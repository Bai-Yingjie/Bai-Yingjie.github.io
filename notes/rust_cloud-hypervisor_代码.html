
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>cloud hypervisor代码 · My Notes</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Bai Yingjie">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-base16-ateliersulphurpool.light.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-wide-page/wide.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hide-navigation-buttons/index.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="rust_cloud-hypervisor_使用.html" />
    
    
    <link rel="prev" href="rust_firecracker_使用.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    CPU和device虚拟化
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    gvisor
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1" data-path="golang_gvisor代码_KVM.html">
            
                <a href="golang_gvisor代码_KVM.html">
            
                    
                    gvisor KVM模式代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.2" data-path="golang_gvisor调试.html">
            
                <a href="golang_gvisor调试.html">
            
                    
                    gvisor调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3" data-path="golang_gvisor_ptrace.html">
            
                <a href="golang_gvisor_ptrace.html">
            
                    
                    gvisor ptrace模式介绍(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="rust_vmm_brief.html">
            
                <a href="rust_vmm_brief.html">
            
                    
                    rust VMM(virtual machine monitor)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.1" data-path="rust_vmm_简介.html">
            
                <a href="rust_vmm_简介.html">
            
                    
                    rust-vmm简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2" data-path="rust_firecracker_代码.html">
            
                <a href="rust_firecracker_代码.html">
            
                    
                    firecracker代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.3" data-path="rust_firecracker_使用.html">
            
                <a href="rust_firecracker_使用.html">
            
                    
                    firecracker使用
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.2.4" data-path="rust_cloud-hypervisor_代码.html">
            
                <a href="rust_cloud-hypervisor_代码.html">
            
                    
                    cloud hypervisor代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.5" data-path="rust_cloud-hypervisor_使用.html">
            
                <a href="rust_cloud-hypervisor_使用.html">
            
                    
                    cloud hypervisor使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.6" data-path="rust_cloud-hypervisor_问题与解决.html">
            
                <a href="rust_cloud-hypervisor_问题与解决.html">
            
                    
                    cloud hypervisor问题与解决
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="virtualization_virtio规范阅读笔记.html">
            
                <a href="virtualization_virtio规范阅读笔记.html">
            
                    
                    virtio规范阅读笔记.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="qemu_ovs_虚拟化环境.html">
            
                <a href="qemu_ovs_虚拟化环境.html">
            
                    
                    qemu OVS 虚拟化环境准备
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="qemu使用.html">
            
                <a href="qemu使用.html">
            
                    
                    Qemu使用(old)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    开源
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="my_opensource.html">
            
                <a href="my_opensource.html">
            
                    
                    我的开源项目
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="my_upstream.html">
            
                <a href="my_upstream.html">
            
                    
                    我的upstream commit
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    系统分析和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="system_analysis_bcc和ebpf.html">
            
                <a href="system_analysis_bcc和ebpf.html">
            
                    
                    bcc和ebpf(starting)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="performance_ovs进程调查.html">
            
                <a href="performance_ovs进程调查.html">
            
                    
                    OVS进程调查
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="performance_ping流程和函数调用解析.html">
            
                <a href="performance_ping流程和函数调用解析.html">
            
                    
                    ping流程和函数调用解析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="CentOS_系统性能优化配置.html">
            
                <a href="CentOS_系统性能优化配置.html">
            
                    
                    CentOS 性能优化系统配置
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Golang
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    入门
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1.1" data-path="golang_语法基础.html">
            
                <a href="golang_语法基础.html">
            
                    
                    Golang 语法基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.2" data-path="golang_json性能.html">
            
                <a href="golang_json性能.html">
            
                    
                    Golang json性能比较
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="golang_原理.html">
            
                <a href="golang_原理.html">
            
                    
                    Golang 原理相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.1" data-path="golang_interface原理.html">
            
                <a href="golang_interface原理.html">
            
                    
                    Golang interface原理(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.2" data-path="golang_内存分配.html">
            
                <a href="golang_内存分配.html">
            
                    
                    Golang 内存分配(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="golang_标准库.html">
            
                <a href="golang_标准库.html">
            
                    
                    Golang 标准库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="golang_我的反射代码.html">
            
                <a href="golang_我的反射代码.html">
            
                    
                    Golang 我的反射代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="golang_问答.html">
            
                <a href="golang_问答.html">
            
                    
                    Golang 问答
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="golang_高效go.html">
            
                <a href="golang_高效go.html">
            
                    
                    Golang 高效go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="golang_进阶.html">
            
                <a href="golang_进阶.html">
            
                    
                    Golang 进阶
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Golang 杂记
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.8.1" data-path="golang_杂记1.html">
            
                <a href="golang_杂记1.html">
            
                    
                    Golang 杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8.2" data-path="golang_杂记2.html">
            
                <a href="golang_杂记2.html">
            
                    
                    Golang 杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8.3" data-path="golang_杂记3.html">
            
                <a href="golang_杂记3.html">
            
                    
                    Golang 杂记3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8.4" data-path="golang_lib选型.html">
            
                <a href="golang_lib选型.html">
            
                    
                    Golang lib选型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8.5" data-path="golang_mod_proxy.html">
            
                <a href="golang_mod_proxy.html">
            
                    
                    go mod和go proxy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8.6" data-path="golang_汇编_arm64.html">
            
                <a href="golang_汇编_arm64.html">
            
                    
                    Golang 汇编语法和arm64小知识
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8.7" data-path="golang_cgo_swig.html">
            
                <a href="golang_cgo_swig.html">
            
                    
                    go调用c可以用swig
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.9" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Golang 环境和工具链生成
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.9.1" data-path="golang_toolchain_ppc.html">
            
                <a href="golang_toolchain_ppc.html">
            
                    
                    go tools增加ppc32支持.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9.2" data-path="golang_toolchain_compile_gccgo.html">
            
                <a href="golang_toolchain_compile_gccgo.html">
            
                    
                    编译gccgo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9.3" data-path="golang_go_on_mips.html">
            
                <a href="golang_go_on_mips.html">
            
                    
                    go on mips boards(not so updated)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.9.3.1" data-path="golang_go_on_mips_part1.html">
            
                <a href="golang_go_on_mips_part1.html">
            
                    
                    part 1: cross compile go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9.3.2" data-path="golang_go_on_mips_part2.html">
            
                <a href="golang_go_on_mips_part2.html">
            
                    
                    part 2: build native go compiler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9.3.3" data-path="golang_go_on_mips_part3.html">
            
                <a href="golang_go_on_mips_part3.html">
            
                    
                    part 3: gccgo experiments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9.3.4" data-path="golang_go_on_mips_part4.html">
            
                <a href="golang_go_on_mips_part4.html">
            
                    
                    part 4: Golang json performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9.3.5" data-path="golang_gentoo_on_mips_board_and_build_go.html">
            
                <a href="golang_gentoo_on_mips_board_and_build_go.html">
            
                    
                    Gentoo on mips board and build go
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.10" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    微服务
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.10.1" data-path="golang_micro.html">
            
                <a href="golang_micro.html">
            
                    
                    go-micro和micro
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.10.2" data-path="golang_微服务概念.html">
            
                <a href="golang_微服务概念.html">
            
                    
                    微服务概念
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.11" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    解释器和编解码
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.11.1" data-path="golang_yeagi.html">
            
                <a href="golang_yeagi.html">
            
                    
                    解释器yeagi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.11.2" data-path="golang_tengo.html">
            
                <a href="golang_tengo.html">
            
                    
                    解释器tengo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.11.3" data-path="golang_govaluate.html">
            
                <a href="golang_govaluate.html">
            
                    
                    解释器govaluate
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.11.4" data-path="golang_encoding_gotiny.html">
            
                <a href="golang_encoding_gotiny.html">
            
                    
                    gotiny编解码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.11.5" data-path="golang_abs.html">
            
                <a href="golang_abs.html">
            
                    
                    解释器abs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.12" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    调试和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.12.1" data-path="golang_调试记录.html">
            
                <a href="golang_调试记录.html">
            
                    
                    Golang 调试记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.12.2" data-path="golang_topid性能优化.html">
            
                <a href="golang_topid性能优化.html">
            
                    
                    Golang topid性能优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.12.3" data-path="golang_gshell性能调试.html">
            
                <a href="golang_gshell性能调试.html">
            
                    
                    Golang gshell性能调试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.13" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    网络和消息中间件
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.13.1" data-path="golang_zmq.html">
            
                <a href="golang_zmq.html">
            
                    
                    消息中间件基本概念和zero mq
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.13.2" data-path="golang_mango.html">
            
                <a href="golang_mango.html">
            
                    
                    消息中间件mango
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.13.3" data-path="golang_libp2p.html">
            
                <a href="golang_libp2p.html">
            
                    
                    Golang p2p网络
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Rust
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="rust_入门_brief.html">
            
                <a href="rust_入门_brief.html">
            
                    
                    Rust 入门系列
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1.1" data-path="rust_books.html">
            
                <a href="rust_books.html">
            
                    
                    Rust reference books
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.2" data-path="rust_入门1.html">
            
                <a href="rust_入门1.html">
            
                    
                    Rust 安装和基础语法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.3" data-path="rust_入门2.html">
            
                <a href="rust_入门2.html">
            
                    
                    Rust 泛型和内存所有权
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.4" data-path="rust_入门3.html">
            
                <a href="rust_入门3.html">
            
                    
                    Rust 闭包 容器 迭代器 生成器 线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.5" data-path="rust_工程构建.html">
            
                <a href="rust_工程构建.html">
            
                    
                    Rust 工程构建
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="rust_coding_brief.html">
            
                <a href="rust_coding_brief.html">
            
                    
                    Rust 代码积累
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.2.1" data-path="rust_序列化.html">
            
                <a href="rust_序列化.html">
            
                    
                    Rust 序列化原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.2" data-path="rust_知识点积累.html">
            
                <a href="rust_知识点积累.html">
            
                    
                    Rust 知识点更新
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.3" data-path="rust_adaptiveservice.html">
            
                <a href="rust_adaptiveservice.html">
            
                    
                    rust版本的adaptiveservice探索
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.4" data-path="rust_常用设施.html">
            
                <a href="rust_常用设施.html">
            
                    
                    Rust 常用设施
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.5" data-path="rust_代码小段.html">
            
                <a href="rust_代码小段.html">
            
                    
                    Rust 代码小段
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="others.html">
            
                <a href="others.html">
            
                    
                    其他
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.3.1" data-path="rust_mdbook_使用.html">
            
                <a href="rust_mdbook_使用.html">
            
                    
                    Rust 使用mdbook
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    ARM server
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="arm_server_杂记.html">
            
                <a href="arm_server_杂记.html">
            
                    
                    Rust 杂记
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    脚本
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="shell_变量.html">
            
                <a href="shell_变量.html">
            
                    
                    shell变量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="shell_基础篇.html">
            
                <a href="shell_基础篇.html">
            
                    
                    shell命令和脚本记录-基础篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="shell_高级篇.html">
            
                <a href="shell_高级篇.html">
            
                    
                    shell命令和脚本记录-高级篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="shell_脚本片段.html">
            
                <a href="shell_脚本片段.html">
            
                    
                    shell脚本片段
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="python_记录.html">
            
                <a href="python_记录.html">
            
                    
                    python记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.6" data-path="lua_记录.html">
            
                <a href="lua_记录.html">
            
                    
                    lua记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.7" data-path="shell_rds脚本阅读.html">
            
                <a href="shell_rds脚本阅读.html">
            
                    
                    RDS脚本阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.8" data-path="Project_Euler.html">
            
                <a href="Project_Euler.html">
            
                    
                    Project Euler
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    CPU Arch相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    ARM64
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1.1" data-path="CPU_ARM64_thunder_overview.html">
            
                <a href="CPU_ARM64_thunder_overview.html">
            
                    
                    thunder 概览
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.2" data-path="CPU_ARM64_thunder_开发板操作记录.html">
            
                <a href="CPU_ARM64_thunder_开发板操作记录.html">
            
                    
                    thunder 开发板操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.3" data-path="CPU_ARM64_thunder_bdk.html">
            
                <a href="CPU_ARM64_thunder_bdk.html">
            
                    
                    thunder BDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.4" data-path="CPU_ARM64_thunder_efi_rtc.html">
            
                <a href="CPU_ARM64_thunder_efi_rtc.html">
            
                    
                    thunder RTC时间和efi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.5" data-path="CPU_ARM64_thunder_uefi_fdt.html">
            
                <a href="CPU_ARM64_thunder_uefi_fdt.html">
            
                    
                    thunder uefi和fdt
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.6" data-path="CPU_ARM64_thunder_atf.html">
            
                <a href="CPU_ARM64_thunder_atf.html">
            
                    
                    thunder atf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.7" data-path="CPU_ARM64_thunder_kernel_boot.html">
            
                <a href="CPU_ARM64_thunder_kernel_boot.html">
            
                    
                    thunder kernel启动打印流程
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    PPC
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.2.1" data-path="CPU_PPC启动多核Linux_流程和内存映射.html">
            
                <a href="CPU_PPC启动多核Linux_流程和内存映射.html">
            
                    
                    PPC启动多核linux: 流程和内存映射
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.2" data-path="CPU_PPC_kernel升级记录.html">
            
                <a href="CPU_PPC_kernel升级记录.html">
            
                    
                    PPC kernel升级记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    MIPS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.3.1" data-path="CPU_MIPS_octeon地址空间和寄存器访问.html">
            
                <a href="CPU_MIPS_octeon地址空间和寄存器访问.html">
            
                    
                    octeon 地址空间和寄存器访问
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.2" data-path="CPU_MIPS_octeon操作记录.html">
            
                <a href="CPU_MIPS_octeon操作记录.html">
            
                    
                    octeon 操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.3" data-path="CPU_MIPS_octeon_包处理性能.html">
            
                <a href="CPU_MIPS_octeon_包处理性能.html">
            
                    
                    octeon 系列处理器包处理性能
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.4" data-path="CPU_MIPS_octeon_ddr调试记录.html">
            
                <a href="CPU_MIPS_octeon_ddr调试记录.html">
            
                    
                    octeon DDR调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.5" data-path="CPU_MIPS_octeon_BDK.html">
            
                <a href="CPU_MIPS_octeon_BDK.html">
            
                    
                    octeon CN78xx BDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.6" data-path="kernel_增加ECC中断.html">
            
                <a href="kernel_增加ECC中断.html">
            
                    
                    octeon 增加ECC中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.7" data-path="CPU_MIPS_octeon_hw-ddr2代码走读.html">
            
                <a href="CPU_MIPS_octeon_hw-ddr2代码走读.html">
            
                    
                    octeon hw-ddr2代码走读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.8" data-path="CPU_MIPS_octeon_reboot调试和ddr中断.html">
            
                <a href="CPU_MIPS_octeon_reboot调试和ddr中断.html">
            
                    
                    octeon reboot调试和DDR中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.9" data-path="CPU_MIPS_octeon中断.html">
            
                <a href="CPU_MIPS_octeon中断.html">
            
                    
                    octeon 中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.10" data-path="CPU_MIPS_octeon原子操作.html">
            
                <a href="CPU_MIPS_octeon原子操作.html">
            
                    
                    octeon 原子操作
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.11" data-path="CPU_MIPS_octeon网口代码分析.html">
            
                <a href="CPU_MIPS_octeon网口代码分析.html">
            
                    
                    octeon 网口代码分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    计算机网络
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="networking_杂记1.html">
            
                <a href="networking_杂记1.html">
            
                    
                    networking杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Qemu OVS和DPDK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.2.1" data-path="OVS_DPDK_编译运行.html">
            
                <a href="OVS_DPDK_编译运行.html">
            
                    
                    OVS-DPDK编译运行
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2.2" data-path="OVS_架构和代码.html">
            
                <a href="OVS_架构和代码.html">
            
                    
                    OVS架构和代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2.3" data-path="OVS_DPDK_performance_HXT_ARM_server.html">
            
                <a href="OVS_DPDK_performance_HXT_ARM_server.html">
            
                    
                    OVS-DPDK for ARM server 性能测试环境
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2.4" data-path="DPDK_Mellanox.html">
            
                <a href="DPDK_Mellanox.html">
            
                    
                    DPDK Mellanox
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2.5" data-path="OVS_phy-vm-phy.html">
            
                <a href="OVS_phy-vm-phy.html">
            
                    
                    OVS PHY-VM-PHY
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2.6" data-path="networking_网络虚拟化用例记录.html">
            
                <a href="networking_网络虚拟化用例记录.html">
            
                    
                    网络虚拟化用例记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2.7" data-path="networking_网络虚拟化操作记录.html">
            
                <a href="networking_网络虚拟化操作记录.html">
            
                    
                    网络虚拟化操作记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    虚拟化网络
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.3.1" data-path="networking_multicast_vxlan_flannel.html">
            
                <a href="networking_multicast_vxlan_flannel.html">
            
                    
                    multicast vxlan和flannel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3.2" data-path="networking_virtualization_杂记.html">
            
                <a href="networking_virtualization_杂记.html">
            
                    
                    虚拟化网络杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3.3" data-path="networking_linux虚拟网络接口.html">
            
                <a href="networking_linux虚拟网络接口.html">
            
                    
                    linux虚拟网络接口(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    设备和驱动相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="device_driver_杂记.html">
            
                <a href="device_driver_杂记.html">
            
                    
                    驱动杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="device_localbus_16bit读写.html">
            
                <a href="device_localbus_16bit读写.html">
            
                    
                    CPLD做8bit到16bit转换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    nand
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.3.1" data-path="device_driver_octeon_nand.html">
            
                <a href="device_driver_octeon_nand.html">
            
                    
                    octeon nand flash驱动
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3.2" data-path="device_driver_nand概率写失败问题分析.html">
            
                <a href="device_driver_nand概率写失败问题分析.html">
            
                    
                    Nand flash概率写失败问题分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11.4" data-path="octeon_remote_pci.html">
            
                <a href="octeon_remote_pci.html">
            
                    
                    octeon remote-pci.c阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.5" data-path="Device_VFIO_notes.html">
            
                <a href="Device_VFIO_notes.html">
            
                    
                    VFIO简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.6" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    智能网卡和DPDK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.6.1" data-path="smartNIC_智能网卡对比.html">
            
                <a href="smartNIC_智能网卡对比.html">
            
                    
                    智能网卡对比
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.6.2" data-path="octeon_pci_NIC.html">
            
                <a href="octeon_pci_NIC.html">
            
                    
                    octeon PCI NIC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.6.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    octeon liquidIO
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.6.3.1" data-path="smartNIC_liquidIO_代码阅读app篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读app篇.html">
            
                    
                    PCI-NIC 代码阅读 --app篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.6.3.2" data-path="smartNIC_liquidIO_代码阅读api篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读api篇.html">
            
                    
                    PCI-NIC 代码阅读 --api篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.6.3.3" data-path="smartNIC_liquidIO_代码阅读driver篇之结构体.html">
            
                <a href="smartNIC_liquidIO_代码阅读driver篇之结构体.html">
            
                    
                    PCI-NIC 代码阅读 --driver篇之结构体
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.6.3.4" data-path="smartNIC_liquidIO_代码阅读driver篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读driver篇.html">
            
                    
                    PCI-NIC 代码阅读 --driver篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.6.3.5" data-path="smartNIC_liquidIO_代码阅读真NIC篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读真NIC篇.html">
            
                    
                    PCI-NIC 代码阅读 --真NIC篇
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11.6.4" data-path="networking_dpdk使用_2014.html">
            
                <a href="networking_dpdk使用_2014.html">
            
                    
                    DPDK使用(2014)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11.7" data-path="device_nvme要点介绍.html">
            
                <a href="device_nvme要点介绍.html">
            
                    
                    nvme要点介绍
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Operating System
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="system_libc_part1.html">
            
                <a href="system_libc_part1.html">
            
                    
                    libc概览1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="system_libc_part2.html">
            
                <a href="system_libc_part2.html">
            
                    
                    libc概览2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="system_libc_part3.html">
            
                <a href="system_libc_part3.html">
            
                    
                    libc概览3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.4" data-path="system_原理杂记.html">
            
                <a href="system_原理杂记.html">
            
                    
                    系统原理杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.5" data-path="system_alpine.html">
            
                <a href="system_alpine.html">
            
                    
                    Alpine Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.6" data-path="system_进程间通信.html">
            
                <a href="system_进程间通信.html">
            
                    
                    进程间通信
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.7" data-path="system_特殊功能fd.html">
            
                <a href="system_特殊功能fd.html">
            
                    
                    eventfd timerfd signalfd和fd共享
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    嵌入式系统开发调试
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="embedded_debugging.html">
            
                <a href="embedded_debugging.html">
            
                    
                    嵌入式调试杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2" data-path="uboot_杂记.html">
            
                <a href="uboot_杂记.html">
            
                    
                    uboot杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.3" data-path="buildroot_杂记.html">
            
                <a href="buildroot_杂记.html">
            
                    
                    buildroot杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.4" data-path="toolchain_升级gcc问题解决.html">
            
                <a href="toolchain_升级gcc问题解决.html">
            
                    
                    升级GCC7.3问题解决
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    工程实践
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" data-path="gitlab_ci.html">
            
                <a href="gitlab_ci.html">
            
                    
                    gitlab CI
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >cloud hypervisor代码</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#code-walk-in-single-picture"><b>1. </b>code walk in single picture</a></li><li><span class="title-icon "></span><a href="#&#x7F16;&#x8BD1;"><b>2. </b>&#x7F16;&#x8BD1;</a></li><ul><li><span class="title-icon "></span><a href="#build&#x65F6;&#x53EF;&#x9009;&#x7684;feature&#x5217;&#x8868;"><b>2.1. </b>build&#x65F6;&#x53EF;&#x9009;&#x7684;feature&#x5217;&#x8868;</a></li></ul><li><span class="title-icon "></span><a href="#rest-api&#x548C;cli"><b>3. </b>REST API&#x548C;CLI</a></li><ul><li><span class="title-icon "></span><a href="#&#x5148;&#x7528;cli&#x521B;&#x5EFA;&#x4E00;&#x4E2A;empty&#x7684;&#x5B9E;&#x4F8B;-&#x9ED8;&#x8BA4;1vcpu-512m&#x5185;&#x5B58;"><b>3.1. </b>&#x5148;&#x7528;cli&#x521B;&#x5EFA;&#x4E00;&#x4E2A;empty&#x7684;&#x5B9E;&#x4F8B;, &#x9ED8;&#x8BA4;1vCPU, 512M&#x5185;&#x5B58;.</a></li><li><span class="title-icon "></span><a href="#&#x968F;&#x540E;&#x7528;rest-api&#x6765;&#x521B;&#x5EFA;vm"><b>3.2. </b>&#x968F;&#x540E;&#x7528;REST API&#x6765;&#x521B;&#x5EFA;vm</a></li><li><span class="title-icon "></span><a href="#&#x7136;&#x540E;boot&#x8FD9;&#x4E2A;&#x5B9E;&#x4F8B;"><b>3.3. </b>&#x7136;&#x540E;boot&#x8FD9;&#x4E2A;&#x5B9E;&#x4F8B;</a></li><li><span class="title-icon "></span><a href="#&#x5176;&#x4ED6;&#x547D;&#x4EE4;"><b>3.4. </b>&#x5176;&#x4ED6;&#x547D;&#x4EE4;</a></li><li><span class="title-icon "></span><a href="#cli&#x548C;rest&#x7684;&#x5173;&#x7CFB;"><b>3.5. </b>cli&#x548C;REST&#x7684;&#x5173;&#x7CFB;</a></li><li><span class="title-icon "></span><a href="#http&#x8DEF;&#x7531;"><b>3.6. </b>http&#x8DEF;&#x7531;</a></li><li><span class="title-icon "></span><a href="#&#x5185;&#x90E8;channel"><b>3.7. </b>&#x5185;&#x90E8;channel</a></li></ul><li><span class="title-icon "></span><a href="#&#x4EE3;&#x7801;&#x68B3;&#x7406;-main"><b>4. </b>&#x4EE3;&#x7801;&#x68B3;&#x7406; main</a></li><ul><li><span class="title-icon "></span><a href="#hypervisor&#x7684;&#x62BD;&#x8C61;"><b>4.1. </b>hypervisor&#x7684;&#x62BD;&#x8C61;</a></li><ul><li><span class="title-icon "></span><a href="#vm&#x62BD;&#x8C61;&#x57FA;&#x672C;&#x4E0A;&#x662F;&#x57FA;&#x4E8E;kvm-api&#x7684;"><b>4.1.1. </b>vm&#x62BD;&#x8C61;&#x57FA;&#x672C;&#x4E0A;&#x662F;&#x57FA;&#x4E8E;kvm api&#x7684;</a></li><li><span class="title-icon "></span><a href="#vmops"><b>4.1.2. </b>vmops</a></li></ul></ul><li><span class="title-icon "></span><a href="#cli-create-vm&#x4EE3;&#x7801;&#x6D41;&#x7A0B;"><b>5. </b>cli create vm&#x4EE3;&#x7801;&#x6D41;&#x7A0B;</a></li><li><span class="title-icon "></span><a href="#rest-api&#x6D41;&#x7A0B;&#x5B9E;&#x4F8B;"><b>6. </b>REST API&#x6D41;&#x7A0B;&#x5B9E;&#x4F8B;</a></li><ul><li><span class="title-icon "></span><a href="#&#x7528;&#x6237;&#x53D1;rest-api"><b>6.1. </b>&#x7528;&#x6237;&#x53D1;REST API</a></li><li><span class="title-icon "></span><a href="#&#x8FD9;&#x4E2A;vmm&#x5BF9;&#x5E94;&#x7684;http-server&#x54CD;&#x5E94;&#x8BF7;&#x6C42;"><b>6.2. </b>&#x8FD9;&#x4E2A;VMM&#x5BF9;&#x5E94;&#x7684;http server&#x54CD;&#x5E94;&#x8BF7;&#x6C42;</a></li><ul><li><span class="title-icon "></span><a href="#&#x4ECE;http&#x7684;raw-data&#x91CC;json&#x683C;&#x5F0F;&#x89E3;&#x6790;vmconfig"><b>6.2.1. </b>&#x4ECE;http&#x7684;raw data&#x91CC;(json&#x683C;&#x5F0F;)&#x89E3;&#x6790;VmConfig</a></li><li><span class="title-icon "></span><a href="#vmcreate&#x4F7F;&#x7528;&#x5185;&#x90E8;channel&#x5411;vmm&#x7684;api&#x53D1;&#x9001;&#x8BF7;&#x6C42;"><b>6.2.2. </b>vm_create&#x4F7F;&#x7528;&#x5185;&#x90E8;channel&#x5411;VMM&#x7684;API&#x53D1;&#x9001;&#x8BF7;&#x6C42;</a></li></ul><li><span class="title-icon "></span><a href="#&#x5185;&#x90E8;channel&#x5904;&#x7406;&#x8BF7;&#x6C42;"><b>6.3. </b>&#x5185;&#x90E8;channel&#x5904;&#x7406;&#x8BF7;&#x6C42;</a></li><ul><li><span class="title-icon "></span><a href="#&#x5904;&#x7406;&#x8FD9;&#x6B21;&#x7684;vmcreate"><b>6.3.1. </b>&#x5904;&#x7406;&#x8FD9;&#x6B21;&#x7684;VmCreate</a></li></ul><li><span class="title-icon "></span><a href="#&#x8FD4;&#x56DE;response"><b>6.4. </b>&#x8FD4;&#x56DE;response</a></li></ul><li><span class="title-icon "></span><a href="#impl-vmm"><b>7. </b>impl Vmm</a></li><ul><li><span class="title-icon "></span><a href="#x8664&#x548C;aarch64&#x7684;mem-layout"><b>7.1. </b>x86_64&#x548C;aarch64&#x7684;mem layout</a></li><li><span class="title-icon "></span><a href="#vmboot"><b>7.2. </b>vm_boot</a></li><li><span class="title-icon "></span><a href="#devicemanager"><b>7.3. </b>DeviceManager</a></li><ul><li><span class="title-icon "></span><a href="#devicemanager&#x7ED3;&#x6784;&#x4F53;"><b>7.3.1. </b>DeviceManager&#x7ED3;&#x6784;&#x4F53;</a></li><li><span class="title-icon "></span><a href="#devicemanager&#x65B9;&#x6CD5;"><b>7.3.2. </b>DeviceManager&#x65B9;&#x6CD5;</a></li><li><span class="title-icon "></span><a href="#pci-segment"><b>7.3.3. </b>PCI segment</a></li><li><span class="title-icon "></span><a href="#pcibus"><b>7.3.4. </b>PciBus</a></li><li><span class="title-icon "></span><a href="#pcidevice"><b>7.3.5. </b>PciDevice</a></li></ul></ul><li><span class="title-icon "></span><a href="#virtio&#x8BBE;&#x5907;"><b>8. </b>virtio&#x8BBE;&#x5907;</a></li><ul><li><span class="title-icon "></span><a href="#virtionet"><b>8.1. </b>virtionet</a></li><ul><li><span class="title-icon "></span><a href="#net&#x7ED3;&#x6784;&#x4F53;"><b>8.1.1. </b>Net&#x7ED3;&#x6784;&#x4F53;</a></li><li><span class="title-icon "></span><a href="#impl-virtiodevice-for-net"><b>8.1.2. </b>impl VirtioDevice for Net</a></li><li><span class="title-icon "></span><a href="#&#x5176;&#x4ED6;trait"><b>8.1.3. </b>&#x5176;&#x4ED6;trait</a></li></ul><li><span class="title-icon "></span><a href="#virtio-block"><b>8.2. </b>virtio block</a></li></ul><li><span class="title-icon "></span><a href="#io-bus&#x548C;mmio-bus"><b>9. </b>IO Bus&#x548C;MMIO Bus</a></li><ul><li><span class="title-icon "></span><a href="#bus&#x65B9;&#x6CD5;"><b>9.1. </b>Bus&#x65B9;&#x6CD5;</a></li></ul><li><span class="title-icon "></span><a href="#&#x4E2D;&#x65AD;"><b>10. </b>&#x4E2D;&#x65AD;</a></li><ul><li><span class="title-icon "></span><a href="#interrupt-group"><b>10.1. </b>interrupt group</a></li><li><span class="title-icon "></span><a href="#&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;"><b>10.2. </b>&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;</a></li><ul><li><span class="title-icon "></span><a href="#msi&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;"><b>10.2.1. </b>msi&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;</a></li><li><span class="title-icon "></span><a href="#msiinterruptgroup"><b>10.2.2. </b>MsiInterruptGroup</a></li></ul></ul></ul></div><a href="#code-walk-in-single-picture" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><p>cloud hypervisor&#x662F;&#x4E00;&#x79CD;&#x57FA;&#x4E8E;rust-vmm&#x7684;VMM&#x5B9E;&#x73B0;. &#x5B83;&#x548C;&#x5176;&#x4ED6;VMM&#x7684;&#x5BF9;&#x6BD4;&#x5728;<a href="rust_vmm_brief.html">&#x8FD9;&#x91CC;</a></p>
<ul>
<li><a href="#code-walk-in-single-picture">code walk in single picture</a></li>
<li><a href="#&#x7F16;&#x8BD1;">&#x7F16;&#x8BD1;</a><ul>
<li><a href="#build&#x65F6;&#x53EF;&#x9009;&#x7684;feature&#x5217;&#x8868;">build&#x65F6;&#x53EF;&#x9009;&#x7684;feature&#x5217;&#x8868;</a></li>
</ul>
</li>
<li><a href="#rest-api&#x548C;cli">REST API&#x548C;CLI</a><ul>
<li><a href="#&#x5148;&#x7528;cli&#x521B;&#x5EFA;&#x4E00;&#x4E2A;empty&#x7684;&#x5B9E;&#x4F8B;-&#x9ED8;&#x8BA4;1vcpu-512m&#x5185;&#x5B58;">&#x5148;&#x7528;cli&#x521B;&#x5EFA;&#x4E00;&#x4E2A;empty&#x7684;&#x5B9E;&#x4F8B;, &#x9ED8;&#x8BA4;1vCPU, 512M&#x5185;&#x5B58;.</a></li>
<li><a href="#&#x968F;&#x540E;&#x7528;rest-api&#x6765;&#x521B;&#x5EFA;vm">&#x968F;&#x540E;&#x7528;REST API&#x6765;&#x521B;&#x5EFA;vm</a></li>
<li><a href="#&#x7136;&#x540E;boot&#x8FD9;&#x4E2A;&#x5B9E;&#x4F8B;">&#x7136;&#x540E;boot&#x8FD9;&#x4E2A;&#x5B9E;&#x4F8B;</a></li>
<li><a href="#&#x5176;&#x4ED6;&#x547D;&#x4EE4;">&#x5176;&#x4ED6;&#x547D;&#x4EE4;</a></li>
<li><a href="#cli&#x548C;rest&#x7684;&#x5173;&#x7CFB;">cli&#x548C;REST&#x7684;&#x5173;&#x7CFB;</a></li>
<li><a href="#http&#x8DEF;&#x7531;">http&#x8DEF;&#x7531;</a></li>
<li><a href="#&#x5185;&#x90E8;channel">&#x5185;&#x90E8;channel</a></li>
</ul>
</li>
<li><a href="#&#x4EE3;&#x7801;&#x68B3;&#x7406;-main">&#x4EE3;&#x7801;&#x68B3;&#x7406; main</a><ul>
<li><a href="#hypervisor&#x7684;&#x62BD;&#x8C61;">hypervisor&#x7684;&#x62BD;&#x8C61;</a><ul>
<li><a href="#vm&#x62BD;&#x8C61;&#x57FA;&#x672C;&#x4E0A;&#x662F;&#x57FA;&#x4E8E;kvm-api&#x7684;">vm&#x62BD;&#x8C61;&#x57FA;&#x672C;&#x4E0A;&#x662F;&#x57FA;&#x4E8E;kvm api&#x7684;</a></li>
<li><a href="#vmops">vmops</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cli-create-vm&#x4EE3;&#x7801;&#x6D41;&#x7A0B;">cli create vm&#x4EE3;&#x7801;&#x6D41;&#x7A0B;</a></li>
<li><a href="#rest-api&#x6D41;&#x7A0B;&#x5B9E;&#x4F8B;">REST API&#x6D41;&#x7A0B;&#x5B9E;&#x4F8B;</a><ul>
<li><a href="#&#x7528;&#x6237;&#x53D1;rest-api">&#x7528;&#x6237;&#x53D1;REST API</a></li>
<li><a href="#&#x8FD9;&#x4E2A;vmm&#x5BF9;&#x5E94;&#x7684;http-server&#x54CD;&#x5E94;&#x8BF7;&#x6C42;">&#x8FD9;&#x4E2A;VMM&#x5BF9;&#x5E94;&#x7684;http server&#x54CD;&#x5E94;&#x8BF7;&#x6C42;</a><ul>
<li><a href="#&#x4ECE;http&#x7684;raw-data&#x91CC;json&#x683C;&#x5F0F;&#x89E3;&#x6790;vmconfig">&#x4ECE;http&#x7684;raw data&#x91CC;(json&#x683C;&#x5F0F;)&#x89E3;&#x6790;VmConfig</a></li>
<li><a href="#vm_create&#x4F7F;&#x7528;&#x5185;&#x90E8;channel&#x5411;vmm&#x7684;api&#x53D1;&#x9001;&#x8BF7;&#x6C42;">vm_create&#x4F7F;&#x7528;&#x5185;&#x90E8;channel&#x5411;VMM&#x7684;API&#x53D1;&#x9001;&#x8BF7;&#x6C42;</a></li>
</ul>
</li>
<li><a href="#&#x5185;&#x90E8;channel&#x5904;&#x7406;&#x8BF7;&#x6C42;">&#x5185;&#x90E8;channel&#x5904;&#x7406;&#x8BF7;&#x6C42;</a><ul>
<li><a href="#&#x5904;&#x7406;&#x8FD9;&#x6B21;&#x7684;vmcreate">&#x5904;&#x7406;&#x8FD9;&#x6B21;&#x7684;VmCreate</a></li>
</ul>
</li>
<li><a href="#&#x8FD4;&#x56DE;response">&#x8FD4;&#x56DE;response</a></li>
</ul>
</li>
<li><a href="#impl-vmm">impl Vmm</a><ul>
<li><a href="#x86_64&#x548C;aarch64&#x7684;mem-layout">x86_64&#x548C;aarch64&#x7684;mem layout</a></li>
<li><a href="#vm_boot">vm_boot</a></li>
<li><a href="#devicemanager">DeviceManager</a><ul>
<li><a href="#devicemanager&#x7ED3;&#x6784;&#x4F53;">DeviceManager&#x7ED3;&#x6784;&#x4F53;</a></li>
<li><a href="#devicemanager&#x65B9;&#x6CD5;">DeviceManager&#x65B9;&#x6CD5;</a><ul>
<li><a href="#devicenode&#x5305;&#x62EC;id-&#x8D44;&#x6E90;-&#x5C42;&#x7EA7;-pci&#x4FE1;&#x606F;">DeviceNode&#x5305;&#x62EC;id, &#x8D44;&#x6E90;, &#x5C42;&#x7EA7;, pci&#x4FE1;&#x606F;</a></li>
</ul>
</li>
<li><a href="#pci-segment">PCI segment</a></li>
<li><a href="#pcibus">PciBus</a></li>
<li><a href="#pcidevice">PciDevice</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#virtio&#x8BBE;&#x5907;">virtio&#x8BBE;&#x5907;</a><ul>
<li><a href="#virtionet">virtionet</a><ul>
<li><a href="#net&#x7ED3;&#x6784;&#x4F53;">Net&#x7ED3;&#x6784;&#x4F53;</a></li>
<li><a href="#impl-virtiodevice-for-net">impl VirtioDevice for Net</a><ul>
<li><a href="#activate">activate</a></li>
<li><a href="#netqueuepair">NetQueuePair</a></li>
</ul>
</li>
<li><a href="#&#x5176;&#x4ED6;trait">&#x5176;&#x4ED6;trait</a></li>
</ul>
</li>
<li><a href="#virtio-block">virtio block</a></li>
</ul>
</li>
<li><a href="#io-bus&#x548C;mmio-bus">IO Bus&#x548C;MMIO Bus</a><ul>
<li><a href="#bus&#x65B9;&#x6CD5;">Bus&#x65B9;&#x6CD5;</a></li>
</ul>
</li>
<li><a href="#&#x4E2D;&#x65AD;">&#x4E2D;&#x65AD;</a><ul>
<li><a href="#interrupt-group">interrupt group</a></li>
<li><a href="#&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;">&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;</a><ul>
<li><a href="#msi&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;">msi&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;</a></li>
<li><a href="#msiinterruptgroup">MsiInterruptGroup</a><ul>
<li><a href="#kvm_irqfd">KVM_IRQFD</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="code-walk-in-single-picture"><a name="code-walk-in-single-picture" class="anchor-navigation-ex-anchor" href="#code-walk-in-single-picture"><i class="fa fa-link" aria-hidden="true"></i></a>1. code walk in single picture</h1>
<p><img src="img/rust_cloud-hypervisor_code_walk.svg" alt="">  </p>
<h1 id="&#x7F16;&#x8BD1;"><a name="&#x7F16;&#x8BD1;" class="anchor-navigation-ex-anchor" href="#&#x7F16;&#x8BD1;"><i class="fa fa-link" aria-hidden="true"></i></a>2. &#x7F16;&#x8BD1;</h1>
<pre class="language-"><code class="lang-sh"><span class="token function">git</span> clone https://github.com/cloud-hypervisor/cloud-hypervisor.git
<span class="token builtin class-name">cd</span> cloud-hypervisor/

<span class="token comment"># docker&#x65B9;&#x5F0F;&#x7F16;&#x8BD1; -- &#x63A8;&#x8350;</span>
<span class="token comment"># &#x5982;&#x679C;&#x9700;&#x8981;proxy, &#x5728;cmd_build&#x51FD;&#x6570;docker run&#x547D;&#x4EE4;&#x884C;&#x52A0;--env http_proxy=&quot;http://10.158.100.6:8080/&quot;</span>
scripts/dev_cli.sh build <span class="token parameter variable">--release</span> <span class="token parameter variable">--libc</span> musl
<span class="token comment"># &#x4EA7;&#x751F;&#x7684;bin: build/cargo_target/x86_64-unknown-linux-musl/release/cloud-hypervisor</span>

<span class="token comment"># &#x672C;&#x5730;&#x65B9;&#x5F0F;&#x7F16;&#x8BD1;, &#x5B8C;&#x5168;&#x9759;&#x6001;&#x94FE;&#x63A5;&#x7248;&#x672C;&#x8981;&#x4F7F;&#x7528;x86_64-unknown-linux-musl</span>
rustup target <span class="token function">add</span> x86_64-unknown-linux-musl
<span class="token comment"># &#x5B8C;&#x5168;&#x9759;&#x6001;&#x7248;&#x672C;&#x4E00;&#x5B9A;&#x8981;&#x52A0;--all, &#x8FD8;&#x8981;&#x5B89;&#x88C5;musl-tools</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> musl-tools
<span class="token function">cargo</span> build <span class="token parameter variable">--release</span> <span class="token parameter variable">--target</span><span class="token operator">=</span>x86_64-unknown-linux-musl <span class="token parameter variable">--all</span>
<span class="token comment"># &#x4EA7;&#x751F;&#x7684;bin: target/x86_64-unknown-linux-musl/release/cloud-hypervisor</span>
</code></pre>
<h2 id="build&#x65F6;&#x53EF;&#x9009;&#x7684;feature&#x5217;&#x8868;"><a name="build&#x65F6;&#x53EF;&#x9009;&#x7684;feature&#x5217;&#x8868;" class="anchor-navigation-ex-anchor" href="#build&#x65F6;&#x53EF;&#x9009;&#x7684;feature&#x5217;&#x8868;"><i class="fa fa-link" aria-hidden="true"></i></a>2.1. build&#x65F6;&#x53EF;&#x9009;&#x7684;feature&#x5217;&#x8868;</h2>
<pre class="language-"><code class="lang-rust"><span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
<span class="token attribute attr-name">#[cfg(target_arch =  <span class="token string">&quot;aarch64&quot;</span>)]</span>

<span class="token attribute attr-name">#[cfg(feature = <span class="token string">&quot;guest_debug&quot;</span>)]</span>
<span class="token attribute attr-name">#[cfg(feature = <span class="token string">&quot;fwdebug&quot;</span>)]</span>
<span class="token attribute attr-name">#[cfg(feature = <span class="token string">&quot;tdx&quot;</span>)]</span>
<span class="token attribute attr-name">#[cfg(feature = <span class="token string">&quot;kvm&quot;</span>)]</span>
<span class="token attribute attr-name">#[cfg(all(feature = <span class="token string">&quot;mshv&quot;</span>, target_arch = <span class="token string">&quot;x86_64&quot;</span>))]</span>
<span class="token attribute attr-name">#[cfg(feature = <span class="token string">&quot;gdb&quot;</span>)]</span>
</code></pre>
<h1 id="rest-api&#x548C;cli"><a name="rest-api&#x548C;cli" class="anchor-navigation-ex-anchor" href="#rest-api&#x548C;cli"><i class="fa fa-link" aria-hidden="true"></i></a>3. REST API&#x548C;CLI</h1>
<p>cloud hypervisor&#x4EE5;cli&#x65B9;&#x5F0F;&#x542F;&#x52A8;, &#x5E76;&#x542F;&#x52A8;http&#x670D;&#x52A1;, &#x63D0;&#x4F9B;REST&#x63A5;&#x53E3;.
&#x5982;&#x679C;cli&#x4F20;&#x5165;vmm&#x7684;&#x53C2;&#x6570;, &#x5219;http&#x670D;&#x52A1;&#x4F1A;&#x6839;&#x636E;&#x540E;&#x9762;&#x7684;REST api&#x6765;&#x521B;&#x5EFA;VM</p>
<h2 id="&#x5148;&#x7528;cli&#x521B;&#x5EFA;&#x4E00;&#x4E2A;empty&#x7684;&#x5B9E;&#x4F8B;-&#x9ED8;&#x8BA4;1vcpu-512m&#x5185;&#x5B58;"><a name="&#x5148;&#x7528;cli&#x521B;&#x5EFA;&#x4E00;&#x4E2A;empty&#x7684;&#x5B9E;&#x4F8B;-&#x9ED8;&#x8BA4;1vcpu-512m&#x5185;&#x5B58;" class="anchor-navigation-ex-anchor" href="#&#x5148;&#x7528;cli&#x521B;&#x5EFA;&#x4E00;&#x4E2A;empty&#x7684;&#x5B9E;&#x4F8B;-&#x9ED8;&#x8BA4;1vcpu-512m&#x5185;&#x5B58;"><i class="fa fa-link" aria-hidden="true"></i></a>3.1. &#x5148;&#x7528;cli&#x521B;&#x5EFA;&#x4E00;&#x4E2A;empty&#x7684;&#x5B9E;&#x4F8B;, &#x9ED8;&#x8BA4;1vCPU, 512M&#x5185;&#x5B58;.</h2>
<pre class="language-"><code class="lang-sh">$ ./target/debug/cloud-hypervisor --api-socket /tmp/cloud-hypervisor.sock
Cloud Hypervisor Guest
    API server: /tmp/cloud-hypervisor.sock
    vCPUs: <span class="token number">1</span>
    Memory: <span class="token number">512</span> MB
    Kernel: None
    Kernel cmdline:
    Disk<span class="token punctuation">(</span>s<span class="token punctuation">)</span>: None
</code></pre>
<h2 id="&#x968F;&#x540E;&#x7528;rest-api&#x6765;&#x521B;&#x5EFA;vm"><a name="&#x968F;&#x540E;&#x7528;rest-api&#x6765;&#x521B;&#x5EFA;vm" class="anchor-navigation-ex-anchor" href="#&#x968F;&#x540E;&#x7528;rest-api&#x6765;&#x521B;&#x5EFA;vm"><i class="fa fa-link" aria-hidden="true"></i></a>3.2. &#x968F;&#x540E;&#x7528;REST API&#x6765;&#x521B;&#x5EFA;vm</h2>
<pre class="language-"><code class="lang-sh"><span class="token function">curl</span> --unix-socket /tmp/cloud-hypervisor.sock <span class="token parameter variable">-i</span> <span class="token punctuation">\</span>
     <span class="token parameter variable">-X</span> PUT <span class="token string">&apos;http://localhost/api/v1/vm.create&apos;</span>  <span class="token punctuation">\</span>
     <span class="token parameter variable">-H</span> <span class="token string">&apos;Accept: application/json&apos;</span>               <span class="token punctuation">\</span>
     <span class="token parameter variable">-H</span> <span class="token string">&apos;Content-Type: application/json&apos;</span>         <span class="token punctuation">\</span>
     <span class="token parameter variable">-d</span> <span class="token string">&apos;{
         &quot;cpus&quot;:{&quot;boot_vcpus&quot;: 4, &quot;max_vcpus&quot;: 4},
         &quot;kernel&quot;:{&quot;path&quot;:&quot;/opt/clh/kernel/vmlinux-virtio-fs-virtio-iommu&quot;},
         &quot;cmdline&quot;:{&quot;args&quot;:&quot;console=ttyS0 console=hvc0 root=/dev/vda1 rw&quot;},
         &quot;disks&quot;:[{&quot;path&quot;:&quot;/opt/clh/images/focal-server-cloudimg-amd64.raw&quot;}],
         &quot;rng&quot;:{&quot;src&quot;:&quot;/dev/urandom&quot;},
         &quot;net&quot;:[{&quot;ip&quot;:&quot;192.168.10.10&quot;, &quot;mask&quot;:&quot;255.255.255.0&quot;, &quot;mac&quot;:&quot;12:34:56:78:90:01&quot;}]
         }&apos;</span>
</code></pre>
<p>&#x6240;&#x6709;&#x7684;json&#x9009;&#x9879;&#x53EF;&#x5728;<code>vmm/src/config.rs</code>&#x7684;<code>struct VmConfig</code>&#x91CC;&#x9762;&#x67E5;&#x770B;.
<code>struct VmConfig</code>&#x7528;&#x4E86;rust&#x7684;&#x5E8F;&#x5217;&#x5316;&#x6846;&#x67B6;<code>serde</code>, &#x628A;&#x7ED3;&#x6784;&#x4F53;&#x76F4;&#x63A5;&#x6620;&#x5C04;&#x6210;</p>
<h2 id="&#x7136;&#x540E;boot&#x8FD9;&#x4E2A;&#x5B9E;&#x4F8B;"><a name="&#x7136;&#x540E;boot&#x8FD9;&#x4E2A;&#x5B9E;&#x4F8B;" class="anchor-navigation-ex-anchor" href="#&#x7136;&#x540E;boot&#x8FD9;&#x4E2A;&#x5B9E;&#x4F8B;"><i class="fa fa-link" aria-hidden="true"></i></a>3.3. &#x7136;&#x540E;boot&#x8FD9;&#x4E2A;&#x5B9E;&#x4F8B;</h2>
<pre class="language-"><code class="lang-sh"><span class="token function">curl</span> --unix-socket /tmp/cloud-hypervisor.sock <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> PUT <span class="token string">&apos;http://localhost/api/v1/vm.boot&apos;</span>
</code></pre>
<h2 id="&#x5176;&#x4ED6;&#x547D;&#x4EE4;"><a name="&#x5176;&#x4ED6;&#x547D;&#x4EE4;" class="anchor-navigation-ex-anchor" href="#&#x5176;&#x4ED6;&#x547D;&#x4EE4;"><i class="fa fa-link" aria-hidden="true"></i></a>3.4. &#x5176;&#x4ED6;&#x547D;&#x4EE4;</h2>
<pre class="language-"><code class="lang-sh"><span class="token comment"># dump vm&#x7684;config</span>
<span class="token function">curl</span> --unix-socket /tmp/cloud-hypervisor.sock <span class="token parameter variable">-i</span> <span class="token punctuation">\</span>
     <span class="token parameter variable">-X</span> GET <span class="token string">&apos;http://localhost/api/v1/vm.info&apos;</span> <span class="token punctuation">\</span>
     <span class="token parameter variable">-H</span> <span class="token string">&apos;Accept: application/json&apos;</span>

<span class="token comment"># reboot vm</span>
<span class="token function">curl</span> --unix-socket /tmp/cloud-hypervisor.sock <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> PUT <span class="token string">&apos;http://localhost/api/v1/vm.reboot&apos;</span>

<span class="token comment"># shut down</span>
<span class="token function">curl</span> --unix-socket /tmp/cloud-hypervisor.sock <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> PUT <span class="token string">&apos;http://localhost/api/v1/vm.shutdown&apos;</span>
</code></pre>
<h2 id="cli&#x548C;rest&#x7684;&#x5173;&#x7CFB;"><a name="cli&#x548C;rest&#x7684;&#x5173;&#x7CFB;" class="anchor-navigation-ex-anchor" href="#cli&#x548C;rest&#x7684;&#x5173;&#x7CFB;"><i class="fa fa-link" aria-hidden="true"></i></a>3.5. cli&#x548C;REST&#x7684;&#x5173;&#x7CFB;</h2>
<p><img src="img/rust_cloud-hypervisor_&#x4EE3;&#x7801;_20220826175725.png" alt="">  </p>
<h2 id="http&#x8DEF;&#x7531;"><a name="http&#x8DEF;&#x7531;" class="anchor-navigation-ex-anchor" href="#http&#x8DEF;&#x7531;"><i class="fa fa-link" aria-hidden="true"></i></a>3.6. http&#x8DEF;&#x7531;</h2>
<p><code>HTTP_ROUTES</code>&#x662F;&#x4E2A;&#x5168;&#x5C40;&#x53D8;&#x91CF;</p>
<pre class="language-"><code class="lang-rust"><span class="token macro property">lazy_static!</span> <span class="token punctuation">{</span>
    <span class="token comment">/// HTTP_ROUTES contain all the cloud-hypervisor HTTP routes.</span>
    <span class="token keyword">pub</span> <span class="token keyword">static</span> <span class="token keyword">ref</span> <span class="token constant">HTTP_ROUTES</span><span class="token punctuation">:</span> <span class="token class-name">HttpRoutes</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> r <span class="token operator">=</span> <span class="token class-name">HttpRoutes</span> <span class="token punctuation">{</span>
            routes<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.add-device&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">AddDevice</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.add-user-device&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">AddUserDevice</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.add-disk&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">AddDisk</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.add-fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">AddFs</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.add-net&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">AddNet</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.add-pmem&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">AddPmem</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.add-vdpa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">AddVdpa</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.add-vsock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">AddVsock</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.boot&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">Boot</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.counters&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">Counters</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.create&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmCreate</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.delete&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">Delete</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmInfo</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.pause&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">Pause</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.power-button&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">PowerButton</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.reboot&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">Reboot</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.receive-migration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">ReceiveMigration</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.remove-device&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">RemoveDevice</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.resize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">Resize</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.resize-zone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">ResizeZone</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.restore&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">Restore</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.resume&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">Resume</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.send-migration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">SendMigration</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.shutdown&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">Shutdown</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vm.snapshot&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmActionHandler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmAction</span><span class="token punctuation">::</span><span class="token class-name">Snapshot</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vmm.ping&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmmPing</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token macro property">endpoint!</span><span class="token punctuation">(</span><span class="token string">&quot;/vmm.shutdown&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmmShutdown</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        r
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x5185;&#x90E8;channel"><a name="&#x5185;&#x90E8;channel" class="anchor-navigation-ex-anchor" href="#&#x5185;&#x90E8;channel"><i class="fa fa-link" aria-hidden="true"></i></a>3.7. &#x5185;&#x90E8;channel</h2>
<p>rust&#x6807;&#x51C6;&#x5E93;&#x7684;channel&#x662F;mpsc, &#x521B;&#x5EFA;channel:</p>
<pre class="language-"><code class="lang-rust"><span class="token comment">// &#x7F16;&#x8BD1;&#x5668;&#x4F1A;&#x4ECE;&#x4E0B;&#x6587;&#x63A8;&#x65AD;&#x51FA;&#x8FD9;&#x4E2A;channel&#x4F20;&#x8F93;&#x7684;&#x662F;ApiRequest</span>
<span class="token keyword">let</span> <span class="token punctuation">(</span>api_request_sender<span class="token punctuation">,</span> api_request_receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>mpsc<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;ApiRequest&#x662F;&#x4E2A;enum, &#x6240;&#x6709;&#x7684;http&#x8BF7;&#x6C42;&#x90FD;&#x5B9A;&#x4E49;&#x5728;&#x8FD9;;
&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x56DE;&#x590D;&#x8FD8;&#x662F;&#x4E00;&#x4E2A;Sender, &#x91CC;&#x9762;&#x662F;ApiResponse.
&#x8FD9;&#x4E2A;&#x5C31;&#x662F;rust&#x7248;&#x672C;&#x7684;channel in channel: &#x53D1;&#x51FA;http&#x8BF7;&#x6C42;&#x7684;&#x4E00;&#x65B9;, &#x6784;&#x9020;&#x8BF7;&#x6C42;&#x548C;&#x4E00;&#x4E2A;&#x4E13;&#x6709;&#x7684;Sender&#x53E5;&#x67C4;&#x7ED9;&#x670D;&#x52A1;&#x65B9;, &#x5E76;&#x7B49;&#x5F85;&#x5728;&#x5BF9;&#x5E94;&#x7684;Receiver; &#x670D;&#x52A1;&#x65B9;&#x628A;ApiResponse&#x54CD;&#x5E94;&#x5199;&#x56DE;&#x5230;&#x8FD9;&#x4E2A;Sender&#x91CC;&#x9762;;</p>
<pre class="language-"><code class="lang-rust"><span class="token attribute attr-name">#[allow(clippy::large_enum_variant)]</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">ApiRequest</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Create the virtual machine. This request payload is a VM configuration</span>
    <span class="token comment">/// (VmConfig).</span>
    <span class="token comment">/// If the VMM API server could not create the VM, it will send a VmCreate</span>
    <span class="token comment">/// error back.</span>
    <span class="token class-name">VmCreate</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">VmConfig</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Boot the previously created virtual machine.</span>
    <span class="token comment">/// If the VM was not previously created, the VMM API server will send a</span>
    <span class="token comment">/// VmBoot error back.</span>
    <span class="token class-name">VmBoot</span><span class="token punctuation">(</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Delete the previously created virtual machine.</span>
    <span class="token comment">/// If the VM was not previously created, the VMM API server will send a</span>
    <span class="token comment">/// VmDelete error back.</span>
    <span class="token comment">/// If the VM is booted, we shut it down first.</span>
    <span class="token class-name">VmDelete</span><span class="token punctuation">(</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Request the VM information.</span>
    <span class="token class-name">VmInfo</span><span class="token punctuation">(</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Request the VMM API server status</span>
    <span class="token class-name">VmmPing</span><span class="token punctuation">(</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Pause a VM.</span>
    <span class="token class-name">VmPause</span><span class="token punctuation">(</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Resume a VM.</span>
    <span class="token class-name">VmResume</span><span class="token punctuation">(</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Get counters for a VM.</span>
    <span class="token class-name">VmCounters</span><span class="token punctuation">(</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Shut the previously booted virtual machine down.</span>
    <span class="token comment">/// If the VM was not previously booted or created, the VMM API server</span>
    <span class="token comment">/// will send a VmShutdown error back.</span>
    <span class="token class-name">VmShutdown</span><span class="token punctuation">(</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Reboot the previously booted virtual machine.</span>
    <span class="token comment">/// If the VM was not previously booted or created, the VMM API server</span>
    <span class="token comment">/// will send a VmReboot error back.</span>
    <span class="token class-name">VmReboot</span><span class="token punctuation">(</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Shut the VMM down.</span>
    <span class="token comment">/// This will shutdown and delete the current VM, if any, and then exit the</span>
    <span class="token comment">/// VMM process.</span>
    <span class="token class-name">VmmShutdown</span><span class="token punctuation">(</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Resize the VM.</span>
    <span class="token class-name">VmResize</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">VmResizeData</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Resize the memory zone.</span>
    <span class="token class-name">VmResizeZone</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">VmResizeZoneData</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Add a device to the VM.</span>
    <span class="token class-name">VmAddDevice</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">DeviceConfig</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Add a user device to the VM.</span>
    <span class="token class-name">VmAddUserDevice</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">UserDeviceConfig</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Remove a device from the VM.</span>
    <span class="token class-name">VmRemoveDevice</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">VmRemoveDeviceData</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Add a disk to the VM.</span>
    <span class="token class-name">VmAddDisk</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">DiskConfig</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Add a fs to the VM.</span>
    <span class="token class-name">VmAddFs</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">FsConfig</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Add a pmem device to the VM.</span>
    <span class="token class-name">VmAddPmem</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">PmemConfig</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Add a network device to the VM.</span>
    <span class="token class-name">VmAddNet</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">NetConfig</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Add a vDPA device to the VM.</span>
    <span class="token class-name">VmAddVdpa</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">VdpaConfig</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Add a vsock device to the VM.</span>
    <span class="token class-name">VmAddVsock</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">VsockConfig</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Take a VM snapshot</span>
    <span class="token class-name">VmSnapshot</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">VmSnapshotConfig</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Restore from a VM snapshot</span>
    <span class="token class-name">VmRestore</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">RestoreConfig</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Incoming migration</span>
    <span class="token class-name">VmReceiveMigration</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">VmReceiveMigrationData</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Outgoing migration</span>
    <span class="token class-name">VmSendMigration</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">VmSendMigrationData</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// Trigger power button</span>
    <span class="token class-name">VmPowerButton</span><span class="token punctuation">(</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="&#x4EE3;&#x7801;&#x68B3;&#x7406;-main"><a name="&#x4EE3;&#x7801;&#x68B3;&#x7406;-main" class="anchor-navigation-ex-anchor" href="#&#x4EE3;&#x7801;&#x68B3;&#x7406;-main"><i class="fa fa-link" aria-hidden="true"></i></a>4. &#x4EE3;&#x7801;&#x68B3;&#x7406; main</h1>
<p>main&#x51FD;&#x6570;&#x5728;<code>cloud-hypervisor/src/main.rs</code></p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Ensure all created files (.e.g sockets) are only accessible by this user</span>
    <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0o077</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">//&#x9ED8;&#x8BA4;vCPU=1, &#x7269;&#x7406;&#x5730;&#x5740;46bit; mem=512M; &#x4F7F;&#x7528;/dev/urandom</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>default_vcpus<span class="token punctuation">,</span> default_memory<span class="token punctuation">,</span> default_rng<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">prepare_default_values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x4F7F;&#x7528;&#x4E86;&#x6D41;&#x884C;&#x7684;cli&#x5E93;clap, &#x7011;&#x5E03;&#x5F0F;&#x7684;&#x5B9A;&#x4E49;args</span>
    <span class="token comment">//get_matches&#x5C31;&#x662F;parse()&#x547D;&#x4EE4;&#x884C;</span>
    <span class="token keyword">let</span> cmd_arguments <span class="token operator">=</span> <span class="token function">create_app</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>default_vcpus<span class="token punctuation">,</span> <span class="token operator">&amp;</span>default_memory<span class="token punctuation">,</span> <span class="token operator">&amp;</span>default_rng<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get_matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> exit_code <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token function">start_vmm</span><span class="token punctuation">(</span>cmd_arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x652F;&#x6301;kvm&#x6216;mshv, &#x7F16;&#x8BD1;&#x65F6;&#x9009;&#x62E9;</span>
        <span class="token keyword">let</span> hypervisor <span class="token operator">=</span> <span class="token namespace">hypervisor<span class="token punctuation">::</span></span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">let</span> kvm_obj <span class="token operator">=</span> <span class="token class-name">Kvm</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">KvmHypervisor</span> <span class="token punctuation">{</span> kvm<span class="token punctuation">:</span> kvm_obj <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">let</span> vmm_thread <span class="token operator">=</span> <span class="token namespace">vmm<span class="token punctuation">::</span></span><span class="token function">start_vmm_thread</span><span class="token punctuation">(</span>
            <span class="token macro property">env!</span><span class="token punctuation">(</span><span class="token string">&quot;CARGO_PKG_VERSION&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>api_socket_path<span class="token punctuation">,</span>
            api_socket_fd<span class="token punctuation">,</span>
            api_evt<span class="token punctuation">.</span><span class="token function">try_clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            http_sender<span class="token punctuation">,</span>
            api_request_receiver<span class="token punctuation">,</span>
            <span class="token attribute attr-name">#[cfg(feature = <span class="token string">&quot;gdb&quot;</span>)]</span>
            gdb_socket_path<span class="token punctuation">,</span>
            <span class="token attribute attr-name">#[cfg(feature = <span class="token string">&quot;gdb&quot;</span>)]</span>
            debug_evt<span class="token punctuation">.</span><span class="token function">try_clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token attribute attr-name">#[cfg(feature = <span class="token string">&quot;gdb&quot;</span>)]</span>
            vm_debug_evt<span class="token punctuation">.</span><span class="token function">try_clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>seccomp_action<span class="token punctuation">,</span>
            hypervisor<span class="token punctuation">,</span> <span class="token comment">//&#x8FD9;&#x4E2A;&#x662F;&#x4E0A;&#x9762;&#x7684;kvm&#x5B9E;&#x4F8B;&#x5316;&#x7684;hypervisor</span>
        <span class="token punctuation">)</span>
            <span class="token keyword">let</span> thread <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token comment">//&#x65B0;&#x5EFA;thread&#x505A;&#x4E3B;event&#x5904;&#x7406;&#x5FAA;&#x73AF;</span>
                <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token class-name">Builder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;vmm&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span>  <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                        <span class="token comment">//&#x65B0;&#x5EFA;vmm, &#x4E3B;&#x8981;&#x662F;&#x6CE8;&#x518C;event, &#x5E76;&#x6CA1;&#x6709;&#x5F00;&#x59CB;&#x771F;&#x6B63;&#x5E72;&#x6D3B;</span>
                        <span class="token keyword">let</span> <span class="token keyword">mut</span> vmm <span class="token operator">=</span> <span class="token class-name">Vmm</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
                            vmm_version<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            api_event<span class="token punctuation">,</span>
                            vmm_seccomp_action<span class="token punctuation">,</span>
                            hypervisor<span class="token punctuation">,</span>
                            exit_evt<span class="token punctuation">,</span>
                        <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

                        <span class="token comment">//event&#x5FAA;&#x73AF;</span>
                        vmm<span class="token punctuation">.</span><span class="token function">control_loop</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>api_receiver<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token keyword">let</span> epoll_fd <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>epoll<span class="token punctuation">.</span><span class="token function">as_raw_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//&#x5728;loop&#x91CC;epoll wait, &#x5E76;&#x6839;&#x636E;&#x6CE8;&#x518C;epoll add&#x7684;token&#x6765;&#x5206;&#x53D1;</span>
                            <span class="token keyword">for</span> event <span class="token keyword">in</span> events<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>num_events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">let</span> dispatch_event<span class="token punctuation">:</span> <span class="token class-name">EpollDispatch</span> <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">match</span> dispatch_event <span class="token punctuation">{</span>
                                    <span class="token class-name">EpollDispatch</span><span class="token punctuation">::</span><span class="token class-name">Unknown</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                                    <span class="token class-name">EpollDispatch</span><span class="token punctuation">::</span><span class="token class-name">Exit</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                                    <span class="token class-name">EpollDispatch</span><span class="token punctuation">::</span><span class="token class-name">Reset</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                                    <span class="token class-name">EpollDispatch</span><span class="token punctuation">::</span><span class="token class-name">ActivateVirtioDevices</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                                    <span class="token class-name">EpollDispatch</span><span class="token punctuation">::</span><span class="token class-name">Api</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                                        <span class="token comment">//consume &#x89E6;&#x53D1;&#x5185;&#x90E8;channel&#x7684;eventfd</span>
                                        <span class="token keyword">self</span><span class="token punctuation">.</span>api_evt<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">EventFdRead</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
                                        <span class="token comment">//&#x5904;&#x7406;&#x5185;&#x90E8;channel&#x8FC7;&#x6765;&#x7684;&#x8BF7;&#x6C42;&#x5E76;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;</span>
                                        <span class="token keyword">let</span> api_request <span class="token operator">=</span> api_receiver<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token keyword">match</span> api_request <span class="token punctuation">{</span>
                                            <span class="token class-name">ApiRequest</span><span class="token punctuation">::</span><span class="token class-name">VmCreate</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> sender<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                                            <span class="token class-name">ApiRequest</span><span class="token punctuation">::</span><span class="token class-name">VmBoot</span><span class="token punctuation">(</span>sender<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                                            <span class="token punctuation">...</span>
                                        <span class="token punctuation">}</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">// &#x8D77;http&#x7EBF;&#x7A0B;, &#x7528;&#x7684;&#x662F;micro_http&#x7684;&#x5E93;</span>
            <span class="token namespace">api<span class="token punctuation">::</span></span><span class="token function">start_http_path_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">let</span> server <span class="token operator">=</span> <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new_from_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">start_http_thread</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>
                    <span class="token namespace">hread<span class="token punctuation">::</span></span><span class="token class-name">Builder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x65B0;&#x7EBF;&#x7A0B;</span>
                        <span class="token keyword">loop</span> <span class="token punctuation">{</span>
                            <span class="token keyword">match</span> server<span class="token punctuation">.</span><span class="token function">requests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token class-name">Ok</span><span class="token punctuation">(</span>request_vec<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">for</span> server_request <span class="token keyword">in</span> request_vec <span class="token punctuation">{</span>
                                        server<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span>server_request<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>
                                            <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>request<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                                                <span class="token function">handle_http_request</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">&amp;</span>api_notifier<span class="token punctuation">,</span> <span class="token operator">&amp;</span>api_sender<span class="token punctuation">)</span>
                                            <span class="token punctuation">}</span>
                                        <span class="token punctuation">)</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

        <span class="token comment">//&#x5E26;api&#x524D;&#x7F00;&#x7684;&#x90FD;&#x662F;&#x53D1;http&#x8BF7;&#x6C42;&#x5230;vmm.control_loop&#x7684;.</span>
        <span class="token namespace">vmm<span class="token punctuation">::</span>api<span class="token punctuation">::</span></span><span class="token function">vm_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token namespace">vmm<span class="token punctuation">::</span>api<span class="token punctuation">::</span></span><span class="token function">vm_boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//&#x6216;&#x8005;vmm::api::vm_restore()</span>
        vmm_thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token namespace">std<span class="token punctuation">::</span>process<span class="token punctuation">::</span></span><span class="token function">exit</span><span class="token punctuation">(</span>exit_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="hypervisor&#x7684;&#x62BD;&#x8C61;"><a name="hypervisor&#x7684;&#x62BD;&#x8C61;" class="anchor-navigation-ex-anchor" href="#hypervisor&#x7684;&#x62BD;&#x8C61;"><i class="fa fa-link" aria-hidden="true"></i></a>4.1. hypervisor&#x7684;&#x62BD;&#x8C61;</h2>
<p>&#x80FD;&#x5728;&#x6700;&#x9876;&#x5C42;&#x62BD;&#x8C61;&#x4E00;&#x4E2A;hypervisor, &#x540C;&#x65F6;&#x652F;&#x6301;&#x591A;&#x79CD;&#x865A;&#x62DF;&#x5316;&#x6280;&#x672F;.
&#x7528;&#x4E86;&#x62BD;&#x8C61;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x53E6;&#x4E00;&#x4E2A;&#x62BD;&#x8C61;&#x7684;&#x6A21;&#x5F0F;, &#x5373;create_vm&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;Vm trait object</p>
<pre class="language-"><code class="lang-rust"><span class="token comment">///</span>
<span class="token comment">/// Trait to represent a Hypervisor</span>
<span class="token comment">///</span>
<span class="token comment">/// This crate provides a hypervisor-agnostic interfaces</span>
<span class="token comment">///</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Hypervisor</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token comment">///</span>
    <span class="token comment">/// Create a Vm using the underlying hypervisor</span>
    <span class="token comment">/// Return a hypervisor-agnostic Vm trait object</span>
    <span class="token comment">///</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">create_vm</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Vm</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">///</span>
    <span class="token comment">/// Create a Vm of a specific type using the underlying hypervisor</span>
    <span class="token comment">/// Return a hypervisor-agnostic Vm trait object</span>
    <span class="token comment">///</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">create_vm_with_type</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _vm_type<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Vm</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token macro property">unreachable!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
    <span class="token comment">///</span>
    <span class="token comment">/// Get the supported CpuID</span>
    <span class="token comment">///</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">get_cpuid</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">CpuId</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">///</span>
    <span class="token comment">/// Check particular extensions if any</span>
    <span class="token comment">///</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">check_required_extensions</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
    <span class="token comment">///</span>
    <span class="token comment">/// Retrieve the list of MSRs supported by the hypervisor.</span>
    <span class="token comment">///</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">get_msr_list</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">MsrList</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;aarch64&quot;</span>)]</span>
    <span class="token comment">///</span>
    <span class="token comment">/// Retrieve AArch64 host maximum IPA size supported by KVM.</span>
    <span class="token comment">///</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">get_host_ipa_limit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">i32</span><span class="token punctuation">;</span>
    <span class="token comment">///</span>
    <span class="token comment">/// Retrieve TDX capabilities</span>
    <span class="token comment">///</span>
    <span class="token attribute attr-name">#[cfg(feature = <span class="token string">&quot;tdx&quot;</span>)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">tdx_capabilities</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">TdxCapabilities</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="vm&#x62BD;&#x8C61;&#x57FA;&#x672C;&#x4E0A;&#x662F;&#x57FA;&#x4E8E;kvm-api&#x7684;"><a name="vm&#x62BD;&#x8C61;&#x57FA;&#x672C;&#x4E0A;&#x662F;&#x57FA;&#x4E8E;kvm-api&#x7684;" class="anchor-navigation-ex-anchor" href="#vm&#x62BD;&#x8C61;&#x57FA;&#x672C;&#x4E0A;&#x662F;&#x57FA;&#x4E8E;kvm-api&#x7684;"><i class="fa fa-link" aria-hidden="true"></i></a>4.1.1. vm&#x62BD;&#x8C61;&#x57FA;&#x672C;&#x4E0A;&#x662F;&#x57FA;&#x4E8E;kvm api&#x7684;</h3>
<pre class="language-"><code class="lang-rust"><span class="token comment">///</span>
<span class="token comment">/// Trait to represent a Vm</span>
<span class="token comment">///</span>
<span class="token comment">/// This crate provides a hypervisor-agnostic interfaces for Vm</span>
<span class="token comment">///</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Vm</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
    <span class="token comment">/// Sets the address of the one-page region in the VM&apos;s address space.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">set_identity_map_address</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> address<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
    <span class="token comment">/// Sets the address of the three-page region in the VM&apos;s address space.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">set_tss_address</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> offset<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Creates an in-kernel interrupt controller.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">create_irq_chip</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Registers an event that will, when signaled, trigger the `gsi` IRQ.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">register_irqfd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> fd<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">EventFd</span><span class="token punctuation">,</span> gsi<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Unregister an event that will, when signaled, trigger the `gsi` IRQ.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">unregister_irqfd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> fd<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">EventFd</span><span class="token punctuation">,</span> gsi<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Creates a new KVM vCPU file descriptor and maps the memory corresponding</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">create_vcpu</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> id<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> vm_ops<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">VmOps</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Vcpu</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Registers an event to be signaled whenever a certain address is written to.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">register_ioevent</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
        fd<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">EventFd</span><span class="token punctuation">,</span>
        addr<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">IoEventAddress</span><span class="token punctuation">,</span>
        datamatch<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">DataMatch</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Unregister an event from a certain address it has been previously registered to.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">unregister_ioevent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> fd<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">EventFd</span><span class="token punctuation">,</span> addr<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">IoEventAddress</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">// Construct a routing entry</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">make_routing_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> gsi<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> config<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">InterruptSourceConfig</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">IrqRoutingEntry</span><span class="token punctuation">;</span>
    <span class="token comment">/// Sets the GSI routing table entries, overwriting any previously set</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">set_gsi_routing</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">IrqRoutingEntry</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Creates a memory region structure that can be used with {create/remove}_user_memory_region</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">make_user_memory_region</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
        slot<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
        guest_phys_addr<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
        memory_size<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
        userspace_addr<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
        readonly<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
        log_dirty_pages<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">MemoryRegion</span><span class="token punctuation">;</span>
    <span class="token comment">/// Creates a guest physical memory slot.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">create_user_memory_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> user_memory_region<span class="token punctuation">:</span> <span class="token class-name">MemoryRegion</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Removes a guest physical memory slot.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">remove_user_memory_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> user_memory_region<span class="token punctuation">:</span> <span class="token class-name">MemoryRegion</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Creates an emulated device in the kernel.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">create_device</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">CreateDevice</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Device</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Returns the preferred CPU target type which can be emulated by KVM on underlying host.</span>
    <span class="token attribute attr-name">#[cfg(any(target_arch = <span class="token string">&quot;arm&quot;</span>, target_arch = <span class="token string">&quot;aarch64&quot;</span>))]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">get_preferred_target</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> kvi<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">VcpuInit</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Enable split Irq capability</span>
    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">enable_split_irq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">enable_sgx_attribute</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> file<span class="token punctuation">:</span> <span class="token class-name">File</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Retrieve guest clock.</span>
    <span class="token attribute attr-name">#[cfg(all(feature = <span class="token string">&quot;kvm&quot;</span>, target_arch = <span class="token string">&quot;x86_64&quot;</span>))]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">get_clock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">ClockData</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Set guest clock.</span>
    <span class="token attribute attr-name">#[cfg(all(feature = <span class="token string">&quot;kvm&quot;</span>, target_arch = <span class="token string">&quot;x86_64&quot;</span>))]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">set_clock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">ClockData</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token attribute attr-name">#[cfg(feature = <span class="token string">&quot;kvm&quot;</span>)]</span>
    <span class="token comment">/// Checks if a particular `Cap` is available.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">check_extension</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> c<span class="token punctuation">:</span> <span class="token class-name">Cap</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span><span class="token punctuation">;</span>
    <span class="token comment">/// Create a device that is used for passthrough</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">create_passthrough_device</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Device</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Get the Vm state. Return VM specific data</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">state</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">VmState</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Set the VM state</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">set_state</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token class-name">VmState</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Start logging dirty pages</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">start_dirty_log</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Stop logging dirty pages</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">stop_dirty_log</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Get dirty pages bitmap</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">get_dirty_log</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> slot<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> base_gpa<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> memory_size<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u64</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
    <span class="token attribute attr-name">#[cfg(feature = <span class="token string">&quot;tdx&quot;</span>)]</span>
    <span class="token comment">/// Initalize TDX on this VM</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">tdx_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> cpuid<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">CpuId</span><span class="token punctuation">,</span> max_vcpus<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token attribute attr-name">#[cfg(feature = <span class="token string">&quot;tdx&quot;</span>)]</span>
    <span class="token comment">/// Finalize the configuration of TDX on this VM</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">tdx_finalize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token attribute attr-name">#[cfg(feature = <span class="token string">&quot;tdx&quot;</span>)]</span>
    <span class="token comment">/// Initalize a TDX memory region for this VM</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">tdx_init_memory_region</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
        host_address<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
        guest_address<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
        size<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
        measure<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="vmops"><a name="vmops" class="anchor-navigation-ex-anchor" href="#vmops"><i class="fa fa-link" aria-hidden="true"></i></a>4.1.2. vmops</h3>
<p>vm&#x7684;op&#x4E3B;&#x8981;&#x9488;&#x5BF9;gpa, guest physical address</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">VmOps</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x5BF9;guest dram&#x6765;&#x8BF4;&#x7684;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">guest_mem_write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> gpa<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">guest_mem_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> gpa<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x5BF9;guest mmio&#x6765;&#x8BF4;&#x7684;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">mmio_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> gpa<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">mmio_write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> gpa<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x5BF9;guest pio&#x6765;&#x8BF4;&#x7684;</span>
    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">pio_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> port<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">pio_write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> port<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="cli-create-vm&#x4EE3;&#x7801;&#x6D41;&#x7A0B;"><a name="cli-create-vm&#x4EE3;&#x7801;&#x6D41;&#x7A0B;" class="anchor-navigation-ex-anchor" href="#cli-create-vm&#x4EE3;&#x7801;&#x6D41;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a>5. cli create vm&#x4EE3;&#x7801;&#x6D41;&#x7A0B;</h1>
<p>&#x547D;&#x4EE4;&#x884C;&#x4F20;&#x5165;&#x7684;kernel&#x9009;&#x9879;, &#x4F1A;&#x88AB;parse&#x6210;vm config, &#x518D;&#x521B;&#x5EFA;vm</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">let</span> vm_params <span class="token operator">=</span> <span class="token namespace">config<span class="token punctuation">::</span></span><span class="token class-name">VmParams</span><span class="token punctuation">::</span><span class="token function">from_arg_matches</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cmd_arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> vm_config <span class="token operator">=</span> <span class="token namespace">config<span class="token punctuation">::</span></span><span class="token class-name">VmConfig</span><span class="token punctuation">::</span><span class="token function">parse</span><span class="token punctuation">(</span>vm_params<span class="token punctuation">)</span>

<span class="token comment">// Create and boot the VM based off the VM config we just built.</span>
<span class="token keyword">let</span> sender <span class="token operator">=</span> api_request_sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token namespace">vmm<span class="token punctuation">::</span>api<span class="token punctuation">::</span></span><span class="token function">vm_create</span><span class="token punctuation">(</span>
    api_evt<span class="token punctuation">.</span><span class="token function">try_clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    api_request_sender<span class="token punctuation">,</span>
    <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>vm_config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;vm_create&#x5C31;&#x662F;&#x7ED9;&#x5185;&#x90E8;http&#x670D;&#x52A1;&#x53D1;&#x8BF7;&#x6C42;:</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">vm_create</span><span class="token punctuation">(</span>
    api_evt<span class="token punctuation">:</span> <span class="token class-name">EventFd</span><span class="token punctuation">,</span>
    api_sender<span class="token punctuation">:</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiRequest</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    config<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">VmConfig</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ApiResult</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>response_sender<span class="token punctuation">,</span> response_receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Send the VM creation request.</span>
    api_sender
        <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">ApiRequest</span><span class="token punctuation">::</span><span class="token class-name">VmCreate</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> response_sender<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">ApiError</span><span class="token punctuation">::</span><span class="token class-name">RequestSend</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    api_evt<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">ApiError</span><span class="token punctuation">::</span><span class="token class-name">EventFdWrite</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    response_receiver<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">ApiError</span><span class="token punctuation">::</span><span class="token class-name">ResponseRecv</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="rest-api&#x6D41;&#x7A0B;&#x5B9E;&#x4F8B;"><a name="rest-api&#x6D41;&#x7A0B;&#x5B9E;&#x4F8B;" class="anchor-navigation-ex-anchor" href="#rest-api&#x6D41;&#x7A0B;&#x5B9E;&#x4F8B;"><i class="fa fa-link" aria-hidden="true"></i></a>6. REST API&#x6D41;&#x7A0B;&#x5B9E;&#x4F8B;</h1>
<h2 id="&#x7528;&#x6237;&#x53D1;rest-api"><a name="&#x7528;&#x6237;&#x53D1;rest-api" class="anchor-navigation-ex-anchor" href="#&#x7528;&#x6237;&#x53D1;rest-api"><i class="fa fa-link" aria-hidden="true"></i></a>6.1. &#x7528;&#x6237;&#x53D1;REST API</h2>
<p>A user or operator sends an HTTP request to the Cloud Hypervisor <a href="https://github.com/cloud-hypervisor/cloud-hypervisor/blob/main/docs/api.md#rest-api" target="_blank">REST API</a> in order to creates a virtual machine:</p>
<pre class="language-"><code class="lang-sh"><span class="token shebang important">#!/bin/bash</span>

 <span class="token function">curl</span> --unix-socket /tmp/cloud-hypervisor.sock <span class="token parameter variable">-i</span> <span class="token punctuation">\</span>
     <span class="token parameter variable">-X</span> PUT <span class="token string">&apos;http://localhost/api/v1/vm.create&apos;</span>  <span class="token punctuation">\</span>
     <span class="token parameter variable">-H</span> <span class="token string">&apos;Accept: application/json&apos;</span>               <span class="token punctuation">\</span>
     <span class="token parameter variable">-H</span> <span class="token string">&apos;Content-Type: application/json&apos;</span>         <span class="token punctuation">\</span>
     <span class="token parameter variable">-d</span> <span class="token string">&apos;{
         &quot;cpus&quot;:{&quot;boot_vcpus&quot;: 4, &quot;max_vcpus&quot;: 4},
         &quot;kernel&quot;:{&quot;path&quot;:&quot;/opt/clh/kernel/vmlinux-virtio-fs-virtio-iommu&quot;},
         &quot;cmdline&quot;:{&quot;args&quot;:&quot;console=ttyS0 console=hvc0 root=/dev/vda1 rw&quot;},
         &quot;disks&quot;:[{&quot;path&quot;:&quot;/opt/clh/images/focal-server-cloudimg-amd64.raw&quot;}],
         &quot;rng&quot;:{&quot;src&quot;:&quot;/dev/urandom&quot;},
         &quot;net&quot;:[{&quot;ip&quot;:&quot;192.168.10.10&quot;, &quot;mask&quot;:&quot;255.255.255.0&quot;, &quot;mac&quot;:&quot;12:34:56:78:90:01&quot;}]
         }&apos;</span>
</code></pre>
<h2 id="&#x8FD9;&#x4E2A;vmm&#x5BF9;&#x5E94;&#x7684;http-server&#x54CD;&#x5E94;&#x8BF7;&#x6C42;"><a name="&#x8FD9;&#x4E2A;vmm&#x5BF9;&#x5E94;&#x7684;http-server&#x54CD;&#x5E94;&#x8BF7;&#x6C42;" class="anchor-navigation-ex-anchor" href="#&#x8FD9;&#x4E2A;vmm&#x5BF9;&#x5E94;&#x7684;http-server&#x54CD;&#x5E94;&#x8BF7;&#x6C42;"><i class="fa fa-link" aria-hidden="true"></i></a>6.2. &#x8FD9;&#x4E2A;VMM&#x5BF9;&#x5E94;&#x7684;http server&#x54CD;&#x5E94;&#x8BF7;&#x6C42;</h2>
<p>The Cloud Hypervisor HTTP thread processes the request and de-serializes the HTTP request JSON body into an internal <code>VmConfig</code> structure.
micro_http&#x54CD;&#x5E94;&#x8FD9;&#x4E2A;&#x8BF7;&#x6C42;, &#x8C03;&#x7528;&#x63D0;&#x524D;&#x6CE8;&#x518C;&#x597D;&#x7684;EndpointHandler:</p>
<pre class="language-"><code class="lang-rust"><span class="token comment">// /api/v1/vm.create handler</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">VmCreate</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">EndpointHandler</span> <span class="token keyword">for</span> <span class="token class-name">VmCreate</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">handle_request</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
        req<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Request</span><span class="token punctuation">,</span>
        api_notifier<span class="token punctuation">:</span> <span class="token class-name">EventFd</span><span class="token punctuation">,</span>
        api_sender<span class="token punctuation">:</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiRequest</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Response</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> req<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Method</span><span class="token punctuation">::</span><span class="token class-name">Put</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">match</span> <span class="token operator">&amp;</span>req<span class="token punctuation">.</span>body <span class="token punctuation">{</span>
                    <span class="token class-name">Some</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Deserialize into a VmConfig</span>
                        <span class="token keyword">let</span> vm_config<span class="token punctuation">:</span> <span class="token class-name">VmConfig</span> <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_slice</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">HttpError</span><span class="token punctuation">::</span><span class="token class-name">SerdeJsonDeserialize</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            <span class="token class-name">Ok</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> config<span class="token punctuation">,</span>
                            <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">return</span> <span class="token function">error_response</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token class-name">BadRequest</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">;</span>

                        <span class="token comment">// Call vm_create()</span>
                        <span class="token keyword">match</span> <span class="token function">vm_create</span><span class="token punctuation">(</span>api_notifier<span class="token punctuation">,</span> api_sender<span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>vm_config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">HttpError</span><span class="token punctuation">::</span><span class="token class-name">ApiError</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            <span class="token class-name">Ok</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Response</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Version</span><span class="token punctuation">::</span><span class="token class-name">Http11</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token class-name">NoContent</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">error_response</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token class-name">InternalServerError</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token class-name">None</span> <span class="token operator">=&gt;</span> <span class="token class-name">Response</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Version</span><span class="token punctuation">::</span><span class="token class-name">Http11</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token class-name">BadRequest</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            _ <span class="token operator">=&gt;</span> <span class="token function">error_response</span><span class="token punctuation">(</span><span class="token class-name">HttpError</span><span class="token punctuation">::</span><span class="token class-name">BadRequest</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token class-name">BadRequest</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x4ECE;http&#x7684;raw-data&#x91CC;json&#x683C;&#x5F0F;&#x89E3;&#x6790;vmconfig"><a name="&#x4ECE;http&#x7684;raw-data&#x91CC;json&#x683C;&#x5F0F;&#x89E3;&#x6790;vmconfig" class="anchor-navigation-ex-anchor" href="#&#x4ECE;http&#x7684;raw-data&#x91CC;json&#x683C;&#x5F0F;&#x89E3;&#x6790;vmconfig"><i class="fa fa-link" aria-hidden="true"></i></a>6.2.1. &#x4ECE;http&#x7684;raw data&#x91CC;(json&#x683C;&#x5F0F;)&#x89E3;&#x6790;VmConfig</h3>
<pre class="language-"><code class="lang-rust"><span class="token keyword">let</span> vm_config<span class="token punctuation">:</span> <span class="token class-name">VmConfig</span> <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_slice</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="vmcreate&#x4F7F;&#x7528;&#x5185;&#x90E8;channel&#x5411;vmm&#x7684;api&#x53D1;&#x9001;&#x8BF7;&#x6C42;"><a name="vmcreate&#x4F7F;&#x7528;&#x5185;&#x90E8;channel&#x5411;vmm&#x7684;api&#x53D1;&#x9001;&#x8BF7;&#x6C42;" class="anchor-navigation-ex-anchor" href="#vmcreate&#x4F7F;&#x7528;&#x5185;&#x90E8;channel&#x5411;vmm&#x7684;api&#x53D1;&#x9001;&#x8BF7;&#x6C42;"><i class="fa fa-link" aria-hidden="true"></i></a>6.2.2. vm_create&#x4F7F;&#x7528;&#x5185;&#x90E8;channel&#x5411;VMM&#x7684;API&#x53D1;&#x9001;&#x8BF7;&#x6C42;</h3>
<p>vm_create&#x4F7F;&#x7528;&#x5185;&#x90E8;channel&#x5411;VMM&#x7684;API&#x53D1;&#x9001;&#x8BF7;&#x6C42;, &#x8BF7;&#x6C42;&#x7684;&#x5185;&#x5BB9;&#x662F;VmConfig, &#x5E76;&#x4F7F;&#x7528;channel in channel&#x6765;&#x7B49;&#x5F85;&#x56DE;&#x590D;</p>
<pre class="language-"><code class="lang-rust"><span class="token class-name">VmCreate</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">VmConfig</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">ApiResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>

    <span class="token comment">// &#x6784;&#x9020;&#x5185;&#x90E8;channel</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>response_sender<span class="token punctuation">,</span> response_receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>mpsc<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Send the VM creation request.</span>
    api_sender
     <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">ApiRequest</span><span class="token punctuation">::</span><span class="token class-name">VmCreate</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> response_sender<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">ApiError</span><span class="token punctuation">::</span><span class="token class-name">RequestSend</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    api_evt<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">ApiError</span><span class="token punctuation">::</span><span class="token class-name">EventFdWrite</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    response_receiver<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">ApiError</span><span class="token punctuation">::</span><span class="token class-name">ResponseRecv</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="&#x5185;&#x90E8;channel&#x5904;&#x7406;&#x8BF7;&#x6C42;"><a name="&#x5185;&#x90E8;channel&#x5904;&#x7406;&#x8BF7;&#x6C42;" class="anchor-navigation-ex-anchor" href="#&#x5185;&#x90E8;channel&#x5904;&#x7406;&#x8BF7;&#x6C42;"><i class="fa fa-link" aria-hidden="true"></i></a>6.3. &#x5185;&#x90E8;channel&#x5904;&#x7406;&#x8BF7;&#x6C42;</h2>
<pre class="language-"><code class="lang-rust"><span class="token comment">// Read from the API receiver channel</span>
<span class="token keyword">let</span> api_request <span class="token operator">=</span> api_receiver<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">ApiRequestRecv</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="&#x5904;&#x7406;&#x8FD9;&#x6B21;&#x7684;vmcreate"><a name="&#x5904;&#x7406;&#x8FD9;&#x6B21;&#x7684;vmcreate" class="anchor-navigation-ex-anchor" href="#&#x5904;&#x7406;&#x8FD9;&#x6B21;&#x7684;vmcreate"><i class="fa fa-link" aria-hidden="true"></i></a>6.3.1. &#x5904;&#x7406;&#x8FD9;&#x6B21;&#x7684;VmCreate</h3>
<p>The Cloud Hypervisor control loop matches the received internal API against the <code>VmCreate</code> payload, and extracts both the <code>VmConfig</code> structure and the <a href="https://doc.rust-lang.org/std/sync/mpsc/struct.Sender.html" target="_blank">Sender</a> from the command payload. It stores the <code>VmConfig</code> structure and replies back to the sender ((The HTTP thread):</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">match</span> api_request <span class="token punctuation">{</span>
    <span class="token class-name">ApiRequest</span><span class="token punctuation">::</span><span class="token class-name">VmCreate</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> sender<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// We only store the passed VM config.</span>
        <span class="token comment">// The VM will be created when being asked to boot it.</span>
        <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>vm_config<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>vm_config <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">ApiResponsePayload</span><span class="token punctuation">::</span><span class="token class-name">Empty</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ApiError</span><span class="token punctuation">::</span><span class="token class-name">VmAlreadyCreated</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">ApiResponseSend</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x91CC;create vm&#x5E76;&#x6CA1;&#x6709;&#x771F;&#x6B63;&#x7684;create, &#x800C;&#x53EA;&#x662F;&#x4FDD;&#x5B58;vmconfig, &#x5F85;&#x5230;boot&#x7684;&#x65F6;&#x5019;&#x518D;&#x521B;&#x5EFA;</p>
<h2 id="&#x8FD4;&#x56DE;response"><a name="&#x8FD4;&#x56DE;response" class="anchor-navigation-ex-anchor" href="#&#x8FD4;&#x56DE;response"><i class="fa fa-link" aria-hidden="true"></i></a>6.4. &#x8FD4;&#x56DE;response</h2>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;, &#x7528;&#x6237;&#x7684;curl&#x8BF7;&#x6C42;&#x7B49;&#x5230;&#x52A8;&#x4F5C;&#x6267;&#x884C;&#x5B8C;&#x6BD5;&#x540E;, &#x5C31;&#x4F1A;&#x6536;&#x5230;response</p>
<h1 id="impl-vmm"><a name="impl-vmm" class="anchor-navigation-ex-anchor" href="#impl-vmm"><i class="fa fa-link" aria-hidden="true"></i></a>7. impl Vmm</h1>
<p>&#x4EE3;&#x7801;&#x5728;<code>cloud-hypervisor/vmm/src/lib.rs</code><br>vm_create&#x548C;vm_boot&#x7B49;&#x771F;&#x6B63;&#x6267;&#x884C;&#x5728;Vmm&#x7684;&#x65B9;&#x6CD5;&#x91CC;:</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span> <span class="token class-name">Vmm</span> <span class="token punctuation">{</span>
    <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">vm_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">vm_boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="x8664&#x548C;aarch64&#x7684;mem-layout"><a name="x8664&#x548C;aarch64&#x7684;mem-layout" class="anchor-navigation-ex-anchor" href="#x8664&#x548C;aarch64&#x7684;mem-layout"><i class="fa fa-link" aria-hidden="true"></i></a>7.1. x86_64&#x548C;aarch64&#x7684;mem layout</h2>
<p><img src="img/rust_cloud-hypervisor_&#x4EE3;&#x7801;_20220826233354.png" alt=""><br>&#x548C;firecracker&#x76F8;&#x6BD4;, cloudhypervisor&#x91CD;&#x70B9;&#x5728;pci mmio.</p>
<h2 id="vmboot"><a name="vmboot" class="anchor-navigation-ex-anchor" href="#vmboot"><i class="fa fa-link" aria-hidden="true"></i></a>7.2. vm_boot</h2>
<p>&#x524D;&#x9762;&#x8BF4;&#x8FC7;, vm_create&#x53EA;&#x662F;&#x4FDD;&#x5B58;vmconfig, &#x800C;vm_boot&#x662F;&#x771F;&#x6B63;&#x521B;&#x5EFA;&#x5E76;&#x8FD0;&#x884C;vm&#x7684;&#x5730;&#x65B9;</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token class-name">Vm</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
    <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span>vm_config<span class="token punctuation">)</span><span class="token punctuation">,</span>
    exit_evt<span class="token punctuation">,</span>
    reset_evt<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>seccomp_action<span class="token punctuation">,</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>hypervisor<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    activate_evt<span class="token punctuation">,</span>
    <span class="token class-name">None</span><span class="token punctuation">,</span>
    <span class="token class-name">None</span><span class="token punctuation">,</span>
    <span class="token class-name">None</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token comment">//vm&#x4EE3;&#x7801;&#x5728;cloud-hypervisor/vmm/src/vm.rs</span>
    <span class="token keyword">let</span> vm <span class="token operator">=</span> hypervisor<span class="token punctuation">.</span><span class="token function">create_vm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//kvm ioctl KVM_CREATE_VM</span>
        <span class="token comment">//return Arc::new(KvmVm {fd: vm_fd, state:  VmState {}, ...}</span>
    <span class="token comment">//&#x4E0B;&#x9762;3&#x4E2A;&#x4E8B;x86&#x72EC;&#x6709;</span>
    vm<span class="token punctuation">.</span><span class="token function">set_identity_map_address</span><span class="token punctuation">(</span><span class="token constant">KVM_IDENTITY_MAP_START</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">)</span>
    vm<span class="token punctuation">.</span><span class="token function">set_tss_address</span><span class="token punctuation">(</span><span class="token constant">KVM_TSS_START</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span>
    vm<span class="token punctuation">.</span><span class="token function">enable_split_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//KVM_ENABLE_CAP</span>
    <span class="token keyword">let</span> memory_manager <span class="token operator">=</span> <span class="token class-name">MemoryManager</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
        <span class="token comment">//&#x5EFA;&#x7ACB;&#x5185;&#x5B58;region Vec, &#x8FD9;&#x4E2A;Vec&#x7684;&#x5143;&#x7D20;&#x662F;(start, size, type)</span>
        <span class="token comment">//&#x6BD4;&#x5982;&#x4E00;&#x822C;&#x5185;&#x5B58;&#x5206;2G, [(0,2G,ram), (3G, 640M, SubRegion), (3G+640M, &#x5927;&#x6982;200M, Reserved)]</span>
        <span class="token keyword">let</span> arch_mem_regions <span class="token operator">=</span> <span class="token namespace">arch<span class="token punctuation">::</span></span><span class="token function">arch_memory_regions</span><span class="token punctuation">(</span>ram_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x5F88;&#x590D;&#x6742;</span>
        <span class="token punctuation">...</span>
        <span class="token keyword">let</span> allocator <span class="token operator">=</span>
            <span class="token class-name">SystemAllocator</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
                io_base<span class="token punctuation">:</span><span class="token number">0</span>
                io_size<span class="token punctuation">:</span> 64K
                platform_mmio_base<span class="token punctuation">:</span> max_mem <span class="token operator">-</span> 1M
                platform_mmio_size<span class="token punctuation">:</span> 1M
                mmio_hole_base<span class="token punctuation">:</span> <span class="token number">0xc000_0000</span>
                mmio_hole_size<span class="token punctuation">:</span> 640M
                <span class="token constant">X86_64_IRQ_BASE</span><span class="token punctuation">:</span> <span class="token number">5</span>
                irq_num<span class="token punctuation">:</span> <span class="token number">24</span><span class="token operator">-</span><span class="token number">5</span>
            <span class="token punctuation">)</span>
        <span class="token comment">//acpi&#x5728;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x6700;&#x540E;1M&#x7684;platform mmio&#x533A;&#x57DF;</span>
        acpi_address <span class="token operator">=</span> allocator<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">allocate_platform_mmio_addresses</span><span class="token punctuation">(</span><span class="token constant">MEMORY_MANAGER_ACPI_SIZE</span><span class="token punctuation">)</span>
        <span class="token comment">//&#x4ECE;0&#x5F00;&#x59CB;&#x5230;start_of_device_area&#x7684;&#x533A;&#x57DF;&#x662F;ram</span>
        <span class="token keyword">let</span> ram_allocator <span class="token operator">=</span> <span class="token class-name">AddressAllocator</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">GuestAddress</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> start_of_device_area<span class="token number">.0</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> memory_manager <span class="token operator">=</span> <span class="token class-name">MemoryManager</span> <span class="token punctuation">{</span>
            boot_guest_memory<span class="token punctuation">,</span>
            guest_memory<span class="token punctuation">,</span>
            next_memory_slot<span class="token punctuation">,</span>
            start_of_device_area<span class="token punctuation">,</span>
            end_of_device_area<span class="token punctuation">,</span>
            end_of_ram_area<span class="token punctuation">,</span>
            vm<span class="token punctuation">,</span>
            hotplug_slots<span class="token punctuation">,</span>
            selected_slot<span class="token punctuation">,</span>
            mergeable<span class="token punctuation">:</span> config<span class="token punctuation">.</span>mergeable<span class="token punctuation">,</span>
            allocator<span class="token punctuation">,</span>
            hotplug_method<span class="token punctuation">:</span> config<span class="token punctuation">.</span>hotplug_method<span class="token punctuation">,</span>
            boot_ram<span class="token punctuation">,</span>
            current_ram<span class="token punctuation">,</span>
            next_hotplug_slot<span class="token punctuation">,</span>
            shared<span class="token punctuation">:</span> config<span class="token punctuation">.</span>shared<span class="token punctuation">,</span>
            hugepages<span class="token punctuation">:</span> config<span class="token punctuation">.</span>hugepages<span class="token punctuation">,</span>
            hugepage_size<span class="token punctuation">:</span> config<span class="token punctuation">.</span>hugepage_size<span class="token punctuation">,</span>
            prefault<span class="token punctuation">:</span> config<span class="token punctuation">.</span>prefault<span class="token punctuation">,</span>
            user_provided_zones<span class="token punctuation">,</span>
            snapshot_memory_ranges<span class="token punctuation">:</span> <span class="token class-name">MemoryRangeTable</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            memory_zones<span class="token punctuation">,</span>
            guest_ram_mappings<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            acpi_address<span class="token punctuation">,</span>
            log_dirty<span class="token punctuation">:</span> dynamic<span class="token punctuation">,</span> <span class="token comment">// Cannot log dirty pages on a TD</span>
            arch_mem_regions<span class="token punctuation">,</span>
            ram_allocator<span class="token punctuation">,</span>
            dynamic<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    memory_manager<span class="token punctuation">.</span><span class="token function">allocate_address_space</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>zone_id<span class="token punctuation">,</span> regions<span class="token punctuation">)</span> <span class="token keyword">in</span> list <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>region<span class="token punctuation">,</span> virtio_mem<span class="token punctuation">)</span> <span class="token keyword">in</span>  regions <span class="token punctuation">{</span>
                <span class="token comment">//ioctl KVM_SET_USER_MEMORY_REGION</span>
                <span class="token comment">//&#x8BB0;&#x5F55;user memory region&#x548C;slot&#x7684;&#x5173;&#x7CFB;&#x5230;Vec&lt;GuestRamMapping&gt;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>guest_ram_mappings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">GuestRamMapping</span> <span class="token punctuation">{</span>
                    gpa<span class="token punctuation">:</span> region<span class="token punctuation">.</span><span class="token function">start_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">raw_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    size<span class="token punctuation">:</span> region<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    slot<span class="token punctuation">,</span>
                    zone_id<span class="token punctuation">:</span> zone_id<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    virtio_mem<span class="token punctuation">,</span>
                    file_offset<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> &#x6BCF;&#x4E2A;&#x975E;ram&#x7684;region
        <span class="token keyword">self</span><span class="token punctuation">.</span>ram_allocator
            <span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">start_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> region<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span>
                <span class="token comment">//&#x5185;&#x90E8;&#x4F7F;&#x7528;BtreeMap&#x6765;&#x7BA1;&#x7406;&#x5185;&#x5B58;ranges, &#x628A;&#x6BCF;&#x4E2A;range insert&#x5230;BtreeMap</span>
                <span class="token comment">//&#x5E94;&#x8BE5;&#x90FD;&#x662F;&#x9488;&#x5BF9;guest &#x7269;&#x7406;&#x5730;&#x5740;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>ranges<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>new_addr<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> new_vm <span class="token operator">=</span> <span class="token class-name">Vm</span><span class="token punctuation">::</span><span class="token function">new_from_memory_manager</span><span class="token punctuation">(</span>memory_manager<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
        <span class="token comment">//1. &#x8D77;&#x4E00;&#x4E2A;&#x540E;&#x53F0;&#x7EBF;&#x7A0B;load kernel</span>
        <span class="token comment">//&#x652F;&#x6301;load ELF &#x6216; firmware, firmware load&#x5230;4G&#x5730;&#x5740;</span>
        <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">load_kernel_async</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kernel<span class="token punctuation">,</span> <span class="token operator">&amp;</span>memory_manager<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token operator">?</span>
            <span class="token namespace">linux_loader<span class="token punctuation">::</span>loader<span class="token punctuation">::</span>elf<span class="token punctuation">::</span></span><span class="token class-name">Elf</span><span class="token punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token namespace">linux_loader<span class="token punctuation">::</span>loader<span class="token punctuation">::</span></span><span class="token function">load_cmdline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x5230;CMDLINE_START&#x5730;&#x5740;</span>
            <span class="token comment">//&#x6216;&#x8005;&#x5F3A;&#x5236;load firmware&#x5230;4G-size&#x5730;&#x5740;, &#x5E76;&#x624B;&#x52A8;&#x6DFB;&#x52A0;&#x6620;&#x5C04;</span>

        <span class="token comment">//2. create numa node</span>
        <span class="token comment">//&#x4E3B;&#x8981;&#x662F;&#x4ECE;vm config&#x91CC;&#x9762;&#x63D0;&#x53D6;config.memory_zones&#x548C;config.distances&#x4FE1;&#x606F;&#x586B;&#x5145;&#x5230;BTreeMap</span>
        <span class="token keyword">let</span> numa_nodes <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">create_numa_nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">//3. &#x521B;&#x5EFA;device manager, &#x89C1;&#x4E0B;&#x9762;&#x7684;&#x8BE6;&#x89E3;</span>
        <span class="token comment">//cloud-hypervisor/vmm/src/device_manager.rs</span>
        <span class="token keyword">let</span> device_manager <span class="token operator">=</span> <span class="token class-name">DeviceManager</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
            vm<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            config<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            memory_manager<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>exit_evt<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>reset_evt<span class="token punctuation">,</span>
            seccomp_action<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            numa_nodes<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>activate_evt<span class="token punctuation">,</span>
            force_iommu<span class="token punctuation">,</span>
            restoring<span class="token punctuation">,</span>
            boot_id_list<span class="token punctuation">,</span>
            timestamp<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
            <span class="token comment">/*
            1. &#x65B0;&#x5EFA;device tree: HashMap&lt;String, DeviceNode&gt;
            2. num_pci_segments&#x9ED8;&#x8BA4;&#x4E3A;1, &#x53EF;&#x4EE5;&#x914D;
            3. &#x786E;&#x5B9A;device&#x533A;&#x57DF;(&#x5176;&#x5B9E;&#x5C31;&#x662F;PCI&#x8BBE;&#x5907;&#x533A;&#x57DF;), &#x89C1;&#x4E0A;&#x9762;layout&#x56FE;
            4. &#x65B0;&#x5EFA;address_manager
                {
                    allocator:  memory_manager.lock().unwrap().allocator(),
                    io_bus:  Arc::new(Bus::new()),
                    mmio_bus:  Arc::new(Bus::new()),
                    vm:  vm.clone(),
                    device_tree:  Arc::clone(&amp;device_tree),
                    pci_mmio_allocators,
                }
            5. &#x65B0;&#x5EFA;msi_interrupt_manager, IOAPIC&#x9700;&#x8981;&#x5B83;, legacy_interrupt_manager&#x9700;&#x8981;IOAPIC
                gsi_msi_routes&#x662F;&#x4E2A;HashMap&lt;u32, RoutingEntry&gt;, &#x6240;&#x6709;pci&#x7684;device&#x90FD;&#x5171;&#x4EAB;&#x8FD9;&#x4E2A;gsi
                RoutingEntry&#x5BF9;&#x5E94;kvm_irq_routing_entry
            6. &#x5206;&#x914D;acpi_address
            7. &#x4E3A;pci&#x9884;&#x7559;legacy&#x7684;&#x4E2D;&#x65AD;slot: pci_irq_slots  = [0; 32];
            8. &#x65B0;&#x5EFA;&#x9ED8;&#x8BA4;&#x7684;pci_segment, id&#x4E3A;0, &#x4E00;&#x4E2A;pci segment&#x5305;&#x62EC;&#x4E00;&#x4E2A;pci root&#x6865;, &#x4E00;&#x4E2A;PCI bus
            9. &#x6784;&#x5EFA;pci_segments Vec, &#x76EE;&#x524D;&#x770B;&#x5305;&#x62EC;id 0&#x548C;id1&#x7684;pci_segment
            10. &#x7528;&#x4E0A;&#x9762;&#x7684;&#x6750;&#x6599;&#x6784;&#x5EFA;device_manager&#x7ED3;&#x6784;&#x4F53;
            11. &#x628A;device_manager insert&#x5230;address_manager
            12. &#x8FD4;&#x56DE;device_manager
            */</span>

        <span class="token keyword">let</span> memory <span class="token operator">=</span> memory_manager<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">guest_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x53EA;&#x6709;x86&#x6709;io bus</span>
        <span class="token keyword">let</span> io_bus <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span>device_manager<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">io_bus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> mmio_bus <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span>device_manager<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mmio_bus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x53EA;&#x6709;x86&#x6709;pci io</span>
        <span class="token keyword">let</span> pci_config_io <span class="token operator">=</span>
            device_manager<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pci_config_io</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">BusDevice</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>

        <span class="token comment">//4. vm_ops</span>
        <span class="token keyword">let</span> vm_ops<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">VmOps</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmOpsHandler</span> <span class="token punctuation">{</span>
            memory<span class="token punctuation">,</span>
            <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
            io_bus<span class="token punctuation">,</span>
            mmio_bus<span class="token punctuation">,</span>
            <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
            pci_config_io<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5. &#x521B;&#x5EFA;cpu_manager &#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x7684;device_manager memory_manager vm_ops&#x6765;&quot;&#x64CD;&#x4F5C;&quot;VM</span>
        <span class="token namespace">cpu<span class="token punctuation">::</span></span><span class="token class-name">CpuManager</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">//6. &#x4ECE;&#x6587;&#x4EF6;&#x51C6;&#x5907;initramfs</span>
        <span class="token comment">//7. &#x6784;&#x5EFA;vm&#x7ED3;&#x6784;&#x4F53;&#x5E76;&#x8FD4;&#x56DE;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Vm</span> <span class="token punctuation">{</span>
            <span class="token attribute attr-name">#[cfg(any(target_arch = <span class="token string">&quot;aarch64&quot;</span>, feature = <span class="token string">&quot;tdx&quot;</span>))]</span>
            kernel<span class="token punctuation">,</span>
            initramfs<span class="token punctuation">,</span>
            device_manager<span class="token punctuation">,</span>
            config<span class="token punctuation">,</span>
            on_tty<span class="token punctuation">,</span>
            threads<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            signals<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            state<span class="token punctuation">:</span> <span class="token class-name">RwLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">VmState</span><span class="token punctuation">::</span><span class="token class-name">Created</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            cpu_manager<span class="token punctuation">,</span>
            memory_manager<span class="token punctuation">,</span>
            vm<span class="token punctuation">,</span>
            <span class="token attribute attr-name">#[cfg(all(feature = <span class="token string">&quot;kvm&quot;</span>, target_arch = <span class="token string">&quot;x86_64&quot;</span>))]</span>
            saved_clock<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            numa_nodes<span class="token punctuation">,</span>
            seccomp_action<span class="token punctuation">:</span> seccomp_action<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            exit_evt<span class="token punctuation">,</span>
            <span class="token attribute attr-name">#[cfg(all(feature = <span class="token string">&quot;kvm&quot;</span>, target_arch = <span class="token string">&quot;x86_64&quot;</span>))]</span>
            hypervisor<span class="token punctuation">,</span>
            stop_on_boot<span class="token punctuation">,</span>
            <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
            load_kernel_handle<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">//&#x6839;&#x636E;vm config&#x521B;&#x5EFA;&#x8BBE;&#x5907;, &#x4E3B;&#x8981;&#x662F;pci&#x7684;virtio&#x8BBE;&#x5907;, vfio&#x8BBE;&#x5907;&#x7B49;</span>
    new_vm<span class="token punctuation">.</span>device_manager<span class="token punctuation">.</span><span class="token function">create_devices</span><span class="token punctuation">(</span>serial_pty<span class="token punctuation">,</span> console_pty<span class="token punctuation">,</span> console_resize_pipe<span class="token punctuation">)</span>
        <span class="token comment">/*
        1. &#x521B;&#x5EFA;interrupt_controller
            &#x5BF9;x86&#x6765;&#x8BF4;&#x662F;IOAPIC, &#x5B83;&#x7684;&#x4E0A;&#x6E38;&#x662F;self.msi_interrupt_manager
            &#x5E76;&#x628A;&#x8FD9;&#x4E2A;&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;&#x6DFB;&#x52A0;&#x5230;address_manager bus_devices &#x548C;device_tree
            &#x5BF9;aarch64&#x6765;&#x8BF4;&#x662F;GIC, gic::Gic::new(), &#x4E0A;&#x6E38;&#x4E5F;&#x662F;self.msi_interrupt_manager
        2. &#x521B;&#x5EFA;legacy&#x7684;interrupt_controller, &#x57FA;&#x4E8E;&#x4E0A;&#x9762;&#x7684;interrupt_controller
        3. add_legacy_devices()
        4. add_acpi_devices()
        5. add_console_device()
        6. make_virtio_devices()
            let mut virtio_devices: Vec&lt;MetaVirtioDevice&gt; = Vec::new();
            make_virtio_block_devices()
            make_virtio_net_devices()
            make_virtio_rng_devices()
            make_virtio_fs_devices()
            make_virtio_pmem_devices()
            make_virtio_vsock_devices()
            make_virtio_mem_devices()
            make_virtio_balloon_devices()
            make_virtio_watchdog_devices()
            make_vdpa_devices()
        7. add_pci_devices(&#x4E0A;&#x9762;&#x7684;virtio&#x8BBE;&#x5907;)
            &#x521B;&#x5EFA;iommu_device: virtio_devices::Iommu::new()
            //&#x5BF9;&#x6BCF;&#x4E2A;virtio&#x8BBE;&#x5907;
            for handle in virtio_devices {
                add_virtio_pci_device() // &#x9ED8;&#x8BA4;add&#x5230;pci segment 0, &#x6CA1;&#x6709;iommu, &#x6CA1;&#x6709;dma
                    1. id&#x4E3A;&quot;xxx_virtio-pci&quot;
                    2. &#x7ED9;&#x8FD9;&#x4E2A;pci device&#x5206;&#x914D;pci&#x8D44;&#x6E90;, bdf&#x53F7;&#x7B49;
                        (pci_segment_id, pci_device_bdf, resources) = self.pci_resources()
                    3. msi&#x4E2D;&#x65AD;&#x4E2A;&#x6570;&#x4E3A;queue&#x4E2A;&#x6570;+1
                    4. &#x521B;&#x5EFA;virtio_pci_device
                        //Constructs a new PCI transport for the given virtio device.
                        virtio_pci_device =  VirtioPciDevice::new(
                            id,
                            memory,
                            virtio_device,
                            msix_num,
                            access_platform,
                            &amp;self.msi_interrupt_manager,
                            pci_device_bdf.into(),
                            self.activate_evt,
                            use_64bit_bar, //&#x9664;&#x4E86;virtio block&#x90FD;&#x662F;64&#x4F4D;.
                            dma_handler
                        )
                            &#x6BCF;&#x4E2A;queue&#x90FD;&#x914D;&#x4E00;&#x4E2A;eventfd
                            &#x521B;&#x5EFA;queues, queue&#x6709;&#x4E24;&#x4E2A;&#x6CDB;&#x578B;&#x53C2;&#x6570;
                            &#x6839;&#x636E;virtio&#x89C4;&#x8303;, pci_device_id&#x662F;0x1040+device_type.
                            &#x521B;&#x5EFA;interrupt group, &#x5373;&#x628A;&#x4E0B;&#x9762;&#x7684;&#x6BCF;&#x4E2A;irq&#x90FD;&#x7ED1;&#x5B9A;&#x4E00;&#x4E2A;eventfd&#x5230;irq
                            &#x914D;&#x7F6E;msix_config
                            &#x914D;&#x7F6E;class, &#x6BD4;&#x5982;PciClassCode::NetworkController&#x7B49;
                            &#x7EC4;&#x6210;configuration space&#x9700;&#x8981;&#x7684;&#x4FE1;&#x606F;:
                            let configuration = PciConfiguration::new(
                                VIRTIO_PCI_VENDOR_ID,
                                pci_device_id,
                                0x1,  // For modern virtio-PCI devices
                                class,
                                subclass,
                                None,
                                PciHeaderType::Device,
                                VIRTIO_PCI_VENDOR_ID,
                                pci_device_id,
                                msix_config_clone,
                            );
                            &#x7EC4;&#x6210;virtio pci device
                            let mut virtio_pci_device = VirtioPciDevice {
                                id,
                                configuration,
                                common_config: VirtioPciCommonConfig {
                                    access_platform,
                                    driver_status: 0,
                                    config_generation: 0,
                                    device_feature_select: 0,
                                    driver_feature_select: 0,
                                    queue_select: 0,
                                    msix_config: Arc::new(AtomicU16::new(VIRTQ_MSI_NO_VECTOR)),
                                    msix_queues: Arc::new(Mutex::new(vec![VIRTQ_MSI_NO_VECTOR; num_queues])),
                                },
                                msix_config,
                                msix_num,
                                device,
                                device_activated: Arc::new(AtomicBool::new(false)),
                                interrupt_status: Arc::new(AtomicUsize::new(0)),
                                virtio_interrupt: None,
                                queues,
                                queue_evts,
                                memory: Some(memory),
                                settings_bar: 0,
                                use_64bit_bar,
                                interrupt_source_group,
                                cap_pci_cfg_info: VirtioPciCfgCapInfo::default(),
                                bar_regions: vec![],
                                activate_evt,
                                activate_barrier: Arc::new(Barrier::new(2)),
                                dma_handler,
                            };
                            //&#x8BBE;&#x7F6E;msix&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;
                            virtio_pci_device.virtio_interrupt = VirtioInterruptMsix::new()
                            return &#x8FD9;&#x4E2A;virtio_pci_device

                    5. add&#x5230;pci, &#x8FD4;&#x56DE;bar&#x5730;&#x5740;&#x4FE1;&#x606F;
                        new_resources = self.add_pci_device(virtio_pci_device)
                            &#x5206;&#x914D;bar&#x7A7A;&#x95F4;, &#x8FD4;&#x56DE;Vec&lt;PciBarConfiguration&gt;.&#x8FD9;&#x662F;PciDevice&#x672C;&#x8EAB;&#x7684;&#x65B9;&#x6CD5;
                            pci_bus.add_device() //&#x6DFB;&#x52A0;&#x5230;hashmap
                            &#x8BB0;&#x5F55;&#x8FD9;&#x4E2A;Bus_device&#x5230;bus_devices
                            pci_bus.register_mapping() //&#x6CE8;&#x518C;bar&#x5730;&#x5740;&#x5230;device manager&#x7684;MMIO Bus, &#x5173;&#x8054;&#x672C;BusDevice&#x5230;&#x8FD9;&#x4E2A;bar&#x5730;&#x5740;
                    6. virtio&#x8BBE;&#x5907;&#x7684;&#x6BCF;&#x4E2A;queue, &#x90FD;&#x6709;&#x4E2A;&quot;&#x901A;&#x77E5;&quot;&#x5730;&#x5740; = bar&#x5730;&#x5740;base+NOTIFICATION_BAR_OFFSET+queue index*4, &#x6BCF;&#x4E2A;&#x901A;&#x77E5;&#x5730;&#x5740;&#x90FD;&#x6709;&#x4E00;&#x4E2A;eventfd
                        self.address_manager.register_ioevent()
                            &#x8C03;&#x7528;KVM&#x7684;KVM_IOEVENTFD ioctl
                    7. &#x628A;&#x672C;&#x8BBE;&#x5907;&#x52A0;&#x5165;&#x5230;device_tree
            }
            add_vfio_devices()
            add_user_devices()
            self.bus_devices
                .push(Arc::clone(&amp;segment.pci_config_mmio) as Arc&lt;Mutex&lt;dyn BusDevice&gt;&gt;);
        8. done
        self.virtio_devices = virtio_devices
        */</span>

vm<span class="token punctuation">.</span><span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//&#x65B0;&#x5EFA;thread&#x5904;&#x7406;signal: SIGWINCH, SIGTERM, SIGINT</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">setup_signal_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//stdin&#x8BBE;&#x4E3A;raw mode</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">setup_tty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//load kernel</span>
    <span class="token keyword">let</span> entry_point <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">entry_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>cpu_manager<span class="token punctuation">.</span><span class="token function">create_boot_vcpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> each vcpu
            kvm create vcpu
    <span class="token keyword">self</span><span class="token punctuation">.</span>cpu_manager<span class="token punctuation">.</span><span class="token function">start_boot_vcpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> each vcpu
            &#x521B;&#x5EFA;&#x65B0;&#x7EBF;&#x7A0B;<span class="token punctuation">,</span> &#x5728;&#x91CC;&#x9762;<span class="token keyword">loop</span><span class="token punctuation">:</span>
                vcpu<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token class-name">VcpuExit</span><span class="token punctuation">::</span><span class="token class-name">IoIn</span>
                    <span class="token class-name">VcpuExit</span><span class="token punctuation">::</span><span class="token class-name">IoOut</span>
                    <span class="token class-name">VcpuExit</span><span class="token punctuation">::</span><span class="token class-name">Shutdown</span>
                    <span class="token class-name">VcpuExit</span><span class="token punctuation">::</span><span class="token class-name">SystemEvent</span>
                    <span class="token class-name">VcpuExit</span><span class="token punctuation">::</span><span class="token class-name">MmioRead</span>
                    <span class="token class-name">VcpuExit</span><span class="token punctuation">::</span><span class="token class-name">MmioWrite</span>
                    <span class="token class-name">VcpuExit</span><span class="token punctuation">::</span><span class="token class-name">Hyperv</span>
</code></pre>
<h2 id="devicemanager"><a name="devicemanager" class="anchor-navigation-ex-anchor" href="#devicemanager"><i class="fa fa-link" aria-hidden="true"></i></a>7.3. DeviceManager</h2>
<h3 id="devicemanager&#x7ED3;&#x6784;&#x4F53;"><a name="devicemanager&#x7ED3;&#x6784;&#x4F53;" class="anchor-navigation-ex-anchor" href="#devicemanager&#x7ED3;&#x6784;&#x4F53;"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.1. DeviceManager&#x7ED3;&#x6784;&#x4F53;</h3>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">DeviceManager</span> <span class="token punctuation">{</span>
    <span class="token comment">// Manage address space related to devices</span>
    address_manager<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">AddressManager</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Console abstraction</span>
    console<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Console</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// console PTY</span>
    console_pty<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">PtyPair</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// serial PTY</span>
    serial_pty<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">PtyPair</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Serial Manager</span>
    serial_manager<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">SerialManager</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// pty foreground status,</span>
    console_resize_pipe<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">File</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Interrupt controller</span>
    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
    interrupt_controller<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token namespace">ioapic<span class="token punctuation">::</span></span><span class="token class-name">Ioapic</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;aarch64&quot;</span>)]</span>
    interrupt_controller<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token namespace">gic<span class="token punctuation">::</span></span><span class="token class-name">Gic</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Things to be added to the commandline (e.g. aarch64 early console)</span>
    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;aarch64&quot;</span>)]</span>
    cmdline_additions<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// ACPI GED notification device</span>
    ged_notification_device<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token namespace">devices<span class="token punctuation">::</span></span><span class="token class-name">AcpiGedDevice</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// VM configuration</span>
    config<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">VmConfig</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Memory Manager</span>
    memory_manager<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">MemoryManager</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// The virtio devices on the system</span>
    virtio_devices<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">MetaVirtioDevice</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// List of bus devices</span>
    <span class="token comment">// Let the DeviceManager keep strong references to the BusDevice devices.</span>
    <span class="token comment">// This allows the IO and MMIO buses to be provided with Weak references,</span>
    <span class="token comment">// which prevents cyclic dependencies.</span>
    bus_devices<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">BusDevice</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Counter to keep track of the consumed device IDs.</span>
    device_id_cnt<span class="token punctuation">:</span> <span class="token class-name">Wrapping</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    pci_segments<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">PciSegment</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token attribute attr-name">#[cfg_attr(target_arch = <span class="token string">&quot;aarch64&quot;</span>, allow(dead_code))]</span>
    <span class="token comment">// MSI Interrupt Manager</span>
    msi_interrupt_manager<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">InterruptManager</span><span class="token operator">&lt;</span><span class="token class-name">GroupConfig</span> <span class="token operator">=</span> <span class="token class-name">MsiIrqGroupConfig</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>

    <span class="token attribute attr-name">#[cfg_attr(feature = <span class="token string">&quot;mshv&quot;</span>, allow(dead_code))]</span>
    <span class="token comment">// Legacy Interrupt Manager</span>
    legacy_interrupt_manager<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">InterruptManager</span><span class="token operator">&lt;</span><span class="token class-name">GroupConfig</span> <span class="token operator">=</span> <span class="token class-name">LegacyIrqGroupConfig</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Passthrough device handle</span>
    passthrough_device<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token namespace">hypervisor<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// VFIO container</span>
    <span class="token comment">// Only one container can be created, therefore it is stored as part of the</span>
    <span class="token comment">// DeviceManager to be reused.</span>
    vfio_container<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">VfioContainer</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Paravirtualized IOMMU</span>
    iommu_device<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token namespace">virtio_devices<span class="token punctuation">::</span></span><span class="token class-name">Iommu</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    iommu_mapping<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">IommuMapping</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// PCI information about devices attached to the paravirtualized IOMMU</span>
    <span class="token comment">// It contains the virtual IOMMU PCI BDF along with the list of PCI BDF</span>
    <span class="token comment">// representing the devices attached to the virtual IOMMU. This is useful</span>
    <span class="token comment">// information for filling the ACPI VIOT table.</span>
    iommu_attached_devices<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">PciBdf</span><span class="token punctuation">,</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">PciBdf</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Tree of devices, representing the dependencies between devices.</span>
    <span class="token comment">// Useful for introspection, snapshot and restore.</span>
    device_tree<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">DeviceTree</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Exit event</span>
    exit_evt<span class="token punctuation">:</span> <span class="token class-name">EventFd</span><span class="token punctuation">,</span>
    reset_evt<span class="token punctuation">:</span> <span class="token class-name">EventFd</span><span class="token punctuation">,</span>

    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;aarch64&quot;</span>)]</span>
    id_to_dev_info<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">DeviceType</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MmioDeviceInfo</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// seccomp action</span>
    seccomp_action<span class="token punctuation">:</span> <span class="token class-name">SeccompAction</span><span class="token punctuation">,</span>

    <span class="token comment">// List of guest NUMA nodes.</span>
    numa_nodes<span class="token punctuation">:</span> <span class="token class-name">NumaNodes</span><span class="token punctuation">,</span>

    <span class="token comment">// Possible handle to the virtio-balloon device</span>
    balloon<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token namespace">virtio_devices<span class="token punctuation">::</span></span><span class="token class-name">Balloon</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Virtio Device activation EventFd to allow the VMM thread to trigger device</span>
    <span class="token comment">// activation and thus start the threads from the VMM thread</span>
    activate_evt<span class="token punctuation">:</span> <span class="token class-name">EventFd</span><span class="token punctuation">,</span>

    acpi_address<span class="token punctuation">:</span> <span class="token class-name">GuestAddress</span><span class="token punctuation">,</span>

    selected_segment<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>

    <span class="token comment">// Possible handle to the virtio-mem device</span>
    virtio_mem_devices<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token namespace">virtio_devices<span class="token punctuation">::</span></span><span class="token class-name">Mem</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;aarch64&quot;</span>)]</span>
    <span class="token comment">// GPIO device for AArch64</span>
    gpio_device<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token namespace">devices<span class="token punctuation">::</span>legacy<span class="token punctuation">::</span></span><span class="token class-name">Gpio</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;aarch64&quot;</span>)]</span>
    <span class="token comment">// Flash device for UEFI on AArch64</span>
    uefi_flash<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">GuestMemoryAtomic</span><span class="token operator">&lt;</span><span class="token class-name">GuestMemoryMmap</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Flag to force setting the iommu on virtio devices</span>
    force_iommu<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>

    <span class="token comment">// Helps identify if the VM is currently being restored</span>
    restoring<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>

    <span class="token comment">// io_uring availability if detected</span>
    io_uring_supported<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// List of unique identifiers provided at boot through the configuration.</span>
    boot_id_list<span class="token punctuation">:</span> <span class="token class-name">BTreeSet</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Start time of the VM</span>
    timestamp<span class="token punctuation">:</span> <span class="token class-name">Instant</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="devicemanager&#x65B9;&#x6CD5;"><a name="devicemanager&#x65B9;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#devicemanager&#x65B9;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.2. DeviceManager&#x65B9;&#x6CD5;</h3>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span> <span class="token class-name">DeviceManager</span> <span class="token punctuation">{</span>
    <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">serial_pty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">console_pty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">console_resize_pipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">create_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">set_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">get_msi_iova_space</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">get_device_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_pci_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_interrupt_controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">get_interrupt_controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_acpi_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_legacy_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_serial_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">modify_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">set_raw_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_virtio_console_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_console_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">make_virtio_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">make_virtio_block_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">make_virtio_net_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">make_virtio_rng_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">make_virtio_fs_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">make_virtio_pmem_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">make_virtio_vsock_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">make_virtio_mem_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">make_virtio_balloon_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">make_virtio_watchdog_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">make_vdpa_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">next_device_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_passthrough_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">create_vfio_container</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_vfio_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_vfio_user_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_pci_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_virtio_pci_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">pci_resources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">io_bus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">mmio_bus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">allocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//address_manager.allocator</span>
    <span class="token function">interrupt_controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">pci_config_io</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">pci_segments</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">console</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">cmdline_additions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">update_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">activate_virtio_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">notify_hotplug</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_user_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">remove_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">eject_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">hotplug_virtio_pci_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">is_iommu_segment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_disk</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_fs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_pmem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_net</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_vdpa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_vsock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">counters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">resize_balloon</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">device_tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">restore_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">notify_power_button</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">iommu_attached_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">uefi_flash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">validate_identifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="devicenode&#x5305;&#x62EC;id-&#x8D44;&#x6E90;-&#x5C42;&#x7EA7;-pci&#x4FE1;&#x606F;"><a name="devicenode&#x5305;&#x62EC;id-&#x8D44;&#x6E90;-&#x5C42;&#x7EA7;-pci&#x4FE1;&#x606F;" class="anchor-navigation-ex-anchor" href="#devicenode&#x5305;&#x62EC;id-&#x8D44;&#x6E90;-&#x5C42;&#x7EA7;-pci&#x4FE1;&#x606F;"><i class="fa fa-link" aria-hidden="true"></i></a>DeviceNode&#x5305;&#x62EC;id, &#x8D44;&#x6E90;, &#x5C42;&#x7EA7;, pci&#x4FE1;&#x606F;</h4>
<p>&#x5C24;&#x5176;&#x662F;&#x6BCF;&#x4E2A;Device&#x90FD;&#x662F;PCI&#x7684;device</p>
<pre class="language-"><code class="lang-rust"><span class="token attribute attr-name">#[derive(Clone, Serialize, Deserialize)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">DeviceNode</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> id<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> resources<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Resource</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> parent<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> children<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[serde(skip)]</span>
    <span class="token keyword">pub</span> migratable<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Migratable</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> pci_bdf<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">PciBdf</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[serde(skip)]</span>
    <span class="token keyword">pub</span> pci_device_handle<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">PciDeviceHandle</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="pci-segment"><a name="pci-segment" class="anchor-navigation-ex-anchor" href="#pci-segment"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.3. PCI segment</h3>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">PciSegment</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> <span class="token keyword">u16</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> pci_bus<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">PciBus</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> pci_config_mmio<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">PciConfigMmio</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> mmio_config_address<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>

    <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> pci_config_io<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">PciConfigIo</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Bitmap of PCI devices to hotplug.</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> pci_devices_up<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token comment">// Bitmap of PCI devices to hotunplug.</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> pci_devices_down<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token comment">// List of allocated IRQs for each PCI slot.</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> pci_irq_slots<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">;</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// Device memory covered by this segment</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> start_of_device_area<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> end_of_device_area<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>

    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> allocator<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">AddressAllocator</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>pci&#x7684;config&#x7A7A;&#x95F4;&#x662F;vmm&#x7684;&#x4E00;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;:</p>
<pre class="language-"><code class="lang-rust"><span class="token comment">/// Contains the configuration space of a PCI node.</span>
<span class="token comment">/// See the [specification](https://en.wikipedia.org/wiki/PCI_configuration_space).</span>
<span class="token comment">/// The configuration space is accessed with DWORD reads and writes from the guest.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">PciConfiguration</span> <span class="token punctuation">{</span>
    registers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">u32</span><span class="token punctuation">;</span> <span class="token constant">NUM_CONFIGURATION_REGISTERS</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    writable_bits<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">u32</span><span class="token punctuation">;</span> <span class="token constant">NUM_CONFIGURATION_REGISTERS</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// writable bits for each register.</span>
    bars<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">PciBar</span><span class="token punctuation">;</span> <span class="token constant">NUM_BAR_REGS</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    rom_bar_addr<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    rom_bar_size<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    rom_bar_used<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    <span class="token comment">// Contains the byte offset and size of the last capability.</span>
    last_capability<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    msix_cap_reg_idx<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    msix_config<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">MsixConfig</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>new&#x4E00;&#x4E2A;segment</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span>  <span class="token class-name">PciSegment</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span>  <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token number">1</span><span class="token punctuation">.</span> &#x65B0;&#x5EFA;&#x4E00;&#x4E2A;pci root&#x6865;
            &#x9ED8;&#x8BA4;&#x662F;<span class="token constant">VENDOR_ID_INTEL</span><span class="token punctuation">(</span><span class="token number">0x8086</span><span class="token punctuation">)</span>&#x548C;<span class="token constant">DEVICE_ID_INTEL_VIRT_PCIE_HOST</span><span class="token punctuation">(</span><span class="token number">0xD57</span><span class="token punctuation">)</span>
            <span class="token class-name">PciClassCode</span><span class="token punctuation">::</span><span class="token class-name">BridgeDevice</span>
            <span class="token operator">&amp;</span><span class="token class-name">PciBridgeSubclass</span><span class="token punctuation">::</span><span class="token class-name">HostBridge</span>
            <span class="token class-name">PciHeaderType</span><span class="token punctuation">::</span><span class="token class-name">Device</span>
        <span class="token number">2</span><span class="token punctuation">.</span> &#x65B0;&#x5EFA;<span class="token constant">PCI</span> bus<span class="token punctuation">,</span> <span class="token constant">PCI</span> bus&#x7528;hashmap&#x6765;&#x7BA1;&#x7406;pci &#x8BBE;&#x5907;<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span>  <span class="token class-name">PciDevice</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
        <span class="token number">3</span><span class="token punctuation">.</span> &#x65B0;&#x5EFA;pci_config_mmio<span class="token punctuation">,</span> &#x4E00;&#x4E2A;&#x5C31;&#x662F;&#x4E00;&#x4E2A;<span class="token class-name">PciBus</span>&#x5B9E;&#x4F8B;
        <span class="token number">4</span><span class="token punctuation">.</span> &#x628A;pci_config_mmio insert&#x5230;address_manager&#x7684;mmio_bus
        <span class="token number">5</span><span class="token punctuation">.</span> &#x7EC4;&#x88C5;&#x4E00;&#x4E2A;segment&#x5E76;&#x8FD4;&#x56DE;
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="pcibus"><a name="pcibus" class="anchor-navigation-ex-anchor" href="#pcibus"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.4. PciBus</h3>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span> <span class="token class-name">PciBus</span> <span class="token punctuation">{</span>
    <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">register_mapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">add_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">remove_by_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">next_device_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">get_device_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">put_device_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="pcidevice"><a name="pcidevice" class="anchor-navigation-ex-anchor" href="#pcidevice"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.5. PciDevice</h3>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">PciDevice</span><span class="token punctuation">:</span> <span class="token class-name">BusDevice</span> <span class="token punctuation">{</span>
    <span class="token function">allocate_bars</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">free_bars</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">write_config_register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">read_config_register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">detect_bar_reprogramming</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">read_bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">write_bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">move_bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">as_any</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="virtio&#x8BBE;&#x5907;"><a name="virtio&#x8BBE;&#x5907;" class="anchor-navigation-ex-anchor" href="#virtio&#x8BBE;&#x5907;"><i class="fa fa-link" aria-hidden="true"></i></a>8. virtio&#x8BBE;&#x5907;</h1>
<h2 id="virtionet"><a name="virtionet" class="anchor-navigation-ex-anchor" href="#virtionet"><i class="fa fa-link" aria-hidden="true"></i></a>8.1. virtionet</h2>
<p>&#x4EE3;&#x7801;<code>cloud-hypervisor/virtio-devices/src/net.rs</code></p>
<pre class="language-"><code class="lang-rust"><span class="token comment">//&#x4E3B;&#x8981;&#x662F;&#x521B;&#x5EFA;tap&#x8BBE;&#x5907;, &#x914D;&#x7F6E;virtio net&#x7684;&#x5C5E;&#x6027;</span>
<span class="token function">make_virtio_net_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token number">1</span><span class="token punctuation">.</span> &#x751F;&#x6210;id<span class="token punctuation">,</span> &#x5373;xxx_net
    <span class="token number">2</span><span class="token punctuation">.</span> &#x652F;&#x6301;vhost user<span class="token punctuation">,</span> &#x4F46;&#x4E00;&#x822C;&#x8FD8;&#x662F;virtio<span class="token operator">-</span>net&#x5BF9;&#x63A5;tap&#x8BBE;&#x5907;
        <span class="token namespace">virtio_devices<span class="token punctuation">::</span></span><span class="token class-name">Net</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            tap&#x8BBE;&#x5907;&#x6709;&#x540D;&#x5C31;open&#x6709;&#x540D;&#x7684;<span class="token punctuation">,</span> &#x6CA1;&#x540D;&#x5C31;&#x9ED8;&#x8BA4;&#x53EB;vmtap<span class="token operator">%</span>d
            tap&#x8BBE;&#x5907;&#x53EF;&#x4EE5;&#x914D;<span class="token constant">IP</span>
            &#x8FD9;&#x91CC;&#x4E3A;&#x4E86;&#x6A21;&#x62DF;&#x591A;queue<span class="token punctuation">,</span> &#x4F7F;&#x7528;&#x4E86;&#x591A;&#x4E2A;tap
            <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">new_with_tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                &#x8BBE;&#x7F6E;feature&#x6807;&#x8BB0;&#x5404;&#x79CD;offload<span class="token punctuation">,</span> tso<span class="token punctuation">,</span> &#x591A;&#x961F;&#x5217;
                <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Net</span> <span class="token punctuation">{</span>
                    common<span class="token punctuation">:</span> <span class="token class-name">VirtioCommon</span> <span class="token punctuation">{</span>
                        device_type<span class="token punctuation">:</span> <span class="token class-name">VirtioDeviceType</span><span class="token punctuation">::</span><span class="token class-name">Net</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
                        avail_features<span class="token punctuation">,</span>
                        queue_sizes<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>queue_size<span class="token punctuation">;</span> queue_num<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        paused_sync<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Barrier</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">(</span>num_queues <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        min_queues<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                        <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    id<span class="token punctuation">,</span>
                    taps<span class="token punctuation">,</span>
                    config<span class="token punctuation">,</span>
                    ctrl_queue_epoll_thread<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                    counters<span class="token punctuation">:</span> <span class="token class-name">NetCounters</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    seccomp_action<span class="token punctuation">,</span>
                    rate_limiter_config<span class="token punctuation">,</span>
                    exit_evt<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token number">3</span><span class="token punctuation">.</span> &#x63D2;&#x5165;&#x5230;&#x8BBE;&#x5907;&#x6811;
        <span class="token keyword">self</span><span class="token punctuation">.</span>device_tree<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token number">4</span><span class="token punctuation">.</span> &#x8FD4;&#x56DE;<span class="token class-name">MetaVirtioDevice</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">MetaVirtioDevice</span> <span class="token punctuation">{</span>
            virtio_device<span class="token punctuation">,</span>
            iommu<span class="token punctuation">:</span> net_cfg<span class="token punctuation">.</span>iommu<span class="token punctuation">,</span>
            id<span class="token punctuation">,</span>
            pci_segment<span class="token punctuation">:</span> net_cfg<span class="token punctuation">.</span>pci_segment<span class="token punctuation">,</span>
            dma_handler<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="net&#x7ED3;&#x6784;&#x4F53;"><a name="net&#x7ED3;&#x6784;&#x4F53;" class="anchor-navigation-ex-anchor" href="#net&#x7ED3;&#x6784;&#x4F53;"><i class="fa fa-link" aria-hidden="true"></i></a>8.1.1. Net&#x7ED3;&#x6784;&#x4F53;</h3>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Net</span> <span class="token punctuation">{</span>
    common<span class="token punctuation">:</span> <span class="token class-name">VirtioCommon</span><span class="token punctuation">,</span>
    id<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    taps<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Tap</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    config<span class="token punctuation">:</span> <span class="token class-name">VirtioNetConfig</span><span class="token punctuation">,</span>
    ctrl_queue_epoll_thread<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token class-name">JoinHandle</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    counters<span class="token punctuation">:</span> <span class="token class-name">NetCounters</span><span class="token punctuation">,</span>
    seccomp_action<span class="token punctuation">:</span> <span class="token class-name">SeccompAction</span><span class="token punctuation">,</span>
    rate_limiter_config<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">RateLimiterConfig</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    exit_evt<span class="token punctuation">:</span> <span class="token class-name">EventFd</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="impl-virtiodevice-for-net"><a name="impl-virtiodevice-for-net" class="anchor-navigation-ex-anchor" href="#impl-virtiodevice-for-net"><i class="fa fa-link" aria-hidden="true"></i></a>8.1.2. impl VirtioDevice for Net</h3>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span> <span class="token class-name">VirtioDevice</span> <span class="token keyword">for</span> <span class="token class-name">Net</span> <span class="token punctuation">{</span>
    <span class="token function">device_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">queue_max_sizes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">features</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">ack_features</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">read_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x8FD9;&#x91CC;&#x5E94;&#x8BE5;&#x662F;&#x5165;&#x53E3;</span>
    <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">counters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">set_access_platform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="activate"><a name="activate" class="anchor-navigation-ex-anchor" href="#activate"><i class="fa fa-link" aria-hidden="true"></i></a>activate</h4>
<p>&#x5728;<code>vmm.control_loop</code>&#x7684;&#x4E8B;&#x4EF6;&#x5FAA;&#x73AF;&#x91CC;, &#x4F1A;&#x6709;<code>EpollDispatch::ActivateVirtioDevices</code>&#x4E8B;&#x4EF6;&#x6765;&#x89E6;&#x53D1;virtio&#x8BBE;&#x5907;&#x7684;&#x4F7F;&#x80FD;:</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">fn</span> <span class="token function-definition function">activate</span> <span class="token punctuation">{</span>
    <span class="token number">1</span><span class="token punctuation">.</span> <span class="token keyword">self</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token number">2</span><span class="token punctuation">.</span> &#x521B;&#x5EFA;<span class="token class-name">NetCtrlEpollHandler</span><span class="token punctuation">,</span> &#x8D77;&#x4E2A;&#x7EBF;&#x7A0B;<span class="token string">&quot;_net1_ctrl&quot;</span><span class="token punctuation">,</span> &#x5728;&#x91CC;&#x9762;epoll&#x5FAA;&#x73AF;&#x5904;&#x7406;ctrl queue&#x7684;&#x4E8B;&#x4EF6;
    <span class="token number">3</span><span class="token punctuation">.</span> &#x6BCF;&#x4E2A;q&#x90FD;&#x521B;&#x5EFA;<span class="token class-name">NetEpollHandler</span><span class="token punctuation">,</span> &#x8D77;&#x4E2A;&#x7EBF;&#x7A0B;<span class="token string">&quot;_net1_qp%i&quot;</span><span class="token punctuation">,</span> &#x5728;epoll&#x91CC;&#x5FAA;&#x73AF;&#x5904;&#x7406;data queue&#x7684;&#x4E8B;&#x4EF6;
<span class="token punctuation">}</span>
</code></pre>
<p>data queue&#x7684;&#x4E8B;&#x4EF6;:</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">match</span>  ev_type <span class="token punctuation">{</span>
    <span class="token constant">RX_QUEUE_EVENT</span><span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">handle_rx_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token constant">TX_QUEUE_EVENT</span><span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">handle_tx_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token constant">TX_TAP_EVENT</span><span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">handle_tx_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token constant">RX_TAP_EVENT</span><span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">handle_rx_tap_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    &#x8FD8;&#x6709;rate limit&#x4E8B;&#x4EF6;<span class="token punctuation">...</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="netqueuepair"><a name="netqueuepair" class="anchor-navigation-ex-anchor" href="#netqueuepair"><i class="fa fa-link" aria-hidden="true"></i></a>NetQueuePair</h4>
<p><code>cloud-hypervisor/net_util/src/queue_pair.rs</code>
&#x524D;&#x9762;&#x7684;&#x4E8B;&#x4EF6;, &#x6700;&#x540E;&#x90FD;&#x4F1A;&#x843D;&#x811A;&#x5230;</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span> <span class="token class-name">NetQueuePair</span> <span class="token punctuation">{</span>
    <span class="token function">process_tx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>tx<span class="token punctuation">.</span><span class="token function">process_desc_chain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            &#x57FA;&#x672C;&#x4E0A;&#x5C31;&#x662F;&#x5728;&#x5FAA;&#x73AF;&#x91CC;&#x76F4;&#x63A5;&#x64CD;&#x4F5C;desc&#x6307;&#x5411;&#x7684;buffer<span class="token punctuation">,</span> &#x6700;&#x540E;&#x8C03;&#x7528;<span class="token namespace">libc<span class="token punctuation">::</span></span>writev&#x628A;&#x8FD9;&#x4E9B;buffer&#x5199;&#x5230;tap&#x7684;fd&#x91CC;&#x9762;<span class="token punctuation">.</span>
            &#x6700;&#x540E;&#x66F4;&#x65B0;used index
    <span class="token function">process_rx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>rx<span class="token punctuation">.</span>process_desc_chain
            &#x57FA;&#x672C;&#x4E0A;&#x662F;&#x4ECE;desc&#x94FE;&#x7684;&#x4FE1;&#x606F;&#x4E2D;<span class="token punctuation">,</span> &#x627E;&#x5230;guest driver&#x63D0;&#x524D;&#x51C6;&#x5907;&#x597D;&#x7684;buffer<span class="token punctuation">,</span> &#x7EC4;&#x6210;iovecs<span class="token punctuation">,</span> &#x7528;<span class="token namespace">libc<span class="token punctuation">::</span></span>readv&#x51FD;&#x6570;&#x8BFB;&#x5230;&#x8FD9;&#x4E2A;iovecs&#x91CC;
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x5176;&#x4ED6;trait"><a name="&#x5176;&#x4ED6;trait" class="anchor-navigation-ex-anchor" href="#&#x5176;&#x4ED6;trait"><i class="fa fa-link" aria-hidden="true"></i></a>8.1.3. &#x5176;&#x4ED6;trait</h3>
<p>Net&#x8FD8;&#x6EE1;&#x8DB3;:</p>
<ul>
<li>Drop trait</li>
<li>Pausable trait</li>
<li>Snapshottable trait</li>
<li>Transportable trait</li>
<li>Migratable trait</li>
</ul>
<h2 id="virtio-block"><a name="virtio-block" class="anchor-navigation-ex-anchor" href="#virtio-block"><i class="fa fa-link" aria-hidden="true"></i></a>8.2. virtio block</h2>
<pre class="language-"><code class="lang-rust"><span class="token function">make_virtio_block_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token number">1</span><span class="token punctuation">.</span> &#x751F;&#x6210;id<span class="token punctuation">,</span> &#x4E00;&#x822C;&#x662F;xxx_disk
    <span class="token number">2</span><span class="token punctuation">.</span> &#x652F;&#x6301;vhost user&#x5BF9;&#x63A5;spdk
    <span class="token number">3</span><span class="token punctuation">.</span> &#x6253;&#x5F00;&#x5757;&#x8BBE;&#x5907;&#x6587;&#x4EF6;<span class="token punctuation">,</span> &#x652F;&#x6301;qcow2<span class="token punctuation">,</span> vhd&#x548C;raw<span class="token punctuation">,</span> &#x8FD4;&#x56DE;&#x4E00;&#x4E2A;<span class="token keyword">trait</span> <span class="token type-definition class-name">object</span><span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span>  <span class="token class-name">DiskFile</span><span class="token operator">&gt;</span>
    <span class="token number">4</span><span class="token punctuation">.</span> &#x4F20;&#x5165;&#x4E0A;&#x9762;&#x7684;&#x6750;&#x6599;<span class="token punctuation">,</span> &#x521B;&#x5EFA;virtio block&#x8BBE;&#x5907;
        <span class="token namespace">virtio_devices<span class="token punctuation">::</span></span><span class="token class-name">Block</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            &#x8BBE;&#x7F6E;feature&#x6807;&#x8BB0;<span class="token punctuation">,</span> <span class="token constant">FLUSH</span><span class="token punctuation">,</span> <span class="token constant">CONFIG_WCE</span><span class="token punctuation">,</span> <span class="token constant">BLK_SIZE</span><span class="token punctuation">,</span> <span class="token constant">TOPOLOGY</span>
            &#x8BA1;&#x7B97;disk&#x53C2;&#x6570;<span class="token punctuation">,</span> &#x6BD4;&#x5982;block size<span class="token punctuation">,</span> sector&#x4E2A;&#x6570;<span class="token punctuation">,</span> writeback<span class="token punctuation">,</span> &#x591A;&#x961F;&#x5217;&#x7B49;
            &#x8FD4;&#x56DE;<span class="token class-name">Block</span>&#x8BBE;&#x5907;
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Block</span> <span class="token punctuation">{</span>
                common<span class="token punctuation">:</span> <span class="token class-name">VirtioCommon</span> <span class="token punctuation">{</span>
                    device_type<span class="token punctuation">:</span> <span class="token class-name">VirtioDeviceType</span><span class="token punctuation">::</span><span class="token class-name">Block</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
                    avail_features<span class="token punctuation">,</span>
                    paused_sync<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Barrier</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>num_queues <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    queue_sizes<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>queue_size<span class="token punctuation">;</span> num_queues<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    min_queues<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                id<span class="token punctuation">,</span>
                disk_image<span class="token punctuation">,</span>
                disk_path<span class="token punctuation">,</span>
                disk_nsectors<span class="token punctuation">,</span>
                config<span class="token punctuation">,</span>
                writeback<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AtomicBool</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                counters<span class="token punctuation">:</span> <span class="token class-name">BlockCounters</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                seccomp_action<span class="token punctuation">,</span>
                rate_limiter_config<span class="token punctuation">,</span>
                exit_evt<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token number">5</span><span class="token punctuation">.</span> &#x63D2;&#x5165;&#x5230;&#x8BBE;&#x5907;&#x6811;
        <span class="token keyword">self</span><span class="token punctuation">.</span>device_tree<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token number">6</span><span class="token punctuation">.</span> &#x8FD4;&#x56DE;<span class="token class-name">MetaVirtioDevice</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">MetaVirtioDevice</span> <span class="token punctuation">{</span>
            virtio_device<span class="token punctuation">,</span>
            iommu<span class="token punctuation">:</span> net_cfg<span class="token punctuation">.</span>iommu<span class="token punctuation">,</span>
            id<span class="token punctuation">,</span>
            pci_segment<span class="token punctuation">:</span> net_cfg<span class="token punctuation">.</span>pci_segment<span class="token punctuation">,</span>
            dma_handler<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="io-bus&#x548C;mmio-bus"><a name="io-bus&#x548C;mmio-bus" class="anchor-navigation-ex-anchor" href="#io-bus&#x548C;mmio-bus"><i class="fa fa-link" aria-hidden="true"></i></a>9. IO Bus&#x548C;MMIO Bus</h1>
<p>&#x9876;&#x5C42;&#x7684;device manager&#x5305;&#x62EC;&#x4E24;&#x4E2A;bus:</p>
<ul>
<li>io bus<br>&#x53EA;&#x6709;x86&#x6709;io bus</li>
<li>mmio bus<br>mmio bus&#x662F;&#x6700;&#x5E38;&#x7528;&#x7684;.</li>
</ul>
<p>io&#x6216;&#x8005;mmio&#x7684;Bus&#x62BD;&#x8C61;&#x90FD;&#x662F;&#x4E00;&#x4E2A;BtreeMap, &#x9760;&#x5730;&#x5740;range&#x6765;&#x8DEF;&#x7531;&#x8BFB;&#x5199;&#x64CD;&#x4F5C;&#x5230;&#x5E95;&#x6307;&#x5411;&#x54EA;&#x4E2A;&#x5177;&#x4F53;&#x7684;&#x8BBE;&#x5907;</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Bus</span> <span class="token punctuation">{</span>
    devices<span class="token punctuation">:</span> <span class="token class-name">RwLock</span><span class="token operator">&lt;</span><span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">BusRange</span><span class="token punctuation">,</span> <span class="token class-name">Weak</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">BusDevice</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Bus&#x8BBE;&#x5907;&#x5FC5;&#x987B;&#x6709;offset&#x8BFB;&#x5199;&#x7684;&#x65B9;&#x6CD5;</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">BusDevice</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Reads at `offset` from this device</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> base<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> offset<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">/// Writes at `offset` into this device</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> base<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> offset<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Barrier</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">None</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6CE8;: &#x5BF9;&#x6BD4;firecracker&#x7684;Bus&#x5B9A;&#x4E49;, &#x548C;&#x8FD9;&#x91CC;&#x5DEE;&#x4E0D;&#x591A;:</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Bus</span> <span class="token punctuation">{</span>
    <span class="token comment">//bus&#x4E0B;&#x9762;&#x662F;BtreeMap&#x7BA1;&#x7406;&#x7684;device</span>
    devices<span class="token punctuation">:</span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">BusRange</span><span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">BusDevice</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="bus&#x65B9;&#x6CD5;"><a name="bus&#x65B9;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#bus&#x65B9;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>9.1. Bus&#x65B9;&#x6CD5;</h2>
<p>&#x4E00;&#x4E2A;BusDevice&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x8303;&#x56F4;</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span> <span class="token class-name">Bus</span> <span class="token punctuation">{</span>
    <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//&#x6839;&#x636E;&#x5730;&#x5740;&#x627E;&#x4E0A;&#x4E00;&#x4E2A;&#x8BBE;&#x5907;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> addr<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">u64</span><span class="token punctuation">,</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">BusDevice</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>
    <span class="token comment">//&#x5728;&#x6307;&#x5B9A;&#x5730;&#x5740;&#x8303;&#x56F4;&#x63D2;&#x5165;&#x8BBE;&#x5907;</span>
    <span class="token function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> device<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">BusDevice</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> base<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> len<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span>
    <span class="token comment">//&#x5220;&#x9664;&#x6307;&#x5B9A;&#x5730;&#x5740;&#x8303;&#x56F4;&#x7684;&#x8BBE;&#x5907;</span>
    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> base<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> len<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span>
    <span class="token comment">//&#x8BFB;&#x5199;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> addr<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> addr<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="&#x4E2D;&#x65AD;"><a name="&#x4E2D;&#x65AD;" class="anchor-navigation-ex-anchor" href="#&#x4E2D;&#x65AD;"><i class="fa fa-link" aria-hidden="true"></i></a>10. &#x4E2D;&#x65AD;</h1>
<p>&#x548C;&#x786C;&#x4EF6;&#x7684;irq&#x7A0D;&#x6709;&#x533A;&#x522B;, virt irq&#x5728;&#x8FD9;&#x91CC;&#x88AB;&#x53EB;&#x505A;<code>Interrupt Source</code></p>
<blockquote>
<p>A device may support multiple types of interrupts, and each type of interrupt may support one or multiple interrupt sources. For example, a PCI device may support:</p>
<ul>
<li>Legacy Irq: exactly one interrupt source.</li>
<li>PCI MSI Irq: 1,2,4,8,16,32 interrupt sources.</li>
<li>PCI MSIx Irq: 2^n(n=0-11) interrupt sources.</li>
</ul>
</blockquote>
<p>&#x4E00;&#x4E2A;&#x8BBE;&#x5907;&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x4E2A;&#x4E2D;&#x65AD;&#x6E90;, &#x6BD4;&#x5982;MSI&#x53EF;&#x4EE5;&#x6709;32&#x4E2A;&#x6E90;, MSIx&#x53EF;&#x4EE5;&#x6709;4096&#x4E2A;&#x6E90;.</p>
<blockquote>
<p>A distinct Interrupt Source Identifier (ISID) will be assigned to each interrupt source.
An ID allocator will be used to allocate and free Interrupt Source Identifiers for devices.
To decouple the vm-device crate from the ID allocator, the vm-device crate doesn&apos;t take the
responsibility to allocate/free Interrupt Source IDs but only makes use of assigned IDs.</p>
</blockquote>
<p>&#x6BCF;&#x4E2A;&#x4E2D;&#x65AD;&#x6E90;&#x90FD;&#x88AB;&#x5206;&#x914D;&#x4E00;&#x4E2A;ID, &#x5373;ISID. vm-device&#x53EA;&#x8D1F;&#x8D23;&#x4F7F;&#x7528;&#x8FD9;&#x4E9B;ID</p>
<blockquote>
<p>The overall flow to deal with interrupts is:</p>
<ul>
<li>The VMM creates an interrupt manager</li>
<li>The VMM creates a device manager, passing on an reference to the interrupt manager</li>
<li>The device manager passes on an reference to the interrupt manager to all registered devices</li>
<li>The guest kernel loads drivers for virtual devices</li>
<li>The guest device driver determines the type and number of interrupts needed, and update the device configuration</li>
<li>The virtual device backend requests the interrupt manager to create an interrupt group
according to guest configuration information</li>
</ul>
</blockquote>
<p>&#x4E2D;&#x65AD;&#x5E76;&#x4E0D;&#x662F;&#x5728;&#x4E00;&#x5F00;&#x59CB;&#x5C31;&#x56FA;&#x5B9A;&#x5206;&#x914D;&#x597D;&#x7684;, &#x800C;&#x662F;&#x9700;&#x8981;guest kernel&#x9A71;&#x52A8;&#x6765;&#x89E6;&#x53D1;.
VMM&#x521B;&#x5EFA;&#x597D;&#x4E2D;&#x65AD;&#x7BA1;&#x7406;&#x5668;&#x540E;, &#x7531;&#x8BBE;&#x5907;&#x7BA1;&#x7406;&#x5668;&#x628A;&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;&#x7684;&#x5F15;&#x7528;&#x4F20;&#x9012;&#x7ED9;&#x6BCF;&#x4E2A;&#x5177;&#x4F53;&#x7684;&#x8BBE;&#x5907;;
guest kernel&#x9A71;&#x52A8;&#x5728;&#x521D;&#x59CB;&#x5316;&#x865A;&#x62DF;&#x8BBE;&#x5907;&#x7684;&#x65F6;&#x5019;, &#x51B3;&#x5B9A;&#x81EA;&#x5DF1;&#x7684;&#x4E2D;&#x65AD;&#x7C7B;&#x578B;, &#x6BD4;&#x5982;MSI, &#x548C;&#x4E2D;&#x65AD;&#x4E2A;&#x6570;;
&#x5BF9;&#x5E94;&#x865A;&#x62DF;&#x8BBE;&#x5907;&#x7684;backend&#x6839;&#x636E;guest&#x9A71;&#x52A8;&#x63D0;&#x4F9B;&#x7684;&#x4FE1;&#x606F;, &#x5411;&#x4E2D;&#x65AD;&#x7BA1;&#x7406;&#x5668;&#x8BF7;&#x6C42;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x4E2D;&#x65AD;group.</p>
<h2 id="interrupt-group"><a name="interrupt-group" class="anchor-navigation-ex-anchor" href="#interrupt-group"><i class="fa fa-link" aria-hidden="true"></i></a>10.1. interrupt group</h2>
<p>InterruptManager&#x53EA;&#x6709;&#x4E24;&#x4E2A;API, <code>create_group()</code>&#x548C;<code>destroy_group()</code>, &#x7528;&#x4E8E;&#x65B0;&#x5EFA;/&#x9500;&#x6BC1; InterruptSourceGroup</p>
<pre class="language-"><code class="lang-rust"><span class="token comment">/// Trait to manage interrupt sources for virtual device backends.</span>
<span class="token comment">///</span>
<span class="token comment">/// The InterruptManager implementations should protect itself from concurrent accesses internally,</span>
<span class="token comment">/// so it could be invoked from multi-threaded context.</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">InterruptManager</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">GroupConfig</span><span class="token punctuation">;</span>

    <span class="token comment">/// Create an [InterruptSourceGroup](trait.InterruptSourceGroup.html) object to manage</span>
    <span class="token comment">/// interrupt sources for a virtual device</span>
    <span class="token comment">///</span>
    <span class="token comment">/// An [InterruptSourceGroup](trait.InterruptSourceGroup.html) object manages all interrupt</span>
    <span class="token comment">/// sources of the same type for a virtual device.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Arguments</span>
    <span class="token comment">/// * interrupt_type: type of interrupt source.</span>
    <span class="token comment">/// * base: base Interrupt Source ID to be managed by the group object.</span>
    <span class="token comment">/// * count: number of Interrupt Sources to be managed by the group object.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">create_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> config<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">GroupConfig</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">InterruptSourceGroup</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>

    <span class="token comment">/// Destroy an [InterruptSourceGroup](trait.InterruptSourceGroup.html) object created by</span>
    <span class="token comment">/// [create_group()](trait.InterruptManager.html#tymethod.create_group).</span>
    <span class="token comment">///</span>
    <span class="token comment">/// Assume the caller takes the responsibility to disable all interrupt sources of the group</span>
    <span class="token comment">/// before calling destroy_group(). This assumption helps to simplify InterruptSourceGroup</span>
    <span class="token comment">/// implementations.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">destroy_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> group<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">InterruptSourceGroup</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>InterruptSourceGroup&#x8D1F;&#x8D23;&#x5177;&#x4F53;&#x4E2D;&#x65AD;&#x7684;&#x7EF4;&#x62A4;: &#x4F7F;&#x80FD;/&#x7981;&#x6B62;/&#x5411;guest&#x6CE8;&#x5165;&#x4E2D;&#x65AD;/&#x66F4;&#x65B0;&#x4E2D;&#x65AD;&#x914D;&#x7F6E;</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">InterruptSourceGroup</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Enable the interrupt sources in the group to generate interrupts.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">enable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// Not all interrupt sources can be enabled.</span>
        <span class="token comment">// To accommodate this, we can have a no-op here.</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Disable the interrupt sources in the group to generate interrupts.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">disable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// Not all interrupt sources can be disabled.</span>
        <span class="token comment">// To accommodate this, we can have a no-op here.</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Inject an interrupt from this interrupt source into the guest.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">trigger</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> index<span class="token punctuation">:</span> <span class="token class-name">InterruptIndex</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token comment">/// Returns an interrupt notifier from this interrupt.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// An interrupt notifier allows for external components and processes</span>
    <span class="token comment">/// to inject interrupts into a guest, by writing to the file returned</span>
    <span class="token comment">/// by this method.</span>
    <span class="token attribute attr-name">#[allow(unused_variables)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">notifier</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> index<span class="token punctuation">:</span> <span class="token class-name">InterruptIndex</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">EventFd</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token comment">/// Update the interrupt source group configuration.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Arguments</span>
    <span class="token comment">/// * index: sub-index into the group.</span>
    <span class="token comment">/// * config: configuration data for the interrupt source.</span>
    <span class="token comment">/// * masked: if the interrupt is masked</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">update</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
        index<span class="token punctuation">:</span> <span class="token class-name">InterruptIndex</span><span class="token punctuation">,</span>
        config<span class="token punctuation">:</span> <span class="token class-name">InterruptSourceConfig</span><span class="token punctuation">,</span>
        masked<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;"><a name="&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;" class="anchor-navigation-ex-anchor" href="#&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;"><i class="fa fa-link" aria-hidden="true"></i></a>10.2. &#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;</h2>
<p>&#x5206;&#x4E3A;&#x4E24;&#x5927;&#x7C7B;, msi&#x548C;legacy</p>
<h3 id="msi&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;"><a name="msi&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;" class="anchor-navigation-ex-anchor" href="#msi&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;"><i class="fa fa-link" aria-hidden="true"></i></a>10.2.1. msi&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;</h3>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">MsiInterruptManager</span> <span class="token punctuation">{</span>
    allocator<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">SystemAllocator</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    vm<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token namespace">hypervisor<span class="token punctuation">::</span></span><span class="token class-name">Vm</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    gsi_msi_routes<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token class-name">RoutingEntry</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>MsiInterruptManager&#x5B9E;&#x73B0;&#x4E86;InterruptManager trait:</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span> <span class="token class-name">InterruptManager</span> <span class="token keyword">for</span> <span class="token class-name">MsiInterruptManager</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">GroupConfig</span> <span class="token operator">=</span> <span class="token class-name">MsiIrqGroupConfig</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">create_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> config<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">GroupConfig</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">InterruptSourceGroup</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> allocator <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>allocator<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x628A;&#x8FD9;&#x6B21;group&#x91CC;&#x7684;&#x6240;&#x6709;&#x4E2D;&#x65AD;&#x63D2;&#x5165;&#x5230;irq_routes, &#x4EE5;hashmap&#x5F62;&#x5F0F;&#x7D22;&#x5F15;, key&#x662F;u32</span>
        <span class="token comment">//&#x6BCF;&#x4E2A;&#x4E2D;&#x65AD;&#x6E90;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;eventfd&#x548C;&#x4E00;&#x4E2A;gsi&#x53F7;&#x7EC4;&#x6210;&#x7684;InterruptRoute</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> irq_routes<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">InterruptIndex</span><span class="token punctuation">,</span> <span class="token class-name">InterruptRoute</span><span class="token operator">&gt;</span> <span class="token operator">=</span>
            <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>count <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> config<span class="token punctuation">.</span>base<span class="token punctuation">..</span>config<span class="token punctuation">.</span>base <span class="token operator">+</span> config<span class="token punctuation">.</span>count <span class="token punctuation">{</span>
            irq_routes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token class-name">InterruptRoute</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> allocator<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">MsiInterruptGroup</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>gsi_msi_routes<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            irq_routes<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">destroy_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _group<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">InterruptSourceGroup</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="msiinterruptgroup"><a name="msiinterruptgroup" class="anchor-navigation-ex-anchor" href="#msiinterruptgroup"><i class="fa fa-link" aria-hidden="true"></i></a>10.2.2. MsiInterruptGroup</h3>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span> <span class="token class-name">InterruptSourceGroup</span> <span class="token keyword">for</span> <span class="token class-name">MsiInterruptGroup</span> <span class="token punctuation">{</span>
    <span class="token comment">//&#x5BF9;&#x8FD9;&#x4E2A;group&#x4E0B;&#x9762;&#x7684;&#x6BCF;&#x4E2A;&#x4E2D;&#x65AD;&#x6E90;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">enable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> route<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>irq_routes<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            route<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
                <span class="token comment">//&#x8C03;&#x7528;kvm&#x7684;ioctl KVM_IRQFD&#x6CE8;&#x518C;eventfd, &#x7ED1;&#x5B9A;&#x5230;&#x5BF9;&#x5E94;&#x7684;gsi. &#x5199;&#x8FD9;&#x4E2A;eventfd&#x4F1A;&#x89E6;&#x53D1;kvm&#x6CE8;&#x5165;&#x4E2D;&#x65AD;&#x5230;irqchip&#x7684;gsi pin</span>
                vm<span class="token punctuation">.</span><span class="token function">register_irqfd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>irq_fd<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>gsi<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x53D6;&#x6D88;&#x6CE8;&#x518C;</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x5C31;&#x662F;&#x5199;&#x5BF9;&#x5E94;&#x7684;eventfd</span>
    <span class="token function">notifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x8FD4;&#x56DE;eventfd&#x7684;clone</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="kvmirqfd"><a name="kvmirqfd" class="anchor-navigation-ex-anchor" href="#kvmirqfd"><i class="fa fa-link" aria-hidden="true"></i></a>KVM_IRQFD</h4>
<blockquote>
<p>Allows setting an eventfd to directly trigger a guest interrupt. kvm_irqfd.fd specifies the file descriptor to use as the eventfd and kvm_irqfd.gsi specifies the irqchip pin toggled by this event. When an event is triggered on the eventfd, an interrupt is injected into the guest using the specified gsi pin</p>
</blockquote>
<p>kvm&#x7684;ioctl KVM_IRQFD&#x6CE8;&#x518C;eventfd, &#x7ED1;&#x5B9A;&#x5230;&#x5BF9;&#x5E94;&#x7684;gsi. &#x5199;&#x8FD9;&#x4E2A;eventfd&#x4F1A;&#x89E6;&#x53D1;kvm&#x6CE8;&#x5165;&#x4E2D;&#x65AD;&#x5230;irqchip&#x7684;gsi pin</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="rust_firecracker_使用.html" class="navigation navigation-prev " aria-label="Previous page: firecracker使用">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="rust_cloud-hypervisor_使用.html" class="navigation navigation-next " aria-label="Next page: cloud hypervisor使用">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"cloud hypervisor代码","level":"1.2.2.4","depth":3,"next":{"title":"cloud hypervisor使用","level":"1.2.2.5","depth":3,"path":"notes/rust_cloud-hypervisor_使用.md","ref":"notes/rust_cloud-hypervisor_使用.md","articles":[]},"previous":{"title":"firecracker使用","level":"1.2.2.3","depth":3,"path":"notes/rust_firecracker_使用.md","ref":"notes/rust_firecracker_使用.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","-lunr","-search","search-plus","-highlight","prism","prism-themes","expandable-chapters-small","github","disqus","splitter","wide-page","hide-navigation-buttons","anchor-navigation-ex","sequence"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"prism":{"css":["prism-themes/themes/prism-base16-ateliersulphurpool.light.css"]},"disqus":{"useIdentifier":false,"shortName":"bai-yingjie-notes"},"sequence":{"theme":"simple"},"github":{"url":"https://github.com/Bai-Yingjie/Bai-Yingjie.github.io"},"splitter":{},"wide-page":{},"fontsettings":{"theme":"white","family":"sans","size":2},"hide-navigation-buttons":{},"anchor-navigation-ex":{"mode":"float","pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"isRewritePageTitle":true,"showLevel":true,"tocLevel1Icon":"fa fa-hand-o-right","tocLevel2Icon":"fa fa-hand-o-right","tocLevel3Icon":"fa fa-hand-o-right","showGoTop":true,"isShowTocTitleIcon":true,"printLog":false,"multipleH1":true,"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false}},"prism-themes":{},"expandable-chapters-small":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"theme":"default","author":"Bai Yingjie","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"My Notes","language":"zh-hans","gitbook":"*"},"file":{"path":"notes/rust_cloud-hypervisor_代码.md","mtime":"2022-10-06T15:55:59.726Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-10-06T15:56:56.695Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

