
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>消息中间件基本概念和zero mq · My Notes</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Bai Yingjie">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-coldark-cold.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-wide-page/wide.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hide-navigation-buttons/index.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="golang_mango.html" />
    
    
    <link rel="prev" href="as_title.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    虚拟化
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    gvisor
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1" data-path="golang_gvisor代码_KVM.html">
            
                <a href="golang_gvisor代码_KVM.html">
            
                    
                    gvisor KVM模式代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.2" data-path="golang_gvisor调试.html">
            
                <a href="golang_gvisor调试.html">
            
                    
                    gvisor调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3" data-path="golang_gvisor_ptrace.html">
            
                <a href="golang_gvisor_ptrace.html">
            
                    
                    gvisor ptrace模式介绍(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="rust_vmm_brief.html">
            
                <a href="rust_vmm_brief.html">
            
                    
                    rust VMM(virtual machine monitor)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.1" data-path="rust_vmm_简介.html">
            
                <a href="rust_vmm_简介.html">
            
                    
                    rust-vmm简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2" data-path="rust_firecracker_代码.html">
            
                <a href="rust_firecracker_代码.html">
            
                    
                    firecracker代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.3" data-path="rust_firecracker_使用.html">
            
                <a href="rust_firecracker_使用.html">
            
                    
                    firecracker使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.4" data-path="rust_cloud-hypervisor_代码.html">
            
                <a href="rust_cloud-hypervisor_代码.html">
            
                    
                    cloud hypervisor代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.5" data-path="rust_cloud-hypervisor_使用.html">
            
                <a href="rust_cloud-hypervisor_使用.html">
            
                    
                    cloud hypervisor使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.6" data-path="rust_cloud-hypervisor_问题与解决.html">
            
                <a href="rust_cloud-hypervisor_问题与解决.html">
            
                    
                    cloud hypervisor问题与解决
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    开源
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="my_opensource.html">
            
                <a href="my_opensource.html">
            
                    
                    我的开源项目
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="my_upstream.html">
            
                <a href="my_upstream.html">
            
                    
                    我的upstream commit
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Golang
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    入门
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1.1" data-path="golang_语法基础.html">
            
                <a href="golang_语法基础.html">
            
                    
                    语法基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.2" data-path="golang_json性能.html">
            
                <a href="golang_json性能.html">
            
                    
                    json性能比较
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="golang_原理.html">
            
                <a href="golang_原理.html">
            
                    
                    原理相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.2.1" data-path="golang_interface原理.html">
            
                <a href="golang_interface原理.html">
            
                    
                    interface原理(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.2" data-path="golang_内存分配.html">
            
                <a href="golang_内存分配.html">
            
                    
                    内存分配(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="golang_标准库.html">
            
                <a href="golang_标准库.html">
            
                    
                    标准库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="golang_我的反射代码.html">
            
                <a href="golang_我的反射代码.html">
            
                    
                    我的反射代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="golang_问答.html">
            
                <a href="golang_问答.html">
            
                    
                    问答
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="golang_高效go.html">
            
                <a href="golang_高效go.html">
            
                    
                    高效go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="golang_进阶.html">
            
                <a href="golang_进阶.html">
            
                    
                    进阶
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    杂记
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.8.1" data-path="golang_杂记1.html">
            
                <a href="golang_杂记1.html">
            
                    
                    杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8.2" data-path="golang_杂记2.html">
            
                <a href="golang_杂记2.html">
            
                    
                    杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8.3" data-path="golang_杂记3.html">
            
                <a href="golang_杂记3.html">
            
                    
                    杂记3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8.4" data-path="golang_lib选型.html">
            
                <a href="golang_lib选型.html">
            
                    
                    lib选型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8.5" data-path="golang_mod_proxy.html">
            
                <a href="golang_mod_proxy.html">
            
                    
                    go mod和go proxy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8.6" data-path="golang_汇编_arm64.html">
            
                <a href="golang_汇编_arm64.html">
            
                    
                    汇编语法和arm64小知识
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8.7" data-path="golang_cgo_swig.html">
            
                <a href="golang_cgo_swig.html">
            
                    
                    go调用c可以用swig
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    环境和工具链生成
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.9.1" data-path="golang_toolchain_ppc.html">
            
                <a href="golang_toolchain_ppc.html">
            
                    
                    go tools增加ppc32支持.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9.2" data-path="golang_toolchain_compile_gccgo.html">
            
                <a href="golang_toolchain_compile_gccgo.html">
            
                    
                    编译gccgo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9.3" data-path="golang_go_on_mips.html">
            
                <a href="golang_go_on_mips.html">
            
                    
                    go on mips boards(not so updated)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.9.3.1" data-path="golang_go_on_mips_part1.html">
            
                <a href="golang_go_on_mips_part1.html">
            
                    
                    part 1: cross compile go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9.3.2" data-path="golang_go_on_mips_part2.html">
            
                <a href="golang_go_on_mips_part2.html">
            
                    
                    part 2: build native go compiler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9.3.3" data-path="golang_go_on_mips_part3.html">
            
                <a href="golang_go_on_mips_part3.html">
            
                    
                    part 3: gccgo experiments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9.3.4" data-path="golang_go_on_mips_part4.html">
            
                <a href="golang_go_on_mips_part4.html">
            
                    
                    part 4: json performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9.3.5" data-path="golang_gentoo_on_mips_board_and_build_go.html">
            
                <a href="golang_gentoo_on_mips_board_and_build_go.html">
            
                    
                    Gentoo on mips board and build go
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.10" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    微服务
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.10.1" data-path="golang_micro.html">
            
                <a href="golang_micro.html">
            
                    
                    go-micro和micro
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.10.2" data-path="golang_微服务概念.html">
            
                <a href="golang_微服务概念.html">
            
                    
                    微服务概念
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.11" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    解释器和编解码
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.11.1" data-path="golang_yeagi.html">
            
                <a href="golang_yeagi.html">
            
                    
                    解释器yeagi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.11.2" data-path="golang_tengo.html">
            
                <a href="golang_tengo.html">
            
                    
                    解释器tengo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.11.3" data-path="golang_govaluate.html">
            
                <a href="golang_govaluate.html">
            
                    
                    解释器govaluate
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.11.4" data-path="golang_encoding_gotiny.html">
            
                <a href="golang_encoding_gotiny.html">
            
                    
                    gotiny编解码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.11.5" data-path="golang_abs.html">
            
                <a href="golang_abs.html">
            
                    
                    解释器abs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.12" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    调试和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.12.1" data-path="golang_调试记录.html">
            
                <a href="golang_调试记录.html">
            
                    
                    调试记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.12.2" data-path="golang_topid性能优化.html">
            
                <a href="golang_topid性能优化.html">
            
                    
                    topid性能优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.12.3" data-path="golang_gshell性能调试.html">
            
                <a href="golang_gshell性能调试.html">
            
                    
                    gshell性能调试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.13" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    网络和消息中间件
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.4.13.1" data-path="golang_zmq.html">
            
                <a href="golang_zmq.html">
            
                    
                    消息中间件基本概念和zero mq
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.13.2" data-path="golang_mango.html">
            
                <a href="golang_mango.html">
            
                    
                    消息中间件mango
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.13.3" data-path="golang_libp2p.html">
            
                <a href="golang_libp2p.html">
            
                    
                    p2p网络
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Rust
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="rust_入门_brief.html">
            
                <a href="rust_入门_brief.html">
            
                    
                    入门系列
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1.1" data-path="rust_books.html">
            
                <a href="rust_books.html">
            
                    
                    reference books
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.2" data-path="rust_入门1.html">
            
                <a href="rust_入门1.html">
            
                    
                    安装和基础语法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.3" data-path="rust_入门2.html">
            
                <a href="rust_入门2.html">
            
                    
                    泛型和内存所有权
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.4" data-path="rust_入门3.html">
            
                <a href="rust_入门3.html">
            
                    
                    闭包 容器 迭代器 生成器 线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.5" data-path="rust_工程构建.html">
            
                <a href="rust_工程构建.html">
            
                    
                    工程构建
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="rust_coding_brief.html">
            
                <a href="rust_coding_brief.html">
            
                    
                    代码积累
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.1" data-path="rust_序列化.html">
            
                <a href="rust_序列化.html">
            
                    
                    序列化原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.2" data-path="rust_知识点积累.html">
            
                <a href="rust_知识点积累.html">
            
                    
                    知识点更新
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.3" data-path="rust_adaptiveservice.html">
            
                <a href="rust_adaptiveservice.html">
            
                    
                    rust版本的adaptiveservice探索
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.4" data-path="rust_常用设施.html">
            
                <a href="rust_常用设施.html">
            
                    
                    常用设施
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.5" data-path="rust_代码小段.html">
            
                <a href="rust_代码小段.html">
            
                    
                    代码小段
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="others.html">
            
                <a href="others.html">
            
                    
                    其他
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.3.1" data-path="rust_mdbook_使用.html">
            
                <a href="rust_mdbook_使用.html">
            
                    
                    使用mdbook
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    ARM server
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="arm_server_杂记.html">
            
                <a href="arm_server_杂记.html">
            
                    
                    杂记
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    脚本
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="shell_变量.html">
            
                <a href="shell_变量.html">
            
                    
                    shell变量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="shell_基础篇.html">
            
                <a href="shell_基础篇.html">
            
                    
                    shell命令和脚本记录-基础篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="shell_高级篇.html">
            
                <a href="shell_高级篇.html">
            
                    
                    shell命令和脚本记录-高级篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="shell_脚本片段.html">
            
                <a href="shell_脚本片段.html">
            
                    
                    shell脚本片段
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="python_记录.html">
            
                <a href="python_记录.html">
            
                    
                    python记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="lua_记录.html">
            
                <a href="lua_记录.html">
            
                    
                    lua记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" data-path="shell_rds脚本阅读.html">
            
                <a href="shell_rds脚本阅读.html">
            
                    
                    RDS脚本阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8" data-path="Project_Euler.html">
            
                <a href="Project_Euler.html">
            
                    
                    Project Euler
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    System
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="system_libc_part1.html">
            
                <a href="system_libc_part1.html">
            
                    
                    libc概览1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="system_libc_part2.html">
            
                <a href="system_libc_part2.html">
            
                    
                    libc概览2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="system_libc_part3.html">
            
                <a href="system_libc_part3.html">
            
                    
                    libc概览3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="system_原理杂记.html">
            
                <a href="system_原理杂记.html">
            
                    
                    原理杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="system_alpine.html">
            
                <a href="system_alpine.html">
            
                    
                    Alpine Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.6" data-path="system_进程间通信.html">
            
                <a href="system_进程间通信.html">
            
                    
                    进程间通信
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.7" data-path="system_特殊功能fd.html">
            
                <a href="system_特殊功能fd.html">
            
                    
                    eventfd timerfd signalfd和fd共享
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    工程实践
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="gitlab_ci.html">
            
                <a href="gitlab_ci.html">
            
                    
                    gitlab CI
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >消息中间件基本概念和zero mq</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#zmq&#x548C;nanomsg"><b>1. </b>zmq&#x548C;nanomsg</a></li><ul><li><span class="title-icon "></span><a href="#nanomsg&#x652F;&#x6301;&#x7684;socket&#x7C7B;&#x578B;"><b>1.1. </b>nanomsg&#x652F;&#x6301;&#x7684;socket&#x7C7B;&#x578B;</a></li><li><span class="title-icon "></span><a href="#nanomsg&#x7684;transport&#x7C7B;&#x578B;"><b>1.2. </b>nanomsg&#x7684;transport&#x7C7B;&#x578B;</a></li><li><span class="title-icon "></span><a href="#nanomsg&#x548C;nng"><b>1.3. </b>nanomsg&#x548C;nng</a></li><li><span class="title-icon "></span><a href="#nng&#x7684;&#x7EAF;go&#x7248;&#x672C;"><b>1.4. </b>nng&#x7684;&#x7EAF;go&#x7248;&#x672C;</a></li></ul><li><span class="title-icon "></span><a href="#&#x9AD8;&#x7EA7;req-rep"><b>2. </b>&#x9AD8;&#x7EA7;REQ-REP</a></li><ul><li><span class="title-icon "></span><a href="#&#x7ECF;&#x8FC7;router&#x4F1A;&#x52A0;address-frame"><b>2.1. </b>&#x7ECF;&#x8FC7;ROUTER&#x4F1A;&#x52A0;&quot;address&quot; frame</a></li><ul><li><span class="title-icon "></span><a href="#&#x5730;&#x5740;&#x7684;&#x751F;&#x6210;"><b>2.1.1. </b>&#x5730;&#x5740;&#x7684;&#x751F;&#x6210;</a></li><li><span class="title-icon "></span><a href="#router&#x518D;&#x628A;&#x6807;&#x8BC6;&#x7B26;&#x5265;&#x6389;-&#x4F20;&#x7ED9;req"><b>2.1.2. </b>Router&#x518D;&#x628A;&#x6807;&#x8BC6;&#x7B26;&#x5265;&#x6389;, &#x4F20;&#x7ED9;REQ</a></li><li><span class="title-icon "></span><a href="#&#x603B;&#x7ED3;"><b>2.1.3. </b>&#x603B;&#x7ED3;</a></li></ul><li><span class="title-icon "></span><a href="#&#x642D;&#x914D;"><b>2.2. </b>&#x642D;&#x914D;</a></li><ul><li><span class="title-icon "></span><a href="#&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;"><b>2.2.1. </b>&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;</a></li><li><span class="title-icon "></span><a href="#&#x4E0D;&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;"><b>2.2.2. </b>&#x4E0D;&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;</a></li><li><span class="title-icon "></span><a href="#&#x603B;&#x7ED3;_1"><b>2.2.3. </b>&#x603B;&#x7ED3;</a></li></ul></ul><li><span class="title-icon "></span><a href="#zmq&#x4F7F;&#x7528;"><b>3. </b>zmq&#x4F7F;&#x7528;</a></li><ul><li><span class="title-icon "></span><a href="#transport&#x7C7B;&#x578B;"><b>3.1. </b>transport&#x7C7B;&#x578B;</a></li><ul><li><span class="title-icon "></span><a href="#&#x7EBF;&#x7A0B;&#x95F4;"><b>3.1.1. </b>&#x7EBF;&#x7A0B;&#x95F4;</a></li><li><span class="title-icon "></span><a href="#&#x8FDB;&#x7A0B;&#x95F4;"><b>3.1.2. </b>&#x8FDB;&#x7A0B;&#x95F4;</a></li><li><span class="title-icon "></span><a href="#tcp"><b>3.1.3. </b>TCP</a></li><li><span class="title-icon "></span><a href="#pgm"><b>3.1.4. </b>pgm</a></li></ul><li><span class="title-icon "></span><a href="#zmq-socket"><b>3.2. </b>zmq socket</a></li><ul><li><span class="title-icon "></span><a href="#server&#x548C;client"><b>3.2.1. </b>server&#x548C;client</a></li><li><span class="title-icon "></span><a href="#zmq-socket&#x7C7B;&#x578B;"><b>3.2.2. </b>zmq socket&#x7C7B;&#x578B;</a></li><li><span class="title-icon "></span><a href="#zmq&#x7684;send&#x548C;recv&#x548C;tcp&#x7684;&#x4E0D;&#x540C;"><b>3.2.3. </b>zmq&#x7684;send&#x548C;recv&#x548C;tcp&#x7684;&#x4E0D;&#x540C;</a></li><li><span class="title-icon "></span><a href="#zmq&#x7684;message-framing"><b>3.2.4. </b>zmq&#x7684;message framing</a></li><li><span class="title-icon "></span><a href="#io-thread&#x548C;context"><b>3.2.5. </b>IO thread&#x548C;context</a></li><li><span class="title-icon "></span><a href="#zmqpoll&#x51FD;&#x6570;"><b>3.2.6. </b>zmq_poll()&#x51FD;&#x6570;</a></li><li><span class="title-icon "></span><a href="#&#x5206;&#x7247;&#x7684;msg"><b>3.2.7. </b>&#x5206;&#x7247;&#x7684;msg</a></li></ul><li><span class="title-icon "></span><a href="#&#x670D;&#x52A1;&#x53D1;&#x73B0;"><b>3.3. </b>&#x670D;&#x52A1;&#x53D1;&#x73B0;</a></li><li><span class="title-icon "></span><a href="#&#x591A;&#x5BF9;&#x591A;&#x7684;client&#x548C;server"><b>3.4. </b>&#x591A;&#x5BF9;&#x591A;&#x7684;client&#x548C;server</a></li><li><span class="title-icon "></span><a href="#&#x5176;&#x4ED6;&#x6A21;&#x578B;"><b>3.5. </b>&#x5176;&#x4ED6;&#x6A21;&#x578B;</a></li><li><span class="title-icon "></span><a href="#&#x5E76;&#x53D1;&#x652F;&#x6301;"><b>3.6. </b>&#x5E76;&#x53D1;&#x652F;&#x6301;</a></li><li><span class="title-icon "></span><a href="#zmq&#x7684;&#x5E94;&#x7528;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;run&#x5728;&#x7EBF;&#x7A0B;-&#x8FDB;&#x7A0B;-&#x6216;node&#x4E0A;"><b>3.7. </b>zmq&#x7684;&#x5E94;&#x7528;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;run&#x5728;&#x7EBF;&#x7A0B;, &#x8FDB;&#x7A0B;, &#x6216;node&#x4E0A;.</a></li><li><span class="title-icon "></span><a href="#pub&#x5230;&#x5DF2;&#x77E5;&#x6570;&#x91CF;&#x7684;subscriber"><b>3.8. </b>pub&#x5230;&#x5DF2;&#x77E5;&#x6570;&#x91CF;&#x7684;subscriber</a></li><li><span class="title-icon "></span><a href="#&#x96F6;&#x62F7;&#x8D1D;"><b>3.9. </b>&#x96F6;&#x62F7;&#x8D1D;</a></li><li><span class="title-icon "></span><a href="#pub-sub&#x5B9E;&#x9645;&#x4E0A;&#x662F;msg-filter"><b>3.10. </b>pub-sub&#x5B9E;&#x9645;&#x4E0A;&#x662F;msg filter</a></li><li><span class="title-icon "></span><a href="#&#x9AD8;&#x6C34;&#x4F4D;"><b>3.11. </b>&#x9AD8;&#x6C34;&#x4F4D;</a></li><li><span class="title-icon "></span><a href="#&#x4E22;&#x5305;&#x600E;&#x4E48;&#x5B9A;&#x4F4D;"><b>3.12. </b>&#x4E22;&#x5305;&#x600E;&#x4E48;&#x5B9A;&#x4F4D;?</a></li></ul><li><span class="title-icon "></span><a href="#&#x6D88;&#x606F;&#x4EA4;&#x4E92;&#x6A21;&#x5F0F;"><b>4. </b>&#x6D88;&#x606F;&#x4EA4;&#x4E92;&#x6A21;&#x5F0F;</a></li><ul><li><span class="title-icon "></span><a href="#pair&#x7C7B;&#x578B;"><b>4.1. </b>PAIR&#x7C7B;&#x578B;</a></li><ul><li><span class="title-icon "></span><a href="#&#x4E3A;&#x793E;&#x4E48;&#x8981;&#x7528;pair"><b>4.1.1. </b>&#x4E3A;&#x793E;&#x4E48;&#x8981;&#x7528;pair</a></li></ul><li><span class="title-icon "></span><a href="#req-rep"><b>4.2. </b>req-rep</a></li><ul><li><span class="title-icon "></span><a href="#server&#x7AEF;"><b>4.2.1. </b>server&#x7AEF;</a></li><li><span class="title-icon "></span><a href="#client&#x7AEF;"><b>4.2.2. </b>client&#x7AEF;</a></li></ul><li><span class="title-icon "></span><a href="#pub-sub"><b>4.3. </b>pub-sub</a></li><ul><li><span class="title-icon "></span><a href="#server&#x4FA7;"><b>4.3.1. </b>server&#x4FA7;</a></li><li><span class="title-icon "></span><a href="#client&#x4FA7;"><b>4.3.2. </b>client&#x4FA7;</a></li></ul><li><span class="title-icon "></span><a href="#push-pull"><b>4.4. </b>push-pull</a></li><ul><li><span class="title-icon "></span><a href="#&#x751F;&#x4EA7;&#x8005;-ventilator"><b>4.4.1. </b>&#x751F;&#x4EA7;&#x8005; ventilator</a></li><li><span class="title-icon "></span><a href="#&#x6D88;&#x8D39;&#x8005;worker"><b>4.4.2. </b>&#x6D88;&#x8D39;&#x8005;worker</a></li><li><span class="title-icon "></span><a href="#sink"><b>4.4.3. </b>sink</a></li><li><span class="title-icon "></span><a href="#&#x603B;&#x7ED3;_2"><b>4.4.4. </b>&#x603B;&#x7ED3;</a></li></ul><li><span class="title-icon "></span><a href="#context"><b>4.5. </b>context</a></li><li><span class="title-icon "></span><a href="#pipeline"><b>4.6. </b>pipeline</a></li><li><span class="title-icon "></span><a href="#fanout"><b>4.7. </b>fanout</a></li><li><span class="title-icon "></span><a href="#&#x7075;&#x9B42;&#x51E0;&#x95EE;"><b>4.8. </b>&#x7075;&#x9B42;&#x51E0;&#x95EE;</a></li><ul><li><span class="title-icon "></span><a href="#&#x963B;&#x585E;&#x8FD8;&#x662F;&#x5F02;&#x6B65;"><b>4.8.1. </b>&#x963B;&#x585E;&#x8FD8;&#x662F;&#x5F02;&#x6B65;?</a></li><li><span class="title-icon "></span><a href="#&#x8C01;&#x5F53;server&#x8C01;&#x5F53;client"><b>4.8.2. </b>&#x8C01;&#x5F53;server&#x8C01;&#x5F53;client?</a></li><li><span class="title-icon "></span><a href="#&#x600E;&#x4E48;&#x5728;wire&#x4E0A;&#x8868;&#x793A;&#x4E00;&#x4E2A;message"><b>4.8.3. </b>&#x600E;&#x4E48;&#x5728;wire&#x4E0A;&#x8868;&#x793A;&#x4E00;&#x4E2A;message?</a></li><li><span class="title-icon "></span><a href="#&#x5982;&#x679C;&#x5BF9;&#x7AEF;&#x6CA1;&#x51C6;&#x5907;&#x597D;&#x7684;&#x65F6;&#x5019;-&#x8981;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x5728;&#x54EA;&#x91CC;"><b>4.8.4. </b>&#x5982;&#x679C;&#x5BF9;&#x7AEF;&#x6CA1;&#x51C6;&#x5907;&#x597D;&#x7684;&#x65F6;&#x5019;, &#x8981;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x5728;&#x54EA;&#x91CC;?</a></li><li><span class="title-icon "></span><a href="#&#x62E5;&#x585E;&#x63A7;&#x5236;&#x7B56;&#x7565;"><b>4.8.5. </b>&#x62E5;&#x585E;&#x63A7;&#x5236;&#x7B56;&#x7565;?</a></li><li><span class="title-icon "></span><a href="#&#x6D88;&#x606F;&#x4E22;&#x5931;&#x600E;&#x4E48;&#x529E;-&#x8981;&#x4FDD;&#x8BC1;&#x9001;&#x8FBE;&#x5417;"><b>4.8.6. </b>&#x6D88;&#x606F;&#x4E22;&#x5931;&#x600E;&#x4E48;&#x529E;? &#x8981;&#x4FDD;&#x8BC1;&#x9001;&#x8FBE;&#x5417;?</a></li><li><span class="title-icon "></span><a href="#&#x5982;&#x679C;&#x6709;&#x65B0;&#x7684;transport&#x65B9;&#x6CD5;&#x600E;&#x4E48;&#x529E;-app&#x8981;&#x6539;&#x5417;-&#x6BD4;&#x5982;&#x589E;&#x52A0;&#x652F;&#x6301;yipc"><b>4.8.7. </b>&#x5982;&#x679C;&#x6709;&#x65B0;&#x7684;transport&#x65B9;&#x6CD5;&#x600E;&#x4E48;&#x529E;? app&#x8981;&#x6539;&#x5417;? &#x6BD4;&#x5982;&#x589E;&#x52A0;&#x652F;&#x6301;yipc?</a></li><li><span class="title-icon "></span><a href="#&#x6D88;&#x606F;&#x600E;&#x4E48;&#x8DEF;&#x7531;"><b>4.8.8. </b>&#x6D88;&#x606F;&#x600E;&#x4E48;&#x8DEF;&#x7531;?</a></li><li><span class="title-icon "></span><a href="#&#x591A;&#x8BED;&#x8A00;&#x600E;&#x4E48;&#x9002;&#x914D;-encoding&#x600E;&#x4E48;&#x9009;&#x62E9;-&#x7F51;&#x7EDC;&#x9519;&#x8BEF;&#x600E;&#x4E48;&#x5904;&#x7406;"><b>4.8.9. </b>&#x591A;&#x8BED;&#x8A00;&#x600E;&#x4E48;&#x9002;&#x914D;? encoding&#x600E;&#x4E48;&#x9009;&#x62E9;? &#x7F51;&#x7EDC;&#x9519;&#x8BEF;&#x600E;&#x4E48;&#x5904;&#x7406;?</a></li><li><span class="title-icon "></span><a href="#&#x4F5C;&#x8005;&#x89C2;&#x70B9;"><b>4.8.10. </b>&#x4F5C;&#x8005;&#x89C2;&#x70B9;</a></li></ul></ul><li><span class="title-icon "></span><a href="#zero-mqzmq-0mq"><b>5. </b>zero mq(zmq, 0mq)</a></li><li><span class="title-icon "></span><a href="#&#x95EE;&#x9898;-req-rep&#x6A21;&#x5F0F;&#x4E0B;&#x7684;rpc-&#x600E;&#x4E48;&#x628A;&#x5F02;&#x6B65;&#x540C;&#x6B65;&#x5316;&#x7684;"><b>6. </b>&#x95EE;&#x9898;: REQ-REP&#x6A21;&#x5F0F;&#x4E0B;&#x7684;RPC, &#x600E;&#x4E48;&#x628A;&#x5F02;&#x6B65;&#x540C;&#x6B65;&#x5316;&#x7684;?</a></li><ul><li><span class="title-icon "></span><a href="#zmq&#x4F7F;&#x7528;&#x6700;&#x57FA;&#x672C;&#x7684;&#x6A21;&#x5F0F;-send&#x540E;&#x9A6C;&#x4E0A;recv"><b>6.1. </b>zmq&#x4F7F;&#x7528;&#x6700;&#x57FA;&#x672C;&#x7684;&#x6A21;&#x5F0F;, send&#x540E;&#x9A6C;&#x4E0A;recv</a></li><li><span class="title-icon "></span><a href="#go&#x6807;&#x51C6;&#x5E93;&#x7684;rpc"><b>6.2. </b>go&#x6807;&#x51C6;&#x5E93;&#x7684;rpc</a></li><li><span class="title-icon "></span><a href="#&#x95EE;&#x9898;&#x548C;&#x6539;&#x8FDB;&#x601D;&#x8DEF;"><b>6.3. </b>&#x95EE;&#x9898;&#x548C;&#x6539;&#x8FDB;&#x601D;&#x8DEF;</a></li></ul></ul></div><a href="#zmq&#x548C;nanomsg" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><ul>
<li><a href="#zmq&#x548C;nanomsg">zmq&#x548C;nanomsg</a><ul>
<li><a href="#nanomsg&#x652F;&#x6301;&#x7684;socket&#x7C7B;&#x578B;">nanomsg&#x652F;&#x6301;&#x7684;socket&#x7C7B;&#x578B;</a></li>
<li><a href="#nanomsg&#x7684;transport&#x7C7B;&#x578B;">nanomsg&#x7684;transport&#x7C7B;&#x578B;</a></li>
<li><a href="#nanomsg&#x548C;nng">nanomsg&#x548C;nng</a></li>
<li><a href="#nng&#x7684;&#x7EAF;go&#x7248;&#x672C;">nng&#x7684;&#x7EAF;go&#x7248;&#x672C;</a></li>
</ul>
</li>
<li><a href="#&#x9AD8;&#x7EA7;req-rep">&#x9AD8;&#x7EA7;REQ-REP</a><ul>
<li><a href="#&#x7ECF;&#x8FC7;router&#x4F1A;&#x52A0;address-frame">&#x7ECF;&#x8FC7;ROUTER&#x4F1A;&#x52A0;&quot;address&quot; frame</a><ul>
<li><a href="#&#x5730;&#x5740;&#x7684;&#x751F;&#x6210;">&#x5730;&#x5740;&#x7684;&#x751F;&#x6210;</a></li>
<li><a href="#router&#x518D;&#x628A;&#x6807;&#x8BC6;&#x7B26;&#x5265;&#x6389;-&#x4F20;&#x7ED9;req">Router&#x518D;&#x628A;&#x6807;&#x8BC6;&#x7B26;&#x5265;&#x6389;, &#x4F20;&#x7ED9;REQ</a></li>
<li><a href="#&#x603B;&#x7ED3;">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#&#x642D;&#x914D;">&#x642D;&#x914D;</a><ul>
<li><a href="#&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;">&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;</a></li>
<li><a href="#&#x4E0D;&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;">&#x4E0D;&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;</a></li>
<li><a href="#&#x603B;&#x7ED3;-1">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#zmq&#x4F7F;&#x7528;">zmq&#x4F7F;&#x7528;</a><ul>
<li><a href="#transport&#x7C7B;&#x578B;">transport&#x7C7B;&#x578B;</a><ul>
<li><a href="#&#x7EBF;&#x7A0B;&#x95F4;">&#x7EBF;&#x7A0B;&#x95F4;</a></li>
<li><a href="#&#x8FDB;&#x7A0B;&#x95F4;">&#x8FDB;&#x7A0B;&#x95F4;</a></li>
<li><a href="#tcp">TCP</a></li>
<li><a href="#pgm">pgm</a></li>
</ul>
</li>
<li><a href="#zmq-socket">zmq socket</a><ul>
<li><a href="#server&#x548C;client">server&#x548C;client</a></li>
<li><a href="#zmq-socket&#x7C7B;&#x578B;">zmq socket&#x7C7B;&#x578B;</a></li>
<li><a href="#zmq&#x7684;send&#x548C;recv&#x548C;tcp&#x7684;&#x4E0D;&#x540C;">zmq&#x7684;send&#x548C;recv&#x548C;tcp&#x7684;&#x4E0D;&#x540C;</a></li>
<li><a href="#zmq&#x7684;message-framing">zmq&#x7684;message framing</a><ul>
<li><a href="#frames">Frames</a></li>
<li><a href="#&#x517C;&#x5BB9;&#x6027;">&#x517C;&#x5BB9;&#x6027;</a></li>
</ul>
</li>
<li><a href="#io-thread&#x548C;context">IO thread&#x548C;context</a></li>
<li><a href="#zmq_poll&#x51FD;&#x6570;">zmq_poll()&#x51FD;&#x6570;</a><ul>
<li><a href="#&#x4E0D;&#x7528;poll">&#x4E0D;&#x7528;poll</a></li>
<li><a href="#&#x4F7F;&#x7528;poll">&#x4F7F;&#x7528;poll</a></li>
</ul>
</li>
<li><a href="#&#x5206;&#x7247;&#x7684;msg">&#x5206;&#x7247;&#x7684;msg</a></li>
</ul>
</li>
<li><a href="#&#x670D;&#x52A1;&#x53D1;&#x73B0;">&#x670D;&#x52A1;&#x53D1;&#x73B0;</a></li>
<li><a href="#&#x591A;&#x5BF9;&#x591A;&#x7684;client&#x548C;server">&#x591A;&#x5BF9;&#x591A;&#x7684;client&#x548C;server</a></li>
<li><a href="#&#x5176;&#x4ED6;&#x6A21;&#x578B;">&#x5176;&#x4ED6;&#x6A21;&#x578B;</a></li>
<li><a href="#&#x5E76;&#x53D1;&#x652F;&#x6301;">&#x5E76;&#x53D1;&#x652F;&#x6301;</a></li>
<li><a href="#zmq&#x7684;&#x5E94;&#x7528;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;run&#x5728;&#x7EBF;&#x7A0B;-&#x8FDB;&#x7A0B;-&#x6216;node&#x4E0A;">zmq&#x7684;&#x5E94;&#x7528;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;run&#x5728;&#x7EBF;&#x7A0B;, &#x8FDB;&#x7A0B;, &#x6216;node&#x4E0A;.</a></li>
<li><a href="#pub&#x5230;&#x5DF2;&#x77E5;&#x6570;&#x91CF;&#x7684;subscriber">pub&#x5230;&#x5DF2;&#x77E5;&#x6570;&#x91CF;&#x7684;subscriber</a></li>
<li><a href="#&#x96F6;&#x62F7;&#x8D1D;">&#x96F6;&#x62F7;&#x8D1D;</a></li>
<li><a href="#pub-sub&#x5B9E;&#x9645;&#x4E0A;&#x662F;msg-filter">pub-sub&#x5B9E;&#x9645;&#x4E0A;&#x662F;msg filter</a></li>
<li><a href="#&#x9AD8;&#x6C34;&#x4F4D;">&#x9AD8;&#x6C34;&#x4F4D;</a></li>
<li><a href="#&#x4E22;&#x5305;&#x600E;&#x4E48;&#x5B9A;&#x4F4D;">&#x4E22;&#x5305;&#x600E;&#x4E48;&#x5B9A;&#x4F4D;?</a></li>
</ul>
</li>
<li><a href="#&#x6D88;&#x606F;&#x4EA4;&#x4E92;&#x6A21;&#x5F0F;">&#x6D88;&#x606F;&#x4EA4;&#x4E92;&#x6A21;&#x5F0F;</a><ul>
<li><a href="#pair&#x7C7B;&#x578B;">PAIR&#x7C7B;&#x578B;</a><ul>
<li><a href="#&#x4E3A;&#x793E;&#x4E48;&#x8981;&#x7528;pair">&#x4E3A;&#x793E;&#x4E48;&#x8981;&#x7528;pair</a></li>
</ul>
</li>
<li><a href="#req-rep">req-rep</a><ul>
<li><a href="#server&#x7AEF;">server&#x7AEF;</a></li>
<li><a href="#client&#x7AEF;">client&#x7AEF;</a></li>
</ul>
</li>
<li><a href="#pub-sub">pub-sub</a><ul>
<li><a href="#server&#x4FA7;">server&#x4FA7;</a></li>
<li><a href="#client&#x4FA7;">client&#x4FA7;</a></li>
</ul>
</li>
<li><a href="#push-pull">push-pull</a><ul>
<li><a href="#&#x751F;&#x4EA7;&#x8005;-ventilator">&#x751F;&#x4EA7;&#x8005; ventilator</a></li>
<li><a href="#&#x6D88;&#x8D39;&#x8005;worker">&#x6D88;&#x8D39;&#x8005;worker</a></li>
<li><a href="#sink">sink</a></li>
<li><a href="#&#x603B;&#x7ED3;-2">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#context">context</a></li>
<li><a href="#pipeline">pipeline</a></li>
<li><a href="#fanout">fanout</a></li>
<li><a href="#&#x7075;&#x9B42;&#x51E0;&#x95EE;">&#x7075;&#x9B42;&#x51E0;&#x95EE;</a><ul>
<li><a href="#&#x963B;&#x585E;&#x8FD8;&#x662F;&#x5F02;&#x6B65;">&#x963B;&#x585E;&#x8FD8;&#x662F;&#x5F02;&#x6B65;?</a></li>
<li><a href="#&#x8C01;&#x5F53;server&#x8C01;&#x5F53;client">&#x8C01;&#x5F53;server&#x8C01;&#x5F53;client?</a></li>
<li><a href="#&#x600E;&#x4E48;&#x5728;wire&#x4E0A;&#x8868;&#x793A;&#x4E00;&#x4E2A;message">&#x600E;&#x4E48;&#x5728;wire&#x4E0A;&#x8868;&#x793A;&#x4E00;&#x4E2A;message?</a></li>
<li><a href="#&#x5982;&#x679C;&#x5BF9;&#x7AEF;&#x6CA1;&#x51C6;&#x5907;&#x597D;&#x7684;&#x65F6;&#x5019;-&#x8981;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x5728;&#x54EA;&#x91CC;">&#x5982;&#x679C;&#x5BF9;&#x7AEF;&#x6CA1;&#x51C6;&#x5907;&#x597D;&#x7684;&#x65F6;&#x5019;, &#x8981;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x5728;&#x54EA;&#x91CC;?</a></li>
<li><a href="#&#x62E5;&#x585E;&#x63A7;&#x5236;&#x7B56;&#x7565;">&#x62E5;&#x585E;&#x63A7;&#x5236;&#x7B56;&#x7565;?</a></li>
<li><a href="#&#x6D88;&#x606F;&#x4E22;&#x5931;&#x600E;&#x4E48;&#x529E;-&#x8981;&#x4FDD;&#x8BC1;&#x9001;&#x8FBE;&#x5417;">&#x6D88;&#x606F;&#x4E22;&#x5931;&#x600E;&#x4E48;&#x529E;? &#x8981;&#x4FDD;&#x8BC1;&#x9001;&#x8FBE;&#x5417;?</a></li>
<li><a href="#&#x5982;&#x679C;&#x6709;&#x65B0;&#x7684;transport&#x65B9;&#x6CD5;&#x600E;&#x4E48;&#x529E;-app&#x8981;&#x6539;&#x5417;-&#x6BD4;&#x5982;&#x589E;&#x52A0;&#x652F;&#x6301;yipc">&#x5982;&#x679C;&#x6709;&#x65B0;&#x7684;transport&#x65B9;&#x6CD5;&#x600E;&#x4E48;&#x529E;? app&#x8981;&#x6539;&#x5417;? &#x6BD4;&#x5982;&#x589E;&#x52A0;&#x652F;&#x6301;yipc?</a></li>
<li><a href="#&#x6D88;&#x606F;&#x600E;&#x4E48;&#x8DEF;&#x7531;">&#x6D88;&#x606F;&#x600E;&#x4E48;&#x8DEF;&#x7531;?</a></li>
<li><a href="#&#x591A;&#x8BED;&#x8A00;&#x600E;&#x4E48;&#x9002;&#x914D;-encoding&#x600E;&#x4E48;&#x9009;&#x62E9;-&#x7F51;&#x7EDC;&#x9519;&#x8BEF;&#x600E;&#x4E48;&#x5904;&#x7406;">&#x591A;&#x8BED;&#x8A00;&#x600E;&#x4E48;&#x9002;&#x914D;? encoding&#x600E;&#x4E48;&#x9009;&#x62E9;? &#x7F51;&#x7EDC;&#x9519;&#x8BEF;&#x600E;&#x4E48;&#x5904;&#x7406;?</a></li>
<li><a href="#&#x4F5C;&#x8005;&#x89C2;&#x70B9;">&#x4F5C;&#x8005;&#x89C2;&#x70B9;</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#zero-mqzmq-0mq">zero mq(zmq, 0mq)</a></li>
<li><a href="#&#x95EE;&#x9898;-req-rep&#x6A21;&#x5F0F;&#x4E0B;&#x7684;rpc-&#x600E;&#x4E48;&#x628A;&#x5F02;&#x6B65;&#x540C;&#x6B65;&#x5316;&#x7684;">&#x95EE;&#x9898;: REQ-REP&#x6A21;&#x5F0F;&#x4E0B;&#x7684;RPC, &#x600E;&#x4E48;&#x628A;&#x5F02;&#x6B65;&#x540C;&#x6B65;&#x5316;&#x7684;?</a><ul>
<li><a href="#zmq&#x4F7F;&#x7528;&#x6700;&#x57FA;&#x672C;&#x7684;&#x6A21;&#x5F0F;-send&#x540E;&#x9A6C;&#x4E0A;recv">zmq&#x4F7F;&#x7528;&#x6700;&#x57FA;&#x672C;&#x7684;&#x6A21;&#x5F0F;, send&#x540E;&#x9A6C;&#x4E0A;recv</a></li>
<li><a href="#go&#x6807;&#x51C6;&#x5E93;&#x7684;rpc">go&#x6807;&#x51C6;&#x5E93;&#x7684;rpc</a></li>
<li><a href="#&#x95EE;&#x9898;&#x548C;&#x6539;&#x8FDB;&#x601D;&#x8DEF;">&#x95EE;&#x9898;&#x548C;&#x6539;&#x8FDB;&#x601D;&#x8DEF;</a></li>
</ul>
</li>
</ul>
<h1 id="zmq&#x548C;nanomsg"><a name="zmq&#x548C;nanomsg" class="anchor-navigation-ex-anchor" href="#zmq&#x548C;nanomsg"><i class="fa fa-link" aria-hidden="true"></i></a>1. zmq&#x548C;nanomsg</h1>
<p>zmq&#x7684;&#x4F5C;&#x8005;&#x4E4B;&#x4E00;&#x540E;&#x6765;&#x81EA;&#x7ACB;&#x95E8;&#x6237;, &#x521B;&#x7ACB;&#x4E86;nanomsg
<a href="https://nanomsg.org/documentation-zeromq.html" target="_blank">https://nanomsg.org/documentation-zeromq.html</a>
&#x4E0A;&#x9762;&#x6587;&#x7AE0;&#x8BE6;&#x7EC6;&#x5199;&#x4E86;nanomsg&#x548C;zmq&#x7684;&#x4E0D;&#x540C;&#x70B9;.
&#x603B;&#x7684;&#x6765;&#x8BF4;, zmq&#x7684;&#x4F5C;&#x8005;&#x4E4B;&#x4E00;&#x5BF9;2008&#x5E74;&#x5F53;&#x65F6;&#x7684;&#x5B9E;&#x73B0;&#x6709;&#x6240;&#x53CD;&#x601D;, &#x7136;&#x540E;&#x5728;&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#x4E0A;&#x6709;&#x6240;&#x6539;&#x8FDB;, &#x4F46;&#x6574;&#x4F53;&#x601D;&#x60F3;&#x662F;&#x6709;&#x5EF6;&#x7EED;&#x6027;&#x7684;, &#x6BD4;&#x5982;&#x90FD;&#x662F;&#x4EE5;lib&#x5F62;&#x5F0F;&#x63D0;&#x4F9B;&#x7684;.
&#x7279;&#x522B;&#x7684;, nanomsg&#x662F;MIT&#x7684;license</p>
<h2 id="nanomsg&#x652F;&#x6301;&#x7684;socket&#x7C7B;&#x578B;"><a name="nanomsg&#x652F;&#x6301;&#x7684;socket&#x7C7B;&#x578B;" class="anchor-navigation-ex-anchor" href="#nanomsg&#x652F;&#x6301;&#x7684;socket&#x7C7B;&#x578B;"><i class="fa fa-link" aria-hidden="true"></i></a>1.1. nanomsg&#x652F;&#x6301;&#x7684;socket&#x7C7B;&#x578B;</h2>
<ul>
<li>PAIR - simple one-to-one communication</li>
<li>BUS - simple many-to-many communication</li>
<li>REQREP - allows to build clusters of stateless services to process user requests</li>
<li>PUBSUB - distributes messages to large sets of interested subscribers</li>
<li>PIPELINE - aggregates messages from multiple sources and load balances them among many destinations</li>
<li>SURVEY - allows to query state of multiple applications in a single go</li>
</ul>
<h2 id="nanomsg&#x7684;transport&#x7C7B;&#x578B;"><a name="nanomsg&#x7684;transport&#x7C7B;&#x578B;" class="anchor-navigation-ex-anchor" href="#nanomsg&#x7684;transport&#x7C7B;&#x578B;"><i class="fa fa-link" aria-hidden="true"></i></a>1.2. nanomsg&#x7684;transport&#x7C7B;&#x578B;</h2>
<ul>
<li>INPROC - transport within a process (between threads, modules etc.)</li>
<li>IPC - transport between processes on a single machine</li>
<li>TCP - network transport via TCP</li>
<li>WS - websockets over TCP</li>
</ul>
<h2 id="nanomsg&#x548C;nng"><a name="nanomsg&#x548C;nng" class="anchor-navigation-ex-anchor" href="#nanomsg&#x548C;nng"><i class="fa fa-link" aria-hidden="true"></i></a>1.3. nanomsg&#x548C;nng</h2>
<p>nng&#x53C8;&#x662F;nanomsg&#x7684;&#x6539;&#x7248;: <a href="https://github.com/nanomsg/nng" target="_blank">https://github.com/nanomsg/nng</a>
&#x770B;&#x8D77;&#x6765;&#x4E0D;&#x9519;:
<a href="https://github.com/nanomsg" target="_blank">https://github.com/nanomsg</a></p>
<h2 id="nng&#x7684;&#x7EAF;go&#x7248;&#x672C;"><a name="nng&#x7684;&#x7EAF;go&#x7248;&#x672C;" class="anchor-navigation-ex-anchor" href="#nng&#x7684;&#x7EAF;go&#x7248;&#x672C;"><i class="fa fa-link" aria-hidden="true"></i></a>1.4. nng&#x7684;&#x7EAF;go&#x7248;&#x672C;</h2>
<p><a href="https://github.com/nanomsg/mangos" target="_blank">https://github.com/nanomsg/mangos</a>
&#x76EE;&#x524D;&#x662F;v3&#x7248;&#x672C;
&#x770B;&#x8D77;&#x6765;&#x5B8C;&#x6210;&#x5EA6;&#x4E0D;&#x9519;.</p>
<h1 id="&#x9AD8;&#x7EA7;req-rep"><a name="&#x9AD8;&#x7EA7;req-rep" class="anchor-navigation-ex-anchor" href="#&#x9AD8;&#x7EA7;req-rep"><i class="fa fa-link" aria-hidden="true"></i></a>2. &#x9AD8;&#x7EA7;REQ-REP</h1>
<p>REP&#x90FD;&#x6709;envelop, envelop&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x52A0;&quot;&#x62A5;&#x6587;&#x5934;&quot;.</p>
<blockquote>
<p>We already looked briefly at multipart messages. Let&#x2019;s now look at a major use case, which is <em>reply message envelopes</em>. An envelope is a way of safely packaging up data with an address, without touching the data itself. By separating reply addresses into an envelope we make it possible to write general purpose intermediaries such as APIs and proxies that create, read, and remove addresses no matter what the message payload or structure is.</p>
<p>In the request-reply pattern, the envelope holds the return address for replies. It is how a ZeroMQ network with no state can create round-trip request-reply dialogs.</p>
<p>When you use REQ and REP sockets you don&#x2019;t even see envelopes; these sockets deal with them automatically. But for most of the interesting request-reply patterns, you&#x2019;ll want to understand envelopes and particularly ROUTER sockets. We&#x2019;ll work through this step-by-step.</p>
</blockquote>
<p>zmq&#x7528;&#x591A;frame&#x63CF;&#x8FF0;&#x4E00;&#x4E2A;msg, &#x5730;&#x5740;&#x548C;data&#x5728;&#x4E0D;&#x540C;&#x7684;frame&#x4E2D;.</p>
<blockquote>
<p>The ZeroMQ reply envelope formally consists of zero or more reply addresses, followed by an empty frame (the envelope delimiter), followed by the message body (zero or more frames). The envelope is created by multiple sockets working together in a chain. We&#x2019;ll break this down.</p>
<p>We&#x2019;ll start by sending &#x201C;Hello&#x201D; through a REQ socket. The REQ socket creates the simplest possible reply envelope, which has no addresses, just an empty delimiter frame and the message frame containing the &#x201C;Hello&#x201D; string. This is a two-frame message.</p>
</blockquote>
<p>&#x7B80;&#x5355;&#x7684;REQ-REP&#x6CA1;&#x5730;&#x5740;, &#x4F46;&#x6709;&#x4E2A;&#x7A7A;&#x7684;&#x5206;&#x9694;frame. &#x7B2C;&#x4E00;&#x4E2A;&#x6570;&#x5B57;&#x662F;&#x5B57;&#x8282;&#x6570;<br><img src="img/golang_zmq_20220911224753.png" alt=""><br>zmq&#x4F1A;&#x628A;&#x524D;&#x9762;&#x7684;envelop&#x5934;&#x5265;&#x6389;, &#x53EA;&#x4F20;&#x9012;data frame&#x7ED9;&#x5E94;&#x7528;&#x5C42;.<br>every request and every reply is in fact two frames, an empty frame and then the body</p>
<h2 id="&#x7ECF;&#x8FC7;router&#x4F1A;&#x52A0;address-frame"><a name="&#x7ECF;&#x8FC7;router&#x4F1A;&#x52A0;address-frame" class="anchor-navigation-ex-anchor" href="#&#x7ECF;&#x8FC7;router&#x4F1A;&#x52A0;address-frame"><i class="fa fa-link" aria-hidden="true"></i></a>2.1. &#x7ECF;&#x8FC7;ROUTER&#x4F1A;&#x52A0;&quot;address&quot; frame</h2>
<p>&#x8FD9;&#x91CC;&#x7684;address&#x662F;&#x7528;&#x6765;&#x8BC6;&#x522B;connection&#x7684;. &#x56E0;&#x4E3A;router&#x9762;&#x5BF9;&#x7684;&#x662F;&#x591A;&#x4E2A;connection.<br><img src="img/golang_zmq_20220911224922.png" alt="">  </p>
<h3 id="&#x5730;&#x5740;&#x7684;&#x751F;&#x6210;"><a name="&#x5730;&#x5740;&#x7684;&#x751F;&#x6210;" class="anchor-navigation-ex-anchor" href="#&#x5730;&#x5740;&#x7684;&#x751F;&#x6210;"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.1. &#x5730;&#x5740;&#x7684;&#x751F;&#x6210;</h3>
<blockquote>
<p>The ROUTER socket <em>invents</em> a random identity for each connection with which it works. If there are three REQ sockets connected to a ROUTER socket, it will invent three random identities, one for each REQ socket.</p>
</blockquote>
<p>router&#x7684;socket&#x4F1A;&#x7ED9;&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x751F;&#x6210;&#x968F;&#x673A;&#x7684;&#x6807;&#x8BC6;&#x7B26;. &#x6BD4;&#x5982;ABC. router&#x5185;&#x90E8;&#x7528;map&#x6765;&#x8DDF;&#x8E2A;&#x8FD9;&#x4E2A;&#x6807;&#x8BC6;&#x7B26;&#x548C;connection&#x7684;&#x5BF9;&#x5E94;&#x5173;&#x7CFB;.<br><img src="img/golang_zmq_20220911224952.png" alt=""><br>&#x7136;&#x540E;&#x8FD9;&#x4E09;&#x4E2A;frame&#x88AB;&#x53D1;&#x5230;DEALER socket&#x51FA;&#x53BB;. &#x4ECE;&#x800C;REP&#x7684;socket&#x4E5F;&#x6536;&#x5230;&#x8FD9;3&#x4E2A;frame.<br>REP&#x7684;&#x5E94;&#x7528;&#x5C42;&#x4E0D;&#x5173;&#x5FC3;&#x8FD9;&#x4E2A;&#x6807;&#x8BC6;frame, &#x6240;&#x4EE5;zmq&#x6682;&#x5B58;&#x8FD9;&#x4E2A;&#x6807;&#x8BC6;, &#x5265;&#x6389;&#x524D;&#x4E24;&#x4E2A;frame, &#x53EA;&#x8FD4;&#x56DE;Hello&#x7ED9;&#x5E94;&#x7528;&#x5C42;.<br>&#x5E94;&#x7528;&#x5C42;&#x5904;&#x7406;&#x540E;, zmq&#x628A;&#x4FDD;&#x5B58;&#x7684;frame&#x91CD;&#x65B0;&#x5305;&#x88C5;&#x56DE;frame, &#x56DE;&#x53BB;&#x8FD8;&#x662F;3&#x4E2A;frame.<br><img src="img/golang_zmq_20220911225029.png" alt=""><br>&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x7528;&#x5E95;&#x5C42;socket&#x7684;&#x5730;&#x5740;&#x505A;&#x4E3A;&#x6807;&#x8BC6;? &#x8FD9;&#x6837;&#x5C31;&#x4E0D;&#x7528;&#x751F;&#x6210;&#x968F;&#x673A;&#x7684;&#x6807;&#x8BC6;&#x4E86;&#x5440;???? &#x662F;&#x5B89;&#x5168;&#x6027;&#x8003;&#x8651;&#x5417;?</p>
<h3 id="router&#x518D;&#x628A;&#x6807;&#x8BC6;&#x7B26;&#x5265;&#x6389;-&#x4F20;&#x7ED9;req"><a name="router&#x518D;&#x628A;&#x6807;&#x8BC6;&#x7B26;&#x5265;&#x6389;-&#x4F20;&#x7ED9;req" class="anchor-navigation-ex-anchor" href="#router&#x518D;&#x628A;&#x6807;&#x8BC6;&#x7B26;&#x5265;&#x6389;-&#x4F20;&#x7ED9;req"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.2. Router&#x518D;&#x628A;&#x6807;&#x8BC6;&#x7B26;&#x5265;&#x6389;, &#x4F20;&#x7ED9;REQ</h3>
<p><img src="img/golang_zmq_20220911225106.png" alt=""><br>DEALER&#x8FD8;&#x662F;&#x628A;3&#x4E2A;frame&#x90FD;&#x7ED9;ROUTER, ROUTER&#x67E5;&#x8868;&#x5F97;&#x5230;connection, &#x5265;&#x6389;&#x6807;&#x8BC6;&#x7B26;&#x90A3;&#x4E2A;frame, &#x53EA;&#x53D1;2&#x4E2A;frame&#x7ED9;REQ socket.<br><img src="img/golang_zmq_20220911225150.png" alt="">  </p>
<blockquote>
<p>ROUTER sockets don&#x2019;t care about the whole envelope. They don&#x2019;t know anything about the empty delimiter. All they care about is that one identity frame that lets them figure out which connection to send a message to.</p>
</blockquote>
<h3 id="&#x603B;&#x7ED3;"><a name="&#x603B;&#x7ED3;" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.3. &#x603B;&#x7ED3;</h3>
<ul>
<li><p>The REQ socket sends, to the network, an empty delimiter frame in front of the message data. REQ sockets are synchronous. REQ sockets always send one request and then wait for one reply. REQ sockets talk to one peer at a time. If you connect a REQ socket to multiple peers, requests are distributed to and replies expected from each peer one turn at a time.</p>
</li>
<li><p>The REP socket reads and saves all identity frames up to and including the empty delimiter, then passes the following frame or frames to the caller. REP sockets are synchronous and talk to one peer at a time. If you connect a REP socket to multiple peers, requests are read from peers in fair fashion, and replies are always sent to the same peer that made the last request.</p>
</li>
<li><p>The DEALER socket is oblivious to the reply envelope and handles this like any multipart message. DEALER sockets are asynchronous and like PUSH and PULL combined. They distribute sent messages among all connections, and fair-queue received messages from all connections.</p>
</li>
<li><p>The ROUTER socket is oblivious to the reply envelope, like DEALER. It creates identities for its connections, and passes these identities to the caller as a first frame in any received message. Conversely, when the caller sends a message, it uses the first message frame as an identity to look up the connection to send to. ROUTERS are asynchronous.</p>
</li>
</ul>
<h2 id="&#x642D;&#x914D;"><a name="&#x642D;&#x914D;" class="anchor-navigation-ex-anchor" href="#&#x642D;&#x914D;"><i class="fa fa-link" aria-hidden="true"></i></a>2.2. &#x642D;&#x914D;</h2>
<p>&#x8BE6;&#x89C1;: <a href="https://zguide.zeromq.org/docs/chapter3/#Request-Reply-Combinations" target="_blank">https://zguide.zeromq.org/docs/chapter3/#Request-Reply-Combinations</a></p>
<h3 id="&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;"><a name="&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;" class="anchor-navigation-ex-anchor" href="#&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.1. &#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;</h3>
<ul>
<li>REQ to REP</li>
<li>DEALER to REP</li>
<li>REQ to ROUTER</li>
<li>DEALER to ROUTER</li>
<li>DEALER to DEALER</li>
<li>ROUTER to ROUTER<h3 id="&#x4E0D;&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;"><a name="&#x4E0D;&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;" class="anchor-navigation-ex-anchor" href="#&#x4E0D;&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.2. &#x4E0D;&#x5408;&#x6CD5;&#x7684;&#x642D;&#x914D;</h3>
</li>
<li>REQ to REQ</li>
<li>REQ to DEALER</li>
<li>REP to REP</li>
<li>REP to ROUTER<h3 id="&#x603B;&#x7ED3;_1"><a name="&#x603B;&#x7ED3;_1" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;_1"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.3. &#x603B;&#x7ED3;</h3>
</li>
<li><p>DEALER is like an asynchronous REQ socket, and ROUTER is like an asynchronous REP socket. Where we use a REQ socket, we can use a DEALER; we just have to read and write the envelope ourselves. Where we use a REP socket, we can stick a ROUTER; we just need to manage the identities ourselves.</p>
</li>
<li><p>Think of REQ and DEALER sockets as &#x201C;clients&#x201D; and REP and ROUTER sockets as &#x201C;servers&#x201D;.</p>
</li>
</ul>
<h1 id="zmq&#x4F7F;&#x7528;"><a name="zmq&#x4F7F;&#x7528;" class="anchor-navigation-ex-anchor" href="#zmq&#x4F7F;&#x7528;"><i class="fa fa-link" aria-hidden="true"></i></a>3. zmq&#x4F7F;&#x7528;</h1>
<p>libzmq&#x662F;zmq&#x7684;&#x6838;&#x5FC3;lib
server&#x7AEF;&#x7528;<code>zmq_bind()</code>&#x7ED1;&#x5B9A;&#x5230;&quot;well known&quot;&#x7684;&#x5730;&#x5740;
client&#x7AEF;&#x4ECE;&#x662F;&#x4E0D;&#x56FA;&#x5B9A;&#x7684;, &#x52A8;&#x6001;&#x7684;&#x5730;&#x5740;<code>zmq_connect()</code>&#x5230;server
&#x6240;&#x6709;&#x7684;zmq socket&#x90FD;&#x662F;&#x5728;zmq&#x7684;context&#x91CC;&#x9762;. zmq&#x7684;context&#x662F;&#x4E00;&#x4E2A;IO&#x7EBF;&#x7A0B;&#x6C60;&#x52A0;&#x5E95;&#x5C42;socket&#x7684;&#x5408;&#x4F53;.
API <code>void *zmq_init (int io_threads)</code>&#x53EF;&#x4EE5;&#x6765;&#x914D;&#x7F6E;io thread&#x7684;&#x4E2A;&#x6570;. </p>
<h2 id="transport&#x7C7B;&#x578B;"><a name="transport&#x7C7B;&#x578B;" class="anchor-navigation-ex-anchor" href="#transport&#x7C7B;&#x578B;"><i class="fa fa-link" aria-hidden="true"></i></a>3.1. transport&#x7C7B;&#x578B;</h2>
<p>transport&#x7528;&#x4E0B;&#x9762;&#x7684;&#x683C;&#x5F0F;&#x6765;&#x8BF4;&#x660E;: <code>transport://&#x5730;&#x5740;</code></p>
<h3 id="&#x7EBF;&#x7A0B;&#x95F4;"><a name="&#x7EBF;&#x7A0B;&#x95F4;" class="anchor-navigation-ex-anchor" href="#&#x7EBF;&#x7A0B;&#x95F4;"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.1. &#x7EBF;&#x7A0B;&#x95F4;</h3>
<p><code>inproc://&#x540D;&#x5B57;</code> &#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x76F4;&#x63A5;&#x7EBF;&#x7A0B;&#x95F4;&#x5185;&#x5B58;&#x4F20;&#x9012;, &#x6B64;&#x65F6;zmq&#x6CA1;&#x6709;IO thread&#x53C2;&#x4E0E;, &#x5373;<code>void *zmq_init (int io_threads);</code>&#x53EF;&#x4EE5;&#x4F20;0. &#x5176;&#x4ED6;&#x7684;transport&#x9700;&#x8981;&#x80CC;&#x666F;io&#x7EBF;&#x7A0B;&#x81F3;&#x5C11;&#x4E00;&#x4E2A;.</p>
<pre class="language-"><code class="lang-c"><span class="token comment">// Assign the in-process name &quot;#1&quot;</span>
rc <span class="token operator">=</span> <span class="token function">zmq_bind</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;inproc://#1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Assign the in-process name &quot;my-endpoint&quot;</span>
rc <span class="token operator">=</span> <span class="token function">zmq_bind</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;inproc://my-endpoint&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">assert</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Connect to the in-process name &quot;#1&quot;</span>
rc <span class="token operator">=</span> <span class="token function">zmq_connect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;inproc://#1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Connect to the in-process name &quot;my-endpoint&quot;</span>
rc <span class="token operator">=</span> <span class="token function">zmq_connect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;inproc://my-endpoint&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">assert</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x4E0D;&#x652F;&#x6301;disconnected&#x6A21;&#x5F0F;, &#x5373;&#x4E00;&#x5B9A;&#x8981;server&#x5148;&#x8D77;. &#x53EF;&#x80FD;&#x540E;&#x9762;&#x7248;&#x672C;&#x4F1A;&#x652F;&#x6301;</p>
<h3 id="&#x8FDB;&#x7A0B;&#x95F4;"><a name="&#x8FDB;&#x7A0B;&#x95F4;" class="anchor-navigation-ex-anchor" href="#&#x8FDB;&#x7A0B;&#x95F4;"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.2. &#x8FDB;&#x7A0B;&#x95F4;</h3>
<p><code>ipc://&#x8DEF;&#x5F84;</code> &#x5B9E;&#x9645;&#x4E0A;&#x662F;unix domain socket</p>
<pre class="language-"><code class="lang-c"><span class="token comment">// Assign the pathname &quot;/tmp/feeds/0&quot;</span>
rc <span class="token operator">=</span> <span class="token function">zmq_bind</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;ipc:///tmp/feeds/0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">assert</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Connect to the pathname &quot;/tmp/feeds/0&quot;</span>
rc <span class="token operator">=</span> <span class="token function">zmq_connect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;ipc:///tmp/feeds/0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">assert</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x4E5F;&#x652F;&#x6301;disconnected&#x6A21;&#x5F0F;. &#x5373;server&#x540E;&#x8D77;&#x8D77;, client&#x5148;&#x8D77;, &#x4F46;&#x8FD8;&#x662F;&#x8FDE;&#x7684;&#x4E0A;.</p>
<h3 id="tcp"><a name="tcp" class="anchor-navigation-ex-anchor" href="#tcp"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.3. TCP</h3>
<p>&#x5BF9;tcp&#x7684;&#x5730;&#x5740;&#x505A;&#x4E86;&#x7B80;&#x5316;&#x5C01;&#x88C5;</p>
<pre class="language-"><code class="lang-c"><span class="token comment">// TCP port 5555 on all available interfaces</span>
rc <span class="token operator">=</span> <span class="token function">zmq_bind</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;tcp:/// :5555&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// TCP port 5555 on the local loop-back interface on all platforms</span>
rc <span class="token operator">=</span> <span class="token function">zmq_bind</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;tcp://127.0.0.1:5555&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// TCP port 5555 on the first Ethernet network interface on Linux</span>
rc <span class="token operator">=</span> <span class="token function">zmq_bind</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;tcp://eth0:5555&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">assert</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Connecting using an IP address</span>
rc <span class="token operator">=</span> <span class="token function">zmq_connect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;tcp://192.168.1.1:5555&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Connecting using a DNS name</span>
rc <span class="token operator">=</span> <span class="token function">zmq_connect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;tcp://server1:5555&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">assert</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>tcp&#x7C7B;&#x578B;&#x7684;transport&#x652F;&#x6301;disconnected&#x6A21;&#x5F0F;. &#x5373;server&#x540E;&#x8D77;&#x8D77;, client&#x5148;&#x8D77;, &#x4F46;&#x8FD8;&#x662F;&#x8FDE;&#x7684;&#x4E0A;.</p>
<h3 id="pgm"><a name="pgm" class="anchor-navigation-ex-anchor" href="#pgm"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.4. pgm</h3>
<p>PGM (Pragmatic General Multicast) is a protocol for reliable multicast transport of data over IP networks.
zmq&#x652F;&#x6301;&#x4E24;&#x79CD;pgm:</p>
<ul>
<li>pgm: &#x57FA;&#x4E8E;raw IP</li>
<li>epgm: &#x57FA;&#x4E8E;UDP
pgm&#x7684;socket&#x53EA;&#x80FD;&#x7528;&#x4E8E;PUB SUB&#x6A21;&#x5F0F;
pgm&#x7684;&#x5730;&#x5740;&#x683C;&#x5F0F;&#x6709;&#x70B9;&#x957F;: <code>interface&#x540D;;&#x591A;&#x64AD;&#x5730;&#x5740;;&#x7AEF;&#x53E3;</code><pre class="language-"><code class="lang-c"><span class="token comment">// Connecting to the multicast address 239.192.1.1, port 5555,</span>
<span class="token comment">// using the first Ethernet network interface on Linux</span>
<span class="token comment">// and the Encapsulated PGM protocol</span>
rc <span class="token operator">=</span> <span class="token function">zmq_connect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;epgm://eth0;239.192.1.1:5555&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Connecting to the multicast address 239.192.1.1, port 5555,</span>
<span class="token comment">// using the network interface with the address 192.168.1.1</span>
<span class="token comment">// and the standard PGM protocol</span>
rc <span class="token operator">=</span> <span class="token function">zmq_connect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;pgm://192.168.1.1;239.192.1.1:5555&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">assert</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</li>
</ul>
<h2 id="zmq-socket"><a name="zmq-socket" class="anchor-navigation-ex-anchor" href="#zmq-socket"><i class="fa fa-link" aria-hidden="true"></i></a>3.2. zmq socket</h2>
<ul>
<li>&#x4E00;&#x4E2A;zmq socket&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x6709;&#x591A;&#x4E2A;incoming&#x548C;outgoing&#x8FDE;&#x63A5;</li>
<li>zmq&#x7684;socket&#x6CA1;&#x6709;accept&#x6982;&#x5FF5;: &#x4E00;&#x4E2A;bind&#x4E86;&#x7684;socket, &#x81EA;&#x52A8;&#x4F1A;accept&#x8FDE;&#x63A5;</li>
<li>&#x80CC;&#x666F;io&#x7EBF;&#x7A0B;&#x4F1A;&#x5904;&#x7406;&#x539F;&#x59CB;&#x8FDE;&#x63A5;, &#x81EA;&#x52A8;&#x65AD;&#x7EBF;&#x91CD;&#x8FDE;</li>
<li>app&#x5C42;&#x4E0D;&#x5E94;&#x8BE5;&#x5173;&#x5FC3;&#x539F;&#x59CB;socket, &#x5B9E;&#x9645;&#x4E0A;app&#x5C42;&#x4E5F;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x539F;&#x59CB;socket</li>
</ul>
<h3 id="server&#x548C;client"><a name="server&#x548C;client" class="anchor-navigation-ex-anchor" href="#server&#x548C;client"><i class="fa fa-link" aria-hidden="true"></i></a>3.2.1. server&#x548C;client</h3>
<ul>
<li>server&#x4EE3;&#x8868;&#x4E00;&#x4E2A;&#x4E0D;&#x53D8;&#x7684;&#x7EC4;&#x4EF6;. server&#x6709;well-konwn&#x5730;&#x5740;, &#x7528;<code>zmq_bind()</code></li>
<li>client&#x66F4;&#x591A;&#x7684;&#x662F;&#x52A8;&#x6001;&#x7684;. &#x7528;<code>zmq_connect()</code>&#x6765;&#x8FDE;server</li>
<li>zmq&#x4F1A;&#x7F13;&#x5B58;message. client&#x548C;server&#x53EF;&#x4EE5;&#x4EFB;&#x610F;&#x987A;&#x5E8F;&#x542F;&#x52A8;. </li>
<li>server&#x53EF;&#x4EE5;bind&#x591A;&#x4E2D;transport&#x7C7B;&#x578B;, &#x6BD4;&#x5982;tcp&#x548C;&#x8FDB;&#x7A0B;&#x95F4;, &#x7EBF;&#x7A0B;&#x95F4;&#x90FD;&#x53EF;&#x4EE5;&#x6DF7;&#x5728;&#x4E00;&#x8D77;bind&#x5230;&#x4E00;&#x4E2A;zmq&#x7684;socket&#x4E0A;<pre class="language-"><code class="lang-c"><span class="token function">zmq_bind</span> <span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;tcp://*:5555&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">zmq_bind</span> <span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;tcp://*:9999&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">zmq_bind</span> <span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;inproc://somename&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
&#x4F46;&#x540C;&#x4E00;&#x4E2A;transport&#x4E00;&#x822C;&#x4E0D;&#x80FD;bind&#x4E24;&#x6B21;, &#x6BD4;&#x5982;tcp, &#x80AF;&#x5B9A;&#x662F;&#x7AEF;&#x53E3;&#x91CD;&#x590D;.</li>
</ul>
<h3 id="zmq-socket&#x7C7B;&#x578B;"><a name="zmq-socket&#x7C7B;&#x578B;" class="anchor-navigation-ex-anchor" href="#zmq-socket&#x7C7B;&#x578B;"><i class="fa fa-link" aria-hidden="true"></i></a>3.2.2. zmq socket&#x7C7B;&#x578B;</h3>
<p>socket&#x7684;&#x7C7B;&#x578B;&#x51B3;&#x5B9A;&#x4E86;&#x4EA4;&#x4E92;&#x6A21;&#x5F0F;, &#x8DEF;&#x7531;&#x65B9;&#x5F0F;, &#x7F13;&#x5B58;&#x7B56;&#x7565;&#x7B49;&#x7B49;. &#x662F;zmq&#x5BF9;&#x4EA4;&#x4E92;&#x6A21;&#x5F0F;&#x7684;&#x5F52;&#x7C7B;&#x548C;&#x62BD;&#x8C61;</p>
<h3 id="zmq&#x7684;send&#x548C;recv&#x548C;tcp&#x7684;&#x4E0D;&#x540C;"><a name="zmq&#x7684;send&#x548C;recv&#x548C;tcp&#x7684;&#x4E0D;&#x540C;" class="anchor-navigation-ex-anchor" href="#zmq&#x7684;send&#x548C;recv&#x548C;tcp&#x7684;&#x4E0D;&#x540C;"><i class="fa fa-link" aria-hidden="true"></i></a>3.2.3. zmq&#x7684;send&#x548C;recv&#x548C;tcp&#x7684;&#x4E0D;&#x540C;</h3>
<ul>
<li>zmq&#x7684;message&#x6709;&#x8FB9;&#x754C;&#x7684;, &#x5C31;&#x50CF;UDP; &#x800C;tcp&#x662F;stream&#x5F0F;&#x7684;.</li>
<li>zmq&#x6709;&#x540E;&#x53F0;IO&#x7EBF;&#x7A0B;, message&#x5148;&#x8FDB;local&#x7684;input queue; &#x53D1;&#x9001;&#x7684;message&#x4E5F;&#x662F;&#x4ECE;local &#x7684;output queue&#x91CC;&#x9762;&#x6765;&#x7684;.</li>
<li>zmq&#x7684;socket&#x53EF;&#x4EE5;1&#x53D1;&#x591A;, &#x5373;1:N&#x7684;&#x591A;&#x64AD;.</li>
<li><code>zmq_send()</code>&#x53EA;&#x662F;&#x628A;message&#x53D1;&#x9001;&#x5230;queue&#x91CC;, &#x540E;&#x53F0;&#x7684;IO&#x7EBF;&#x7A0B;&#x4F1A;&#x5F02;&#x6B65;&#x7684;&#x53D1;&#x9001;&#x8FD9;&#x4E2A;message. &#x9664;&#x975E;&#x7279;&#x522B;&#x60C5;&#x51B5;, &#x8FD9;&#x4E2A;API&#x4E0D;&#x4F1A;&#x963B;&#x585E;</li>
<li><code>zmq_msg_send()</code>&#x540E;&#x9762;&#x8FD8;&#x8981;&#x7814;&#x7A76;&#x4E00;&#x4E0B;</li>
</ul>
<h3 id="zmq&#x7684;message-framing"><a name="zmq&#x7684;message-framing" class="anchor-navigation-ex-anchor" href="#zmq&#x7684;message-framing"><i class="fa fa-link" aria-hidden="true"></i></a>3.2.4. zmq&#x7684;message framing</h3>
<p>zmq&#x5185;&#x90E8;&#x5BF9;wire&#x4E0A;&#x7684;&#x6570;&#x636E;&#x662F;&#x505A;&#x4E86;&#x6309;size&#x5206;&#x5272;&#x7684;. &#x662F;&#x7C7B;UDP&#x7684;&#x8BBE;&#x8BA1;.
&#x6240;&#x4EE5;recv&#x7684;API&#x88AB;&#x8BBE;&#x8BA1;&#x6210;&#x8981;&#x4F20;&#x5165;buffer size&#x7684;&#x683C;&#x5F0F;:</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">int</span> <span class="token function">zmq_send</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>socket<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token keyword">int</span> <span class="token function">zmq_recv</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>socket<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
</code></pre>
<p>&#x90A3;&#x4E48;zmq_recv&#x4F1A;&#x6839;&#x636E;&#x7528;&#x6237;&#x63D0;&#x4F9B;&#x7684;buf size&#x6765;&quot;&#x622A;&#x65AD;&quot;&#x6D88;&#x606F;. &#x8FD9;&#x4E2A;&#x7528;&#x8D77;&#x6765;&#x5C31;&#x4E0D;&#x5730;&#x9053;.</p>
<p>&#x6240;&#x4EE5;zmq&#x63D0;&#x4F9B;&#x4E86;&#x53E6;&#x5916;&#x4E24;&#x4E2A;API, &#x8FD9;&#x91CC;&#x9762;&#x5C31;&#x6CA1;&#x6709;size, &#x6BCF;&#x6B21;&#x8C03;&#x7528;&#x90FD;&#x662F;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;msg</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">int</span> <span class="token function">zmq_msg_send</span> <span class="token punctuation">(</span><span class="token class-name">zmq_msg_t</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>socket<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token keyword">int</span> <span class="token function">zmq_msg_recv</span> <span class="token punctuation">(</span><span class="token class-name">zmq_msg_t</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>socket<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
</code></pre>
<p>&#x5B9E;&#x9645;&#x4E0A;, &#x5BF9;msg&#x7684;&#x64CD;&#x4F5C;&#x662F;&#x4E00;&#x7CFB;&#x5217;&#x7684;API</p>
<pre class="language-"><code class="lang-c">Initialise a message<span class="token operator">:</span> <span class="token function">zmq_msg_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">zmq_msg_init_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">zmq_msg_init_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
Sending and receiving a message<span class="token operator">:</span> <span class="token function">zmq_msg_send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">zmq_msg_recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
Release a message<span class="token operator">:</span> <span class="token function">zmq_msg_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
Access message content<span class="token operator">:</span> <span class="token function">zmq_msg_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">zmq_msg_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">zmq_msg_more</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
Work with message properties<span class="token operator">:</span> <span class="token function">zmq_msg_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">zmq_msg_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
Message manipulation<span class="token operator">:</span> <span class="token function">zmq_msg_copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">zmq_msg_move</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
</code></pre>
<p>&#x7528;&#x6237;&#x8981;&#x81EA;&#x5DF1;&#x9009;&#x62E9;&#x5408;&#x9002;&#x7684;&quot;&#x7EAF;&#x6570;&#x636E;&quot;&#x7684;&#x8868;&#x73B0;&#x5F62;&#x5F0F;, &#x6BD4;&#x5982;&#x7528;gpb/json&#x6765;&#x5E8F;&#x5217;&#x5316;&#x7B49;&#x7B49;, &#x8FD9;&#x4E2A;zmq&#x4E0D;&#x7BA1;.
&#x4F7F;&#x7528;msg&#x7684;&#x8981;&#x70B9;:</p>
<ul>
<li><p>You create and pass around <code>zmq_msg_t</code> objects, not blocks of data.</p>
</li>
<li><p>To read a message, you use <a href="http://api.zeromq.org/3-2:zmq_msg_init" target="_blank">zmq_msg_init()</a> to create an empty message, and then you pass that to <a href="http://api.zeromq.org/3-2:zmq_msg_recv" target="_blank">zmq_msg_recv()</a>.</p>
</li>
<li><p>To write a message from new data, you use <a href="http://api.zeromq.org/3-2:zmq_msg_init_size" target="_blank">zmq_msg_init_size()</a> to create a message and at the same time allocate a block of data of some size. You then fill that data using <code>memcpy</code>, and pass the message to <a href="http://api.zeromq.org/3-2:zmq_msg_send" target="_blank">zmq_msg_send()</a>.</p>
</li>
<li><p>To release (not destroy) a message, you call <a href="http://api.zeromq.org/3-2:zmq_msg_close" target="_blank">zmq_msg_close()</a>. This drops a reference, and eventually ZeroMQ will destroy the message.</p>
</li>
<li><p>To access the message content, you use <a href="http://api.zeromq.org/3-2:zmq_msg_data" target="_blank">zmq_msg_data()</a>. To know how much data the message contains, use <a href="http://api.zeromq.org/3-2:zmq_msg_size" target="_blank">zmq_msg_size()</a>.</p>
</li>
<li><p>Do not use <a href="http://api.zeromq.org/3-2:zmq_msg_move" target="_blank">zmq_msg_move()</a>, <a href="http://api.zeromq.org/3-2:zmq_msg_copy" target="_blank">zmq_msg_copy()</a>, or <a href="http://api.zeromq.org/3-2:zmq_msg_init_data" target="_blank">zmq_msg_init_data()</a> unless you read the man pages and know precisely why you need these.</p>
</li>
<li><p>After you pass a message to <a href="http://api.zeromq.org/3-2:zmq_msg_send" target="_blank">zmq_msg_send()</a>, &#xD8;MQ will clear the message, i.e., set the size to zero. You cannot send the same message twice, and you cannot access the message data after sending it.
&#x9700;&#x8981;&#x7684;&#x8BDD;, &#x7528;<code>zmq_msg_copy()</code>&#x589E;&#x52A0;&#x5F15;&#x7528;, &#x4F46;&#x5B9E;&#x9645;&#x5E76;&#x4E0D;&#x62F7;&#x8D1D;msg&#x5185;&#x5BB9;. &#x6700;&#x540E;&#x4E00;&#x4E2A;&#x5F15;&#x7528;&#x88AB;send&#x6210;&#x529F;&#x540E;, msg&#x4F1A;&#x88AB;&#x81EA;&#x52A8;&#x9500;&#x6BC1;.</p>
</li>
<li><p>These rules don&#x2019;t apply if you use <a href="http://api.zeromq.org/3-2:zmq_send" target="_blank">zmq_send()</a> and <a href="http://api.zeromq.org/3-2:zmq_recv" target="_blank">zmq_recv()</a>, to which you pass byte arrays, not message structures.</p>
</li>
</ul>
<h4 id="frames"><a name="frames" class="anchor-navigation-ex-anchor" href="#frames"><i class="fa fa-link" aria-hidden="true"></i></a>Frames</h4>
<p>zmq&#x5B9A;&#x4E49;&#x4E86;&#x81EA;&#x5DF1;&#x7684;frame&#x683C;&#x5F0F;. frame&#x662F;msg&#x7684;&#x57FA;&#x672C;&#x627F;&#x8F7D;&#x5355;&#x5143;. &#x4E00;&#x4E2A;msg&#x53EF;&#x4EE5;&#x5305;&#x62EC;&#x591A;&#x4E2A;frame.</p>
<ul>
<li>frame&#x7684;size&#x662F;&#x786E;&#x5B9A;&#x7684;</li>
<li>frame&#x7684;&#x5B9A;&#x4E49;&#x5728;<a href="http://rfc.zeromq.org/spec:15" target="_blank">protocol called ZMTP</a><blockquote>
<p>The ZeroMQ Message Transport Protocol (ZMTP) is a transport layer protocol for exchanging messages between two peers over a connected transport layer such as TCP. This document describes ZMTP/2.0.
ZMTP delimits the TCP stream as &#x2018;frames&#x2019;. A message can consist of multiple frames, for purposes of structuring. A frame consists of a flags field, followed by a length field and a frame body of length octets. The length does not include the flags field, nor itself, so an empty frame has a length of zero.</p>
<ul>
<li>Bit 0 (MORE): <em>More frames to follow</em>. A value of 0 indicates that there are no more frames to follow. A value of 1 indicates that more frames will follow. On messages consisting of a single frame the MORE bit MUST be 0.</li>
<li>Bit 1 (LONG): <em>Long message</em>. A value of 0 indicates that the message length is encoded as a single octet. A value of 1 indicates that the message length is encoded as a 64-bit unsigned integer in network byte order.</li>
<li>Bits 2-7: <em>Reserved</em>. Bits 2-7 are reserved for future use and MUST be zero.</li>
</ul>
</blockquote>
</li>
</ul>
<pre class="language-"><code class="lang-c">The following diagram shows the layout of a final frame with a length of <span class="token number">0</span> to <span class="token number">255</span> octets<span class="token operator">:</span>
            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
 Octet <span class="token number">0</span>    <span class="token operator">|</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token operator">|</span>
            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
 Octet <span class="token number">1</span>    <span class="token operator">|</span> Length          <span class="token operator">|</span>
            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
 Octets <span class="token number">2</span><span class="token operator">+</span>  <span class="token operator">|</span> Body                      Length octets <span class="token operator">|</span>
            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>

The following diagram shows the layout of a final LONG frame<span class="token operator">:</span>
            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
 Octet <span class="token number">0</span>    <span class="token operator">|</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token operator">|</span>
            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
 Octets <span class="token number">1</span><span class="token operator">-</span><span class="token number">8</span> <span class="token operator">|</span> Length                       <span class="token number">8</span> octets   <span class="token operator">|</span>
            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
 Octets <span class="token number">9</span><span class="token operator">+</span>  <span class="token operator">|</span> Body                      Length octets <span class="token operator">|</span>
            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
</code></pre>
<p>&#x6982;&#x5FF5;&#x70B9;:</p>
<ul>
<li>A message can be one or more parts.</li>
<li>These parts are also called &#x201C;frames&#x201D;.</li>
<li>Each part is a <code>zmq_msg_t</code> object.</li>
<li>You send and receive each part separately, in the low-level API.</li>
<li>Higher-level APIs provide wrappers to send entire multipart messages.
&#x4F7F;&#x7528;&#x8981;&#x70B9;:</li>
<li>You may send zero-length messages, e.g., for sending a signal from one thread to another.</li>
<li>ZeroMQ guarantees to deliver all the parts (one or more) for a message, or none of them.</li>
<li>ZeroMQ does not send the message (single or multipart) right away, but at some indeterminate later time. A multipart message must therefore fit in memory.</li>
<li>A message (single or multipart) must fit in memory. If you want to send files of arbitrary sizes, you should break them into pieces and send each piece as separate single-part messages. <em>Using multipart data will not reduce memory consumption.</em></li>
<li>You must call <a href="http://api.zeromq.org/3-2:zmq_msg_close" target="_blank">zmq_msg_close()</a> when finished with a received message, in languages that don&#x2019;t automatically destroy objects when a scope closes. You don&#x2019;t call this method after sending a message.</li>
</ul>
<h4 id="&#x517C;&#x5BB9;&#x6027;"><a name="&#x517C;&#x5BB9;&#x6027;" class="anchor-navigation-ex-anchor" href="#&#x517C;&#x5BB9;&#x6027;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x517C;&#x5BB9;&#x6027;</h4>
<p>PAIR accepts connections from PAIR.
PUB accepts connections from SUB.
SUB accepts connections from PUB.
REQ accepts connections from REP or ROUTER.
REP accepts connections from REQ or DEALER.
DEALER accepts connections from REP, DEALER, or ROUTER.
ROUTER accepts connections from REQ, DEALER, or ROUTER.
PULL accepts connections from PUSH.
PUSH accepts connections from PULL.</p>
<h3 id="io-thread&#x548C;context"><a name="io-thread&#x548C;context" class="anchor-navigation-ex-anchor" href="#io-thread&#x548C;context"><i class="fa fa-link" aria-hidden="true"></i></a>3.2.5. IO thread&#x548C;context</h3>
<p>IO thread&#x4ECE;&#x5C5E;&#x4E8E;context. &#x4E00;&#x4E2A;context&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019;, &#x5C31;&#x9ED8;&#x8BA4;&#x542F;&#x52A8;&#x4E86;&#x4E00;&#x4E2A;IO thread. &#x5176;&#x540E;&#x4ECE;&#x5C5E;&#x4E8E;context&#x521B;&#x5EFA;&#x7684;socket&#x4EEC;, &#x5171;&#x540C;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;IO thread.<br>&#x6709;&#x4E2A;api<code>zmq_ctx_set (context, ZMQ_IO_THREADS, io_threads);</code>&#x53EF;&#x4EE5;&#x66F4;&#x6539;io thread&#x7684;&#x4E2A;&#x6570;.  </p>
<h3 id="zmqpoll&#x51FD;&#x6570;"><a name="zmqpoll&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#zmqpoll&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>3.2.6. zmq_poll()&#x51FD;&#x6570;</h3>
<p>&#x5982;&#x679C;&#x4E00;&#x4E2A;zmq&#x7684;socket&#x6709;&#x591A;&#x4E2A;&#x5BF9;&#x7AEF;, &#x6211;&#x4EEC;&#x60F3;&#x540C;&#x65F6;&#x8BFB;&#x600E;&#x4E48;&#x529E;?<br>&#x4E00;&#x822C;&#x7528;<code>zmq_poll()</code>, &#x6BD4;&#x5982;&#x628A;poll&#x5305;&#x88C5;&#x5728;&#x6846;&#x67B6;&#x91CC;, &#x6846;&#x67B6;&#x5206;&#x53D1;event, &#x5E94;&#x7528;&#x4FA7;&#x4EE3;&#x7801;&#x53EA;&#x8D1F;&#x8D23;react. &#x7528;&#x6237;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;&#x57FA;&#x4E8E;zmq&#x7684;&#x4E8B;&#x4EF6;&#x9A71;&#x52A8;&#x6846;&#x67B6;, zmq&#x4E0D;&#x63D0;&#x4F9B;&#x8FD9;&#x4E2A;&#x6846;&#x67B6;.</p>
<blockquote>
<p>An even better way might be to wrap zmq_poll() in a framework that turns it into a nice event-driven reactor, but it&#x2019;s significantly more work than we want to cover here.</p>
</blockquote>
<h4 id="&#x4E0D;&#x7528;poll"><a name="&#x4E0D;&#x7528;poll" class="anchor-navigation-ex-anchor" href="#&#x4E0D;&#x7528;poll"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4E0D;&#x7528;poll</h4>
<pre class="language-"><code class="lang-go"><span class="token comment">//</span>
<span class="token comment">// Reading from multiple sockets </span>
<span class="token comment">// This version uses a simple recv loop</span>
<span class="token comment">//</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
    <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//  Connect to task ventilator</span>
    receiver<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>PULL<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> receiver<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    receiver<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://localhost:5557&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//  Connect to weather server</span>
    subscriber<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>SUB<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> subscriber<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    subscriber<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://localhost:5556&quot;</span><span class="token punctuation">)</span>
    subscriber<span class="token punctuation">.</span><span class="token function">SetSubscribe</span><span class="token punctuation">(</span><span class="token string">&quot;10001&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//  Process messages from both sockets</span>
    <span class="token comment">//  We prioritize traffic from the task ventilator</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>

        <span class="token comment">// ventilator</span>
        <span class="token keyword">for</span> b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> receiver<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>NOBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span> b <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> <span class="token punctuation">{</span>
            <span class="token comment">// fake process task</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// weather server</span>
        <span class="token keyword">for</span> b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> subscriber<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>NOBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span> b <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> <span class="token punctuation">{</span>
            <span class="token comment">//  process task</span>
            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;found weather =%s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//  No activity, so sleep for 1 msec</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1e6</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;done&quot;</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre>
<p>&#x5728;&#x5FAA;&#x73AF;&#x91CC;&#x975E;&#x963B;&#x585E;&#x8BFB;, &#x6BCF;&#x8F6E;&#x50BB;&#x50BB;&#x7684;sleep 1ms.</p>
<h4 id="&#x4F7F;&#x7528;poll"><a name="&#x4F7F;&#x7528;poll" class="anchor-navigation-ex-anchor" href="#&#x4F7F;&#x7528;poll"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4F7F;&#x7528;poll</h4>
<pre class="language-"><code class="lang-go"><span class="token comment">//</span>
<span class="token comment">// Reading from multiple sockets </span>
<span class="token comment">// This version uses zmq.Poll()</span>
<span class="token comment">//</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//  Connect to task ventilator</span>
    receiver<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>PULL<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> receiver<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    receiver<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://localhost:5557&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//  Connect to weather server</span>
    subscriber<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>SUB<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> subscriber<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    subscriber<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://localhost:5556&quot;</span><span class="token punctuation">)</span>
    subscriber<span class="token punctuation">.</span><span class="token function">SetSubscribe</span><span class="token punctuation">(</span><span class="token string">&quot;10001&quot;</span><span class="token punctuation">)</span>

    pi <span class="token operator">:=</span> zmq<span class="token punctuation">.</span>PollItems<span class="token punctuation">{</span>
        zmq<span class="token punctuation">.</span>PollItem<span class="token punctuation">{</span>Socket<span class="token punctuation">:</span> receiver<span class="token punctuation">,</span> Events<span class="token punctuation">:</span> zmq<span class="token punctuation">.</span>POLLIN<span class="token punctuation">}</span><span class="token punctuation">,</span>
        zmq<span class="token punctuation">.</span>PollItem<span class="token punctuation">{</span>Socket<span class="token punctuation">:</span> subscriber<span class="token punctuation">,</span> Events<span class="token punctuation">:</span> zmq<span class="token punctuation">.</span>POLLIN<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//  Process messages from both sockets</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>

        <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> zmq<span class="token punctuation">.</span><span class="token function">Poll</span><span class="token punctuation">(</span>pi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token keyword">switch</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> pi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>REvents<span class="token operator">&amp;</span>zmq<span class="token punctuation">.</span>POLLIN <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment">//  Process task</span>
            pi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Socket<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// eat the incoming message</span>
        <span class="token keyword">case</span> pi<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>REvents<span class="token operator">&amp;</span>zmq<span class="token punctuation">.</span>POLLIN <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment">//  Process weather update</span>
            pi<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Socket<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// eat the incoming message</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;done&quot;</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre>
<p>&#x6DFB;&#x52A0;poll item, &#x4E0D;&#x7528;&#x50BB;sleep</p>
<h3 id="&#x5206;&#x7247;&#x7684;msg"><a name="&#x5206;&#x7247;&#x7684;msg" class="anchor-navigation-ex-anchor" href="#&#x5206;&#x7247;&#x7684;msg"><i class="fa fa-link" aria-hidden="true"></i></a>3.2.7. &#x5206;&#x7247;&#x7684;msg</h3>
<p>&#x6CA1;&#x4ED4;&#x7EC6;&#x770B;, &#x8BE6;&#x89C1;: <a href="https://zguide.zeromq.org/docs/chapter2/#Multipart-Messages" target="_blank">https://zguide.zeromq.org/docs/chapter2/#Multipart-Messages</a>
&#x53D1;&#x9001;&#x65B9;:</p>
<pre class="language-"><code class="lang-c"><span class="token function">zmq_msg_send</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>message<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> ZMQ_SNDMORE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token function">zmq_msg_send</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>message<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> ZMQ_SNDMORE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token function">zmq_msg_send</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>message<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x63A5;&#x6536;&#x65B9;:</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">zmq_msg_t</span> message<span class="token punctuation">;</span>
    <span class="token function">zmq_msg_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zmq_msg_recv</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>message<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//  Process the message frame</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">zmq_msg_close</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">zmq_msg_more</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token comment">//  Last message frame</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x670D;&#x52A1;&#x53D1;&#x73B0;"><a name="&#x670D;&#x52A1;&#x53D1;&#x73B0;" class="anchor-navigation-ex-anchor" href="#&#x670D;&#x52A1;&#x53D1;&#x73B0;"><i class="fa fa-link" aria-hidden="true"></i></a>3.3. &#x670D;&#x52A1;&#x53D1;&#x73B0;</h2>
<p>&#x670D;&#x52A1;&#x53D1;&#x73B0;&#x89E3;&#x51B3;&#x7684;&#x662F;&#x7F51;&#x7EDC;&#x4E3B;&#x4F53;&#x95F4;&#x5982;&#x4F55;&#x77E5;&#x9053;&#x5BF9;&#x65B9;&#x7684;&#x95EE;&#x9898;.</p>
<p>hard code&#x6216;&#x8005;&#x9759;&#x6001;&#x914D;&#x7F6E;&#x5F0F;&#x7684;&#x90FD;&#x4E0D;&#x7B97;&#x662F;&#x670D;&#x52A1;&#x53D1;&#x73B0;. &#x56E0;&#x4E3A;&#x4F60;&#x5728;&#x5199;&#x9759;&#x6001;&#x914D;&#x7F6E;&#x7684;&#x65F6;&#x5019;, &#x5DF2;&#x7ECF;&#x77E5;&#x9053;&#x4F60;&#x7684;&#x7F51;&#x7EDC;&#x7684;&#x6837;&#x5B50;&#x4E86;.
&#x6BD4;&#x5982;&#x4E0B;&#x9762;&#x9759;&#x6001;&#x914D;&#x7F6E;&#x7684;&#x7F51;&#x7EDC;: &#x5982;&#x679C;&#x7B80;&#x5355;&#x7684;&#x589E;&#x52A0;subscriber&#x662F;&#x7B80;&#x5355;&#x7684;, &#x6BCF;&#x4E2A;subscriber&#x5199;&#x6B7B;<code>192.168.55.210:5556</code>&#x5C31;&#x884C;&#x4E86;.<br><img src="img/golang_zmq_20220911230120.png" alt=""><br>&#x4F46;&#x5982;&#x679C;&#x589E;&#x52A0;publisher&#x5462;? &#x539F;&#x6765;&#x7684;subscriber&#x4E5F;&#x8981;&#x6539;&#x5417;?</p>
<p>&#x7528;&#x4E0B;&#x9762;&#x7684;&#x56FE;&#x6765;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;: &#x589E;&#x52A0;&#x4E2D;&#x95F4;&#x4EBA;. &#x8FD9;&#x662F;&#x5178;&#x578B;&#x7684;<code>M:N</code>&#x5230;<code>M: 1 :N</code>&#x7684;&#x89E3;&#x8026;<br><img src="img/golang_zmq_20220911230148.png" alt="">  </p>
<p>&#x90A3;&#x4E3A;&#x4EC0;&#x4E48;zmq&#x4E0D;&#x9000;&#x51FA;&#x4E00;&#x4E2A;&#x9ED8;&#x8BA4;&#x7684;&#x4E2D;&#x5FC3;&#x5F0F;&#x7684;broker? &#x8BA9;&#x7F51;&#x7EDC;&#x4E00;&#x5F00;&#x59CB;&#x5C31;&#x662F;&#x661F;&#x5F62;&#x7684;&#x4E2D;&#x5FC3;&#x7ED3;&#x6784;?
&#x4F5C;&#x8005;&#x5BF9;broker&#x662F;&#x6301;&#x6709;&#x8C28;&#x614E;&#x7684;&#x6001;&#x5EA6;&#x7684;, &#x4E00;&#x65B9;&#x9762;&#x662F;&#x62C5;&#x5FC3;&#x6027;&#x80FD;, &#x4E00;&#x65B9;&#x9762;&#x62C5;&#x5FC3;&#x62C5;&#x5FC3;&#x6545;&#x969C;</p>
<blockquote>
<p>You might wonder, if all networks eventually get large enough to need intermediaries, why don&#x2019;t we simply have a message broker in place for all applications? For beginners, it&#x2019;s a fair compromise. Just always use a star topology, forget about performance, and things will usually work. However, message brokers are greedy things; in their role as central intermediaries, they become too complex, too stateful, and eventually a problem.</p>
</blockquote>
<p>&#x6700;&#x540E;&#x62BD;&#x8C61;&#x7684;&#x5178;&#x578B;&#x6A21;&#x5F0F;&#x662F;:<br><img src="img/golang_zmq_20220911230211.png" alt="">  </p>
<h2 id="&#x591A;&#x5BF9;&#x591A;&#x7684;client&#x548C;server"><a name="&#x591A;&#x5BF9;&#x591A;&#x7684;client&#x548C;server" class="anchor-navigation-ex-anchor" href="#&#x591A;&#x5BF9;&#x591A;&#x7684;client&#x548C;server"><i class="fa fa-link" aria-hidden="true"></i></a>3.4. &#x591A;&#x5BF9;&#x591A;&#x7684;client&#x548C;server</h2>
<p>&#x6BD4;&#x5982;<br><img src="img/golang_zmq_20220911230230.png" alt=""><br>&#x6BCF;&#x4E2A;client&#x8FDE;&#x63A5;&#x6240;&#x6709;&#x7684;server, servers&#x90FD;&#x63D0;&#x4F9B;&#x540C;&#x4E00;&#x4E2A;&#x670D;&#x52A1;, &#x4EE5;&#x81F3;&#x4E8E;client&#x548C;&#x54EA;&#x4E2A;server&#x8BF7;&#x6C42;, &#x90FD;&#x662F;&#x56DE;&#x4E00;&#x6837;&#x7684;&#x6570;&#x636E;. &#x591A;&#x4E2A;server&#x6269;&#x5C55;&#x4E86;&#x7F51;&#x7EDC;&#x7684;&#x5904;&#x7406;&#x80FD;&#x529B;, &#x4F46;&#x8FD9;&#x6837;&#x8981;&#x6C42;&#x6BCF;&#x4E2A;client&#x90FD;&#x77E5;&#x9053;&#x6240;&#x6709;&#x7684;server.</p>
<p>&#x53EF;&#x4EE5;&#x6F14;&#x5316;&#x4E3A;&#x8FD9;&#x79CD;&#x6A21;&#x5F0F;:<br><img src="img/golang_zmq_20220911230254.png" alt=""><br>&#x4E2D;&#x95F4;&#x4EBA;&#x4F1A;&#x8BB0;&#x4F4F;&#x54EA;&#x4E2A;client&#x6765;&#x7684;req, &#x5F53;&#x67D0;&#x4E2A;server&#x7ED9;&#x51FA;&#x5BF9;&#x8FD9;&#x4E2A;req&#x7684;&#x56DE;&#x590D;&#x7684;&#x65F6;&#x5019;, &#x4E2D;&#x95F4;&#x4EBA;&#x4F1A;&#x627E;&#x5230;&#x4E4B;&#x524D;&#x8BB0;&#x4F4F;&#x7684;client&#x6765;&#x6CBF;&#x8DEF;&#x8FD4;&#x56DE;rep.</p>
<p>zmq&#x628A;&#x4E2D;&#x95F4;&#x8FD9;&#x4E2A;&#x8F6C;&#x53D1;&#x903B;&#x8F91;&#x62BD;&#x8C61;&#x6210;API: <code>int zmq_proxy (const void *frontend, const void *backend, const void *capture)</code></p>
<h2 id="&#x5176;&#x4ED6;&#x6A21;&#x578B;"><a name="&#x5176;&#x4ED6;&#x6A21;&#x578B;" class="anchor-navigation-ex-anchor" href="#&#x5176;&#x4ED6;&#x6A21;&#x578B;"><i class="fa fa-link" aria-hidden="true"></i></a>3.5. &#x5176;&#x4ED6;&#x6A21;&#x578B;</h2>
<p><img src="img/golang_zmq_20220911230319.png" alt=""><br><img src="img/golang_zmq_20220911230350.png" alt="">  </p>
<h2 id="&#x5E76;&#x53D1;&#x652F;&#x6301;"><a name="&#x5E76;&#x53D1;&#x652F;&#x6301;" class="anchor-navigation-ex-anchor" href="#&#x5E76;&#x53D1;&#x652F;&#x6301;"><i class="fa fa-link" aria-hidden="true"></i></a>3.6. &#x5E76;&#x53D1;&#x652F;&#x6301;</h2>
<p>&#x7B80;&#x5355;&#x6765;&#x8BF4;, zmq&#x505A;&#x4E86;&#x4F60;&#x80FD;&#x60F3;&#x5230;&#x7684;&#x6240;&#x6709;&#x5BF9;&#x5E76;&#x53D1;&#x7684;&#x652F;&#x6301;: <code>we don&#x2019;t need mutexes, locks, or any other form of inter-thread communication except messages sent across ZeroMQ sockets</code></p>
<p>&#x4F5C;&#x8005;&#x7684;&#x57FA;&#x672C;&#x601D;&#x60F3;&#x662F;: &#x4E0D;&#x8981;&#x5171;&#x4EAB;&#x4EFB;&#x4F55;&#x4E1C;&#x897F;, stateless&#x5C31;&#x662F;&#x6700;&#x597D;&#x7684;&#x5E76;&#x53D1;&#x6A21;&#x578B; -- &#x56E0;&#x4E3A;&#x4EC0;&#x4E48;&#x90FD;&#x4E0D;&#x9700;&#x8981;&#x4FDD;&#x62A4;</p>
<ul>
<li><p>Isolate data privately within its thread and never share data in multiple threads. The only exception to this are ZeroMQ contexts, which are threadsafe.<br>&#x4E0D;&#x8981;&#x5171;&#x4EAB;&#x6570;&#x636E;...</p>
</li>
<li><p>Stay away from the classic concurrency mechanisms like as mutexes, critical sections, semaphores, etc. These are an anti-pattern in ZeroMQ applications.<br>&#x4E0D;&#x8981;&#x7528;&#x9501;&#x5565;&#x7684;. &#x548C;zmq&#x516B;&#x5B57;&#x4E0D;&#x5408;.</p>
</li>
<li><p>Create one ZeroMQ context at the start of your process, and pass that to all threads that you want to connect via <code>inproc</code> sockets.</p>
</li>
<li><p>Use <em>attached</em> threads to create structure within your application, and connect these to their parent threads using PAIR sockets over <code>inproc</code>. The pattern is: bind parent socket, then create child thread which connects its socket.<br>&#x5728;&#x7EBF;&#x7A0B;&#x95F4;&#x4F7F;&#x7528;inproc socket pair</p>
</li>
<li><p>Use <em>detached</em> threads to simulate independent tasks, with their own contexts. Connect these over <code>tcp</code>. Later you can move these to stand-alone processes without changing the code significantly.</p>
</li>
<li><p>All interaction between threads happens as ZeroMQ messages, which you can define more or less formally.<br>&#x548C;go&#x4E00;&#x6837;, &#x4F7F;&#x7528;&quot;&#x901A;&#x4FE1;&quot;&#x6765;&#x4EE3;&#x66FF;&quot;&#x5171;&#x4EAB;&quot;</p>
</li>
<li><p>Don&#x2019;t share ZeroMQ sockets between threads. ZeroMQ sockets are not threadsafe. Technically it&#x2019;s possible to migrate a socket from one thread to another but it demands skill. The only place where it&#x2019;s remotely sane to share sockets between threads are in language bindings that need to do magic like garbage collection on sockets.<br>&#x867D;&#x7136;context&#x662F;&#x5E76;&#x53D1;&#x5B89;&#x5168;&#x7684;. &#x4F46;socket&#x4E0D;&#x662F;. &#x4E0D;&#x8981;&#x5728;&#x7EBF;&#x7A0B;&#x95F4;&#x5171;&#x4EAB;socket.</p>
<blockquote>
<p>Do not use or close sockets except in the thread that created them.<br>&#x9664;&#x4E86;&#x521B;&#x5EFA;socket&#x7684;&#x7EBF;&#x7A0B;, &#x4E0D;&#x8981;&#x5728;&#x53E6;&#x5916;&#x7684;&#x7EBF;&#x7A0B;&#x4F7F;&#x7528;&#x548C;&#x5173;&#x95ED;socket.</p>
</blockquote>
</li>
</ul>
<h2 id="zmq&#x7684;&#x5E94;&#x7528;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;run&#x5728;&#x7EBF;&#x7A0B;-&#x8FDB;&#x7A0B;-&#x6216;node&#x4E0A;"><a name="zmq&#x7684;&#x5E94;&#x7528;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;run&#x5728;&#x7EBF;&#x7A0B;-&#x8FDB;&#x7A0B;-&#x6216;node&#x4E0A;" class="anchor-navigation-ex-anchor" href="#zmq&#x7684;&#x5E94;&#x7528;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;run&#x5728;&#x7EBF;&#x7A0B;-&#x8FDB;&#x7A0B;-&#x6216;node&#x4E0A;"><i class="fa fa-link" aria-hidden="true"></i></a>3.7. zmq&#x7684;&#x5E94;&#x7528;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;run&#x5728;&#x7EBF;&#x7A0B;, &#x8FDB;&#x7A0B;, &#x6216;node&#x4E0A;.</h2>
<p>&#x901A;&#x8FC7;zmq&#x7684;&#x62BD;&#x8C61;, &#x5E94;&#x7528;&#x4EE3;&#x7801;&#x9762;&#x5BF9;&#x7684;&#x662F;&#x901A;&#x4FE1;&#x7F16;&#x7A0B;, &#x53EF;&#x4EE5;&#x65B9;&#x4FBF;&#x7684;&#x5728;&#x5404;&#x79CD;&#x73AF;&#x5883;&#x4E2D;&#x6269;&#x5C55;.
&#x6BD4;&#x5982;&#x8981;&#x5B9E;&#x73B0;&#x4E0B;&#x9762;&#x7684;&#x6A21;&#x5757;: &#x865A;&#x6846;&#x5185;&#x662F;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;<br><img src="img/golang_zmq_20220911230506.png" alt="">  </p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Multithreaded Hello World server.</span>
<span class="token comment">// Uses Goroutines.  We could also use channels (a native form of </span>
<span class="token comment">// inproc), but I stuck to the example.</span>
<span class="token comment">//</span>
<span class="token comment">// Author:  Brendan Mc.</span>
<span class="token comment">// Requires: http://github.com/alecthomas/gozmq</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
    <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Launch pool of worker threads</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> <span class="token number">5</span><span class="token punctuation">;</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">{</span>
        <span class="token keyword">go</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Prepare our context and sockets</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Socket to talk to clients</span>
    clients<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>ROUTER<span class="token punctuation">)</span> <span class="token comment">//&#x548C;clients&#x8FDE;</span>
    <span class="token keyword">defer</span> clients<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    clients<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://*:5555&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">// Socket to talk to workers</span>
    workers<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>DEALER<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> workers<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    workers<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">&quot;ipc://workers.ipc&quot;</span><span class="token punctuation">)</span> <span class="token comment">//&#x5E94;&#x8BE5;&#x662F;unix socket</span>

    <span class="token comment">// connect work threads to client threads via a queue</span>
    zmq<span class="token punctuation">.</span><span class="token function">Device</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>QUEUE<span class="token punctuation">,</span> clients<span class="token punctuation">,</span> workers<span class="token punctuation">)</span> <span class="token comment">//&#x8FD9;&#x4E2A;&#x540E;&#x9762;&#x8981;&#x770B;&#x4E00;&#x4E0B;</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Socket to talk to dispatcher</span>
    receiver<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>REP<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> receiver<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    receiver<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;ipc://workers.ipc&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token boolean">true</span> <span class="token punctuation">{</span>
        received<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> receiver<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Received request [%s]\n&quot;</span><span class="token punctuation">,</span> received<span class="token punctuation">)</span>

        <span class="token comment">// Do some &apos;work&apos;</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>

        <span class="token comment">// Send reply back to client</span>
        receiver<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x89E3;&#x91CA;</p>
<ul>
<li><p>The server starts a set of worker threads. Each worker thread creates a REP socket and then processes requests on this socket. Worker threads are just like single-threaded servers. The only differences are the transport (<code>inproc</code> instead of <code>tcp</code>), and the bind-connect direction.</p>
</li>
<li><p>The server creates a ROUTER socket to talk to clients and binds this to its external interface (over <code>tcp</code>).</p>
</li>
<li><p>The server creates a DEALER socket to talk to the workers and binds this to its internal interface (over <code>inproc</code>).</p>
</li>
<li><p>The server starts a proxy that connects the two sockets. The proxy pulls incoming requests fairly from all clients, and distributes those out to workers. It also routes replies back to their origin.</p>
</li>
</ul>
<h2 id="pub&#x5230;&#x5DF2;&#x77E5;&#x6570;&#x91CF;&#x7684;subscriber"><a name="pub&#x5230;&#x5DF2;&#x77E5;&#x6570;&#x91CF;&#x7684;subscriber" class="anchor-navigation-ex-anchor" href="#pub&#x5230;&#x5DF2;&#x77E5;&#x6570;&#x91CF;&#x7684;subscriber"><i class="fa fa-link" aria-hidden="true"></i></a>3.8. pub&#x5230;&#x5DF2;&#x77E5;&#x6570;&#x91CF;&#x7684;subscriber</h2>
<p><img src="img/golang_zmq_20220911233342.png" alt=""><br>&#x5DF2;&#x77E5;subscriber&#x6570;&#x91CF;, publisher&#x901A;&#x8FC7;REP&#x7C7B;&#x578B;&#x7684;socket&#x7B49;&#x5F85;&#x6240;&#x6709;&#x8BA2;&#x9605;&#x8005;&#x8FDE;&#x4E0A;&#x6765;(1,2&#x6B65;), &#x7136;&#x540E;&#x53D1;&#x6D88;&#x606F;(&#x7B2C;3&#x6B65;)<br>&#x53D1;&#x5E03;&#x8005;&#x4EE3;&#x7801;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Synchronized publisher</span>
<span class="token comment">//</span>
<span class="token comment">// Author:  Brendan Mc.</span>
<span class="token comment">// Requires: http://github.com/alecthomas/gozmq</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> subsExpected <span class="token operator">=</span> <span class="token number">10</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Socket to talk to clients</span>
    publisher<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>PUB<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> publisher<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    publisher<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://*:5561&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">// Socket to receive signals</span>
    syncservice<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>REP<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> syncservice<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    syncservice<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://*:5562&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">// Get synchronization from subscribers</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> subsExpected<span class="token punctuation">;</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">{</span>
        syncservice<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        syncservice<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> update_nbr <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> update_nbr <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> update_nbr <span class="token operator">=</span> update_nbr <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">{</span>
        publisher<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;Rhubarb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    publisher<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;END&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8BA2;&#x9605;&#x8005;&#x4EE3;&#x7801;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Synchronized subscriber</span>
<span class="token comment">//</span>
<span class="token comment">// Author: Aleksandar Janicijevic</span>
<span class="token comment">// Requires: http://github.com/alecthomas/gozmq</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
    <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    subscriber<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>SUB<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> subscriber<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    subscriber<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://localhost:5561&quot;</span><span class="token punctuation">)</span>
    subscriber<span class="token punctuation">.</span><span class="token function">SetSubscribe</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//  0MQ is so fast, we need to wait a while...</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>

    <span class="token comment">//  Second, synchronize with publisher</span>
    syncclient<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>REQ<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> syncclient<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    syncclient<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://localhost:5562&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//  - send a synchronization request</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Send synchronization request&quot;</span><span class="token punctuation">)</span>
    syncclient<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Wait for synchronization reply&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//  - wait for synchronization reply</span>
    syncclient<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Get updates&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//  Third, get our updates and report how many we got</span>
    update_nbr <span class="token operator">:=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        reply<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> subscriber<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token function">string</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;END&quot;</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        update_nbr<span class="token operator">++</span>
    <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Received %d updates\n&quot;</span><span class="token punctuation">,</span> update_nbr<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x7528;shell&#x8D77;10&#x4E2A;&#x8BA2;&#x9605;&#x8005;&#x8FDB;&#x7A0B;, &#x7136;&#x540E;&#x518D;&#x8D77;&#x53D1;&#x5E03;&#x8005;&#x8FDB;&#x7A0B;.</p>
<pre class="language-"><code class="lang-sh"><span class="token builtin class-name">echo</span> <span class="token string">&quot;Starting subscribers...&quot;</span>
<span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>a<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> a<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> a<span class="token operator">++</span><span class="token punctuation">))</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    syncsub <span class="token operator">&amp;</span>
<span class="token keyword">done</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Starting publisher...&quot;</span>
syncpub
</code></pre>
<p>&#x7ED3;&#x679C;</p>
<pre class="language-"><code>Starting subscribers...
Starting publisher...
Received 1000000 updates
Received 1000000 updates
...
Received 1000000 updates
Received 1000000 updates
</code></pre><h2 id="&#x96F6;&#x62F7;&#x8D1D;"><a name="&#x96F6;&#x62F7;&#x8D1D;" class="anchor-navigation-ex-anchor" href="#&#x96F6;&#x62F7;&#x8D1D;"><i class="fa fa-link" aria-hidden="true"></i></a>3.9. &#x96F6;&#x62F7;&#x8D1D;</h2>
<p>&#x8FD9;&#x91CC;&#x7684;&#x62F7;&#x8D1D;&#x662F;&#x6307;&#x5E94;&#x7528;&#x5C42;&#x7684;&#x53D1;&#x9001;buffer&#x5230;zmq&#x7684;socket&#x4E4B;&#x95F4;&#x7684;&#x62F7;&#x8D1D;. &#x96F6;&#x62F7;&#x8D1D;&#x6307;&#x53D1;&#x9001;&#x7684;&#x65F6;&#x5019;, &#x5E94;&#x7528;&#x5C42;&#x7684;buffer&#x76F4;&#x63A5;&#x7528;&#x4E8E;zmq&#x7684;&#x53D1;&#x9001;, &#x800C;&#x4E0D;&#x662F;&#x5148;&#x62F7;&#x8D1D;&#x5230;zmq&#x7684;buffer, &#x518D;&#x53D1;&#x9001;.</p>
<blockquote>
<p>To do zero-copy, you use zmq_msg_init_data() to create a message that refers to a block of data already allocated with malloc() or some other allocator, and then you pass that to zmq_msg_send(). When you create the message, you also pass a function that ZeroMQ will call to free the block of data, when it has finished sending the message. This is the simplest example, assuming buffer is a block of 1,000 bytes allocated on the heap:</p>
</blockquote>
<p>&#x4EE3;&#x7801;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">void</span> <span class="token function">my_free</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>hint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">free</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//  Send message from buffer, which we allocate and ZeroMQ will free for us</span>
<span class="token class-name">zmq_msg_t</span> message<span class="token punctuation">;</span>
<span class="token function">zmq_msg_init_data</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>message<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> my_free<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">zmq_msg_send</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>message<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<blockquote>
<p>Note that you don&#x2019;t call zmq_msg_close() after sending a message&#x2013;libzmq will do this automatically when it&#x2019;s actually done sending the message.</p>
</blockquote>
<h2 id="pub-sub&#x5B9E;&#x9645;&#x4E0A;&#x662F;msg-filter"><a name="pub-sub&#x5B9E;&#x9645;&#x4E0A;&#x662F;msg-filter" class="anchor-navigation-ex-anchor" href="#pub-sub&#x5B9E;&#x9645;&#x4E0A;&#x662F;msg-filter"><i class="fa fa-link" aria-hidden="true"></i></a>3.10. pub-sub&#x5B9E;&#x9645;&#x4E0A;&#x662F;msg filter</h2>
<p>&#x8BA2;&#x9605;&#x7CFB;&#x7EDF;&#x5B9E;&#x9645;&#x4E0A;&#x505A;&#x7684;&#x662F;string&#x7684;prefix match: &#x5728;&#x6570;&#x636E;&#x91CC;&#x641C;&#x7D22;prefix, &#x5339;&#x914D;&#x5230;&#x4E86;&#x5C31;&#x662F;&#x547D;&#x4E2D;&#x8BA2;&#x9605;. &#x8BA2;&#x9605;&#x7684;filter&#x53D1;&#x751F;&#x5728;&#x53D1;&#x9001;&#x4FA7;.<br>&#x4F46;&#x95EE;&#x9898;&#x662F;, &#x6BD4;&#x5982;prefix&#x662F;xyz, &#x5982;&#x679C;&quot;&#x7EAF;&#x6570;&#x636E;&quot;&#x79CD;&#x4E5F;&#x6709;xyz&#x600E;&#x4E48;&#x529E;?
-- &#x7528;zmq&#x7684;key&#x548C;data&#x5206;&#x79BB;<br><img src="img/golang_zmq_20220911233722.png" alt="">  </p>
<p>&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;prefix&#x7684;&#x5339;&#x914D;&#x4F1A;&#x5728;msg&#x5185;&#x641C;&#x7D22;, &#x4F46;&#x4E0D;&#x4F1A;&#x8DE8;frame. --&#x90A3;&#x4E48;&#x7B2C;&#x4E00;&#x4E2A;frame&#x6765;&#x53D1;key, &#x540E;&#x9762;&#x7684;frame&#x53D1;data&#x5C31;&#x53EF;&#x4EE5;&#x4E86;. &#x8FD9;&#x6837;prefix&#x53EA;&#x4F1A;&#x5728;&#x7B2C;&#x4E00;&#x4E2A;frame&#x79CD;&#x5339;&#x914D;<br>&#x53D1;&#x5E03;&#x65B9;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">//</span>
<span class="token comment">//  Pubsub envelope publisher</span>
<span class="token comment">//</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
    <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    publisher<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>PUB<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> publisher<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    publisher<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://*:5563&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        publisher<span class="token punctuation">.</span><span class="token function">SendMultipart</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;We don&apos;t want to see this&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        publisher<span class="token punctuation">.</span><span class="token function">SendMultipart</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;We would like to see this&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8BA2;&#x9605;&#x65B9;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">//</span>
<span class="token comment">//  Pubsub envelope subscriber</span>
<span class="token comment">//</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    subscriber<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>SUB<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> subscriber<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    subscriber<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://localhost:5563&quot;</span><span class="token punctuation">)</span>
    subscriber<span class="token punctuation">.</span><span class="token function">SetSubscribe</span><span class="token punctuation">(</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        address<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> subscriber<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        content<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> subscriber<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;[&quot;</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;] &quot;</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5982;&#x679C;&#x6B64;&#x65F6;&#x52A0;&#x65B0;&#x9700;&#x6C42;: &#x589E;&#x52A0;&#x591A;&#x4E2A;&#x53D1;&#x5E03;&#x8005;, &#x90A3;&#x4E48;&#x53EF;&#x4EE5;&#x8BBE;&#x8BA1;&#x4EA4;&#x4E92;&#x683C;&#x5F0F;&#x4E3A;:<br><img src="img/golang_zmq_20220911233913.png" alt="">  </p>
<h2 id="&#x9AD8;&#x6C34;&#x4F4D;"><a name="&#x9AD8;&#x6C34;&#x4F4D;" class="anchor-navigation-ex-anchor" href="#&#x9AD8;&#x6C34;&#x4F4D;"><i class="fa fa-link" aria-hidden="true"></i></a>3.11. &#x9AD8;&#x6C34;&#x4F4D;</h2>
<p>&#x4F5C;&#x8005;&#x5BF9;&#x4E8E;flow control&#x6709;&#x7ECF;&#x5178;&#x7684;&#x63CF;&#x8FF0;, &#x8BE6;&#x89C1;: <a href="https://zguide.zeromq.org/docs/chapter2/#High-Water-Marks" target="_blank">https://zguide.zeromq.org/docs/chapter2/#High-Water-Marks</a><br>&#x4F5C;&#x8005;&#x8BA4;&#x4E3A;&#x9AD8;&#x6C34;&#x7EBF;&#x540E;, &#x5411;app&#x53D1;&#x9001;&#x53CD;&#x538B;&quot;stop&quot;&#x662F;&#x4E0D;&#x597D;&#x7684;. &#x5982;&#x679C;A&#x9AD8;&#x9891;&#x7387;&#x7ED9;B&#x53D1;, B&#x7531;&#x4E8E;gc&#x6216;&#x8005;CPU load&#x9AD8;&#x5904;&#x7406;&#x4E0D;&#x4E86;, &#x6D88;&#x606F;&#x4F1A;&#x5728;&#x8FD9;&#x4E2A;&#x901A;&#x4FE1;&#x7CFB;&#x7EDF;&#x4E0A;&#x5806;&#x79EF;, A&#x7684;&#x5E94;&#x7528;&#x4FA7;&#x4E5F;&#x4F1A;&#x6709;&#x6D88;&#x606F;&#x5806;&#x79EF;.</p>
<blockquote>
<p>ZeroMQ uses the concept of HWM (high-water mark) to define the capacity of its internal pipes. Each connection out of a socket or into a socket has its own pipe, and HWM for sending, and/or receiving, depending on the socket type. Some sockets (PUB, PUSH) only have send buffers. Some (SUB, PULL, REQ, REP) only have receive buffers. Some (DEALER, ROUTER, PAIR) have both send and receive buffers.<br>In ZeroMQ v3.x, it&#x2019;s set to 1,000 by default<br>zmq&#x5185;&#x90E8;&#x4E5F;&#x4F7F;&#x7528;&#x9AD8;&#x6C34;&#x7EBF;&#x5B9A;&#x4E49;buffer&#x7684;&#x5BB9;&#x91CF;. &#x9ED8;&#x8BA4;&#x662F;10000&#x4E2A;msg.</p>
<p>When your socket reaches its HWM, it will either block or drop data depending on the socket type. PUB and ROUTER sockets will drop data if they reach their HWM, while other socket types will block. Over the inproc transport, the sender and receiver share the same buffers, so the real HWM is the sum of the HWM set by both sides.<br>&#x5230;&#x8FBE;&#x9AD8;&#x6C34;&#x7EBF;&#x540E;, &#x4E0D;&#x540C;&#x7684;socket type&#x7684;&#x7B56;&#x7565;&#x4E0D;&#x540C;: PUB&#x548C;ROUTER&#x7C7B;&#x578B;&#x7684;&#x662F;&#x4E22;&#x5F03;; &#x800C;&#x5176;&#x4ED6;&#x7C7B;&#x578B;&#x662F;&#x963B;&#x585E;.</p>
</blockquote>
<h2 id="&#x4E22;&#x5305;&#x600E;&#x4E48;&#x5B9A;&#x4F4D;"><a name="&#x4E22;&#x5305;&#x600E;&#x4E48;&#x5B9A;&#x4F4D;" class="anchor-navigation-ex-anchor" href="#&#x4E22;&#x5305;&#x600E;&#x4E48;&#x5B9A;&#x4F4D;"><i class="fa fa-link" aria-hidden="true"></i></a>3.12. &#x4E22;&#x5305;&#x600E;&#x4E48;&#x5B9A;&#x4F4D;?</h2>
<p>&#x89C1;&#x8FD9;&#x91CC;: <a href="https://zguide.zeromq.org/docs/chapter2/#Missing-Message-Problem-Solver" target="_blank">https://zguide.zeromq.org/docs/chapter2/#Missing-Message-Problem-Solver</a><br>&#x8981;&#x70B9;:</p>
<ul>
<li><p>On SUB sockets, set a subscription using <tt style="box-sizing: inherit;"><a href="http://api.zeromq.org/3-2:zmq_setsockopt" target="_blank">zmq_setsockopt()</a><code>ZMQ_SUBSCRIBE</code>, or you won&#x2019;t get messages. Because you subscribe to messages by prefix, if you subscribe to &quot;&#x201D; (an empty subscription), you will get everything.</tt></p>
</li>
<li><p>If you start the SUB socket (i.e., establish a connection to a PUB socket) <em>after</em> the PUB socket has started sending out data, you will lose whatever it published before the connection was made. If this is a problem, set up your architecture so the SUB socket starts first, then the PUB socket starts publishing.</p>
</li>
<li><p>Even if you synchronize a SUB and PUB socket, you may still lose messages. It&#x2019;s due to the fact that internal queues aren&#x2019;t created until a connection is actually created. If you can switch the bind/connect direction so the SUB socket binds, and the PUB socket connects, you may find it works more as you&#x2019;d expect.</p>
</li>
<li><p>If you&#x2019;re using REP and REQ sockets, and you&#x2019;re not sticking to the synchronous send/recv/send/recv order, ZeroMQ will report errors, which you might ignore. Then, it would look like you&#x2019;re losing messages. If you use REQ or REP, stick to the send/recv order, and always, in real code, check for errors on ZeroMQ calls.</p>
</li>
<li><p>If you&#x2019;re using PUSH sockets, you&#x2019;ll find that the first PULL socket to connect will grab an unfair share of messages. The accurate rotation of messages only happens when all PULL sockets are successfully connected, which can take some milliseconds. As an alternative to PUSH/PULL, for lower data rates, consider using ROUTER/DEALER and the load balancing pattern.</p>
</li>
<li><p>If you&#x2019;re sharing sockets across threads, don&#x2019;t. It will lead to random weirdness, and crashes.</p>
</li>
<li><p>If you&#x2019;re using <code>inproc</code>, make sure both sockets are in the same context. Otherwise the connecting side will in fact fail. Also, bind first, then connect. <code>inproc</code> is not a disconnected transport like <code>tcp</code>.</p>
</li>
<li><p>If you&#x2019;re using ROUTER sockets, it&#x2019;s remarkably easy to lose messages by accident, by sending malformed identity frames (or forgetting to send an identity frame). In general setting the <code>ZMQ_ROUTER_MANDATORY</code> option on ROUTER sockets is a good idea, but do also check the return code on every send call.</p>
</li>
<li><p>Lastly, if you really can&#x2019;t figure out what&#x2019;s going wrong, make a <em>minimal</em> test case that reproduces the problem, and ask for help from the ZeroMQ community.</p>
</li>
</ul>
<h1 id="&#x6D88;&#x606F;&#x4EA4;&#x4E92;&#x6A21;&#x5F0F;"><a name="&#x6D88;&#x606F;&#x4EA4;&#x4E92;&#x6A21;&#x5F0F;" class="anchor-navigation-ex-anchor" href="#&#x6D88;&#x606F;&#x4EA4;&#x4E92;&#x6A21;&#x5F0F;"><i class="fa fa-link" aria-hidden="true"></i></a>4. &#x6D88;&#x606F;&#x4EA4;&#x4E92;&#x6A21;&#x5F0F;</h1>
<p><a href="https://zguide.zeromq.org/docs/chapter1/" target="_blank">zmq&#x6587;&#x6863;&#x4E2D;</a>&#x6709;&#x8BE6;&#x7EC6;&#x89E3;&#x91CA;</p>
<p>&#x6838;&#x5FC3;&#x7684;&#x4EA4;&#x4E92;&#x6A21;&#x5F0F;&#x6709;4&#x79CD;:</p>
<ul>
<li><p><strong>Request-reply</strong>, which connects a set of clients to a set of services. This is a remote procedure call and task distribution pattern.
rpc&#x6216;&#x901A;&#x5E38;&#x7684;client server</p>
</li>
<li><p><strong>Pub-sub</strong>, which connects a set of publishers to a set of subscribers. This is a data distribution pattern.
&#x8BA2;&#x9605;-&#x53D1;&#x5E03;</p>
</li>
<li><p><strong>Pipeline</strong>, which connects nodes in a fan-out/fan-in pattern that can have multiple steps and loops. This is a parallel task distribution and collection pattern.
&#x8FD9;&#x5C31;&#x662F;&#x4F8B;&#x5B50;push-pull</p>
</li>
<li><p><strong>Exclusive pair</strong>, which connects two sockets exclusively. This is a pattern for connecting two threads in a process, not to be confused with &#x201C;normal&#x201D; pairs of sockets.
&#x7EBF;&#x7A0B;&#x95F4;&#x7684;socket&#x5BF9;.</p>
</li>
</ul>
<p>socket&#x7C7B;&#x578B;&#x914D;&#x5BF9;:</p>
<ul>
<li>PUB and SUB</li>
<li>REQ and REP</li>
<li>REQ and ROUTER (take care, REQ inserts an extra null frame)</li>
<li>DEALER and REP (take care, REP assumes a null frame)</li>
<li>DEALER and ROUTER</li>
<li>DEALER and DEALER</li>
<li>ROUTER and ROUTER</li>
<li>PUSH and PULL</li>
<li>PAIR and PAIR</li>
</ul>
<h2 id="pair&#x7C7B;&#x578B;"><a name="pair&#x7C7B;&#x578B;" class="anchor-navigation-ex-anchor" href="#pair&#x7C7B;&#x578B;"><i class="fa fa-link" aria-hidden="true"></i></a>4.1. PAIR&#x7C7B;&#x578B;</h2>
<p>&#x5BF9;&#x4E8E;&#x7EBF;&#x7A0B;&#x95F4;&#x7684;&quot;&#x5171;&#x4EAB;&quot;, zmq&#x7684;&#x7B56;&#x7565;&#x662F;&#x4E0D;&#x8981;&#x7528;&#x9501;&#x5565;&#x7684;, &#x7528;zmq&#x7684;&#x901A;&#x4FE1;&#x673A;&#x5236;.
use PAIR sockets over the inproc transport</p>
<p>&#x6BD4;&#x5982;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x6A21;&#x578B;:<br><img src="img/golang_zmq_20220911234218.png" alt="">  </p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Multithreaded relay.</span>
<span class="token comment">// Uses Goroutines.  We could also use channels (a native form of </span>
<span class="token comment">// inproc), but I stuck to the example.</span>
<span class="token comment">//</span>
<span class="token comment">// Author:  Brendan Mc.</span>
<span class="token comment">// Requires: http://github.com/alecthomas/gozmq</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Prepare our context and sockets</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Bind inproc socket before starting step2</span>
    receiver<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>PAIR<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> receiver<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    receiver<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">&quot;ipc://step3.ipc&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">go</span> <span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Wait for signal</span>
    receiver<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Test successful!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Connect to step2 and tell it we&apos;re ready</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    xmitter<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>PAIR<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> xmitter<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    xmitter<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;ipc://step2.ipc&quot;</span><span class="token punctuation">)</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Step 1 ready, signaling step 2&quot;</span><span class="token punctuation">)</span>

    xmitter<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;READY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Bind inproc before starting step 1</span>
    receiver<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>PAIR<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> receiver<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    receiver<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">&quot;ipc://step2.ipc&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">go</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// wait for signal and pass it on</span>
    receiver<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">// Connect to step3 and tell it we&apos;re ready</span>
    xmitter<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>PAIR<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> xmitter<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    xmitter<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;ipc://step3.ipc&quot;</span><span class="token punctuation">)</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Step 2 ready, singaling step 3&quot;</span><span class="token punctuation">)</span>

    xmitter<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;READY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x7684;go&#x7684;&#x4F8B;&#x5B50;, &#x7528;&#x7684;&#x662F;ipc&#x7684;transport&#x7C7B;&#x578B;, &#x800C;&#x5B9E;&#x9645;&#x4E0A;, &#x8FD9;&#x91CC;&#x8981;&#x8868;&#x8FBE;&#x7684;&#x662F;inproc&#x7684;transport&#x7C7B;&#x578B;, &#x4F3C;&#x4E4E;&#x8FD9;&#x4E2A;&#x6587;&#x6863;&#x7684;&#x5F53;&#x65F6;&#x8FD8;&#x4E0D;&#x652F;&#x6301;go&#x7684;inproc transport?
&#x4E0B;&#x9762;&#x662F;c&#x7248;&#x672C;:</p>
<pre class="language-"><code class="lang-c"><span class="token comment">//  Multithreaded relay</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;zhelpers.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">step1</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//  Connect to step2 and tell it we&apos;re ready</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>xmitter <span class="token operator">=</span> <span class="token function">zmq_socket</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> ZMQ_PAIR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zmq_connect</span> <span class="token punctuation">(</span>xmitter<span class="token punctuation">,</span> <span class="token string">&quot;inproc://step2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">&quot;Step 1 ready, signaling step 2\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">s_send</span> <span class="token punctuation">(</span>xmitter<span class="token punctuation">,</span> <span class="token string">&quot;READY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zmq_close</span> <span class="token punctuation">(</span>xmitter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">step2</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//  Bind inproc socket before starting step1</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>receiver <span class="token operator">=</span> <span class="token function">zmq_socket</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> ZMQ_PAIR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zmq_bind</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> <span class="token string">&quot;inproc://step2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">pthread_t</span> thread<span class="token punctuation">;</span>
    <span class="token function">pthread_create</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> step1<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//  Wait for signal and pass it on</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>string <span class="token operator">=</span> <span class="token function">s_recv</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zmq_close</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//  Connect to step3 and tell it we&apos;re ready</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>xmitter <span class="token operator">=</span> <span class="token function">zmq_socket</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> ZMQ_PAIR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zmq_connect</span> <span class="token punctuation">(</span>xmitter<span class="token punctuation">,</span> <span class="token string">&quot;inproc://step3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">&quot;Step 2 ready, signaling step 3\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">s_send</span> <span class="token punctuation">(</span>xmitter<span class="token punctuation">,</span> <span class="token string">&quot;READY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zmq_close</span> <span class="token punctuation">(</span>xmitter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>context <span class="token operator">=</span> <span class="token function">zmq_ctx_new</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//  Bind inproc socket before starting step2</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>receiver <span class="token operator">=</span> <span class="token function">zmq_socket</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> ZMQ_PAIR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zmq_bind</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> <span class="token string">&quot;inproc://step3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">pthread_t</span> thread<span class="token punctuation">;</span>
    <span class="token function">pthread_create</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> step2<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//  Wait for signal</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>string <span class="token operator">=</span> <span class="token function">s_recv</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zmq_close</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">&quot;Test successful!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zmq_ctx_destroy</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6CE8;&#x610F;&#x7528;inproc&#x7C7B;&#x578B;&#x7684;transport&#x7684;&#x4E3B;&#x8981;&#x573A;&#x666F;&#x662F;&#x4F4E;&#x5EF6;&#x8FDF;, &#x9AD8;&#x6027;&#x80FD;. &#x4F46;&#x8FD9;&#x4E2A;&#x7C7B;&#x578B;&#x7684;transport&#x6269;&#x5C55;&#x6027;&#x4E0D;&#x597D;. &#x5982;&#x679C;&#x662F;&#x7528;tcp&#x6216;&#x8005;&#x662F;ipc, &#x591A;&#x7EBF;&#x7A0B;&#x7684;&#x6A21;&#x578B;&#x53EF;&#x4EE5;&#x5F88;&#x8F7B;&#x6613;&#x7684;breakdown&#x5230;&#x591A;&#x8FDB;&#x7A0B;.</p>
<h3 id="&#x4E3A;&#x793E;&#x4E48;&#x8981;&#x7528;pair"><a name="&#x4E3A;&#x793E;&#x4E48;&#x8981;&#x7528;pair" class="anchor-navigation-ex-anchor" href="#&#x4E3A;&#x793E;&#x4E48;&#x8981;&#x7528;pair"><i class="fa fa-link" aria-hidden="true"></i></a>4.1.1. &#x4E3A;&#x793E;&#x4E48;&#x8981;&#x7528;pair</h3>
<ul>
<li><p>You can use PUSH for the sender and PULL for the receiver. This looks simple and will work, but remember that PUSH will distribute messages to all available receivers. If you by accident start two receivers (e.g., you already have one running and you start a second), you&#x2019;ll &#x201C;lose&#x201D; half of your signals. PAIR has the advantage of refusing more than one connection; the pair is <em>exclusive</em>.</p>
</li>
<li><p>You can use DEALER for the sender and ROUTER for the receiver. ROUTER, however, wraps your message in an &#x201C;envelope&#x201D;, meaning your zero-size signal turns into a multipart message. If you don&#x2019;t care about the data and treat anything as a valid signal, and if you don&#x2019;t read more than once from the socket, that won&#x2019;t matter. If, however, you decide to send real data, you will suddenly find ROUTER providing you with &#x201C;wrong&#x201D; messages. DEALER also distributes outgoing messages, giving the same risk as PUSH.</p>
</li>
<li><p>You can use PUB for the sender and SUB for the receiver. This will correctly deliver your messages exactly as you sent them and PUB does not distribute as PUSH or DEALER do. However, you need to configure the subscriber with an empty subscription, which is annoying.</p>
</li>
</ul>
<h2 id="req-rep"><a name="req-rep" class="anchor-navigation-ex-anchor" href="#req-rep"><i class="fa fa-link" aria-hidden="true"></i></a>4.2. req-rep</h2>
<p>&#x5178;&#x578B;&#x7684;rpc&#x6A21;&#x5F0F;&#x6216;&#x6700;&#x5E38;&#x7528;&#x7684;client-server&#x6A21;&#x5F0F;, &#x540C;&#x6B65;&#x7684;. &#x6309;&#x4F5C;&#x8005;&#x7684;&#x8BF4;&#x6CD5;&#x662F;, lock-step:<br><img src="img/golang_zmq_20220911234350.png" alt=""><br>&#x4ECE;&#x793A;&#x4F8B;&#x4EE3;&#x7801;&#x6765;&#x770B;</p>
<h3 id="server&#x7AEF;"><a name="server&#x7AEF;" class="anchor-navigation-ex-anchor" href="#server&#x7AEF;"><i class="fa fa-link" aria-hidden="true"></i></a>4.2.1. server&#x7AEF;</h3>
<pre class="language-"><code class="lang-go"><span class="token comment">//</span>
<span class="token comment">// Hello World Zeromq server</span>
<span class="token comment">//</span>
<span class="token comment">// Author: Aaron Raddon   github.com/araddon</span>
<span class="token comment">// Requires: http://github.com/alecthomas/gozmq</span>
<span class="token comment">//</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
    <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    socket<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>REP<span class="token punctuation">)</span> <span class="token comment">//REP&#x7C7B;&#x578B;, server&#x4FA7;</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> socket<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    socket<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://*:5555&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">// Wait for messages</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        msg<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> socket<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Received &quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">// do some fake &quot;work&quot;</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>

        <span class="token comment">// send reply back to client</span>
        reply <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;World&quot;</span><span class="token punctuation">)</span>
        socket<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4ECE;server&#x7684;app&#x89D2;&#x5EA6;&#x770B;:</p>
<ul>
<li>server&#x53EA;&quot;&#x76D1;&#x542C;&quot;<code>tcp://*:5555</code>&#x7684;&#x6570;&#x636E;</li>
<li>zmq&#x5BF9;app&#x5C4F;&#x853D;&#x4E86;listen, accept&#x8FC7;&#x7A0B;, app&#x770B;&#x4E0D;&#x5230;&#x6570;&#x636E;&#x901A;&#x9053;&#x7684;socket.</li>
<li>&#x90A3;&#x4E48;&#x5728;app&#x770B;&#x6765;, &#x5B83;&#x4E0D;&#x77E5;&#x9053;&#x5BF9;&#x7AEF;client&#x662F;&#x8C01;. &#x5F88;&#x53EF;&#x80FD;&#x8FD9;&#x6B21;recv&#x7684;&#x6570;&#x636E;, &#x548C;&#x4E0B;&#x6B21;recv&#x7684;&#x6570;&#x636E;, &#x90FD;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;client&#x53D1;&#x8FC7;&#x6765;&#x7684;.<br>-- &#x6240;&#x4EE5;&#x4F5C;&#x8005;&#x63D0;&#x5230;lockstep: &#x672C;&#x6B21;recv&#x7684;&#x4E1C;&#x897F;&#x8981;&#x9A6C;&#x4E0A;&#x5904;&#x7406;, &#x9A6C;&#x4E0A;send, &#x624D;&#x80FD;&#x4FDD;&#x8BC1;&#x4E24;&#x6B21;&#x64CD;&#x4F5C;&#x662F;&#x5BF9;&#x4E00;&#x4E2A;client.</li>
</ul>
<p>&#x8FD9;&#x91CC;zmq&#x7684;&#x793A;&#x4F8B;&#x4EE3;&#x7801;&#x662F;&#x5178;&#x578B;&#x7684;&#x540C;&#x6B65;&#x7ED3;&#x6784;.&#x6216;&#x8005;&#x8BF4;&#x662F;&#x6846;&#x67B6;&#x4EE3;&#x7801;&#x548C;app&#x4EE3;&#x7801;&#x6DF7;&#x5728;&#x4E00;&#x8D77;&#x7684;.<br>&#x4F5C;&#x8005;&#x4E13;&#x95E8;&#x63D0;&#x5230;:</p>
<blockquote>
<p>Now this looks too simple to be realistic, but ZeroMQ sockets have, as we already learned, superpowers. You could throw thousands of clients at this server, all at once, and it would continue to work happily and quickly. For fun, try starting the client and then starting the server, see how it all still works, then think for a second what this means.</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x770B;&#x8D77;&#x6765;&#x7B80;&#x5355;&#x7684;server&#x4EE3;&#x7801;, &#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x652F;&#x6301;&#x4E0A;&#x5343;&#x4E2A;client&#x53D1;&#x8D77;&#x8BF7;&#x6C42;; &#x5373;&#x4F7F;&#x5148;&#x542F;&#x52A8;client, &#x518D;&#x542F;&#x52A8;server, &#x8FD8;&#x80FD;&#x6B63;&#x5E38;&#x5DE5;&#x4F5C;. -- &#x4F3C;&#x4E4E;&#x6697;&#x793A;&#x4E86;zmq&#x4E3A;client&#x4FA7;&#x63D0;&#x4F9B;&#x7684;lib&#x5E93;&#x6709;&#x7F13;&#x5B58;msg&#x529F;&#x80FD;.</p>
<h3 id="client&#x7AEF;"><a name="client&#x7AEF;" class="anchor-navigation-ex-anchor" href="#client&#x7AEF;"><i class="fa fa-link" aria-hidden="true"></i></a>4.2.2. client&#x7AEF;</h3>
<pre class="language-"><code class="lang-go"><span class="token comment">//</span>
<span class="token comment">// Hello World Zeromq Client</span>
<span class="token comment">//</span>
<span class="token comment">// Author: Aaron Raddon   github.com/araddon</span>
<span class="token comment">// Requires: http://github.com/alecthomas/gozmq</span>
<span class="token comment">//</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    socket<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>REQ<span class="token punctuation">)</span> <span class="token comment">//REQ&#x7C7B;&#x578B;, client&#x4FA7;</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> socket<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Connecting to hello world server...&quot;</span><span class="token punctuation">)</span>
    socket<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://localhost:5555&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token comment">// send hello</span>
        msg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;Hello %d&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        socket<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Sending &quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>

        <span class="token comment">// Wait for reply:</span>
        reply<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> socket<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Received &quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>client&#x7684;&#x5173;&#x952E;&#x64CD;&#x4F5C;&#x662F;<code>socket.Connect(&quot;tcp://localhost:5555&quot;)</code>, &#x4ECE;&#x6B64;&#x8FD9;&#x4E2A;socket&#x4EE3;&#x8868;&#x4E86;&#x548C;server&#x7684;&#x8FDE;&#x63A5;.&#x8BF4;&#x660E;&#x4ECE;app&#x7684;&#x89D2;&#x5EA6;&#x770B;:</p>
<ul>
<li>client&#x662F;&#x6301;&#x6709;server&#x8FDE;&#x63A5;&#x4FE1;&#x606F;&#x7684;</li>
<li>client send&#x540E;&#x9A6C;&#x4E0A;recv, &#x867D;&#x7136;&#x4E0D;&#x662F;rcp&#x7684;call&#x5F62;&#x5F0F;, &#x4F46;&#x8FD9;&#x91CC;&#x5FC5;&#x987B;&#x662F;&quot;lockstep&quot;&#x5F0F;&#x7684;&#x540C;&#x6B65;&#x7B49;. &#x56E0;&#x4E3A;&#x8FC7;&#x4E86;&#x8FD9;&#x4E2A;&#x70B9;, app&#x5C31;&#x4E0D;&#x77E5;&#x9053;reply&#x5BF9;&#x5E94;&#x7684;&#x662F;&#x90A3;&#x4E2A;request.</li>
</ul>
<h2 id="pub-sub"><a name="pub-sub" class="anchor-navigation-ex-anchor" href="#pub-sub"><i class="fa fa-link" aria-hidden="true"></i></a>4.3. pub-sub</h2>
<p>&#x4E00;&#x4E2A;pub, &#x591A;&#x4E2A;sub. &#x590D;&#x5236;&#x6D88;&#x606F;, &#x5F02;&#x6B65;&#x6A21;&#x5F0F;<br><img src="img/golang_zmq_20220911235008.png" alt="">  </p>
<p>subcriber&#x9700;&#x8981;&#x7528;<code>zmq_setsockopt()</code>&#x6765;&#x8BA2;&#x9605;&#x4E00;&#x4E2A;string&#x5173;&#x952E;&#x8BCD;.<br>sub&#x7684;&quot;socket&quot;&#x662F;&#x53EA;&#x8BFB;&#x7684;, pub&#x7684;&quot;socket&quot;&#x662F;&#x53EA;&#x5199;&#x7684;.<br>&#x867D;&#x7136;&#x7406;&#x8BBA;&#x4E0A;client&#x4E5F;&#x53EF;&#x4EE5;pub, &#x4F46;&#x4E00;&#x822C;&#x90FD;&#x662F;server pub, client&#x6765;&#x8BA2;&#x9605;.<br>&#x4ECE;&#x4E0B;&#x9762;&#x4F5C;&#x8005;&#x7684;&#x63CF;&#x8FF0;&#x6765;&#x770B;:</p>
<ul>
<li><p>A subscriber can connect to more than one publisher, using one connect call each time. Data will then arrive and be interleaved (&#x201C;fair-queued&#x201D;) so that no single publisher drowns out the others.<br>&#x4E00;&#x4E2A;subscriber&#x53EF;&#x4EE5;&#x4ECE;&#x591A;&#x4E2A;publisher&#x6765;&#x8BA2;&#x9605;. &#x4ECE;&#x8FD9;&#x4E2A;sub&#x7684;&quot;socket&quot;&#x8BFB;&#x80FD;&#x8BFB;&#x5230;&#x6240;&#x6709;&#x8BA2;&#x9605;&#x7684;&#x6D88;&#x606F;. &#x4ECE;&#x591A;&#x4E2A;publisher&#x6765;&#x7684;&#x6D88;&#x606F;&#x4EA4;&#x53C9;&#x653E;&#x7F6E;&#x5728;socket&#x91CC;</p>
</li>
<li><p>If a publisher has no connected subscribers, then it will simply drop all messages.<br>&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4EBA;&#x8BA2;&#x9605;, publisher&#x4F1A;&#x4E22;&#x5F03;&#x6240;&#x6709;&#x6D88;&#x606F;. -- &#x8BF4;&#x660E;&#x8BA2;&#x9605;&#x8005;&#x662F;&#x76F4;&#x63A5;&#x548C;&#x53D1;&#x5E03;&#x8005;&#x6709;&#x771F;&#x6B63;&#x7684;socket&#x8FDE;&#x63A5;&#x7684;, publisher&#x90FD;&#x77E5;&#x9053;.</p>
</li>
<li><p>If you&#x2019;re using TCP and a subscriber is slow, messages will queue up on the publisher. We&#x2019;ll look at how to protect publishers against this using the &#x201C;high-water mark&#x201D; later.<br>&#x5982;&#x679C;&#x662F;&#x8FDC;&#x7AEF;&#x673A;&#x5668;&#x4E0A;&#x7684;&#x6162;&#x901F;subscriber, &#x90A3;&#x6D88;&#x606F;&#x4F1A;&#x5728;publisher&#x4FA7;&#x62E5;&#x585E;. -- &#x66F4;&#x52A0;&#x8BF4;&#x660E;&#x4E86;&#x6CA1;&#x6709;&quot;&#x4E2D;&#x95F4;&#x4EBA;&quot;&#x6765;&#x8F6C;&#x53D1;.</p>
</li>
<li><p>From ZeroMQ v3.x, filtering happens at the publisher side when using a connected protocol (tcp&#x6216;ipc). Using the epgm protocol, filtering happens at the subscriber side. In ZeroMQ v2.x, all filtering happened at the subscriber side.<br>zmq&#x7684;2.0&#x7248;&#x672C;, filtering&#x53D1;&#x751F;&#x5728;&#x63A5;&#x6536;&#x65B9;; &#x800C;zmq3.0&#x7248;&#x672C;, filtering&#x53D1;&#x751F;&#x5728;&#x53D1;&#x9001;&#x65B9;.</p>
</li>
</ul>
<h3 id="server&#x4FA7;"><a name="server&#x4FA7;" class="anchor-navigation-ex-anchor" href="#server&#x4FA7;"><i class="fa fa-link" aria-hidden="true"></i></a>4.3.1. server&#x4FA7;</h3>
<pre class="language-"><code class="lang-go"><span class="token comment">// </span>
<span class="token comment">//   Weather update server</span>
<span class="token comment">//   Binds PUB socket to tcp://*:5556</span>
<span class="token comment">//   Publishes random weather updates</span>
<span class="token comment">// </span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
    <span class="token string">&quot;math/rand&quot;</span>
    <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    socket<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>PUB<span class="token punctuation">)</span> <span class="token comment">//&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x6307;&#x660E;&#x4E86;PUB&#x7C7B;&#x578B;</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> socket<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    socket<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://*:5556&quot;</span><span class="token punctuation">)</span>
    socket<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">&quot;ipc://weather.ipc&quot;</span><span class="token punctuation">)</span> <span class="token comment">//&#x4F3C;&#x4E4E;PUB&#x7C7B;&#x578B;&#x80FD;&#x7ED1;&#x5B9A;&#x591A;&#x4E2A;&#x5730;&#x5740;?</span>

    <span class="token comment">// Seed the random number generator</span>
    rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// loop for a while aparently</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token comment">//  make values that will fool the boss</span>
        zipcode <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span>
        temperature <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">215</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">80</span>
        relhumidity <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">10</span>

        msg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d %d %d&quot;</span><span class="token punctuation">,</span> zipcode<span class="token punctuation">,</span> temperature<span class="token punctuation">,</span> relhumidity<span class="token punctuation">)</span>

        <span class="token comment">//  Send message to all subscribers</span>
        socket<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="client&#x4FA7;"><a name="client&#x4FA7;" class="anchor-navigation-ex-anchor" href="#client&#x4FA7;"><i class="fa fa-link" aria-hidden="true"></i></a>4.3.2. client&#x4FA7;</h3>
<pre class="language-"><code class="lang-go"><span class="token comment">// </span>
<span class="token comment">//   Weather proxy listens to weather server which is constantly</span>
<span class="token comment">//   emitting weather data</span>
<span class="token comment">//   Binds SUB socket to tcp://*:5556</span>
<span class="token comment">// </span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
    <span class="token string">&quot;os&quot;</span>
    <span class="token string">&quot;strconv&quot;</span>
    <span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    socket<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>SUB<span class="token punctuation">)</span> <span class="token comment">//SUB&#x7C7B;&#x578B;</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> socket<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> temps <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    <span class="token keyword">var</span> temp <span class="token builtin">int64</span>
    total_temp <span class="token operator">:=</span> <span class="token number">0</span>
    filter <span class="token operator">:=</span> <span class="token string">&quot;59937&quot;</span>

    <span class="token comment">// find zipcode</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">{</span> <span class="token comment">// ./wuclient 85678</span>
        filter <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//  Subscribe to just one zipcode (whitefish MT 59937) </span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Collecting updates from weather server for %s&#x2026;\n&quot;</span><span class="token punctuation">,</span> filter<span class="token punctuation">)</span>
    socket<span class="token punctuation">.</span><span class="token function">SetSubscribe</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span> <span class="token comment">//&#x8BA2;&#x9605;&#x5B9E;&#x9645;&#x5C31;&#x662F;filter</span>
    socket<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://localhost:5556&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">101</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token comment">// found temperature point</span>
        datapt<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> socket<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        temps <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>datapt<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
        temp<span class="token punctuation">,</span> err <span class="token operator">=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>temps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token comment">// Invalid string </span>
            total_temp <span class="token operator">+=</span> <span class="token function">int</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Average temperature for zipcode %s was %dF \n\n&quot;</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> total_temp<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="push-pull"><a name="push-pull" class="anchor-navigation-ex-anchor" href="#push-pull"><i class="fa fa-link" aria-hidden="true"></i></a>4.4. push-pull</h2>
<p>zmq&#x7684;push&#x548C;pull&#x6A21;&#x5F0F;&#x7528;&#x4E8E;&#x751F;&#x4EA7; &#x6D88;&#x8D39;&#x7CFB;&#x7EDF;<br>push&#x751F;&#x4EA7;, pull&#x6765;&#x6D88;&#x8D39;. &#x53EF;&#x4EE5;&#x4E00;&#x4E2A;push, &#x591A;&#x4E2A;pull. &#x4F46;&#x5F88;&#x663E;&#x7136;, push&#x7684;&#x6D88;&#x606F;&#x4E0D;&#x4F1A;&#x590D;&#x5236;&#x5E7F;&#x64AD;&#x7ED9;&#x6BCF;&#x4E2A;puller<br><img src="img/golang_zmq_20220911235257.png" alt="">  </p>
<ul>
<li>A ventilator that produces tasks that can be done in parallel</li>
<li>A set of workers that process tasks</li>
<li>A sink that collects results back from the worker processes</li>
</ul>
<p>push&#x548C;pull&#x6CA1;&#x6709;&#x56FA;&#x5B9A;&#x7684;server client&#x89D2;&#x8272;, client&#x4E5F;&#x53EF;&#x4EE5;pull, &#x4E5F;&#x53EF;&#x4EE5;push.
&#x8FD9;&#x91CC;&#x7684;&#x6240;&#x6709;&#x6846;&#x6846;&#x90FD;&#x662F;&#x72EC;&#x7ACB;&#x7684;&#x8FDB;&#x7A0B;.</p>
<h3 id="&#x751F;&#x4EA7;&#x8005;-ventilator"><a name="&#x751F;&#x4EA7;&#x8005;-ventilator" class="anchor-navigation-ex-anchor" href="#&#x751F;&#x4EA7;&#x8005;-ventilator"><i class="fa fa-link" aria-hidden="true"></i></a>4.4.1. &#x751F;&#x4EA7;&#x8005; ventilator</h3>
<pre class="language-"><code class="lang-go"><span class="token comment">//</span>
<span class="token comment">// Task ventilator</span>
<span class="token comment">// Binds PUSH socket to tcp://localhost:5557</span>
<span class="token comment">// Sends batch of tasks to workers via that socket</span>
<span class="token comment">//</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
    <span class="token string">&quot;math/rand&quot;</span>
    <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Socket to send messages On</span>
    sender<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>PUSH<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> sender<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    sender<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://*:5557&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//  Socket to send start of batch message on</span>
    sink<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>PUSH<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> sink<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    sink<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://localhost:5558&quot;</span><span class="token punctuation">)</span>

    fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Press Enter when the workers are ready: &quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> line <span class="token builtin">string</span>
    fmt<span class="token punctuation">.</span><span class="token function">Scanln</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>line<span class="token punctuation">)</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Sending tasks to workers&#x2026;&quot;</span><span class="token punctuation">)</span>

    sink<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">// Seed the random number generator</span>
    rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    total_msec <span class="token operator">:=</span> <span class="token number">0</span>

    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        workload <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        total_msec <span class="token operator">+=</span> workload
        msg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> workload<span class="token punctuation">)</span>
        sender<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Total expected cost: %d msec\n&quot;</span><span class="token punctuation">,</span> total_msec<span class="token punctuation">)</span>

    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1e9</span><span class="token punctuation">)</span> <span class="token comment">//  Give 0MQ time to deliver: one second ==  1e9 ns</span>

<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x6D88;&#x8D39;&#x8005;worker"><a name="&#x6D88;&#x8D39;&#x8005;worker" class="anchor-navigation-ex-anchor" href="#&#x6D88;&#x8D39;&#x8005;worker"><i class="fa fa-link" aria-hidden="true"></i></a>4.4.2. &#x6D88;&#x8D39;&#x8005;worker</h3>
<pre class="language-"><code class="lang-go"><span class="token comment">//</span>
<span class="token comment">// Task Wroker</span>
<span class="token comment">// Connects PULL socket to tcp://localhost:5557</span>
<span class="token comment">// Collects workloads from ventilator via that socket</span>
<span class="token comment">// Connects PUSH socket to tcp://localhost:5558</span>
<span class="token comment">// Sends results to sink via that socket </span>
<span class="token comment">// </span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
    <span class="token string">&quot;strconv&quot;</span>
    <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//  Socket to receive messages on</span>
    receiver<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>PULL<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> receiver<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    receiver<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://localhost:5557&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//  Socket to send messages to task sink</span>
    sender<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>PUSH<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> sender<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    sender<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://localhost:5558&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//  Process tasks forever</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        msgbytes<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> receiver<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s.\n&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>msgbytes<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">//  Do the work</span>
        msec<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>msgbytes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>msec<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1e6</span><span class="token punctuation">)</span>

        <span class="token comment">//  Send results to sink</span>
        sender<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="sink"><a name="sink" class="anchor-navigation-ex-anchor" href="#sink"><i class="fa fa-link" aria-hidden="true"></i></a>4.4.3. sink</h3>
<pre class="language-"><code class="lang-go"><span class="token comment">//</span>
<span class="token comment">// Task sink</span>
<span class="token comment">// Binds PULL socket to tcp://localhost:5558</span>
<span class="token comment">// Collects results from workers via that socket</span>
<span class="token comment">//</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    zmq <span class="token string">&quot;github.com/alecthomas/gozmq&quot;</span>
    <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zmq<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> context<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//  Socket to receive messages on</span>
    receiver<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">NewSocket</span><span class="token punctuation">(</span>zmq<span class="token punctuation">.</span>PULL<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> receiver<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    receiver<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://*:5558&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//  Wait for start of batch</span>
    msgbytes<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> receiver<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Received Start Msg &quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>msgbytes<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">//  Start our clock now</span>
    start_time <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//  Process 100 confirmations</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        msgbytes<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> receiver<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//  Calculate and report duration of batch</span>
    te <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Total elapsed time: %d msec\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>te<span class="token operator">-</span>start_time<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1e6</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x603B;&#x7ED3;_2"><a name="&#x603B;&#x7ED3;_2" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;_2"><i class="fa fa-link" aria-hidden="true"></i></a>4.4.4. &#x603B;&#x7ED3;</h3>
<ul>
<li><p>The workers connect upstream to the ventilator, and downstream to the sink. This means you can add workers arbitrarily. If the workers bound to their endpoints, you would need (a) more endpoints and (b) to modify the ventilator and/or the sink each time you added a worker. We say that the ventilator and sink are <em>stable</em> parts of our architecture and the workers are <em>dynamic</em> parts of it.<br>worker&#x5BF9;&#x4E0A;&#x5BF9;&#x4E0B;&#x90FD;&#x662F;client, &#x6240;&#x4EE5;worker&#x80FD;&#x591F;&#x52A8;&#x6001;&#x7684;&#x6DFB;&#x52A0;. &#x800C;&#x4E0A;&#x4E0B;&#x4E24;&#x5C42;&#x90FD;&#x662F;server, &#x67B6;&#x6784;&#x4E0A;&#x662F;&#x7A33;&#x5B9A;&#x7684;.</p>
</li>
<li><p>We have to synchronize the start of the batch with all workers being up and running. This is a fairly common gotcha in ZeroMQ and there is no easy solution. The zmq_connect method takes a certain time. So when a set of workers connect to the ventilator, the first one to successfully connect will get a whole load of messages in that short time while the others are also connecting. If you don&#x2019;t synchronize the start of the batch somehow, the system won&#x2019;t run in parallel at all. Try removing the wait in the ventilator, and see what happens.<br>&#x5982;&#x679C;&#x751F;&#x4EA7;&#x8005;ventilator&#x4E0D;&#x7B49;&#x6240;&#x6709;worker&#x8FDE;&#x63A5;&#x6210;&#x529F;, &#x90A3;&#x5728;&#x7B2C;&#x4E00;&#x4E2A;&#x8FDE;&#x4E0A;&#x7684;worker&#x4F1A;&#x6536;&#x5230;&#x5927;&#x91CF;&#x7684;work. &#x800C;&#x5176;&#x4ED6;&#x7684;worker&#x8FD8;&#x5728;&#x8FDE;&#x63A5;&#x4E2D;. zmq&#x7684;&#x7ECF;&#x9A8C;&#x662F;, &#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x9700;&#x8981;ms&#x7EA7;&#x7684;&#x65F6;&#x95F4;, &#x8FD9;&#x4E2A;&#x65F6;&#x95F4;&#x5185;&#x8DB3;&#x591F;&#x5927;&#x91CF;&#x7684;&#x6D88;&#x606F;&#x4EA4;&#x4E92;&#x4E86;. -- &#x53EF;&#x80FD;&#x8BF4;&#x7684;&#x662F;&#x8DE8;&#x673A;&#x5668;&#x8DE8;&#x7F51;&#x7EDC;&#x7684;&#x573A;&#x666F;.</p>
</li>
<li><p>The ventilator&#x2019;s PUSH socket distributes tasks to workers (assuming they are all connected <em>before</em> the batch starts going out) evenly. This is called <em>load balancing</em> and it&#x2019;s something we&#x2019;ll look at again in more detail.<br>load balance&#x53D1;&#x751F;&#x5728;&#x751F;&#x4EA7;&#x8005;&#x5373;ventilator&#x91CC;&#x9762;</p>
</li>
<li><p>The sink&#x2019;s PULL socket collects results from workers evenly. This is called <em>fair-queuing</em>.<br>sinker&#x6536;&#x96C6;&#x7ED3;&#x679C;&#x7684;&#x65F6;&#x5019;, &#x4ECE;&#x6BCF;&#x4E2A;worker&#x516C;&#x5E73;&#x7684;&#x6536;&#x96C6;. &#x516C;&#x5E73;&#x961F;&#x5217;<br><img src="img/golang_zmq_20220911235424.png" alt="">  </p>
</li>
</ul>
<h2 id="context"><a name="context" class="anchor-navigation-ex-anchor" href="#context"><i class="fa fa-link" aria-hidden="true"></i></a>4.5. context</h2>
<p>&#x4E0A;&#x9762;go&#x4EE3;&#x7801;&#x4E2D;, &#x9996;&#x5148;&#x8981;&#x5EFA;&#x4E2A;context, socket&#x662F;&#x4ECE;&#x5C5E;&#x4E8E;context&#x7684;.
zmq&#x5EFA;&#x8BAE;: &#x6BCF;&#x4E2A;&#x8FDB;&#x7A0B;&#x4E00;&#x4E2A;context.</p>
<blockquote>
<p>You should create and use exactly one context in your process. Technically, the context is the container for all sockets in a single process, and acts as the transport for inproc sockets, which are the fastest way to connect threads in one process.</p>
</blockquote>
<h2 id="pipeline"><a name="pipeline" class="anchor-navigation-ex-anchor" href="#pipeline"><i class="fa fa-link" aria-hidden="true"></i></a>4.6. pipeline</h2>
<h2 id="fanout"><a name="fanout" class="anchor-navigation-ex-anchor" href="#fanout"><i class="fa fa-link" aria-hidden="true"></i></a>4.7. fanout</h2>
<h2 id="&#x7075;&#x9B42;&#x51E0;&#x95EE;"><a name="&#x7075;&#x9B42;&#x51E0;&#x95EE;" class="anchor-navigation-ex-anchor" href="#&#x7075;&#x9B42;&#x51E0;&#x95EE;"><i class="fa fa-link" aria-hidden="true"></i></a>4.8. &#x7075;&#x9B42;&#x51E0;&#x95EE;</h2>
<p><a href="https://zguide.zeromq.org/docs/chapter1/#Why-We-Needed-ZeroMQ" target="_blank">https://zguide.zeromq.org/docs/chapter1/#Why-We-Needed-ZeroMQ</a><br>&#x6458;&#x8981;&#x5982;&#x4E0B;:</p>
<h3 id="&#x963B;&#x585E;&#x8FD8;&#x662F;&#x5F02;&#x6B65;"><a name="&#x963B;&#x585E;&#x8FD8;&#x662F;&#x5F02;&#x6B65;" class="anchor-navigation-ex-anchor" href="#&#x963B;&#x585E;&#x8FD8;&#x662F;&#x5F02;&#x6B65;"><i class="fa fa-link" aria-hidden="true"></i></a>4.8.1. &#x963B;&#x585E;&#x8FD8;&#x662F;&#x5F02;&#x6B65;?</h3>
<p>&#x963B;&#x585E;&#x6027;&#x80FD;&#x4E0D;&#x4F73;, &#x5F02;&#x6B65;&#x5F88;&#x96BE;&#x641E;&#x5BF9;.</p>
<blockquote>
<p>How do we handle I/O? Does our application block, or do we handle I/O in the background? This is a key design decision. Blocking I/O creates architectures that do not scale well. But background I/O can be very hard to do right.How do we handle I/O? Does our application block, or do we handle I/O in the background? This is a key design decision. Blocking I/O creates architectures that do not scale well. But background I/O can be very hard to do right.</p>
</blockquote>
<h3 id="&#x8C01;&#x5F53;server&#x8C01;&#x5F53;client"><a name="&#x8C01;&#x5F53;server&#x8C01;&#x5F53;client" class="anchor-navigation-ex-anchor" href="#&#x8C01;&#x5F53;server&#x8C01;&#x5F53;client"><i class="fa fa-link" aria-hidden="true"></i></a>4.8.2. &#x8C01;&#x5F53;server&#x8C01;&#x5F53;client?</h3>
<p>&#x9700;&#x8981;server&#x6C38;&#x8FDC;&#x5728;&#x5417;? &#x9700;&#x8981;&#x65AD;&#x7EBF;&#x91CD;&#x8FDE;&#x5417;?</p>
<h3 id="&#x600E;&#x4E48;&#x5728;wire&#x4E0A;&#x8868;&#x793A;&#x4E00;&#x4E2A;message"><a name="&#x600E;&#x4E48;&#x5728;wire&#x4E0A;&#x8868;&#x793A;&#x4E00;&#x4E2A;message" class="anchor-navigation-ex-anchor" href="#&#x600E;&#x4E48;&#x5728;wire&#x4E0A;&#x8868;&#x793A;&#x4E00;&#x4E2A;message"><i class="fa fa-link" aria-hidden="true"></i></a>4.8.3. &#x600E;&#x4E48;&#x5728;wire&#x4E0A;&#x8868;&#x793A;&#x4E00;&#x4E2A;message?</h3>
<p>&#x6211;&#x89C9;&#x5F97;&#x7528;&#x7ED3;&#x6784;&#x4F53;, &#x6216;&#x8005;tengo&#x4E2D;&#x7684;Object&#x62BD;&#x8C61;</p>
<h3 id="&#x5982;&#x679C;&#x5BF9;&#x7AEF;&#x6CA1;&#x51C6;&#x5907;&#x597D;&#x7684;&#x65F6;&#x5019;-&#x8981;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x5728;&#x54EA;&#x91CC;"><a name="&#x5982;&#x679C;&#x5BF9;&#x7AEF;&#x6CA1;&#x51C6;&#x5907;&#x597D;&#x7684;&#x65F6;&#x5019;-&#x8981;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x5728;&#x54EA;&#x91CC;" class="anchor-navigation-ex-anchor" href="#&#x5982;&#x679C;&#x5BF9;&#x7AEF;&#x6CA1;&#x51C6;&#x5907;&#x597D;&#x7684;&#x65F6;&#x5019;-&#x8981;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x5728;&#x54EA;&#x91CC;"><i class="fa fa-link" aria-hidden="true"></i></a>4.8.4. &#x5982;&#x679C;&#x5BF9;&#x7AEF;&#x6CA1;&#x51C6;&#x5907;&#x597D;&#x7684;&#x65F6;&#x5019;, &#x8981;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x5728;&#x54EA;&#x91CC;?</h3>
<h3 id="&#x62E5;&#x585E;&#x63A7;&#x5236;&#x7B56;&#x7565;"><a name="&#x62E5;&#x585E;&#x63A7;&#x5236;&#x7B56;&#x7565;" class="anchor-navigation-ex-anchor" href="#&#x62E5;&#x585E;&#x63A7;&#x5236;&#x7B56;&#x7565;"><i class="fa fa-link" aria-hidden="true"></i></a>4.8.5. &#x62E5;&#x585E;&#x63A7;&#x5236;&#x7B56;&#x7565;?</h3>
<h3 id="&#x6D88;&#x606F;&#x4E22;&#x5931;&#x600E;&#x4E48;&#x529E;-&#x8981;&#x4FDD;&#x8BC1;&#x9001;&#x8FBE;&#x5417;"><a name="&#x6D88;&#x606F;&#x4E22;&#x5931;&#x600E;&#x4E48;&#x529E;-&#x8981;&#x4FDD;&#x8BC1;&#x9001;&#x8FBE;&#x5417;" class="anchor-navigation-ex-anchor" href="#&#x6D88;&#x606F;&#x4E22;&#x5931;&#x600E;&#x4E48;&#x529E;-&#x8981;&#x4FDD;&#x8BC1;&#x9001;&#x8FBE;&#x5417;"><i class="fa fa-link" aria-hidden="true"></i></a>4.8.6. &#x6D88;&#x606F;&#x4E22;&#x5931;&#x600E;&#x4E48;&#x529E;? &#x8981;&#x4FDD;&#x8BC1;&#x9001;&#x8FBE;&#x5417;?</h3>
<h3 id="&#x5982;&#x679C;&#x6709;&#x65B0;&#x7684;transport&#x65B9;&#x6CD5;&#x600E;&#x4E48;&#x529E;-app&#x8981;&#x6539;&#x5417;-&#x6BD4;&#x5982;&#x589E;&#x52A0;&#x652F;&#x6301;yipc"><a name="&#x5982;&#x679C;&#x6709;&#x65B0;&#x7684;transport&#x65B9;&#x6CD5;&#x600E;&#x4E48;&#x529E;-app&#x8981;&#x6539;&#x5417;-&#x6BD4;&#x5982;&#x589E;&#x52A0;&#x652F;&#x6301;yipc" class="anchor-navigation-ex-anchor" href="#&#x5982;&#x679C;&#x6709;&#x65B0;&#x7684;transport&#x65B9;&#x6CD5;&#x600E;&#x4E48;&#x529E;-app&#x8981;&#x6539;&#x5417;-&#x6BD4;&#x5982;&#x589E;&#x52A0;&#x652F;&#x6301;yipc"><i class="fa fa-link" aria-hidden="true"></i></a>4.8.7. &#x5982;&#x679C;&#x6709;&#x65B0;&#x7684;transport&#x65B9;&#x6CD5;&#x600E;&#x4E48;&#x529E;? app&#x8981;&#x6539;&#x5417;? &#x6BD4;&#x5982;&#x589E;&#x52A0;&#x652F;&#x6301;yipc?</h3>
<blockquote>
<p>What if we need to use a different network transport. Say, multicast instead of TCP unicast? Or IPv6? Do we need to rewrite the applications, or is the transport abstracted in some layer?</p>
</blockquote>
<h3 id="&#x6D88;&#x606F;&#x600E;&#x4E48;&#x8DEF;&#x7531;"><a name="&#x6D88;&#x606F;&#x600E;&#x4E48;&#x8DEF;&#x7531;" class="anchor-navigation-ex-anchor" href="#&#x6D88;&#x606F;&#x600E;&#x4E48;&#x8DEF;&#x7531;"><i class="fa fa-link" aria-hidden="true"></i></a>4.8.8. &#x6D88;&#x606F;&#x600E;&#x4E48;&#x8DEF;&#x7531;?</h3>
<blockquote>
<p>How do we route messages? Can we send the same message to multiple peers? Can we send replies back to an original requester?</p>
</blockquote>
<h3 id="&#x591A;&#x8BED;&#x8A00;&#x600E;&#x4E48;&#x9002;&#x914D;-encoding&#x600E;&#x4E48;&#x9009;&#x62E9;-&#x7F51;&#x7EDC;&#x9519;&#x8BEF;&#x600E;&#x4E48;&#x5904;&#x7406;"><a name="&#x591A;&#x8BED;&#x8A00;&#x600E;&#x4E48;&#x9002;&#x914D;-encoding&#x600E;&#x4E48;&#x9009;&#x62E9;-&#x7F51;&#x7EDC;&#x9519;&#x8BEF;&#x600E;&#x4E48;&#x5904;&#x7406;" class="anchor-navigation-ex-anchor" href="#&#x591A;&#x8BED;&#x8A00;&#x600E;&#x4E48;&#x9002;&#x914D;-encoding&#x600E;&#x4E48;&#x9009;&#x62E9;-&#x7F51;&#x7EDC;&#x9519;&#x8BEF;&#x600E;&#x4E48;&#x5904;&#x7406;"><i class="fa fa-link" aria-hidden="true"></i></a>4.8.9. &#x591A;&#x8BED;&#x8A00;&#x600E;&#x4E48;&#x9002;&#x914D;? encoding&#x600E;&#x4E48;&#x9009;&#x62E9;? &#x7F51;&#x7EDC;&#x9519;&#x8BEF;&#x600E;&#x4E48;&#x5904;&#x7406;?</h3>
<h3 id="&#x4F5C;&#x8005;&#x89C2;&#x70B9;"><a name="&#x4F5C;&#x8005;&#x89C2;&#x70B9;" class="anchor-navigation-ex-anchor" href="#&#x4F5C;&#x8005;&#x89C2;&#x70B9;"><i class="fa fa-link" aria-hidden="true"></i></a>4.8.10. &#x4F5C;&#x8005;&#x89C2;&#x70B9;</h3>
<p>&#x6D88;&#x606F;&#x5904;&#x7406;&#x6846;&#x67B6;&#x4E0D;&#x597D;&#x641E;. &#x5F88;&#x591A;&#x4EBA;&#x8D8A;&#x9AD8;&#x8D8A;&#x590D;&#x6742;, &#x6545;&#x969C;&#x7387;&#x8D8A;&#x9AD8;. &#x8FD9;&#x5305;&#x62EC;&#x4E86;broker&#x6982;&#x5FF5;&#x7684;&#x53D1;&#x660E;&#x548C;&#x5E7F;&#x6CDB;&#x4F7F;&#x7528;. &#x5728;&#x5E26;&#x6765;&#x65B9;&#x4FBF;&#x7684;&#x540C;&#x65F6;, broker&#x4E5F;&#x6709;&#x5F88;&#x591A;&#x95EE;&#x9898;, &#x6BD4;&#x5982;broker&#x7CFB;&#x7EDF;&#x672C;&#x8EAB;&#x9700;&#x8981;&#x4EBA;&#x7EF4;&#x62A4;, &#x53EA;&#x9002;&#x5408;&#x5927;&#x578B;&#x7CFB;&#x7EDF;.<br>&#x5BF9;&#x4E2D;&#x5C0F;&#x578B;&#x7684;&#x7CFB;&#x7EDF;&#x5F00;&#x53D1;&#x6765;&#x8BF4;, &#x901A;&#x5E38;&#x7684;&#x7ED3;&#x5C40;&#x4F5C;&#x8005;&#x5DF2;&#x7ECF;&#x9884;&#x8A00;&#x4E86;:  </p>
<blockquote>
<p>Either they avoid network programming and make monolithic applications that do not scale. Or they jump into network programming and make brittle, complex applications that are hard to maintain. Or they bet on a messaging product, and end up with scalable applications that depend on expensive, easily broken technology.<br>&#x4E0D;&#x662F;&#x81EA;&#x5DF1;&#x778E;&#x641E;, &#x5C31;&#x662F;&#x8D4C;&#x4E0A;&#x4E00;&#x4E2A;&#x65B0;&#x6280;&#x672F;&#x6765;&#x778E;&#x641E;.</p>
</blockquote>
<p>&#x4F5C;&#x8005;&#x8BA4;&#x4E3A;&#x7684;&#x7406;&#x60F3;&#x6D88;&#x606F;&#x7CFB;&#x7EDF;:  </p>
<blockquote>
<p>What we need is something that does the job of messaging, but does it in such a simple and cheap way that it can work in any application, with close to zero cost. It should be a library which you just link, without any other dependencies. No additional moving pieces, so no additional risk. It should run on any OS and work with any programming language.</p>
</blockquote>
<p>&#x53EA;&#x662F;&#x4E2A;&#x5E93;, &#x7B80;&#x5355;, &#x9AD8;&#x6548;, &#x6CA1;&#x6709;&#x5176;&#x4ED6;&#x7684;&#x6BD4;&#x5982;broker, &#x6D88;&#x606F;&#x4E2D;&#x5FC3;&#x7B49;&#x72EC;&#x7ACB;&#x5B9E;&#x4F53;.  </p>
<ul>
<li><p>It handles I/O asynchronously, in background threads. These communicate with application threads using lock-free data structures, so concurrent ZeroMQ applications need no locks, semaphores, or other wait states.<br>&#x80CC;&#x666F;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x5F02;&#x6B65;IO, &#x65E0;&#x9501;&#x8BBE;&#x8BA1;. app&#x5C42;&#x4E0D;&#x5173;&#x5FC3;&#x9501;</p>
</li>
<li><p>Components can come and go dynamically and ZeroMQ will automatically reconnect. This means you can start components in any order. You can create &#x201C;service-oriented architectures&#x201D; (SOAs) where services can join and leave the network at any time.<br>&#x81EA;&#x52A8;&#x91CD;&#x8FDE;</p>
</li>
<li><p>It queues messages automatically when needed. It does this intelligently, pushing messages as close as possible to the receiver before queuing them.<br>&#x81EA;&#x52A8;&#x7F13;&#x5B58;&#x6D88;&#x606F;</p>
</li>
<li><p>It has ways of dealing with over-full queues (called &#x201C;high water mark&#x201D;). When a queue is full, ZeroMQ automatically blocks senders, or throws away messages, depending on the kind of messaging you are doing (the so-called &#x201C;pattern&#x201D;).<br>&#x62E5;&#x585E;&#x65F6;&#x6709;&#x8003;&#x8651;</p>
</li>
<li><p>It lets your applications talk to each other over arbitrary transports: TCP, multicast, in-process, inter-process. You don&#x2019;t need to change your code to use a different transport.<br>&#x591A;transport&#x652F;&#x6301;: tcp, &#x591A;&#x64AD;, &#x8FDB;&#x7A0B;&#x95F4;, &#x7EBF;&#x7A0B;&#x95F4;</p>
</li>
<li><p>It handles slow/blocked readers safely, using different strategies that depend on the messaging pattern.<br>&#x8FD8;&#x662F;&#x5173;&#x4E8E;&#x62E5;&#x585E;&#x7684;</p>
</li>
<li><p>It lets you route messages using a variety of patterns such as request-reply and pub-sub. These patterns are how you create the topology, the structure of your network.<br>&#x652F;&#x6301;&#x591A;&#x6A21;&#x5F0F;, &#x6BD4;&#x5982;req-rep, pub-sub&#x7B49;&#x7B49;</p>
</li>
<li><p>It lets you create proxies to queue, forward, or capture messages with a single call. Proxies can reduce the interconnection complexity of a network.<br>&#x652F;&#x6301;proxy&#x6765;&#x505A;&#x8F6C;&#x53D1;, &#x8F6C;&#x5B58;, &#x6293;&#x5305;&#x7B49;</p>
</li>
<li><p>It delivers whole messages exactly as they were sent, using a simple framing on the wire. If you write a 10k message, you will receive a 10k message.<br>&#x6D88;&#x606F;&#x7EA7;&#x522B;&#x4F20;&#x8F93;. &#x800C;&#x4E0D;&#x662F;&#x62A5;&#x6587;&#x7EA7;&#x522B;</p>
</li>
<li><p>It does not impose any format on messages. They are blobs from zero to gigabytes large. When you want to represent data you choose some other product on top, such as msgpack, Google&#x2019;s protocol buffers, and others.<br>&#x4ECE;zmq&#x7EA7;&#x522B;&#x6765;&#x770B;, zmq&#x4E0D;&#x5BF9;&#x4F20;&#x8F93;&#x7684;&#x6570;&#x636E;&#x505A;&#x5305;&#x88C5;.</p>
</li>
<li><p>It handles network errors intelligently, by retrying automatically in cases where it makes sense.<br>&#x5BF9;&#x7F51;&#x7EDC;&#x9519;&#x8BEF;&#x6709;&#x4E00;&#x5957;&#x5904;&#x7406;</p>
</li>
</ul>
<p>zmq&#x5E95;&#x5C42;&#x662F;&#x80CC;&#x666F;&#x7EBF;&#x7A0B;&#x7BA1;&#x7406;&#x7684;&quot;&#x8FDE;&#x63A5;&quot;</p>
<blockquote>
<p>In the ZeroMQ universe, sockets are doorways to fast little background communications engines that manage a whole set of connections automagically for you. You can&#x2019;t see, work with, open, close, or attach state to these connections. Whether you use blocking send or receive, or poll, all you can talk to is the socket, not the connections it manages for you. The connections are private and invisible, and this is the key to ZeroMQ&#x2019;s scalability.</p>
<p>This is because your code, talking to a socket, can then handle any number of connections across whatever network protocols are around, without change. <strong>A messaging pattern sitting in ZeroMQ scales more cheaply than a messaging pattern sitting in your application code.</strong></p>
</blockquote>
<p>zmq&#x5BF9;app&#x63D0;&#x4F9B;&#x7684;socket&#x4E0D;&#x662F;&#x539F;&#x59CB;&#x7684;os&#x7EA7;&#x522B;socket, &#x800C;&#x662F;os.socket+os.thread&#x7EC4;&#x6210;&#x7684;&#x4E00;&#x5957;&#x7CFB;&#x7EDF;.</p>
<h1 id="zero-mqzmq-0mq"><a name="zero-mqzmq-0mq" class="anchor-navigation-ex-anchor" href="#zero-mqzmq-0mq"><i class="fa fa-link" aria-hidden="true"></i></a>5. zero mq(zmq, 0mq)</h1>
<p><a href="https://zeromq.org/get-started/" target="_blank">https://zeromq.org/get-started/</a>
<a href="https://lwn.net/Articles/466304/" target="_blank">https://lwn.net/Articles/466304/</a></p>
<p>&#x6982;&#x5FF5;: 
<a href="http://zguide.zeromq.org/page:all" target="_blank">http://zguide.zeromq.org/page:all</a>
<a href="http://zguide.zeromq.org/page:chapter1" target="_blank">http://zguide.zeromq.org/page:chapter1</a></p>
<p>&#x7EAF;go&#x5B9E;&#x73B0;zero mq 
<a href="https://github.com/zeromq/gomq" target="_blank">https://github.com/zeromq/gomq</a>
<a href="https://github.com/go-zeromq/zmq4" target="_blank">https://github.com/go-zeromq/zmq4</a></p>
<p>cgo&#x7248;&#x672C;:
<a href="https://github.com/zeromq/goczmq" target="_blank">https://github.com/zeromq/goczmq</a>
<a href="https://github.com/pebbe/zmq4" target="_blank">https://github.com/pebbe/zmq4</a></p>
<p>zero mq api: <a href="http://api.zeromq.org/2-1:zmq-connect" target="_blank">http://api.zeromq.org/2-1:zmq-connect</a></p>
<h1 id="&#x95EE;&#x9898;-req-rep&#x6A21;&#x5F0F;&#x4E0B;&#x7684;rpc-&#x600E;&#x4E48;&#x628A;&#x5F02;&#x6B65;&#x540C;&#x6B65;&#x5316;&#x7684;"><a name="&#x95EE;&#x9898;-req-rep&#x6A21;&#x5F0F;&#x4E0B;&#x7684;rpc-&#x600E;&#x4E48;&#x628A;&#x5F02;&#x6B65;&#x540C;&#x6B65;&#x5316;&#x7684;" class="anchor-navigation-ex-anchor" href="#&#x95EE;&#x9898;-req-rep&#x6A21;&#x5F0F;&#x4E0B;&#x7684;rpc-&#x600E;&#x4E48;&#x628A;&#x5F02;&#x6B65;&#x540C;&#x6B65;&#x5316;&#x7684;"><i class="fa fa-link" aria-hidden="true"></i></a>6. &#x95EE;&#x9898;: REQ-REP&#x6A21;&#x5F0F;&#x4E0B;&#x7684;RPC, &#x600E;&#x4E48;&#x628A;&#x5F02;&#x6B65;&#x540C;&#x6B65;&#x5316;&#x7684;?</h1>
<p>&#x6BD4;&#x5982;socket send&#x540E;, &#x600E;&#x4E48;&#x7B49;&#x5F85;socket recv?
&#x6700;&#x7B80;&#x5355;&#x7684;send, &#x539F;&#x5730;recv&#x53EF;&#x4EE5;, &#x4F46;&#x5E76;&#x53D1;&#x573A;&#x666F;&#x5462;?
&#x6211;&#x8BB0;&#x5F97;&#x5728;&#x54EA;&#x91CC;&#x770B;&#x5230;&#x8FC7;, &#x601D;&#x8DEF;&#x6709;&#x70B9;&#x50CF;channel in channel. &#x4F46;client&#x65B9;&#x9700;&#x8981;&#x6709;&#x4E2A;&#x5B88;&#x62A4;routine, &#x6536;&#x5230;REP&#x540E;, &#x7ED9;&#x5BF9;&#x5E94;&#x7684;goroutine&#x53D1;channel</p>
<h2 id="zmq&#x4F7F;&#x7528;&#x6700;&#x57FA;&#x672C;&#x7684;&#x6A21;&#x5F0F;-send&#x540E;&#x9A6C;&#x4E0A;recv"><a name="zmq&#x4F7F;&#x7528;&#x6700;&#x57FA;&#x672C;&#x7684;&#x6A21;&#x5F0F;-send&#x540E;&#x9A6C;&#x4E0A;recv" class="anchor-navigation-ex-anchor" href="#zmq&#x4F7F;&#x7528;&#x6700;&#x57FA;&#x672C;&#x7684;&#x6A21;&#x5F0F;-send&#x540E;&#x9A6C;&#x4E0A;recv"><i class="fa fa-link" aria-hidden="true"></i></a>6.1. zmq&#x4F7F;&#x7528;&#x6700;&#x57FA;&#x672C;&#x7684;&#x6A21;&#x5F0F;, send&#x540E;&#x9A6C;&#x4E0A;recv</h2>
<p>client&#x4EE3;&#x7801;</p>
<pre class="language-"><code class="lang-c"><span class="token comment">//  Hello World client</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;zmq.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">&quot;Connecting to hello world server...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>context <span class="token operator">=</span> <span class="token function">zmq_ctx_new</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>requester <span class="token operator">=</span> <span class="token function">zmq_socket</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> ZMQ_REQ<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zmq_connect</span> <span class="token punctuation">(</span>requester<span class="token punctuation">,</span> <span class="token string">&quot;tcp://localhost:5555&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> request_nbr<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>request_nbr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> request_nbr <span class="token operator">!=</span> <span class="token number">10</span><span class="token punctuation">;</span> request_nbr<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> buffer <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">&quot;Sending Hello %d...\n&quot;</span><span class="token punctuation">,</span> request_nbr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x5148;send</span>
        <span class="token function">zmq_send</span> <span class="token punctuation">(</span>requester<span class="token punctuation">,</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x539F;&#x5730;recv</span>
        <span class="token function">zmq_recv</span> <span class="token punctuation">(</span>requester<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">&quot;Received World %d\n&quot;</span><span class="token punctuation">,</span> request_nbr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">zmq_close</span> <span class="token punctuation">(</span>requester<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zmq_ctx_destroy</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>server&#x4FA7;&#x4EE3;&#x7801;</p>
<pre class="language-"><code class="lang-c"><span class="token comment">//  Hello World server</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;zmq.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//  Socket to talk to clients</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>context <span class="token operator">=</span> <span class="token function">zmq_ctx_new</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>responder <span class="token operator">=</span> <span class="token function">zmq_socket</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> ZMQ_REP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">zmq_bind</span> <span class="token punctuation">(</span>responder<span class="token punctuation">,</span> <span class="token string">&quot;tcp://*:5555&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> buffer <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x5148;&#x63A5;&#x6536;</span>
        <span class="token function">zmq_recv</span> <span class="token punctuation">(</span>responder<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">&quot;Received Hello\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//  Do some &apos;work&apos;</span>
        <span class="token comment">//&#x518D;&#x53D1;&#x9001;</span>
        <span class="token function">zmq_send</span> <span class="token punctuation">(</span>responder<span class="token punctuation">,</span> <span class="token string">&quot;World&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x57FA;&#x672C;&#x6A21;&#x5F0F;&#x4E0B;, zmq&#x4E0D;&#x5141;&#x8BB8;&#x540C;&#x65F6;&#x53D1;REQ:</p>
<blockquote>
<p>The REQ-REP socket pair is in lockstep. The client issues zmq_send() and then zmq_recv(), in a loop (or once if that&#x2019;s all it needs). Doing any other sequence (e.g., sending two messages in a row) will result in a return code of -1 from the send or recv call.</p>
</blockquote>
<h2 id="go&#x6807;&#x51C6;&#x5E93;&#x7684;rpc"><a name="go&#x6807;&#x51C6;&#x5E93;&#x7684;rpc" class="anchor-navigation-ex-anchor" href="#go&#x6807;&#x51C6;&#x5E93;&#x7684;rpc"><i class="fa fa-link" aria-hidden="true"></i></a>6.2. go&#x6807;&#x51C6;&#x5E93;&#x7684;rpc</h2>
<p>&#x5728;<code>src/net/rpc/client.go</code>&#x4E2D;, client&#x652F;&#x6301;&#x540C;&#x65F6;&#x591A;&#x4E2A;REQ&#x5E76;&#x53D1;&#x53D1;&#x9001;&#x5230;server, &#x600E;&#x4E48;&#x505A;&#x5230;&#x7684;?</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Client represents an RPC Client.</span>
<span class="token comment">// There may be multiple outstanding Calls associated</span>
<span class="token comment">// with a single Client, and a Client may be used by</span>
<span class="token comment">// multiple goroutines simultaneously.</span>
<span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    codec ClientCodec

    reqMutex sync<span class="token punctuation">.</span>Mutex <span class="token comment">// protects following</span>
    request  Request

    mutex    sync<span class="token punctuation">.</span>Mutex <span class="token comment">// protects following</span>
    <span class="token comment">//&#x79D8;&#x8BC0;&#x5728;seq&#x548C;&#x540E;&#x9762;&#x7684;pending map</span>
    seq      <span class="token builtin">uint64</span>
    pending  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint64</span><span class="token punctuation">]</span><span class="token operator">*</span>Call
    closing  <span class="token builtin">bool</span> <span class="token comment">// user has called Close</span>
    shutdown <span class="token builtin">bool</span> <span class="token comment">// server has told us to stop</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5728;send&#x7684;&#x65F6;&#x5019;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>client <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">send</span><span class="token punctuation">(</span>call <span class="token operator">*</span>Call<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//&#x5728;&#x52A0;&#x9501;&#x7684;&#x60C5;&#x51B5;&#x4E0B;, &#x628A;seq++&#x5E76;&#x52A0;&#x5230;map&#x4E2D;</span>
    seq <span class="token operator">:=</span> client<span class="token punctuation">.</span>seq
    client<span class="token punctuation">.</span>seq<span class="token operator">++</span>
    client<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>seq<span class="token punctuation">]</span> <span class="token operator">=</span> call
    client<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//&#x53D1;&#x9001;</span>
    client<span class="token punctuation">.</span>request<span class="token punctuation">.</span>Seq <span class="token operator">=</span> seq
    client<span class="token punctuation">.</span>codec<span class="token punctuation">.</span><span class="token function">WriteRequest</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token punctuation">.</span>request<span class="token punctuation">,</span> call<span class="token punctuation">.</span>Args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x91CC;&#x9762;&#x7684;Call&#x662F;&#x8FD9;&#x6B21;RPC&#x8C03;&#x7528;&#x7684;&#x62BD;&#x8C61;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Call represents an active RPC.</span>
<span class="token keyword">type</span> Call <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    ServiceMethod <span class="token builtin">string</span>      <span class="token comment">// The name of the service and method to call.</span>
    Args          <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// The argument to the function (*struct).</span>
    Reply         <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// The reply from the function (*struct).</span>
    Error         <span class="token builtin">error</span>       <span class="token comment">// After completion, the error status.</span>
    Done          <span class="token keyword">chan</span> <span class="token operator">*</span>Call  <span class="token comment">// Strobes when call is complete.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x597D;&#x4E86;, &#x4E0B;&#x9762;&#x770B;&#x770B;client.Call</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Call invokes the named function, waits for it to complete, and returns its error status.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>client <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">Call</span><span class="token punctuation">(</span>serviceMethod <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> reply <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    call <span class="token operator">:=</span> <span class="token operator">&lt;-</span>client<span class="token punctuation">.</span><span class="token function">Go</span><span class="token punctuation">(</span>serviceMethod<span class="token punctuation">,</span> args<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>Call<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Done
    <span class="token keyword">return</span> call<span class="token punctuation">.</span>Error
<span class="token punctuation">}</span>
</code></pre>
<p>Go&#x51FD;&#x6570;&#x91CC;&#x9762;, &#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;Call, &#x548C;&#x4E00;&#x4E2A;channel, send&#x8FD9;&#x4E2A;Call&#x7ED9;server, &#x8FD4;&#x56DE;&#x8FD9;&#x4E2A;channel.
&#x6CE8;&#x610F;, Go&#x51FD;&#x6570;&#x5E76;&#x4E0D;&#x7B49;&#x5F85;server&#x7684;REP&#x8FC7;&#x6765;.</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Go invokes the function asynchronously. It returns the Call structure representing</span>
<span class="token comment">// the invocation. The done channel will signal when the call is complete by returning</span>
<span class="token comment">// the same Call object. If done is nil, Go will allocate a new channel.</span>
<span class="token comment">// If non-nil, done must be buffered or Go will deliberately crash.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>client <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">Go</span><span class="token punctuation">(</span>serviceMethod <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> reply <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> done <span class="token keyword">chan</span> <span class="token operator">*</span>Call<span class="token punctuation">)</span> <span class="token operator">*</span>Call <span class="token punctuation">{</span>
    call <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Call<span class="token punctuation">)</span>
    call<span class="token punctuation">.</span>ServiceMethod <span class="token operator">=</span> serviceMethod
    call<span class="token punctuation">.</span>Args <span class="token operator">=</span> args
    call<span class="token punctuation">.</span>Reply <span class="token operator">=</span> reply
    <span class="token keyword">if</span> done <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        done <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>Call<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// buffered.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// If caller passes done != nil, it must arrange that</span>
        <span class="token comment">// done has enough buffer for the number of simultaneous</span>
        <span class="token comment">// RPCs that will be using that channel. If the channel</span>
        <span class="token comment">// is totally unbuffered, it&apos;s best not to run at all.</span>
        <span class="token keyword">if</span> <span class="token function">cap</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token string">&quot;rpc: done channel is unbuffered&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    call<span class="token punctuation">.</span>Done <span class="token operator">=</span> done
    client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span>
    <span class="token keyword">return</span> call
<span class="token punctuation">}</span>
</code></pre>
<p>&#x7B49;&#x5F85;&#x53D1;&#x751F;&#x5728;Go&#x51FD;&#x6570;&#x91CC;&#x9762;, &#x7B49;&#x5F85;&#x8FD9;&#x4E2A;&#x8FD4;&#x56DE;&#x7684;channel.
&#x597D;&#x4E86;, &#x4F46;&#x662F;&#x54EA;&#x91CC;&#x5199;&#x8FD9;&#x4E2A;channel&#x5462;?</p>
<p>&#x6BCF;&#x4E2A;client&#x90FD;&#x542F;&#x52A8;&#x4E86;&#x4E00;&#x4E2A;&#x5B88;&#x62A4;goroutine, &#x53EB;input</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// NewClientWithCodec is like NewClient but uses the specified</span>
<span class="token comment">// codec to encode requests and decode responses.</span>
<span class="token keyword">func</span> <span class="token function">NewClientWithCodec</span><span class="token punctuation">(</span>codec ClientCodec<span class="token punctuation">)</span> <span class="token operator">*</span>Client <span class="token punctuation">{</span>
    client <span class="token operator">:=</span> <span class="token operator">&amp;</span>Client<span class="token punctuation">{</span>
        codec<span class="token punctuation">:</span>   codec<span class="token punctuation">,</span>
        pending<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint64</span><span class="token punctuation">]</span><span class="token operator">*</span>Call<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">go</span> client<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> client
<span class="token punctuation">}</span>
</code></pre>
<p>&#x524D;&#x9762;&#x8BF4;&#x8FC7;&#x4E86;, client.Call&#x51FD;&#x6570;&#x53EA;&#x662F;&#x8C03;&#x7528;&#x4E86;send, &#x7136;&#x540E;&#x7B49;&#x5F85;&#x5728;chennel&#x4E0A;. &#x6CA1;&#x6709;&#x8C03;&#x7528;recv
&#x662F;&#x8FD9;&#x4E2A;input routine&#x4E0D;&#x65AD;&#x7684;&#x8C03;&#x7528;recv&#x6765;&#x6536;&#x5305;&#x7684;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>client <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        response <span class="token operator">=</span> Response<span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token comment">//recv&#x6536;header</span>
        err <span class="token operator">=</span> client<span class="token punctuation">.</span>codec<span class="token punctuation">.</span><span class="token function">ReadResponseHeader</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>response<span class="token punctuation">)</span>
        <span class="token comment">//&#x5305;&#x5934;&#x91CC;&#x9762;&#x7531;seq&#x53F7;</span>
        seq <span class="token operator">:=</span> response<span class="token punctuation">.</span>Seq
        client<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//&#x6839;&#x636E;seq&#x53F7;&#x627E;&#x5230;call channel</span>
        call <span class="token operator">:=</span> client<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>seq<span class="token punctuation">]</span>
        <span class="token function">delete</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>pending<span class="token punctuation">,</span> seq<span class="token punctuation">)</span>
        client<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">//&#x8BFB;Reply</span>
        client<span class="token punctuation">.</span>codec<span class="token punctuation">.</span><span class="token function">ReadResponseBody</span><span class="token punctuation">(</span>call<span class="token punctuation">.</span>Reply<span class="token punctuation">)</span>
        <span class="token comment">//&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5199;channel, &#x901A;&#x77E5;client.Call&#x505C;&#x6B62;&#x7B49;&#x5F85;</span>
        call<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x603B;&#x7ED3;:</p>
<ul>
<li>send&#x4E4B;&#x524D;&#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;call&#x7ED3;&#x6784;&#x4F53;, &#x7528;&#x6765;&#x4F20;&#x9012;&#x4FE1;&#x606F;. &#x540C;&#x65F6;&#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;channel(&#x6BCF;&#x4E2A;call&#x4E00;&#x4E2A;). &#x53D1;&#x9001;&#x7684;&#x65F6;&#x5019;, &#x6BCF;&#x4E2A;req&#x90FD;&#x6709;&#x4E2A;&#x5E8F;&#x53F7;, &#x8FD9;&#x4E2A;&#x5E8F;&#x53F7;&#x548C;call&#x662F;&#x4E00;&#x4E00;&#x5BF9;&#x5E94;&#x7684;, &#x628A;&#x8FD9;&#x4E2A;&#x5BF9;&#x5E94;&#x5173;&#x7CFB;&#x4FDD;&#x5B58;&#x5728;map&#x91CC;.
client&#x7B49;&#x5F85;&#x5728;&#x8FD9;&#x4E2A;channel.</li>
<li>server&#x7AEF;&#x628A;seq&#x539F;&#x5C01;&#x4E0D;&#x52A8;&#x7684;&#x642C;&#x5230;reply&#x7684;header&#x91CC;&#x9762;: <code>resp.Seq = req.Seq</code></li>
<li>&#x6709;&#x4E2A;input goroutine&#x4E0D;&#x65AD;&#x7684;&#x8BFB;socket, &#x628A;header&#x91CC;&#x9762;&#x5305;&#x542B;&#x7684;seq&#x5E8F;&#x53F7;, &#x901A;&#x8FC7;map&#x67E5;&#x5230;pending&#x7684;call&#x7ED3;&#x6784;&#x4F53;. &#x8BFB;reply&#x5230;&#x8FD9;&#x4E2A;call&#x7ED3;&#x6784;&#x4F53;, &#x5199;channel&#x901A;&#x77E5;client&#x672C;&#x6B21;call&#x5B8C;&#x6210;.</li>
</ul>
<h2 id="&#x95EE;&#x9898;&#x548C;&#x6539;&#x8FDB;&#x601D;&#x8DEF;"><a name="&#x95EE;&#x9898;&#x548C;&#x6539;&#x8FDB;&#x601D;&#x8DEF;" class="anchor-navigation-ex-anchor" href="#&#x95EE;&#x9898;&#x548C;&#x6539;&#x8FDB;&#x601D;&#x8DEF;"><i class="fa fa-link" aria-hidden="true"></i></a>6.3. &#x95EE;&#x9898;&#x548C;&#x6539;&#x8FDB;&#x601D;&#x8DEF;</h2>
<p>&#x4E2A;&#x4EBA;&#x611F;&#x89C9;&#x8FD9;&#x4E2A;RPC&#x5199;&#x7684;&#x4E00;&#x822C;, &#x5F88;&#x5570;&#x55E6;, &#x7528;seq&#x548C;map&#x6765;&#x8BB0;&#x5F55;&#x6BCF;&#x4E2A;call, server&#x4F1A;&#x539F;&#x5C01;&#x4E0D;&#x52A8;&#x7684;&#x628A;seq&#x8FD4;&#x56DE;&#x6765;, client&#x518D;&#x6839;&#x636E;seq&#x53F7;&#x67E5;&#x627E;&#x5230;&#x672C;&#x6B21;call&#x5B9E;&#x4F8B;. &#x8FD9;&#x91CC;&#x9762;&#x6709;map&#x7684;hash&#x8BA1;&#x7B97;, &#x6269;&#x5BB9;&#x7B49;&#x7B49;&#x6027;&#x80FD;&#x4E0D;&#x597D;&#x7684;&#x5730;&#x65B9;.<br>&#x6211;&#x7684;&#x60F3;&#x6CD5;&#x662F;, &#x65E2;&#x7136;server&#x8981;&#x628A;client&#x53D1;&#x9001;&#x7684;seq&#x53F7;&#x539F;&#x5C01;&#x4E0D;&#x52A8;&#x7684;&#x8FD4;&#x56DE;, &#x4F55;&#x4E0D;&#x5728;client&#x76F4;&#x63A5;&quot;&#x5C01;&#x88C5;&quot;chennel&#x4FE1;&#x606F;, server&#x7AEF;&#x8FD8;&#x662F;&#x539F;&#x5C01;&#x4E0D;&#x52A8;&#x8FD4;&#x56DE;, &#x8FD9;&#x6837;client&#x7684;input&#x5B88;&#x62A4;routine&#x5728;&#x6536;&#x5230;&#x56DE;&#x590D;&#x62A5;&#x6587;&#x7684;&#x65F6;&#x5019;, &#x5C31;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x7528;&#x8FD9;&#x4E2A;channel&#x4E86;, &#x7701;&#x6389;&#x4E86;hash map.<br>&#x4F46;input&#x5B88;&#x62A4;routine&#x662F;&#x6CA1;&#x6709;&#x529E;&#x6CD5;&#x7701;&#x6389;&#x7684;. &#x8FD9;&#x548C;routine&#x4E4B;&#x95F4;channel in channel&#x7684;RPC&#x4E0D;&#x540C;, &#x56E0;&#x4E3A;socket RPC&#x8DE8;&#x4E86;&#x8FDB;&#x7A0B;.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="as_title.html" class="navigation navigation-prev " aria-label="Previous page: 网络和消息中间件">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="golang_mango.html" class="navigation navigation-next " aria-label="Next page: 消息中间件mango">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"消息中间件基本概念和zero mq","level":"1.4.13.1","depth":3,"next":{"title":"消息中间件mango","level":"1.4.13.2","depth":3,"path":"notes/golang_mango.md","ref":"notes/golang_mango.md","articles":[]},"previous":{"title":"网络和消息中间件","level":"1.4.13","depth":2,"path":"notes/as_title.md","ref":"notes/as_title.md","articles":[{"title":"消息中间件基本概念和zero mq","level":"1.4.13.1","depth":3,"path":"notes/golang_zmq.md","ref":"notes/golang_zmq.md","articles":[]},{"title":"消息中间件mango","level":"1.4.13.2","depth":3,"path":"notes/golang_mango.md","ref":"notes/golang_mango.md","articles":[]},{"title":"p2p网络","level":"1.4.13.3","depth":3,"path":"notes/golang_libp2p.md","ref":"notes/golang_libp2p.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["-sharing","-lunr","-search","search-plus","-highlight","prism","prism-themes","expandable-chapters-small","github","disqus","splitter","wide-page","hide-navigation-buttons","anchor-navigation-ex"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"prism":{"css":["prism-themes/themes/prism-coldark-cold.css"]},"disqus":{"useIdentifier":false,"shortName":"bai-yingjie-notes"},"github":{"url":"https://github.com/Bai-Yingjie/Bai-Yingjie.github.io"},"splitter":{},"wide-page":{},"fontsettings":{"theme":"white","family":"sans","size":2},"hide-navigation-buttons":{},"anchor-navigation-ex":{"mode":"float","pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"isRewritePageTitle":true,"showLevel":true,"tocLevel1Icon":"fa fa-hand-o-right","tocLevel2Icon":"fa fa-hand-o-right","tocLevel3Icon":"fa fa-hand-o-right","showGoTop":true,"isShowTocTitleIcon":true,"printLog":false,"multipleH1":true,"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false}},"prism-themes":{},"expandable-chapters-small":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"theme":"default","author":"Bai Yingjie","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"My Notes","language":"zh-hans","gitbook":"*"},"file":{"path":"notes/golang_zmq.md","mtime":"2022-09-18T16:12:30.554Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-09-18T16:13:29.528Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

