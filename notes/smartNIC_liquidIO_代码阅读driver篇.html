
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>PCI-NIC 代码阅读 --driver篇 · My Notes</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Bai Yingjie">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-wide-page/wide.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hide-navigation-buttons/index.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="smartNIC_liquidIO_代码阅读真NIC篇.html" />
    
    
    <link rel="prev" href="smartNIC_liquidIO_代码阅读driver篇之结构体.html" />
    

    </head>
    <body>
        


<div class="book">
    <div class="book-summary">
        
            <div class="theme-code-header">
                <a href="" class="link">
                    <h1 class="title">My Notes</h1>
                </a>
            </div>
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    开源
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="my_opensource.html">
            
                <a href="my_opensource.html">
            
                    
                    我的开源项目
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="my_upstream.html">
            
                <a href="my_upstream.html">
            
                    
                    我的upstream commit
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    系统分析和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="system_analysis_bcc和ebpf.html">
            
                <a href="system_analysis_bcc和ebpf.html">
            
                    
                    bcc和ebpf(starting)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="performance_ovs进程调查.html">
            
                <a href="performance_ovs进程调查.html">
            
                    
                    OVS进程调查
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="performance_ping流程和函数调用解析.html">
            
                <a href="performance_ping流程和函数调用解析.html">
            
                    
                    ping流程和函数调用解析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="CentOS_系统性能优化配置.html">
            
                <a href="CentOS_系统性能优化配置.html">
            
                    
                    CentOS 性能优化系统配置
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    ARM server
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="arm_server_杂记.html">
            
                <a href="arm_server_杂记.html">
            
                    
                    Arm server 杂记
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    嵌入式系统开发调试
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="embedded_debugging.html">
            
                <a href="embedded_debugging.html">
            
                    
                    嵌入式调试杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="uboot_杂记.html">
            
                <a href="uboot_杂记.html">
            
                    
                    uboot杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="buildroot_杂记.html">
            
                <a href="buildroot_杂记.html">
            
                    
                    buildroot杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="toolchain_升级gcc问题解决.html">
            
                <a href="toolchain_升级gcc问题解决.html">
            
                    
                    升级GCC7.3问题解决
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Linux工程实践
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="linux_日常使用.html">
            
                <a href="linux_日常使用.html">
            
                    
                    日常linux使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="git_日常使用.html">
            
                <a href="git_日常使用.html">
            
                    
                    日常git使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="向kernel提交补丁.html">
            
                <a href="向kernel提交补丁.html">
            
                    
                    向kernel提交补丁
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="linux_ssh_relay.html">
            
                <a href="linux_ssh_relay.html">
            
                    
                    ssh relay
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="gitlab_ci.html">
            
                <a href="gitlab_ci.html">
            
                    
                    gitlab CI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="docker_操作记录.html">
            
                <a href="docker_操作记录.html">
            
                    
                    docker操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="centos_操作记录.html">
            
                <a href="centos_操作记录.html">
            
                    
                    centos操作记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Golang
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    入门
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1.1" data-path="golang_语法基础.html">
            
                <a href="golang_语法基础.html">
            
                    
                    Golang 语法基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.2" data-path="golang_json性能.html">
            
                <a href="golang_json性能.html">
            
                    
                    Golang json性能比较
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="golang_原理.html">
            
                <a href="golang_原理.html">
            
                    
                    Golang 原理相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.2.1" data-path="golang_interface原理.html">
            
                <a href="golang_interface原理.html">
            
                    
                    Golang interface原理(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.2" data-path="golang_内存分配.html">
            
                <a href="golang_内存分配.html">
            
                    
                    Golang 内存分配(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="golang_标准库.html">
            
                <a href="golang_标准库.html">
            
                    
                    Golang 标准库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="golang_我的反射代码.html">
            
                <a href="golang_我的反射代码.html">
            
                    
                    Golang 我的反射代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="golang_问答.html">
            
                <a href="golang_问答.html">
            
                    
                    Golang 问答
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="golang_高效go.html">
            
                <a href="golang_高效go.html">
            
                    
                    Golang 高效go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" data-path="golang_进阶.html">
            
                <a href="golang_进阶.html">
            
                    
                    Golang 进阶
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Golang 杂记
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.8.1" data-path="golang_杂记1.html">
            
                <a href="golang_杂记1.html">
            
                    
                    Golang 杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8.2" data-path="golang_杂记2.html">
            
                <a href="golang_杂记2.html">
            
                    
                    Golang 杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8.3" data-path="golang_杂记3.html">
            
                <a href="golang_杂记3.html">
            
                    
                    Golang 杂记3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8.4" data-path="golang_lib选型.html">
            
                <a href="golang_lib选型.html">
            
                    
                    Golang lib选型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8.5" data-path="golang_mod_proxy.html">
            
                <a href="golang_mod_proxy.html">
            
                    
                    go mod和go proxy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8.6" data-path="golang_汇编_arm64.html">
            
                <a href="golang_汇编_arm64.html">
            
                    
                    Golang 汇编语法和arm64小知识
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8.7" data-path="golang_cgo_swig.html">
            
                <a href="golang_cgo_swig.html">
            
                    
                    go调用c可以用swig
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.9" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Golang 环境和工具链生成
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.9.1" data-path="golang_toolchain_ppc.html">
            
                <a href="golang_toolchain_ppc.html">
            
                    
                    go tools增加ppc32支持.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9.2" data-path="golang_toolchain_compile_gccgo.html">
            
                <a href="golang_toolchain_compile_gccgo.html">
            
                    
                    编译gccgo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9.3" data-path="golang_go_on_mips.html">
            
                <a href="golang_go_on_mips.html">
            
                    
                    go on mips boards(not so updated)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.9.3.1" data-path="golang_go_on_mips_part1.html">
            
                <a href="golang_go_on_mips_part1.html">
            
                    
                    part 1: cross compile go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9.3.2" data-path="golang_go_on_mips_part2.html">
            
                <a href="golang_go_on_mips_part2.html">
            
                    
                    part 2: build native go compiler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9.3.3" data-path="golang_go_on_mips_part3.html">
            
                <a href="golang_go_on_mips_part3.html">
            
                    
                    part 3: gccgo experiments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9.3.4" data-path="golang_go_on_mips_part4.html">
            
                <a href="golang_go_on_mips_part4.html">
            
                    
                    part 4: Golang json performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9.3.5" data-path="golang_gentoo_on_mips_board_and_build_go.html">
            
                <a href="golang_gentoo_on_mips_board_and_build_go.html">
            
                    
                    Gentoo on mips board and build go
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.10" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    微服务
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.10.1" data-path="golang_micro.html">
            
                <a href="golang_micro.html">
            
                    
                    go-micro和micro
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.10.2" data-path="golang_微服务概念.html">
            
                <a href="golang_微服务概念.html">
            
                    
                    微服务概念
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.11" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    解释器和编解码
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.11.1" data-path="golang_yeagi.html">
            
                <a href="golang_yeagi.html">
            
                    
                    解释器yeagi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.11.2" data-path="golang_tengo.html">
            
                <a href="golang_tengo.html">
            
                    
                    解释器tengo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.11.3" data-path="golang_govaluate.html">
            
                <a href="golang_govaluate.html">
            
                    
                    解释器govaluate
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.11.4" data-path="golang_encoding_gotiny.html">
            
                <a href="golang_encoding_gotiny.html">
            
                    
                    gotiny编解码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.11.5" data-path="golang_abs.html">
            
                <a href="golang_abs.html">
            
                    
                    解释器abs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.12" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    调试和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.12.1" data-path="golang_调试记录.html">
            
                <a href="golang_调试记录.html">
            
                    
                    Golang 调试记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.12.2" data-path="golang_topid性能优化.html">
            
                <a href="golang_topid性能优化.html">
            
                    
                    Golang topid性能优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.12.3" data-path="golang_gshell性能调试.html">
            
                <a href="golang_gshell性能调试.html">
            
                    
                    Golang gshell性能调试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.13" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    网络和消息中间件
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.13.1" data-path="golang_zmq.html">
            
                <a href="golang_zmq.html">
            
                    
                    消息中间件基本概念和zero mq
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.13.2" data-path="golang_mango.html">
            
                <a href="golang_mango.html">
            
                    
                    消息中间件mango
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.13.3" data-path="golang_libp2p.html">
            
                <a href="golang_libp2p.html">
            
                    
                    Golang p2p网络
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Rust
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="rust_入门_brief.html">
            
                <a href="rust_入门_brief.html">
            
                    
                    Rust 入门系列
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1.1" data-path="rust_books.html">
            
                <a href="rust_books.html">
            
                    
                    Rust reference books
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.2" data-path="rust_入门1.html">
            
                <a href="rust_入门1.html">
            
                    
                    Rust 安装和基础语法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.3" data-path="rust_入门2.html">
            
                <a href="rust_入门2.html">
            
                    
                    Rust 泛型和内存所有权
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.4" data-path="rust_入门3.html">
            
                <a href="rust_入门3.html">
            
                    
                    Rust 闭包 容器 迭代器 生成器 线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.5" data-path="rust_工程构建.html">
            
                <a href="rust_工程构建.html">
            
                    
                    Rust 工程构建
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="rust_coding_brief.html">
            
                <a href="rust_coding_brief.html">
            
                    
                    Rust 代码积累
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.2.1" data-path="rust_序列化.html">
            
                <a href="rust_序列化.html">
            
                    
                    Rust 序列化原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.2" data-path="rust_知识点积累.html">
            
                <a href="rust_知识点积累.html">
            
                    
                    Rust 知识点更新
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.3" data-path="rust_adaptiveservice.html">
            
                <a href="rust_adaptiveservice.html">
            
                    
                    rust版本的adaptiveservice探索
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.4" data-path="rust_常用设施.html">
            
                <a href="rust_常用设施.html">
            
                    
                    Rust 常用设施
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.5" data-path="rust_代码小段.html">
            
                <a href="rust_代码小段.html">
            
                    
                    Rust 代码小段
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="others.html">
            
                <a href="others.html">
            
                    
                    其他
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.3.1" data-path="rust_mdbook_使用.html">
            
                <a href="rust_mdbook_使用.html">
            
                    
                    Rust 使用mdbook
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    C开发
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="c_automake_autoconf.html">
            
                <a href="c_automake_autoconf.html">
            
                    
                    automake autoconf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="makefile_原理和实践.html">
            
                <a href="makefile_原理和实践.html">
            
                    
                    makefile
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="c_编程杂记高级篇.html">
            
                <a href="c_编程杂记高级篇.html">
            
                    
                    C编程杂记高级篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="c_编程杂记基础篇.html">
            
                <a href="c_编程杂记基础篇.html">
            
                    
                    C编程杂记基础篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5" data-path="c_networking_socket高阶用法.html">
            
                <a href="c_networking_socket高阶用法.html">
            
                    
                    网络编程: Advanced Socket Topics(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.6" data-path="c_protobuf介绍.html">
            
                <a href="c_protobuf介绍.html">
            
                    
                    序列化: protobuf介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.7" data-path="c_进程间通信_共享文件和共享内存.html">
            
                <a href="c_进程间通信_共享文件和共享内存.html">
            
                    
                    进程间通信: 共享文件和共享内存(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.8" data-path="c_pthread_condition和mutex.html">
            
                <a href="c_pthread_condition和mutex.html">
            
                    
                    并发 任务 事件 和锁.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.9" data-path="kernel_user_space_howto.html">
            
                <a href="kernel_user_space_howto.html">
            
                    
                    kernel space和user space交互(网摘, linux2.6)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    脚本
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="shell_变量.html">
            
                <a href="shell_变量.html">
            
                    
                    shell变量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="shell_基础篇.html">
            
                <a href="shell_基础篇.html">
            
                    
                    shell命令和脚本记录-基础篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="shell_高级篇.html">
            
                <a href="shell_高级篇.html">
            
                    
                    shell命令和脚本记录-高级篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="shell_脚本片段.html">
            
                <a href="shell_脚本片段.html">
            
                    
                    shell脚本片段
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="python_记录.html">
            
                <a href="python_记录.html">
            
                    
                    python记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6" data-path="lua_记录.html">
            
                <a href="lua_记录.html">
            
                    
                    lua记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.7" data-path="shell_rds脚本阅读.html">
            
                <a href="shell_rds脚本阅读.html">
            
                    
                    RDS脚本阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8" data-path="Project_Euler.html">
            
                <a href="Project_Euler.html">
            
                    
                    Project Euler
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    cloud和容器相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="cloud_杂记.html">
            
                <a href="cloud_杂记.html">
            
                    
                    云杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="container_当代容器读书笔记.html">
            
                <a href="container_当代容器读书笔记.html">
            
                    
                    当代容器读书笔记
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Operating System
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="system_libc_part1.html">
            
                <a href="system_libc_part1.html">
            
                    
                    libc概览1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="system_libc_part2.html">
            
                <a href="system_libc_part2.html">
            
                    
                    libc概览2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="system_libc_part3.html">
            
                <a href="system_libc_part3.html">
            
                    
                    libc概览3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.4" data-path="system_原理杂记.html">
            
                <a href="system_原理杂记.html">
            
                    
                    系统原理杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.5" data-path="system_alpine.html">
            
                <a href="system_alpine.html">
            
                    
                    Alpine Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.6" data-path="system_进程间通信.html">
            
                <a href="system_进程间通信.html">
            
                    
                    进程间通信
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.7" data-path="system_特殊功能fd.html">
            
                <a href="system_特殊功能fd.html">
            
                    
                    eventfd timerfd signalfd和fd共享
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    CPU和device虚拟化
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    gvisor
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1.1" data-path="golang_gvisor代码_KVM.html">
            
                <a href="golang_gvisor代码_KVM.html">
            
                    
                    gvisor KVM模式代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.1.2" data-path="golang_gvisor调试.html">
            
                <a href="golang_gvisor调试.html">
            
                    
                    gvisor调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.1.3" data-path="golang_gvisor_ptrace.html">
            
                <a href="golang_gvisor_ptrace.html">
            
                    
                    gvisor ptrace模式介绍(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13.2" data-path="rust_vmm_brief.html">
            
                <a href="rust_vmm_brief.html">
            
                    
                    rust VMM(virtual machine monitor)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.2.1" data-path="rust_vmm_简介.html">
            
                <a href="rust_vmm_简介.html">
            
                    
                    rust-vmm简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2.2" data-path="rust_firecracker_代码.html">
            
                <a href="rust_firecracker_代码.html">
            
                    
                    firecracker代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2.3" data-path="rust_firecracker_使用.html">
            
                <a href="rust_firecracker_使用.html">
            
                    
                    firecracker使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2.4" data-path="rust_cloud-hypervisor_代码.html">
            
                <a href="rust_cloud-hypervisor_代码.html">
            
                    
                    cloud hypervisor代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2.5" data-path="rust_cloud-hypervisor_使用.html">
            
                <a href="rust_cloud-hypervisor_使用.html">
            
                    
                    cloud hypervisor使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2.6" data-path="rust_cloud-hypervisor_问题与解决.html">
            
                <a href="rust_cloud-hypervisor_问题与解决.html">
            
                    
                    cloud hypervisor问题与解决
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13.3" data-path="virtualization_virtio规范阅读笔记.html">
            
                <a href="virtualization_virtio规范阅读笔记.html">
            
                    
                    virtio规范阅读笔记.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.4" data-path="qemu_ovs_虚拟化环境.html">
            
                <a href="qemu_ovs_虚拟化环境.html">
            
                    
                    qemu OVS 虚拟化环境准备
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.5" data-path="qemu使用.html">
            
                <a href="qemu使用.html">
            
                    
                    Qemu使用(old)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    计算机网络相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" data-path="networking_杂记1.html">
            
                <a href="networking_杂记1.html">
            
                    
                    networking杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Qemu OVS和DPDK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.2.1" data-path="OVS_DPDK_编译运行.html">
            
                <a href="OVS_DPDK_编译运行.html">
            
                    
                    OVS-DPDK编译运行
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2.2" data-path="OVS_架构和代码.html">
            
                <a href="OVS_架构和代码.html">
            
                    
                    OVS架构和代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2.3" data-path="OVS_DPDK_performance_HXT_ARM_server.html">
            
                <a href="OVS_DPDK_performance_HXT_ARM_server.html">
            
                    
                    OVS-DPDK for ARM server 性能测试环境
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2.4" data-path="DPDK_Mellanox.html">
            
                <a href="DPDK_Mellanox.html">
            
                    
                    DPDK Mellanox
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2.5" data-path="OVS_phy-vm-phy.html">
            
                <a href="OVS_phy-vm-phy.html">
            
                    
                    OVS PHY-VM-PHY
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2.6" data-path="networking_网络虚拟化用例记录.html">
            
                <a href="networking_网络虚拟化用例记录.html">
            
                    
                    网络虚拟化用例记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2.7" data-path="networking_网络虚拟化操作记录.html">
            
                <a href="networking_网络虚拟化操作记录.html">
            
                    
                    网络虚拟化操作记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    虚拟化网络
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.3.1" data-path="networking_tc_filter_连接veth和tap.html">
            
                <a href="networking_tc_filter_连接veth和tap.html">
            
                    
                    Connecting a veth device to tap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.3.2" data-path="networking_multicast_vxlan_flannel.html">
            
                <a href="networking_multicast_vxlan_flannel.html">
            
                    
                    multicast vxlan和flannel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.3.3" data-path="networking_virtio网络介绍.html">
            
                <a href="networking_virtio网络介绍.html">
            
                    
                    virtio网络介绍(网摘): vhost-net virtio-net vhost-user SRIOV
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.3.4" data-path="networking_virtualization_杂记.html">
            
                <a href="networking_virtualization_杂记.html">
            
                    
                    虚拟化网络杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.3.5" data-path="networking_linux虚拟网络接口.html">
            
                <a href="networking_linux虚拟网络接口.html">
            
                    
                    linux虚拟网络接口(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    内核 设备和驱动相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.1" data-path="driver_驱动中使用工作队列轮询.html">
            
                <a href="driver_驱动中使用工作队列轮询.html">
            
                    
                    驱动中使用工作队列轮询
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="device_driver_杂记.html">
            
                <a href="device_driver_杂记.html">
            
                    
                    驱动调试杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.3" data-path="device_driver_原理相关.html">
            
                <a href="device_driver_原理相关.html">
            
                    
                    kernel和驱动原理相关
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.4" data-path="device_localbus_16bit读写.html">
            
                <a href="device_localbus_16bit读写.html">
            
                    
                    CPLD做8bit到16bit转换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.5" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    nand
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.5.1" data-path="device_driver_octeon_nand.html">
            
                <a href="device_driver_octeon_nand.html">
            
                    
                    octeon nand flash驱动
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.5.2" data-path="device_driver_nand概率写失败问题分析.html">
            
                <a href="device_driver_nand概率写失败问题分析.html">
            
                    
                    Nand flash概率写失败问题分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15.6" data-path="octeon_remote_pci.html">
            
                <a href="octeon_remote_pci.html">
            
                    
                    octeon remote-pci.c阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.7" data-path="Device_VFIO_notes.html">
            
                <a href="Device_VFIO_notes.html">
            
                    
                    VFIO简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    智能网卡和DPDK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.8.1" data-path="smartNIC_智能网卡对比.html">
            
                <a href="smartNIC_智能网卡对比.html">
            
                    
                    智能网卡对比
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8.2" data-path="octeon_pci_NIC.html">
            
                <a href="octeon_pci_NIC.html">
            
                    
                    octeon PCI NIC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    octeon liquidIO
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.8.3.1" data-path="smartNIC_liquidIO_代码阅读app篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读app篇.html">
            
                    
                    PCI-NIC 代码阅读 --app篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8.3.2" data-path="smartNIC_liquidIO_代码阅读api篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读api篇.html">
            
                    
                    PCI-NIC 代码阅读 --api篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8.3.3" data-path="smartNIC_liquidIO_代码阅读driver篇之结构体.html">
            
                <a href="smartNIC_liquidIO_代码阅读driver篇之结构体.html">
            
                    
                    PCI-NIC 代码阅读 --driver篇之结构体
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.15.8.3.4" data-path="smartNIC_liquidIO_代码阅读driver篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读driver篇.html">
            
                    
                    PCI-NIC 代码阅读 --driver篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8.3.5" data-path="smartNIC_liquidIO_代码阅读真NIC篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读真NIC篇.html">
            
                    
                    PCI-NIC 代码阅读 --真NIC篇
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15.8.4" data-path="networking_dpdk使用_2014.html">
            
                <a href="networking_dpdk使用_2014.html">
            
                    
                    DPDK使用(2014)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15.9" data-path="device_nvme要点介绍.html">
            
                <a href="device_nvme要点介绍.html">
            
                    
                    nvme要点介绍
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    CPU Arch相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    ARM64
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1.1" data-path="CPU_ARM64_thunder_overview.html">
            
                <a href="CPU_ARM64_thunder_overview.html">
            
                    
                    thunder 概览
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.1.2" data-path="CPU_ARM64_thunder_开发板操作记录.html">
            
                <a href="CPU_ARM64_thunder_开发板操作记录.html">
            
                    
                    thunder 开发板操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.1.3" data-path="CPU_ARM64_thunder_bdk.html">
            
                <a href="CPU_ARM64_thunder_bdk.html">
            
                    
                    thunder BDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.1.4" data-path="CPU_ARM64_thunder_efi_rtc.html">
            
                <a href="CPU_ARM64_thunder_efi_rtc.html">
            
                    
                    thunder RTC时间和efi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.1.5" data-path="CPU_ARM64_thunder_uefi_fdt.html">
            
                <a href="CPU_ARM64_thunder_uefi_fdt.html">
            
                    
                    thunder uefi和fdt
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.1.6" data-path="CPU_ARM64_thunder_atf.html">
            
                <a href="CPU_ARM64_thunder_atf.html">
            
                    
                    thunder atf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.1.7" data-path="CPU_ARM64_thunder_kernel_boot.html">
            
                <a href="CPU_ARM64_thunder_kernel_boot.html">
            
                    
                    thunder kernel启动打印流程
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.2" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    PPC
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.2.1" data-path="CPU_PPC启动多核Linux_流程和内存映射.html">
            
                <a href="CPU_PPC启动多核Linux_流程和内存映射.html">
            
                    
                    PPC启动多核linux: 流程和内存映射
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.2.2" data-path="CPU_PPC_kernel升级记录.html">
            
                <a href="CPU_PPC_kernel升级记录.html">
            
                    
                    PPC kernel升级记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    MIPS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.3.1" data-path="CPU_MIPS_octeon地址空间和寄存器访问.html">
            
                <a href="CPU_MIPS_octeon地址空间和寄存器访问.html">
            
                    
                    octeon 地址空间和寄存器访问
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.2" data-path="CPU_MIPS_octeon操作记录.html">
            
                <a href="CPU_MIPS_octeon操作记录.html">
            
                    
                    octeon 操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.3" data-path="CPU_MIPS_octeon_包处理性能.html">
            
                <a href="CPU_MIPS_octeon_包处理性能.html">
            
                    
                    octeon 系列处理器包处理性能
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.4" data-path="CPU_MIPS_octeon_ddr调试记录.html">
            
                <a href="CPU_MIPS_octeon_ddr调试记录.html">
            
                    
                    octeon DDR调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.5" data-path="CPU_MIPS_octeon_BDK.html">
            
                <a href="CPU_MIPS_octeon_BDK.html">
            
                    
                    octeon CN78xx BDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.6" data-path="kernel_增加ECC中断.html">
            
                <a href="kernel_增加ECC中断.html">
            
                    
                    octeon 增加ECC中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.7" data-path="CPU_MIPS_octeon_hw-ddr2代码走读.html">
            
                <a href="CPU_MIPS_octeon_hw-ddr2代码走读.html">
            
                    
                    octeon hw-ddr2代码走读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.8" data-path="CPU_MIPS_octeon_reboot调试和ddr中断.html">
            
                <a href="CPU_MIPS_octeon_reboot调试和ddr中断.html">
            
                    
                    octeon reboot调试和DDR中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.9" data-path="CPU_MIPS_octeon中断.html">
            
                <a href="CPU_MIPS_octeon中断.html">
            
                    
                    octeon 中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.10" data-path="CPU_MIPS_octeon原子操作.html">
            
                <a href="CPU_MIPS_octeon原子操作.html">
            
                    
                    octeon 原子操作
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.11" data-path="CPU_MIPS_octeon网口代码分析.html">
            
                <a href="CPU_MIPS_octeon网口代码分析.html">
            
                    
                    octeon 网口代码分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="" target="_blank" class="gitbook-link">
            Author: Bai Yingjie
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >PCI-NIC 代码阅读 --driver篇</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;"><b>1. </b>&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;</a></li><li><span class="title-icon "></span><a href="#&#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spinlock&#x548C;atomic&#x53D8;&#x91CF;"><b>2. </b>&#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spin_lock&#x548C;atomic&#x53D8;&#x91CF;</a></li><li><span class="title-icon "></span><a href="#&#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;"><b>3. </b>&#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;</a></li><li><span class="title-icon "></span><a href="#&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;"><b>4. </b>&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;</a></li><li><span class="title-icon "></span><a href="#pci-base-driver&#x6A21;&#x5757;"><b>5. </b>pci base driver&#x6A21;&#x5757;</a></li><ul><li><span class="title-icon "></span><a href="#a-pci&#x9A71;&#x52A8;"><b>5.1. </b>A. pci&#x9A71;&#x52A8;</a></li><ul><li><span class="title-icon "></span><a href="#a1-octeon&#x7684;pci-probe&#x51FD;&#x6570;"><b>5.1.1. </b>A1. octeon&#x7684;pci probe&#x51FD;&#x6570;</a></li></ul><li><span class="title-icon "></span><a href="#b-octpollthread-&#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;"><b>5.2. </b>B. oct_poll_thread, &#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;</a></li><li><span class="title-icon "></span><a href="#c-octeonfops-&#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl"><b>5.3. </b>C. octeon_fops: &#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl</a></li><ul><li><span class="title-icon "></span><a href="#c1-octeonioctl"><b>5.3.1. </b>C1. octeon_ioctl</a></li></ul><li><span class="title-icon "></span><a href="#&#x4E2D;&#x65AD;&#x5904;&#x7406;-&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;"><b>5.4. </b>&#x4E2D;&#x65AD;&#x5904;&#x7406; :&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;</a></li><ul><li><span class="title-icon "></span><a href="#int1-octeondroqbh-&#x89C1;a19"><b>5.4.1. </b>INT1. octeon_droq_bh, &#x89C1;A19</a></li><li><span class="title-icon "></span><a href="#int2-octeonrequestcompletionbh-&#x548C;a15&#x51E0;&#x4E4E;&#x4E00;&#x6837;"><b>5.4.2. </b>INT2. octeon_request_completion_bh, &#x548C;A15&#x51E0;&#x4E4E;&#x4E00;&#x6837;</a></li></ul></ul></ul></div><a href="#&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><ul>
<li><a href="#&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;">&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;</a></li>
<li><a href="#&#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spin_lock&#x548C;atomic&#x53D8;&#x91CF;">&#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spin_lock&#x548C;atomic&#x53D8;&#x91CF;</a></li>
<li><a href="#&#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;">&#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;</a></li>
<li><a href="#&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;">&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;</a></li>
<li><a href="#pci-base-driver&#x6A21;&#x5757;">pci base driver&#x6A21;&#x5757;</a><ul>
<li><a href="#a-pci&#x9A71;&#x52A8;">A. pci&#x9A71;&#x52A8;</a><ul>
<li><a href="#a1-octeon&#x7684;pci-probe&#x51FD;&#x6570;">A1. octeon&#x7684;pci probe&#x51FD;&#x6570;</a><ul>
<li><a href="#a11-&#x5982;&#x4F55;osi-&#x5230;&#x5E95;&#x54EA;&#x4E9B;&#x662F;osi&#x7684;-&#x54EA;&#x4E9B;&#x53C8;&#x4E0D;&#x662F;">A11. &#x5982;&#x4F55;osi? &#x5230;&#x5E95;&#x54EA;&#x4E9B;&#x662F;osi&#x7684;? &#x54EA;&#x4E9B;&#x53C8;&#x4E0D;&#x662F;?</a></li>
<li><a href="#a12cn66xx&#x7684;&#x914D;&#x7F6E;&#x8868;">A12.cn66xx&#x7684;&#x914D;&#x7F6E;&#x8868;</a></li>
<li><a href="#a13-oct_poll_module_starter">A13. oct_poll_module_starter</a></li>
<li><a href="#a14-check_db_timeout--doorbell-timeout-&#x5468;&#x671F;1&#x4E2A;tick">A14. check_db_timeout  &quot;Doorbell Timeout&quot;, &#x5468;&#x671F;1&#x4E2A;tick</a><ul>
<li><a href="#a141-octeon_pci_map_single&#x548C;octeon_pci_unmap_single">A141. octeon_pci_map_single&#x548C;octeon_pci_unmap_single</a></li>
<li><a href="#a142-&#x5185;&#x5B58;&#x7533;&#x8BF7;&#x53CA;&#x91CA;&#x653E;">A142. &#x5185;&#x5B58;&#x7533;&#x8BF7;&#x53CA;&#x91CA;&#x653E;</a></li>
</ul>
</li>
<li><a href="#a15-oct_poll_req_completion-1&#x4E2A;tick">A15. oct_poll_req_completion, 1&#x4E2A;tick</a></li>
<li><a href="#a16-oct_poll_check_unordered_list">A16. oct_poll_check_unordered_list</a></li>
<li><a href="#a17-check_droq_refill-&#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;">A17. check_droq_refill, &#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;</a><ul>
<li><a href="#a171-octeon_droq_refill">A171. octeon_droq_refill</a></li>
</ul>
</li>
<li><a href="#a18-oct_droq_thread-&#x6536;&#x5305;&#x7EBF;&#x7A0B;-&#x6BCF;&#x4E2A;output-q&#x4E00;&#x4E2A;">A18. oct_droq_thread, &#x6536;&#x5305;&#x7EBF;&#x7A0B;, &#x6BCF;&#x4E2A;output q&#x4E00;&#x4E2A;</a><ul>
<li><a href="#a181-octeon_register_dispatch_fn-&#x6CE8;&#x518C;&#x6536;&#x5305;&#x5BF9;&#x5E94;&#x7684;opcode&#x51FD;&#x6570;">A181. octeon_register_dispatch_fn() &#x6CE8;&#x518C;&#x6536;&#x5305;&#x5BF9;&#x5E94;&#x7684;opcode&#x51FD;&#x6570;</a></li>
<li><a href="#a182-octeon_create_recv_info-&#x4ECE;&#x9A71;&#x52A8;&#x5C42;&#x5230;&#x5206;&#x53D1;&#x5C42;-&#x6BCF;&#x4E2A;&#x6765;&#x7684;&#x62A5;&#x6587;&#x90FD;&#x4F1A;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;">A182. octeon_create_recv_info(), &#x4ECE;&#x9A71;&#x52A8;&#x5C42;&#x5230;&#x5206;&#x53D1;&#x5C42;, &#x6BCF;&#x4E2A;&#x6765;&#x7684;&#x62A5;&#x6587;&#x90FD;&#x4F1A;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;</a></li>
</ul>
</li>
<li><a href="#a19-octeon_droq_bh">A19. octeon_droq_bh</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#b-oct_poll_thread-&#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;">B. oct_poll_thread, &#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;</a></li>
<li><a href="#c-octeon_fops-&#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl">C. octeon_fops: &#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl</a><ul>
<li><a href="#c1-octeon_ioctl">C1. octeon_ioctl</a><ul>
<li><a href="#c11oct_poll_module_starter">C11.oct_poll_module_starter()</a></li>
<li><a href="#c12octeon_ioctl_send_request">C12.octeon_ioctl_send_request</a><ul>
<li><a href="#c121-octeon_copy_input_dma_buffers--&#x65B0;&#x7533;&#x8BF7;&#x5185;&#x6838;&#x6001;&#x7684;input-buffer-&#x5E76;&#x628A;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;data&#x62F7;&#x8FDB;&#x6765;">C121. octeon_copy_input_dma_buffers : &#x65B0;&#x7533;&#x8BF7;&#x5185;&#x6838;&#x6001;&#x7684;input buffer, &#x5E76;&#x628A;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;data&#x62F7;&#x8FDB;&#x6765;</a></li>
<li><a href="#c122-octeon_create_output_dma_buffers--&#x5C06;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;output-buffer&#x5728;&#x5185;&#x6838;&#x6001;&#x4E5F;&#x7533;&#x8BF7;&#x4E00;&#x4EFD;">C122. octeon_create_output_dma_buffers : &#x5C06;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;output buffer&#x5728;&#x5185;&#x6838;&#x6001;&#x4E5F;&#x7533;&#x8BF7;&#x4E00;&#x4EFD;</a></li>
<li><a href="#c123-octeon_create_data_buf">C123. octeon_create_data_buf</a><ul>
<li><a href="#c1231-octeon_create_sg_list">C1231. octeon_create_sg_list</a></li>
</ul>
</li>
<li><a href="#c124-&#x4E3B;&#x8981;&#x7684;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;">C124. &#x4E3B;&#x8981;&#x7684;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#&#x4E2D;&#x65AD;&#x5904;&#x7406;-&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;">&#x4E2D;&#x65AD;&#x5904;&#x7406; :&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;</a><ul>
<li><a href="#int1-octeon_droq_bh-&#x89C1;a19">INT1. octeon_droq_bh, &#x89C1;A19</a></li>
<li><a href="#int2-octeon_request_completion_bh-&#x548C;a15&#x51E0;&#x4E4E;&#x4E00;&#x6837;">INT2. octeon_request_completion_bh, &#x548C;A15&#x51E0;&#x4E4E;&#x4E00;&#x6837;</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;"><a name="&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;" class="anchor-navigation-ex-anchor" href="#&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;"><i class="fa fa-link" aria-hidden="true"></i></a>1. &#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;</h1>
<p>&#x5B9A;&#x4E49;<code>CAVIUM_DEBUG PRINT_FLOW</code><br>&#x6216;<code>CAVIUM_DEBUG PRINT_ALL</code><br>&#x8FD8;&#x53EF;&#x4EE5;&#x7528;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6253;&#x5370;droq&#x4FE1;&#x606F;:
<code>oct_dump_droq_state(octeon_droq_t   *oq)</code></p>
<h1 id="&#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spinlock&#x548C;atomic&#x53D8;&#x91CF;"><a name="&#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spinlock&#x548C;atomic&#x53D8;&#x91CF;" class="anchor-navigation-ex-anchor" href="#&#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spinlock&#x548C;atomic&#x53D8;&#x91CF;"><i class="fa fa-link" aria-hidden="true"></i></a>2. &#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spin_lock&#x548C;atomic&#x53D8;&#x91CF;</h1>
<p>&#x51E0;&#x4E4E;&#x6BCF;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x90FD;&#x6709;<code>spin_lock</code>&#x4FDD;&#x62A4;, &#x6BD4;&#x5982;pending list&#x5C31;&#x6709;<br><code>cavium_spin_lock_init(&amp;oct-&gt;plist-&gt;lock);</code>
&#x63A5;&#x7740;&#x8FD8;&#x6709;atomic&#x53D8;&#x91CF;<br><code>cavium_atomic_set(&amp;oct-&gt;plist-&gt;instr_count, 0);</code></p>
<h1 id="&#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;"><a name="&#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;" class="anchor-navigation-ex-anchor" href="#&#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;"><i class="fa fa-link" aria-hidden="true"></i></a>3. &#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;</h1>
<pre><code>resp_order == OCTEON_RESP_ORDERED
    : resp_list = OCTEON_ORDERED_LIST
    : &#x7531;process_ordered_list()&#x5904;&#x7406;, &#x89C1;A15

resp_order == OCTEON_RESP_UNORDERED &amp;&amp; resp_mode == OCTEON_RESP_BLOCKING
    : resp_list = OCTEON_UNORDERED_BLOCKING_LIST
    : &#x7531;check_unordered_blocking_list()&#x5904;&#x7406;, &#x89C1;A15

resp_order == OCTEON_RESP_UNORDERED &amp;&amp; resp_mode == OCTEON_RESP_NON_BLOCKING
    : resp_list = OCTEON_UNORDERED_NONBLOCKING_LIST
    : &#x7531;oct_poll_check_unordered_list()&#x5904;&#x7406;, &#x4F46;&#x88AB;&#x6CE8;&#x91CA;&#x6389;&#x4E86;?, &#x89C1;A16
</code></pre><h1 id="&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;"><a name="&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;" class="anchor-navigation-ex-anchor" href="#&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;"><i class="fa fa-link" aria-hidden="true"></i></a>4. &#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;</h1>
<pre><code class="lang-c">octeon_ioctl_send_request
    __do_request_processing()
        __do_instruction_processing();

oct_test_thread()
    send_test_packet()
        octeon_process_request()
            __do_request_processing()
                __do_instruction_processing();

perf_test_loop()
    octeon_process_request()
        __do_request_processing()
            __do_instruction_processing();

cn56xx_send_peer_to_peer_map()----&#x6CE8;&#x610F;: nic&#x6A21;&#x5757;&#x4E5F;&#x4F1A;&#x8C03;&#x7528;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;
    octeon_process_instruction()
        __do_instruction_processing();

octeon_destroy_resources()
    octeon_send_short_command()
        __do_instruction_processing();

octeon_hot_reset()
    octeon_send_short_command()
        __do_instruction_processing();

octeon_shutdown_output_queue()
    octeon_send_short_command()
        __do_instruction_processing();

octeon_restart_output_queue()
    octeon_send_short_command()
        __do_instruction_processing();
</code></pre>
<h1 id="pci-base-driver&#x6A21;&#x5757;"><a name="pci-base-driver&#x6A21;&#x5757;" class="anchor-navigation-ex-anchor" href="#pci-base-driver&#x6A21;&#x5757;"><i class="fa fa-link" aria-hidden="true"></i></a>5. pci base driver&#x6A21;&#x5757;</h1>
<p><code>components/driver/host/driver/linux/octeon_linux.c</code></p>
<pre><code class="lang-c">module_init(octeon_base_init_module);
    //&#x6253;&#x5370;&#x4E00;&#x4E9B;&#x7CFB;&#x7EDF;&#x7279;&#x5F81;&#x4FE1;&#x606F;, &#x5927;&#x5C0F;&#x7AEF;, HZ, &#x7F16;&#x8BD1;&#x5B8F;&#x5F00;&#x5173;&#x7B49;, &#x8FD9;&#x662F;&#x5F88;&#x597D;&#x7684;&#x67B6;&#x6784;&#x8BBE;&#x8BA1;&#x4E60;&#x60EF;
    octeon_state = OCT_DRV_DEVICE_INIT_START;
    //&#x6E05;&#x96F6;octeon device&#x6570;&#x7EC4;, &#x5171;4&#x4E2A;
    octeon_init_device_list();
    //&#x6E05;&#x96F6;octmodhandlers&#x6570;&#x7EC4;, 3&#x4E2A;
    octeon_init_module_handler_list(); //&#x89C1;PCI-NIC &#x4EE3;&#x7801;&#x9605;&#x8BFB;&#x4E4B;driver&#x7BC7;(&#x7ED3;&#x6784;&#x4F53;)&#x4E4B;octeon_module_handler_t
    //&#x6CE8;&#x518C;pci&#x9A71;&#x52A8;, &#x89C1;A
    ret = pci_register_driver(&amp;octeon_pci_driver); //&#x7B80;&#x5355;&#x8BBE;&#x7F6E;&#x4E86;driver&#x7684;bus&#x7B49;&#x5C5E;&#x6027;&#x540E;, &#x8FD8;&#x662F;&#x8C03;&#x7528;driver_register(&amp;drv-&gt;driver)
    octeon_state = OCT_DRV_DEVICE_INIT_DONE;
    //&#x521D;&#x59CB;&#x5316;poll&#x8FDB;&#x7A0B;
    octeon_init_poll_thread()
        //&#x8868;&#x793A;kthread&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x89C1;PCI-NIC &#x4EE3;&#x7801;&#x9605;&#x8BFB;&#x4E4B;driver&#x7BC7;(&#x7ED3;&#x6784;&#x4F53;)G2
        //&#x8FDB;&#x7A0B;&#x4E3B;&#x4F53;&#x662F;oct_poll_thread, &#x89C1;B
        cavium_kthread_setup(&amp;oct_poll_id, oct_poll_thread, NULL, &quot;Oct Poll Thread&quot;, 1);
        cavium_kthread_create()
            t-&gt;id = kthread_create(t-&gt;fn, t-&gt;fn_arg, t-&gt;fn_string);
            if(t-&gt;exec_on_create)
                wake_up_process(t-&gt;id);
    octeon_state = OCT_DRV_POLL_INIT_DONE;
    //&#x6CE8;&#x518C;&#x5B57;&#x7B26;&#x8BBE;&#x5907;/dev/octeon_device, &#x89C1;C
    ret = register_chrdev(OCTEON_DEVICE_MAJOR, DRIVER_NAME,&amp;octeon_fops);
    octeon_state = OCT_DRV_REGISTER_DONE;
</code></pre>
<h2 id="a-pci&#x9A71;&#x52A8;"><a name="a-pci&#x9A71;&#x52A8;" class="anchor-navigation-ex-anchor" href="#a-pci&#x9A71;&#x52A8;"><i class="fa fa-link" aria-hidden="true"></i></a>5.1. A. pci&#x9A71;&#x52A8;</h2>
<pre><code class="lang-c">static struct pci_driver octeon_pci_driver = {
    .name     = &quot;Octeon&quot;,
    .id_table = octeon_pci_tbl, //&#x5305;&#x62EC;&#x4E86;6XXX&#x5168;&#x7CFB;&#x5217;&#x7684;PCI ID
    .probe    = octeon_probe, //&#x89C1;A1
    .remove   = __devexit_p(octeon_remove),
};
</code></pre>
<h3 id="a1-octeon&#x7684;pci-probe&#x51FD;&#x6570;"><a name="a1-octeon&#x7684;pci-probe&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#a1-octeon&#x7684;pci-probe&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>5.1.1. A1. octeon&#x7684;pci probe&#x51FD;&#x6570;</h3>
<p><code>components/driver/host/driver/linux/octeon_main.c</code></p>
<pre><code class="lang-c">octeon_probe(struct pci_dev *pdev, const struct pci_device_id *ent)
    //&#x9996;&#x5148;&#x8981;hold&#x4E00;&#x4E2A;octeon_device_t, &#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;
    octeon_device_t  *oct_dev=NULL;
    /*&#x8FD9;&#x91CC;&#x5148;&#x6253;&#x5370;(uint32_t)pdev-&gt;vendor, (uint32_t)pdev-&gt;device
    **&#x8FD9;&#x662F;linux&#x9A71;&#x52A8;core&#x5C42;&#x5339;&#x914D;&#x597D;pci&#x8BBE;&#x5907;&#x540E;&#x4F20;&#x5165;&#x7684;
    **&#x5982;&#x679C;&#x8981;&#x6539;&#x4E3A;&#x7528;&#x6237;&#x6001;,&#x53C2;&#x8003;remote-pci&#x7684;&#x65B9;&#x5F0F;&#x627E;octeon&#x8BBE;&#x5907;
    */
    /*&#x7533;&#x8BF7;&#x5168;&#x5C40;&#x53D8;&#x91CF;octeon_device[4]&#x7684;&#x5185;&#x5B58;
    **&#x8FD9;&#x662F;&#x4E2A;osi&#x7684;&#x63A5;&#x53E3;, &#x4F46;&#x6700;&#x540E;&#x600E;&#x4E48;&#x8C03;&#x5230;linux&#x7684;?&#x89C1;A11
    oct_dev = octeon_allocate_device(pdev-&gt;device);
        oct = octeon_allocate_device_mem(pci_id);
            /*&#x5B9E;&#x9645;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x5305;&#x62EC; 
            **&#x4E3B;&#x7ED3;&#x6784;&#x4F53;:sizeof(octeon_device_t)+&#x89C1;&#x7ED3;&#x6784;&#x4F53;:sizeof(octeon_cn6xxx_t)+&#x89C1;&#x7ED3;&#x6784;&#x4F53;J:sizeof(octeon_dispatch_t)*64
            **&#x53EF;&#x80FD;&#x662F;&#x4E3A;&#x4E86;&#x7701;&#x4E8B;, &#x628A;&#x5185;&#x5B58;&#x4E00;&#x6B21;&#x5168;&#x90E8;&#x7533;&#x8BF7;&#x4E86;, &#x540E;&#x9762;&#x4E5F;&#x4F1A;&#x5206;&#x5F00;&#x7528;
            */
            //&#x8FD9;&#x91CC;&#x600E;&#x4E48;&#x505A;&#x5230;osi&#x7684;?&#x89C1;A11
            buf  = cavium_alloc_virt(size); //&#x865A;&#x62DF;&#x5730;&#x5740;
            oct        = (octeon_device_t *)buf;
            oct-&gt;chip  = (void *)(buf + octdevsize);
            oct-&gt;dispatch.dlist = (octeon_dispatch_t *)(buf + octdevsize + configsize); //&#x89C1;A18&#x91CC;&#x9762;&#x7684;&#x4F7F;&#x7528;
        octeon_device[oct_idx] = oct;
        //&#x4E0D;&#x540C;&#x7684;octeon&#x7684;name&#x4E0D;&#x4E00;&#x6837;, &quot;Octeon%d&quot;
    //&#x628A;oct_dev&#x5F53;&#x4F5C;&#x9A71;&#x52A8;&#x7684;priv&#x6210;&#x5458;
    pci_set_drvdata(pdev, oct_dev);
    //&#x53CD;&#x8FC7;&#x6765;&#x6307;
    oct_dev-&gt;pci_dev = (void *)pdev;
    //&#x5177;&#x4F53;&#x786C;&#x4EF6;&#x8981;&#x5728;&#x8FD9;&#x91CC;&#x914D;?
    octeon_device_init(oct_dev)
        /*&#x8FD9;&#x91CC;&#x9762;&#x6709;&#x4E2A;&#x51FD;&#x6570;&#x6307;&#x9488;, &#x539F;&#x578B;&#x662F;
        **typedef   oct_poll_fn_status_t (* octeon_poll_fn_t)(void *, unsigned long);
        */
        octeon_poll_ops_t   poll_ops;
        //&#x8FD9;&#x91CC;&#x9762;&#x4E00;&#x5171;&#x505A;&#x4E86;&#x4E09;&#x4EF6;&#x4E8B;, &#x5728;pci-remote&#x91CC;&#x9762;&#x6709;&#x5BF9;&#x5E94;&#x7684;
        octeon_pci_os_setup(octeon_dev)
            pci_enable_device(octeon_dev-&gt;pci_dev)
            //&#x4F7F;&#x80FD;64bit&#x8BBF;&#x95EE;, dev&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;64bit host&#x7A7A;&#x95F4;?
            pci_set_dma_mask(octeon_dev-&gt;pci_dev, PCI_DMA_64BIT)
            //&#x4F7F;&#x80FD;device&#x7684;master&#x4F4D;
            pci_set_master(octeon_dev-&gt;pci_dev)
        //&#x4F7F;&#x7528;&#x9A71;&#x52A8;&#x51FD;&#x6570;pci_read_config_dword&#x6765;&#x83B7;&#x5F97;ID,&#x5E76;&#x8C03;&#x7528;&#x76F8;&#x5E94;&#x51FD;&#x6570;
        octeon_chip_specific_setup(octeon_dev)
            case OCTEON_CN66XX_PCIID:
                /*&#x8BBE;&#x7F6E;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;:C
                **&#x7528;&#x6765;&#x9002;&#x914D;&#x4E0D;&#x540C;&#x578B;&#x53F7;&#x7684;octeon&#x7684;&#x94A9;&#x5B50;&#x51FD;&#x6570;
                **&#x8FD9;&#x4E9B;&#x51FD;&#x6570;&#x662F;&#x548C;&#x786C;&#x4EF6;&#x6700;&#x76F8;&#x5173;&#x7684;&#x64CD;&#x4F5C;, &#x5BC4;&#x5B58;&#x5668;&#x548C;&#x4E2D;&#x65AD;
                **&#x6CE8;&#x610F;&#x8FD9;&#x662F;&#x4E2A;osi&#x7684;&#x51FD;&#x6570;
                **&#x51FD;&#x6570;&#x5B9E;&#x73B0;&#x5728;components/driver/host/driver/osi/cn6xxx_common.c
                */
                setup_cn66xx_octeon_device(oct)
                    //&#x5176;&#x5B9E;chip&#x662F;&#x4E2A;void*, &#x8FD8;&#x8BB0;&#x5F97;&#x524D;&#x9762;&#x591A;&#x7533;&#x8BF7;&#x7684;size&#x5417;? sizeof(octeon_cn6xxx_t)
                    octeon_cn6xxx_t *cn6xxx = (octeon_cn6xxx_t *)oct-&gt;chip;
                    //map bar0&#x5730;&#x5740;&#x5230;oct-&gt;mmio[0].start
                    octeon_map_pci_barx(oct, 0, 0)
                        //reserve&#x8D44;&#x6E90;
                        pci_request_region(oct-&gt;pci_dev, baridx*2, DRIVER_NAME)
                           oct-&gt;mmio[baridx].start = pci_resource_start(oct-&gt;pci_dev, baridx*2);
                           oct-&gt;mmio[baridx].len   = pci_resource_len(oct-&gt;pci_dev, baridx*2);
                        //&#x5730;&#x5740;&#x9700;&#x8981;ioremap?, &#x628A;&#x8C03;&#x8BD5;&#x6253;&#x5370;&#x6253;&#x5F00;!
                        oct-&gt;mmio[baridx].hw_addr    = ioremap(oct-&gt;mmio[baridx].start, mapped_len);
                    //map bar1
                    octeon_map_pci_barx(oct, 1, MAX_BAR1_IOREMAP_SIZE))
                    cn6xxx-&gt;conf  = (cn6xxx_config_t  *)oct_get_config_info(oct);
                        /*&#x806A;&#x660E;!&#x6839;&#x636E;chip id, &#x76F4;&#x63A5;&#x8D4B;&#x503C;&#x914D;&#x7F6E;&#x8868;
                        **&#x6240;&#x6709;&#x7684;&#x914D;&#x7F6E;&#x8868;&#x5728;components/driver/host/include/oct_config_data.h
                        **&#x8FD9;&#x91CC;&#x6309;&#x7167;octeon_cn6xxx_t&#x6765;&#x914D;&#x7684;, &#x89C1;A12
                        */
                        return (void *)&amp;default_cn66xx_conf;
                    /*&#x8BBE;&#x7F6E;oct-&gt;fn_list
                    **&#x5305;&#x62EC;setup_iq_regs setup_oq_regs setup_device_regs update_iq_read_idx
                    **bar1_idx_setup bar1_idx_write     
                    **interrupt_handler enable_interrupt enable_io_queues
                    **&#x7B49;&#x7B49;, &#x8BE6;&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;:C
                    **&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;cn6xxx_interrupt_handler&#x89C1;&#x4E0B;:&#x4E2D;&#x65AD;&#x5904;&#x7406;
                    */
                    //&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x8BBE;&#x7F6E;bar0&#x7684;window&#x5BC4;&#x5B58;&#x5668;&#x76F8;&#x5173;&#x7684;&#x5730;&#x5740;
                    cn6xxx_setup_reg_address()
        //map&#x5B8C;&#x6210;&#x4E86;, &#x914D;&#x7F6E;&#x4E5F;&#x5B8C;&#x6210;&#x4E86;, &#x4F46;&#x8FD8;&#x6CA1;&#x6709;&#x5199;&#x8FDB;&#x53BB;
        cavium_atomic_set(&amp;octeon_dev-&gt;status, OCT_DEV_PCI_MAP_DONE);
        //&#x5148;&#x590D;&#x4F4D;&#x4E00;&#x4E0B;
        octeon_dev-&gt;fn_list.soft_reset(octeon_dev)
        //&#x6E05;&#x7A7A;dispatch&#x94FE;&#x8868;
        octeon_init_dispatch_list(octeon_dev)
        //&#x521D;&#x59CB;&#x5316;poll fn list&#x5230;oct-&gt;poll_list, &#x91CC;&#x9762;&#x5171;64&#x4E2A;poll&#x51FD;&#x6570;
        octeon_setup_poll_fn_list(octeon_dev);
        /*&#x6CE8;&#x518C;&#x4E00;&#x4E2A;&#x9A71;&#x52A8;&#x81EA;&#x5DF1;&#x7528;&#x7684;poll_ops:&quot;Module Starter&quot; 
        **&#x51FD;&#x6570;&#x662F;oct_poll_module_starter, 1&#x79D2;&#x4E00;&#x6B21;, &#x89C1;A13
        **&#x6CE8;&#x518C;&#x5230;&#x4E0A;&#x9762;&#x7684;oct-&gt;poll_list
        */
        octeon_register_poll_fn(octeon_dev-&gt;octeon_id, &amp;poll_ops);
        //&#x81F3;&#x6B64;&#x521D;&#x59CB;&#x5316;&#x5B8C;&#x6210;? &#x4F46;&#x6CA1;&#x6709;&#x5199;&#x4EFB;&#x4F55;&#x7684;octeon&#x7684;&#x5BC4;&#x5B58;&#x5668;???
        cavium_atomic_set(&amp;octeon_dev-&gt;status, OCT_DEV_DISPATCH_INIT_DONE);
        //&#x5982;&#x679C;&#x4F7F;&#x80FD;&#x4E86;buffer pool(USE_BUFFER_POOL), &#x641C;&#x7D22;&#x5173;&#x952E;&#x5B57;: HUGE_BUFFER_CHUNKS
        /*&#x6CE8;&#x610F;&#x8FD9;&#x4E5F;&#x662F;&#x4E2A;osi&#x7684;&#x51FD;&#x6570;
        **&#x57FA;&#x672C;&#x4E0A;&#x662F;&#x8C03;&#x7528;cavium_malloc_dma&#x6765;&#x9884;&#x5148;&#x5206;&#x914D;&#x5185;&#x5B58;, &#x6309;size&#x5927;&#x5C0F;&#x5206;&#x4E3A;6&#x7C7B;,32k,16k,&#x4F9D;&#x6B21;
        **&#x6700;&#x540E;&#x662F;&#x8C03;&#x7528;kmalloc ----&#x9700;&#x8981;&#x9002;&#x914D;
        **&#x9ED8;&#x8BA4;&#x662F;&#x5173;&#x95ED;&#x7684;, ----&#x6211;&#x51C6;&#x5907;&#x6253;&#x5F00;&#x8FD9;&#x4E2A;&#x529F;&#x80FD;
        **&#x4F46;&#x4ECE;get_buffer_from_pool()&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6765;&#x770B;,&#x4E0D;&#x80FD;&#x628A;&#x8981;&#x7533;&#x8BF7;&#x7684;size&#x5206;&#x7247;
        **&#x6BD4;&#x5982;&#x8D85;&#x8FC7;&#x6BD4;&#x5982;32K, &#x5219;&#x4F1A;&#x8C03;&#x7528;cavium_malloc_dma&#x5206;&#x914D;&#x5185;&#x5B58;
        **&#x4E5F;&#x5C31;&#x662F;&#x8BF4;, &#x8FD9;&#x4E2A;&#x9A71;&#x52A8;&#x91CC;&#x9762;&#x7684;packet&#x90FD;&#x662F;&#x5047;&#x5B9A;&#x7269;&#x7406;&#x5185;&#x5B58;&#x8FDE;&#x7EED;&#x7684; ----&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x8981;&#x89E3;&#x51B3;--&#x8981;&#x7ED3;&#x5408;&#x540E;&#x9762;&#x7684;pci_map_single()
        */
        octeon_init_buffer_pool(octeon_dev, &amp;bufpool_config)
        //&#x5148;&#x5173;&#x95ED;input ring&#x548C;output ring
        octeon_set_io_queues_off(octeon_dev);
        //&#x521D;&#x59CB;&#x5316;input ring
        octeon_setup_instr_queues(octeon_dev)
            //&#x5BF9;32&#x4E2A;ring, &#x6216;&#x8005;&#x8BF4;queue
                //&#x6CE8;&#x610F;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x4E0D;&#x9700;&#x8981;&#x7269;&#x7406;&#x5730;&#x5740;&#x8FDE;&#x7EED;, &#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;D
                oct-&gt;instr_queue[i] = cavium_alloc_virt(sizeof(octeon_instr_queue_t));
                //&#x8FD9;&#x91CC;&#x624D;&#x662F;&#x771F;&#x6B63;&#x7684;input ring&#x7684;&#x5185;&#x5B58;&#x7533;&#x8BF7;&#x7684;&#x5730;&#x65B9;
                octeon_init_instr_queue(oct, i)
                    iq = oct-&gt;instr_queue[iq_no];
                    q_size = conf-&gt;instr_type * conf-&gt;num_descs; //&#x8FD9;&#x4E2A;input queue&#x7684;&#x6DF1;&#x5EA6;
                    //&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5E95;&#x5C42;&#x662F;&#x8C03;&#x7528;linux&#x5185;&#x6838;&#x7684;pci_alloc_consistent ----&#x60F3;&#x597D;&#x600E;&#x4E48;&#x66FF;&#x4EE3;&#x4E86;&#x5417;? &#x8981;&#x4FDD;&#x8BC1;&#x786C;&#x4EF6;&#x548C;&#x8F6F;&#x4EF6;&#x770B;&#x5230;&#x7684;&#x4E1C;&#x897F;&#x540C;&#x6B65;&#x54E6;!
                    iq-&gt;base_addr = octeon_pci_alloc_consistent(oct-&gt;pci_dev, q_size, &amp;iq-&gt;base_addr_dma); //&#x89C1;A141, DMA&#x5185;&#x5B58;
                    //no response list, &#x7533;&#x8BF7;&#x865A;&#x62DF;&#x8FDE;&#x7EED;&#x7684;&#x5185;&#x5B58;, &#x662F;&#x7ED3;&#x6784;&#x4F53;D&#x91CC;&#x9762;&#x7684;&#x4E00;&#x4E2A;&#x6210;&#x5458;
                    octeon_init_nr_free_list(iq, iq-&gt;max_count)
                    //&#x547D;&#x4EE4;&#x5B57;&#x7684;32bit&#x6216;64bit&#x662F;&#x6839;&#x636E;&#x914D;&#x7F6E;&#x6765;&#x7684;
                    //&#x771F;&#x6B63;&#x5F00;&#x59CB;&#x5E72;&#x6D3B;, &#x8C03;&#x7528;&#x94A9;&#x5B50;&#x51FD;&#x6570;&#x8BBE;&#x7F6E;iput ring
                    oct-&gt;fn_list.setup_iq_regs(oct, iq_no);
                    //&#x6CE8;&#x518C;poll&#x51FD;&#x6570; check_db_timeout, &quot;Doorbell Timeout&quot;, &#x5468;&#x671F;1&#x4E2A;tick??&#x4F1A;&#x4E0D;&#x4F1A;&#x592A;&#x5FEB;&#x4E86;?&#x89C1;A14
                    octeon_register_poll_fn(oct-&gt;octeon_id, &amp;poll_ops);
        //&#x5230;&#x8FD9;&#x91CC;input ring&#x5B8C;&#x5DE5;
        cavium_atomic_set(&amp;octeon_dev-&gt;status, OCT_DEV_INSTR_QUEUE_INIT_DONE);

        //pending list&#x662F;&#x7528;&#x6765;&#x5904;&#x7406;&#x9700;&#x8981;response&#x7684;request&#x7684;, &#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;E, &#x5F88;&#x9738;&#x9053;&#x7684;&#x90A3;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;
        octeon_init_pending_list(octeon_dev)
            //count&#x662F;&#x4ECE;&#x90A3;&#x4E2A;&#x914D;&#x7F6E;&#x8868;&#x91CC;&#x6765;&#x7684;
            count = (CHIP_FIELD(oct, cn6xxx, conf))-&gt;c.pending_list_size;
            oct-&gt;pend_list_size = count;
            //&#x7ED9;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;E&#x5206;&#x914D;&#x7A7A;&#x95F4;, &#x865A;&#x62DF;&#x5730;&#x5740;&#x8FDE;&#x7EED;&#x5C31;&#x884C;
            oct-&gt;plist = cavium_alloc_virt(sizeof(octeon_pending_list_t));
            //&#x8FD9;&#x4E2A;list&#x662F;E1,&#x662F;&#x4E2A;&#x94FE;&#x8868;, &#x6709;count&#x4E2A;node
            oct-&gt;plist-&gt;list = (octeon_pending_entry_t *) cavium_alloc_virt(OCT_PENDING_ENTRY_SIZE * count);
            //free_list&#x662F;&#x4E2A;&#x6570;&#x7EC4;, &#x6709;count&#x4E2A;uint32
            oct-&gt;plist-&gt;free_list = (uint32_t *) cavium_alloc_virt(sizeof(uint32_t) * count);
            oct-&gt;plist-&gt;entries = count;
        cavium_atomic_set(&amp;octeon_dev-&gt;status, OCT_DEV_PEND_LIST_INIT_DONE);
        //&#x73B0;&#x5728;&#x662F;&#x5E94;&#x7B54;&#x94FE;&#x8868;
        octeon_setup_response_list(octeon_dev)
            //&#x5BF9;&#x4E09;&#x79CD;&#x7C7B;&#x578B;, &#x521D;&#x59CB;&#x5316;&#x94FE;&#x8868;&#x5934;, &#x5B9E;&#x9645;&#x4E0A;, &#x4EE5;&#x4E0B;&#x4E09;&#x7C7B;&#x7684;response, &#x7531;&#x94FE;&#x8868;&#x5934;&#x5F15;&#x9886;
            //1 ordered, 1 unordered-blocking, 1 unordered-nonblocking
            //&#x5BF9;&#x5168;&#x5C40;&#x53D8;&#x91CF;noresp_buf_free_fn&#x8D4B;NULL, &#x8FD9;&#x662F;&#x4E2A;&#x51FD;&#x6570;&#x6307;&#x9488;&#x7684;&#x4E8C;&#x7EF4;&#x6570;&#x7EC4;
            noresp_buf_free_fn[oct-&gt;octeon_id][i] = NULL;
            //&#x6CE8;&#x518C;poll&#x51FD;&#x6570;, oct_poll_req_completion, 1&#x4E2A;tick, &#x89C1;A15
            ret = octeon_register_poll_fn(oct-&gt;octeon_id, &amp;poll_ops);
            //&#x6CE8;&#x610F;: &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x88AB;&#x6CE8;&#x91CA;&#x6389;&#x4E86;! &#x6CE8;&#x518C;poll&#x51FD;&#x6570;, oct_poll_check_unordered_list, &#x4E00;&#x79D2;10&#x6B21;, &#x89C1;A16
            /*ret = octeon_register_poll_fn(oct-&gt;octeon_id, &amp;poll_ops);*/

        cavium_atomic_set(&amp;octeon_dev-&gt;status, OCT_DEV_RESP_LIST_INIT_DONE);

        //&#x5F00;&#x59CB;&#x521D;&#x59CB;&#x5316;output queue, &#x4E5F;&#x53EB;dpoq?
        octeon_setup_output_queues(octeon_dev)
            //&#x7ED9;32&#x4E2A;droq&#x5206;&#x914D;&#x7A7A;&#x95F4;
            for 32&#x4E2A;
                //droq&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;G
                oct-&gt;droq[i] = cavium_alloc_virt(sizeof(octeon_droq_t));
                octeon_init_droq(oct, i)
                    //&#x5148;&#x4ECE;config&#x8868;&#x4E2D;&#x67E5;&#x914D;&#x7F6E;&#x4FE1;&#x606F;
                    //&#x7136;&#x540E;&#x7ED9;&#x771F;&#x6B63;&#x7684;&#x786C;&#x4EF6;output ring&#x5206;&#x914D;&#x7A7A;&#x95F4;
                    //&#x5FC5;&#x987B;&#x6CE8;&#x610F;&#x4EE5;&#x4E0B;&#x7684;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x7684;&#x51FD;&#x6570;
                    droq-&gt;desc_ring = octeon_pci_alloc_consistent() //DMA&#x5185;&#x5B58;
                    //&#x5E95;&#x4E0B;&#x8C03;&#x7528;__get_free_pages(),8&#x5B57;&#x8282;&#x5BF9;&#x9F50;
                    droq-&gt;info_list = cavium_alloc_aligned_memory() //&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x9875;?
                    droq-&gt;recv_buf_list = cavium_alloc_virt() //&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;G5

                    octeon_droq_setup_ring_buffers(oct, droq))
                        //A1i1. &#x5BF9;&#x6BCF;&#x4E2A;&#x63CF;&#x8FF0;&#x7B26;, &#x7533;&#x8BF7;buffer, &#x771F;&#x6B63;&#x548C;octeon&#x786C;&#x4EF6;&#x5BF9;&#x5E94;&#x7684;buffer, &#x53E6;&#x5916;&#x4E00;&#x5904;&#x5728;refill, &#x89C1;A17
                        for(i = 0; i &lt; droq-&gt;max_count; i++)
                            //&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x7684;get_new_recv_buffer&#x662F;osi&#x7684;, &#x4F46;&#x5B9E;&#x73B0;&#x662F;linux&#x7684;skbuf&#xFF1B; &#x8FD9;&#x91CC;&#x5C31;&#x5DF2;&#x7ECF;&#x628A;&#x6536;&#x5305;bufer&#x7533;&#x8BF7;&#x597D;&#x4E86;
                            buf = get_new_recv_buffer(droq-&gt;buffer_size); //&#x7528;skb&#x7533;&#x8BF7;buffer?&#x4E3A;&#x4EC0;&#x4E48;?
                            //recv_buf_list&#x662F;&#x4E2A;G5&#x7684;&#x6570;&#x7EC4;
                            droq-&gt;recv_buf_list[i].buffer  = buf;
                            droq-&gt;recv_buf_list[i].data    = get_recv_buffer_data(buf);
                            //&#x4E0B;&#x9762;&#x5173;&#x952E;&#x662F;, &#x7B80;&#x5199;, &#x5B9E;&#x9645;&#x4E0A;&#x7528;octeon_pci_map_single&#x8F6C;&#x4E3A;IOMMU&#x5730;&#x5740;, &#x8BF4;&#x660E;&#x4E5F;&#x662F;DMA&#x5185;&#x5B58;
                            desc_ring[i].info_ptr   = octeon_pci_map_single(&amp;droq-&gt;info_list[i],...)
                            desc_ring[i].buffer_ptr = octeon_pci_map_single(droq-&gt;recv_buf_list[i].data,...)
                        octeon_droq_reset_indices(droq);
                            droq-&gt;host_read_index     = 0;
                            droq-&gt;octeon_write_index  = 0;
                            droq-&gt;host_refill_index   = 0;
                            droq-&gt;refill_count        = 0;
                            cavium_atomic_set(&amp;droq-&gt;pkts_pending, 0);
                    //&#x8C03;&#x7528;&#x771F;&#x6B63;&#x7684;&#x8BBE;&#x786C;&#x4EF6;&#x7684;&#x51FD;&#x6570;
                    oct-&gt;fn_list.setup_oq_regs(oct, q_no);
                    poll_ops.fn     = check_droq_refill;
                    //&#x6CE8;&#x518C;check_droq_refill&#x51FD;&#x6570;, &#x89C1;A17, &#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;
                    octeon_register_poll_fn(oct-&gt;octeon_id, &amp;poll_ops);
                    //&#x5982;&#x679C;&#x6253;&#x5F00;&#x4E86;USE_DROQ_THREADS, &#x4F46;&#x597D;&#x50CF;&#x6CA1;&#x5F00;, &#x6536;&#x5305;&#x5185;&#x6838;&#x7EBF;&#x7A0B;
                    cavium_init_wait_channel(&amp;droq-&gt;wc); //&#x5E95;&#x4E0B;&#x662F;init_waitqueue_head()
                    //droq&#x5185;&#x6838;&#x7EBF;&#x7A0B;, &#x8FD0;&#x884C;oct_droq_thread, &#x89C1;A18, &#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;
                    cavium_kthread_setup(&amp;droq-&gt;thread, oct_droq_thread, droq,&quot;Oct DROQ Thread&quot;, 0)
                    cavium_kthread_create(&amp;droq-&gt;thread) //&#x5E95;&#x4E0B;&#x662F;kthread_create()
                    //&#x7ED1;&#x5B9A;&#x5230;cpu, q&#x548C;cpu&#x4E2A;&#x6570;&#x6C42;&#x4F59;droq-&gt;q_no % cavium_get_cpu_count()
                    cavium_kthread_set_cpu_affinity() //&#x5E95;&#x4E0B;&#x662F;kthread_bind()
                    cavium_kthread_run(&amp;droq-&gt;thread); //&#x5E95;&#x4E0B;&#x662F;wake_up_process()
        //&#x81F3;&#x6B64;output q&#x521D;&#x59CB;&#x5316;&#x7ED3;&#x675F;
        cavium_atomic_set(&amp;octeon_dev-&gt;status, OCT_DEV_DROQ_INIT_DONE);
        //&#x6839;&#x636E;&#x6CE8;&#x91CA;, &#x8C03;&#x7528;&#x5176;&#x4ED6;&#x7684;device&#x76F8;&#x5173;&#x7684;&#x521D;&#x59CB;&#x5316;&#x5BC4;&#x5B58;&#x5668;&#x51FD;&#x6570;
        ret = octeon_dev-&gt;fn_list.setup_device_regs(octeon_dev);
        //&#x8FD9;&#x90E8;&#x5206;&#x6CE8;&#x518C;/proc/octeon
        cavium_init_proc(octeon_dev);
            root = proc_mkdir(octeon_dev-&gt;device_name, NULL);
            octeon_dev-&gt;proc_root_dir = (void *)root;
            node = create_proc_entry(&quot;debug_level&quot;, 0644, root);
            node-&gt;read_proc = proc_read_debug_level;
            node-&gt;write_proc = proc_write_debug_level;
            //&#x8FD9;&#x91CC;&#x9762;&#x7684;create_proc_read_entry()&#x5728;&#x65B0;&#x7684;&#x5185;&#x6838;&#x91CC;&#x5E94;&#x8BE5;&#x662F;proc_create_data() and seq_file
            node = create_proc_read_entry(&quot;stats&quot;,0444, root, proc_read_stats,octeon_dev)
            //&#x7C7B;&#x4F3C;&#x7684;, &#x521B;&#x5EFA;&quot;configreg&quot; &quot;csrreg&quot; &quot;npireg&quot;, &#x6302;&#x7684;&#x662F;&#x4E0D;&#x540C;&#x7684;&#x8BFB;&#x5199;&#x51FD;&#x6570;

        //&#x5982;&#x679C;&#x6CA1;&#x6709;&#x6253;&#x5F00;USE_DROQ_THREADS, &#x5219;&#x7528;tasklet&#x6765;&#x5904;&#x7406;output q, &#x9ED8;&#x8BA4;&#x662F;&#x8D70;&#x8FD9;
        //octeon_droq_bh&#x89C1;A19, &#x7531;&#x4E2D;&#x65AD;&#x89E6;&#x53D1;, &#x89C1;&#x4E2D;&#x65AD;&#x5904;&#x7406;
        cavium_tasklet_init(&amp;octeon_dev-&gt;droq_tasklet, octeon_droq_bh, (unsigned long)octeon_dev);
        //comp_tasklet&#x7528;&#x6765;&#x52A0;&#x901F;ORDERED&#x7684;&#x8BF7;&#x6C42;&#x7684;&#x5904;&#x7406;, &#x8FD9;&#x4E2A;&#x4E0B;&#x534A;&#x90E8;&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x662F;&#x8C03;&#x7528;process_ordered_list(), &#x53EF;&#x4EE5;&#x53C2;&#x8003;A15
        cavium_tasklet_init(&amp;octeon_dev-&gt;comp_tasklet, octeon_request_completion_bh, (unsigned long)octeon_dev);
        //&#x6CE8;&#x518C;PCIE&#x4E2D;&#x65AD;, &#x89C1;&#x4E2D;&#x65AD;&#x5904;&#x7406;
        octeon_setup_interrupt(octeon_dev);
            //&#x6253;&#x5F00;msi&#x4E2D;&#x65AD;
            pci_enable_msi(oct-&gt;pci_dev)
            irqret = request_irq(oct-&gt;pci_dev-&gt;irq, octeon_intr_handler, CVM_SHARED_INTR, &quot;octeon&quot;, oct);
        //&#x73B0;&#x5728;&#x5F00;&#x59CB;&#x4F7F;&#x80FD;&#x4E2D;&#x65AD;
           octeon_dev-&gt;fn_list.enable_interrupt(octeon_dev-&gt;chip);
        //&#x4F7F;&#x80FD;input output q
        octeon_dev-&gt;fn_list.enable_io_queues(octeon_dev);
        //send credit&#x662F;&#x4EC0;&#x4E48;&#x610F;&#x601D;?
        for(j = 0; j &lt; octeon_dev-&gt;num_oqs; j++)  
            OCTEON_WRITE32(octeon_dev-&gt;droq[j]-&gt;pkts_credit_reg, octeon_dev-&gt;droq[j]-&gt;max_count);

        /* Packets can start arriving on the output queues from this point. */
        octeon_dev-&gt;app_mode = CVM_DRV_INVALID_APP;
        cavium_atomic_set(&amp;octeon_dev-&gt;status, OCT_DEV_HOST_OK);
    //&#x6CE8;&#x518C;dispath&#x51FD;&#x6570;, &#x89C1;A181
    octeon_setup_driver_dispatches(oct_dev-&gt;octeon_id)
    //&#x8981;&#x6C42;oct_dev-&gt;app_mode&#x4E0D;&#x662F;CVM_DRV_BASE_APP&#x6216;CVM_DRV_INVALID_APP
    octeon_start_module(oct_dev-&gt;app_mode, oct_dev-&gt;octeon_id)
        //&#x91CC;&#x9762;&#x8C03;&#x7684;&#x51FD;&#x6570;&#x662F;octeon_register_module_handler()&#x6CE8;&#x518C;&#x7684;
        __octeon_module_action(app_type, OCTEON_START_MODULE, octeon_id)
    octeon_state = OCT_DRV_ACTIVE;
</code></pre>
<h4 id="a11-&#x5982;&#x4F55;osi-&#x5230;&#x5E95;&#x54EA;&#x4E9B;&#x662F;osi&#x7684;-&#x54EA;&#x4E9B;&#x53C8;&#x4E0D;&#x662F;"><a name="a11-&#x5982;&#x4F55;osi-&#x5230;&#x5E95;&#x54EA;&#x4E9B;&#x662F;osi&#x7684;-&#x54EA;&#x4E9B;&#x53C8;&#x4E0D;&#x662F;" class="anchor-navigation-ex-anchor" href="#a11-&#x5982;&#x4F55;osi-&#x5230;&#x5E95;&#x54EA;&#x4E9B;&#x662F;osi&#x7684;-&#x54EA;&#x4E9B;&#x53C8;&#x4E0D;&#x662F;"><i class="fa fa-link" aria-hidden="true"></i></a>A11. &#x5982;&#x4F55;osi? &#x5230;&#x5E95;&#x54EA;&#x4E9B;&#x662F;osi&#x7684;? &#x54EA;&#x4E9B;&#x53C8;&#x4E0D;&#x662F;?</h4>
<p><code>components/driver/host/driver/osi/octeon_device.c</code>
<code>buf  = cavium_alloc_virt(size)</code>;&#x5B9E;&#x9645;&#x8C03;&#x7684;&#x662F;<code>vmalloc</code>, &#x8FD9;&#x662F;linux kernel&#x7684;&#x51FD;&#x6570;, &#x8FD9;&#x91CC;&#x5DF2;&#x7ECF;&#x4E0D;&#x662F;osi&#x4E86;</p>
<p>os&#x76F8;&#x5173;&#x7684;&#x5B9A;&#x4E49;&#x5728;<br><code>components/driver/host/driver/linux/cvm_linux_types.h</code></p>
<pre><code class="lang-c">#define   cavium_alloc_virt(size)        vmalloc((size))
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x5934;&#x6587;&#x4EF6;&#x88AB;
<code>components/driver/host/driver/linux/linux_sysdep.h</code> &#x5F15;&#x7528;<br>&#x8FDB;&#x800C;&#x88AB;
<code>components/driver/host/include/cavium_sysdep.h</code> &#x5F15;&#x7528;</p>
<pre><code class="lang-c">#ifdef linux
#include &quot;../driver/linux/linux_sysdep.h&quot; //&#x73B0;&#x5728;&#x662F;&#x8FD9;&#x4E2A;&#x5206;&#x652F;
#elif defined(__FreeBSD__)
#include &quot;../driver/freebsd/freebsd_sysdep.h&quot;
#elif defined (_WIN32)
#include &quot;..\driver\windows\windows_sysdep.h&quot;
#else /* CUSTOM_OS */
#include &quot;custom_sysdep.h&quot;
#endif
</code></pre>
<h4 id="a12cn66xx&#x7684;&#x914D;&#x7F6E;&#x8868;"><a name="a12cn66xx&#x7684;&#x914D;&#x7F6E;&#x8868;" class="anchor-navigation-ex-anchor" href="#a12cn66xx&#x7684;&#x914D;&#x7F6E;&#x8868;"><i class="fa fa-link" aria-hidden="true"></i></a>A12.cn66xx&#x7684;&#x914D;&#x7F6E;&#x8868;</h4>
<pre><code class="lang-c">cn66xx_config_t  default_cn66xx_conf =
{
    /* num_iqs; num_oqs; pending_list_size; */
    {
    4,
    4,
    4096,
    },

    /* Input Queue configuration */
    /* num_descs; instr_type; db_min; db_timeout; */
    {
    {1024, 32, 1, 1} ,
    {1024, 32, 1, 1}  ,
    {1024, 32, 1, 1}  ,
    {1024, 32, 1, 1}
    },

    /* Output Queue configuration */
    /* num_descs; info_ptr; bufsize, pkts_per_intr; refill_threshold*/
    {
    {1024, 1, 1536, 128, 128} ,
    {1024,  1, 1536, 128, 128} ,
    {1024,  1, 1536, 128, 128} ,
    {1024,  1, 1536, 128, 128} ,
    },

    /* oq_intr_pkt; oq_intr_time; */
    64,
    100,

#ifdef CVMCS_DMA_IC
    /* dma_intr_pkt; dma_intr_time; */
    64,
    1000,
#endif

};
</code></pre>
<h4 id="a13-octpollmodulestarter"><a name="a13-octpollmodulestarter" class="anchor-navigation-ex-anchor" href="#a13-octpollmodulestarter"><i class="fa fa-link" aria-hidden="true"></i></a>A13. oct_poll_module_starter</h4>
<p>&#x8FD9;&#x4E2A;poll&#x7684;&#x4F5C;&#x7528;&#x662F;&#x7B49;&#x5F85;core&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x6210;&#x529F;, &#x5E76;&#x62A5;&#x544A;&#x5B83;&#x7684;app type</p>
<pre><code class="lang-c">oct_poll_module_starter(void  *octptr, unsigned long arg)
        if(cavium_atomic_read(&amp;oct-&gt;status) == OCT_DEV_RUNNING) {
        return OCT_POLL_FN_FINISHED;
    }

    /* If the status of the device is CORE_OK, the core
       application has reported its application type. Call
       any registered handlers now and move to the RUNNING
       state. */
    if(cavium_atomic_read(&amp;oct-&gt;status) != OCT_DEV_CORE_OK)
        return OCT_POLL_FN_CONTINUE;

    cavium_atomic_set(&amp;oct-&gt;status,OCT_DEV_RUNNING);
</code></pre>
<h4 id="a14-checkdbtimeout--doorbell-timeout-&#x5468;&#x671F;1&#x4E2A;tick"><a name="a14-checkdbtimeout--doorbell-timeout-&#x5468;&#x671F;1&#x4E2A;tick" class="anchor-navigation-ex-anchor" href="#a14-checkdbtimeout--doorbell-timeout-&#x5468;&#x671F;1&#x4E2A;tick"><i class="fa fa-link" aria-hidden="true"></i></a>A14. check_db_timeout  &quot;Doorbell Timeout&quot;, &#x5468;&#x671F;1&#x4E2A;tick</h4>
<pre><code class="lang-c">/* Called by the Poll thread at regular intervals to check the instruction
 * queue for commands to be posted and for commands that were fetched by Octeon.
 */
check_db_timeout(void  *octptr, unsigned long  iq_no)
    //&#x5148;&#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x7684;input queue
    iq = oct-&gt;instr_queue[iq_no];
    //&#x8BA1;&#x7B97;&#x662F;&#x5426;&#x8D85;&#x65F6;, &#x8FD9;&#x91CC;&#x9762;&#x7684;cavium_jiffies&#x662F;&#x5185;&#x6838;&#x53D8;&#x91CF;jiffies
    //&#x6CA1;&#x8D85;&#x65F6;&#x5C31;&#x5565;&#x4E5F;&#x4E0D;&#x5E72;
    If cavium_jiffies - last_db_time &lt; db_timeout
        return OCT_POLL_FN_CONTINUE;
    iq-&gt;last_db_time = cavium_jiffies; //&#x8BB0;&#x5F55;&#x4E0A;&#x6B21;&#x7684;cavium_jiffies
    //&#x8FD9;&#x91CC;&#x7528;spin_lock_softirqsave&#x662F;&#x4E3A;&#x4E86;&#x963B;&#x6B62;&#x4E2D;&#x65AD;(tasklet)--&#x54EA;&#x4E2A;&#x4E2D;&#x65AD;&#x4E5F;&#x8981;&#x9501;iq-&gt;lock&#x5462;?
    cavium_spin_lock_softirqsave(&amp;iq-&gt;lock);
    //fill_cnt&#x8868;&#x793A;&#x7B49;&#x5F85;&#x53D1;&#x5230;octeon&#x7684;instructions&#x4E2A;&#x6570;, &#x8D85;&#x65F6;&#x4E86;&#x8FD8;&#x6709;&#x503C;, &#x5219;&#x6309;&#x95E8;&#x94C3;
    if(iq-&gt;fill_cnt != 0)
        ring_doorbell(iq);
            //OCTEON_WRITE32&#x4E5F;&#x662F;&#x4E2A;osi&#x7684;&#x63A5;&#x53E3;, &#x5E95;&#x4E0B;&#x662F;writel
            OCTEON_WRITE32(iq-&gt;doorbell_reg, iq-&gt;fill_cnt);
            iq-&gt;fill_cnt     = 0;
            iq-&gt;last_db_time = cavium_jiffies;
    cavium_spin_unlock_softirqrestore(&amp;iq-&gt;lock);
    if(cavium_atomic_read(&amp;iq-&gt;instr_pending))
        /** &#x8FD9;&#x4E2A;&#x6CE8;&#x91CA;&#x771F;&#x597D;!
        * Check for commands that were fetched by Octeon. If they were NORESPONSE
        * requests, move the requests from the per-queue pending list to the
        * per-device noresponse completion list.
        */
        flush_instr_queue(oct, iq);
            update_iq_indices(oct, iq);
                //&#x6839;&#x636E;octeon&#x5DF2;&#x7ECF;&#x8BFB;&#x53D6;&#x7684;commands&#x6570;&#x66F4;&#x65B0;, octeon_read_index&#x8868;&#x793A;octeon&#x5DF2;&#x7ECF;&#x6267;&#x884C;&#x5B8C;&#x7684;index
                iq-&gt;octeon_read_index = oct-&gt;fn_list.update_iq_read_idx(iq);
                /*&#x628A;flush_index&#x5230;octeon_read_index&#x4E4B;&#x95F4;&#x7684;
                **NORESPONSE&#x7684;&#x8BF7;&#x6C42;&#x79FB;&#x52A8;&#x5230;completion list(&#x6BCF;&#x4E2A;device&#x4E00;&#x4E2A;)
                */
                if(iq-&gt;flush_index != iq-&gt;octeon_read_index)
                    inst_processed = __process_iq_noresponse_list(oct, iq);
                        //&#x5728;&#x5FAA;&#x73AF;&#x91CC;&#x628A;flush_index&#x5230;octeon_read_index&#x4E4B;&#x95F4;&#x7684;instruction&#x79FB;&#x5230;freelist
                        //&#x4ECE;iq-&gt;nrlist&#x79FB;&#x5230;iq-&gt;nr_free.q
                        iq-&gt;nr_free.q[put_idx].buf     = iq-&gt;nrlist[old].buf;
                        iq-&gt;nr_free.q[put_idx].buftype = iq-&gt;nrlist[old].buftype;
                        iq-&gt;nrlist[old].buf = 0; iq-&gt;nrlist[old].buftype = 0;
                    //&#x8FD9;&#x91CC;&#x8868;&#x793A;noresponse&#x7684;&#x5DF2;&#x7ECF;&#x5904;&#x7406;&#x4E86;inst_processed&#x4E2A;
                    if(inst_processed)
                        cavium_atomic_sub(inst_processed, &amp;iq-&gt;instr_pending);
                        iq-&gt;stats.instr_processed += inst_processed ;
            //&#x5BF9;iq-&gt;nr_free&#x8FDB;&#x884C;&#x91CA;&#x653E;, &#x8FD8;&#x662F;irqsave&#x9501;iq-&gt;lock
            process_noresponse_list(oct, iq);
                //&#x5728;get_idx&#x548C;put_idx&#x4E4B;&#x95F4;
                while(get_idx != iq-&gt;nr_free.put_idx)
                    switch(iq-&gt;nr_free.q[get_idx].buftype) {
                    case NORESP_BUFTYPE_INSTR:
                        //instr&#x662F;octeon_soft_instruction_t, &#x89C1;&#x7ED3;&#x6784;&#x4F53;E11
                        instr = (octeon_soft_instruction_t *)iq-&gt;nr_free.q[get_idx].buf;
                        //instr_list&#x662F;&#x4E2A;&#x5C40;&#x90E8;&#x53D8;&#x91CF;, &#x8868;&#x793A;&#x4E00;&#x4E2A;&#x94FE;&#x8868;
                        cavium_list_add_tail(&amp;instr-&gt;list, &amp;instr_list);
                    case NORESP_BUFTYPE_NET:
                    case NORESP_BUFTYPE_NET_SG:
                    case NORESP_BUFTYPE_OHSM_SEND:
                        //&#x8FD9;&#x91CC;&#x91CA;&#x653E;buf
                        noresp_buf_free_fn[oct-&gt;octeon_id][iq-&gt;nr_free.q[get_idx].buftype](iq-&gt;nr_free.q[get_idx].buf);
                //&#x63A5;&#x4E0B;&#x6765;&#x5904;&#x7406;&#x521A;&#x751F;&#x6210;&#x7684;instr_list&#x94FE;&#x8868;
                release_soft_instr(oct, instr, instr-&gt;req_info.status); //&#x6807;&#x8BB0;A14i1
                    if(soft_instr-&gt;dptr)
                        //DPI_INST_HDR[G]=0&#x65F6;
                        if(!soft_instr-&gt;ih.gather)
                            octeon_pci_unmap_single() //response_manager.c
                        //DPI_INST_HDR[G]=1&#x65F6;, DPTR&#x6307;&#x5411;&#x4E00;&#x4E2A;&#x94FE;&#x8868;
                        else
                            octeon_pci_unmap_sg_list()
                        //&#x6CE8;: &#x4EE5;&#x4E0A;&#x4E24;&#x4E2A;&#x53C8;&#x662F;osi&#x7684;&#x63A5;&#x53E3;, &#x89C1;A141
                    if(soft_instr-&gt;rptr)
                        if(!soft_instr-&gt;irh.scatter)
                            octeon_pci_unmap_single()
                        else
                            octeon_pci_unmap_sg_list()
                    //&#x8C03;&#x7528;callback,&#x662F;SET_REQ_INFO_CALLBACK()&#x6CE8;&#x518C;&#x7684;, &#x89C1;C12&#x91CC;&#x9762;&#x7684;&#x8C03;&#x7528;
                    soft_instr-&gt;req_info.callback()
                    if soft_instr-&gt;alloc_flags
                        delete_soft_instr_buffers(octeon_dev, soft_instr); //&#x89C1;A142
                            cavium_free_buffer(octeon_dev,(uint8_t *)((uint64_t *)soft_instr-&gt;status_word - 1));
                            cavium_free_buffer(octeon_dev, (uint8_t*)soft_instr-&gt;scatter_ptr);
                            cavium_free_buffer(octeon_dev, (uint8_t*)soft_instr-&gt;gather_ptr);
                            cavium_free_buffer(octeon_dev, (uint8_t*)soft_instr-&gt;dptr);
                            cavium_free_buffer(octeon_dev, (uint8_t*)soft_instr);
</code></pre>
<h5 id="a141-octeonpcimapsingle&#x548C;octeonpciunmapsingle"><a name="a141-octeonpcimapsingle&#x548C;octeonpciunmapsingle" class="anchor-navigation-ex-anchor" href="#a141-octeonpcimapsingle&#x548C;octeonpciunmapsingle"><i class="fa fa-link" aria-hidden="true"></i></a>A141. octeon_pci_map_single&#x548C;octeon_pci_unmap_single</h5>
<pre><code class="lang-c">#define USE_PCIMAP_CALLS //&#x8FD9;&#x91CC;&#x9ED8;&#x8BA4;&#x662F;&#x6253;&#x5F00;&#x7684;
octeon_pci_map_single(cavium_pci_device_t *pci_dev, void *virt_addr,uint32_t  size, int direction)
#if defined(USE_PCIMAP_CALLS)
    physaddr = pci_map_single(pci_dev, virt_addr, size, direction);
#else
    physaddr = virt_to_phys(virt_addr);
#endif

octeon_pci_unmap_single(cavium_pci_device_t  *pci_dev, unsigned long dma_addr,
                        uint32_t  size, int direction)
#if defined(USE_PCIMAP_CALLS)
    pci_unmap_single(pci_dev, (dma_addr_t)dma_addr, size, direction);
#endif
</code></pre>
<p>&#x6CE8;:<code>octeon_pci_map_single</code>&#x7528;&#x6765;map&#x5DF2;&#x7ECF;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;</p>
<pre><code class="lang-c">desc_ring[i].info_ptr
desc_ring[i].buffer_ptr
cmd-&gt;dptr
cmd-&gt;rptr
sg_list[i].ptr[k]&#x90FD;&#x4F1A;&#x7528;&#x5230;
</code></pre>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x8BF4;&#x53EA;&#x662F;&#x4E2A;map&#x5462;? &#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;bufer&#x5DF2;&#x7ECF;&#x7533;&#x8BF7;&#x597D;&#x4E86;. &#x6BD4;&#x5982;&#x5728;</p>
<pre><code class="lang-c">octeon_droq_setup_ring_buffers&#x4E2D;
    buf = get_new_recv_buffer(droq-&gt;buffer_size);
        dev_alloc_skb(size + SKB_ADJUST) //&#x5B9E;&#x9645;&#x5E95;&#x4E0B;&#x4F7F;&#x7528;skbuf&#x7533;&#x8BF7;&#x7684;
    droq-&gt;recv_buf_list[i].data    = get_recv_buffer_data(buf);
    desc_ring[i].buffer_ptr = (uint64_t)octeon_pci_map_single(oct-&gt;pci_dev, droq-&gt;recv_buf_list[i].data, droq-&gt;buffer_size, CAVIUM_PCI_DMA_FROMDEVICE );
</code></pre>
<p>&#x8865;&#x5145;:<code>pci_map_single</code>&#x662F;&#x5E72;&#x5565;&#x7684;?&#x89C1;<code>linux/include/asm-generic/pci-dma-compat.h</code></p>
<pre><code class="lang-c">static inline dma_addr_t
pci_map_single(struct pci_dev *hwdev, void *ptr, size_t size, int direction)
    dma_map_single(hwdev == NULL ? NULL : &amp;hwdev-&gt;dev, ptr, size, (enum dma_data_direction)direction);
        struct dma_map_ops *ops = get_dma_ops(dev);
        addr = ops-&gt;map_page(dev, virt_to_page(ptr),
                 (unsigned long)ptr &amp; ~PAGE_MASK, size,
                 dir, attrs);
        return addr;
</code></pre>
<p>&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x5F3A;&#x8C03;&#x7684;&#x662F;:
&#x5B9E;&#x9645;&#x4E0A;&#x8FD9;&#x91CC;&#x7528;&#x5230;&#x4E86;IOMMU, &#x628A;ptr&#x8F6C;&#x6210;&#x4E86;IOVA(IO Virtual address)<br>&#x9A71;&#x52A8;&#x5728;&#x53D1;DMA&#x7684;command&#x4E4B;&#x524D;, &#x9700;&#x8981;&#x8C03;&#x7528;pci<em>map</em>*()&#x53BB;&#x628A;&#x5730;&#x5740;&#x8F6C;&#x6210;IO&#x865A;&#x62DF;&#x5730;&#x5740;<br>IOVA&#x662F;&#x5206;domain&#x7684;, &#x6BCF;&#x4E2A;pcie&#x7684;device&#x90FD;&#x6709;&#x81EA;&#x5DF1;&#x7684;domain, &#x5728;&#x4E00;&#x4E2A;p2p&#x6865;&#x4E0B;&#x9762;&#x7684;&#x6240;&#x6709;devices&#x5171;&#x4EAB;&#x865A;&#x62DF;&#x5730;&#x5740;&#x7A7A;&#x95F4;</p>
<p>&#x518D;&#x8865;&#x5145;:<code>octeon_pci_alloc_consistent</code>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x88AB;&#x7528;&#x6765;&#x7533;&#x8BF7;<code>droq-&gt;desc_ring&#x548C;iq-&gt;base_addr</code>&#x7684;&#x5185;&#x5B58;
&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x662F;&#x5426;&#x4FDD;&#x8BC1;&#x4E86;&#x5185;&#x5B58;&#x4E00;&#x81F4;&#x6027;???</p>
<pre><code class="lang-c">octeon_pci_alloc_consistent
    pci_alloc_consistent(pci_dev, size, (dma_addr_t *)dma_addr_ptr);
        dma_alloc_coherent(hwdev == NULL ? NULL : &amp;hwdev-&gt;dev, size, dma_handle, GFP_ATOMIC);
            struct dma_map_ops *ops = platform_dma_get_ops(dev);
            caddr = ops-&gt;alloc(dev, size, daddr, gfp, attrs);
            return caddr;
</code></pre>
<h5 id="a142-&#x5185;&#x5B58;&#x7533;&#x8BF7;&#x53CA;&#x91CA;&#x653E;"><a name="a142-&#x5185;&#x5B58;&#x7533;&#x8BF7;&#x53CA;&#x91CA;&#x653E;" class="anchor-navigation-ex-anchor" href="#a142-&#x5185;&#x5B58;&#x7533;&#x8BF7;&#x53CA;&#x91CA;&#x653E;"><i class="fa fa-link" aria-hidden="true"></i></a>A142. &#x5185;&#x5B58;&#x7533;&#x8BF7;&#x53CA;&#x91CA;&#x653E;</h5>
<p>&#x5728;<code>delete_soft_instr_buffers</code>&#x51FD;&#x6570;&#x4E2D;, &#x8C03;&#x7528;&#x4E86;&#x5F88;&#x591A;<code>cavium_free_buffer()</code>&#x51FD;&#x6570;,<br>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x548C;<code>cavium_alloc_buffer()</code>&#x4E00;&#x8D77;,&#x7BA1;&#x7406;&#x50CF;  </p>
<pre><code>soft_instr-&gt;dptr 
soft_instr 
soft_instr-&gt;gather_ptr
soft_instr-&gt;scatter_ptr
</code></pre><p>&#x8FD9;&#x6837;&#x7684;buffer<br>&#x8FD9;&#x4E9B;&#x662F;osi&#x7684;&#x63A5;&#x53E3;</p>
<pre><code class="lang-c">/*
 *  Macros that switch between using the buffer pool and the system-dependent
 *  routines based on compilation flags used.
 */
static __inline void *
cavium_alloc_buffer(octeon_device_t *octeon_dev, uint32_t size)
{
#ifdef USE_BUFFER_POOL
    //&#x4ECE;&#x9884;&#x5148;&#x5206;&#x914D;&#x7684;&#x51E0;&#x4E2A;pool&#x4E2D;&#x5206;&#x914D;, 32k, 16k, 8k, 4k, 2k...
    //&#x8D85;&#x8FC7;32k&#x7684;size&#x8FD8;&#x662F;&#x7528;cavium_malloc_dma&#x6765;&#x5206;&#x914D;
    return get_buffer_from_pool(octeon_dev, size);
#else
    //&#x5176;&#x5E95;&#x5C42;&#x5B9E;&#x73B0;&#x662F;kmalloc, &#x5728;cvm_linux_types.h
    return cavium_malloc_dma(size, __CAVIUM_MEM_ATOMIC);
#endif
}

static __inline void
cavium_free_buffer(octeon_device_t  *octeon_dev, void *buf)
{
#ifdef USE_BUFFER_POOL
     put_buffer_in_pool(octeon_dev, (uint8_t *)buf);
#else
     cavium_free_dma(buf);
#endif
}
</code></pre>
<h4 id="a15-octpollreqcompletion-1&#x4E2A;tick"><a name="a15-octpollreqcompletion-1&#x4E2A;tick" class="anchor-navigation-ex-anchor" href="#a15-octpollreqcompletion-1&#x4E2A;tick"><i class="fa fa-link" aria-hidden="true"></i></a>A15. oct_poll_req_completion, 1&#x4E2A;tick</h4>
<p>&#x548C;<code>octeon_request_completion_bh</code>&#x7C7B;&#x4F3C;
&#x5BF9;ordered list, &#x7531;&#x94FE;&#x8868;&#x5934;<br><code>&amp;octeon_dev-&gt;response_list[OCTEON_ORDERED_LIST]</code>&#x5E26;&#x9886;
&#x4E0B;&#x9762;&#x94FE;&#x8868;&#x7684;&#x5143;&#x7D20;&#x662F;<br><code>octeon_pending_entry_t</code>, &#x89C1;&#x7ED3;&#x6784;&#x4F53;E1 </p>
<pre><code class="lang-c">oct_poll_req_completion(void *octptr, unsigned long  arg)
    process_ordered_list(oct);
        //&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x662F;&#x4E00;&#x6B21;&#x5904;&#x7406;&#x7684;&#x4E0A;&#x9650;&#x503C;
        uint32_t resp_to_process = 4096;
        /*&#x6CE8;&#x610F;, &#x5982;&#x679C;&#x5B9A;&#x4E49;&#x4E86;CVMCS_DMA_IC
        **&#x5982;&#x679C;&#x4F7F;&#x80FD;&#x4E86;DMA&#x4E2D;&#x65AD;(def CVMCS_DMA_IC), &#x5C31;&#x53EF;&#x4EE5;&#x786E;&#x5207;&#x7684;&#x4F7F;&#x7528;dma_cnt_to_process
        **dma_cnt_to_process&#x8868;&#x793A;&#x5DF2;&#x7ECF;&#x6709;&#x591A;&#x5C11;&#x4E2A;&#x88AB;DMA&#x4E86;
        */
        resp_to_process = cavium_atomic_read(&amp;octeon_dev-&gt;dma_cnt_to_process);
        //&#x89C1;&#x7ED3;&#x6784;&#x4F53;F, &#x4E09;&#x4E2A;response list&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x5934;
        response_list =  &amp;octeon_dev-&gt;response_list[OCTEON_ORDERED_LIST];
        while &lt; resp_to_process
            //pending_entry&#x662F;octeon_pending_entry_t, &#x89C1;E1
            //&#x4ECE;response_list&#x53D6;&#x8282;&#x70B9;&#x4F9D;&#x6B21;&#x5904;&#x7406;
            pending_entry =  get_list_head(octeon_dev, response_list);
            soft_instr = pending_entry-&gt;instr;
            //&#x8FD9;&#x91CC;&#x7684;soft_instr-&gt;status_word&#x662F;&#x4E2A;&#x5730;&#x5740;, &#x5E94;&#x8BE5;&#x662F;octeon&#x5199;&#x56DE;status&#x7528;&#x7684;
            uint64_t   status64 = *(soft_instr-&gt;status_word); 
            status = (octeon_req_status_t) (status64 &amp; 0xffffffffULL);
            //&#x5DF2;&#x7ECF;&#x53D1;&#x9001;ok&#x4E86;
            if(status != OCTEON_REQUEST_PENDING)
                //&#x4ECE;&#x8FD9;&#x4E2A;response list&#x91CC;&#x9762;&#x5220;&#x9664;&#x8282;&#x70B9;
                release_from_response_list(octeon_dev, pending_entry);
                //&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x4F1A;&#x8C03;callback, &#x4E5F;&#x5C31;&#x662F;&#x4F1A;&#x628A;response&#x4ECE;&#x5185;&#x6838;&#x6001;&#x8003;&#x5230;&#x7528;&#x6237;&#x6001;
                release_soft_instr(octeon_dev, soft_instr, status); //&#x89C1;&#x6807;&#x8BB0;A14i1
                //&#x4ECE;pending list&#x5220;&#x9664;&#x8282;&#x70B9;
                release_from_pending_list(octeon_dev,pending_entry);
                    oct-&gt;plist-&gt;free_index--;
                    oct-&gt;plist-&gt;free_list[oct-&gt;plist-&gt;free_index] = pe-&gt;request_id;
                    pe-&gt;status = OCTEON_PENDING_ENTRY_FREE;
            else
                //&#x76F8;&#x5F53;&#x4E8E;&#x9000;&#x51FA;&#x5FAA;&#x73AF;&#x4E86;, &#x8FD9;&#x91CC;&#x4E5F;&#x6B63;&#x662F;order&#x6A21;&#x5F0F;&#x7684;&#x7CBE;&#x9AD3;! &#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x6A21;&#x5F0F;&#x4E0B;&#x7684;pending list&#x662F;&#x6839;&#x636E;&#x8BF7;&#x6C42;&#x7684;&#x987A;&#x5E8F;&#x52A0;&#x7684;, &#x800C;&#x5904;&#x7406;&#x7684;&#x7ED3;&#x679C;&#x4ECE;status&#x5F97;&#x51FA;, &#x5982;&#x679C;&#x524D;&#x9762;&#x7684;entry&#x6CA1;&#x5B8C;&#x6210;, &#x540E;&#x9762;&#x4E5F;&#x662F;&#x4E0D;&#x4F1A;&#x5B8C;&#x6210;&#x7684;.&#x6240;&#x4EE5;&#x5C31;&#x6B64;&#x9000;&#x51FA;
    //unordered blocking&#x7684;ioctl&#x4F1A;&#x963B;&#x585E;, 
    check_unordered_blocking_list(oct);
        //&#x89C1;&#x7ED3;&#x6784;&#x4F53;F, &#x4E09;&#x4E2A;response list&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x5934;
        response_list = (octeon_response_list_t *)&amp;(oct-&gt;response_list[OCTEON_UNORDERED_BLOCKING_LIST]);
        //&#x5BF9;&#x6BCF;&#x4E2A;&#x94FE;&#x8868;&#x8282;&#x70B9;
        //&#x6CE8;:&#x8FD9;&#x91CC;&#x662F;unordered, &#x5C31;&#x4E0D;&#x50CF;&#x4E0A;&#x9762;, &#x9047;&#x5230;&#x4E2A;&#x672A;&#x5904;&#x7406;&#x7684;&#x5C31;&#x9000;&#x51FA;&#x4E86;. &#x8FD9;&#x91CC;&#x662F;&#x4E00;&#x76F4;&#x904D;&#x5386;&#x8FD9;&#x4E2A;&#x94FE;&#x8868;: &#x4F46;&#x6709;&#x4E2A;&#x4EBA;&#x4E3A;&#x7684;&#x6700;&#x591A;16&#x4E2A;&#x7684;&#x9650;&#x5236;.
        cavium_list_for_each_safe(curr, tmp, &amp;response_list-&gt;head)
            pending_entry = (octeon_pending_entry_t *)curr;
            soft_instr = pending_entry-&gt;instr;
            if *(soft_instr-&gt;status_word) != COMPLETION_WORD_INIT
                uint64_t   status64 = *(soft_instr-&gt;status_word);
            else
                status = OCTEON_REQUEST_TIMEOUT;
            //&#x4E0D;pending&#x8868;&#x793A;&#x5DF2;&#x7ECF;ok&#x4E86;?
            if(status != OCTEON_REQUEST_PENDING)
                //&#x8FD9;&#x91CC;&#x53EA;&#x8C03;&#x4E2A;callback?&#x90A3;&#x4E48;&#x91CA;&#x653E;&#x8D44;&#x6E90;&#x5462;? --&#x662F;SET_REQ_INFO_CALLBACK()&#x6CE8;&#x518C;&#x7684;, &#x89C1;C12&#x91CC;&#x9762;&#x7684;&#x8C03;&#x7528;
                soft_instr-&gt;req_info.callback()
</code></pre>
<h4 id="a16-octpollcheckunorderedlist"><a name="a16-octpollcheckunorderedlist" class="anchor-navigation-ex-anchor" href="#a16-octpollcheckunorderedlist"><i class="fa fa-link" aria-hidden="true"></i></a>A16. oct_poll_check_unordered_list</h4>
<p>&#x8FD9;&#x91CC;&#x7684;&#x6CE8;&#x91CA;&#x5199;&#x7684;&#x5F88;&#x597D;, &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x662F;&#x7ED9;UNORDERED NONBLOCKING LIST&#x6536;&#x5C38;&#x7684;;
&#x8FD9;&#x4E2A;&#x7C7B;&#x578B;&#x7684;response&#x662F;&#x8981;app&#x53BB;&#x67E5;&#x8BE2;&#x5B8C;&#x6210;&#x72B6;&#x6001;&#x7684;:
app&#x8C03;&#x7528;api octeon_query_request_status(query.octeon_id,&amp;query)&#x6765;&#x67E5;&#x8BE2;.
&#x4F46;&#x5982;&#x679C;app&#x610F;&#x5916;&#x9000;&#x51FA;&#x4E86;, &#x6709;&#x4E9B;pending entry&#x5C31;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x91CA;&#x653E;&#x4E86;.</p>
<h4 id="a17-checkdroqrefill-&#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;"><a name="a17-checkdroqrefill-&#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;" class="anchor-navigation-ex-anchor" href="#a17-checkdroqrefill-&#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;"><i class="fa fa-link" aria-hidden="true"></i></a>A17. check_droq_refill, &#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;</h4>
<pre><code class="lang-c">check_droq_refill(void  *octptr, unsigned long q_no)
    droq = oct-&gt;droq[q_no];
    if (droq-&gt;refill_count &gt;= droq-&gt;refill_threshold) 
        //no dispatch&#x65F6;, buffer&#x4F1A;&#x4FDD;&#x7559;, &#x5426;&#x5219;&#x8FD8;&#x8981;&#x7533;&#x8BF7;&#x65B0;&#x7684;recv buffer
        //&#x5E76;&#x628A;droq-&gt;refill_count--;&#x89C1;A171
        desc_refilled = octeon_droq_refill(oct, droq);
        //&#x8FD9;&#x53EF;&#x80FD;&#x662F;&#x4E2A;&#x5237;cache&#x7684;&#x51FD;&#x6570;, &#x91CD;&#x8981;!&#x600E;&#x4E48;&#x5728;&#x7528;&#x6237;&#x6001;&#x5237;cache&#x5462;?
        cavium_flush_write();
        OCTEON_WRITE32(droq-&gt;pkts_credit_reg, desc_refilled);
</code></pre>
<h5 id="a171-octeondroqrefill"><a name="a171-octeondroqrefill" class="anchor-navigation-ex-anchor" href="#a171-octeondroqrefill"><i class="fa fa-link" aria-hidden="true"></i></a>A171. octeon_droq_refill</h5>
<p>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5F88;&#x591A;&#x5730;&#x65B9;&#x90FD;&#x5728;&#x8C03;</p>
<pre><code class="lang-c">octeon_droq_refill(octeon_device_t  *octeon_dev, octeon_droq_t   *droq)
   desc_ring = droq-&gt;desc_ring;
   while(droq-&gt;refill_count &amp;&amp; (desc_refilled &lt; droq-&gt;max_count)) {
        /* If a valid buffer exists (happens if there is no dispatch), reuse 
           the buffer, else allocate. */
        if(droq-&gt;recv_buf_list[droq-&gt;host_refill_index].buffer == 0) 
            //buffer&#x4E3A;NULL&#x8BF4;&#x660E;&#x5DF2;&#x7ECF;dispatch&#x4E86;? &#x6B64;&#x65F6;&#x91CD;&#x65B0;&#x7533;&#x8BF7;&#x4E00;&#x4E2A;buffer --&#x53C2;&#x8003;A182
            buf = get_new_recv_buffer(droq-&gt;buffer_size); //&#x89C1;A141
            /* If a buffer could not be allocated, no point in continuing */
            if(!buf) 
                break;
            droq-&gt;recv_buf_list[droq-&gt;host_refill_index].buffer = buf;
            data = get_recv_buffer_data(buf);
        else
            data = get_recv_buffer_data(droq-&gt;recv_buf_list[droq-&gt;host_refill_index].buffer);
#if defined(ETHERPCI)
        data += 8;
#endif
        droq-&gt;recv_buf_list[droq-&gt;host_refill_index].data = data;
        desc_ring[droq-&gt;host_refill_index].buffer_ptr = (uint64_t)octeon_pci_map_single(octeon_dev-&gt;pci_dev, data, droq-&gt;buffer_size, CAVIUM_PCI_DMA_FROMDEVICE);

        /* Reset any previous values in the length field. */
        droq-&gt;info_list[droq-&gt;host_refill_index].length = 0;

        INCR_INDEX_BY1(droq-&gt;host_refill_index, droq-&gt;max_count);
        desc_refilled++;
        droq-&gt;refill_count--;
</code></pre>
<h4 id="a18-octdroqthread-&#x6536;&#x5305;&#x7EBF;&#x7A0B;-&#x6BCF;&#x4E2A;output-q&#x4E00;&#x4E2A;"><a name="a18-octdroqthread-&#x6536;&#x5305;&#x7EBF;&#x7A0B;-&#x6BCF;&#x4E2A;output-q&#x4E00;&#x4E2A;" class="anchor-navigation-ex-anchor" href="#a18-octdroqthread-&#x6536;&#x5305;&#x7EBF;&#x7A0B;-&#x6BCF;&#x4E2A;output-q&#x4E00;&#x4E2A;"><i class="fa fa-link" aria-hidden="true"></i></a>A18. oct_droq_thread, &#x6536;&#x5305;&#x7EBF;&#x7A0B;, &#x6BCF;&#x4E2A;output q&#x4E00;&#x4E2A;</h4>
<p>&#x4F46;&#x597D;&#x50CF;&#x6CA1;&#x6253;&#x5F00;; &#x548C;A19&#x6536;&#x5305;bh&#x4E8C;&#x9009;&#x4E00;</p>
<pre><code class="lang-c">oct_droq_thread(void* arg)
    //&#x4F20;&#x5165;&#x7684;&#x662F;q&#x53F7;
    //&#x6253;&#x5370;&#x8DD1;&#x5728;smp_processor_id()&#x8FD9;&#x4E2A;&#x6838;&#x4E0A;, &#x521D;&#x59CB;&#x5316;&#x65F6;&#x7ED1;&#x5B9A;&#x8FC7;&#x7684;
    //&#x5982;&#x679C;&#x6CA1;&#x6709;stop, &#x6CA1;&#x6709;signal, &#x5E95;&#x4E0B;&#x662F;&#x7528;kthread_should_stop()&#x68C0;&#x67E5;signal&#x7684;
    //&#x5168;&#x90E8;&#x7684;&#x5E72;&#x6D3B;&#x4E3B;&#x4F53;&#x5728;&#x8FD9;&#x4E2A;&#x5FAA;&#x73AF;&#x91CC;
    while(!droq-&gt;stop_thread &amp;&amp; !cavium_kthread_signalled())
        while(cavium_atomic_read(&amp;droq-&gt;pkts_pending))
            //&#x5E72;&#x6D3B;&#x7684;&#x4E3B;&#x4F53;
            octeon_droq_process_packets(droq-&gt;oct_dev, droq);
                //pkts_pending&#x5C31;&#x662F;&#x5F85;&#x5904;&#x7406;&#x7684;&#x62A5;&#x6587;&#x6570;
                pkt_count = cavium_atomic_read(&amp;droq-&gt;pkts_pending);    
                //&#x4F55;&#x4E3A;&#x5FEB;&#x8F6C;? &#x597D;&#x50CF;&#x662F;&#x8C03;&#x4E86;octeon_register_droq_ops()&#x6CE8;&#x518C;&#x7684;, base&#x91CC;&#x9762;&#x6CA1;&#x4EBA;&#x8C03;; nic&#x6A21;&#x5757;&#x91CC;&#x9762;&#x7528;&#x5230;&#x4E86;
                if droq-&gt;fastpath_on
                    pkts_processed = octeon_droq_fast_process_packets(oct, droq, pkt_count); //&#x8981;&#x4E0D;&#x8981;&#x5173;&#x6CE8;&#x4E00;&#x4E0B;?
                else
                //&#x5982;&#x679C;&#x5B9A;&#x4E49;&#x4E86;ETHERPCI, &#x5E94;&#x8BE5;&#x6CA1;&#x6709;&#x5427;?
                    octeon_droq_drop_packets(droq, pkt_count);
                //&#x5E94;&#x8BE5;&#x662F;&#x4E0B;&#x9762;&#x7684;&#x5206;&#x652F;
                    pkts_processed = octeon_droq_slow_process_packets(oct, droq, pkt_count);
                        for(pkt = 0; pkt &lt; pkt_count; pkt++) 
                            info = &amp;(droq-&gt;info_list[droq-&gt;host_read_index]); //&#x4ECE;&#x4E0A;&#x6B21;&#x7684;&#x5730;&#x65B9;&#x5F00;&#x59CB;, &#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;G4
                            resp_hdr = (octeon_resp_hdr_t *)&amp;info-&gt;resp_hdr; //&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;G41
                            octeon_swap_8B_data((uint64_t *)info, 2);
                            //&#x8FD9;&#x91CC;&#x6709;dispatch
                            buf_cnt = octeon_droq_dispatch_pkt(oct, droq, resp_hdr, info);
                                //&#x6839;&#x636E;buffer_size&#x5F97;&#x5230;buffer count, &#x56E0;&#x4E3A;&#x6BCF;&#x4E2A;recvbuf&#x90FD;&#x662F;&#x56FA;&#x5B9A;&#x5927;&#x5C0F;, &#x800C;buffer size&#x53EF;&#x4EE5;&#x5F88;&#x5927;
                                cnt = octeon_droq_get_bufcount(droq-&gt;buffer_size, info-&gt;length);
                                //&#x6839;&#x636E;opcode&#x5F97;&#x5230;&#x5206;&#x53D1;&#x51FD;&#x6570;, &#x662F;octeon_register_dispatch_fn()&#x6CE8;&#x518C;&#x7684;, &#x89C1;A181
                                disp_fn = octeon_get_dispatch(oct, (uint16_t)resp_hdr-&gt;opcode);
                                        //&#x5728;octeon_dev-&gt;dispatch.dlist[idx]&#x91CC;&#x9762;(&#x6CE8;&#x610F;&#x8FD9;&#x53EF;&#x80FD;&#x662F;&#x4E2A;&#x94FE;&#x8868;), &#x4F9D;&#x6B21;&#x5339;&#x914D;opcode;&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;J
                                //&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x53EA;&#x6DFB;&#x52A0;droq-&gt;dispatch_list&#x8282;&#x70B9;, &#x89C1;A182, &#x771F;&#x6B63;&#x5904;&#x7406;&#x8FD9;&#x4E2A;&#x94FE;&#x8868;&#x5728;&#x4E0B;&#x9762;
                                //&#x8FD9;&#x91CC;&#x5B9E;&#x9645;&#x4E0A;&#x5DF2;&#x7ECF;&#x4ECE;&quot;&#x5E95;&#x5C42;&#x9A71;&#x52A8;&quot;&#x6536;&#x5305;&#x5C42;, &#x4E0A;&#x4EA4;&#x5230;&#x5206;&#x53D1;&#x5C42;&#x5904;&#x7406;&#x4E86;
                                rinfo = octeon_create_recv_info(oct, droq, cnt, droq-&gt;host_read_index);
                                rdisp-&gt;rinfo    = rinfo;
                                rdisp-&gt;disp_fn  = disp_fn;
                                *((uint64_t *)&amp;rinfo-&gt;recv_pkt-&gt;resp_hdr) = *((uint64_t *)resp_hdr);
                                cavium_list_add_tail(&amp;rdisp-&gt;list, &amp;droq-&gt;dispatch_list);
                            /*&#x4E0A;&#x9762;&#x5DF2;&#x7ECF;dispatch&#x4E86;, &#x4E0D;&#x7BA1;&#x662F;&#x4E0D;&#x662F;&#x6709;&#x4EBA;&#x5728;&#x5904;&#x7406;&#x8FD9;&#x4E9B;package, &#x5C06;&#x6765;&#x603B;&#x662F;&#x4F1A;&#x88AB;&#x5904;&#x7406;&#x548C;&#x56DE;&#x6536;
                            **&#x8FD9;&#x91CC;&#x628A;refill_count&#x52A0;&#x4E0A;&#x53BB;, &#x8BF4;&#x660E;&#x8BE5;&#x7533;&#x8BF7;&#x65B0;&#x7684;buf&#x4E86;
                            */
                            droq-&gt;refill_count += buf_cnt;
                            //&#x4E0B;&#x9762;&#x5224;&#x65AD;&#x662F;&#x5426;pkt&#x592A;&#x591A;, &#x8981;&#x4E22;&#x5F03;, &#x548C;droq-&gt;pkts_per_intr&#x914D;&#x7F6E;&#x6709;&#x5173;
                            if((droq-&gt;ops.drop_on_max) &amp;&amp; (pkts_to_process - pkt))
                                octeon_droq_drop_packets(droq, (pkts_to_process - pkt));
                                droq-&gt;stats.dropped_toomany += (pkts_to_process - pkt); 
                //&#x51CF;&#x6389;&#x5DF2;&#x5904;&#x7406;&#x7684;
                cavium_atomic_sub(pkts_processed, &amp;droq-&gt;pkts_pending);
                if(droq-&gt;refill_count &gt;= droq-&gt;refill_threshold)
                    //&#x548C;A17&#x7C7B;&#x4F3C;, &#x90A3;&#x4E48;&#x5982;&#x679C;&#x6709;USE_DROQ_THREADS, &#x90A3;&#x53EF;&#x80FD;&#x4E0D;&#x9700;&#x8981;A17&#x4E86;
                    desc_refilled = octeon_droq_refill(oct, droq); 
                /*&#x63A5;&#x4E0B;&#x6765;&#x904D;&#x5386;droq-&gt;dispatch_list&#x94FE;&#x8868;, &#x5176;&#x4E2D;&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#x662F;, &#x8C03;&#x7528;&#x91CC;&#x9762;&#x7684;disp_fn
                **&#x8C03;&#x7528;&#x5B8C;&#x5373;&#x5220;&#x9664;
                **struct __dispatch {
                **    cavium_list_t          list;
                **    octeon_recv_info_t    *rinfo;
                **    octeon_dispatch_fn_t   disp_fn;
                **};
                */
                disp_fn(); //&#x4ECE;&#x8FD9;&#x5C31;&#x65AD;&#x4E86;???????????????&#x600E;&#x4E48;&#x518D;&#x5F80;&#x4E0A;&#x9762;&#x8D70;?????????, &#x8DDF;scatter&#x7684;DMA&#x53C8;&#x600E;&#x4E48;&#x8054;&#x7CFB;&#x8D77;&#x6765;?--&#x4E0D;&#x7528;&#x8054;&#x7CFB;&#x8D77;&#x6765;
        //&#x5230;&#x8FD9;&#x91CC;&#x5185;&#x5C42;while&#x521A;&#x7ED3;&#x675F;, &#x7761;&#x7720;&#x7B49;&#x5F85;&#x65B0;&#x7684;pkts, &#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;&#x4F1A;&#x5524;&#x9192;
        cavium_sleep_atomic_cond(&amp;droq-&gt;wc, &amp;droq-&gt;pkts_pending);
            //&#x4EE5;&#x4E0B;&#x662F;&#x4E00;&#x4E2A;&#x5E38;&#x89C1;&#x7684;wait&#x5728;wait_queue&#x7684;&#x64CD;&#x4F5C;, &#x7B49;&#x5F85;droq-&gt;pkts_pending&#x4E0D;&#x4E3A;0
            cavium_wait_entry      we;
            cavium_init_wait_entry(&amp;we, current);
            cavium_add_to_waitq(waitq, &amp;we);
            set_current_state(TASK_INTERRUPTIBLE);
            while(!cavium_atomic_read(pcond))
                schedule();
            set_current_state(TASK_RUNNING); 
            cavium_remove_from_waitq(waitq, &amp;we);
</code></pre>
<h5 id="a181-octeonregisterdispatchfn-&#x6CE8;&#x518C;&#x6536;&#x5305;&#x5BF9;&#x5E94;&#x7684;opcode&#x51FD;&#x6570;"><a name="a181-octeonregisterdispatchfn-&#x6CE8;&#x518C;&#x6536;&#x5305;&#x5BF9;&#x5E94;&#x7684;opcode&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#a181-octeonregisterdispatchfn-&#x6CE8;&#x518C;&#x6536;&#x5305;&#x5BF9;&#x5E94;&#x7684;opcode&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>A181. octeon_register_dispatch_fn() &#x6CE8;&#x518C;&#x6536;&#x5305;&#x5BF9;&#x5E94;&#x7684;opcode&#x51FD;&#x6570;</h5>
<p>&#x6240;&#x6709;&#x7684;opcode&#x5728;&#x8FD9;&#x91CC;<code>components/driver/common/octeon-drv-opcodes.h</code>
&#x5728;&#x8FD9;&#x91CC;&#x8C03;&#x7528;</p>
<pre><code class="lang-c">octeon_setup_driver_dispatches(oct_dev-&gt;octeon_id);
        //&#x6CE8;&#x518C;&#x7684;CORE_DRV_ACTIVE_OP&#x5904;&#x7406;&#x51FD;&#x6570;, &#x4E3B;&#x8981;&#x4F5C;&#x7528;&#x662F;&#x6536;&#x5230;core OK&#x7684;&#x62A5;&#x6587;&#x540E;, &#x7F6E;oct-&gt;status&#x4E3A;OCT_DEV_CORE_OK
    octeon_register_dispatch_fn(oct_id, CORE_DRV_ACTIVE_OP, octeon_core_drv_init,
                                get_octeon_device_ptr(oct_id));
</code></pre>
<p>&#x53E6;&#x5916;&#x5728;<code>components/driver/host/test/kernel/droq_test/octeon_droq_test.c</code> &#x5185;&#x6838;&#x6D4B;&#x8BD5;&#x4EE3;&#x7801;&#x91CC;&#x9762;&#x4E5F;&#x6709;&#x6CE8;&#x518C;</p>
<pre><code class="lang-c">    if(octeon_register_dispatch_fn(OCTEON_ID, DROQ_PKT_OP1, droq_test_dispatch, NULL)) {
    if(octeon_register_dispatch_fn(OCTEON_ID, DROQ_PKT_OP2, droq_test_dispatch, NULL)) {
</code></pre>
<h5 id="a182-octeoncreaterecvinfo-&#x4ECE;&#x9A71;&#x52A8;&#x5C42;&#x5230;&#x5206;&#x53D1;&#x5C42;-&#x6BCF;&#x4E2A;&#x6765;&#x7684;&#x62A5;&#x6587;&#x90FD;&#x4F1A;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;"><a name="a182-octeoncreaterecvinfo-&#x4ECE;&#x9A71;&#x52A8;&#x5C42;&#x5230;&#x5206;&#x53D1;&#x5C42;-&#x6BCF;&#x4E2A;&#x6765;&#x7684;&#x62A5;&#x6587;&#x90FD;&#x4F1A;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;" class="anchor-navigation-ex-anchor" href="#a182-octeoncreaterecvinfo-&#x4ECE;&#x9A71;&#x52A8;&#x5C42;&#x5230;&#x5206;&#x53D1;&#x5C42;-&#x6BCF;&#x4E2A;&#x6765;&#x7684;&#x62A5;&#x6587;&#x90FD;&#x4F1A;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;"><i class="fa fa-link" aria-hidden="true"></i></a>A182. octeon_create_recv_info(), &#x4ECE;&#x9A71;&#x52A8;&#x5C42;&#x5230;&#x5206;&#x53D1;&#x5C42;, &#x6BCF;&#x4E2A;&#x6765;&#x7684;&#x62A5;&#x6587;&#x90FD;&#x4F1A;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;</h5>
<pre><code class="lang-c">/** Receive Packet format used when dispatching output queue packets
    with non-raw opcodes.
    The received packet will be sent to the upper layers using this
    structure which is passed as a parameter to the dispatch function 
*/
typedef struct {
  /**  Number of buffers in this received packet */
   uint16_t               buffer_count; 
  /** Id of the device that is sending the packet up */
   uint8_t                octeon_id;
  /** The type of buffer contained in the buffer ptr&apos;s for this recv pkt. */
   uint8_t                buf_type;
  /** Length of data in the packet buffer */
   uint32_t               length;
  /** The response header */
   octeon_resp_hdr_t      resp_hdr;
  /** Pointer to the OS-specific packet buffer */
   void                  *buffer_ptr[MAX_RECV_BUFS]; 
  /** Size of the buffers pointed to by ptr&apos;s in buffer_ptr */
   uint32_t               buffer_size[MAX_RECV_BUFS];
} octeon_recv_pkt_t;

/** The first parameter of a dispatch function.
    For a raw mode opcode, the driver dispatches with the device 
    pointer in this structure. 
    For non-raw mode opcode, the driver dispatches the recv_pkt_t
    created to contain the buffers with data received from Octeon.
    ---------------------
    |     *recv_pkt ----|---
    |-------------------|   |
    | 0 or more bytes   |   |
    | reserved by driver|   |
    |-------------------|&lt;-/
    | octeon_recv_pkt_t |
    |                   |
    |___________________|
*/
typedef struct {
    void                     *rsvd;
    octeon_recv_pkt_t        *recv_pkt;
} octeon_recv_info_t;

struct __dispatch {
    cavium_list_t          list;
    octeon_recv_info_t    *rinfo;
    octeon_dispatch_fn_t   disp_fn;
};
</code></pre>
<pre><code class="lang-c">octeon_create_recv_info(octeon_device_t  *octeon_dev,
                        octeon_droq_t    *droq,
                        uint32_t          buf_cnt,
                        uint32_t          idx)
   //&#x89C1;G4
   octeon_droq_info_t    *info;
   octeon_recv_pkt_t     *recv_pkt; //&#x89C1;&#x4E0A;
   octeon_recv_info_t    *recv_info; //&#x89C1;&#x4E0A;
   uint32_t               i, bytes_left;

   info = &amp;droq-&gt;info_list[idx];
   recv_info = octeon_alloc_recv_info(sizeof(struct __dispatch));
       //&#x4EE5;&#x4E0A;&#x4E24;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x7684;size&#x52A0;&#x8D77;&#x6765;&#x518D;&#x52A0;extra_bytes, &#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x91CC;&#x8981;&#x7528;DMA&#x7684;&#x5185;&#x5B58;?????
       buf = cavium_malloc_dma(OCT_RECV_PKT_SIZE + OCT_RECV_INFO_SIZE + extra_bytes, __CAVIUM_MEM_ATOMIC);
       recv_info = (octeon_recv_info_t *)buf;
       recv_info-&gt;recv_pkt = (octeon_recv_pkt_t *)(buf + OCT_RECV_INFO_SIZE);
       recv_info-&gt;rsvd = NULL;
       if(extra_bytes)
           recv_info-&gt;rsvd = buf + OCT_RECV_INFO_SIZE + OCT_RECV_PKT_SIZE;
   recv_pkt = recv_info-&gt;recv_pkt;

   recv_pkt-&gt;resp_hdr      =  info-&gt;resp_hdr;
   recv_pkt-&gt;length        =  info-&gt;length;
   recv_pkt-&gt;buffer_count  =  (uint16_t)buf_cnt;
   recv_pkt-&gt;octeon_id     =  (uint16_t)octeon_dev-&gt;octeon_id;
   recv_pkt-&gt;buf_type      = OCT_RECV_BUF_TYPE_2;

   i = 0;
   bytes_left = info-&gt;length;
   //&#x4E00;&#x4E2A;&#x5927;&#x62A5;&#x6587;&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x4E2A;buf_cnt
   while(buf_cnt)
      octeon_pci_unmap_single(octeon_dev-&gt;pci_dev, (unsigned long)droq-&gt;desc_ring[idx].buffer_ptr, droq-&gt;buffer_size, CAVIUM_PCI_DMA_FROMDEVICE);

      recv_pkt-&gt;buffer_size[i] =
      (bytes_left &gt;= droq-&gt;buffer_size)?droq-&gt;buffer_size: bytes_left;
      //&#x8FD9;&#x91CC;&#x4E0D;&#x662F;&#x628A;buffer&#x62F7;&#x8D1D;&#x8FC7;&#x53BB;, &#x800C;&#x53EA;&#x662F;&#x586B;&#x6307;&#x9488;, &#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x628A;buffer&#x632A;&#x4E2A;&#x4F4D;&#x7F6E;&#x5462;? 
      //&#x5176;&#x5B9E;&#x8FD9;&#x91CC;&#x662F;&#x4E2A;&#x5206;&#x5C42;, droq-&gt;recv_buf_list[idx].buffer&#x662F;&#x4E0B;&#x5C42;&#x7684;buffer --&#x5C31;&#x662F;&#x7528;skb&#x7533;&#x8BF7;&#x7684;buffer, &#x5BF9;&#x5E94;&#x786C;&#x4EF6;DMA&#x7684;output buffer
      //recv_pkt-&gt;buffer_ptr[i]&#x662F;&#x4E0A;&#x5C42;&#x7684;buffer, &#x4F46;&#x4ECE;&#x5E95;&#x5C42;&#x5230;&#x4E0A;&#x5C42;&#x4E0D;&#x662F;buffer&#x62F7;&#x8D1D;, &#x800C;&#x53EA;&#x662F;&#x6307;&#x9488;&#x8F6C;&#x79FB;
      //&#x90A3;&#x4E48;&#x6B64;&#x65F6;, &#x5E95;&#x5C42;&#x7684;buffer&#x5C31;&#x53EF;&#x4EE5;&#x91CD;&#x65B0;&#x7533;&#x8BF7;&#x4E86;.
      recv_pkt-&gt;buffer_ptr[i]  = droq-&gt;recv_buf_list[idx].buffer;
      //&#x5E95;&#x5C42;&#x7684;buffer&#x5DF2;&#x7ECF;&#x8F6C;&#x79FB;&#x7ED9;&#x4E0A;&#x5C42;&#x4E86;; &#x8FD9;&#x91CC;&#x8D4B;&#x503C;0, &#x5728;output buffer refill&#x73AF;&#x8282;&#x91CD;&#x65B0;&#x7533;&#x8BF7;buffer,&#x53C2;&#x8003;A171
      droq-&gt;recv_buf_list[idx].buffer = 0;

      INCR_INDEX_BY1(idx, droq-&gt;max_count);
      bytes_left -= droq-&gt;buffer_size;
      i++; buf_cnt--;

   return recv_info;
</code></pre>
<h4 id="a19-octeondroqbh"><a name="a19-octeondroqbh" class="anchor-navigation-ex-anchor" href="#a19-octeondroqbh"><i class="fa fa-link" aria-hidden="true"></i></a>A19. octeon_droq_bh</h4>
<pre><code class="lang-c">octeon_droq_bh(unsigned long  pdev)
    for(q_no = 0; q_no &lt; oct-&gt;num_oqs; q_no++)
        reschedule |= octeon_droq_process_packets(oct, oct-&gt;droq[q_no]); //&#x53C2;&#x8003;A18
    if(reschedule)
        //&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7528;&#x6765;&#x89E6;&#x53D1;tasklet, &#x4E00;&#x822C;&#x4F1A;&#x5728;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;&#x8C03;
        cavium_tasklet_schedule(&amp;oct-&gt;droq_tasklet);
</code></pre>
<h2 id="b-octpollthread-&#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;"><a name="b-octpollthread-&#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;" class="anchor-navigation-ex-anchor" href="#b-octpollthread-&#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a>5.2. B. oct_poll_thread, &#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;</h2>
<pre><code class="lang-c">oct_poll_thread(void* arg)
    while !cavium_kthread_signalled()
        //&#x5BF9;&#x6BCF;&#x4E2A;octeon&#x8BBE;&#x5907;
        oct_process_poll_list(get_octeon_device(i));
            poll_list = (octeon_poll_fn_node_t *)oct-&gt;poll_list;
            //&#x5BF9;poll_list&#x91CC;&#x9762;&#x6700;&#x591A;64&#x4E2A;fn&#x4F9D;&#x6B21;&#x8C03;&#x7528;
            //&#x8FD9;&#x91CC;&#x7684;&#x51FD;&#x6570;&#x7531;octeon_register_poll_fn()&#x6CE8;&#x518C;
            //&#x6839;&#x636E;&#x524D;&#x9762;&#x5206;&#x6790;, &#x5DF2;&#x7ECF;&#x6CE8;&#x518C;&#x7684;&#x51FD;&#x6570;&#x6709;:A13 A14 A15 A16 A17
            n = (octeon_poll_fn_node_t *)&amp;poll_list[i];
            ret = n-&gt;fn((void *)oct, n-&gt;fn_arg);

        cavium_sleep_timeout(1); //1&#x4E2A;jiffy
            set_current_state(TASK_INTERRUPTIBLE);  
            schedule_timeout(timeout);              
            set_current_state(TASK_RUNNING);
</code></pre>
<h2 id="c-octeonfops-&#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl"><a name="c-octeonfops-&#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl" class="anchor-navigation-ex-anchor" href="#c-octeonfops-&#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl"><i class="fa fa-link" aria-hidden="true"></i></a>5.3. C. octeon_fops: &#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl</h2>
<pre><code class="lang-c">static struct file_operations octeon_fops =
{
   open:      octeon_open,
   release:   octeon_release,
   read:      NULL,
   write:     NULL,
   ioctl:     octeon_ioctl, //&#x89C1;C1
#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,6,11)
   unlocked_ioctl: octeon_unlocked_ioctl,
   compat_ioctl:  octeon_compat_ioctl,
#endif
   mmap:      NULL
};
</code></pre>
<h3 id="c1-octeonioctl"><a name="c1-octeonioctl" class="anchor-navigation-ex-anchor" href="#c1-octeonioctl"><i class="fa fa-link" aria-hidden="true"></i></a>5.3.1. C1. octeon_ioctl</h3>
<pre><code class="lang-c">int octeon_ioctl (struct inode   *inode,
                  struct file    *file, 
                  unsigned int   cmd,
                  unsigned long  arg)
   switch(cmd)  {
      case IOCTL_OCTEON_HOT_RESET:
           retval = octeon_ioctl_hot_reset(cmd, (void *)arg);
        //arg&#x662F;octeon_rw_reg_buf_t 
        //&#x5148;copy_from_user
        cavium_copy_in(&amp;rw_buf, arg, OCTEON_RW_REG_BUF_SIZE)
        //&#x5F97;&#x5230;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;
        oct_dev = get_octeon_device(rw_buf.oct_id);
        octeon_hot_reset(oct_dev);
            /*&#x6211;&#x89C9;&#x5F97;&#x4E00;&#x4E2A;&#x5178;&#x578B;&#x7684;&#x91CD;&#x542F;&#x67B6;&#x6784;&#x5E94;&#x8BE5;&#x662F;&#x91CD;&#x542F;&#x51FD;&#x6570;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x53D8;&#x91CF;
            **&#x771F;&#x6B63;&#x5E72;&#x6D3B;&#x7684;&#x4EFB;&#x52A1;&#x6216;&#x8D44;&#x6E90;&#x4E3B;&#x4F53;&#x5728;&#x4E3B;&#x5FAA;&#x73AF;&#x91CC;&#x4E3B;&#x52A8;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x88AB;stop&#x4E86;
            **&#x4ECE;&#x800C;&#x5E72;&#x51C0;&#x7684;&#x6E05;&#x9664;&#x8D44;&#x6E90;
            **&#x8FD9;&#x6837;&#x7684;&#x597D;&#x5904;&#x662F;&#x529F;&#x80FD;&#x4EE3;&#x7801;&#x96C6;&#x4E2D;&#x5728;&#x4E00;&#x8D77;&#x4F7F;&#x7528;&#x548C;&#x91CA;&#x653E;
            **&#x800C;&#x4E0D;&#x7528;&#x628A;&#x91CA;&#x653E;&#x8D44;&#x6E90;&#x7684;&#x51FD;&#x6570;&#x5168;&#x90E8;&#x96C6;&#x4E2D;&#x5728;&#x53D1;&#x8D77;stop&#x7684;&#x51FD;&#x6570;&#x91CC;&#x6267;&#x884C;
            */
            //&#x8FD9;&#x91CC;&#x9762;&#x4E5F;&#x662F;, &#x6839;&#x636E;&#x5F53;&#x524D;&#x7684;&#x72B6;&#x6001;&#x5B57;&#x6765;&#x5E72;&#x6D3B;.
            //&#x603B;&#x4F53;&#x4E0A;&#x662F;&#x53D1;stop&#x547D;&#x4EE4;&#x7ED9;octeon,&#x7B49;&#x5F85;&#x4E00;&#x4E9B;&#x6D3B;&#x5E72;&#x5B8C;, &#x590D;&#x4F4D;&#x4E00;&#x4E9B;&#x53D8;&#x91CF;
            //&#x6700;&#x540E;&#x6CE8;&#x518C;oct_poll_module_starter()&#x51FD;&#x6570;&#x5230;poll&#x8FDB;&#x7A0B;, &#x89C1;C11

           break;

      case IOCTL_OCTEON_SEND_REQUEST:
           retval = octeon_ioctl_send_request(cmd, (void *)arg); //&#x89C1;C12
           break;

      case IOCTL_OCTEON_QUERY_REQUEST:
           retval = octeon_ioctl_query_request(cmd, (void *)arg); 
               //&#x67E5;&#x8BE2;, &#x7ED3;&#x679C;&#x5230;octeon_query_request_t   
           break;

      case IOCTL_OCTEON_STATS:
           retval = octeon_ioctl_stats(cmd, (void *)arg);
           break;

      case IOCTL_OCTEON_READ32:
      case IOCTL_OCTEON_READ16:
      case IOCTL_OCTEON_READ8:
      case IOCTL_OCTEON_READ_PCI_CONFIG:
      case IOCTL_OCTEON_WIN_READ:
           retval = octeon_ioctl_read(cmd, (void *)arg);
           break;


      case IOCTL_OCTEON_WRITE32:
      case IOCTL_OCTEON_WRITE16:
      case IOCTL_OCTEON_WRITE8:
      case IOCTL_OCTEON_WRITE_PCI_CONFIG:
      case IOCTL_OCTEON_WIN_WRITE:
           retval = octeon_ioctl_write(cmd, (void *)arg);
           break;

      case IOCTL_OCTEON_CORE_MEM_READ:
           retval = octeon_ioctl_read_core_mem(cmd, (void *)arg);
           break;

      case IOCTL_OCTEON_CORE_MEM_WRITE:
           retval = octeon_ioctl_write_core_mem(cmd, (void *)arg);
           break;

      case IOCTL_OCTEON_GET_DEV_COUNT:
           retval = octeon_ioctl_get_dev_count(cmd, (void *)arg);
           break;

      case IOCTL_OCTEON_GET_MAPPING_INFO: 
           retval = octeon_ioctl_get_mapping_info(cmd, (void *)arg);
           break;

      default:
           cavium_error(&quot;octeon_ioctl: Unknown ioctl command\n&quot;);
           retval = -ENOTTY;
           break;
   }  /* switch */
</code></pre>
<h4 id="c11octpollmodulestarter"><a name="c11octpollmodulestarter" class="anchor-navigation-ex-anchor" href="#c11octpollmodulestarter"><i class="fa fa-link" aria-hidden="true"></i></a>C11.oct_poll_module_starter()</h4>
<h4 id="c12octeonioctlsendrequest"><a name="c12octeonioctlsendrequest" class="anchor-navigation-ex-anchor" href="#c12octeonioctlsendrequest"><i class="fa fa-link" aria-hidden="true"></i></a>C12.octeon_ioctl_send_request</h4>
<pre><code class="lang-c">typedef struct {
        /** wait channel head for this request. */
        cavium_wait_channel   wait_head;
        /** completion condition */
        int                   condition;
        /** Status of request. Used in NORESPONSE completion. */
        octeon_req_status_t   status;
} octeon_user_req_complete_t;
</code></pre>
<pre><code class="lang-c">copy buffer &#x65E2;&#x7BA1;input&#x53C8;&#x7BA1;ouput, &#x8FD9;&#x4E9B;&#x662F;&#x5728;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#x7684;&#x62F7;&#x8D1D;
/**  This structure is used to copy the response for a request
     from kernel space to user space.
*/
typedef struct {
  /** The kernel Input buffer. */
  uint8_t                    *kern_inptr;
  /** Size of the kernel output buffer. */
   uint32_t                   kern_outsize;
  /** Address of the kernel output buffer. */
   uint8_t                   *kern_outptr;
  /** Number of user space buffers */
   uint32_t                   user_bufcnt;
  /** Address of user-space buffers. */
   uint8_t                   *user_ptr[MAX_BUFCNT];
  /** Size of each user-space buffer. */
   uint32_t                   user_size[MAX_BUFCNT];
  /** The octeon device from which response is awaited. */
  octeon_device_t            *octeon_dev;
  /** Wait queue and completion flag for user request. */
  octeon_user_req_complete_t *comp;
}octeon_copy_buffer_t;
</code></pre>
<pre><code class="lang-c">int octeon_ioctl_send_request(unsigned int   cmd,
                              void          *arg)
    //&#x4ECE;&#x5185;&#x6838;&#x65B0;&#x7533;&#x8BF7;octeon_soft_request_t&#x7ED3;&#x6784;, &#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x89C1;app&#x7BC7; &#x91CD;&#x8981;&#x7ED3;&#x6784;&#x4F53;
    soft_req = (octeon_soft_request_t *)cavium_alloc_buffer(octeon_dev, OCT_SOFT_REQUEST_SIZE);
    //&#x628A;&#x7528;&#x6237;&#x6001;&#x7684;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x62F7;&#x8FDB;&#x53BB;
    cavium_copy_in(soft_req, (void *)arg, OCT_SOFT_REQUEST_SIZE)
    //&#x540C;&#x6837;&#x7684;&#x65B9;&#x6CD5;&#x628A;&#x7528;&#x6237;&#x7684;octeon_request_info_t&#x62F7;&#x8FDB;&#x53BB;
    req_info = (octeon_request_info_t *)cavium_alloc_buffer(octeon_dev, OCT_REQ_INFO_SIZE);
    cavium_copy_in((void *)req_info, (void *)user_req_info, OCT_USER_REQ_INFO_SIZE)

    resp_order = GET_SOFT_REQ_RESP_ORDER(soft_req);
    resp_mode  = GET_SOFT_REQ_RESP_MODE(soft_req);
    dma_mode   = GET_SOFT_REQ_DMA_MODE(soft_req);
    //&#x83B7;&#x5F97;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;
    octeon_dev = get_octeon_device(GET_REQ_INFO_OCTEON_ID(req_info));

    if (resp_mode == OCTEON_RESP_BLOCKING) 
        //&#x56E0;&#x4E3A;block&#x7684;&#x8BF7;&#x6C42;&#x8981;wait&#x5728;&#x4E00;&#x4E2A;&#x7B49;&#x5F85;&#x961F;&#x5217;&#x91CC;, &#x5728;linux&#x4E0B;&#x662F;wait_queue_head_t
        //comp&#x662F;octeon_user_req_complete_t, &#x89C1;&#x4E0A;&#x9762;&#x7ED3;&#x6784;&#x4F53;
        comp = octeon_alloc_user_req_complete(octeon_dev);

    //&#x5F00;&#x59CB;&#x62F7;&#x8D1D;input&#x6570;&#x636E;&#x7684;buf, &#x603B;&#x7684;&#x539F;&#x5219;&#x662F;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x7684;buf&#x8003;&#x5230;&#x5185;&#x6838;&#x8FDE;&#x7EED;&#x7A7A;&#x95F4;&#x7684;buf
    //&#x5E76;&#x66FF;&#x6362;&#x76F8;&#x5E94;&#x7684;&#x6307;&#x9488;&#x5730;&#x5740;(&#x4ECE;&#x6307;&#x5411;user&#x7684;&#x5730;&#x5740;&#x53D8;&#x4E3A;&#x6307;&#x5411;&#x65B0;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x6838;&#x5730;&#x5740;)
    if(soft_req-&gt;inbuf.cnt) {
        if((dma_mode == OCTEON_DMA_DIRECT) || (dma_mode == OCTEON_DMA_SCATTER))
            //gather&#x6A21;&#x5F0F;&#x4E0B;, &#x7528;inbuf.ptr[(idx)].addr&#x8FD9;&#x4E2A;&#x6570;&#x7EC4;
            //&#x975E;gather&#x6A21;&#x5F0F;&#x4E0B;, &#x53EA;&#x7528;inbuf.ptr[0]
            retval = octeon_copy_input_dma_buffers(octeon_dev, soft_req, 0); //&#x89C1;C121
        else
            retval = octeon_copy_input_dma_buffers(octeon_dev, soft_req, 1);
        if(retval)
            goto free_req_info;
    } else {
        soft_req-&gt;inbuf.cnt = 0;
        soft_req-&gt;inbuf.size[0] = 0;
        SOFT_REQ_INBUF(soft_req, 0)  = NULL;
    }

    //&#x7533;&#x8BF7;octeon_copy_buffer_t&#x7684;buffer, &#x7528;&#x6765;&#x628A;response&#x62F7;&#x56DE;user&#x7A7A;&#x95F4;
    //copy_buf&#x662F;octeon_copy_buffer_t, &#x89C1;&#x4E0A;&#x9762;&#x7ED3;&#x6784;&#x4F53;
    copy_buf = cavium_alloc_buffer(octeon_dev, sizeof(octeon_copy_buffer_t));
    //&#x8FD9;&#x91CC;&#x53EA;&#x7528;0&#x662F;&#x56E0;&#x4E3A;&#x4ECE;&#x7528;&#x6237;&#x6001;&#x62F7;&#x8D1D;&#x5230;&#x5185;&#x6838;&#x6001;&#x53D8;&#x6210;&#x4E86;&#x4E00;&#x4E2A;&#x6574;&#x7684;buffer
    copy_buf-&gt;kern_inptr = SOFT_REQ_INBUF(soft_req, 0);
    copy_buf-&gt;octeon_dev = octeon_dev;
    copy_buf-&gt;comp       = comp;
    //noresponse&#x6A21;&#x5F0F;&#x4E0B;, &#x4E0D;&#x7528;&#x7533;&#x8BF7;output buf
        soft_req-&gt;outbuf.cnt     = 0;
        soft_req-&gt;outbuf.size[0] = 0;
        SOFT_REQ_OUTBUF(soft_req, 0)  = NULL;
        copy_buf-&gt;user_bufcnt    = 0;
    //&#x4EE5;&#x4E0B;&#x662F;response&#x6A21;&#x5F0F;, &#x7533;&#x8BF7;&#x5728;&#x5185;&#x6838;&#x6001;&#x7528;&#x7684;response buffer
        retval = octeon_create_output_dma_buffers(octeon_dev, soft_req,...); //&#x89C1;C122
    //&#x5B8C;&#x4E8B;&#x8FD8;&#x5F97;&#x62F7;&#x56DE;&#x7528;&#x6237;&#x6001;, &#x95EE;&#x9898;&#x662F;&#x8C01;&#x8C03;&#x4E86;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5462;? --&#x88AB;&#x6CE8;&#x91CA;&#x6389;&#x7684;A16&#x548C;release_soft_instr(), A14&#x548C;A15&#x90FD;&#x4F1A;&#x8C03;
    SET_REQ_INFO_CALLBACK(req_info, octeon_copy_user_buffer, copy_buf);
                    //&#x4E0B;&#x9762;&#x662F;octeon_copy_user_buffer()&#x505A;&#x7684;&#x4E8B;&#x60C5;
                    //1. &#x8FD9;&#x4E2A;request&#x662F;&#x963B;&#x585E;&#x7684;
                    if(copy_buf-&gt;comp)
                        copy_buf-&gt;comp-&gt;condition = 1;
                        copy_buf-&gt;comp-&gt;status    = status;
                        //&#x5524;&#x9192;&#x963B;&#x585E;&#x7684;&#x8FDB;&#x7A0B;
                        cavium_wakeup(&amp;(copy_buf-&gt;comp-&gt;wait_head));
                    2. &#x975E;&#x963B;&#x585E;&#x7684;, &#x5728;&#x8FD9;&#x91CC;&#x62F7;&#x8D1D;
                    else
                    /* For non-blocking there is no process sleeping. So do copy
                       to user here and free buffers here. */
                    if(copy_buf-&gt;kern_inptr) {
                        cavium_free_buffer(octeon_dev, copy_buf-&gt;kern_inptr);

                    if(copy_buf-&gt;user_bufcnt) {
                        //&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x628A;copy_buf-&gt;kern_outptr + 8&#x7684;buf&#x8003;&#x5230;&#x7528;&#x6237;&#x6001;
                        //&#x770B;&#x4E86;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x5B9E;&#x73B0;&#x5C31;&#x77E5;&#x9053;&#x4E3A;&#x4EC0;&#x4E48;&#x5185;&#x6838;&#x6001;&#x7533;&#x8BF7;&#x7684;buf&#x90FD;&#x662F;&#x4E00;&#x6574;&#x5757;&#x7684;&#x4E86;
                        octeon_user_req_copyout_response(copy_buf, status);

                    if(copy_buf-&gt;kern_outptr) {
                        cavium_free_buffer(octeon_dev, copy_buf-&gt;kern_outptr);

                    cavium_free_buffer(octeon_dev, copy_buf);

    //&#x8FD9;&#x4E2A;&#x91CD;&#x8981;&#x4E86;
    status = __do_request_processing(octeon_dev, soft_req);
        //&#x5148;&#x7533;&#x8BF7;&#x91CD;&#x8981;&#x7ED3;&#x6784;&#x4F53;octeon_soft_instruction_t si, &#x89C1;E11
        si = cavium_alloc_buffer()
        //&#x5F00;&#x59CB;&#x4ECE;soft_req&#x5F80;si&#x91CC;&#x636F;&#x996C;
        cavium_memcpy(&amp;si-&gt;exhdr_info, &amp;sr-&gt;exhdr_info, OCT_EXHDR_INFO_SIZE);
        cavium_memcpy(&amp;si-&gt;req_info, SOFT_REQ_INFO(sr), OCT_REQ_INFO_SIZE);
        si-&gt;ih   = sr-&gt;ih;
        si-&gt;irh  = sr-&gt;irh;
        //&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5173;&#x952E;&#x4E86;! &#x5E26;&#x7740;&#x95EE;&#x9898;, &#x524D;&#x9762;&#x5DF2;&#x7ECF;&#x628A;&#x5185;&#x6838;&#x6001;&#x7684;input&#x548C;output&#x7684;buffer&#x90FD;&#x641E;&#x5B9A;&#x4E86;&#x5440;(C121, C122)? &#x800C;&#x4E14;&#x66F4;&#x5E95;&#x5C42;&#x7684;output buffer&#x4E5F;OK&#x4E86;(A1i1&#x548C;A17), &#x8FD9;&#x91CC;&#x641E;&#x5565;? --dptr&#x548C;rptr
        octeon_create_data_buf(oct, si, sr) //&#x89C1;C123    
        //&#x8C03;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E4B;&#x524D;, input output bufer&#x8981;&#x51C6;&#x5907;&#x597D;, dptr&#x548C;rptr&#x4E5F;&#x8981;&#x51C6;&#x5907;&#x597D;&#xFF1B; --&#x6240;&#x6709;buffer&#x90FD;&#x8981;&#x51C6;&#x5907;&#x597D;
        retval = __do_instruction_processing(oct, si, sr);
            irh = (uint64_t*)&amp;si-&gt;irh;
            ih  = (uint64_t*)&amp;si-&gt;ih;
            si-&gt;irh.pcie_port = oct-&gt;pcie_port;
            resp_order = SOFT_INSTR_RESP_ORDER(si);
            resp_mode  = SOFT_INSTR_RESP_MODE(si);
            iq_no      = SOFT_INSTR_IQ_NO(si);
            //&#x5F97;&#x5230;iq&#x53F7;
            iq = oct-&gt;instr_queue[iq_no];
            cmd = &amp;si-&gt;command; //&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;E114
            //&#x6CE8;&#x610F;: si-&gt;dptr&#x662F;&#x865A;&#x62DF;&#x5730;&#x5740;, &#x8FD9;&#x91CC;&#x7528;pci_map*&#x51FD;&#x6570;&#x628A;&#x8FD9;&#x4E2A;&#x865A;&#x62DF;&#x5730;&#x5740;&#x8F6C;&#x4E3A;iommu&#x5730;&#x5740;, &#x8F6C;&#x5230;cmd-&gt;dptr&#x91CC;
            if(si-&gt;dptr)    
                //gather&#x6A21;&#x5F0F;&#x4E0B;, &#x786C;&#x4EF6;&#x770B;&#x5230;&#x7684;&#x662F;octeon_sg_entry_t&#x7684;&#x6570;&#x7EC4;, &#x89C1;C1231
                cmd-&gt;dptr = (uint64_t)octeon_pci_map_single(si-&gt;dptr,...)
                //&#x975E;gather&#x6A21;&#x5F0F;&#x4E0B;, &#x662F;&#x4E00;&#x4E2A;bufer&#x5730;&#x5740;
                cmd-&gt;dptr = (uint64_t)octeon_pci_map_single(si-&gt;dptr,...)
            if(si-&gt;rptr)
                //&#x548C;&#x4E0A;&#x9762;&#x5DEE;&#x4E0D;&#x591A;
            //&#x8BBE;&#x8D85;&#x65F6;&#x65F6;&#x95F4;
            si-&gt;timeout = cavium_jiffies + SOFT_INSTR_TIMEOUT(si);
            if(resp_order != OCTEON_RESP_NORESPONSE) 
                //&#x52A0;&#x5230;pending list, &#x8FD9;&#x662F;&#x7B49;&#x5F85;&#x94FE;&#x8868; &#x5728;A15&#x91CC;&#x9762;&#x5904;&#x7406;
                pending_entry =  add_to_pending_list(oct, si);
                    //&#x4ECE;oct-&gt;plist-&gt;list[]&#x6570;&#x7EC4;&#x91CC;&#x627E;&#x4E2A;&#x7A7A;&#x4F4D;&#x7F6E;, &#x628A;&#x8FD9;&#x4E2A;command&#x52A0;&#x5230;list
                    //&#x6B64;&#x65F6;free index&#x4E0D;&#x80FD;&#x8D85;&#x8FC7;&#x603B;&#x7684;size
                    if (oct-&gt;plist-&gt;free_index == oct-&gt;pend_list_size))
                        return ERROR;
                    pl_index = oct-&gt;plist-&gt;free_list[oct-&gt;plist-&gt;free_index];
                    //&#x8FD9;&#x4E2A;index&#x5BF9;&#x5E94;&#x7684;node&#x5E94;&#x8BE5;&#x662F;free&#x7684;
                    if(oct-&gt;plist-&gt;list[pl_index].status != OCTEON_PENDING_ENTRY_FREE)
                        return ERROR;
                    oct-&gt;plist-&gt;free_index++;
                    oct-&gt;plist-&gt;list[pl_index].instr      = si;
                    oct-&gt;plist-&gt;list[pl_index].request_id = pl_index;
                    oct-&gt;plist-&gt;list[pl_index].status     = OCTEON_PENDING_ENTRY_USED;
                    oct-&gt;plist-&gt;list[pl_index].iq_no      = SOFT_INSTR_IQ_NO(si);
                    //instr_count&#x8868;&#x793A;pending&#x7684;&#x547D;&#x4EE4;&#x6570;
                    cavium_atomic_inc(&amp;oct-&gt;plist-&gt;instr_count);
                    //&#x66F4;&#x65B0;&#x4E00;&#x4E9B;status
                    si-&gt;req_info.status     = OCTEON_REQUEST_PENDING;
                    si-&gt;irh.rid             = pl_index;
                    si-&gt;req_info.request_id = pl_index;

            cmd-&gt;ih   = *ih;
            cmd-&gt;irh  = *irh;
            //&#x8FD4;&#x56DE;&#x503C;&#x662F;   index = iq-&gt;host_write_index;
            q_index = post_command64B(oct, iq,...) //&#x5B9E;&#x8D28;&#x5C31;&#x662F;ring_doorbell(iq);
                __post_command(oct, iq, force_db, (uint8_t *)cmd64);
                    //&#x628A;cmd&#x62F7;&#x5230;iq&#x4E2D;&#x53BB;
                    __copy_cmd_into_iq(iq, cmd);
                        iqptr = iq-&gt;base_addr + (cmdsize * iq-&gt;host_write_index);
                        cavium_memcpy(iqptr, cmd, cmdsize);
                    //&#x66F4;&#x65B0;host_write_index
                    index = iq-&gt;host_write_index;
                    INCR_INDEX_BY1(iq-&gt;host_write_index, iq-&gt;max_count);
                    iq-&gt;fill_cnt++;
                    /* Flush the command into memory. */
                    cavium_flush_write(); //wmb()
                    //&#x8D85;&#x8FC7;fill_threshold&#x624D;&#x6309;&#x95E8;&#x94C3;
                    if(iq-&gt;fill_cnt &gt;= iq-&gt;fill_threshold || force_db)
                        ring_doorbell(iq);
                            OCTEON_WRITE32(iq-&gt;doorbell_reg, iq-&gt;fill_cnt);
                            iq-&gt;fill_cnt     = 0;
                            iq-&gt;last_db_time = cavium_jiffies;
                    cavium_atomic_inc(&amp;iq-&gt;instr_pending);

            if(q_index &gt;= 0)
                if(resp_order == OCTEON_RESP_NORESPONSE) 
                    //&#x8C01;&#x6765;&#x5904;&#x7406;? --A14
                    __add_to_nrlist(iq, q_index, si, NORESP_BUFTYPE_INSTR);
                else 
                    pending_entry-&gt;queue_index = q_index;
                //&#x81F3;&#x6B64;&#x8FD9;&#x4E2A;command&#x5DF2;&#x7ECF;&#x53D1;&#x9001;&#x5230;iq&#x91CC;&#x9762;&#x4E86;, &#x7136;&#x540E;&#x5C31;&#x662F;octeon&#x53D6;command&#x6267;&#x884C;

                retval.s.request_id = si-&gt;req_info.request_id;
                retval.s.error       = 0;
                retval.s.status     = si-&gt;req_info.status;
                if(sr)
                    SOFT_REQ_INFO(sr)-&gt;request_id = retval.s.request_id;
                    SOFT_REQ_INFO(sr)-&gt;status     = retval.s.status;

                if(resp_order != OCTEON_RESP_NORESPONSE)
                    uint32_t   resp_list;
                    //&#x4E09;&#x9009;&#x4E00;, OCTEON_ORDERED_LIST OCTEON_UNORDERED_NONBLOCKING_LIST OCTEON_UNORDERED_BLOCKING_LIST
                    GET_RESPONSE_LIST(resp_order, resp_mode, resp_list);
                    //&#x52A0;&#x5230;&#x76F8;&#x5E94;&#x7684;&#x94FE;&#x8868;&#x91CC;, &#x8FD9;&#x662F;&#x5E94;&#x7B54;&#x94FE;&#x8868;. &#x8C01;&#x6765;&#x5904;&#x7406;?--&#x96BE;&#x9053;&#x53C8;&#x662F;A15?????
                    //&#x6BCF;&#x4E2A;&#x53D1;&#x9001;&#x7684;command&#x90FD;&#x4F1A;&#x52A0;&#x5230;&#x5E94;&#x7B54;&#x94FE;&#x8868;(response&#x6A21;&#x5F0F;&#x4E0B;)
                    //&#x8FD9;&#x4E2A;&#x94FE;&#x8868;&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;F, &#x662F;&#x4E2A;&quot;&#x7EAF;&#x7684;&quot;&#x94FE;&#x8868;, &#x5176;&#x5B9E;&#x5B83;&#x7684;&#x8282;&#x70B9;&#x662F;pending_entry
                    //pending_entry&#x4ECE;&#x7B49;&#x5F85;&#x94FE;&#x8868;&#x6765;, pending_entry&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;E1
                    push_response_list(&amp;oct-&gt;response_list[resp_list], pending_entry);

            if(cavium_atomic_read(&amp;iq-&gt;instr_pending) &gt;= (iq-&gt;max_count/2))
                flush_instr_queue(oct, iq); //&#x53C2;&#x8003;A14

    //&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;&#x7B49;&#x7740;octeon&#x5E72;&#x6D3B;&#x4E86;
    //&#x5982;&#x679C;&#x662F;&#x963B;&#x585E;&#x6A21;&#x5F0F;, &#x6CE8;:&#x8FD9;&#x4E2A;&#x6A21;&#x5F0F;&#x4E0D;&#x652F;&#x6301;ordered
    if (resp_mode == OCTEON_RESP_BLOCKING) {
        //&#x5C31;&#x76F4;&#x63A5;&#x5728;&#x5FAA;&#x73AF;&#x91CC;&#x67E5;&#x8BE2;&#x7B49;&#x7740;, &#x540E;&#x9762;&#x7B49;&#x5B8C;&#x4E86;&#x4EE5;&#x540E;&#x5C31;&#x5730;&#x91CA;&#x653E;&#x8D44;&#x6E90;
        do {
            if(!SOFT_REQ_IGNORE_SIGNAL(soft_req) &amp;&amp; signal_pending(current))
                query.status = OCTEON_REQUEST_INTERRUPTED;

            retval = octeon_query_request_status(query.octeon_id,&amp;query);//&#x89C1;C124

            /* comp-&gt;condition would be set in the callback octeon_copy_user_buffer()
               called from the request completion tasklet */
            if(comp-&gt;condition == 0)
                cavium_sleep_timeout_cond(&amp;comp-&gt;wait_head,&amp;comp-&gt;condition,1);
            else
                query.status = comp-&gt;status;
        } while((query.status == OCTEON_REQUEST_PENDING) &amp;&amp; (!retval));
        /*### Copy query status to req_info here ###*/
        SOFT_REQ_INFO(soft_req)-&gt;status = query.status;
        octeon_user_req_copyout_response(copy_buf, query.status);
    //&#x628A;req info&#x8003;&#x5230;&#x7528;&#x6237;&#x6001;
    cavium_copy_out( user_req_info, SOFT_REQ_INFO(soft_req), OCT_USER_REQ_INFO_SIZE)
</code></pre>
<h5 id="c121-octeoncopyinputdmabuffers--&#x65B0;&#x7533;&#x8BF7;&#x5185;&#x6838;&#x6001;&#x7684;input-buffer-&#x5E76;&#x628A;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;data&#x62F7;&#x8FDB;&#x6765;"><a name="c121-octeoncopyinputdmabuffers--&#x65B0;&#x7533;&#x8BF7;&#x5185;&#x6838;&#x6001;&#x7684;input-buffer-&#x5E76;&#x628A;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;data&#x62F7;&#x8FDB;&#x6765;" class="anchor-navigation-ex-anchor" href="#c121-octeoncopyinputdmabuffers--&#x65B0;&#x7533;&#x8BF7;&#x5185;&#x6838;&#x6001;&#x7684;input-buffer-&#x5E76;&#x628A;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;data&#x62F7;&#x8FDB;&#x6765;"><i class="fa fa-link" aria-hidden="true"></i></a>C121. octeon_copy_input_dma_buffers : &#x65B0;&#x7533;&#x8BF7;&#x5185;&#x6838;&#x6001;&#x7684;input buffer, &#x5E76;&#x628A;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;data&#x62F7;&#x8FDB;&#x6765;</h5>
<pre><code class="lang-c">octeon_copy_input_dma_buffers(octeon_device_t        *octeon_dev,
                              octeon_soft_request_t  *soft_req,
                              uint32_t                gather)
    //&#x8BA1;&#x7B97;&#x51FA;&#x6001;total size
    for (i = 0,total_size = 0; i &lt; soft_req-&gt;inbuf.cnt; i++)  
        total_size += soft_req-&gt;inbuf.size[i];
    //gather&#x6A21;&#x5F0F;&#x6700;&#x5927;&#x652F;&#x6301;64K, direct&#x6A21;&#x5F0F;&#x652F;&#x6301;16K
    //&#x65B0;&#x7533;&#x8BF7;&#x6574;&#x4E2A;buf
    mem = cavium_alloc_buffer(octeon_dev, total_size);
    memtmp = mem;
    //&#x628A;&#x6BCF;&#x4E2A;inbuf&#x4ECE;&#x7528;&#x6237;&#x6001;&#x62F7;&#x5230;&#x521A;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x6838;&#x6001;buf&#x91CC;, &#x867D;&#x7136;&#x62F7;&#x6210;&#x4E00;&#x4E2A;&#x6574;&#x4F53;, &#x4F46;&#x8FD8;&#x662F;&#x4F1A;&#x4FDD;&#x7559;&#x6BCF;&#x4E2A;inbuf
    for (i = 0; i &lt; soft_req-&gt;inbuf.cnt; i++)  {
        if(cavium_copy_in((void *)memtmp, (void *)SOFT_REQ_INBUF(soft_req, i), soft_req-&gt;inbuf.size[i])) {
            cavium_error(&quot;OCTEON: copy in failed for inbuf\n&quot;);
            cavium_free_buffer(octeon_dev, mem);
            soft_req-&gt;inbuf.cnt    = 0;
            SOFT_REQ_INBUF(soft_req, 0) = NULL;
            return -EFAULT;
        }
        if(gather)
            //gather&#x6A21;&#x5F0F;&#x4E0B;&#x8BBE;&#x7F6E;&#x6BCF;&#x4E2A;inbuf&#x7684;&#x6307;&#x9488;
            SOFT_REQ_INBUF(soft_req, i)  = memtmp;
        memtmp += soft_req-&gt;inbuf.size[i];
    }

    if(!gather) {
        soft_req-&gt;inbuf.cnt = 1;
        soft_req-&gt;inbuf.size[0]      = total_size;
        SOFT_REQ_INBUF(soft_req, 0)  = mem;
    }
</code></pre>
<h5 id="c122-octeoncreateoutputdmabuffers--&#x5C06;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;output-buffer&#x5728;&#x5185;&#x6838;&#x6001;&#x4E5F;&#x7533;&#x8BF7;&#x4E00;&#x4EFD;"><a name="c122-octeoncreateoutputdmabuffers--&#x5C06;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;output-buffer&#x5728;&#x5185;&#x6838;&#x6001;&#x4E5F;&#x7533;&#x8BF7;&#x4E00;&#x4EFD;" class="anchor-navigation-ex-anchor" href="#c122-octeoncreateoutputdmabuffers--&#x5C06;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;output-buffer&#x5728;&#x5185;&#x6838;&#x6001;&#x4E5F;&#x7533;&#x8BF7;&#x4E00;&#x4EFD;"><i class="fa fa-link" aria-hidden="true"></i></a>C122. octeon_create_output_dma_buffers : &#x5C06;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;output buffer&#x5728;&#x5185;&#x6838;&#x6001;&#x4E5F;&#x7533;&#x8BF7;&#x4E00;&#x4EFD;</h5>
<pre><code class="lang-c">octeon_create_output_dma_buffers(octeon_device_t        *octeon_dev,
                                 octeon_soft_request_t  *soft_req,
                                 octeon_copy_buffer_t   *copy_buf,
                                 uint32_t                scatter)
    //&#x9996;&#x5148;&#x8BA1;&#x7B97;&#x6240;&#x6709;&#x7684;outbuf&#x7684;total size, &#x8FD9;&#x4E2A;size&#x6700;&#x5927;16K, &#x6216;14*8K(scatter)
    cnt = soft_req-&gt;outbuf.cnt;
    for (i = 0, total_size=0; i &lt; cnt; i++)  
        total_size += soft_req-&gt;outbuf.size[i];
    //total size&#x8FD8;&#x8981;&#x52A0;&#x4E0A;sizeof(octeon_resp_hdr_t)&#x518D;&#x52A0;8, &#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;G41
    total_size += OCT_RESP_HDR_SIZE + 8;
    //&#x8FD9;&#x4E2A;&#x5C31;&#x662F;&#x5728;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#x7684;output buffer, &#x4F46;&#x8981;&#x548C;refill&#x7684;&#x90A3;&#x4E2A;&#x66F4;&#x5E95;&#x5C42;&#x7684;buffer&#x533A;&#x522B;&#x5F00;
    mem = cavium_alloc_buffer(octeon_dev, total_size);
    //&#x4E3A;copy&#x4F1A;&#x7528;&#x6237;&#x6001;&#x505A;&#x7684;&#x51C6;&#x5907;  
    copy_buf-&gt;kern_outsize = total_size - OCT_RESP_HDR_SIZE - 8;
    copy_buf-&gt;kern_outptr  = mem;
    copy_buf-&gt;user_bufcnt  = cnt;
    for (i = 0; i &lt; cnt; i++)   {
        //&#x4FDD;&#x7559;&#x7528;&#x6237;&#x6001;buffer&#x7684;&#x5730;&#x5740;, &#x5F80;&#x56DE;&#x62F7;&#x8D1D;&#x8981;&#x7528;
        copy_buf-&gt;user_ptr[i]  = SOFT_REQ_OUTBUF(soft_req, i);
        copy_buf-&gt;user_size[i] = soft_req-&gt;outbuf.size[i];
    }  
    //&#x586B;soft_req-&gt;outbuf
    while (size &lt; total_size)
        //&#x628A;outbuf&#x8FD9;&#x4E2A;&#x6570;&#x7EC4;&#x91CC;&#x9762;&#x7684;&#x6307;&#x9488;&#x66F4;&#x65B0;&#x4E3A;&#x5185;&#x6838;&#x6001;&#x5730;&#x5740;
        SOFT_REQ_OUTBUF(soft_req, i) = mem + size;
        if( (size + OCT_MAX_USER_BUF_SIZE) &gt; total_size)
            buf_size = (total_size - size);    
        else
            buf_size = OCT_MAX_USER_BUF_SIZE;
        soft_req-&gt;outbuf.size[i] = buf_size; 
        i++;

    soft_req-&gt;outbuf.cnt = i;
</code></pre>
<h5 id="c123-octeoncreatedatabuf"><a name="c123-octeoncreatedatabuf" class="anchor-navigation-ex-anchor" href="#c123-octeoncreatedatabuf"><i class="fa fa-link" aria-hidden="true"></i></a>C123. octeon_create_data_buf</h5>
<p>&#x6839;&#x636E;DMA&#x7684;&#x65B9;&#x5F0F;, &#x586B;soft_instr-&gt;dptr(&#x5F80;octeon&#x53BB;)&#x548C;soft_instr-&gt;rptr(&#x4ECE;octeon&#x6765;), &#x95EE;&#x9898;, &#x5728;&#x54EA;&#x91CC;&#x7528;&#x7684;&#x5462;?????</p>
<p>&#x4EE5;&#x4E0A;&#x4E24;&#x4E2A;ptr&#x53EF;&#x4EE5;&#x662F;&#x76F4;&#x63A5;&#x4E00;&#x4E2A;&#x6307;&#x9488;&#x5730;&#x5740;, &#x4E5F;&#x53EF;&#x4EE5;&#x662F;octeon_sg_entry_t &#x7684;&#x94FE;&#x8868;</p>
<pre><code class="lang-c">static  uint32_t 
octeon_create_data_buf(octeon_device_t            *oct,
                       octeon_soft_instruction_t  *soft_instr,
                       octeon_soft_request_t      *soft_req)
    dma_mode   = GET_SOFT_REQ_DMA_MODE(soft_req);
    resp_order = GET_SOFT_REQ_RESP_ORDER(soft_req);
    //&#x786E;&#x8BA4;buffer count&#x4E0D;&#x5927;&#x4E8E;MAX_BUFCNT, 16
    //DMA&#x7C7B;&#x578B;
    //&#x7B2C;&#x4E00;&#x79CD;: input&#x548C;output&#x90FD;&#x662F;direct
    OCTEON_DMA_DIRECT :soft_req-&gt;outbuf.cnt&#x5FC5;&#x987B;&#x4E3A;0&#xFF1B;&#x6700;&#x5927;&#x652F;&#x6301;16K&#x7684;buffer;
    &#x53EF;&#x4EE5;&#x6CA1;&#x6709;input, &#x4F46;&#x5FC5;&#x987B;&#x6709;header&#x7684;buffer
        soft_instr-&gt;ih.gather   = 0;
        soft_instr-&gt;irh.scatter = 0;
        //&#x7533;&#x8BF7;input buf, &#x8FD9;&#x91CC;&#x597D;&#x50CF;&#x7F57;&#x55E6;&#x4E86;, &#x5E94;&#x8BE5;&#x4E0D;&#x7528;&#x518D;&#x7533;&#x8BF7;&#x4E00;&#x6B21;buffer
        soft_instr-&gt;dptr =  octeon_process_request_inbuf(oct,
                                                soft_instr, soft_req);
            //&#x662F;&#x54EA;&#x4E2A;iq
            iq_no = SOFT_INSTR_IQ_NO(soft_instr);
            exhdr_size = SOFT_INSTR_EXHDR_COUNT(soft_instr) * 8;

            //&#x8FD9;&#x91CC;&#x5728;&#x76F4;&#x63A5;DMA&#x6A21;&#x5F0F;&#x4E0B;, &#x5982;&#x679C;app&#x63D0;&#x4F9B;&#x4E86;&#x591A;&#x4E2A;inbuf, &#x5C31;&#x5408;&#x5E76;&#x5230;&#x65B0;&#x7684;&#x5927;buf&#x91CC;
            if (soft_req-&gt;inbuf.cnt &gt; 1)
                for i in all inbuf.cnt:
                    total_size += soft_req-&gt;inbuf.size[i];
                //&#x603B;&#x7684;size&#x8FD8;&#x8981;&#x52A0;&#x4E0A;extra header
                total_size += exhdr_size; /* Add any extra header bytes present */
                //&#x91CD;&#x65B0;&#x7533;&#x8BF7;buf, &#x5E95;&#x4E0B;&#x8981;&#x4E48;&#x662F;&#x4ECE;buffer&#x6C60;&#x6765;, &#x8981;&#x4E48;&#x662F;kmalloc(&#x53EF;dma)
                buf = cavium_alloc_buffer(octeon_dev, total_size);
                //&#x5148;&#x62F7;extra header
                if(exhdr_size) {
                   cavium_memcpy(tmpbuf, soft_instr-&gt;exhdr, exhdr_size);
                   tmpbuf += exhdr_size;
                }
                //&#x518D;&#x62F7;&#x6BCF;&#x4E2A;inbuf&#x7684;&#x5185;&#x5BB9;, &#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x662F;dada&#x7684;&#x7B2C;&#x4E8C;&#x6B21;&#x62F7;&#x8D1D;, &#x7B2C;&#x4E00;&#x6B21;&#x53D1;&#x751F;&#x5728;&#x4ECE;&#x7528;&#x6237;&#x6001;&#x62F7;&#x5230;&#x5185;&#x6838;&#x6001;, &#x89C1;C121
                for(i = 0 ; i &lt; soft_req-&gt;inbuf.cnt; i++) {
                  cavium_memcpy(tmpbuf, SOFT_REQ_INBUF(soft_req, i),soft_req-&gt;inbuf.size[i]);
                  tmpbuf += soft_req-&gt;inbuf.size[i];
                }

                soft_instr-&gt;dptr       = buf;
                soft_instr-&gt;ih.dlengsz = total_size;
                SET_SOFT_INSTR_ALLOCFLAGS(soft_instr, OCTEON_DPTR_COALESCED);
            //&#x53EA;&#x6709;&#x4E00;&#x4E2A;inbuf
            else
                //&#x53EA;&#x6709;&#x4E00;&#x4E2A;buf&#x5C31;&#x4E0D;&#x7528;&#x62F7;&#x8D1D;&#x4E86;
                soft_instr-&gt;dptr        = SOFT_REQ_INBUF(soft_req, 0);
                soft_instr-&gt;ih.dlengsz  = soft_req-&gt;inbuf.size[0];

        //&#x586B;rptr, &#x56E0;&#x4E3A;&#x5728;&#x76F4;&#x63A5;DMA&#x6A21;&#x5F0F;&#x4E0B;, soft_req-&gt;outbuf.cnt&#x5FC5;&#x987B;&#x4E3A;0
        if((soft_instr-&gt;ih.raw) &amp;&amp; (resp_order != OCTEON_RESP_NORESPONSE))
            soft_instr-&gt;rptr = SOFT_REQ_OUTBUF(soft_req, 0);
            soft_instr-&gt;irh.rlenssz  = soft_req-&gt;outbuf.size[0];
            soft_instr-&gt;status_word = outbuf&#x7684;&#x6700;&#x540E;8&#x4E2A;&#x5B57;&#x8282;
    //&#x7B2C;&#x4E8C;&#x79CD;:input&#x662F;gather, output&#x662F;direct
    OCTEON_DMA_GATHER :soft_req-&gt;outbuf.cnt&#x5FC5;&#x987B;&#x4E3A;0
        soft_instr-&gt;ih.gather   = 1;
        //&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x6A21;&#x5F0F;&#x4E0B;output&#x662F;&#x76F4;&#x63A5;&#x7684;
        soft_instr-&gt;rptr         = SOFT_REQ_OUTBUF(soft_req, 0);
        soft_instr-&gt;irh.rlenssz  = soft_req-&gt;outbuf.size[0];
        soft_instr-&gt;status_word =
             (uint64_t *)((uint8_t *)SOFT_REQ_OUTBUF(soft_req, 0)
                    + soft_req-&gt;outbuf.size[0] - 8);
        //&#x4E0A;&#x9762;&#x641E;&#x5B9A;&#x4E86;rptr, &#x73B0;&#x5728;&#x6765;&#x641E;dptr, &#x89C1;C1231
        soft_instr-&gt;dptr = octeon_create_sg_list(oct, &amp;soft_req-&gt;inbuf
                         , soft_instr, OCTEON_DPTR_GATHER);
    //&#x7B2C;&#x4E09;&#x79CD;:input&#x662F;direct, output&#x662F;scatter
    OCTEON_DMA_SCATTER : &#x6B64;DMA&#x4E0D;&#x652F;&#x6301;noresponse, &#x5F88;&#x7B80;&#x5355;, &#x5982;&#x679C;&#x4E0D;&#x7528;output,&#x8FD8;&#x8981;scatter&#x5E72;&#x5565;?
        soft_instr-&gt;irh.scatter = 1;
        //&#x8FD9;&#x4E2A;&#x6A21;&#x5F0F;&#x4E0B;, &#x8981;&#x6C42;inbuf.cnt&#x5FC5;&#x987B;&#x4E3A;1???????&#x548C;&#x4E0A;&#x9762;&#x7B2C;&#x4E00;&#x79CD;DMA&#x6A21;&#x5F0F;&#x4E3A;&#x4EC0;&#x4E48;&#x6709;&#x5DEE;&#x522B;&#x5462;?
        //&#x90A3;&#x4E48;&#x53EA;&#x6709;&#x4E00;&#x4E2A;inbuf, &#x5C31;&#x76F4;&#x63A5;&#x7528;&#x4F5C;dptr&#x4E86;
        soft_instr-&gt;dptr        = SOFT_REQ_INBUF(soft_req, 0);
        soft_instr-&gt;ih.dlengsz  = soft_req-&gt;inbuf.size[0];
        //&#x4E0A;&#x9762;&#x7B97;&#x662F;&#x641E;&#x5B9A;&#x4E86;dptr, &#x63A5;&#x5199;&#x6765;&#x641E;rptr, &#x89C1;C1231
        soft_instr-&gt;rptr = octeon_create_sg_list(oct, &amp;soft_req-&gt;outbuf,
                              soft_instr, OCTEON_RPTR_SCATTER);
        if(resp_order != OCTEON_RESP_NORESPONSE) {
                soft_instr-&gt;status_word = (uint64_t *)
                  ((uint8_t *)SOFT_REQ_OUTBUF(soft_req, (soft_req-&gt;outbuf.cnt-1))
                   + soft_req-&gt;outbuf.size[soft_req-&gt;outbuf.cnt-1] - 8);

    //&#x7B2C;&#x56DB;&#x79CD;:input&#x662F;gather, output&#x662F;scatter
    OCTEON_DMA_SCATTER_GATHER :&#x662F;&#x4EE5;&#x4E0A;&#x4E24;&#x4E2A;&#x6A21;&#x5F0F;&#x7684;&#x7EFC;&#x5408;, &#x540C;&#x4E0A;, &#x4E0D;&#x652F;&#x6301;noresponse

    //input&#x548C;output&#x7684;buf&#x90FD;&#x641E;&#x5B9A;&#x4EE5;&#x540E;
    if(soft_instr-&gt;ih.raw)
        if(IQ_INSTR_MODE_32B(oct, SOFT_INSTR_IQ_NO(soft_instr)))
            soft_instr-&gt;ih.fsz = 16;
        else 
            soft_instr-&gt;ih.fsz = 16 + (SOFT_INSTR_EXHDR_COUNT(soft_instr) * 8);

    if(soft_instr-&gt;status_word)
        //status&#x7F6E;&#x4E3A;COMPLETION_WORD_INIT
        *(soft_instr-&gt;status_word) = COMPLETION_WORD_INIT;
</code></pre>
<h6 id="c1231-octeoncreatesglist"><a name="c1231-octeoncreatesglist" class="anchor-navigation-ex-anchor" href="#c1231-octeoncreatesglist"><i class="fa fa-link" aria-hidden="true"></i></a>C1231. octeon_create_sg_list</h6>
<pre><code class="lang-c">/** The Scatter-Gather List Entry. The scatter or gather component used with
    a Octeon input instruction has this format. */
typedef struct { 

    /** The first 64 bit gives the size of data in each dptr.*/
    union {
        uint16_t  size[4];
        uint64_t  size64;
    } u;

    /** The 4 dptr pointers for this entry. */
    uint64_t     ptr[4];

}octeon_sg_entry_t;
</code></pre>
<pre><code class="lang-c">//&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5E76;&#x4E0D;&#x62F7;&#x8D1D;data, &#x53EA;&#x662F;&#x7533;&#x8BF7;sg_count&#x4E2A;&#x4E0A;&#x9762;&#x7684;&#x7ED3;&#x6784;&#x4F53;, &#x7136;&#x540E;&#x628A;&#x91CC;&#x9762;&#x7684;4&#x4E2A;ptr&#x6307;&#x5411;outbuf
octeon_create_sg_list(octeon_device_t            *oct,
                      octeon_buffer_t            *buf, 
                      octeon_soft_instruction_t  *soft_instr,
                      uint32_t                    flags)
    //cnt&#x5C31;&#x662F;buf&#x7684;&#x4E2A;&#x6570;
    //gather&#x94FE;&#x8868;
        //&#x4E5F;&#x662F;&#x5148;&#x7B97;total size, &#x52A0;&#x4E0A;&#x4E00;&#x4E9B;extra header, &#x6700;&#x5927;64K
        soft_instr-&gt;gather_bytes = total_size;
        soft_instr-&gt;ih.dlengsz   = cnt;
    //scatter&#x94FE;&#x8868;
        //&#x540C;&#x6837;&#x5148;&#x7B97;total size, &#x52A0;&#x4E0A;&#x4E00;&#x4E9B;extra header, &#x6700;&#x5927;14*8K
        soft_instr-&gt;irh.rlenssz   = cnt;
        soft_instr-&gt;scatter_bytes = total_size;
    //&#x628A;cnt&#x6309;4&#x4E2A;&#x4E00;&#x7EC4;
    sg_count = ROUNDUP4(cnt) &gt;&gt; 2;
    sg_list = octeon_alloc_sglist(oct, soft_instr, sg_count, flags);
        //&#x7ED3;&#x6784;&#x4F53;&#x89C1;&#x4E0A;&#x9762;octeon_sg_entry_t, sg_list&#x9700;&#x8981;8&#x5B57;&#x8282;&#x5BF9;&#x9F50;
        sg_list = cavium_alloc_buffer(octeon_dev,(sg_count*OCT_SG_ENTRY_SIZE)+ 7);
        if(flags &amp; OCTEON_DPTR_GATHER)
            soft_instr-&gt;gather_ptr = (void *)sg_list;
        else
            soft_instr-&gt;scatter_ptr = (void *)sg_list;

    //&#x5411;sg_list[i].ptr[k]&#x586B;&#x7269;&#x7406;&#x5730;&#x5740;(&#x6216;&#x7ECF;&#x8FC7;IOMMU&#x7684;&#x5730;&#x5740;)
    for (i = 0, j = 0; i &lt; sg_count; i++)  {
        for(k = tmpcnt; ((k &lt; 4) &amp;&amp; (j &lt; cnt)); j++, k++)   {
            size = buf-&gt;size[j];
            /* Gather list data is swapped and interpreted in Hardware.
               Scatter data is interpreted by core software. We need to do
               swapping of scatter list manually. */
            if(flags == OCTEON_RPTR_SCATTER) {
                octeon_swap_2B_data(&amp;size, 1);
                sg_list[i].u.size[3-k] = size;
            } else {
                CAVIUM_ADD_SG_SIZE(&amp;sg_list[i], size, k);
            }

            if(flags == OCTEON_DPTR_GATHER) {
                sg_list[i].ptr[k] = octeon_pci_map_single(oct-&gt;pci_dev, OCT_SOFT_REQ_BUFPTR(buf, j), buf-&gt;size[j], CAVIUM_PCI_DMA_TODEVICE);
                } else {
                sg_list[i].ptr[k] = octeon_pci_map_single(oct-&gt;pci_dev, OCT_SOFT_REQ_BUFPTR(buf, j), buf-&gt;size[j], CAVIUM_PCI_DMA_FROMDEVICE);
            octeon_swap_8B_data(&amp;sg_list[i].ptr[k], 1);
            }
        }
        tmpcnt = 0;
    }
    return sg_list; //&#x88AB;&#x5F53;&#x4F5C;rptr&#x6216;dptr
</code></pre>
<h5 id="c124-&#x4E3B;&#x8981;&#x7684;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;"><a name="c124-&#x4E3B;&#x8981;&#x7684;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;" class="anchor-navigation-ex-anchor" href="#c124-&#x4E3B;&#x8981;&#x7684;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;"><i class="fa fa-link" aria-hidden="true"></i></a>C124. &#x4E3B;&#x8981;&#x7684;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;</h5>
<pre><code class="lang-c">octeon_query_request_status(uint32_t                 octeon_id,
                            octeon_query_request_t  *query)
    octeon_device_t  *octeon_dev = get_octeon_device(query-&gt;octeon_id);
    process_unordered_poll(octeon_dev, query))
        //&#x6709;request_id&#x5C31;&#x53EF;&#x4EE5;&#x627E;&#x5230;pending entry
        pending_entry  = &amp;octeon_dev-&gt;plist-&gt;list[query-&gt;request_id];
        soft_instr = pending_entry-&gt;instr;
        //COMPLETION_WORD_INIT&#x662F;&#x6700;&#x5F00;&#x59CB;&#x7684;&#x72B6;&#x6001;, &#x4E0D;&#x662F;init&#x8BF4;&#x660E;&#x5DF2;&#x7ECF;&#x5728;&#x5E72;&#x6D3B;&#x4E86;?
        if(*(soft_instr-&gt;status_word) != COMPLETION_WORD_INIT)
            //&#x5F97;&#x5230;&#x65B0;&#x7684;status
            status = (octeon_req_status_t) (status64 &amp; 0x00000000ffffffffULL);
        else
            //&#x662F;&#x5426;&#x8D85;&#x65F6;&#x4E86;?
            if(cavium_check_timeout(cavium_jiffies, soft_instr-&gt;timeout)) 
                status = OCTEON_REQUEST_TIMEOUT;
        //&#x4E0D;&#x662F;pending&#x8BF4;&#x660E;&#x7528;&#x5B8C;&#x4E86;
        if(status != OCTEON_REQUEST_PENDING)
            if(SOFT_INSTR_RESP_MODE(soft_instr) == OCTEON_RESP_BLOCKING)
                response_list = &amp;octeon_dev-&gt;response_list[OCTEON_UNORDERED_BLOCKING_LIST];
            else
                response_list = &amp;octeon_dev-&gt;response_list[OCTEON_UNORDERED_NONBLOCKING_LIST];
            release_from_response_list(octeon_dev, pending_entry);
            release_from_pending_list(octeon_dev,pending_entry);
            release_soft_instr(octeon_dev, soft_instr, status);
        //&#x672C;&#x6B21;&#x67E5;&#x8BE2;&#x7684;&#x7ED3;&#x679C;, &#x4E00;&#x822C;&#x5F00;&#x59CB;&#x4F1A;&#x662F;OCTEON_REQUEST_PENDING, &#x6700;&#x540E;&#x662F;&#x5B8C;&#x6210;
        query-&gt;status = status;
</code></pre>
<h2 id="&#x4E2D;&#x65AD;&#x5904;&#x7406;-&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;"><a name="&#x4E2D;&#x65AD;&#x5904;&#x7406;-&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#&#x4E2D;&#x65AD;&#x5904;&#x7406;-&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>5.4. &#x4E2D;&#x65AD;&#x5904;&#x7406; :&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;</h2>
<pre><code class="lang-c">octeon_intr_handler(int irq, void *dev)
        return  oct-&gt;fn_list.interrupt_handler(oct);
</code></pre>
<p>&#x6BD4;&#x5982;</p>
<pre><code class="lang-c">cn6xxx_interrupt_handler
cn6xxx_interrupt_handler(void  *dev)
    //&#x901A;&#x8FC7;bar0&#x8BFB;INT_SUM&#x5BC4;&#x5B58;&#x5668;, &#x6CA1;&#x6709;&#x4E2D;&#x65AD;&#x5219;&#x9A6C;&#x4E0A;&#x9000;&#x51FA;
    intr64 = OCTEON_READ64(cn6xxx-&gt;intr_sum_reg64);
    if !intr64 
        return

    //&#x9A6C;&#x4E0A;&#x5173;&#x672C;&#x4E2D;&#x65AD;
    oct-&gt;fn_list.disable_interrupt(oct-&gt;chip);
    if(intr64 &amp; CN63XX_INTR_ERR)
        cn6xxx_handle_pcie_error_intr(oct, intr64);
    if(intr64 &amp; CN63XX_INTR_PKT_DATA) //&#x8FD9;&#x91CC;&#x662F;&#x4ECE;octeon&#x7F51;&#x53E3;&#x6765;&#x7684;&#x62A5;&#x6587;, &#x548C;response&#x6CA1;&#x6709;&#x5173;&#x7CFB;
        cn6xxx_droq_intr_handler(oct);
                     droq_time_mask = octeon_read_csr(oct, CN63XX_SLI_PKT_TIME_INT);
            //&#x5BF9;&#x6BCF;&#x4E2A;q
            for (oq_no = 0; oq_no &lt; oct-&gt;num_oqs; oq_no++)
                //&#x5148;&#x68C0;&#x67E5;&#x662F;&#x4E0D;&#x662F;&#x5728;mask&#x91CC;
                if ( !(droq_mask &amp; (1 &lt;&lt; oq_no)) )
                    continue;
                droq = oct-&gt;droq[oq_no];
                //&#x4E00;&#x5171;&#x6536;&#x4E86;&#x591A;&#x5C11;&#x5305;?
                pkt_count = octeon_droq_check_hw_for_pkts(oct, droq);
                    pkt_count = OCTEON_READ32(droq-&gt;pkts_sent_reg)
                    //&#x4E3A;&#x4EC0;&#x4E48;&#x662F;&#x52A0;&#x5728;pkts_pending&#x4E0A;&#x5462;? &#x662F;&#x6307;&#x6536;&#x5230;&#x7684;&#x8FD8;&#x6CA1;&#x5904;&#x7406;&#x7684;&#x62A5;&#x6587;&#x6570;?
                    cavium_atomic_add(pkt_count, &amp;droq-&gt;pkts_pending);
                    //&#x8FD9;&#x91CC;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD8;&#x8981;&#x5199;&#x56DE;&#x8FD9;&#x4E2A;&#x5BC4;&#x5B58;&#x5668;&#x5462;?
                    OCTEON_WRITE32(droq-&gt;pkts_sent_reg, pkt_count);
                //&#x8FD8;&#x6709;&#x4E2A;poll&#x6A21;&#x5F0F;???? &#x597D;&#x50CF;&#x6CA1;&#x6253;&#x5F00;
                if(droq-&gt;ops.poll_mode) {
                    droq-&gt;ops.napi_fn(oct-&gt;octeon_id, oq_no, POLL_EVENT_INTR_ARRIVED);
                else
                    //&#x6253;&#x5F00;&#x4E86;USE_DROQ_THREADS&#x624D;&#x4F1A;&#x8C03;, &#x4E5F;&#x5C31;&#x662F;&#x8BF4;, &#x5373;&#x4F7F;&#x662F;&#x7528;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x6536;&#x5305;, &#x4E5F;&#x9700;&#x8981;&#x4E2D;&#x65AD;&#x89E6;&#x53D1;
                    cavium_wakeup(&amp;droq-&gt;wc); //&#x8FD9;&#x4E2A;&#x4EFB;&#x52A1;&#x89C1;A18
            //&#x4E0D;&#x7528;USE_DROQ_THREADS&#x65F6;&#x4F7F;&#x7528;tasklet, &#x89C1;INT1
            cavium_tasklet_schedule(&amp;oct-&gt;droq_tasklet);

    if(intr64 &amp; (CN63XX_INTR_DMA0_FORCE|CN63XX_INTR_DMA1_FORCE))
        //&#x8FD9;&#x91CC;&#x5F00;&#x59CB;&#x8BA9;comp_tasklet&#x5E72;&#x6D3B;, &#x89C1;INT2
        cavium_tasklet_schedule(&amp;oct-&gt;comp_tasklet);
    //&#x597D;&#x50CF;&#x6CA1;&#x6709;&#x641C;&#x5230;&#x4EFB;&#x4F55;dma_ops&#x4E0B;&#x6302;&#x7684;&#x51FD;&#x6570;
    if((intr64 &amp; CN63XX_INTR_DMA_DATA) &amp;&amp; (oct-&gt;dma_ops.intr_handler))
        oct-&gt;dma_ops.intr_handler((void *)oct, intr64);
    /* Clear the current interrupts */
    OCTEON_WRITE64(cn6xxx-&gt;intr_sum_reg64, intr64);
    /* Re-enable our interrupts  */
    oct-&gt;fn_list.enable_interrupt(oct-&gt;chip);
</code></pre>
<h3 id="int1-octeondroqbh-&#x89C1;a19"><a name="int1-octeondroqbh-&#x89C1;a19" class="anchor-navigation-ex-anchor" href="#int1-octeondroqbh-&#x89C1;a19"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.1. INT1. octeon_droq_bh, &#x89C1;A19</h3>
<ul>
<li>&#x8FD9;&#x91CC;&#x7684;&#x6536;&#x5305;&#x548C;&#x53D1;&#x9001;&#x547D;&#x4EE4;&#x5B57;&#x91CC;&#x9762;&#x7684;response&#x5E94;&#x8BE5;&#x6CA1;&#x6709;&#x5173;&#x7CFB;, &#x53EA;&#x662F;&#x6536;octeon&#x4E3B;&#x52A8;&#x53D1;&#x8FC7;&#x6765;&#x7684;&#x5305;, &#x7136;&#x540E;&#x5206;&#x53D1;; &#x73B0;&#x5728;&#x8D70;&#x7684;&#x5E94;&#x8BE5;&#x662F;slow path, &#x800C;&#x4E14;&#x6CA1;&#x6709;&#x771F;&#x6B63;&#x7684;&quot;&#x4E0A;&#x5C42;&quot;&#x5904;&#x7406;&#x51FD;&#x6570;&#x6CE8;&#x518C;, &#x89C1;A181</li>
<li>&#x5173;&#x4E8E;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x7684;tasklet:<ol>
<li>tasklet&#x5DE5;&#x4F5C;&#x5728;&#x8F6F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;</li>
<li>tasklet&#x5728;&#x591A;CPU&#x4E4B;&#x95F4;&#x662F;&#x4E32;&#x884C;&#x5316;&#x6267;&#x884C;&#x7684;, &#x591A;CPU&#x4E0D;&#x4F1A;&#x540C;&#x65F6;&#x6267;&#x884C;&#x4E00;&#x4E2A;tasklet----&#x800C;&#x540C;&#x662F;&#x8F6F;&#x4E2D;&#x65AD;&#x7684;softirq&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x6267;&#x884C;</li>
<li>tasklet&#x59CB;&#x7EC8;&#x8FD0;&#x884C;&#x5728;&#x88AB;&#x521D;&#x59CB;&#x63D0;&#x4EA4;&#x7684;&#x540C;&#x4E00;&#x5904;&#x7406;&#x5668;&#x4E0A;&#xFF0C;workqueue&#x4E0D;&#x4E00;&#x5B9A; ----&#x5F85;&#x786E;&#x8BA4;</li>
</ol>
</li>
</ul>
<p>&#x7EFC;&#x4E0A;, &#x5373;&#x4F7F;&#x4E2D;&#x65AD;&#x6765;&#x7684;&#x5F88;&#x5FEB;, <code>tasklet_schedule(&amp;oct-&gt;droq_tasklet)</code>&#x4E0D;&#x65AD;&#x7684;&#x88AB;&#x8C03;&#x7528;, &#x90A3;&#x4E48;droq_tasklet&#x4E5F;&#x8FD8;&#x662F;&#x4F1A;&#x88AB;&#x4E32;&#x884C;&#x6267;&#x884C;.
&#x800C;&#x7EBF;&#x7A0B;&#x6536;&#x5305;&#x6A21;&#x5F0F;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x591A;CPU&#x4E00;&#x8D77;&#x6536;&#x5305;, &#x53EA;&#x8981;&#x4ED6;&#x4EEC;&#x4E0D;&#x662F;&#x5904;&#x7406;&#x540C;&#x4E00;&#x4E2A;Q. --&#x6700;&#x591A;32&#x4E2A;q</p>
<h3 id="int2-octeonrequestcompletionbh-&#x548C;a15&#x51E0;&#x4E4E;&#x4E00;&#x6837;"><a name="int2-octeonrequestcompletionbh-&#x548C;a15&#x51E0;&#x4E4E;&#x4E00;&#x6837;" class="anchor-navigation-ex-anchor" href="#int2-octeonrequestcompletionbh-&#x548C;a15&#x51E0;&#x4E4E;&#x4E00;&#x6837;"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.2. INT2. octeon_request_completion_bh, &#x548C;A15&#x51E0;&#x4E4E;&#x4E00;&#x6837;</h3>
<pre><code class="lang-c">void
octeon_request_completion_bh(unsigned long pdev)
{
    octeon_device_t    *octeon_dev = (octeon_device_t *)pdev;

    octeon_dev-&gt;stats.comp_tasklet_count++;

    /* process_ordered_list returns 1 if list is empty. */
#ifdef CVMCS_DMA_IC
    /* No need to schedule this again, if too many pending,
      * then we got DMA_COUNT interrupt immediately */
    process_ordered_list(octeon_dev);
#else
    if(!process_ordered_list(octeon_dev))
        cavium_tasklet_schedule(&amp;octeon_dev-&gt;comp_tasklet);
#endif
    check_unordered_blocking_list(octeon_dev);
}
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="smartNIC_liquidIO_代码阅读driver篇之结构体.html" class="navigation navigation-prev " aria-label="Previous page: PCI-NIC 代码阅读 --driver篇之结构体">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="smartNIC_liquidIO_代码阅读真NIC篇.html" class="navigation navigation-next " aria-label="Next page: PCI-NIC 代码阅读 --真NIC篇">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"PCI-NIC 代码阅读 --driver篇","level":"1.15.8.3.4","depth":4,"next":{"title":"PCI-NIC 代码阅读 --真NIC篇","level":"1.15.8.3.5","depth":4,"path":"notes/smartNIC_liquidIO_代码阅读真NIC篇.md","ref":"notes/smartNIC_liquidIO_代码阅读真NIC篇.md","articles":[]},"previous":{"title":"PCI-NIC 代码阅读 --driver篇之结构体","level":"1.15.8.3.3","depth":4,"path":"notes/smartNIC_liquidIO_代码阅读driver篇之结构体.md","ref":"notes/smartNIC_liquidIO_代码阅读driver篇之结构体.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","-lunr","-search","search-plus","-highlight","theme-code","expandable-chapters-small","github","disqus","splitter","wide-page","hide-navigation-buttons","anchor-navigation-ex","sequence"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"disqus":{"useIdentifier":false,"shortName":"bai-yingjie-notes"},"sequence":{"theme":"simple"},"github":{"url":"https://github.com/Bai-Yingjie/Bai-Yingjie.github.io"},"splitter":{},"wide-page":{},"theme-code":{"showLevel":false,"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"styles/website.css"}},"fontsettings":{"theme":"white","family":"sans","size":2},"hide-navigation-buttons":{},"anchor-navigation-ex":{"mode":"float","pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"isRewritePageTitle":true,"showLevel":true,"tocLevel1Icon":"fa fa-hand-o-right","tocLevel2Icon":"fa fa-hand-o-right","tocLevel3Icon":"fa fa-hand-o-right","showGoTop":true,"isShowTocTitleIcon":true,"printLog":false,"multipleH1":true,"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false}},"expandable-chapters-small":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"theme":"default","author":"Bai Yingjie","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"My Notes","language":"zh-hans","gitbook":"*"},"file":{"path":"notes/smartNIC_liquidIO_代码阅读driver篇.md","mtime":"2022-10-11T15:10:43.014Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-10-11T15:11:40.551Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>


        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

        
    </body>
</html>

