
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>PCI-NIC 代码阅读 --driver篇 · My Notes</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Bai Yingjie">
        
        
    
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-wide-page/wide.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hide-navigation-buttons/index.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-theme-comscore/test.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    


    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="smartNIC_liquidIO_代码阅读真NIC篇.html" />
    
    
    <link rel="prev" href="smartNIC_liquidIO_代码阅读driver篇之结构体.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    简介
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="recent_topics.html">
            
                <a href="recent_topics.html">
            
                    
                    recent topics
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="as_title_kaiyuan.html">
            
                <a href="as_title_kaiyuan.html">
            
                    
                    开源
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="my_opensource.html">
            
                <a href="my_opensource.html">
            
                    
                    我的开源项目
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="my_upstream.html">
            
                <a href="my_upstream.html">
            
                    
                    我的upstream commit
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="as_title_system.html">
            
                <a href="as_title_system.html">
            
                    
                    系统分析和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="as_title_perf_misc.html">
            
                <a href="as_title_perf_misc.html">
            
                    
                    调试和分析记录系列
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="profiling_调试和分析记录5.html">
            
                <a href="profiling_调试和分析记录5.html">
            
                    
                    调试和分析记录5
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="profiling_调试和分析记录4.html">
            
                <a href="profiling_调试和分析记录4.html">
            
                    
                    调试和分析记录4
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.3" data-path="profiling_调试和分析记录3.html">
            
                <a href="profiling_调试和分析记录3.html">
            
                    
                    调试和分析记录3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.4" data-path="profiling_调试和分析记录2.html">
            
                <a href="profiling_调试和分析记录2.html">
            
                    
                    调试和分析记录2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.5" data-path="profiling_调试和分析记录1.html">
            
                <a href="profiling_调试和分析记录1.html">
            
                    
                    调试和分析记录1
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="调试和分析工具概览.html">
            
                <a href="调试和分析工具概览.html">
            
                    
                    profiling和debugging工具相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="profiling_Linux内核调试的方式以及工具集锦.html">
            
                <a href="profiling_Linux内核调试的方式以及工具集锦.html">
            
                    
                    Linux内核调试的方式以及工具集锦(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2" data-path="profiling_user_space_Ptrace_Utrace_Uprobes.html">
            
                <a href="profiling_user_space_Ptrace_Utrace_Uprobes.html">
            
                    
                    Ptrace, Utrace, Uprobes: Lightweight, Dynamic Tracing of User Apps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3" data-path="debugging_gdb备忘录.html">
            
                <a href="debugging_gdb备忘录.html">
            
                    
                    gdb备忘录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.4" data-path="profiling_perf命令备忘录.html">
            
                <a href="profiling_perf命令备忘录.html">
            
                    
                    perf命令备忘录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.5" data-path="profiling_perf命令备忘录2.html">
            
                <a href="profiling_perf命令备忘录2.html">
            
                    
                    perf命令备忘录2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6" data-path="profiling_perf学习笔记之实战篇.html">
            
                <a href="profiling_perf学习笔记之实战篇.html">
            
                    
                    perf学习笔记之实战篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.7" data-path="profiling_perf学习笔记之入门篇.html">
            
                <a href="profiling_perf学习笔记之入门篇.html">
            
                    
                    perf学习笔记之入门篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.8" data-path="profiling_用kprobe和perf_记录函数参数.html">
            
                <a href="profiling_用kprobe和perf_记录函数参数.html">
            
                    
                    使用kprobe和perf结合记录函数参数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.9" data-path="profiling_ftrace和trace-cmd记录.html">
            
                <a href="profiling_ftrace和trace-cmd记录.html">
            
                    
                    ftrace和trace-cmd记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.10" data-path="profiling_ftrace使用实例.html">
            
                <a href="profiling_ftrace使用实例.html">
            
                    
                    ftrace使用实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.11" data-path="profiling_systemtap实例.html">
            
                <a href="profiling_systemtap实例.html">
            
                    
                    systemtap实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.12" data-path="profiling_systemtap基础.html">
            
                <a href="profiling_systemtap基础.html">
            
                    
                    systemtap基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.13" data-path="profiling_perf-tools_example.html">
            
                <a href="profiling_perf-tools_example.html">
            
                    
                    perf-tools 系统tracing工具集
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.14" data-path="profiling_Comparing_SystemTap_and_bpftrace.html">
            
                <a href="profiling_Comparing_SystemTap_and_bpftrace.html">
            
                    
                    Comparing SystemTap and bpftrace(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.15" data-path="system_analysis_bcc和ebpf.html">
            
                <a href="system_analysis_bcc和ebpf.html">
            
                    
                    bcc和ebpf(starting)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.16" data-path="profiling_valgrind体验.html">
            
                <a href="profiling_valgrind体验.html">
            
                    
                    体验valgrind
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="as_title_os_perf.html">
            
                <a href="as_title_os_perf.html">
            
                    
                    profiling和debugging实例
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="debugging_gshellos_socket_leak.html">
            
                <a href="debugging_gshellos_socket_leak.html">
            
                    
                    gshell socket leak调查
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2" data-path="profiling_调查ftrace显示调用栈全0问题.html">
            
                <a href="profiling_调查ftrace显示调用栈全0问题.html">
            
                    
                    调查ftrace显示调用栈全0问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.3" data-path="profiling_eoe_filter写tap设备失败问题.html">
            
                <a href="profiling_eoe_filter写tap设备失败问题.html">
            
                    
                    eoe_filter写tap设备失败问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.4" data-path="performance_ovs进程调查.html">
            
                <a href="performance_ovs进程调查.html">
            
                    
                    OVS进程调查
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.5" data-path="performance_ping流程和函数调用解析.html">
            
                <a href="performance_ping流程和函数调用解析.html">
            
                    
                    ping流程和函数调用解析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.6" data-path="profiling_VM互相ping场景下的延迟分析.html">
            
                <a href="profiling_VM互相ping场景下的延迟分析.html">
            
                    
                    VM互相ping场景下的延迟分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.7" data-path="debugging_ftrace_谁创建了bond0设备.html">
            
                <a href="debugging_ftrace_谁创建了bond0设备.html">
            
                    
                    谁创建了bond0设备: ftrace kprobe uprobe perf综合使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.8" data-path="profiling_unixbench之filecopy分析.html">
            
                <a href="profiling_unixbench之filecopy分析.html">
            
                    
                    unixbench之file copy分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.9" data-path="profiling_lmbench之lat_tcp分析.html">
            
                <a href="profiling_lmbench之lat_tcp分析.html">
            
                    
                    lmbench之lat_tcp分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="as_title_arch_perf.html">
            
                <a href="as_title_arch_perf.html">
            
                    
                    CPU ARCH相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.4.1" data-path="performance_CPU_microarchiteture_pmu.html">
            
                <a href="performance_CPU_microarchiteture_pmu.html">
            
                    
                    Top-down Microarchitecture Analysis Method(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="as_title_cloud.html">
            
                <a href="as_title_cloud.html">
            
                    
                    Cloud和容器相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="container_linux_namespaces.html">
            
                <a href="container_linux_namespaces.html">
            
                    
                    linux名字空间
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="cloud_杂记.html">
            
                <a href="cloud_杂记.html">
            
                    
                    云杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="container_当代容器读书笔记.html">
            
                <a href="container_当代容器读书笔记.html">
            
                    
                    当代容器读书笔记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="multi-arch_docker_binfmt_misc.html">
            
                <a href="multi-arch_docker_binfmt_misc.html">
            
                    
                    multi-arch docker 和 binfmt_misc
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="as_title_vdevice.html">
            
                <a href="as_title_vdevice.html">
            
                    
                    CPU和device虚拟化
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="as_title_gvisor.html">
            
                <a href="as_title_gvisor.html">
            
                    
                    gvisor
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1.1" data-path="golang_gvisor代码_KVM.html">
            
                <a href="golang_gvisor代码_KVM.html">
            
                    
                    gvisor KVM模式代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.2" data-path="golang_gvisor调试.html">
            
                <a href="golang_gvisor调试.html">
            
                    
                    gvisor调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.3" data-path="golang_gvisor_ptrace.html">
            
                <a href="golang_gvisor_ptrace.html">
            
                    
                    gvisor ptrace模式介绍(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="rust_vmm_brief.html">
            
                <a href="rust_vmm_brief.html">
            
                    
                    rust VMM(virtual machine monitor)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.1" data-path="rust_vmm_简介.html">
            
                <a href="rust_vmm_简介.html">
            
                    
                    rust-vmm简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.2" data-path="rust_firecracker_代码.html">
            
                <a href="rust_firecracker_代码.html">
            
                    
                    firecracker代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.3" data-path="rust_firecracker_使用.html">
            
                <a href="rust_firecracker_使用.html">
            
                    
                    firecracker使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.4" data-path="rust_cloud-hypervisor_代码.html">
            
                <a href="rust_cloud-hypervisor_代码.html">
            
                    
                    cloud hypervisor代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.5" data-path="rust_cloud-hypervisor_使用.html">
            
                <a href="rust_cloud-hypervisor_使用.html">
            
                    
                    cloud hypervisor使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.6" data-path="rust_cloud-hypervisor_问题与解决.html">
            
                <a href="rust_cloud-hypervisor_问题与解决.html">
            
                    
                    cloud hypervisor问题与解决
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.7" data-path="rust_virtiofsd_代码.html">
            
                <a href="rust_virtiofsd_代码.html">
            
                    
                    virtiofsd代码阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.8" data-path="rust_virtio_vhost_libs.html">
            
                <a href="rust_virtio_vhost_libs.html">
            
                    
                    vhost virtio相关的rust库
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="virtualization_virtio规范阅读笔记.html">
            
                <a href="virtualization_virtio规范阅读笔记.html">
            
                    
                    virtio规范阅读笔记.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="qemu_ovs_虚拟化环境.html">
            
                <a href="qemu_ovs_虚拟化环境.html">
            
                    
                    qemu OVS 虚拟化环境准备
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="qemu使用.html">
            
                <a href="qemu使用.html">
            
                    
                    Qemu使用(old)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="qemu_binary_translation.html">
            
                <a href="qemu_binary_translation.html">
            
                    
                    QEMU 指令翻译
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="as_title_networking.html">
            
                <a href="as_title_networking.html">
            
                    
                    计算机网络相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="networking_杂记2.html">
            
                <a href="networking_杂记2.html">
            
                    
                    networking杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="networking_杂记1.html">
            
                <a href="networking_杂记1.html">
            
                    
                    networking杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="networking_优化linux网络栈_接收路径.html">
            
                <a href="networking_优化linux网络栈_接收路径.html">
            
                    
                    优化linux网络栈: 接收路径(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="networking_优化linux网络栈_发送路径.html">
            
                <a href="networking_优化linux网络栈_发送路径.html">
            
                    
                    优化linux网络栈: 发送路径(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="networking_Potential_Performance_Bottleneck_in_Linux_TCP.html">
            
                <a href="networking_Potential_Performance_Bottleneck_in_Linux_TCP.html">
            
                    
                    Potential Performance Bottleneck in Linux TCP(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="networking_xdp入门.html">
            
                <a href="networking_xdp入门.html">
            
                    
                    Get started with XDP(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="networking_linux收包路径图解.html">
            
                <a href="networking_linux收包路径图解.html">
            
                    
                    linux收包路径图解(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8" data-path="vpp_compiling_on_alpine.md">
            
                <span>
            
                    
                    alpine编译vpp
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.8.1" data-path="vpp_host_interace.html">
            
                <a href="vpp_host_interace.html">
            
                    
                    vpp的host-interface
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.9" data-path="as_title_qemu_ovs.html">
            
                <a href="as_title_qemu_ovs.html">
            
                    
                    Qemu OVS和DPDK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.9.1" data-path="OVS_DPDK_编译运行.html">
            
                <a href="OVS_DPDK_编译运行.html">
            
                    
                    OVS-DPDK编译运行
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.2" data-path="OVS_架构和代码.html">
            
                <a href="OVS_架构和代码.html">
            
                    
                    OVS架构和代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.3" data-path="OVS_DPDK_performance_HXT_ARM_server.html">
            
                <a href="OVS_DPDK_performance_HXT_ARM_server.html">
            
                    
                    OVS-DPDK for ARM server 性能测试环境
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.4" data-path="DPDK_Mellanox.html">
            
                <a href="DPDK_Mellanox.html">
            
                    
                    DPDK Mellanox
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.5" data-path="OVS_phy-vm-phy.html">
            
                <a href="OVS_phy-vm-phy.html">
            
                    
                    OVS PHY-VM-PHY
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.6" data-path="networking_网络虚拟化用例记录.html">
            
                <a href="networking_网络虚拟化用例记录.html">
            
                    
                    网络虚拟化用例记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.7" data-path="networking_网络虚拟化操作记录.html">
            
                <a href="networking_网络虚拟化操作记录.html">
            
                    
                    网络虚拟化操作记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.10" data-path="as_title_virtnet.html">
            
                <a href="as_title_virtnet.html">
            
                    
                    虚拟化网络
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.10.1" data-path="networking_tc_filter_连接veth和tap.html">
            
                <a href="networking_tc_filter_连接veth和tap.html">
            
                    
                    Connecting a veth device to tap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10.2" data-path="networking_multicast_vxlan_flannel.html">
            
                <a href="networking_multicast_vxlan_flannel.html">
            
                    
                    multicast vxlan和flannel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10.3" data-path="networking_virtio网络介绍.html">
            
                <a href="networking_virtio网络介绍.html">
            
                    
                    virtio网络介绍(网摘): vhost-net virtio-net vhost-user SRIOV
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10.4" data-path="networking_virtualization_杂记.html">
            
                <a href="networking_virtualization_杂记.html">
            
                    
                    虚拟化网络杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10.5" data-path="networking_linux虚拟网络接口.html">
            
                <a href="networking_linux虚拟网络接口.html">
            
                    
                    linux虚拟网络接口(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="as_title_arm_server.html">
            
                <a href="as_title_arm_server.html">
            
                    
                    ARM server
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="arm_server_杂记.html">
            
                <a href="arm_server_杂记.html">
            
                    
                    Arm server 杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="server_知识点.html">
            
                <a href="server_知识点.html">
            
                    
                    server知识点
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="as_title_embedded.html">
            
                <a href="as_title_embedded.html">
            
                    
                    嵌入式系统开发调试
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="embedded_debugging.html">
            
                <a href="embedded_debugging.html">
            
                    
                    嵌入式调试杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="uboot_杂记.html">
            
                <a href="uboot_杂记.html">
            
                    
                    uboot杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="buildroot_杂记.html">
            
                <a href="buildroot_杂记.html">
            
                    
                    buildroot杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="toolchain_升级gcc问题解决.html">
            
                <a href="toolchain_升级gcc问题解决.html">
            
                    
                    升级GCC7.3问题解决
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="kernel_异常打印分析实例.html">
            
                <a href="kernel_异常打印分析实例.html">
            
                    
                    kernel bug异常打印分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="as_title_linuxdaily.html">
            
                <a href="as_title_linuxdaily.html">
            
                    
                    Linux工程实践
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="linux_日常使用.html">
            
                <a href="linux_日常使用.html">
            
                    
                    日常linux使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="git_日常使用.html">
            
                <a href="git_日常使用.html">
            
                    
                    日常git使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="向kernel提交补丁.html">
            
                <a href="向kernel提交补丁.html">
            
                    
                    向kernel提交补丁
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="linux_ssh_relay.html">
            
                <a href="linux_ssh_relay.html">
            
                    
                    ssh relay
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5" data-path="gitlab_ci.html">
            
                <a href="gitlab_ci.html">
            
                    
                    gitlab CI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.6" data-path="docker_操作记录.html">
            
                <a href="docker_操作记录.html">
            
                    
                    docker操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.7" data-path="centos_操作记录.html">
            
                <a href="centos_操作记录.html">
            
                    
                    centos操作记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="as_title_golang.html">
            
                <a href="as_title_golang.html">
            
                    
                    Golang
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="as_title_golang1.html">
            
                <a href="as_title_golang1.html">
            
                    
                    入门
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1.1" data-path="golang_语法基础.html">
            
                <a href="golang_语法基础.html">
            
                    
                    Golang 语法基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.1.2" data-path="golang_json性能.html">
            
                <a href="golang_json性能.html">
            
                    
                    Golang json性能比较
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="golang_原理.html">
            
                <a href="golang_原理.html">
            
                    
                    Golang 原理相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.2.1" data-path="golang_interface原理.html">
            
                <a href="golang_interface原理.html">
            
                    
                    Golang interface原理(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2.2" data-path="golang_内存分配.html">
            
                <a href="golang_内存分配.html">
            
                    
                    Golang 内存分配(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="golang_标准库.html">
            
                <a href="golang_标准库.html">
            
                    
                    Golang 标准库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="golang_泛型.html">
            
                <a href="golang_泛型.html">
            
                    
                    Golang 泛型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="golang_我的反射代码.html">
            
                <a href="golang_我的反射代码.html">
            
                    
                    Golang 我的反射代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6" data-path="golang_问答.html">
            
                <a href="golang_问答.html">
            
                    
                    Golang 问答
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.7" data-path="golang_plugin.html">
            
                <a href="golang_plugin.html">
            
                    
                    Golang plugin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8" data-path="golang_高效go.html">
            
                <a href="golang_高效go.html">
            
                    
                    Golang 高效go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9" data-path="golang_进阶.html">
            
                <a href="golang_进阶.html">
            
                    
                    Golang 进阶
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10" data-path="as_title_golang2.html">
            
                <a href="as_title_golang2.html">
            
                    
                    Golang 杂记
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.10.1" data-path="golang_杂记1.html">
            
                <a href="golang_杂记1.html">
            
                    
                    Golang 杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.2" data-path="golang_杂记2.html">
            
                <a href="golang_杂记2.html">
            
                    
                    Golang 杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.3" data-path="golang_杂记3.html">
            
                <a href="golang_杂记3.html">
            
                    
                    Golang 杂记3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.4" data-path="golang_lib选型.html">
            
                <a href="golang_lib选型.html">
            
                    
                    Golang lib选型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.5" data-path="golang_mod_proxy.html">
            
                <a href="golang_mod_proxy.html">
            
                    
                    go mod和go proxy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.6" data-path="golang_汇编_arm64.html">
            
                <a href="golang_汇编_arm64.html">
            
                    
                    Golang 汇编语法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.7" data-path="golang_cgo_swig.html">
            
                <a href="golang_cgo_swig.html">
            
                    
                    go调用c可以用swig
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.11" data-path="as_title_golang3.html">
            
                <a href="as_title_golang3.html">
            
                    
                    Golang 环境和工具链生成
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.11.1" data-path="golang_toolchain_ppc.html">
            
                <a href="golang_toolchain_ppc.html">
            
                    
                    go tools增加ppc32支持
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.2" data-path="golang_toolchain_compile_gccgo.html">
            
                <a href="golang_toolchain_compile_gccgo.html">
            
                    
                    编译gccgo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.3" data-path="golang_go_on_mips.html">
            
                <a href="golang_go_on_mips.html">
            
                    
                    go on mips boards(not so updated)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.11.3.1" data-path="golang_go_on_mips_part1.html">
            
                <a href="golang_go_on_mips_part1.html">
            
                    
                    part 1: cross compile go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.3.2" data-path="golang_go_on_mips_part2.html">
            
                <a href="golang_go_on_mips_part2.html">
            
                    
                    part 2: build native go compiler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.3.3" data-path="golang_go_on_mips_part3.html">
            
                <a href="golang_go_on_mips_part3.html">
            
                    
                    part 3: gccgo experiments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.3.4" data-path="golang_go_on_mips_part4.html">
            
                <a href="golang_go_on_mips_part4.html">
            
                    
                    part 4: Golang json performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.3.5" data-path="golang_gentoo_on_mips_board_and_build_go.html">
            
                <a href="golang_gentoo_on_mips_board_and_build_go.html">
            
                    
                    Gentoo on mips board and build go
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.12" data-path="as_title_golang4.html">
            
                <a href="as_title_golang4.html">
            
                    
                    微服务
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.12.1" data-path="golang_micro.html">
            
                <a href="golang_micro.html">
            
                    
                    go-micro和micro
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.2" data-path="golang_微服务概念.html">
            
                <a href="golang_微服务概念.html">
            
                    
                    微服务概念
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.13" data-path="as_title_golang5.html">
            
                <a href="as_title_golang5.html">
            
                    
                    解释器和编解码
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.13.1" data-path="golang_yeagi.html">
            
                <a href="golang_yeagi.html">
            
                    
                    解释器yeagi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.2" data-path="golang_tengo.html">
            
                <a href="golang_tengo.html">
            
                    
                    解释器tengo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.3" data-path="golang_govaluate.html">
            
                <a href="golang_govaluate.html">
            
                    
                    解释器govaluate
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.4" data-path="golang_encoding_gotiny.html">
            
                <a href="golang_encoding_gotiny.html">
            
                    
                    gotiny编解码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.5" data-path="golang_abs.html">
            
                <a href="golang_abs.html">
            
                    
                    解释器abs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.14" data-path="as_title_golang6.html">
            
                <a href="as_title_golang6.html">
            
                    
                    调试和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.14.1" data-path="golang_调试记录.html">
            
                <a href="golang_调试记录.html">
            
                    
                    Golang 调试记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.14.2" data-path="golang_topid性能优化.html">
            
                <a href="golang_topid性能优化.html">
            
                    
                    Golang topid性能优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.14.3" data-path="golang_gshell性能调试.html">
            
                <a href="golang_gshell性能调试.html">
            
                    
                    Golang gshell性能调试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.15" data-path="as_title_golang7.html">
            
                <a href="as_title_golang7.html">
            
                    
                    网络和消息中间件
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.15.1" data-path="golang_zmq.html">
            
                <a href="golang_zmq.html">
            
                    
                    消息中间件基本概念和zero mq
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.15.2" data-path="golang_mango.html">
            
                <a href="golang_mango.html">
            
                    
                    消息中间件mango
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.15.3" data-path="golang_libp2p.html">
            
                <a href="golang_libp2p.html">
            
                    
                    Golang p2p网络
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="as_title_rust.html">
            
                <a href="as_title_rust.html">
            
                    
                    Rust
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="rust_入门_brief.html">
            
                <a href="rust_入门_brief.html">
            
                    
                    Rust 入门系列
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1.1" data-path="rust_books.html">
            
                <a href="rust_books.html">
            
                    
                    Rust reference books
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.2" data-path="rust_入门1.html">
            
                <a href="rust_入门1.html">
            
                    
                    Rust 安装和基础语法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.3" data-path="rust_入门2.html">
            
                <a href="rust_入门2.html">
            
                    
                    Rust 泛型和内存所有权
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.4" data-path="rust_入门3.html">
            
                <a href="rust_入门3.html">
            
                    
                    Rust 闭包 容器 迭代器 生成器 线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.5" data-path="rust_工程构建.html">
            
                <a href="rust_工程构建.html">
            
                    
                    Rust 工程构建
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="rust_coding_brief.html">
            
                <a href="rust_coding_brief.html">
            
                    
                    Rust 代码积累
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.2.1" data-path="rust_by_example_misc.html">
            
                <a href="rust_by_example_misc.html">
            
                    
                    Rust by example杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.2" data-path="rust_序列化.html">
            
                <a href="rust_序列化.html">
            
                    
                    Rust 序列化原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.3" data-path="rust_知识点积累.html">
            
                <a href="rust_知识点积累.html">
            
                    
                    Rust 知识点更新
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.4" data-path="rust_adaptiveservice.html">
            
                <a href="rust_adaptiveservice.html">
            
                    
                    rust版本的adaptiveservice探索
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.5" data-path="rust_常用设施.html">
            
                <a href="rust_常用设施.html">
            
                    
                    Rust 常用设施
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.6" data-path="rust_代码小段.html">
            
                <a href="rust_代码小段.html">
            
                    
                    Rust 代码小段
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.7" data-path="rust_错误处理.html">
            
                <a href="rust_错误处理.html">
            
                    
                    Rust 错误处理(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="others.html">
            
                <a href="others.html">
            
                    
                    其他
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.3.1" data-path="rust_mdbook_使用.html">
            
                <a href="rust_mdbook_使用.html">
            
                    
                    Rust 使用mdbook
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="as_title_scripts.html">
            
                <a href="as_title_scripts.html">
            
                    
                    脚本
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="shell_变量.html">
            
                <a href="shell_变量.html">
            
                    
                    shell变量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="shell_基础篇.html">
            
                <a href="shell_基础篇.html">
            
                    
                    shell命令和脚本记录-基础篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="shell_高级篇.html">
            
                <a href="shell_高级篇.html">
            
                    
                    shell命令和脚本记录-高级篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.4" data-path="shell_脚本片段.html">
            
                <a href="shell_脚本片段.html">
            
                    
                    shell脚本片段
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.5" data-path="python_记录.html">
            
                <a href="python_记录.html">
            
                    
                    python记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.6" data-path="lua_记录.html">
            
                <a href="lua_记录.html">
            
                    
                    lua记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.7" data-path="shell_rds脚本阅读.html">
            
                <a href="shell_rds脚本阅读.html">
            
                    
                    RDS脚本阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.8" data-path="Project_Euler.html">
            
                <a href="Project_Euler.html">
            
                    
                    Project Euler
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="as_title_app.html">
            
                <a href="as_title_app.html">
            
                    
                    应用相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="app_sysbench代码分析.html">
            
                <a href="app_sysbench代码分析.html">
            
                    
                    sysbench代码分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="as_title_algorithm.html">
            
                <a href="as_title_algorithm.html">
            
                    
                    算法相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" data-path="algorithm_radix_tree.html">
            
                <a href="algorithm_radix_tree.html">
            
                    
                    基数(radix)树(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="as_title_cos.html">
            
                <a href="as_title_cos.html">
            
                    
                    C和Operating System
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.1" data-path="system_libc_part1.html">
            
                <a href="system_libc_part1.html">
            
                    
                    libc概览1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="system_libc_part2.html">
            
                <a href="system_libc_part2.html">
            
                    
                    libc概览2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.3" data-path="system_libc_part3.html">
            
                <a href="system_libc_part3.html">
            
                    
                    libc概览3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.4" data-path="system_原理杂记.html">
            
                <a href="system_原理杂记.html">
            
                    
                    系统原理杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.5" data-path="system_alpine.html">
            
                <a href="system_alpine.html">
            
                    
                    Alpine Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.6" data-path="system_进程间通信.html">
            
                <a href="system_进程间通信.html">
            
                    
                    进程间通信
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.7" data-path="system_特殊功能fd.html">
            
                <a href="system_特殊功能fd.html">
            
                    
                    eventfd timerfd signalfd和fd共享
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8" data-path="c_automake_autoconf.html">
            
                <a href="c_automake_autoconf.html">
            
                    
                    automake autoconf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.9" data-path="makefile_原理和实践.html">
            
                <a href="makefile_原理和实践.html">
            
                    
                    makefile
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.10" data-path="c_编程杂记高级篇.html">
            
                <a href="c_编程杂记高级篇.html">
            
                    
                    C编程杂记高级篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.11" data-path="c_编程杂记基础篇.html">
            
                <a href="c_编程杂记基础篇.html">
            
                    
                    C编程杂记基础篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.12" data-path="c_networking_socket高阶用法.html">
            
                <a href="c_networking_socket高阶用法.html">
            
                    
                    网络编程: Advanced Socket Topics(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.13" data-path="c_protobuf介绍.html">
            
                <a href="c_protobuf介绍.html">
            
                    
                    序列化: protobuf介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.14" data-path="c_进程间通信_共享文件和共享内存.html">
            
                <a href="c_进程间通信_共享文件和共享内存.html">
            
                    
                    进程间通信: 共享文件和共享内存(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.15" data-path="c_pthread_condition和mutex.html">
            
                <a href="c_pthread_condition和mutex.html">
            
                    
                    并发 任务 事件 和锁.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.16" data-path="kernel_user_space_howto.html">
            
                <a href="kernel_user_space_howto.html">
            
                    
                    kernel space和user space交互(网摘, linux2.6)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.17" data-path="CentOS_系统性能优化配置.html">
            
                <a href="CentOS_系统性能优化配置.html">
            
                    
                    CentOS 性能优化系统配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.18" data-path="OS_gentoo使用.html">
            
                <a href="OS_gentoo使用.html">
            
                    
                    gentoo使用记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="as_title_driver.html">
            
                <a href="as_title_driver.html">
            
                    
                    内核 设备和驱动相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1" data-path="device_driver_地址空间类型和DMA.html">
            
                <a href="device_driver_地址空间类型和DMA.html">
            
                    
                    地址空间类型和DMA
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.2" data-path="platform_device_driver.html">
            
                <a href="platform_device_driver.html">
            
                    
                    平台驱动杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3" data-path="platform_device_driver2.html">
            
                <a href="platform_device_driver2.html">
            
                    
                    平台驱动杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.4" data-path="device_driver_pci驱动概述.html">
            
                <a href="device_driver_pci驱动概述.html">
            
                    
                    pci驱动概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.5" data-path="device_driver_内核中的时间和延迟操作.html">
            
                <a href="device_driver_内核中的时间和延迟操作.html">
            
                    
                    内核中的时间和延迟操作
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.6" data-path="device_driver_杂记.html">
            
                <a href="device_driver_杂记.html">
            
                    
                    驱动调试杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.7" data-path="device_localbus_16bit读写.html">
            
                <a href="device_localbus_16bit读写.html">
            
                    
                    CPLD做8bit到16bit转换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.8" data-path="driver_位域和大小端.html">
            
                <a href="driver_位域和大小端.html">
            
                    
                    位域和大小端
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.9" data-path="as_title_driver1.html">
            
                <a href="as_title_driver1.html">
            
                    
                    nand
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.9.1" data-path="device_driver_octeon_nand.html">
            
                <a href="device_driver_octeon_nand.html">
            
                    
                    octeon nand flash驱动
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.9.2" data-path="device_driver_nand概率写失败问题分析.html">
            
                <a href="device_driver_nand概率写失败问题分析.html">
            
                    
                    Nand flash概率写失败问题分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.10" data-path="octeon_remote_pci.html">
            
                <a href="octeon_remote_pci.html">
            
                    
                    octeon remote-pci.c阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.11" data-path="Device_VFIO_notes.html">
            
                <a href="Device_VFIO_notes.html">
            
                    
                    VFIO简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12" data-path="as_title_driver2.html">
            
                <a href="as_title_driver2.html">
            
                    
                    智能网卡和DPDK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.12.1" data-path="smartNIC_智能网卡对比.html">
            
                <a href="smartNIC_智能网卡对比.html">
            
                    
                    智能网卡对比
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.2" data-path="octeon_pci_NIC.html">
            
                <a href="octeon_pci_NIC.html">
            
                    
                    octeon PCI NIC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.3" data-path="as_title_driver3.html">
            
                <a href="as_title_driver3.html">
            
                    
                    octeon liquidIO
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.12.3.1" data-path="smartNIC_liquidIO_代码阅读app篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读app篇.html">
            
                    
                    PCI-NIC 代码阅读 --app篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.3.2" data-path="smartNIC_liquidIO_代码阅读api篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读api篇.html">
            
                    
                    PCI-NIC 代码阅读 --api篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.3.3" data-path="smartNIC_liquidIO_代码阅读driver篇之结构体.html">
            
                <a href="smartNIC_liquidIO_代码阅读driver篇之结构体.html">
            
                    
                    PCI-NIC 代码阅读 --driver篇之结构体
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.16.12.3.4" data-path="smartNIC_liquidIO_代码阅读driver篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读driver篇.html">
            
                    
                    PCI-NIC 代码阅读 --driver篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.3.5" data-path="smartNIC_liquidIO_代码阅读真NIC篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读真NIC篇.html">
            
                    
                    PCI-NIC 代码阅读 --真NIC篇
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.12.4" data-path="networking_dpdk使用_2014.html">
            
                <a href="networking_dpdk使用_2014.html">
            
                    
                    DPDK使用(2014)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.13" data-path="device_nvme要点介绍.html">
            
                <a href="device_nvme要点介绍.html">
            
                    
                    nvme要点介绍
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="as_title_cpu.html">
            
                <a href="as_title_cpu.html">
            
                    
                    CPU Arch相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.1" data-path="CPU_interconnection_networks.html">
            
                <a href="CPU_interconnection_networks.html">
            
                    
                    CPU核互联模型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.2" data-path="cache_CPU和cache一致性原理.html">
            
                <a href="cache_CPU和cache一致性原理.html">
            
                    
                    CPU和cache一致性原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3" data-path="as_title_cpu1.html">
            
                <a href="as_title_cpu1.html">
            
                    
                    ARM64
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.3.1" data-path="CPU_ARM64_知识杂记.html">
            
                <a href="CPU_ARM64_知识杂记.html">
            
                    
                    aarch64架构知识杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.2" data-path="CPU_ARM64_thunder_overview.html">
            
                <a href="CPU_ARM64_thunder_overview.html">
            
                    
                    thunder 概览
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.3" data-path="CPU_ARM64_thunder_开发板操作记录.html">
            
                <a href="CPU_ARM64_thunder_开发板操作记录.html">
            
                    
                    thunder 开发板操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.4" data-path="CPU_ARM64_thunder_bdk.html">
            
                <a href="CPU_ARM64_thunder_bdk.html">
            
                    
                    thunder BDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.5" data-path="CPU_ARM64_thunder_efi_rtc.html">
            
                <a href="CPU_ARM64_thunder_efi_rtc.html">
            
                    
                    thunder RTC时间和efi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.6" data-path="CPU_ARM64_thunder_uefi_fdt.html">
            
                <a href="CPU_ARM64_thunder_uefi_fdt.html">
            
                    
                    thunder uefi和fdt
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.7" data-path="CPU_ARM64_thunder_atf.html">
            
                <a href="CPU_ARM64_thunder_atf.html">
            
                    
                    thunder atf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.8" data-path="CPU_ARM64_thunder_kernel_boot.html">
            
                <a href="CPU_ARM64_thunder_kernel_boot.html">
            
                    
                    thunder kernel启动打印流程
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17.4" data-path="as_title_cpu2.html">
            
                <a href="as_title_cpu2.html">
            
                    
                    PPC
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.4.1" data-path="CPU_PPC启动多核Linux_流程和内存映射.html">
            
                <a href="CPU_PPC启动多核Linux_流程和内存映射.html">
            
                    
                    PPC启动多核linux: 流程和内存映射
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.4.2" data-path="CPU_PPC_kernel升级记录.html">
            
                <a href="CPU_PPC_kernel升级记录.html">
            
                    
                    PPC kernel升级记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17.5" data-path="as_title_cpu3.html">
            
                <a href="as_title_cpu3.html">
            
                    
                    MIPS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.5.1" data-path="CPU_MIPS_octeon地址空间和寄存器访问.html">
            
                <a href="CPU_MIPS_octeon地址空间和寄存器访问.html">
            
                    
                    octeon 地址空间和寄存器访问
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.2" data-path="CPU_MIPS_octeon操作记录.html">
            
                <a href="CPU_MIPS_octeon操作记录.html">
            
                    
                    octeon 操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.3" data-path="CPU_MIPS_octeon_包处理性能.html">
            
                <a href="CPU_MIPS_octeon_包处理性能.html">
            
                    
                    octeon 系列处理器包处理性能
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.4" data-path="CPU_MIPS_octeon_ddr调试记录.html">
            
                <a href="CPU_MIPS_octeon_ddr调试记录.html">
            
                    
                    octeon DDR调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.5" data-path="CPU_MIPS_octeon_BDK.html">
            
                <a href="CPU_MIPS_octeon_BDK.html">
            
                    
                    octeon CN78xx BDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.6" data-path="kernel_增加ECC中断.html">
            
                <a href="kernel_增加ECC中断.html">
            
                    
                    octeon 增加ECC中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.7" data-path="CPU_MIPS_octeon_hw-ddr2代码走读.html">
            
                <a href="CPU_MIPS_octeon_hw-ddr2代码走读.html">
            
                    
                    octeon hw-ddr2代码走读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.8" data-path="CPU_MIPS_octeon_reboot调试和ddr中断.html">
            
                <a href="CPU_MIPS_octeon_reboot调试和ddr中断.html">
            
                    
                    octeon reboot调试和DDR中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.9" data-path="CPU_MIPS_octeon中断.html">
            
                <a href="CPU_MIPS_octeon中断.html">
            
                    
                    octeon 中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.10" data-path="CPU_MIPS_octeon原子操作.html">
            
                <a href="CPU_MIPS_octeon原子操作.html">
            
                    
                    octeon 原子操作
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.11" data-path="CPU_MIPS_octeon网口代码分析.html">
            
                <a href="CPU_MIPS_octeon网口代码分析.html">
            
                    
                    octeon 网口代码分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >PCI-NIC 代码阅读 --driver篇</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;"><b>1. </b>&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;</a></li><li><span class="title-icon "></span><a href="#&#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spinlock&#x548C;atomic&#x53D8;&#x91CF;"><b>2. </b>&#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spin_lock&#x548C;atomic&#x53D8;&#x91CF;</a></li><li><span class="title-icon "></span><a href="#&#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;"><b>3. </b>&#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;</a></li><li><span class="title-icon "></span><a href="#&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;"><b>4. </b>&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;</a></li><li><span class="title-icon "></span><a href="#pci-base-driver&#x6A21;&#x5757;"><b>5. </b>pci base driver&#x6A21;&#x5757;</a></li><ul><li><span class="title-icon "></span><a href="#a-pci&#x9A71;&#x52A8;"><b>5.1. </b>A. pci&#x9A71;&#x52A8;</a></li><ul><li><span class="title-icon "></span><a href="#a1-octeon&#x7684;pci-probe&#x51FD;&#x6570;"><b>5.1.1. </b>A1. octeon&#x7684;pci probe&#x51FD;&#x6570;</a></li></ul><li><span class="title-icon "></span><a href="#b-octpollthread-&#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;"><b>5.2. </b>B. oct_poll_thread, &#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;</a></li><li><span class="title-icon "></span><a href="#c-octeonfops-&#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl"><b>5.3. </b>C. octeon_fops: &#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl</a></li><ul><li><span class="title-icon "></span><a href="#c1-octeonioctl"><b>5.3.1. </b>C1. octeon_ioctl</a></li></ul><li><span class="title-icon "></span><a href="#&#x4E2D;&#x65AD;&#x5904;&#x7406;-&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;"><b>5.4. </b>&#x4E2D;&#x65AD;&#x5904;&#x7406; :&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;</a></li><ul><li><span class="title-icon "></span><a href="#int1-octeondroqbh-&#x89C1;a19"><b>5.4.1. </b>INT1. octeon_droq_bh, &#x89C1;A19</a></li><li><span class="title-icon "></span><a href="#int2-octeonrequestcompletionbh-&#x548C;a15&#x51E0;&#x4E4E;&#x4E00;&#x6837;"><b>5.4.2. </b>INT2. octeon_request_completion_bh, &#x548C;A15&#x51E0;&#x4E4E;&#x4E00;&#x6837;</a></li></ul></ul></ul></div><a href="#&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><ul>
<li><a href="#&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;">&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;</a></li>
<li><a href="#&#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spin_lock&#x548C;atomic&#x53D8;&#x91CF;">&#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spin_lock&#x548C;atomic&#x53D8;&#x91CF;</a></li>
<li><a href="#&#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;">&#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;</a></li>
<li><a href="#&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;">&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;</a></li>
<li><a href="#pci-base-driver&#x6A21;&#x5757;">pci base driver&#x6A21;&#x5757;</a><ul>
<li><a href="#a-pci&#x9A71;&#x52A8;">A. pci&#x9A71;&#x52A8;</a><ul>
<li><a href="#a1-octeon&#x7684;pci-probe&#x51FD;&#x6570;">A1. octeon&#x7684;pci probe&#x51FD;&#x6570;</a><ul>
<li><a href="#a11-&#x5982;&#x4F55;osi-&#x5230;&#x5E95;&#x54EA;&#x4E9B;&#x662F;osi&#x7684;-&#x54EA;&#x4E9B;&#x53C8;&#x4E0D;&#x662F;">A11. &#x5982;&#x4F55;osi? &#x5230;&#x5E95;&#x54EA;&#x4E9B;&#x662F;osi&#x7684;? &#x54EA;&#x4E9B;&#x53C8;&#x4E0D;&#x662F;?</a></li>
<li><a href="#a12cn66xx&#x7684;&#x914D;&#x7F6E;&#x8868;">A12.cn66xx&#x7684;&#x914D;&#x7F6E;&#x8868;</a></li>
<li><a href="#a13-oct_poll_module_starter">A13. oct_poll_module_starter</a></li>
<li><a href="#a14-check_db_timeout--doorbell-timeout-&#x5468;&#x671F;1&#x4E2A;tick">A14. check_db_timeout  &quot;Doorbell Timeout&quot;, &#x5468;&#x671F;1&#x4E2A;tick</a><ul>
<li><a href="#a141-octeon_pci_map_single&#x548C;octeon_pci_unmap_single">A141. octeon_pci_map_single&#x548C;octeon_pci_unmap_single</a></li>
<li><a href="#a142-&#x5185;&#x5B58;&#x7533;&#x8BF7;&#x53CA;&#x91CA;&#x653E;">A142. &#x5185;&#x5B58;&#x7533;&#x8BF7;&#x53CA;&#x91CA;&#x653E;</a></li>
</ul>
</li>
<li><a href="#a15-oct_poll_req_completion-1&#x4E2A;tick">A15. oct_poll_req_completion, 1&#x4E2A;tick</a></li>
<li><a href="#a16-oct_poll_check_unordered_list">A16. oct_poll_check_unordered_list</a></li>
<li><a href="#a17-check_droq_refill-&#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;">A17. check_droq_refill, &#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;</a><ul>
<li><a href="#a171-octeon_droq_refill">A171. octeon_droq_refill</a></li>
</ul>
</li>
<li><a href="#a18-oct_droq_thread-&#x6536;&#x5305;&#x7EBF;&#x7A0B;-&#x6BCF;&#x4E2A;output-q&#x4E00;&#x4E2A;">A18. oct_droq_thread, &#x6536;&#x5305;&#x7EBF;&#x7A0B;, &#x6BCF;&#x4E2A;output q&#x4E00;&#x4E2A;</a><ul>
<li><a href="#a181-octeon_register_dispatch_fn-&#x6CE8;&#x518C;&#x6536;&#x5305;&#x5BF9;&#x5E94;&#x7684;opcode&#x51FD;&#x6570;">A181. octeon_register_dispatch_fn() &#x6CE8;&#x518C;&#x6536;&#x5305;&#x5BF9;&#x5E94;&#x7684;opcode&#x51FD;&#x6570;</a></li>
<li><a href="#a182-octeon_create_recv_info-&#x4ECE;&#x9A71;&#x52A8;&#x5C42;&#x5230;&#x5206;&#x53D1;&#x5C42;-&#x6BCF;&#x4E2A;&#x6765;&#x7684;&#x62A5;&#x6587;&#x90FD;&#x4F1A;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;">A182. octeon_create_recv_info(), &#x4ECE;&#x9A71;&#x52A8;&#x5C42;&#x5230;&#x5206;&#x53D1;&#x5C42;, &#x6BCF;&#x4E2A;&#x6765;&#x7684;&#x62A5;&#x6587;&#x90FD;&#x4F1A;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;</a></li>
</ul>
</li>
<li><a href="#a19-octeon_droq_bh">A19. octeon_droq_bh</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#b-oct_poll_thread-&#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;">B. oct_poll_thread, &#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;</a></li>
<li><a href="#c-octeon_fops-&#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl">C. octeon_fops: &#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl</a><ul>
<li><a href="#c1-octeon_ioctl">C1. octeon_ioctl</a><ul>
<li><a href="#c11oct_poll_module_starter">C11.oct_poll_module_starter()</a></li>
<li><a href="#c12octeon_ioctl_send_request">C12.octeon_ioctl_send_request</a><ul>
<li><a href="#c121-octeon_copy_input_dma_buffers--&#x65B0;&#x7533;&#x8BF7;&#x5185;&#x6838;&#x6001;&#x7684;input-buffer-&#x5E76;&#x628A;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;data&#x62F7;&#x8FDB;&#x6765;">C121. octeon_copy_input_dma_buffers : &#x65B0;&#x7533;&#x8BF7;&#x5185;&#x6838;&#x6001;&#x7684;input buffer, &#x5E76;&#x628A;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;data&#x62F7;&#x8FDB;&#x6765;</a></li>
<li><a href="#c122-octeon_create_output_dma_buffers--&#x5C06;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;output-buffer&#x5728;&#x5185;&#x6838;&#x6001;&#x4E5F;&#x7533;&#x8BF7;&#x4E00;&#x4EFD;">C122. octeon_create_output_dma_buffers : &#x5C06;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;output buffer&#x5728;&#x5185;&#x6838;&#x6001;&#x4E5F;&#x7533;&#x8BF7;&#x4E00;&#x4EFD;</a></li>
<li><a href="#c123-octeon_create_data_buf">C123. octeon_create_data_buf</a><ul>
<li><a href="#c1231-octeon_create_sg_list">C1231. octeon_create_sg_list</a></li>
</ul>
</li>
<li><a href="#c124-&#x4E3B;&#x8981;&#x7684;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;">C124. &#x4E3B;&#x8981;&#x7684;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#&#x4E2D;&#x65AD;&#x5904;&#x7406;-&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;">&#x4E2D;&#x65AD;&#x5904;&#x7406; :&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;</a><ul>
<li><a href="#int1-octeon_droq_bh-&#x89C1;a19">INT1. octeon_droq_bh, &#x89C1;A19</a></li>
<li><a href="#int2-octeon_request_completion_bh-&#x548C;a15&#x51E0;&#x4E4E;&#x4E00;&#x6837;">INT2. octeon_request_completion_bh, &#x548C;A15&#x51E0;&#x4E4E;&#x4E00;&#x6837;</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;"><a name="&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;" class="anchor-navigation-ex-anchor" href="#&#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;"><i class="fa fa-link" aria-hidden="true"></i></a>1. &#x6253;&#x5F00;&#x8C03;&#x8BD5;&#x6253;&#x5370;</h1>
<p>&#x5B9A;&#x4E49;<code>CAVIUM_DEBUG PRINT_FLOW</code><br>&#x6216;<code>CAVIUM_DEBUG PRINT_ALL</code><br>&#x8FD8;&#x53EF;&#x4EE5;&#x7528;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6253;&#x5370;droq&#x4FE1;&#x606F;:
<code>oct_dump_droq_state(octeon_droq_t   *oq)</code></p>
<h1 id="&#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spinlock&#x548C;atomic&#x53D8;&#x91CF;"><a name="&#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spinlock&#x548C;atomic&#x53D8;&#x91CF;" class="anchor-navigation-ex-anchor" href="#&#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spinlock&#x548C;atomic&#x53D8;&#x91CF;"><i class="fa fa-link" aria-hidden="true"></i></a>2. &#x4EE3;&#x7801;&#x91CC;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x7684;spin_lock&#x548C;atomic&#x53D8;&#x91CF;</h1>
<p>&#x51E0;&#x4E4E;&#x6BCF;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x90FD;&#x6709;<code>spin_lock</code>&#x4FDD;&#x62A4;, &#x6BD4;&#x5982;pending list&#x5C31;&#x6709;<br><code>cavium_spin_lock_init(&amp;oct-&gt;plist-&gt;lock);</code>
&#x63A5;&#x7740;&#x8FD8;&#x6709;atomic&#x53D8;&#x91CF;<br><code>cavium_atomic_set(&amp;oct-&gt;plist-&gt;instr_count, 0);</code></p>
<h1 id="&#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;"><a name="&#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;" class="anchor-navigation-ex-anchor" href="#&#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;"><i class="fa fa-link" aria-hidden="true"></i></a>3. &#x51E0;&#x79CD;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x5408;</h1>
<pre class="language-"><code>resp_order == OCTEON_RESP_ORDERED
    : resp_list = OCTEON_ORDERED_LIST
    : &#x7531;process_ordered_list()&#x5904;&#x7406;, &#x89C1;A15

resp_order == OCTEON_RESP_UNORDERED &amp;&amp; resp_mode == OCTEON_RESP_BLOCKING
    : resp_list = OCTEON_UNORDERED_BLOCKING_LIST
    : &#x7531;check_unordered_blocking_list()&#x5904;&#x7406;, &#x89C1;A15

resp_order == OCTEON_RESP_UNORDERED &amp;&amp; resp_mode == OCTEON_RESP_NON_BLOCKING
    : resp_list = OCTEON_UNORDERED_NONBLOCKING_LIST
    : &#x7531;oct_poll_check_unordered_list()&#x5904;&#x7406;, &#x4F46;&#x88AB;&#x6CE8;&#x91CA;&#x6389;&#x4E86;?, &#x89C1;A16
</code></pre><h1 id="&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;"><a name="&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;" class="anchor-navigation-ex-anchor" href="#&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;"><i class="fa fa-link" aria-hidden="true"></i></a>4. &#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x8109;&#x7EDC;</h1>
<pre class="language-"><code class="lang-c">octeon_ioctl_send_request
    <span class="token function">__do_request_processing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">__do_instruction_processing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">oct_test_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">send_test_packet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">octeon_process_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">__do_request_processing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">__do_instruction_processing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">perf_test_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">octeon_process_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">__do_request_processing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">__do_instruction_processing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">cn56xx_send_peer_to_peer_map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">--</span>&#x6CE8;&#x610F;<span class="token operator">:</span> nic&#x6A21;&#x5757;&#x4E5F;&#x4F1A;&#x8C03;&#x7528;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;
    <span class="token function">octeon_process_instruction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">__do_instruction_processing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">octeon_destroy_resources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">octeon_send_short_command</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">__do_instruction_processing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">octeon_hot_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">octeon_send_short_command</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">__do_instruction_processing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">octeon_shutdown_output_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">octeon_send_short_command</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">__do_instruction_processing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">octeon_restart_output_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">octeon_send_short_command</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">__do_instruction_processing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h1 id="pci-base-driver&#x6A21;&#x5757;"><a name="pci-base-driver&#x6A21;&#x5757;" class="anchor-navigation-ex-anchor" href="#pci-base-driver&#x6A21;&#x5757;"><i class="fa fa-link" aria-hidden="true"></i></a>5. pci base driver&#x6A21;&#x5757;</h1>
<p><code>components/driver/host/driver/linux/octeon_linux.c</code></p>
<pre class="language-"><code class="lang-c"><span class="token function">module_init</span><span class="token punctuation">(</span>octeon_base_init_module<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x6253;&#x5370;&#x4E00;&#x4E9B;&#x7CFB;&#x7EDF;&#x7279;&#x5F81;&#x4FE1;&#x606F;, &#x5927;&#x5C0F;&#x7AEF;, HZ, &#x7F16;&#x8BD1;&#x5B8F;&#x5F00;&#x5173;&#x7B49;, &#x8FD9;&#x662F;&#x5F88;&#x597D;&#x7684;&#x67B6;&#x6784;&#x8BBE;&#x8BA1;&#x4E60;&#x60EF;</span>
    octeon_state <span class="token operator">=</span> OCT_DRV_DEVICE_INIT_START<span class="token punctuation">;</span>
    <span class="token comment">//&#x6E05;&#x96F6;octeon device&#x6570;&#x7EC4;, &#x5171;4&#x4E2A;</span>
    <span class="token function">octeon_init_device_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x6E05;&#x96F6;octmodhandlers&#x6570;&#x7EC4;, 3&#x4E2A;</span>
    <span class="token function">octeon_init_module_handler_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x89C1;PCI-NIC &#x4EE3;&#x7801;&#x9605;&#x8BFB;&#x4E4B;driver&#x7BC7;(&#x7ED3;&#x6784;&#x4F53;)&#x4E4B;octeon_module_handler_t</span>
    <span class="token comment">//&#x6CE8;&#x518C;pci&#x9A71;&#x52A8;, &#x89C1;A</span>
    ret <span class="token operator">=</span> <span class="token function">pci_register_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octeon_pci_driver<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x7B80;&#x5355;&#x8BBE;&#x7F6E;&#x4E86;driver&#x7684;bus&#x7B49;&#x5C5E;&#x6027;&#x540E;, &#x8FD8;&#x662F;&#x8C03;&#x7528;driver_register(&amp;drv-&gt;driver)</span>
    octeon_state <span class="token operator">=</span> OCT_DRV_DEVICE_INIT_DONE<span class="token punctuation">;</span>
    <span class="token comment">//&#x521D;&#x59CB;&#x5316;poll&#x8FDB;&#x7A0B;</span>
    <span class="token function">octeon_init_poll_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//&#x8868;&#x793A;kthread&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x89C1;PCI-NIC &#x4EE3;&#x7801;&#x9605;&#x8BFB;&#x4E4B;driver&#x7BC7;(&#x7ED3;&#x6784;&#x4F53;)G2</span>
        <span class="token comment">//&#x8FDB;&#x7A0B;&#x4E3B;&#x4F53;&#x662F;oct_poll_thread, &#x89C1;B</span>
        <span class="token function">cavium_kthread_setup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oct_poll_id<span class="token punctuation">,</span> oct_poll_thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;Oct Poll Thread&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cavium_kthread_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            t<span class="token operator">-&gt;</span>id <span class="token operator">=</span> <span class="token function">kthread_create</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>fn<span class="token punctuation">,</span> t<span class="token operator">-&gt;</span>fn_arg<span class="token punctuation">,</span> t<span class="token operator">-&gt;</span>fn_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>exec_on_create<span class="token punctuation">)</span>
                <span class="token function">wake_up_process</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    octeon_state <span class="token operator">=</span> OCT_DRV_POLL_INIT_DONE<span class="token punctuation">;</span>
    <span class="token comment">//&#x6CE8;&#x518C;&#x5B57;&#x7B26;&#x8BBE;&#x5907;/dev/octeon_device, &#x89C1;C</span>
    ret <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span>OCTEON_DEVICE_MAJOR<span class="token punctuation">,</span> DRIVER_NAME<span class="token punctuation">,</span><span class="token operator">&amp;</span>octeon_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    octeon_state <span class="token operator">=</span> OCT_DRV_REGISTER_DONE<span class="token punctuation">;</span>
</code></pre>
<h2 id="a-pci&#x9A71;&#x52A8;"><a name="a-pci&#x9A71;&#x52A8;" class="anchor-navigation-ex-anchor" href="#a-pci&#x9A71;&#x52A8;"><i class="fa fa-link" aria-hidden="true"></i></a>5.1. A. pci&#x9A71;&#x52A8;</h2>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">pci_driver</span> octeon_pci_driver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name     <span class="token operator">=</span> <span class="token string">&quot;Octeon&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>id_table <span class="token operator">=</span> octeon_pci_tbl<span class="token punctuation">,</span> <span class="token comment">//&#x5305;&#x62EC;&#x4E86;6XXX&#x5168;&#x7CFB;&#x5217;&#x7684;PCI ID</span>
    <span class="token punctuation">.</span>probe    <span class="token operator">=</span> octeon_probe<span class="token punctuation">,</span> <span class="token comment">//&#x89C1;A1</span>
    <span class="token punctuation">.</span>remove   <span class="token operator">=</span> <span class="token function">__devexit_p</span><span class="token punctuation">(</span>octeon_remove<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="a1-octeon&#x7684;pci-probe&#x51FD;&#x6570;"><a name="a1-octeon&#x7684;pci-probe&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#a1-octeon&#x7684;pci-probe&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>5.1.1. A1. octeon&#x7684;pci probe&#x51FD;&#x6570;</h3>
<p><code>components/driver/host/driver/linux/octeon_main.c</code></p>
<pre class="language-"><code class="lang-c"><span class="token function">octeon_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token operator">*</span>pdev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pci_device_id</span> <span class="token operator">*</span>ent<span class="token punctuation">)</span>
    <span class="token comment">//&#x9996;&#x5148;&#x8981;hold&#x4E00;&#x4E2A;octeon_device_t, &#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;</span>
    <span class="token class-name">octeon_device_t</span>  <span class="token operator">*</span>oct_dev<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">/*&#x8FD9;&#x91CC;&#x5148;&#x6253;&#x5370;(uint32_t)pdev-&gt;vendor, (uint32_t)pdev-&gt;device
    **&#x8FD9;&#x662F;linux&#x9A71;&#x52A8;core&#x5C42;&#x5339;&#x914D;&#x597D;pci&#x8BBE;&#x5907;&#x540E;&#x4F20;&#x5165;&#x7684;
    **&#x5982;&#x679C;&#x8981;&#x6539;&#x4E3A;&#x7528;&#x6237;&#x6001;,&#x53C2;&#x8003;remote-pci&#x7684;&#x65B9;&#x5F0F;&#x627E;octeon&#x8BBE;&#x5907;
    */</span>
    <span class="token comment">/*&#x7533;&#x8BF7;&#x5168;&#x5C40;&#x53D8;&#x91CF;octeon_device[4]&#x7684;&#x5185;&#x5B58;
    **&#x8FD9;&#x662F;&#x4E2A;osi&#x7684;&#x63A5;&#x53E3;, &#x4F46;&#x6700;&#x540E;&#x600E;&#x4E48;&#x8C03;&#x5230;linux&#x7684;?&#x89C1;A11
    oct_dev = octeon_allocate_device(pdev-&gt;device);
        oct = octeon_allocate_device_mem(pci_id);
            /*&#x5B9E;&#x9645;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x5305;&#x62EC; 
            **&#x4E3B;&#x7ED3;&#x6784;&#x4F53;:sizeof(octeon_device_t)+&#x89C1;&#x7ED3;&#x6784;&#x4F53;:sizeof(octeon_cn6xxx_t)+&#x89C1;&#x7ED3;&#x6784;&#x4F53;J:sizeof(octeon_dispatch_t)*64
            **&#x53EF;&#x80FD;&#x662F;&#x4E3A;&#x4E86;&#x7701;&#x4E8B;, &#x628A;&#x5185;&#x5B58;&#x4E00;&#x6B21;&#x5168;&#x90E8;&#x7533;&#x8BF7;&#x4E86;, &#x540E;&#x9762;&#x4E5F;&#x4F1A;&#x5206;&#x5F00;&#x7528;
            */</span>
            <span class="token comment">//&#x8FD9;&#x91CC;&#x600E;&#x4E48;&#x505A;&#x5230;osi&#x7684;?&#x89C1;A11</span>
            buf  <span class="token operator">=</span> <span class="token function">cavium_alloc_virt</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x865A;&#x62DF;&#x5730;&#x5740;</span>
            oct        <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_device_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>
            oct<span class="token operator">-&gt;</span>chip  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> octdevsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            oct<span class="token operator">-&gt;</span>dispatch<span class="token punctuation">.</span>dlist <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_dispatch_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> octdevsize <span class="token operator">+</span> configsize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x89C1;A18&#x91CC;&#x9762;&#x7684;&#x4F7F;&#x7528;</span>
        octeon_device<span class="token punctuation">[</span>oct_idx<span class="token punctuation">]</span> <span class="token operator">=</span> oct<span class="token punctuation">;</span>
        <span class="token comment">//&#x4E0D;&#x540C;&#x7684;octeon&#x7684;name&#x4E0D;&#x4E00;&#x6837;, &quot;Octeon%d&quot;</span>
    <span class="token comment">//&#x628A;oct_dev&#x5F53;&#x4F5C;&#x9A71;&#x52A8;&#x7684;priv&#x6210;&#x5458;</span>
    <span class="token function">pci_set_drvdata</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> oct_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x53CD;&#x8FC7;&#x6765;&#x6307;</span>
    oct_dev<span class="token operator">-&gt;</span>pci_dev <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pdev<span class="token punctuation">;</span>
    <span class="token comment">//&#x5177;&#x4F53;&#x786C;&#x4EF6;&#x8981;&#x5728;&#x8FD9;&#x91CC;&#x914D;?</span>
    <span class="token function">octeon_device_init</span><span class="token punctuation">(</span>oct_dev<span class="token punctuation">)</span>
        <span class="token comment">/*&#x8FD9;&#x91CC;&#x9762;&#x6709;&#x4E2A;&#x51FD;&#x6570;&#x6307;&#x9488;, &#x539F;&#x578B;&#x662F;
        **typedef   oct_poll_fn_status_t (* octeon_poll_fn_t)(void *, unsigned long);
        */</span>
        <span class="token class-name">octeon_poll_ops_t</span>   poll_ops<span class="token punctuation">;</span>
        <span class="token comment">//&#x8FD9;&#x91CC;&#x9762;&#x4E00;&#x5171;&#x505A;&#x4E86;&#x4E09;&#x4EF6;&#x4E8B;, &#x5728;pci-remote&#x91CC;&#x9762;&#x6709;&#x5BF9;&#x5E94;&#x7684;</span>
        <span class="token function">octeon_pci_os_setup</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span>
            <span class="token function">pci_enable_device</span><span class="token punctuation">(</span>octeon_dev<span class="token operator">-&gt;</span>pci_dev<span class="token punctuation">)</span>
            <span class="token comment">//&#x4F7F;&#x80FD;64bit&#x8BBF;&#x95EE;, dev&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;64bit host&#x7A7A;&#x95F4;?</span>
            <span class="token function">pci_set_dma_mask</span><span class="token punctuation">(</span>octeon_dev<span class="token operator">-&gt;</span>pci_dev<span class="token punctuation">,</span> PCI_DMA_64BIT<span class="token punctuation">)</span>
            <span class="token comment">//&#x4F7F;&#x80FD;device&#x7684;master&#x4F4D;</span>
            <span class="token function">pci_set_master</span><span class="token punctuation">(</span>octeon_dev<span class="token operator">-&gt;</span>pci_dev<span class="token punctuation">)</span>
        <span class="token comment">//&#x4F7F;&#x7528;&#x9A71;&#x52A8;&#x51FD;&#x6570;pci_read_config_dword&#x6765;&#x83B7;&#x5F97;ID,&#x5E76;&#x8C03;&#x7528;&#x76F8;&#x5E94;&#x51FD;&#x6570;</span>
        <span class="token function">octeon_chip_specific_setup</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span>
            <span class="token keyword">case</span> OCTEON_CN66XX_PCIID<span class="token operator">:</span>
                <span class="token comment">/*&#x8BBE;&#x7F6E;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;:C
                **&#x7528;&#x6765;&#x9002;&#x914D;&#x4E0D;&#x540C;&#x578B;&#x53F7;&#x7684;octeon&#x7684;&#x94A9;&#x5B50;&#x51FD;&#x6570;
                **&#x8FD9;&#x4E9B;&#x51FD;&#x6570;&#x662F;&#x548C;&#x786C;&#x4EF6;&#x6700;&#x76F8;&#x5173;&#x7684;&#x64CD;&#x4F5C;, &#x5BC4;&#x5B58;&#x5668;&#x548C;&#x4E2D;&#x65AD;
                **&#x6CE8;&#x610F;&#x8FD9;&#x662F;&#x4E2A;osi&#x7684;&#x51FD;&#x6570;
                **&#x51FD;&#x6570;&#x5B9E;&#x73B0;&#x5728;components/driver/host/driver/osi/cn6xxx_common.c
                */</span>
                <span class="token function">setup_cn66xx_octeon_device</span><span class="token punctuation">(</span>oct<span class="token punctuation">)</span>
                    <span class="token comment">//&#x5176;&#x5B9E;chip&#x662F;&#x4E2A;void*, &#x8FD8;&#x8BB0;&#x5F97;&#x524D;&#x9762;&#x591A;&#x7533;&#x8BF7;&#x7684;size&#x5417;? sizeof(octeon_cn6xxx_t)</span>
                    <span class="token class-name">octeon_cn6xxx_t</span> <span class="token operator">*</span>cn6xxx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_cn6xxx_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>oct<span class="token operator">-&gt;</span>chip<span class="token punctuation">;</span>
                    <span class="token comment">//map bar0&#x5730;&#x5740;&#x5230;oct-&gt;mmio[0].start</span>
                    <span class="token function">octeon_map_pci_barx</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token comment">//reserve&#x8D44;&#x6E90;</span>
                        <span class="token function">pci_request_region</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>pci_dev<span class="token punctuation">,</span> baridx<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span> DRIVER_NAME<span class="token punctuation">)</span>
                           oct<span class="token operator">-&gt;</span>mmio<span class="token punctuation">[</span>baridx<span class="token punctuation">]</span><span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token function">pci_resource_start</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>pci_dev<span class="token punctuation">,</span> baridx<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                           oct<span class="token operator">-&gt;</span>mmio<span class="token punctuation">[</span>baridx<span class="token punctuation">]</span><span class="token punctuation">.</span>len   <span class="token operator">=</span> <span class="token function">pci_resource_len</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>pci_dev<span class="token punctuation">,</span> baridx<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//&#x5730;&#x5740;&#x9700;&#x8981;ioremap?, &#x628A;&#x8C03;&#x8BD5;&#x6253;&#x5370;&#x6253;&#x5F00;!</span>
                        oct<span class="token operator">-&gt;</span>mmio<span class="token punctuation">[</span>baridx<span class="token punctuation">]</span><span class="token punctuation">.</span>hw_addr    <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>mmio<span class="token punctuation">[</span>baridx<span class="token punctuation">]</span><span class="token punctuation">.</span>start<span class="token punctuation">,</span> mapped_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//map bar1</span>
                    <span class="token function">octeon_map_pci_barx</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MAX_BAR1_IOREMAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    cn6xxx<span class="token operator">-&gt;</span>conf  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">cn6xxx_config_t</span>  <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">oct_get_config_info</span><span class="token punctuation">(</span>oct<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">/*&#x806A;&#x660E;!&#x6839;&#x636E;chip id, &#x76F4;&#x63A5;&#x8D4B;&#x503C;&#x914D;&#x7F6E;&#x8868;
                        **&#x6240;&#x6709;&#x7684;&#x914D;&#x7F6E;&#x8868;&#x5728;components/driver/host/include/oct_config_data.h
                        **&#x8FD9;&#x91CC;&#x6309;&#x7167;octeon_cn6xxx_t&#x6765;&#x914D;&#x7684;, &#x89C1;A12
                        */</span>
                        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>default_cn66xx_conf<span class="token punctuation">;</span>
                    <span class="token comment">/*&#x8BBE;&#x7F6E;oct-&gt;fn_list
                    **&#x5305;&#x62EC;setup_iq_regs setup_oq_regs setup_device_regs update_iq_read_idx
                    **bar1_idx_setup bar1_idx_write     
                    **interrupt_handler enable_interrupt enable_io_queues
                    **&#x7B49;&#x7B49;, &#x8BE6;&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;:C
                    **&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;cn6xxx_interrupt_handler&#x89C1;&#x4E0B;:&#x4E2D;&#x65AD;&#x5904;&#x7406;
                    */</span>
                    <span class="token comment">//&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x8BBE;&#x7F6E;bar0&#x7684;window&#x5BC4;&#x5B58;&#x5668;&#x76F8;&#x5173;&#x7684;&#x5730;&#x5740;</span>
                    <span class="token function">cn6xxx_setup_reg_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//map&#x5B8C;&#x6210;&#x4E86;, &#x914D;&#x7F6E;&#x4E5F;&#x5B8C;&#x6210;&#x4E86;, &#x4F46;&#x8FD8;&#x6CA1;&#x6709;&#x5199;&#x8FDB;&#x53BB;</span>
        <span class="token function">cavium_atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>status<span class="token punctuation">,</span> OCT_DEV_PCI_MAP_DONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x5148;&#x590D;&#x4F4D;&#x4E00;&#x4E0B;</span>
        octeon_dev<span class="token operator">-&gt;</span>fn_list<span class="token punctuation">.</span><span class="token function">soft_reset</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span>
        <span class="token comment">//&#x6E05;&#x7A7A;dispatch&#x94FE;&#x8868;</span>
        <span class="token function">octeon_init_dispatch_list</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span>
        <span class="token comment">//&#x521D;&#x59CB;&#x5316;poll fn list&#x5230;oct-&gt;poll_list, &#x91CC;&#x9762;&#x5171;64&#x4E2A;poll&#x51FD;&#x6570;</span>
        <span class="token function">octeon_setup_poll_fn_list</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*&#x6CE8;&#x518C;&#x4E00;&#x4E2A;&#x9A71;&#x52A8;&#x81EA;&#x5DF1;&#x7528;&#x7684;poll_ops:&quot;Module Starter&quot; 
        **&#x51FD;&#x6570;&#x662F;oct_poll_module_starter, 1&#x79D2;&#x4E00;&#x6B21;, &#x89C1;A13
        **&#x6CE8;&#x518C;&#x5230;&#x4E0A;&#x9762;&#x7684;oct-&gt;poll_list
        */</span>
        <span class="token function">octeon_register_poll_fn</span><span class="token punctuation">(</span>octeon_dev<span class="token operator">-&gt;</span>octeon_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>poll_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x81F3;&#x6B64;&#x521D;&#x59CB;&#x5316;&#x5B8C;&#x6210;? &#x4F46;&#x6CA1;&#x6709;&#x5199;&#x4EFB;&#x4F55;&#x7684;octeon&#x7684;&#x5BC4;&#x5B58;&#x5668;???</span>
        <span class="token function">cavium_atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>status<span class="token punctuation">,</span> OCT_DEV_DISPATCH_INIT_DONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x5982;&#x679C;&#x4F7F;&#x80FD;&#x4E86;buffer pool(USE_BUFFER_POOL), &#x641C;&#x7D22;&#x5173;&#x952E;&#x5B57;: HUGE_BUFFER_CHUNKS</span>
        <span class="token comment">/*&#x6CE8;&#x610F;&#x8FD9;&#x4E5F;&#x662F;&#x4E2A;osi&#x7684;&#x51FD;&#x6570;
        **&#x57FA;&#x672C;&#x4E0A;&#x662F;&#x8C03;&#x7528;cavium_malloc_dma&#x6765;&#x9884;&#x5148;&#x5206;&#x914D;&#x5185;&#x5B58;, &#x6309;size&#x5927;&#x5C0F;&#x5206;&#x4E3A;6&#x7C7B;,32k,16k,&#x4F9D;&#x6B21;
        **&#x6700;&#x540E;&#x662F;&#x8C03;&#x7528;kmalloc ----&#x9700;&#x8981;&#x9002;&#x914D;
        **&#x9ED8;&#x8BA4;&#x662F;&#x5173;&#x95ED;&#x7684;, ----&#x6211;&#x51C6;&#x5907;&#x6253;&#x5F00;&#x8FD9;&#x4E2A;&#x529F;&#x80FD;
        **&#x4F46;&#x4ECE;get_buffer_from_pool()&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6765;&#x770B;,&#x4E0D;&#x80FD;&#x628A;&#x8981;&#x7533;&#x8BF7;&#x7684;size&#x5206;&#x7247;
        **&#x6BD4;&#x5982;&#x8D85;&#x8FC7;&#x6BD4;&#x5982;32K, &#x5219;&#x4F1A;&#x8C03;&#x7528;cavium_malloc_dma&#x5206;&#x914D;&#x5185;&#x5B58;
        **&#x4E5F;&#x5C31;&#x662F;&#x8BF4;, &#x8FD9;&#x4E2A;&#x9A71;&#x52A8;&#x91CC;&#x9762;&#x7684;packet&#x90FD;&#x662F;&#x5047;&#x5B9A;&#x7269;&#x7406;&#x5185;&#x5B58;&#x8FDE;&#x7EED;&#x7684; ----&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x8981;&#x89E3;&#x51B3;--&#x8981;&#x7ED3;&#x5408;&#x540E;&#x9762;&#x7684;pci_map_single()
        */</span>
        <span class="token function">octeon_init_buffer_pool</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bufpool_config<span class="token punctuation">)</span>
        <span class="token comment">//&#x5148;&#x5173;&#x95ED;input ring&#x548C;output ring</span>
        <span class="token function">octeon_set_io_queues_off</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x521D;&#x59CB;&#x5316;input ring</span>
        <span class="token function">octeon_setup_instr_queues</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span>
            <span class="token comment">//&#x5BF9;32&#x4E2A;ring, &#x6216;&#x8005;&#x8BF4;queue</span>
                <span class="token comment">//&#x6CE8;&#x610F;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x4E0D;&#x9700;&#x8981;&#x7269;&#x7406;&#x5730;&#x5740;&#x8FDE;&#x7EED;, &#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;D</span>
                oct<span class="token operator">-&gt;</span>instr_queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cavium_alloc_virt</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">octeon_instr_queue_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//&#x8FD9;&#x91CC;&#x624D;&#x662F;&#x771F;&#x6B63;&#x7684;input ring&#x7684;&#x5185;&#x5B58;&#x7533;&#x8BF7;&#x7684;&#x5730;&#x65B9;</span>
                <span class="token function">octeon_init_instr_queue</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
                    iq <span class="token operator">=</span> oct<span class="token operator">-&gt;</span>instr_queue<span class="token punctuation">[</span>iq_no<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    q_size <span class="token operator">=</span> conf<span class="token operator">-&gt;</span>instr_type <span class="token operator">*</span> conf<span class="token operator">-&gt;</span>num_descs<span class="token punctuation">;</span> <span class="token comment">//&#x8FD9;&#x4E2A;input queue&#x7684;&#x6DF1;&#x5EA6;</span>
                    <span class="token comment">//&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5E95;&#x5C42;&#x662F;&#x8C03;&#x7528;linux&#x5185;&#x6838;&#x7684;pci_alloc_consistent ----&#x60F3;&#x597D;&#x600E;&#x4E48;&#x66FF;&#x4EE3;&#x4E86;&#x5417;? &#x8981;&#x4FDD;&#x8BC1;&#x786C;&#x4EF6;&#x548C;&#x8F6F;&#x4EF6;&#x770B;&#x5230;&#x7684;&#x4E1C;&#x897F;&#x540C;&#x6B65;&#x54E6;!</span>
                    iq<span class="token operator">-&gt;</span>base_addr <span class="token operator">=</span> <span class="token function">octeon_pci_alloc_consistent</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>pci_dev<span class="token punctuation">,</span> q_size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>iq<span class="token operator">-&gt;</span>base_addr_dma<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x89C1;A141, DMA&#x5185;&#x5B58;</span>
                    <span class="token comment">//no response list, &#x7533;&#x8BF7;&#x865A;&#x62DF;&#x8FDE;&#x7EED;&#x7684;&#x5185;&#x5B58;, &#x662F;&#x7ED3;&#x6784;&#x4F53;D&#x91CC;&#x9762;&#x7684;&#x4E00;&#x4E2A;&#x6210;&#x5458;</span>
                    <span class="token function">octeon_init_nr_free_list</span><span class="token punctuation">(</span>iq<span class="token punctuation">,</span> iq<span class="token operator">-&gt;</span>max_count<span class="token punctuation">)</span>
                    <span class="token comment">//&#x547D;&#x4EE4;&#x5B57;&#x7684;32bit&#x6216;64bit&#x662F;&#x6839;&#x636E;&#x914D;&#x7F6E;&#x6765;&#x7684;</span>
                    <span class="token comment">//&#x771F;&#x6B63;&#x5F00;&#x59CB;&#x5E72;&#x6D3B;, &#x8C03;&#x7528;&#x94A9;&#x5B50;&#x51FD;&#x6570;&#x8BBE;&#x7F6E;iput ring</span>
                    oct<span class="token operator">-&gt;</span>fn_list<span class="token punctuation">.</span><span class="token function">setup_iq_regs</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> iq_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//&#x6CE8;&#x518C;poll&#x51FD;&#x6570; check_db_timeout, &quot;Doorbell Timeout&quot;, &#x5468;&#x671F;1&#x4E2A;tick??&#x4F1A;&#x4E0D;&#x4F1A;&#x592A;&#x5FEB;&#x4E86;?&#x89C1;A14</span>
                    <span class="token function">octeon_register_poll_fn</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>octeon_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>poll_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x5230;&#x8FD9;&#x91CC;input ring&#x5B8C;&#x5DE5;</span>
        <span class="token function">cavium_atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>status<span class="token punctuation">,</span> OCT_DEV_INSTR_QUEUE_INIT_DONE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//pending list&#x662F;&#x7528;&#x6765;&#x5904;&#x7406;&#x9700;&#x8981;response&#x7684;request&#x7684;, &#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;E, &#x5F88;&#x9738;&#x9053;&#x7684;&#x90A3;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;</span>
        <span class="token function">octeon_init_pending_list</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span>
            <span class="token comment">//count&#x662F;&#x4ECE;&#x90A3;&#x4E2A;&#x914D;&#x7F6E;&#x8868;&#x91CC;&#x6765;&#x7684;</span>
            count <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">CHIP_FIELD</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> cn6xxx<span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>c<span class="token punctuation">.</span>pending_list_size<span class="token punctuation">;</span>
            oct<span class="token operator">-&gt;</span>pend_list_size <span class="token operator">=</span> count<span class="token punctuation">;</span>
            <span class="token comment">//&#x7ED9;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;E&#x5206;&#x914D;&#x7A7A;&#x95F4;, &#x865A;&#x62DF;&#x5730;&#x5740;&#x8FDE;&#x7EED;&#x5C31;&#x884C;</span>
            oct<span class="token operator">-&gt;</span>plist <span class="token operator">=</span> <span class="token function">cavium_alloc_virt</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">octeon_pending_list_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//&#x8FD9;&#x4E2A;list&#x662F;E1,&#x662F;&#x4E2A;&#x94FE;&#x8868;, &#x6709;count&#x4E2A;node</span>
            oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_pending_entry_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">cavium_alloc_virt</span><span class="token punctuation">(</span>OCT_PENDING_ENTRY_SIZE <span class="token operator">*</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//free_list&#x662F;&#x4E2A;&#x6570;&#x7EC4;, &#x6709;count&#x4E2A;uint32</span>
            oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>free_list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">cavium_alloc_virt</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span> <span class="token operator">*</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>entries <span class="token operator">=</span> count<span class="token punctuation">;</span>
        <span class="token function">cavium_atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>status<span class="token punctuation">,</span> OCT_DEV_PEND_LIST_INIT_DONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x73B0;&#x5728;&#x662F;&#x5E94;&#x7B54;&#x94FE;&#x8868;</span>
        <span class="token function">octeon_setup_response_list</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span>
            <span class="token comment">//&#x5BF9;&#x4E09;&#x79CD;&#x7C7B;&#x578B;, &#x521D;&#x59CB;&#x5316;&#x94FE;&#x8868;&#x5934;, &#x5B9E;&#x9645;&#x4E0A;, &#x4EE5;&#x4E0B;&#x4E09;&#x7C7B;&#x7684;response, &#x7531;&#x94FE;&#x8868;&#x5934;&#x5F15;&#x9886;</span>
            <span class="token comment">//1 ordered, 1 unordered-blocking, 1 unordered-nonblocking</span>
            <span class="token comment">//&#x5BF9;&#x5168;&#x5C40;&#x53D8;&#x91CF;noresp_buf_free_fn&#x8D4B;NULL, &#x8FD9;&#x662F;&#x4E2A;&#x51FD;&#x6570;&#x6307;&#x9488;&#x7684;&#x4E8C;&#x7EF4;&#x6570;&#x7EC4;</span>
            noresp_buf_free_fn<span class="token punctuation">[</span>oct<span class="token operator">-&gt;</span>octeon_id<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token comment">//&#x6CE8;&#x518C;poll&#x51FD;&#x6570;, oct_poll_req_completion, 1&#x4E2A;tick, &#x89C1;A15</span>
            ret <span class="token operator">=</span> <span class="token function">octeon_register_poll_fn</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>octeon_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>poll_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//&#x6CE8;&#x610F;: &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x88AB;&#x6CE8;&#x91CA;&#x6389;&#x4E86;! &#x6CE8;&#x518C;poll&#x51FD;&#x6570;, oct_poll_check_unordered_list, &#x4E00;&#x79D2;10&#x6B21;, &#x89C1;A16</span>
            <span class="token comment">/*ret = octeon_register_poll_fn(oct-&gt;octeon_id, &amp;poll_ops);*/</span>

        <span class="token function">cavium_atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>status<span class="token punctuation">,</span> OCT_DEV_RESP_LIST_INIT_DONE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//&#x5F00;&#x59CB;&#x521D;&#x59CB;&#x5316;output queue, &#x4E5F;&#x53EB;dpoq?</span>
        <span class="token function">octeon_setup_output_queues</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span>
            <span class="token comment">//&#x7ED9;32&#x4E2A;droq&#x5206;&#x914D;&#x7A7A;&#x95F4;</span>
            <span class="token keyword">for</span> <span class="token number">32</span>&#x4E2A;
                <span class="token comment">//droq&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;G</span>
                oct<span class="token operator">-&gt;</span>droq<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cavium_alloc_virt</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">octeon_droq_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">octeon_init_droq</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
                    <span class="token comment">//&#x5148;&#x4ECE;config&#x8868;&#x4E2D;&#x67E5;&#x914D;&#x7F6E;&#x4FE1;&#x606F;</span>
                    <span class="token comment">//&#x7136;&#x540E;&#x7ED9;&#x771F;&#x6B63;&#x7684;&#x786C;&#x4EF6;output ring&#x5206;&#x914D;&#x7A7A;&#x95F4;</span>
                    <span class="token comment">//&#x5FC5;&#x987B;&#x6CE8;&#x610F;&#x4EE5;&#x4E0B;&#x7684;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x7684;&#x51FD;&#x6570;</span>
                    droq<span class="token operator">-&gt;</span>desc_ring <span class="token operator">=</span> <span class="token function">octeon_pci_alloc_consistent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//DMA&#x5185;&#x5B58;</span>
                    <span class="token comment">//&#x5E95;&#x4E0B;&#x8C03;&#x7528;__get_free_pages(),8&#x5B57;&#x8282;&#x5BF9;&#x9F50;</span>
                    droq<span class="token operator">-&gt;</span>info_list <span class="token operator">=</span> <span class="token function">cavium_alloc_aligned_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x9875;?</span>
                    droq<span class="token operator">-&gt;</span>recv_buf_list <span class="token operator">=</span> <span class="token function">cavium_alloc_virt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;G5</span>

                    <span class="token function">octeon_droq_setup_ring_buffers</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> droq<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment">//A1i1. &#x5BF9;&#x6BCF;&#x4E2A;&#x63CF;&#x8FF0;&#x7B26;, &#x7533;&#x8BF7;buffer, &#x771F;&#x6B63;&#x548C;octeon&#x786C;&#x4EF6;&#x5BF9;&#x5E94;&#x7684;buffer, &#x53E6;&#x5916;&#x4E00;&#x5904;&#x5728;refill, &#x89C1;A17</span>
                        <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> droq<span class="token operator">-&gt;</span>max_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                            <span class="token comment">//&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x7684;get_new_recv_buffer&#x662F;osi&#x7684;, &#x4F46;&#x5B9E;&#x73B0;&#x662F;linux&#x7684;skbuf&#xFF1B; &#x8FD9;&#x91CC;&#x5C31;&#x5DF2;&#x7ECF;&#x628A;&#x6536;&#x5305;bufer&#x7533;&#x8BF7;&#x597D;&#x4E86;</span>
                            buf <span class="token operator">=</span> <span class="token function">get_new_recv_buffer</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x7528;skb&#x7533;&#x8BF7;buffer?&#x4E3A;&#x4EC0;&#x4E48;?</span>
                            <span class="token comment">//recv_buf_list&#x662F;&#x4E2A;G5&#x7684;&#x6570;&#x7EC4;</span>
                            droq<span class="token operator">-&gt;</span>recv_buf_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer  <span class="token operator">=</span> buf<span class="token punctuation">;</span>
                            droq<span class="token operator">-&gt;</span>recv_buf_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data    <span class="token operator">=</span> <span class="token function">get_recv_buffer_data</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//&#x4E0B;&#x9762;&#x5173;&#x952E;&#x662F;, &#x7B80;&#x5199;, &#x5B9E;&#x9645;&#x4E0A;&#x7528;octeon_pci_map_single&#x8F6C;&#x4E3A;IOMMU&#x5730;&#x5740;, &#x8BF4;&#x660E;&#x4E5F;&#x662F;DMA&#x5185;&#x5B58;</span>
                            desc_ring<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>info_ptr   <span class="token operator">=</span> <span class="token function">octeon_pci_map_single</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>info_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
                            desc_ring<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer_ptr <span class="token operator">=</span> <span class="token function">octeon_pci_map_single</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>recv_buf_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
                        <span class="token function">octeon_droq_reset_indices</span><span class="token punctuation">(</span>droq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            droq<span class="token operator">-&gt;</span>host_read_index     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                            droq<span class="token operator">-&gt;</span>octeon_write_index  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                            droq<span class="token operator">-&gt;</span>host_refill_index   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                            droq<span class="token operator">-&gt;</span>refill_count        <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                            <span class="token function">cavium_atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>pkts_pending<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//&#x8C03;&#x7528;&#x771F;&#x6B63;&#x7684;&#x8BBE;&#x786C;&#x4EF6;&#x7684;&#x51FD;&#x6570;</span>
                    oct<span class="token operator">-&gt;</span>fn_list<span class="token punctuation">.</span><span class="token function">setup_oq_regs</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> q_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    poll_ops<span class="token punctuation">.</span>fn     <span class="token operator">=</span> check_droq_refill<span class="token punctuation">;</span>
                    <span class="token comment">//&#x6CE8;&#x518C;check_droq_refill&#x51FD;&#x6570;, &#x89C1;A17, &#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;</span>
                    <span class="token function">octeon_register_poll_fn</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>octeon_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>poll_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//&#x5982;&#x679C;&#x6253;&#x5F00;&#x4E86;USE_DROQ_THREADS, &#x4F46;&#x597D;&#x50CF;&#x6CA1;&#x5F00;, &#x6536;&#x5305;&#x5185;&#x6838;&#x7EBF;&#x7A0B;</span>
                    <span class="token function">cavium_init_wait_channel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>wc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x5E95;&#x4E0B;&#x662F;init_waitqueue_head()</span>
                    <span class="token comment">//droq&#x5185;&#x6838;&#x7EBF;&#x7A0B;, &#x8FD0;&#x884C;oct_droq_thread, &#x89C1;A18, &#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;</span>
                    <span class="token function">cavium_kthread_setup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>thread<span class="token punctuation">,</span> oct_droq_thread<span class="token punctuation">,</span> droq<span class="token punctuation">,</span><span class="token string">&quot;Oct DROQ Thread&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token function">cavium_kthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>thread<span class="token punctuation">)</span> <span class="token comment">//&#x5E95;&#x4E0B;&#x662F;kthread_create()</span>
                    <span class="token comment">//&#x7ED1;&#x5B9A;&#x5230;cpu, q&#x548C;cpu&#x4E2A;&#x6570;&#x6C42;&#x4F59;droq-&gt;q_no % cavium_get_cpu_count()</span>
                    <span class="token function">cavium_kthread_set_cpu_affinity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x5E95;&#x4E0B;&#x662F;kthread_bind()</span>
                    <span class="token function">cavium_kthread_run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x5E95;&#x4E0B;&#x662F;wake_up_process()</span>
        <span class="token comment">//&#x81F3;&#x6B64;output q&#x521D;&#x59CB;&#x5316;&#x7ED3;&#x675F;</span>
        <span class="token function">cavium_atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>status<span class="token punctuation">,</span> OCT_DEV_DROQ_INIT_DONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x6839;&#x636E;&#x6CE8;&#x91CA;, &#x8C03;&#x7528;&#x5176;&#x4ED6;&#x7684;device&#x76F8;&#x5173;&#x7684;&#x521D;&#x59CB;&#x5316;&#x5BC4;&#x5B58;&#x5668;&#x51FD;&#x6570;</span>
        ret <span class="token operator">=</span> octeon_dev<span class="token operator">-&gt;</span>fn_list<span class="token punctuation">.</span><span class="token function">setup_device_regs</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x8FD9;&#x90E8;&#x5206;&#x6CE8;&#x518C;/proc/octeon</span>
        <span class="token function">cavium_init_proc</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            root <span class="token operator">=</span> <span class="token function">proc_mkdir</span><span class="token punctuation">(</span>octeon_dev<span class="token operator">-&gt;</span>device_name<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            octeon_dev<span class="token operator">-&gt;</span>proc_root_dir <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>root<span class="token punctuation">;</span>
            node <span class="token operator">=</span> <span class="token function">create_proc_entry</span><span class="token punctuation">(</span><span class="token string">&quot;debug_level&quot;</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
            node<span class="token operator">-&gt;</span>read_proc <span class="token operator">=</span> proc_read_debug_level<span class="token punctuation">;</span>
            node<span class="token operator">-&gt;</span>write_proc <span class="token operator">=</span> proc_write_debug_level<span class="token punctuation">;</span>
            <span class="token comment">//&#x8FD9;&#x91CC;&#x9762;&#x7684;create_proc_read_entry()&#x5728;&#x65B0;&#x7684;&#x5185;&#x6838;&#x91CC;&#x5E94;&#x8BE5;&#x662F;proc_create_data() and seq_file</span>
            node <span class="token operator">=</span> <span class="token function">create_proc_read_entry</span><span class="token punctuation">(</span><span class="token string">&quot;stats&quot;</span><span class="token punctuation">,</span><span class="token number">0444</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> proc_read_stats<span class="token punctuation">,</span>octeon_dev<span class="token punctuation">)</span>
            <span class="token comment">//&#x7C7B;&#x4F3C;&#x7684;, &#x521B;&#x5EFA;&quot;configreg&quot; &quot;csrreg&quot; &quot;npireg&quot;, &#x6302;&#x7684;&#x662F;&#x4E0D;&#x540C;&#x7684;&#x8BFB;&#x5199;&#x51FD;&#x6570;</span>

        <span class="token comment">//&#x5982;&#x679C;&#x6CA1;&#x6709;&#x6253;&#x5F00;USE_DROQ_THREADS, &#x5219;&#x7528;tasklet&#x6765;&#x5904;&#x7406;output q, &#x9ED8;&#x8BA4;&#x662F;&#x8D70;&#x8FD9;</span>
        <span class="token comment">//octeon_droq_bh&#x89C1;A19, &#x7531;&#x4E2D;&#x65AD;&#x89E6;&#x53D1;, &#x89C1;&#x4E2D;&#x65AD;&#x5904;&#x7406;</span>
        <span class="token function">cavium_tasklet_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>droq_tasklet<span class="token punctuation">,</span> octeon_droq_bh<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>octeon_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//comp_tasklet&#x7528;&#x6765;&#x52A0;&#x901F;ORDERED&#x7684;&#x8BF7;&#x6C42;&#x7684;&#x5904;&#x7406;, &#x8FD9;&#x4E2A;&#x4E0B;&#x534A;&#x90E8;&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x662F;&#x8C03;&#x7528;process_ordered_list(), &#x53EF;&#x4EE5;&#x53C2;&#x8003;A15</span>
        <span class="token function">cavium_tasklet_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>comp_tasklet<span class="token punctuation">,</span> octeon_request_completion_bh<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>octeon_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x6CE8;&#x518C;PCIE&#x4E2D;&#x65AD;, &#x89C1;&#x4E2D;&#x65AD;&#x5904;&#x7406;</span>
        <span class="token function">octeon_setup_interrupt</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//&#x6253;&#x5F00;msi&#x4E2D;&#x65AD;</span>
            <span class="token function">pci_enable_msi</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>pci_dev<span class="token punctuation">)</span>
            irqret <span class="token operator">=</span> <span class="token function">request_irq</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>pci_dev<span class="token operator">-&gt;</span>irq<span class="token punctuation">,</span> octeon_intr_handler<span class="token punctuation">,</span> CVM_SHARED_INTR<span class="token punctuation">,</span> <span class="token string">&quot;octeon&quot;</span><span class="token punctuation">,</span> oct<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x73B0;&#x5728;&#x5F00;&#x59CB;&#x4F7F;&#x80FD;&#x4E2D;&#x65AD;</span>
           octeon_dev<span class="token operator">-&gt;</span>fn_list<span class="token punctuation">.</span><span class="token function">enable_interrupt</span><span class="token punctuation">(</span>octeon_dev<span class="token operator">-&gt;</span>chip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x4F7F;&#x80FD;input output q</span>
        octeon_dev<span class="token operator">-&gt;</span>fn_list<span class="token punctuation">.</span><span class="token function">enable_io_queues</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//send credit&#x662F;&#x4EC0;&#x4E48;&#x610F;&#x601D;?</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> octeon_dev<span class="token operator">-&gt;</span>num_oqs<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>  
            <span class="token function">OCTEON_WRITE32</span><span class="token punctuation">(</span>octeon_dev<span class="token operator">-&gt;</span>droq<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">-&gt;</span>pkts_credit_reg<span class="token punctuation">,</span> octeon_dev<span class="token operator">-&gt;</span>droq<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">-&gt;</span>max_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Packets can start arriving on the output queues from this point. */</span>
        octeon_dev<span class="token operator">-&gt;</span>app_mode <span class="token operator">=</span> CVM_DRV_INVALID_APP<span class="token punctuation">;</span>
        <span class="token function">cavium_atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>status<span class="token punctuation">,</span> OCT_DEV_HOST_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x6CE8;&#x518C;dispath&#x51FD;&#x6570;, &#x89C1;A181</span>
    <span class="token function">octeon_setup_driver_dispatches</span><span class="token punctuation">(</span>oct_dev<span class="token operator">-&gt;</span>octeon_id<span class="token punctuation">)</span>
    <span class="token comment">//&#x8981;&#x6C42;oct_dev-&gt;app_mode&#x4E0D;&#x662F;CVM_DRV_BASE_APP&#x6216;CVM_DRV_INVALID_APP</span>
    <span class="token function">octeon_start_module</span><span class="token punctuation">(</span>oct_dev<span class="token operator">-&gt;</span>app_mode<span class="token punctuation">,</span> oct_dev<span class="token operator">-&gt;</span>octeon_id<span class="token punctuation">)</span>
        <span class="token comment">//&#x91CC;&#x9762;&#x8C03;&#x7684;&#x51FD;&#x6570;&#x662F;octeon_register_module_handler()&#x6CE8;&#x518C;&#x7684;</span>
        <span class="token function">__octeon_module_action</span><span class="token punctuation">(</span>app_type<span class="token punctuation">,</span> OCTEON_START_MODULE<span class="token punctuation">,</span> octeon_id<span class="token punctuation">)</span>
    octeon_state <span class="token operator">=</span> OCT_DRV_ACTIVE<span class="token punctuation">;</span>
</code></pre>
<h4 id="a11-&#x5982;&#x4F55;osi-&#x5230;&#x5E95;&#x54EA;&#x4E9B;&#x662F;osi&#x7684;-&#x54EA;&#x4E9B;&#x53C8;&#x4E0D;&#x662F;"><a name="a11-&#x5982;&#x4F55;osi-&#x5230;&#x5E95;&#x54EA;&#x4E9B;&#x662F;osi&#x7684;-&#x54EA;&#x4E9B;&#x53C8;&#x4E0D;&#x662F;" class="anchor-navigation-ex-anchor" href="#a11-&#x5982;&#x4F55;osi-&#x5230;&#x5E95;&#x54EA;&#x4E9B;&#x662F;osi&#x7684;-&#x54EA;&#x4E9B;&#x53C8;&#x4E0D;&#x662F;"><i class="fa fa-link" aria-hidden="true"></i></a>A11. &#x5982;&#x4F55;osi? &#x5230;&#x5E95;&#x54EA;&#x4E9B;&#x662F;osi&#x7684;? &#x54EA;&#x4E9B;&#x53C8;&#x4E0D;&#x662F;?</h4>
<p><code>components/driver/host/driver/osi/octeon_device.c</code>
<code>buf  = cavium_alloc_virt(size)</code>;&#x5B9E;&#x9645;&#x8C03;&#x7684;&#x662F;<code>vmalloc</code>, &#x8FD9;&#x662F;linux kernel&#x7684;&#x51FD;&#x6570;, &#x8FD9;&#x91CC;&#x5DF2;&#x7ECF;&#x4E0D;&#x662F;osi&#x4E86;</p>
<p>os&#x76F8;&#x5173;&#x7684;&#x5B9A;&#x4E49;&#x5728;<br><code>components/driver/host/driver/linux/cvm_linux_types.h</code></p>
<pre class="language-"><code class="lang-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>   <span class="token macro-name function">cavium_alloc_virt</span><span class="token expression"><span class="token punctuation">(</span>size<span class="token punctuation">)</span>        <span class="token function">vmalloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x5934;&#x6587;&#x4EF6;&#x88AB;
<code>components/driver/host/driver/linux/linux_sysdep.h</code> &#x5F15;&#x7528;<br>&#x8FDB;&#x800C;&#x88AB;
<code>components/driver/host/include/cavium_sysdep.h</code> &#x5F15;&#x7528;</p>
<pre class="language-"><code class="lang-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">linux</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;../driver/linux/linux_sysdep.h&quot;</span> <span class="token comment">//&#x73B0;&#x5728;&#x662F;&#x8FD9;&#x4E2A;&#x5206;&#x652F;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;../driver/freebsd/freebsd_sysdep.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span>_WIN32<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;..\driver\windows\windows_sysdep.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">/* CUSTOM_OS */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;custom_sysdep.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre>
<h4 id="a12cn66xx&#x7684;&#x914D;&#x7F6E;&#x8868;"><a name="a12cn66xx&#x7684;&#x914D;&#x7F6E;&#x8868;" class="anchor-navigation-ex-anchor" href="#a12cn66xx&#x7684;&#x914D;&#x7F6E;&#x8868;"><i class="fa fa-link" aria-hidden="true"></i></a>A12.cn66xx&#x7684;&#x914D;&#x7F6E;&#x8868;</h4>
<pre class="language-"><code class="lang-c"><span class="token class-name">cn66xx_config_t</span>  default_cn66xx_conf <span class="token operator">=</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* num_iqs; num_oqs; pending_list_size; */</span>
    <span class="token punctuation">{</span>
    <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token number">4096</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">/* Input Queue configuration */</span>
    <span class="token comment">/* num_descs; instr_type; db_min; db_timeout; */</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">{</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span> <span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span>  <span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span>  <span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">/* Output Queue configuration */</span>
    <span class="token comment">/* num_descs; info_ptr; bufsize, pkts_per_intr; refill_threshold*/</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">{</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1536</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">}</span> <span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token number">1024</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1536</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">}</span> <span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token number">1024</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1536</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">}</span> <span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token number">1024</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1536</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">}</span> <span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">/* oq_intr_pkt; oq_intr_time; */</span>
    <span class="token number">64</span><span class="token punctuation">,</span>
    <span class="token number">100</span><span class="token punctuation">,</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CVMCS_DMA_IC</span></span>
    <span class="token comment">/* dma_intr_pkt; dma_intr_time; */</span>
    <span class="token number">64</span><span class="token punctuation">,</span>
    <span class="token number">1000</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="a13-octpollmodulestarter"><a name="a13-octpollmodulestarter" class="anchor-navigation-ex-anchor" href="#a13-octpollmodulestarter"><i class="fa fa-link" aria-hidden="true"></i></a>A13. oct_poll_module_starter</h4>
<p>&#x8FD9;&#x4E2A;poll&#x7684;&#x4F5C;&#x7528;&#x662F;&#x7B49;&#x5F85;core&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x6210;&#x529F;, &#x5E76;&#x62A5;&#x544A;&#x5B83;&#x7684;app type</p>
<pre class="language-"><code class="lang-c"><span class="token function">oct_poll_module_starter</span><span class="token punctuation">(</span><span class="token keyword">void</span>  <span class="token operator">*</span>octptr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">cavium_atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oct<span class="token operator">-&gt;</span>status<span class="token punctuation">)</span> <span class="token operator">==</span> OCT_DEV_RUNNING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> OCT_POLL_FN_FINISHED<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* If the status of the device is CORE_OK, the core
       application has reported its application type. Call
       any registered handlers now and move to the RUNNING
       state. */</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">cavium_atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oct<span class="token operator">-&gt;</span>status<span class="token punctuation">)</span> <span class="token operator">!=</span> OCT_DEV_CORE_OK<span class="token punctuation">)</span>
        <span class="token keyword">return</span> OCT_POLL_FN_CONTINUE<span class="token punctuation">;</span>

    <span class="token function">cavium_atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oct<span class="token operator">-&gt;</span>status<span class="token punctuation">,</span>OCT_DEV_RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="a14-checkdbtimeout--doorbell-timeout-&#x5468;&#x671F;1&#x4E2A;tick"><a name="a14-checkdbtimeout--doorbell-timeout-&#x5468;&#x671F;1&#x4E2A;tick" class="anchor-navigation-ex-anchor" href="#a14-checkdbtimeout--doorbell-timeout-&#x5468;&#x671F;1&#x4E2A;tick"><i class="fa fa-link" aria-hidden="true"></i></a>A14. check_db_timeout  &quot;Doorbell Timeout&quot;, &#x5468;&#x671F;1&#x4E2A;tick</h4>
<pre class="language-"><code class="lang-c"><span class="token comment">/* Called by the Poll thread at regular intervals to check the instruction
 * queue for commands to be posted and for commands that were fetched by Octeon.
 */</span>
<span class="token function">check_db_timeout</span><span class="token punctuation">(</span><span class="token keyword">void</span>  <span class="token operator">*</span>octptr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span>  iq_no<span class="token punctuation">)</span>
    <span class="token comment">//&#x5148;&#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x7684;input queue</span>
    iq <span class="token operator">=</span> oct<span class="token operator">-&gt;</span>instr_queue<span class="token punctuation">[</span>iq_no<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x8BA1;&#x7B97;&#x662F;&#x5426;&#x8D85;&#x65F6;, &#x8FD9;&#x91CC;&#x9762;&#x7684;cavium_jiffies&#x662F;&#x5185;&#x6838;&#x53D8;&#x91CF;jiffies</span>
    <span class="token comment">//&#x6CA1;&#x8D85;&#x65F6;&#x5C31;&#x5565;&#x4E5F;&#x4E0D;&#x5E72;</span>
    If cavium_jiffies <span class="token operator">-</span> last_db_time <span class="token operator">&lt;</span> db_timeout
        <span class="token keyword">return</span> OCT_POLL_FN_CONTINUE<span class="token punctuation">;</span>
    iq<span class="token operator">-&gt;</span>last_db_time <span class="token operator">=</span> cavium_jiffies<span class="token punctuation">;</span> <span class="token comment">//&#x8BB0;&#x5F55;&#x4E0A;&#x6B21;&#x7684;cavium_jiffies</span>
    <span class="token comment">//&#x8FD9;&#x91CC;&#x7528;spin_lock_softirqsave&#x662F;&#x4E3A;&#x4E86;&#x963B;&#x6B62;&#x4E2D;&#x65AD;(tasklet)--&#x54EA;&#x4E2A;&#x4E2D;&#x65AD;&#x4E5F;&#x8981;&#x9501;iq-&gt;lock&#x5462;?</span>
    <span class="token function">cavium_spin_lock_softirqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>iq<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//fill_cnt&#x8868;&#x793A;&#x7B49;&#x5F85;&#x53D1;&#x5230;octeon&#x7684;instructions&#x4E2A;&#x6570;, &#x8D85;&#x65F6;&#x4E86;&#x8FD8;&#x6709;&#x503C;, &#x5219;&#x6309;&#x95E8;&#x94C3;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>iq<span class="token operator">-&gt;</span>fill_cnt <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">ring_doorbell</span><span class="token punctuation">(</span>iq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//OCTEON_WRITE32&#x4E5F;&#x662F;&#x4E2A;osi&#x7684;&#x63A5;&#x53E3;, &#x5E95;&#x4E0B;&#x662F;writel</span>
            <span class="token function">OCTEON_WRITE32</span><span class="token punctuation">(</span>iq<span class="token operator">-&gt;</span>doorbell_reg<span class="token punctuation">,</span> iq<span class="token operator">-&gt;</span>fill_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            iq<span class="token operator">-&gt;</span>fill_cnt     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            iq<span class="token operator">-&gt;</span>last_db_time <span class="token operator">=</span> cavium_jiffies<span class="token punctuation">;</span>
    <span class="token function">cavium_spin_unlock_softirqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>iq<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">cavium_atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>iq<span class="token operator">-&gt;</span>instr_pending<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">/** &#x8FD9;&#x4E2A;&#x6CE8;&#x91CA;&#x771F;&#x597D;!
        * Check for commands that were fetched by Octeon. If they were NORESPONSE
        * requests, move the requests from the per-queue pending list to the
        * per-device noresponse completion list.
        */</span>
        <span class="token function">flush_instr_queue</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> iq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">update_iq_indices</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> iq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//&#x6839;&#x636E;octeon&#x5DF2;&#x7ECF;&#x8BFB;&#x53D6;&#x7684;commands&#x6570;&#x66F4;&#x65B0;, octeon_read_index&#x8868;&#x793A;octeon&#x5DF2;&#x7ECF;&#x6267;&#x884C;&#x5B8C;&#x7684;index</span>
                iq<span class="token operator">-&gt;</span>octeon_read_index <span class="token operator">=</span> oct<span class="token operator">-&gt;</span>fn_list<span class="token punctuation">.</span><span class="token function">update_iq_read_idx</span><span class="token punctuation">(</span>iq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">/*&#x628A;flush_index&#x5230;octeon_read_index&#x4E4B;&#x95F4;&#x7684;
                **NORESPONSE&#x7684;&#x8BF7;&#x6C42;&#x79FB;&#x52A8;&#x5230;completion list(&#x6BCF;&#x4E2A;device&#x4E00;&#x4E2A;)
                */</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>iq<span class="token operator">-&gt;</span>flush_index <span class="token operator">!=</span> iq<span class="token operator">-&gt;</span>octeon_read_index<span class="token punctuation">)</span>
                    inst_processed <span class="token operator">=</span> <span class="token function">__process_iq_noresponse_list</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> iq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//&#x5728;&#x5FAA;&#x73AF;&#x91CC;&#x628A;flush_index&#x5230;octeon_read_index&#x4E4B;&#x95F4;&#x7684;instruction&#x79FB;&#x5230;freelist</span>
                        <span class="token comment">//&#x4ECE;iq-&gt;nrlist&#x79FB;&#x5230;iq-&gt;nr_free.q</span>
                        iq<span class="token operator">-&gt;</span>nr_free<span class="token punctuation">.</span>q<span class="token punctuation">[</span>put_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>buf     <span class="token operator">=</span> iq<span class="token operator">-&gt;</span>nrlist<span class="token punctuation">[</span>old<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">;</span>
                        iq<span class="token operator">-&gt;</span>nr_free<span class="token punctuation">.</span>q<span class="token punctuation">[</span>put_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>buftype <span class="token operator">=</span> iq<span class="token operator">-&gt;</span>nrlist<span class="token punctuation">[</span>old<span class="token punctuation">]</span><span class="token punctuation">.</span>buftype<span class="token punctuation">;</span>
                        iq<span class="token operator">-&gt;</span>nrlist<span class="token punctuation">[</span>old<span class="token punctuation">]</span><span class="token punctuation">.</span>buf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> iq<span class="token operator">-&gt;</span>nrlist<span class="token punctuation">[</span>old<span class="token punctuation">]</span><span class="token punctuation">.</span>buftype <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token comment">//&#x8FD9;&#x91CC;&#x8868;&#x793A;noresponse&#x7684;&#x5DF2;&#x7ECF;&#x5904;&#x7406;&#x4E86;inst_processed&#x4E2A;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>inst_processed<span class="token punctuation">)</span>
                        <span class="token function">cavium_atomic_sub</span><span class="token punctuation">(</span>inst_processed<span class="token punctuation">,</span> <span class="token operator">&amp;</span>iq<span class="token operator">-&gt;</span>instr_pending<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        iq<span class="token operator">-&gt;</span>stats<span class="token punctuation">.</span>instr_processed <span class="token operator">+=</span> inst_processed <span class="token punctuation">;</span>
            <span class="token comment">//&#x5BF9;iq-&gt;nr_free&#x8FDB;&#x884C;&#x91CA;&#x653E;, &#x8FD8;&#x662F;irqsave&#x9501;iq-&gt;lock</span>
            <span class="token function">process_noresponse_list</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> iq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//&#x5728;get_idx&#x548C;put_idx&#x4E4B;&#x95F4;</span>
                <span class="token keyword">while</span><span class="token punctuation">(</span>get_idx <span class="token operator">!=</span> iq<span class="token operator">-&gt;</span>nr_free<span class="token punctuation">.</span>put_idx<span class="token punctuation">)</span>
                    <span class="token keyword">switch</span><span class="token punctuation">(</span>iq<span class="token operator">-&gt;</span>nr_free<span class="token punctuation">.</span>q<span class="token punctuation">[</span>get_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>buftype<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> NORESP_BUFTYPE_INSTR<span class="token operator">:</span>
                        <span class="token comment">//instr&#x662F;octeon_soft_instruction_t, &#x89C1;&#x7ED3;&#x6784;&#x4F53;E11</span>
                        instr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_soft_instruction_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>iq<span class="token operator">-&gt;</span>nr_free<span class="token punctuation">.</span>q<span class="token punctuation">[</span>get_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">;</span>
                        <span class="token comment">//instr_list&#x662F;&#x4E2A;&#x5C40;&#x90E8;&#x53D8;&#x91CF;, &#x8868;&#x793A;&#x4E00;&#x4E2A;&#x94FE;&#x8868;</span>
                        <span class="token function">cavium_list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>instr<span class="token operator">-&gt;</span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>instr_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> NORESP_BUFTYPE_NET<span class="token operator">:</span>
                    <span class="token keyword">case</span> NORESP_BUFTYPE_NET_SG<span class="token operator">:</span>
                    <span class="token keyword">case</span> NORESP_BUFTYPE_OHSM_SEND<span class="token operator">:</span>
                        <span class="token comment">//&#x8FD9;&#x91CC;&#x91CA;&#x653E;buf</span>
                        noresp_buf_free_fn<span class="token punctuation">[</span>oct<span class="token operator">-&gt;</span>octeon_id<span class="token punctuation">]</span><span class="token punctuation">[</span>iq<span class="token operator">-&gt;</span>nr_free<span class="token punctuation">.</span>q<span class="token punctuation">[</span>get_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>buftype<span class="token punctuation">]</span><span class="token punctuation">(</span>iq<span class="token operator">-&gt;</span>nr_free<span class="token punctuation">.</span>q<span class="token punctuation">[</span>get_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//&#x63A5;&#x4E0B;&#x6765;&#x5904;&#x7406;&#x521A;&#x751F;&#x6210;&#x7684;instr_list&#x94FE;&#x8868;</span>
                <span class="token function">release_soft_instr</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> instr<span class="token punctuation">,</span> instr<span class="token operator">-&gt;</span>req_info<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x6807;&#x8BB0;A14i1</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>soft_instr<span class="token operator">-&gt;</span>dptr<span class="token punctuation">)</span>
                        <span class="token comment">//DPI_INST_HDR[G]=0&#x65F6;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>soft_instr<span class="token operator">-&gt;</span>ih<span class="token punctuation">.</span>gather<span class="token punctuation">)</span>
                            <span class="token function">octeon_pci_unmap_single</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//response_manager.c</span>
                        <span class="token comment">//DPI_INST_HDR[G]=1&#x65F6;, DPTR&#x6307;&#x5411;&#x4E00;&#x4E2A;&#x94FE;&#x8868;</span>
                        <span class="token keyword">else</span>
                            <span class="token function">octeon_pci_unmap_sg_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token comment">//&#x6CE8;: &#x4EE5;&#x4E0A;&#x4E24;&#x4E2A;&#x53C8;&#x662F;osi&#x7684;&#x63A5;&#x53E3;, &#x89C1;A141</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>soft_instr<span class="token operator">-&gt;</span>rptr<span class="token punctuation">)</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>soft_instr<span class="token operator">-&gt;</span>irh<span class="token punctuation">.</span>scatter<span class="token punctuation">)</span>
                            <span class="token function">octeon_pci_unmap_single</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token keyword">else</span>
                            <span class="token function">octeon_pci_unmap_sg_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token comment">//&#x8C03;&#x7528;callback,&#x662F;SET_REQ_INFO_CALLBACK()&#x6CE8;&#x518C;&#x7684;, &#x89C1;C12&#x91CC;&#x9762;&#x7684;&#x8C03;&#x7528;</span>
                    soft_instr<span class="token operator">-&gt;</span>req_info<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> soft_instr<span class="token operator">-&gt;</span>alloc_flags
                        <span class="token function">delete_soft_instr_buffers</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> soft_instr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x89C1;A142</span>
                            <span class="token function">cavium_free_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>soft_instr<span class="token operator">-&gt;</span>status_word <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">cavium_free_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>soft_instr<span class="token operator">-&gt;</span>scatter_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">cavium_free_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>soft_instr<span class="token operator">-&gt;</span>gather_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">cavium_free_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>soft_instr<span class="token operator">-&gt;</span>dptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">cavium_free_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>soft_instr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="a141-octeonpcimapsingle&#x548C;octeonpciunmapsingle"><a name="a141-octeonpcimapsingle&#x548C;octeonpciunmapsingle" class="anchor-navigation-ex-anchor" href="#a141-octeonpcimapsingle&#x548C;octeonpciunmapsingle"><i class="fa fa-link" aria-hidden="true"></i></a>A141. octeon_pci_map_single&#x548C;octeon_pci_unmap_single</h5>
<pre class="language-"><code class="lang-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USE_PCIMAP_CALLS</span> <span class="token comment">//&#x8FD9;&#x91CC;&#x9ED8;&#x8BA4;&#x662F;&#x6253;&#x5F00;&#x7684;</span></span>
<span class="token function">octeon_pci_map_single</span><span class="token punctuation">(</span><span class="token class-name">cavium_pci_device_t</span> <span class="token operator">*</span>pci_dev<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>virt_addr<span class="token punctuation">,</span><span class="token class-name">uint32_t</span>  size<span class="token punctuation">,</span> <span class="token keyword">int</span> direction<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>USE_PCIMAP_CALLS<span class="token punctuation">)</span></span></span>
    physaddr <span class="token operator">=</span> <span class="token function">pci_map_single</span><span class="token punctuation">(</span>pci_dev<span class="token punctuation">,</span> virt_addr<span class="token punctuation">,</span> size<span class="token punctuation">,</span> direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    physaddr <span class="token operator">=</span> <span class="token function">virt_to_phys</span><span class="token punctuation">(</span>virt_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token function">octeon_pci_unmap_single</span><span class="token punctuation">(</span><span class="token class-name">cavium_pci_device_t</span>  <span class="token operator">*</span>pci_dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> dma_addr<span class="token punctuation">,</span>
                        <span class="token class-name">uint32_t</span>  size<span class="token punctuation">,</span> <span class="token keyword">int</span> direction<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>USE_PCIMAP_CALLS<span class="token punctuation">)</span></span></span>
    <span class="token function">pci_unmap_single</span><span class="token punctuation">(</span>pci_dev<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">dma_addr_t</span><span class="token punctuation">)</span>dma_addr<span class="token punctuation">,</span> size<span class="token punctuation">,</span> direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre>
<p>&#x6CE8;:<code>octeon_pci_map_single</code>&#x7528;&#x6765;map&#x5DF2;&#x7ECF;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;</p>
<pre class="language-"><code class="lang-c">desc_ring<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>info_ptr
desc_ring<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer_ptr
cmd<span class="token operator">-&gt;</span>dptr
cmd<span class="token operator">-&gt;</span>rptr
sg_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ptr<span class="token punctuation">[</span>k<span class="token punctuation">]</span>&#x90FD;&#x4F1A;&#x7528;&#x5230;
</code></pre>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x8BF4;&#x53EA;&#x662F;&#x4E2A;map&#x5462;? &#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;bufer&#x5DF2;&#x7ECF;&#x7533;&#x8BF7;&#x597D;&#x4E86;. &#x6BD4;&#x5982;&#x5728;</p>
<pre class="language-"><code class="lang-c">octeon_droq_setup_ring_buffers&#x4E2D;
    buf <span class="token operator">=</span> <span class="token function">get_new_recv_buffer</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dev_alloc_skb</span><span class="token punctuation">(</span>size <span class="token operator">+</span> SKB_ADJUST<span class="token punctuation">)</span> <span class="token comment">//&#x5B9E;&#x9645;&#x5E95;&#x4E0B;&#x4F7F;&#x7528;skbuf&#x7533;&#x8BF7;&#x7684;</span>
    droq<span class="token operator">-&gt;</span>recv_buf_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data    <span class="token operator">=</span> <span class="token function">get_recv_buffer_data</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    desc_ring<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer_ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token function">octeon_pci_map_single</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>pci_dev<span class="token punctuation">,</span> droq<span class="token operator">-&gt;</span>recv_buf_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> droq<span class="token operator">-&gt;</span>buffer_size<span class="token punctuation">,</span> CAVIUM_PCI_DMA_FROMDEVICE <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x8865;&#x5145;:<code>pci_map_single</code>&#x662F;&#x5E72;&#x5565;&#x7684;?&#x89C1;<code>linux/include/asm-generic/pci-dma-compat.h</code></p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token class-name">dma_addr_t</span>
<span class="token function">pci_map_single</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token operator">*</span>hwdev<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> direction<span class="token punctuation">)</span>
    <span class="token function">dma_map_single</span><span class="token punctuation">(</span>hwdev <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token constant">NULL</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>hwdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">enum</span> <span class="token class-name">dma_data_direction</span><span class="token punctuation">)</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">dma_map_ops</span> <span class="token operator">*</span>ops <span class="token operator">=</span> <span class="token function">get_dma_ops</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        addr <span class="token operator">=</span> ops<span class="token operator">-&gt;</span><span class="token function">map_page</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token function">virt_to_page</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>ptr <span class="token operator">&amp;</span> <span class="token operator">~</span>PAGE_MASK<span class="token punctuation">,</span> size<span class="token punctuation">,</span>
                 dir<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> addr<span class="token punctuation">;</span>
</code></pre>
<p>&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x5F3A;&#x8C03;&#x7684;&#x662F;:
&#x5B9E;&#x9645;&#x4E0A;&#x8FD9;&#x91CC;&#x7528;&#x5230;&#x4E86;IOMMU, &#x628A;ptr&#x8F6C;&#x6210;&#x4E86;IOVA(IO Virtual address)<br>&#x9A71;&#x52A8;&#x5728;&#x53D1;DMA&#x7684;command&#x4E4B;&#x524D;, &#x9700;&#x8981;&#x8C03;&#x7528;pci<em>map</em>*()&#x53BB;&#x628A;&#x5730;&#x5740;&#x8F6C;&#x6210;IO&#x865A;&#x62DF;&#x5730;&#x5740;<br>IOVA&#x662F;&#x5206;domain&#x7684;, &#x6BCF;&#x4E2A;pcie&#x7684;device&#x90FD;&#x6709;&#x81EA;&#x5DF1;&#x7684;domain, &#x5728;&#x4E00;&#x4E2A;p2p&#x6865;&#x4E0B;&#x9762;&#x7684;&#x6240;&#x6709;devices&#x5171;&#x4EAB;&#x865A;&#x62DF;&#x5730;&#x5740;&#x7A7A;&#x95F4;</p>
<p>&#x518D;&#x8865;&#x5145;:<code>octeon_pci_alloc_consistent</code>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x88AB;&#x7528;&#x6765;&#x7533;&#x8BF7;<code>droq-&gt;desc_ring&#x548C;iq-&gt;base_addr</code>&#x7684;&#x5185;&#x5B58;
&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x662F;&#x5426;&#x4FDD;&#x8BC1;&#x4E86;&#x5185;&#x5B58;&#x4E00;&#x81F4;&#x6027;???</p>
<pre class="language-"><code class="lang-c">octeon_pci_alloc_consistent
    <span class="token function">pci_alloc_consistent</span><span class="token punctuation">(</span>pci_dev<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">dma_addr_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>dma_addr_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dma_alloc_coherent</span><span class="token punctuation">(</span>hwdev <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token constant">NULL</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>hwdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> size<span class="token punctuation">,</span> dma_handle<span class="token punctuation">,</span> GFP_ATOMIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">struct</span> <span class="token class-name">dma_map_ops</span> <span class="token operator">*</span>ops <span class="token operator">=</span> <span class="token function">platform_dma_get_ops</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            caddr <span class="token operator">=</span> ops<span class="token operator">-&gt;</span><span class="token function">alloc</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> size<span class="token punctuation">,</span> daddr<span class="token punctuation">,</span> gfp<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> caddr<span class="token punctuation">;</span>
</code></pre>
<h5 id="a142-&#x5185;&#x5B58;&#x7533;&#x8BF7;&#x53CA;&#x91CA;&#x653E;"><a name="a142-&#x5185;&#x5B58;&#x7533;&#x8BF7;&#x53CA;&#x91CA;&#x653E;" class="anchor-navigation-ex-anchor" href="#a142-&#x5185;&#x5B58;&#x7533;&#x8BF7;&#x53CA;&#x91CA;&#x653E;"><i class="fa fa-link" aria-hidden="true"></i></a>A142. &#x5185;&#x5B58;&#x7533;&#x8BF7;&#x53CA;&#x91CA;&#x653E;</h5>
<p>&#x5728;<code>delete_soft_instr_buffers</code>&#x51FD;&#x6570;&#x4E2D;, &#x8C03;&#x7528;&#x4E86;&#x5F88;&#x591A;<code>cavium_free_buffer()</code>&#x51FD;&#x6570;,<br>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x548C;<code>cavium_alloc_buffer()</code>&#x4E00;&#x8D77;,&#x7BA1;&#x7406;&#x50CF;  </p>
<pre class="language-"><code>soft_instr-&gt;dptr 
soft_instr 
soft_instr-&gt;gather_ptr
soft_instr-&gt;scatter_ptr
</code></pre><p>&#x8FD9;&#x6837;&#x7684;buffer<br>&#x8FD9;&#x4E9B;&#x662F;osi&#x7684;&#x63A5;&#x53E3;</p>
<pre class="language-"><code class="lang-c"><span class="token comment">/*
 *  Macros that switch between using the buffer pool and the system-dependent
 *  routines based on compilation flags used.
 */</span>
<span class="token keyword">static</span> __inline <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">cavium_alloc_buffer</span><span class="token punctuation">(</span><span class="token class-name">octeon_device_t</span> <span class="token operator">*</span>octeon_dev<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USE_BUFFER_POOL</span></span>
    <span class="token comment">//&#x4ECE;&#x9884;&#x5148;&#x5206;&#x914D;&#x7684;&#x51E0;&#x4E2A;pool&#x4E2D;&#x5206;&#x914D;, 32k, 16k, 8k, 4k, 2k...</span>
    <span class="token comment">//&#x8D85;&#x8FC7;32k&#x7684;size&#x8FD8;&#x662F;&#x7528;cavium_malloc_dma&#x6765;&#x5206;&#x914D;</span>
    <span class="token keyword">return</span> <span class="token function">get_buffer_from_pool</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">//&#x5176;&#x5E95;&#x5C42;&#x5B9E;&#x73B0;&#x662F;kmalloc, &#x5728;cvm_linux_types.h</span>
    <span class="token keyword">return</span> <span class="token function">cavium_malloc_dma</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> __CAVIUM_MEM_ATOMIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> __inline <span class="token keyword">void</span>
<span class="token function">cavium_free_buffer</span><span class="token punctuation">(</span><span class="token class-name">octeon_device_t</span>  <span class="token operator">*</span>octeon_dev<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USE_BUFFER_POOL</span></span>
     <span class="token function">put_buffer_in_pool</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
     <span class="token function">cavium_free_dma</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="a15-octpollreqcompletion-1&#x4E2A;tick"><a name="a15-octpollreqcompletion-1&#x4E2A;tick" class="anchor-navigation-ex-anchor" href="#a15-octpollreqcompletion-1&#x4E2A;tick"><i class="fa fa-link" aria-hidden="true"></i></a>A15. oct_poll_req_completion, 1&#x4E2A;tick</h4>
<p>&#x548C;<code>octeon_request_completion_bh</code>&#x7C7B;&#x4F3C;
&#x5BF9;ordered list, &#x7531;&#x94FE;&#x8868;&#x5934;<br><code>&amp;octeon_dev-&gt;response_list[OCTEON_ORDERED_LIST]</code>&#x5E26;&#x9886;
&#x4E0B;&#x9762;&#x94FE;&#x8868;&#x7684;&#x5143;&#x7D20;&#x662F;<br><code>octeon_pending_entry_t</code>, &#x89C1;&#x7ED3;&#x6784;&#x4F53;E1 </p>
<pre class="language-"><code class="lang-c"><span class="token function">oct_poll_req_completion</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>octptr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span>  arg<span class="token punctuation">)</span>
    <span class="token function">process_ordered_list</span><span class="token punctuation">(</span>oct<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x662F;&#x4E00;&#x6B21;&#x5904;&#x7406;&#x7684;&#x4E0A;&#x9650;&#x503C;</span>
        <span class="token class-name">uint32_t</span> resp_to_process <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>
        <span class="token comment">/*&#x6CE8;&#x610F;, &#x5982;&#x679C;&#x5B9A;&#x4E49;&#x4E86;CVMCS_DMA_IC
        **&#x5982;&#x679C;&#x4F7F;&#x80FD;&#x4E86;DMA&#x4E2D;&#x65AD;(def CVMCS_DMA_IC), &#x5C31;&#x53EF;&#x4EE5;&#x786E;&#x5207;&#x7684;&#x4F7F;&#x7528;dma_cnt_to_process
        **dma_cnt_to_process&#x8868;&#x793A;&#x5DF2;&#x7ECF;&#x6709;&#x591A;&#x5C11;&#x4E2A;&#x88AB;DMA&#x4E86;
        */</span>
        resp_to_process <span class="token operator">=</span> <span class="token function">cavium_atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>dma_cnt_to_process<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x89C1;&#x7ED3;&#x6784;&#x4F53;F, &#x4E09;&#x4E2A;response list&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x5934;</span>
        response_list <span class="token operator">=</span>  <span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>response_list<span class="token punctuation">[</span>OCTEON_ORDERED_LIST<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token operator">&lt;</span> resp_to_process
            <span class="token comment">//pending_entry&#x662F;octeon_pending_entry_t, &#x89C1;E1</span>
            <span class="token comment">//&#x4ECE;response_list&#x53D6;&#x8282;&#x70B9;&#x4F9D;&#x6B21;&#x5904;&#x7406;</span>
            pending_entry <span class="token operator">=</span>  <span class="token function">get_list_head</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> response_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
            soft_instr <span class="token operator">=</span> pending_entry<span class="token operator">-&gt;</span>instr<span class="token punctuation">;</span>
            <span class="token comment">//&#x8FD9;&#x91CC;&#x7684;soft_instr-&gt;status_word&#x662F;&#x4E2A;&#x5730;&#x5740;, &#x5E94;&#x8BE5;&#x662F;octeon&#x5199;&#x56DE;status&#x7528;&#x7684;</span>
            <span class="token class-name">uint64_t</span>   status64 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>soft_instr<span class="token operator">-&gt;</span>status_word<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            status <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_req_status_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>status64 <span class="token operator">&amp;</span> <span class="token number">0xffffffffULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//&#x5DF2;&#x7ECF;&#x53D1;&#x9001;ok&#x4E86;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">!=</span> OCTEON_REQUEST_PENDING<span class="token punctuation">)</span>
                <span class="token comment">//&#x4ECE;&#x8FD9;&#x4E2A;response list&#x91CC;&#x9762;&#x5220;&#x9664;&#x8282;&#x70B9;</span>
                <span class="token function">release_from_response_list</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> pending_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x4F1A;&#x8C03;callback, &#x4E5F;&#x5C31;&#x662F;&#x4F1A;&#x628A;response&#x4ECE;&#x5185;&#x6838;&#x6001;&#x8003;&#x5230;&#x7528;&#x6237;&#x6001;</span>
                <span class="token function">release_soft_instr</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> soft_instr<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x89C1;&#x6807;&#x8BB0;A14i1</span>
                <span class="token comment">//&#x4ECE;pending list&#x5220;&#x9664;&#x8282;&#x70B9;</span>
                <span class="token function">release_from_pending_list</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span>pending_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>free_index<span class="token operator">--</span><span class="token punctuation">;</span>
                    oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>free_list<span class="token punctuation">[</span>oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>free_index<span class="token punctuation">]</span> <span class="token operator">=</span> pe<span class="token operator">-&gt;</span>request_id<span class="token punctuation">;</span>
                    pe<span class="token operator">-&gt;</span>status <span class="token operator">=</span> OCTEON_PENDING_ENTRY_FREE<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token comment">//&#x76F8;&#x5F53;&#x4E8E;&#x9000;&#x51FA;&#x5FAA;&#x73AF;&#x4E86;, &#x8FD9;&#x91CC;&#x4E5F;&#x6B63;&#x662F;order&#x6A21;&#x5F0F;&#x7684;&#x7CBE;&#x9AD3;! &#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x6A21;&#x5F0F;&#x4E0B;&#x7684;pending list&#x662F;&#x6839;&#x636E;&#x8BF7;&#x6C42;&#x7684;&#x987A;&#x5E8F;&#x52A0;&#x7684;, &#x800C;&#x5904;&#x7406;&#x7684;&#x7ED3;&#x679C;&#x4ECE;status&#x5F97;&#x51FA;, &#x5982;&#x679C;&#x524D;&#x9762;&#x7684;entry&#x6CA1;&#x5B8C;&#x6210;, &#x540E;&#x9762;&#x4E5F;&#x662F;&#x4E0D;&#x4F1A;&#x5B8C;&#x6210;&#x7684;.&#x6240;&#x4EE5;&#x5C31;&#x6B64;&#x9000;&#x51FA;</span>
    <span class="token comment">//unordered blocking&#x7684;ioctl&#x4F1A;&#x963B;&#x585E;, </span>
    <span class="token function">check_unordered_blocking_list</span><span class="token punctuation">(</span>oct<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x89C1;&#x7ED3;&#x6784;&#x4F53;F, &#x4E09;&#x4E2A;response list&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x5934;</span>
        response_list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_response_list_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>response_list<span class="token punctuation">[</span>OCTEON_UNORDERED_BLOCKING_LIST<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x5BF9;&#x6BCF;&#x4E2A;&#x94FE;&#x8868;&#x8282;&#x70B9;</span>
        <span class="token comment">//&#x6CE8;:&#x8FD9;&#x91CC;&#x662F;unordered, &#x5C31;&#x4E0D;&#x50CF;&#x4E0A;&#x9762;, &#x9047;&#x5230;&#x4E2A;&#x672A;&#x5904;&#x7406;&#x7684;&#x5C31;&#x9000;&#x51FA;&#x4E86;. &#x8FD9;&#x91CC;&#x662F;&#x4E00;&#x76F4;&#x904D;&#x5386;&#x8FD9;&#x4E2A;&#x94FE;&#x8868;: &#x4F46;&#x6709;&#x4E2A;&#x4EBA;&#x4E3A;&#x7684;&#x6700;&#x591A;16&#x4E2A;&#x7684;&#x9650;&#x5236;.</span>
        <span class="token function">cavium_list_for_each_safe</span><span class="token punctuation">(</span>curr<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>response_list<span class="token operator">-&gt;</span>head<span class="token punctuation">)</span>
            pending_entry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_pending_entry_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>curr<span class="token punctuation">;</span>
            soft_instr <span class="token operator">=</span> pending_entry<span class="token operator">-&gt;</span>instr<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token operator">*</span><span class="token punctuation">(</span>soft_instr<span class="token operator">-&gt;</span>status_word<span class="token punctuation">)</span> <span class="token operator">!=</span> COMPLETION_WORD_INIT
                <span class="token class-name">uint64_t</span>   status64 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>soft_instr<span class="token operator">-&gt;</span>status_word<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                status <span class="token operator">=</span> OCTEON_REQUEST_TIMEOUT<span class="token punctuation">;</span>
            <span class="token comment">//&#x4E0D;pending&#x8868;&#x793A;&#x5DF2;&#x7ECF;ok&#x4E86;?</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">!=</span> OCTEON_REQUEST_PENDING<span class="token punctuation">)</span>
                <span class="token comment">//&#x8FD9;&#x91CC;&#x53EA;&#x8C03;&#x4E2A;callback?&#x90A3;&#x4E48;&#x91CA;&#x653E;&#x8D44;&#x6E90;&#x5462;? --&#x662F;SET_REQ_INFO_CALLBACK()&#x6CE8;&#x518C;&#x7684;, &#x89C1;C12&#x91CC;&#x9762;&#x7684;&#x8C03;&#x7528;</span>
                soft_instr<span class="token operator">-&gt;</span>req_info<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="a16-octpollcheckunorderedlist"><a name="a16-octpollcheckunorderedlist" class="anchor-navigation-ex-anchor" href="#a16-octpollcheckunorderedlist"><i class="fa fa-link" aria-hidden="true"></i></a>A16. oct_poll_check_unordered_list</h4>
<p>&#x8FD9;&#x91CC;&#x7684;&#x6CE8;&#x91CA;&#x5199;&#x7684;&#x5F88;&#x597D;, &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x662F;&#x7ED9;UNORDERED NONBLOCKING LIST&#x6536;&#x5C38;&#x7684;;
&#x8FD9;&#x4E2A;&#x7C7B;&#x578B;&#x7684;response&#x662F;&#x8981;app&#x53BB;&#x67E5;&#x8BE2;&#x5B8C;&#x6210;&#x72B6;&#x6001;&#x7684;:
app&#x8C03;&#x7528;api octeon_query_request_status(query.octeon_id,&amp;query)&#x6765;&#x67E5;&#x8BE2;.
&#x4F46;&#x5982;&#x679C;app&#x610F;&#x5916;&#x9000;&#x51FA;&#x4E86;, &#x6709;&#x4E9B;pending entry&#x5C31;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x91CA;&#x653E;&#x4E86;.</p>
<h4 id="a17-checkdroqrefill-&#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;"><a name="a17-checkdroqrefill-&#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;" class="anchor-navigation-ex-anchor" href="#a17-checkdroqrefill-&#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;"><i class="fa fa-link" aria-hidden="true"></i></a>A17. check_droq_refill, &#x6BCF;&#x4E2A;q&#x4E00;&#x4E2A;</h4>
<pre class="language-"><code class="lang-c"><span class="token function">check_droq_refill</span><span class="token punctuation">(</span><span class="token keyword">void</span>  <span class="token operator">*</span>octptr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> q_no<span class="token punctuation">)</span>
    droq <span class="token operator">=</span> oct<span class="token operator">-&gt;</span>droq<span class="token punctuation">[</span>q_no<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>refill_count <span class="token operator">&gt;=</span> droq<span class="token operator">-&gt;</span>refill_threshold<span class="token punctuation">)</span> 
        <span class="token comment">//no dispatch&#x65F6;, buffer&#x4F1A;&#x4FDD;&#x7559;, &#x5426;&#x5219;&#x8FD8;&#x8981;&#x7533;&#x8BF7;&#x65B0;&#x7684;recv buffer</span>
        <span class="token comment">//&#x5E76;&#x628A;droq-&gt;refill_count--;&#x89C1;A171</span>
        desc_refilled <span class="token operator">=</span> <span class="token function">octeon_droq_refill</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> droq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x8FD9;&#x53EF;&#x80FD;&#x662F;&#x4E2A;&#x5237;cache&#x7684;&#x51FD;&#x6570;, &#x91CD;&#x8981;!&#x600E;&#x4E48;&#x5728;&#x7528;&#x6237;&#x6001;&#x5237;cache&#x5462;?</span>
        <span class="token function">cavium_flush_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">OCTEON_WRITE32</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>pkts_credit_reg<span class="token punctuation">,</span> desc_refilled<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="a171-octeondroqrefill"><a name="a171-octeondroqrefill" class="anchor-navigation-ex-anchor" href="#a171-octeondroqrefill"><i class="fa fa-link" aria-hidden="true"></i></a>A171. octeon_droq_refill</h5>
<p>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5F88;&#x591A;&#x5730;&#x65B9;&#x90FD;&#x5728;&#x8C03;</p>
<pre class="language-"><code class="lang-c"><span class="token function">octeon_droq_refill</span><span class="token punctuation">(</span><span class="token class-name">octeon_device_t</span>  <span class="token operator">*</span>octeon_dev<span class="token punctuation">,</span> <span class="token class-name">octeon_droq_t</span>   <span class="token operator">*</span>droq<span class="token punctuation">)</span>
   desc_ring <span class="token operator">=</span> droq<span class="token operator">-&gt;</span>desc_ring<span class="token punctuation">;</span>
   <span class="token keyword">while</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>refill_count <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>desc_refilled <span class="token operator">&lt;</span> droq<span class="token operator">-&gt;</span>max_count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* If a valid buffer exists (happens if there is no dispatch), reuse 
           the buffer, else allocate. */</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>recv_buf_list<span class="token punctuation">[</span>droq<span class="token operator">-&gt;</span>host_refill_index<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> 
            <span class="token comment">//buffer&#x4E3A;NULL&#x8BF4;&#x660E;&#x5DF2;&#x7ECF;dispatch&#x4E86;? &#x6B64;&#x65F6;&#x91CD;&#x65B0;&#x7533;&#x8BF7;&#x4E00;&#x4E2A;buffer --&#x53C2;&#x8003;A182</span>
            buf <span class="token operator">=</span> <span class="token function">get_new_recv_buffer</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x89C1;A141</span>
            <span class="token comment">/* If a buffer could not be allocated, no point in continuing */</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>buf<span class="token punctuation">)</span> 
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            droq<span class="token operator">-&gt;</span>recv_buf_list<span class="token punctuation">[</span>droq<span class="token operator">-&gt;</span>host_refill_index<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer <span class="token operator">=</span> buf<span class="token punctuation">;</span>
            data <span class="token operator">=</span> <span class="token function">get_recv_buffer_data</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            data <span class="token operator">=</span> <span class="token function">get_recv_buffer_data</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>recv_buf_list<span class="token punctuation">[</span>droq<span class="token operator">-&gt;</span>host_refill_index<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>ETHERPCI<span class="token punctuation">)</span></span></span>
        data <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        droq<span class="token operator">-&gt;</span>recv_buf_list<span class="token punctuation">[</span>droq<span class="token operator">-&gt;</span>host_refill_index<span class="token punctuation">]</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
        desc_ring<span class="token punctuation">[</span>droq<span class="token operator">-&gt;</span>host_refill_index<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer_ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token function">octeon_pci_map_single</span><span class="token punctuation">(</span>octeon_dev<span class="token operator">-&gt;</span>pci_dev<span class="token punctuation">,</span> data<span class="token punctuation">,</span> droq<span class="token operator">-&gt;</span>buffer_size<span class="token punctuation">,</span> CAVIUM_PCI_DMA_FROMDEVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Reset any previous values in the length field. */</span>
        droq<span class="token operator">-&gt;</span>info_list<span class="token punctuation">[</span>droq<span class="token operator">-&gt;</span>host_refill_index<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token function">INCR_INDEX_BY1</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>host_refill_index<span class="token punctuation">,</span> droq<span class="token operator">-&gt;</span>max_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        desc_refilled<span class="token operator">++</span><span class="token punctuation">;</span>
        droq<span class="token operator">-&gt;</span>refill_count<span class="token operator">--</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="a18-octdroqthread-&#x6536;&#x5305;&#x7EBF;&#x7A0B;-&#x6BCF;&#x4E2A;output-q&#x4E00;&#x4E2A;"><a name="a18-octdroqthread-&#x6536;&#x5305;&#x7EBF;&#x7A0B;-&#x6BCF;&#x4E2A;output-q&#x4E00;&#x4E2A;" class="anchor-navigation-ex-anchor" href="#a18-octdroqthread-&#x6536;&#x5305;&#x7EBF;&#x7A0B;-&#x6BCF;&#x4E2A;output-q&#x4E00;&#x4E2A;"><i class="fa fa-link" aria-hidden="true"></i></a>A18. oct_droq_thread, &#x6536;&#x5305;&#x7EBF;&#x7A0B;, &#x6BCF;&#x4E2A;output q&#x4E00;&#x4E2A;</h4>
<p>&#x4F46;&#x597D;&#x50CF;&#x6CA1;&#x6253;&#x5F00;; &#x548C;A19&#x6536;&#x5305;bh&#x4E8C;&#x9009;&#x4E00;</p>
<pre class="language-"><code class="lang-c"><span class="token function">oct_droq_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
    <span class="token comment">//&#x4F20;&#x5165;&#x7684;&#x662F;q&#x53F7;</span>
    <span class="token comment">//&#x6253;&#x5370;&#x8DD1;&#x5728;smp_processor_id()&#x8FD9;&#x4E2A;&#x6838;&#x4E0A;, &#x521D;&#x59CB;&#x5316;&#x65F6;&#x7ED1;&#x5B9A;&#x8FC7;&#x7684;</span>
    <span class="token comment">//&#x5982;&#x679C;&#x6CA1;&#x6709;stop, &#x6CA1;&#x6709;signal, &#x5E95;&#x4E0B;&#x662F;&#x7528;kthread_should_stop()&#x68C0;&#x67E5;signal&#x7684;</span>
    <span class="token comment">//&#x5168;&#x90E8;&#x7684;&#x5E72;&#x6D3B;&#x4E3B;&#x4F53;&#x5728;&#x8FD9;&#x4E2A;&#x5FAA;&#x73AF;&#x91CC;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>droq<span class="token operator">-&gt;</span>stop_thread <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">cavium_kthread_signalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">cavium_atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>pkts_pending<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">//&#x5E72;&#x6D3B;&#x7684;&#x4E3B;&#x4F53;</span>
            <span class="token function">octeon_droq_process_packets</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>oct_dev<span class="token punctuation">,</span> droq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//pkts_pending&#x5C31;&#x662F;&#x5F85;&#x5904;&#x7406;&#x7684;&#x62A5;&#x6587;&#x6570;</span>
                pkt_count <span class="token operator">=</span> <span class="token function">cavium_atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>pkts_pending<span class="token punctuation">)</span><span class="token punctuation">;</span>    
                <span class="token comment">//&#x4F55;&#x4E3A;&#x5FEB;&#x8F6C;? &#x597D;&#x50CF;&#x662F;&#x8C03;&#x4E86;octeon_register_droq_ops()&#x6CE8;&#x518C;&#x7684;, base&#x91CC;&#x9762;&#x6CA1;&#x4EBA;&#x8C03;; nic&#x6A21;&#x5757;&#x91CC;&#x9762;&#x7528;&#x5230;&#x4E86;</span>
                <span class="token keyword">if</span> droq<span class="token operator">-&gt;</span>fastpath_on
                    pkts_processed <span class="token operator">=</span> <span class="token function">octeon_droq_fast_process_packets</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> droq<span class="token punctuation">,</span> pkt_count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x8981;&#x4E0D;&#x8981;&#x5173;&#x6CE8;&#x4E00;&#x4E0B;?</span>
                <span class="token keyword">else</span>
                <span class="token comment">//&#x5982;&#x679C;&#x5B9A;&#x4E49;&#x4E86;ETHERPCI, &#x5E94;&#x8BE5;&#x6CA1;&#x6709;&#x5427;?</span>
                    <span class="token function">octeon_droq_drop_packets</span><span class="token punctuation">(</span>droq<span class="token punctuation">,</span> pkt_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//&#x5E94;&#x8BE5;&#x662F;&#x4E0B;&#x9762;&#x7684;&#x5206;&#x652F;</span>
                    pkts_processed <span class="token operator">=</span> <span class="token function">octeon_droq_slow_process_packets</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> droq<span class="token punctuation">,</span> pkt_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span><span class="token punctuation">(</span>pkt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> pkt <span class="token operator">&lt;</span> pkt_count<span class="token punctuation">;</span> pkt<span class="token operator">++</span><span class="token punctuation">)</span> 
                            info <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>info_list<span class="token punctuation">[</span>droq<span class="token operator">-&gt;</span>host_read_index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x4ECE;&#x4E0A;&#x6B21;&#x7684;&#x5730;&#x65B9;&#x5F00;&#x59CB;, &#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;G4</span>
                            resp_hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_resp_hdr_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>info<span class="token operator">-&gt;</span>resp_hdr<span class="token punctuation">;</span> <span class="token comment">//&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;G41</span>
                            <span class="token function">octeon_swap_8B_data</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>info<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//&#x8FD9;&#x91CC;&#x6709;dispatch</span>
                            buf_cnt <span class="token operator">=</span> <span class="token function">octeon_droq_dispatch_pkt</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> droq<span class="token punctuation">,</span> resp_hdr<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">//&#x6839;&#x636E;buffer_size&#x5F97;&#x5230;buffer count, &#x56E0;&#x4E3A;&#x6BCF;&#x4E2A;recvbuf&#x90FD;&#x662F;&#x56FA;&#x5B9A;&#x5927;&#x5C0F;, &#x800C;buffer size&#x53EF;&#x4EE5;&#x5F88;&#x5927;</span>
                                cnt <span class="token operator">=</span> <span class="token function">octeon_droq_get_bufcount</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>buffer_size<span class="token punctuation">,</span> info<span class="token operator">-&gt;</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">//&#x6839;&#x636E;opcode&#x5F97;&#x5230;&#x5206;&#x53D1;&#x51FD;&#x6570;, &#x662F;octeon_register_dispatch_fn()&#x6CE8;&#x518C;&#x7684;, &#x89C1;A181</span>
                                disp_fn <span class="token operator">=</span> <span class="token function">octeon_get_dispatch</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span>resp_hdr<span class="token operator">-&gt;</span>opcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token comment">//&#x5728;octeon_dev-&gt;dispatch.dlist[idx]&#x91CC;&#x9762;(&#x6CE8;&#x610F;&#x8FD9;&#x53EF;&#x80FD;&#x662F;&#x4E2A;&#x94FE;&#x8868;), &#x4F9D;&#x6B21;&#x5339;&#x914D;opcode;&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;J</span>
                                <span class="token comment">//&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x53EA;&#x6DFB;&#x52A0;droq-&gt;dispatch_list&#x8282;&#x70B9;, &#x89C1;A182, &#x771F;&#x6B63;&#x5904;&#x7406;&#x8FD9;&#x4E2A;&#x94FE;&#x8868;&#x5728;&#x4E0B;&#x9762;</span>
                                <span class="token comment">//&#x8FD9;&#x91CC;&#x5B9E;&#x9645;&#x4E0A;&#x5DF2;&#x7ECF;&#x4ECE;&quot;&#x5E95;&#x5C42;&#x9A71;&#x52A8;&quot;&#x6536;&#x5305;&#x5C42;, &#x4E0A;&#x4EA4;&#x5230;&#x5206;&#x53D1;&#x5C42;&#x5904;&#x7406;&#x4E86;</span>
                                rinfo <span class="token operator">=</span> <span class="token function">octeon_create_recv_info</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> droq<span class="token punctuation">,</span> cnt<span class="token punctuation">,</span> droq<span class="token operator">-&gt;</span>host_read_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                rdisp<span class="token operator">-&gt;</span>rinfo    <span class="token operator">=</span> rinfo<span class="token punctuation">;</span>
                                rdisp<span class="token operator">-&gt;</span>disp_fn  <span class="token operator">=</span> disp_fn<span class="token punctuation">;</span>
                                <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>rinfo<span class="token operator">-&gt;</span>recv_pkt<span class="token operator">-&gt;</span>resp_hdr<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>resp_hdr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token function">cavium_list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rdisp<span class="token operator">-&gt;</span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>dispatch_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">/*&#x4E0A;&#x9762;&#x5DF2;&#x7ECF;dispatch&#x4E86;, &#x4E0D;&#x7BA1;&#x662F;&#x4E0D;&#x662F;&#x6709;&#x4EBA;&#x5728;&#x5904;&#x7406;&#x8FD9;&#x4E9B;package, &#x5C06;&#x6765;&#x603B;&#x662F;&#x4F1A;&#x88AB;&#x5904;&#x7406;&#x548C;&#x56DE;&#x6536;
                            **&#x8FD9;&#x91CC;&#x628A;refill_count&#x52A0;&#x4E0A;&#x53BB;, &#x8BF4;&#x660E;&#x8BE5;&#x7533;&#x8BF7;&#x65B0;&#x7684;buf&#x4E86;
                            */</span>
                            droq<span class="token operator">-&gt;</span>refill_count <span class="token operator">+=</span> buf_cnt<span class="token punctuation">;</span>
                            <span class="token comment">//&#x4E0B;&#x9762;&#x5224;&#x65AD;&#x662F;&#x5426;pkt&#x592A;&#x591A;, &#x8981;&#x4E22;&#x5F03;, &#x548C;droq-&gt;pkts_per_intr&#x914D;&#x7F6E;&#x6709;&#x5173;</span>
                            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>drop_on_max<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pkts_to_process <span class="token operator">-</span> pkt<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token function">octeon_droq_drop_packets</span><span class="token punctuation">(</span>droq<span class="token punctuation">,</span> <span class="token punctuation">(</span>pkts_to_process <span class="token operator">-</span> pkt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                droq<span class="token operator">-&gt;</span>stats<span class="token punctuation">.</span>dropped_toomany <span class="token operator">+=</span> <span class="token punctuation">(</span>pkts_to_process <span class="token operator">-</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token comment">//&#x51CF;&#x6389;&#x5DF2;&#x5904;&#x7406;&#x7684;</span>
                <span class="token function">cavium_atomic_sub</span><span class="token punctuation">(</span>pkts_processed<span class="token punctuation">,</span> <span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>pkts_pending<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>refill_count <span class="token operator">&gt;=</span> droq<span class="token operator">-&gt;</span>refill_threshold<span class="token punctuation">)</span>
                    <span class="token comment">//&#x548C;A17&#x7C7B;&#x4F3C;, &#x90A3;&#x4E48;&#x5982;&#x679C;&#x6709;USE_DROQ_THREADS, &#x90A3;&#x53EF;&#x80FD;&#x4E0D;&#x9700;&#x8981;A17&#x4E86;</span>
                    desc_refilled <span class="token operator">=</span> <span class="token function">octeon_droq_refill</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> droq<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token comment">/*&#x63A5;&#x4E0B;&#x6765;&#x904D;&#x5386;droq-&gt;dispatch_list&#x94FE;&#x8868;, &#x5176;&#x4E2D;&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#x662F;, &#x8C03;&#x7528;&#x91CC;&#x9762;&#x7684;disp_fn
                **&#x8C03;&#x7528;&#x5B8C;&#x5373;&#x5220;&#x9664;
                **struct __dispatch {
                **    cavium_list_t          list;
                **    octeon_recv_info_t    *rinfo;
                **    octeon_dispatch_fn_t   disp_fn;
                **};
                */</span>
                <span class="token function">disp_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x4ECE;&#x8FD9;&#x5C31;&#x65AD;&#x4E86;???????????????&#x600E;&#x4E48;&#x518D;&#x5F80;&#x4E0A;&#x9762;&#x8D70;?????????, &#x8DDF;scatter&#x7684;DMA&#x53C8;&#x600E;&#x4E48;&#x8054;&#x7CFB;&#x8D77;&#x6765;?--&#x4E0D;&#x7528;&#x8054;&#x7CFB;&#x8D77;&#x6765;</span>
        <span class="token comment">//&#x5230;&#x8FD9;&#x91CC;&#x5185;&#x5C42;while&#x521A;&#x7ED3;&#x675F;, &#x7761;&#x7720;&#x7B49;&#x5F85;&#x65B0;&#x7684;pkts, &#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;&#x4F1A;&#x5524;&#x9192;</span>
        <span class="token function">cavium_sleep_atomic_cond</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>wc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>pkts_pending<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//&#x4EE5;&#x4E0B;&#x662F;&#x4E00;&#x4E2A;&#x5E38;&#x89C1;&#x7684;wait&#x5728;wait_queue&#x7684;&#x64CD;&#x4F5C;, &#x7B49;&#x5F85;droq-&gt;pkts_pending&#x4E0D;&#x4E3A;0</span>
            cavium_wait_entry      we<span class="token punctuation">;</span>
            <span class="token function">cavium_init_wait_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>we<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">cavium_add_to_waitq</span><span class="token punctuation">(</span>waitq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>we<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_INTERRUPTIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cavium_atomic_read</span><span class="token punctuation">(</span>pcond<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token function">cavium_remove_from_waitq</span><span class="token punctuation">(</span>waitq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>we<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="a181-octeonregisterdispatchfn-&#x6CE8;&#x518C;&#x6536;&#x5305;&#x5BF9;&#x5E94;&#x7684;opcode&#x51FD;&#x6570;"><a name="a181-octeonregisterdispatchfn-&#x6CE8;&#x518C;&#x6536;&#x5305;&#x5BF9;&#x5E94;&#x7684;opcode&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#a181-octeonregisterdispatchfn-&#x6CE8;&#x518C;&#x6536;&#x5305;&#x5BF9;&#x5E94;&#x7684;opcode&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>A181. octeon_register_dispatch_fn() &#x6CE8;&#x518C;&#x6536;&#x5305;&#x5BF9;&#x5E94;&#x7684;opcode&#x51FD;&#x6570;</h5>
<p>&#x6240;&#x6709;&#x7684;opcode&#x5728;&#x8FD9;&#x91CC;<code>components/driver/common/octeon-drv-opcodes.h</code>
&#x5728;&#x8FD9;&#x91CC;&#x8C03;&#x7528;</p>
<pre class="language-"><code class="lang-c"><span class="token function">octeon_setup_driver_dispatches</span><span class="token punctuation">(</span>oct_dev<span class="token operator">-&gt;</span>octeon_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x6CE8;&#x518C;&#x7684;CORE_DRV_ACTIVE_OP&#x5904;&#x7406;&#x51FD;&#x6570;, &#x4E3B;&#x8981;&#x4F5C;&#x7528;&#x662F;&#x6536;&#x5230;core OK&#x7684;&#x62A5;&#x6587;&#x540E;, &#x7F6E;oct-&gt;status&#x4E3A;OCT_DEV_CORE_OK</span>
    <span class="token function">octeon_register_dispatch_fn</span><span class="token punctuation">(</span>oct_id<span class="token punctuation">,</span> CORE_DRV_ACTIVE_OP<span class="token punctuation">,</span> octeon_core_drv_init<span class="token punctuation">,</span>
                                <span class="token function">get_octeon_device_ptr</span><span class="token punctuation">(</span>oct_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x53E6;&#x5916;&#x5728;<code>components/driver/host/test/kernel/droq_test/octeon_droq_test.c</code> &#x5185;&#x6838;&#x6D4B;&#x8BD5;&#x4EE3;&#x7801;&#x91CC;&#x9762;&#x4E5F;&#x6709;&#x6CE8;&#x518C;</p>
<pre class="language-"><code class="lang-c">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">octeon_register_dispatch_fn</span><span class="token punctuation">(</span>OCTEON_ID<span class="token punctuation">,</span> DROQ_PKT_OP1<span class="token punctuation">,</span> droq_test_dispatch<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">octeon_register_dispatch_fn</span><span class="token punctuation">(</span>OCTEON_ID<span class="token punctuation">,</span> DROQ_PKT_OP2<span class="token punctuation">,</span> droq_test_dispatch<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</code></pre>
<h5 id="a182-octeoncreaterecvinfo-&#x4ECE;&#x9A71;&#x52A8;&#x5C42;&#x5230;&#x5206;&#x53D1;&#x5C42;-&#x6BCF;&#x4E2A;&#x6765;&#x7684;&#x62A5;&#x6587;&#x90FD;&#x4F1A;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;"><a name="a182-octeoncreaterecvinfo-&#x4ECE;&#x9A71;&#x52A8;&#x5C42;&#x5230;&#x5206;&#x53D1;&#x5C42;-&#x6BCF;&#x4E2A;&#x6765;&#x7684;&#x62A5;&#x6587;&#x90FD;&#x4F1A;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;" class="anchor-navigation-ex-anchor" href="#a182-octeoncreaterecvinfo-&#x4ECE;&#x9A71;&#x52A8;&#x5C42;&#x5230;&#x5206;&#x53D1;&#x5C42;-&#x6BCF;&#x4E2A;&#x6765;&#x7684;&#x62A5;&#x6587;&#x90FD;&#x4F1A;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;"><i class="fa fa-link" aria-hidden="true"></i></a>A182. octeon_create_recv_info(), &#x4ECE;&#x9A71;&#x52A8;&#x5C42;&#x5230;&#x5206;&#x53D1;&#x5C42;, &#x6BCF;&#x4E2A;&#x6765;&#x7684;&#x62A5;&#x6587;&#x90FD;&#x4F1A;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;</h5>
<pre class="language-"><code class="lang-c"><span class="token comment">/** Receive Packet format used when dispatching output queue packets
    with non-raw opcodes.
    The received packet will be sent to the upper layers using this
    structure which is passed as a parameter to the dispatch function 
*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token comment">/**  Number of buffers in this received packet */</span>
   <span class="token class-name">uint16_t</span>               buffer_count<span class="token punctuation">;</span> 
  <span class="token comment">/** Id of the device that is sending the packet up */</span>
   <span class="token class-name">uint8_t</span>                octeon_id<span class="token punctuation">;</span>
  <span class="token comment">/** The type of buffer contained in the buffer ptr&apos;s for this recv pkt. */</span>
   <span class="token class-name">uint8_t</span>                buf_type<span class="token punctuation">;</span>
  <span class="token comment">/** Length of data in the packet buffer */</span>
   <span class="token class-name">uint32_t</span>               length<span class="token punctuation">;</span>
  <span class="token comment">/** The response header */</span>
   <span class="token class-name">octeon_resp_hdr_t</span>      resp_hdr<span class="token punctuation">;</span>
  <span class="token comment">/** Pointer to the OS-specific packet buffer */</span>
   <span class="token keyword">void</span>                  <span class="token operator">*</span>buffer_ptr<span class="token punctuation">[</span>MAX_RECV_BUFS<span class="token punctuation">]</span><span class="token punctuation">;</span> 
  <span class="token comment">/** Size of the buffers pointed to by ptr&apos;s in buffer_ptr */</span>
   <span class="token class-name">uint32_t</span>               buffer_size<span class="token punctuation">[</span>MAX_RECV_BUFS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">octeon_recv_pkt_t</span><span class="token punctuation">;</span>

<span class="token comment">/** The first parameter of a dispatch function.
    For a raw mode opcode, the driver dispatches with the device 
    pointer in this structure. 
    For non-raw mode opcode, the driver dispatches the recv_pkt_t
    created to contain the buffers with data received from Octeon.
    ---------------------
    |     *recv_pkt ----|---
    |-------------------|   |
    | 0 or more bytes   |   |
    | reserved by driver|   |
    |-------------------|&lt;-/
    | octeon_recv_pkt_t |
    |                   |
    |___________________|
*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span>                     <span class="token operator">*</span>rsvd<span class="token punctuation">;</span>
    <span class="token class-name">octeon_recv_pkt_t</span>        <span class="token operator">*</span>recv_pkt<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">octeon_recv_info_t</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">__dispatch</span> <span class="token punctuation">{</span>
    <span class="token class-name">cavium_list_t</span>          list<span class="token punctuation">;</span>
    <span class="token class-name">octeon_recv_info_t</span>    <span class="token operator">*</span>rinfo<span class="token punctuation">;</span>
    <span class="token class-name">octeon_dispatch_fn_t</span>   disp_fn<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-c"><span class="token function">octeon_create_recv_info</span><span class="token punctuation">(</span><span class="token class-name">octeon_device_t</span>  <span class="token operator">*</span>octeon_dev<span class="token punctuation">,</span>
                        <span class="token class-name">octeon_droq_t</span>    <span class="token operator">*</span>droq<span class="token punctuation">,</span>
                        <span class="token class-name">uint32_t</span>          buf_cnt<span class="token punctuation">,</span>
                        <span class="token class-name">uint32_t</span>          idx<span class="token punctuation">)</span>
   <span class="token comment">//&#x89C1;G4</span>
   <span class="token class-name">octeon_droq_info_t</span>    <span class="token operator">*</span>info<span class="token punctuation">;</span>
   <span class="token class-name">octeon_recv_pkt_t</span>     <span class="token operator">*</span>recv_pkt<span class="token punctuation">;</span> <span class="token comment">//&#x89C1;&#x4E0A;</span>
   <span class="token class-name">octeon_recv_info_t</span>    <span class="token operator">*</span>recv_info<span class="token punctuation">;</span> <span class="token comment">//&#x89C1;&#x4E0A;</span>
   <span class="token class-name">uint32_t</span>               i<span class="token punctuation">,</span> bytes_left<span class="token punctuation">;</span>

   info <span class="token operator">=</span> <span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>info_list<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
   recv_info <span class="token operator">=</span> <span class="token function">octeon_alloc_recv_info</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__dispatch</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//&#x4EE5;&#x4E0A;&#x4E24;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x7684;size&#x52A0;&#x8D77;&#x6765;&#x518D;&#x52A0;extra_bytes, &#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x91CC;&#x8981;&#x7528;DMA&#x7684;&#x5185;&#x5B58;?????</span>
       buf <span class="token operator">=</span> <span class="token function">cavium_malloc_dma</span><span class="token punctuation">(</span>OCT_RECV_PKT_SIZE <span class="token operator">+</span> OCT_RECV_INFO_SIZE <span class="token operator">+</span> extra_bytes<span class="token punctuation">,</span> __CAVIUM_MEM_ATOMIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
       recv_info <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_recv_info_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>
       recv_info<span class="token operator">-&gt;</span>recv_pkt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_recv_pkt_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> OCT_RECV_INFO_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
       recv_info<span class="token operator">-&gt;</span>rsvd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>extra_bytes<span class="token punctuation">)</span>
           recv_info<span class="token operator">-&gt;</span>rsvd <span class="token operator">=</span> buf <span class="token operator">+</span> OCT_RECV_INFO_SIZE <span class="token operator">+</span> OCT_RECV_PKT_SIZE<span class="token punctuation">;</span>
   recv_pkt <span class="token operator">=</span> recv_info<span class="token operator">-&gt;</span>recv_pkt<span class="token punctuation">;</span>

   recv_pkt<span class="token operator">-&gt;</span>resp_hdr      <span class="token operator">=</span>  info<span class="token operator">-&gt;</span>resp_hdr<span class="token punctuation">;</span>
   recv_pkt<span class="token operator">-&gt;</span>length        <span class="token operator">=</span>  info<span class="token operator">-&gt;</span>length<span class="token punctuation">;</span>
   recv_pkt<span class="token operator">-&gt;</span>buffer_count  <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span>buf_cnt<span class="token punctuation">;</span>
   recv_pkt<span class="token operator">-&gt;</span>octeon_id     <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span>octeon_dev<span class="token operator">-&gt;</span>octeon_id<span class="token punctuation">;</span>
   recv_pkt<span class="token operator">-&gt;</span>buf_type      <span class="token operator">=</span> OCT_RECV_BUF_TYPE_2<span class="token punctuation">;</span>

   i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   bytes_left <span class="token operator">=</span> info<span class="token operator">-&gt;</span>length<span class="token punctuation">;</span>
   <span class="token comment">//&#x4E00;&#x4E2A;&#x5927;&#x62A5;&#x6587;&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x4E2A;buf_cnt</span>
   <span class="token keyword">while</span><span class="token punctuation">(</span>buf_cnt<span class="token punctuation">)</span>
      <span class="token function">octeon_pci_unmap_single</span><span class="token punctuation">(</span>octeon_dev<span class="token operator">-&gt;</span>pci_dev<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>droq<span class="token operator">-&gt;</span>desc_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer_ptr<span class="token punctuation">,</span> droq<span class="token operator">-&gt;</span>buffer_size<span class="token punctuation">,</span> CAVIUM_PCI_DMA_FROMDEVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>

      recv_pkt<span class="token operator">-&gt;</span>buffer_size<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span>
      <span class="token punctuation">(</span>bytes_left <span class="token operator">&gt;=</span> droq<span class="token operator">-&gt;</span>buffer_size<span class="token punctuation">)</span><span class="token operator">?</span>droq<span class="token operator">-&gt;</span>buffer_size<span class="token operator">:</span> bytes_left<span class="token punctuation">;</span>
      <span class="token comment">//&#x8FD9;&#x91CC;&#x4E0D;&#x662F;&#x628A;buffer&#x62F7;&#x8D1D;&#x8FC7;&#x53BB;, &#x800C;&#x53EA;&#x662F;&#x586B;&#x6307;&#x9488;, &#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x628A;buffer&#x632A;&#x4E2A;&#x4F4D;&#x7F6E;&#x5462;? </span>
      <span class="token comment">//&#x5176;&#x5B9E;&#x8FD9;&#x91CC;&#x662F;&#x4E2A;&#x5206;&#x5C42;, droq-&gt;recv_buf_list[idx].buffer&#x662F;&#x4E0B;&#x5C42;&#x7684;buffer --&#x5C31;&#x662F;&#x7528;skb&#x7533;&#x8BF7;&#x7684;buffer, &#x5BF9;&#x5E94;&#x786C;&#x4EF6;DMA&#x7684;output buffer</span>
      <span class="token comment">//recv_pkt-&gt;buffer_ptr[i]&#x662F;&#x4E0A;&#x5C42;&#x7684;buffer, &#x4F46;&#x4ECE;&#x5E95;&#x5C42;&#x5230;&#x4E0A;&#x5C42;&#x4E0D;&#x662F;buffer&#x62F7;&#x8D1D;, &#x800C;&#x53EA;&#x662F;&#x6307;&#x9488;&#x8F6C;&#x79FB;</span>
      <span class="token comment">//&#x90A3;&#x4E48;&#x6B64;&#x65F6;, &#x5E95;&#x5C42;&#x7684;buffer&#x5C31;&#x53EF;&#x4EE5;&#x91CD;&#x65B0;&#x7533;&#x8BF7;&#x4E86;.</span>
      recv_pkt<span class="token operator">-&gt;</span>buffer_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token operator">=</span> droq<span class="token operator">-&gt;</span>recv_buf_list<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer<span class="token punctuation">;</span>
      <span class="token comment">//&#x5E95;&#x5C42;&#x7684;buffer&#x5DF2;&#x7ECF;&#x8F6C;&#x79FB;&#x7ED9;&#x4E0A;&#x5C42;&#x4E86;; &#x8FD9;&#x91CC;&#x8D4B;&#x503C;0, &#x5728;output buffer refill&#x73AF;&#x8282;&#x91CD;&#x65B0;&#x7533;&#x8BF7;buffer,&#x53C2;&#x8003;A171</span>
      droq<span class="token operator">-&gt;</span>recv_buf_list<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token function">INCR_INDEX_BY1</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> droq<span class="token operator">-&gt;</span>max_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
      bytes_left <span class="token operator">-=</span> droq<span class="token operator">-&gt;</span>buffer_size<span class="token punctuation">;</span>
      i<span class="token operator">++</span><span class="token punctuation">;</span> buf_cnt<span class="token operator">--</span><span class="token punctuation">;</span>

   <span class="token keyword">return</span> recv_info<span class="token punctuation">;</span>
</code></pre>
<h4 id="a19-octeondroqbh"><a name="a19-octeondroqbh" class="anchor-navigation-ex-anchor" href="#a19-octeondroqbh"><i class="fa fa-link" aria-hidden="true"></i></a>A19. octeon_droq_bh</h4>
<pre class="language-"><code class="lang-c"><span class="token function">octeon_droq_bh</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span>  pdev<span class="token punctuation">)</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>q_no <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> q_no <span class="token operator">&lt;</span> oct<span class="token operator">-&gt;</span>num_oqs<span class="token punctuation">;</span> q_no<span class="token operator">++</span><span class="token punctuation">)</span>
        reschedule <span class="token operator">|=</span> <span class="token function">octeon_droq_process_packets</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> oct<span class="token operator">-&gt;</span>droq<span class="token punctuation">[</span>q_no<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x53C2;&#x8003;A18</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>reschedule<span class="token punctuation">)</span>
        <span class="token comment">//&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7528;&#x6765;&#x89E6;&#x53D1;tasklet, &#x4E00;&#x822C;&#x4F1A;&#x5728;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;&#x8C03;</span>
        <span class="token function">cavium_tasklet_schedule</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oct<span class="token operator">-&gt;</span>droq_tasklet<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="b-octpollthread-&#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;"><a name="b-octpollthread-&#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;" class="anchor-navigation-ex-anchor" href="#b-octpollthread-&#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a>5.2. B. oct_poll_thread, &#x6240;&#x6709;&#x8BBE;&#x5907;&#x548C;&#x56DE;&#x8C03;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;</h2>
<pre class="language-"><code class="lang-c"><span class="token function">oct_poll_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token operator">!</span><span class="token function">cavium_kthread_signalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//&#x5BF9;&#x6BCF;&#x4E2A;octeon&#x8BBE;&#x5907;</span>
        <span class="token function">oct_process_poll_list</span><span class="token punctuation">(</span><span class="token function">get_octeon_device</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            poll_list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_poll_fn_node_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>oct<span class="token operator">-&gt;</span>poll_list<span class="token punctuation">;</span>
            <span class="token comment">//&#x5BF9;poll_list&#x91CC;&#x9762;&#x6700;&#x591A;64&#x4E2A;fn&#x4F9D;&#x6B21;&#x8C03;&#x7528;</span>
            <span class="token comment">//&#x8FD9;&#x91CC;&#x7684;&#x51FD;&#x6570;&#x7531;octeon_register_poll_fn()&#x6CE8;&#x518C;</span>
            <span class="token comment">//&#x6839;&#x636E;&#x524D;&#x9762;&#x5206;&#x6790;, &#x5DF2;&#x7ECF;&#x6CE8;&#x518C;&#x7684;&#x51FD;&#x6570;&#x6709;:A13 A14 A15 A16 A17</span>
            n <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_poll_fn_node_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>poll_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> n<span class="token operator">-&gt;</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>oct<span class="token punctuation">,</span> n<span class="token operator">-&gt;</span>fn_arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">cavium_sleep_timeout</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1&#x4E2A;jiffy</span>
            <span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_INTERRUPTIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token function">schedule_timeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>              
            <span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="c-octeonfops-&#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl"><a name="c-octeonfops-&#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl" class="anchor-navigation-ex-anchor" href="#c-octeonfops-&#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl"><i class="fa fa-link" aria-hidden="true"></i></a>5.3. C. octeon_fops: &#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;ioctl</h2>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> octeon_fops <span class="token operator">=</span>
<span class="token punctuation">{</span>
   open<span class="token operator">:</span>      octeon_open<span class="token punctuation">,</span>
   release<span class="token operator">:</span>   octeon_release<span class="token punctuation">,</span>
   read<span class="token operator">:</span>      <span class="token constant">NULL</span><span class="token punctuation">,</span>
   write<span class="token operator">:</span>     <span class="token constant">NULL</span><span class="token punctuation">,</span>
   ioctl<span class="token operator">:</span>     octeon_ioctl<span class="token punctuation">,</span> <span class="token comment">//&#x89C1;C1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LINUX_VERSION_CODE <span class="token operator">&gt;</span> <span class="token function">KERNEL_VERSION</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span></span></span>
   unlocked_ioctl<span class="token operator">:</span> octeon_unlocked_ioctl<span class="token punctuation">,</span>
   compat_ioctl<span class="token operator">:</span>  octeon_compat_ioctl<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
   mmap<span class="token operator">:</span>      <span class="token constant">NULL</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="c1-octeonioctl"><a name="c1-octeonioctl" class="anchor-navigation-ex-anchor" href="#c1-octeonioctl"><i class="fa fa-link" aria-hidden="true"></i></a>5.3.1. C1. octeon_ioctl</h3>
<pre class="language-"><code class="lang-c"><span class="token keyword">int</span> <span class="token function">octeon_ioctl</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span>   <span class="token operator">*</span>inode<span class="token punctuation">,</span>
                  <span class="token keyword">struct</span> <span class="token class-name">file</span>    <span class="token operator">*</span>file<span class="token punctuation">,</span> 
                  <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   cmd<span class="token punctuation">,</span>
                  <span class="token keyword">unsigned</span> <span class="token keyword">long</span>  arg<span class="token punctuation">)</span>
   <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>  <span class="token punctuation">{</span>
      <span class="token keyword">case</span> IOCTL_OCTEON_HOT_RESET<span class="token operator">:</span>
           retval <span class="token operator">=</span> <span class="token function">octeon_ioctl_hot_reset</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//arg&#x662F;octeon_rw_reg_buf_t </span>
        <span class="token comment">//&#x5148;copy_from_user</span>
        <span class="token function">cavium_copy_in</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw_buf<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> OCTEON_RW_REG_BUF_SIZE<span class="token punctuation">)</span>
        <span class="token comment">//&#x5F97;&#x5230;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;</span>
        oct_dev <span class="token operator">=</span> <span class="token function">get_octeon_device</span><span class="token punctuation">(</span>rw_buf<span class="token punctuation">.</span>oct_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">octeon_hot_reset</span><span class="token punctuation">(</span>oct_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/*&#x6211;&#x89C9;&#x5F97;&#x4E00;&#x4E2A;&#x5178;&#x578B;&#x7684;&#x91CD;&#x542F;&#x67B6;&#x6784;&#x5E94;&#x8BE5;&#x662F;&#x91CD;&#x542F;&#x51FD;&#x6570;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x53D8;&#x91CF;
            **&#x771F;&#x6B63;&#x5E72;&#x6D3B;&#x7684;&#x4EFB;&#x52A1;&#x6216;&#x8D44;&#x6E90;&#x4E3B;&#x4F53;&#x5728;&#x4E3B;&#x5FAA;&#x73AF;&#x91CC;&#x4E3B;&#x52A8;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x88AB;stop&#x4E86;
            **&#x4ECE;&#x800C;&#x5E72;&#x51C0;&#x7684;&#x6E05;&#x9664;&#x8D44;&#x6E90;
            **&#x8FD9;&#x6837;&#x7684;&#x597D;&#x5904;&#x662F;&#x529F;&#x80FD;&#x4EE3;&#x7801;&#x96C6;&#x4E2D;&#x5728;&#x4E00;&#x8D77;&#x4F7F;&#x7528;&#x548C;&#x91CA;&#x653E;
            **&#x800C;&#x4E0D;&#x7528;&#x628A;&#x91CA;&#x653E;&#x8D44;&#x6E90;&#x7684;&#x51FD;&#x6570;&#x5168;&#x90E8;&#x96C6;&#x4E2D;&#x5728;&#x53D1;&#x8D77;stop&#x7684;&#x51FD;&#x6570;&#x91CC;&#x6267;&#x884C;
            */</span>
            <span class="token comment">//&#x8FD9;&#x91CC;&#x9762;&#x4E5F;&#x662F;, &#x6839;&#x636E;&#x5F53;&#x524D;&#x7684;&#x72B6;&#x6001;&#x5B57;&#x6765;&#x5E72;&#x6D3B;.</span>
            <span class="token comment">//&#x603B;&#x4F53;&#x4E0A;&#x662F;&#x53D1;stop&#x547D;&#x4EE4;&#x7ED9;octeon,&#x7B49;&#x5F85;&#x4E00;&#x4E9B;&#x6D3B;&#x5E72;&#x5B8C;, &#x590D;&#x4F4D;&#x4E00;&#x4E9B;&#x53D8;&#x91CF;</span>
            <span class="token comment">//&#x6700;&#x540E;&#x6CE8;&#x518C;oct_poll_module_starter()&#x51FD;&#x6570;&#x5230;poll&#x8FDB;&#x7A0B;, &#x89C1;C11</span>

           <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> IOCTL_OCTEON_SEND_REQUEST<span class="token operator">:</span>
           retval <span class="token operator">=</span> <span class="token function">octeon_ioctl_send_request</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x89C1;C12</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> IOCTL_OCTEON_QUERY_REQUEST<span class="token operator">:</span>
           retval <span class="token operator">=</span> <span class="token function">octeon_ioctl_query_request</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span> 
               <span class="token comment">//&#x67E5;&#x8BE2;, &#x7ED3;&#x679C;&#x5230;octeon_query_request_t   </span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> IOCTL_OCTEON_STATS<span class="token operator">:</span>
           retval <span class="token operator">=</span> <span class="token function">octeon_ioctl_stats</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> IOCTL_OCTEON_READ32<span class="token operator">:</span>
      <span class="token keyword">case</span> IOCTL_OCTEON_READ16<span class="token operator">:</span>
      <span class="token keyword">case</span> IOCTL_OCTEON_READ8<span class="token operator">:</span>
      <span class="token keyword">case</span> IOCTL_OCTEON_READ_PCI_CONFIG<span class="token operator">:</span>
      <span class="token keyword">case</span> IOCTL_OCTEON_WIN_READ<span class="token operator">:</span>
           retval <span class="token operator">=</span> <span class="token function">octeon_ioctl_read</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>


      <span class="token keyword">case</span> IOCTL_OCTEON_WRITE32<span class="token operator">:</span>
      <span class="token keyword">case</span> IOCTL_OCTEON_WRITE16<span class="token operator">:</span>
      <span class="token keyword">case</span> IOCTL_OCTEON_WRITE8<span class="token operator">:</span>
      <span class="token keyword">case</span> IOCTL_OCTEON_WRITE_PCI_CONFIG<span class="token operator">:</span>
      <span class="token keyword">case</span> IOCTL_OCTEON_WIN_WRITE<span class="token operator">:</span>
           retval <span class="token operator">=</span> <span class="token function">octeon_ioctl_write</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> IOCTL_OCTEON_CORE_MEM_READ<span class="token operator">:</span>
           retval <span class="token operator">=</span> <span class="token function">octeon_ioctl_read_core_mem</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> IOCTL_OCTEON_CORE_MEM_WRITE<span class="token operator">:</span>
           retval <span class="token operator">=</span> <span class="token function">octeon_ioctl_write_core_mem</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> IOCTL_OCTEON_GET_DEV_COUNT<span class="token operator">:</span>
           retval <span class="token operator">=</span> <span class="token function">octeon_ioctl_get_dev_count</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> IOCTL_OCTEON_GET_MAPPING_INFO<span class="token operator">:</span> 
           retval <span class="token operator">=</span> <span class="token function">octeon_ioctl_get_mapping_info</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">default</span><span class="token operator">:</span>
           <span class="token function">cavium_error</span><span class="token punctuation">(</span><span class="token string">&quot;octeon_ioctl: Unknown ioctl command\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           retval <span class="token operator">=</span> <span class="token operator">-</span>ENOTTY<span class="token punctuation">;</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>  <span class="token comment">/* switch */</span>
</code></pre>
<h4 id="c11octpollmodulestarter"><a name="c11octpollmodulestarter" class="anchor-navigation-ex-anchor" href="#c11octpollmodulestarter"><i class="fa fa-link" aria-hidden="true"></i></a>C11.oct_poll_module_starter()</h4>
<h4 id="c12octeonioctlsendrequest"><a name="c12octeonioctlsendrequest" class="anchor-navigation-ex-anchor" href="#c12octeonioctlsendrequest"><i class="fa fa-link" aria-hidden="true"></i></a>C12.octeon_ioctl_send_request</h4>
<pre class="language-"><code class="lang-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        <span class="token comment">/** wait channel head for this request. */</span>
        cavium_wait_channel   wait_head<span class="token punctuation">;</span>
        <span class="token comment">/** completion condition */</span>
        <span class="token keyword">int</span>                   condition<span class="token punctuation">;</span>
        <span class="token comment">/** Status of request. Used in NORESPONSE completion. */</span>
        <span class="token class-name">octeon_req_status_t</span>   status<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">octeon_user_req_complete_t</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-c">copy buffer &#x65E2;&#x7BA1;input&#x53C8;&#x7BA1;ouput<span class="token punctuation">,</span> &#x8FD9;&#x4E9B;&#x662F;&#x5728;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#x7684;&#x62F7;&#x8D1D;
<span class="token comment">/**  This structure is used to copy the response for a request
     from kernel space to user space.
*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token comment">/** The kernel Input buffer. */</span>
  <span class="token class-name">uint8_t</span>                    <span class="token operator">*</span>kern_inptr<span class="token punctuation">;</span>
  <span class="token comment">/** Size of the kernel output buffer. */</span>
   <span class="token class-name">uint32_t</span>                   kern_outsize<span class="token punctuation">;</span>
  <span class="token comment">/** Address of the kernel output buffer. */</span>
   <span class="token class-name">uint8_t</span>                   <span class="token operator">*</span>kern_outptr<span class="token punctuation">;</span>
  <span class="token comment">/** Number of user space buffers */</span>
   <span class="token class-name">uint32_t</span>                   user_bufcnt<span class="token punctuation">;</span>
  <span class="token comment">/** Address of user-space buffers. */</span>
   <span class="token class-name">uint8_t</span>                   <span class="token operator">*</span>user_ptr<span class="token punctuation">[</span>MAX_BUFCNT<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/** Size of each user-space buffer. */</span>
   <span class="token class-name">uint32_t</span>                   user_size<span class="token punctuation">[</span>MAX_BUFCNT<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/** The octeon device from which response is awaited. */</span>
  <span class="token class-name">octeon_device_t</span>            <span class="token operator">*</span>octeon_dev<span class="token punctuation">;</span>
  <span class="token comment">/** Wait queue and completion flag for user request. */</span>
  <span class="token class-name">octeon_user_req_complete_t</span> <span class="token operator">*</span>comp<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token class-name">octeon_copy_buffer_t</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-c"><span class="token keyword">int</span> <span class="token function">octeon_ioctl_send_request</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span>   cmd<span class="token punctuation">,</span>
                              <span class="token keyword">void</span>          <span class="token operator">*</span>arg<span class="token punctuation">)</span>
    <span class="token comment">//&#x4ECE;&#x5185;&#x6838;&#x65B0;&#x7533;&#x8BF7;octeon_soft_request_t&#x7ED3;&#x6784;, &#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x89C1;app&#x7BC7; &#x91CD;&#x8981;&#x7ED3;&#x6784;&#x4F53;</span>
    soft_req <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_soft_request_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">cavium_alloc_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> OCT_SOFT_REQUEST_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x628A;&#x7528;&#x6237;&#x6001;&#x7684;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x62F7;&#x8FDB;&#x53BB;</span>
    <span class="token function">cavium_copy_in</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> OCT_SOFT_REQUEST_SIZE<span class="token punctuation">)</span>
    <span class="token comment">//&#x540C;&#x6837;&#x7684;&#x65B9;&#x6CD5;&#x628A;&#x7528;&#x6237;&#x7684;octeon_request_info_t&#x62F7;&#x8FDB;&#x53BB;</span>
    req_info <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_request_info_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">cavium_alloc_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> OCT_REQ_INFO_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cavium_copy_in</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>req_info<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>user_req_info<span class="token punctuation">,</span> OCT_USER_REQ_INFO_SIZE<span class="token punctuation">)</span>

    resp_order <span class="token operator">=</span> <span class="token function">GET_SOFT_REQ_RESP_ORDER</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    resp_mode  <span class="token operator">=</span> <span class="token function">GET_SOFT_REQ_RESP_MODE</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dma_mode   <span class="token operator">=</span> <span class="token function">GET_SOFT_REQ_DMA_MODE</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x83B7;&#x5F97;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;</span>
    octeon_dev <span class="token operator">=</span> <span class="token function">get_octeon_device</span><span class="token punctuation">(</span><span class="token function">GET_REQ_INFO_OCTEON_ID</span><span class="token punctuation">(</span>req_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>resp_mode <span class="token operator">==</span> OCTEON_RESP_BLOCKING<span class="token punctuation">)</span> 
        <span class="token comment">//&#x56E0;&#x4E3A;block&#x7684;&#x8BF7;&#x6C42;&#x8981;wait&#x5728;&#x4E00;&#x4E2A;&#x7B49;&#x5F85;&#x961F;&#x5217;&#x91CC;, &#x5728;linux&#x4E0B;&#x662F;wait_queue_head_t</span>
        <span class="token comment">//comp&#x662F;octeon_user_req_complete_t, &#x89C1;&#x4E0A;&#x9762;&#x7ED3;&#x6784;&#x4F53;</span>
        comp <span class="token operator">=</span> <span class="token function">octeon_alloc_user_req_complete</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//&#x5F00;&#x59CB;&#x62F7;&#x8D1D;input&#x6570;&#x636E;&#x7684;buf, &#x603B;&#x7684;&#x539F;&#x5219;&#x662F;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x7684;buf&#x8003;&#x5230;&#x5185;&#x6838;&#x8FDE;&#x7EED;&#x7A7A;&#x95F4;&#x7684;buf</span>
    <span class="token comment">//&#x5E76;&#x66FF;&#x6362;&#x76F8;&#x5E94;&#x7684;&#x6307;&#x9488;&#x5730;&#x5740;(&#x4ECE;&#x6307;&#x5411;user&#x7684;&#x5730;&#x5740;&#x53D8;&#x4E3A;&#x6307;&#x5411;&#x65B0;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x6838;&#x5730;&#x5740;)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>cnt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dma_mode <span class="token operator">==</span> OCTEON_DMA_DIRECT<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>dma_mode <span class="token operator">==</span> OCTEON_DMA_SCATTER<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">//gather&#x6A21;&#x5F0F;&#x4E0B;, &#x7528;inbuf.ptr[(idx)].addr&#x8FD9;&#x4E2A;&#x6570;&#x7EC4;</span>
            <span class="token comment">//&#x975E;gather&#x6A21;&#x5F0F;&#x4E0B;, &#x53EA;&#x7528;inbuf.ptr[0]</span>
            retval <span class="token operator">=</span> <span class="token function">octeon_copy_input_dma_buffers</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> soft_req<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x89C1;C121</span>
        <span class="token keyword">else</span>
            retval <span class="token operator">=</span> <span class="token function">octeon_copy_input_dma_buffers</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> soft_req<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> free_req_info<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">SOFT_REQ_INBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//&#x7533;&#x8BF7;octeon_copy_buffer_t&#x7684;buffer, &#x7528;&#x6765;&#x628A;response&#x62F7;&#x56DE;user&#x7A7A;&#x95F4;</span>
    <span class="token comment">//copy_buf&#x662F;octeon_copy_buffer_t, &#x89C1;&#x4E0A;&#x9762;&#x7ED3;&#x6784;&#x4F53;</span>
    copy_buf <span class="token operator">=</span> <span class="token function">cavium_alloc_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">octeon_copy_buffer_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x8FD9;&#x91CC;&#x53EA;&#x7528;0&#x662F;&#x56E0;&#x4E3A;&#x4ECE;&#x7528;&#x6237;&#x6001;&#x62F7;&#x8D1D;&#x5230;&#x5185;&#x6838;&#x6001;&#x53D8;&#x6210;&#x4E86;&#x4E00;&#x4E2A;&#x6574;&#x7684;buffer</span>
    copy_buf<span class="token operator">-&gt;</span>kern_inptr <span class="token operator">=</span> <span class="token function">SOFT_REQ_INBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    copy_buf<span class="token operator">-&gt;</span>octeon_dev <span class="token operator">=</span> octeon_dev<span class="token punctuation">;</span>
    copy_buf<span class="token operator">-&gt;</span>comp       <span class="token operator">=</span> comp<span class="token punctuation">;</span>
    <span class="token comment">//noresponse&#x6A21;&#x5F0F;&#x4E0B;, &#x4E0D;&#x7528;&#x7533;&#x8BF7;output buf</span>
        soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>cnt     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">SOFT_REQ_OUTBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        copy_buf<span class="token operator">-&gt;</span>user_bufcnt    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x4EE5;&#x4E0B;&#x662F;response&#x6A21;&#x5F0F;, &#x7533;&#x8BF7;&#x5728;&#x5185;&#x6838;&#x6001;&#x7528;&#x7684;response buffer</span>
        retval <span class="token operator">=</span> <span class="token function">octeon_create_output_dma_buffers</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> soft_req<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x89C1;C122</span>
    <span class="token comment">//&#x5B8C;&#x4E8B;&#x8FD8;&#x5F97;&#x62F7;&#x56DE;&#x7528;&#x6237;&#x6001;, &#x95EE;&#x9898;&#x662F;&#x8C01;&#x8C03;&#x4E86;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5462;? --&#x88AB;&#x6CE8;&#x91CA;&#x6389;&#x7684;A16&#x548C;release_soft_instr(), A14&#x548C;A15&#x90FD;&#x4F1A;&#x8C03;</span>
    <span class="token function">SET_REQ_INFO_CALLBACK</span><span class="token punctuation">(</span>req_info<span class="token punctuation">,</span> octeon_copy_user_buffer<span class="token punctuation">,</span> copy_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//&#x4E0B;&#x9762;&#x662F;octeon_copy_user_buffer()&#x505A;&#x7684;&#x4E8B;&#x60C5;</span>
                    <span class="token comment">//1. &#x8FD9;&#x4E2A;request&#x662F;&#x963B;&#x585E;&#x7684;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>copy_buf<span class="token operator">-&gt;</span>comp<span class="token punctuation">)</span>
                        copy_buf<span class="token operator">-&gt;</span>comp<span class="token operator">-&gt;</span>condition <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        copy_buf<span class="token operator">-&gt;</span>comp<span class="token operator">-&gt;</span>status    <span class="token operator">=</span> status<span class="token punctuation">;</span>
                        <span class="token comment">//&#x5524;&#x9192;&#x963B;&#x585E;&#x7684;&#x8FDB;&#x7A0B;</span>
                        <span class="token function">cavium_wakeup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>copy_buf<span class="token operator">-&gt;</span>comp<span class="token operator">-&gt;</span>wait_head<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token number">2.</span> &#x975E;&#x963B;&#x585E;&#x7684;<span class="token punctuation">,</span> &#x5728;&#x8FD9;&#x91CC;&#x62F7;&#x8D1D;
                    <span class="token keyword">else</span>
                    <span class="token comment">/* For non-blocking there is no process sleeping. So do copy
                       to user here and free buffers here. */</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>copy_buf<span class="token operator">-&gt;</span>kern_inptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">cavium_free_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> copy_buf<span class="token operator">-&gt;</span>kern_inptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span><span class="token punctuation">(</span>copy_buf<span class="token operator">-&gt;</span>user_bufcnt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x628A;copy_buf-&gt;kern_outptr + 8&#x7684;buf&#x8003;&#x5230;&#x7528;&#x6237;&#x6001;</span>
                        <span class="token comment">//&#x770B;&#x4E86;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x5B9E;&#x73B0;&#x5C31;&#x77E5;&#x9053;&#x4E3A;&#x4EC0;&#x4E48;&#x5185;&#x6838;&#x6001;&#x7533;&#x8BF7;&#x7684;buf&#x90FD;&#x662F;&#x4E00;&#x6574;&#x5757;&#x7684;&#x4E86;</span>
                        <span class="token function">octeon_user_req_copyout_response</span><span class="token punctuation">(</span>copy_buf<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span><span class="token punctuation">(</span>copy_buf<span class="token operator">-&gt;</span>kern_outptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">cavium_free_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> copy_buf<span class="token operator">-&gt;</span>kern_outptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token function">cavium_free_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> copy_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//&#x8FD9;&#x4E2A;&#x91CD;&#x8981;&#x4E86;</span>
    status <span class="token operator">=</span> <span class="token function">__do_request_processing</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> soft_req<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x5148;&#x7533;&#x8BF7;&#x91CD;&#x8981;&#x7ED3;&#x6784;&#x4F53;octeon_soft_instruction_t si, &#x89C1;E11</span>
        si <span class="token operator">=</span> <span class="token function">cavium_alloc_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//&#x5F00;&#x59CB;&#x4ECE;soft_req&#x5F80;si&#x91CC;&#x636F;&#x996C;</span>
        <span class="token function">cavium_memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>exhdr_info<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sr<span class="token operator">-&gt;</span>exhdr_info<span class="token punctuation">,</span> OCT_EXHDR_INFO_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cavium_memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>req_info<span class="token punctuation">,</span> <span class="token function">SOFT_REQ_INFO</span><span class="token punctuation">(</span>sr<span class="token punctuation">)</span><span class="token punctuation">,</span> OCT_REQ_INFO_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>ih   <span class="token operator">=</span> sr<span class="token operator">-&gt;</span>ih<span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>irh  <span class="token operator">=</span> sr<span class="token operator">-&gt;</span>irh<span class="token punctuation">;</span>
        <span class="token comment">//&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5173;&#x952E;&#x4E86;! &#x5E26;&#x7740;&#x95EE;&#x9898;, &#x524D;&#x9762;&#x5DF2;&#x7ECF;&#x628A;&#x5185;&#x6838;&#x6001;&#x7684;input&#x548C;output&#x7684;buffer&#x90FD;&#x641E;&#x5B9A;&#x4E86;&#x5440;(C121, C122)? &#x800C;&#x4E14;&#x66F4;&#x5E95;&#x5C42;&#x7684;output buffer&#x4E5F;OK&#x4E86;(A1i1&#x548C;A17), &#x8FD9;&#x91CC;&#x641E;&#x5565;? --dptr&#x548C;rptr</span>
        <span class="token function">octeon_create_data_buf</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> si<span class="token punctuation">,</span> sr<span class="token punctuation">)</span> <span class="token comment">//&#x89C1;C123    </span>
        <span class="token comment">//&#x8C03;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E4B;&#x524D;, input output bufer&#x8981;&#x51C6;&#x5907;&#x597D;, dptr&#x548C;rptr&#x4E5F;&#x8981;&#x51C6;&#x5907;&#x597D;&#xFF1B; --&#x6240;&#x6709;buffer&#x90FD;&#x8981;&#x51C6;&#x5907;&#x597D;</span>
        retval <span class="token operator">=</span> <span class="token function">__do_instruction_processing</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> si<span class="token punctuation">,</span> sr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            irh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>irh<span class="token punctuation">;</span>
            ih  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>ih<span class="token punctuation">;</span>
            si<span class="token operator">-&gt;</span>irh<span class="token punctuation">.</span>pcie_port <span class="token operator">=</span> oct<span class="token operator">-&gt;</span>pcie_port<span class="token punctuation">;</span>
            resp_order <span class="token operator">=</span> <span class="token function">SOFT_INSTR_RESP_ORDER</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
            resp_mode  <span class="token operator">=</span> <span class="token function">SOFT_INSTR_RESP_MODE</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
            iq_no      <span class="token operator">=</span> <span class="token function">SOFT_INSTR_IQ_NO</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//&#x5F97;&#x5230;iq&#x53F7;</span>
            iq <span class="token operator">=</span> oct<span class="token operator">-&gt;</span>instr_queue<span class="token punctuation">[</span>iq_no<span class="token punctuation">]</span><span class="token punctuation">;</span>
            cmd <span class="token operator">=</span> <span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>command<span class="token punctuation">;</span> <span class="token comment">//&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;E114</span>
            <span class="token comment">//&#x6CE8;&#x610F;: si-&gt;dptr&#x662F;&#x865A;&#x62DF;&#x5730;&#x5740;, &#x8FD9;&#x91CC;&#x7528;pci_map*&#x51FD;&#x6570;&#x628A;&#x8FD9;&#x4E2A;&#x865A;&#x62DF;&#x5730;&#x5740;&#x8F6C;&#x4E3A;iommu&#x5730;&#x5740;, &#x8F6C;&#x5230;cmd-&gt;dptr&#x91CC;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>dptr<span class="token punctuation">)</span>    
                <span class="token comment">//gather&#x6A21;&#x5F0F;&#x4E0B;, &#x786C;&#x4EF6;&#x770B;&#x5230;&#x7684;&#x662F;octeon_sg_entry_t&#x7684;&#x6570;&#x7EC4;, &#x89C1;C1231</span>
                cmd<span class="token operator">-&gt;</span>dptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token function">octeon_pci_map_single</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>dptr<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
                <span class="token comment">//&#x975E;gather&#x6A21;&#x5F0F;&#x4E0B;, &#x662F;&#x4E00;&#x4E2A;bufer&#x5730;&#x5740;</span>
                cmd<span class="token operator">-&gt;</span>dptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token function">octeon_pci_map_single</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>dptr<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>rptr<span class="token punctuation">)</span>
                <span class="token comment">//&#x548C;&#x4E0A;&#x9762;&#x5DEE;&#x4E0D;&#x591A;</span>
            <span class="token comment">//&#x8BBE;&#x8D85;&#x65F6;&#x65F6;&#x95F4;</span>
            si<span class="token operator">-&gt;</span>timeout <span class="token operator">=</span> cavium_jiffies <span class="token operator">+</span> <span class="token function">SOFT_INSTR_TIMEOUT</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>resp_order <span class="token operator">!=</span> OCTEON_RESP_NORESPONSE<span class="token punctuation">)</span> 
                <span class="token comment">//&#x52A0;&#x5230;pending list, &#x8FD9;&#x662F;&#x7B49;&#x5F85;&#x94FE;&#x8868; &#x5728;A15&#x91CC;&#x9762;&#x5904;&#x7406;</span>
                pending_entry <span class="token operator">=</span>  <span class="token function">add_to_pending_list</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> si<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//&#x4ECE;oct-&gt;plist-&gt;list[]&#x6570;&#x7EC4;&#x91CC;&#x627E;&#x4E2A;&#x7A7A;&#x4F4D;&#x7F6E;, &#x628A;&#x8FD9;&#x4E2A;command&#x52A0;&#x5230;list</span>
                    <span class="token comment">//&#x6B64;&#x65F6;free index&#x4E0D;&#x80FD;&#x8D85;&#x8FC7;&#x603B;&#x7684;size</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>free_index <span class="token operator">==</span> oct<span class="token operator">-&gt;</span>pend_list_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
                    pl_index <span class="token operator">=</span> oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>free_list<span class="token punctuation">[</span>oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>free_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token comment">//&#x8FD9;&#x4E2A;index&#x5BF9;&#x5E94;&#x7684;node&#x5E94;&#x8BE5;&#x662F;free&#x7684;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>list<span class="token punctuation">[</span>pl_index<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">!=</span> OCTEON_PENDING_ENTRY_FREE<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
                    oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>free_index<span class="token operator">++</span><span class="token punctuation">;</span>
                    oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>list<span class="token punctuation">[</span>pl_index<span class="token punctuation">]</span><span class="token punctuation">.</span>instr      <span class="token operator">=</span> si<span class="token punctuation">;</span>
                    oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>list<span class="token punctuation">[</span>pl_index<span class="token punctuation">]</span><span class="token punctuation">.</span>request_id <span class="token operator">=</span> pl_index<span class="token punctuation">;</span>
                    oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>list<span class="token punctuation">[</span>pl_index<span class="token punctuation">]</span><span class="token punctuation">.</span>status     <span class="token operator">=</span> OCTEON_PENDING_ENTRY_USED<span class="token punctuation">;</span>
                    oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>list<span class="token punctuation">[</span>pl_index<span class="token punctuation">]</span><span class="token punctuation">.</span>iq_no      <span class="token operator">=</span> <span class="token function">SOFT_INSTR_IQ_NO</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//instr_count&#x8868;&#x793A;pending&#x7684;&#x547D;&#x4EE4;&#x6570;</span>
                    <span class="token function">cavium_atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oct<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>instr_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//&#x66F4;&#x65B0;&#x4E00;&#x4E9B;status</span>
                    si<span class="token operator">-&gt;</span>req_info<span class="token punctuation">.</span>status     <span class="token operator">=</span> OCTEON_REQUEST_PENDING<span class="token punctuation">;</span>
                    si<span class="token operator">-&gt;</span>irh<span class="token punctuation">.</span>rid             <span class="token operator">=</span> pl_index<span class="token punctuation">;</span>
                    si<span class="token operator">-&gt;</span>req_info<span class="token punctuation">.</span>request_id <span class="token operator">=</span> pl_index<span class="token punctuation">;</span>

            cmd<span class="token operator">-&gt;</span>ih   <span class="token operator">=</span> <span class="token operator">*</span>ih<span class="token punctuation">;</span>
            cmd<span class="token operator">-&gt;</span>irh  <span class="token operator">=</span> <span class="token operator">*</span>irh<span class="token punctuation">;</span>
            <span class="token comment">//&#x8FD4;&#x56DE;&#x503C;&#x662F;   index = iq-&gt;host_write_index;</span>
            q_index <span class="token operator">=</span> <span class="token function">post_command64B</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> iq<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token comment">//&#x5B9E;&#x8D28;&#x5C31;&#x662F;ring_doorbell(iq);</span>
                <span class="token function">__post_command</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> iq<span class="token punctuation">,</span> force_db<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>cmd64<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//&#x628A;cmd&#x62F7;&#x5230;iq&#x4E2D;&#x53BB;</span>
                    <span class="token function">__copy_cmd_into_iq</span><span class="token punctuation">(</span>iq<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        iqptr <span class="token operator">=</span> iq<span class="token operator">-&gt;</span>base_addr <span class="token operator">+</span> <span class="token punctuation">(</span>cmdsize <span class="token operator">*</span> iq<span class="token operator">-&gt;</span>host_write_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">cavium_memcpy</span><span class="token punctuation">(</span>iqptr<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> cmdsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//&#x66F4;&#x65B0;host_write_index</span>
                    index <span class="token operator">=</span> iq<span class="token operator">-&gt;</span>host_write_index<span class="token punctuation">;</span>
                    <span class="token function">INCR_INDEX_BY1</span><span class="token punctuation">(</span>iq<span class="token operator">-&gt;</span>host_write_index<span class="token punctuation">,</span> iq<span class="token operator">-&gt;</span>max_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    iq<span class="token operator">-&gt;</span>fill_cnt<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token comment">/* Flush the command into memory. */</span>
                    <span class="token function">cavium_flush_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//wmb()</span>
                    <span class="token comment">//&#x8D85;&#x8FC7;fill_threshold&#x624D;&#x6309;&#x95E8;&#x94C3;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>iq<span class="token operator">-&gt;</span>fill_cnt <span class="token operator">&gt;=</span> iq<span class="token operator">-&gt;</span>fill_threshold <span class="token operator">||</span> force_db<span class="token punctuation">)</span>
                        <span class="token function">ring_doorbell</span><span class="token punctuation">(</span>iq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">OCTEON_WRITE32</span><span class="token punctuation">(</span>iq<span class="token operator">-&gt;</span>doorbell_reg<span class="token punctuation">,</span> iq<span class="token operator">-&gt;</span>fill_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            iq<span class="token operator">-&gt;</span>fill_cnt     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                            iq<span class="token operator">-&gt;</span>last_db_time <span class="token operator">=</span> cavium_jiffies<span class="token punctuation">;</span>
                    <span class="token function">cavium_atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>iq<span class="token operator">-&gt;</span>instr_pending<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>q_index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>resp_order <span class="token operator">==</span> OCTEON_RESP_NORESPONSE<span class="token punctuation">)</span> 
                    <span class="token comment">//&#x8C01;&#x6765;&#x5904;&#x7406;? --A14</span>
                    <span class="token function">__add_to_nrlist</span><span class="token punctuation">(</span>iq<span class="token punctuation">,</span> q_index<span class="token punctuation">,</span> si<span class="token punctuation">,</span> NORESP_BUFTYPE_INSTR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> 
                    pending_entry<span class="token operator">-&gt;</span>queue_index <span class="token operator">=</span> q_index<span class="token punctuation">;</span>
                <span class="token comment">//&#x81F3;&#x6B64;&#x8FD9;&#x4E2A;command&#x5DF2;&#x7ECF;&#x53D1;&#x9001;&#x5230;iq&#x91CC;&#x9762;&#x4E86;, &#x7136;&#x540E;&#x5C31;&#x662F;octeon&#x53D6;command&#x6267;&#x884C;</span>

                retval<span class="token punctuation">.</span>s<span class="token punctuation">.</span>request_id <span class="token operator">=</span> si<span class="token operator">-&gt;</span>req_info<span class="token punctuation">.</span>request_id<span class="token punctuation">;</span>
                retval<span class="token punctuation">.</span>s<span class="token punctuation">.</span>error       <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                retval<span class="token punctuation">.</span>s<span class="token punctuation">.</span>status     <span class="token operator">=</span> si<span class="token operator">-&gt;</span>req_info<span class="token punctuation">.</span>status<span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>sr<span class="token punctuation">)</span>
                    <span class="token function">SOFT_REQ_INFO</span><span class="token punctuation">(</span>sr<span class="token punctuation">)</span><span class="token operator">-&gt;</span>request_id <span class="token operator">=</span> retval<span class="token punctuation">.</span>s<span class="token punctuation">.</span>request_id<span class="token punctuation">;</span>
                    <span class="token function">SOFT_REQ_INFO</span><span class="token punctuation">(</span>sr<span class="token punctuation">)</span><span class="token operator">-&gt;</span>status     <span class="token operator">=</span> retval<span class="token punctuation">.</span>s<span class="token punctuation">.</span>status<span class="token punctuation">;</span>

                <span class="token keyword">if</span><span class="token punctuation">(</span>resp_order <span class="token operator">!=</span> OCTEON_RESP_NORESPONSE<span class="token punctuation">)</span>
                    <span class="token class-name">uint32_t</span>   resp_list<span class="token punctuation">;</span>
                    <span class="token comment">//&#x4E09;&#x9009;&#x4E00;, OCTEON_ORDERED_LIST OCTEON_UNORDERED_NONBLOCKING_LIST OCTEON_UNORDERED_BLOCKING_LIST</span>
                    <span class="token function">GET_RESPONSE_LIST</span><span class="token punctuation">(</span>resp_order<span class="token punctuation">,</span> resp_mode<span class="token punctuation">,</span> resp_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//&#x52A0;&#x5230;&#x76F8;&#x5E94;&#x7684;&#x94FE;&#x8868;&#x91CC;, &#x8FD9;&#x662F;&#x5E94;&#x7B54;&#x94FE;&#x8868;. &#x8C01;&#x6765;&#x5904;&#x7406;?--&#x96BE;&#x9053;&#x53C8;&#x662F;A15?????</span>
                    <span class="token comment">//&#x6BCF;&#x4E2A;&#x53D1;&#x9001;&#x7684;command&#x90FD;&#x4F1A;&#x52A0;&#x5230;&#x5E94;&#x7B54;&#x94FE;&#x8868;(response&#x6A21;&#x5F0F;&#x4E0B;)</span>
                    <span class="token comment">//&#x8FD9;&#x4E2A;&#x94FE;&#x8868;&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;F, &#x662F;&#x4E2A;&quot;&#x7EAF;&#x7684;&quot;&#x94FE;&#x8868;, &#x5176;&#x5B9E;&#x5B83;&#x7684;&#x8282;&#x70B9;&#x662F;pending_entry</span>
                    <span class="token comment">//pending_entry&#x4ECE;&#x7B49;&#x5F85;&#x94FE;&#x8868;&#x6765;, pending_entry&#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;E1</span>
                    <span class="token function">push_response_list</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oct<span class="token operator">-&gt;</span>response_list<span class="token punctuation">[</span>resp_list<span class="token punctuation">]</span><span class="token punctuation">,</span> pending_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">cavium_atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>iq<span class="token operator">-&gt;</span>instr_pending<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>iq<span class="token operator">-&gt;</span>max_count<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">flush_instr_queue</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> iq<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x53C2;&#x8003;A14</span>

    <span class="token comment">//&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;&#x7B49;&#x7740;octeon&#x5E72;&#x6D3B;&#x4E86;</span>
    <span class="token comment">//&#x5982;&#x679C;&#x662F;&#x963B;&#x585E;&#x6A21;&#x5F0F;, &#x6CE8;:&#x8FD9;&#x4E2A;&#x6A21;&#x5F0F;&#x4E0D;&#x652F;&#x6301;ordered</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resp_mode <span class="token operator">==</span> OCTEON_RESP_BLOCKING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//&#x5C31;&#x76F4;&#x63A5;&#x5728;&#x5FAA;&#x73AF;&#x91CC;&#x67E5;&#x8BE2;&#x7B49;&#x7740;, &#x540E;&#x9762;&#x7B49;&#x5B8C;&#x4E86;&#x4EE5;&#x540E;&#x5C31;&#x5730;&#x91CA;&#x653E;&#x8D44;&#x6E90;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SOFT_REQ_IGNORE_SIGNAL</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">signal_pending</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>
                query<span class="token punctuation">.</span>status <span class="token operator">=</span> OCTEON_REQUEST_INTERRUPTED<span class="token punctuation">;</span>

            retval <span class="token operator">=</span> <span class="token function">octeon_query_request_status</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>octeon_id<span class="token punctuation">,</span><span class="token operator">&amp;</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//&#x89C1;C124</span>

            <span class="token comment">/* comp-&gt;condition would be set in the callback octeon_copy_user_buffer()
               called from the request completion tasklet */</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>comp<span class="token operator">-&gt;</span>condition <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">cavium_sleep_timeout_cond</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>comp<span class="token operator">-&gt;</span>wait_head<span class="token punctuation">,</span><span class="token operator">&amp;</span>comp<span class="token operator">-&gt;</span>condition<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                query<span class="token punctuation">.</span>status <span class="token operator">=</span> comp<span class="token operator">-&gt;</span>status<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>status <span class="token operator">==</span> OCTEON_REQUEST_PENDING<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>retval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*### Copy query status to req_info here ###*/</span>
        <span class="token function">SOFT_REQ_INFO</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">)</span><span class="token operator">-&gt;</span>status <span class="token operator">=</span> query<span class="token punctuation">.</span>status<span class="token punctuation">;</span>
        <span class="token function">octeon_user_req_copyout_response</span><span class="token punctuation">(</span>copy_buf<span class="token punctuation">,</span> query<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x628A;req info&#x8003;&#x5230;&#x7528;&#x6237;&#x6001;</span>
    <span class="token function">cavium_copy_out</span><span class="token punctuation">(</span> user_req_info<span class="token punctuation">,</span> <span class="token function">SOFT_REQ_INFO</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">)</span><span class="token punctuation">,</span> OCT_USER_REQ_INFO_SIZE<span class="token punctuation">)</span>
</code></pre>
<h5 id="c121-octeoncopyinputdmabuffers--&#x65B0;&#x7533;&#x8BF7;&#x5185;&#x6838;&#x6001;&#x7684;input-buffer-&#x5E76;&#x628A;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;data&#x62F7;&#x8FDB;&#x6765;"><a name="c121-octeoncopyinputdmabuffers--&#x65B0;&#x7533;&#x8BF7;&#x5185;&#x6838;&#x6001;&#x7684;input-buffer-&#x5E76;&#x628A;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;data&#x62F7;&#x8FDB;&#x6765;" class="anchor-navigation-ex-anchor" href="#c121-octeoncopyinputdmabuffers--&#x65B0;&#x7533;&#x8BF7;&#x5185;&#x6838;&#x6001;&#x7684;input-buffer-&#x5E76;&#x628A;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;data&#x62F7;&#x8FDB;&#x6765;"><i class="fa fa-link" aria-hidden="true"></i></a>C121. octeon_copy_input_dma_buffers : &#x65B0;&#x7533;&#x8BF7;&#x5185;&#x6838;&#x6001;&#x7684;input buffer, &#x5E76;&#x628A;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;data&#x62F7;&#x8FDB;&#x6765;</h5>
<pre class="language-"><code class="lang-c"><span class="token function">octeon_copy_input_dma_buffers</span><span class="token punctuation">(</span><span class="token class-name">octeon_device_t</span>        <span class="token operator">*</span>octeon_dev<span class="token punctuation">,</span>
                              <span class="token class-name">octeon_soft_request_t</span>  <span class="token operator">*</span>soft_req<span class="token punctuation">,</span>
                              <span class="token class-name">uint32_t</span>                gather<span class="token punctuation">)</span>
    <span class="token comment">//&#x8BA1;&#x7B97;&#x51FA;&#x6001;total size</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>total_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>  
        total_size <span class="token operator">+=</span> soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//gather&#x6A21;&#x5F0F;&#x6700;&#x5927;&#x652F;&#x6301;64K, direct&#x6A21;&#x5F0F;&#x652F;&#x6301;16K</span>
    <span class="token comment">//&#x65B0;&#x7533;&#x8BF7;&#x6574;&#x4E2A;buf</span>
    mem <span class="token operator">=</span> <span class="token function">cavium_alloc_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> total_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    memtmp <span class="token operator">=</span> mem<span class="token punctuation">;</span>
    <span class="token comment">//&#x628A;&#x6BCF;&#x4E2A;inbuf&#x4ECE;&#x7528;&#x6237;&#x6001;&#x62F7;&#x5230;&#x521A;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x6838;&#x6001;buf&#x91CC;, &#x867D;&#x7136;&#x62F7;&#x6210;&#x4E00;&#x4E2A;&#x6574;&#x4F53;, &#x4F46;&#x8FD8;&#x662F;&#x4F1A;&#x4FDD;&#x7559;&#x6BCF;&#x4E2A;inbuf</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">cavium_copy_in</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>memtmp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">SOFT_REQ_INBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">cavium_error</span><span class="token punctuation">(</span><span class="token string">&quot;OCTEON: copy in failed for inbuf\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">cavium_free_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>cnt    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">SOFT_REQ_INBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>gather<span class="token punctuation">)</span>
            <span class="token comment">//gather&#x6A21;&#x5F0F;&#x4E0B;&#x8BBE;&#x7F6E;&#x6BCF;&#x4E2A;inbuf&#x7684;&#x6307;&#x9488;</span>
            <span class="token function">SOFT_REQ_INBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> i<span class="token punctuation">)</span>  <span class="token operator">=</span> memtmp<span class="token punctuation">;</span>
        memtmp <span class="token operator">+=</span> soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>gather<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>      <span class="token operator">=</span> total_size<span class="token punctuation">;</span>
        <span class="token function">SOFT_REQ_INBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token operator">=</span> mem<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h5 id="c122-octeoncreateoutputdmabuffers--&#x5C06;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;output-buffer&#x5728;&#x5185;&#x6838;&#x6001;&#x4E5F;&#x7533;&#x8BF7;&#x4E00;&#x4EFD;"><a name="c122-octeoncreateoutputdmabuffers--&#x5C06;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;output-buffer&#x5728;&#x5185;&#x6838;&#x6001;&#x4E5F;&#x7533;&#x8BF7;&#x4E00;&#x4EFD;" class="anchor-navigation-ex-anchor" href="#c122-octeoncreateoutputdmabuffers--&#x5C06;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;output-buffer&#x5728;&#x5185;&#x6838;&#x6001;&#x4E5F;&#x7533;&#x8BF7;&#x4E00;&#x4EFD;"><i class="fa fa-link" aria-hidden="true"></i></a>C122. octeon_create_output_dma_buffers : &#x5C06;&#x7528;&#x6237;&#x6001;&#x63D0;&#x4F9B;&#x7684;output buffer&#x5728;&#x5185;&#x6838;&#x6001;&#x4E5F;&#x7533;&#x8BF7;&#x4E00;&#x4EFD;</h5>
<pre class="language-"><code class="lang-c"><span class="token function">octeon_create_output_dma_buffers</span><span class="token punctuation">(</span><span class="token class-name">octeon_device_t</span>        <span class="token operator">*</span>octeon_dev<span class="token punctuation">,</span>
                                 <span class="token class-name">octeon_soft_request_t</span>  <span class="token operator">*</span>soft_req<span class="token punctuation">,</span>
                                 <span class="token class-name">octeon_copy_buffer_t</span>   <span class="token operator">*</span>copy_buf<span class="token punctuation">,</span>
                                 <span class="token class-name">uint32_t</span>                scatter<span class="token punctuation">)</span>
    <span class="token comment">//&#x9996;&#x5148;&#x8BA1;&#x7B97;&#x6240;&#x6709;&#x7684;outbuf&#x7684;total size, &#x8FD9;&#x4E2A;size&#x6700;&#x5927;16K, &#x6216;14*8K(scatter)</span>
    cnt <span class="token operator">=</span> soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>cnt<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> total_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>  
        total_size <span class="token operator">+=</span> soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//total size&#x8FD8;&#x8981;&#x52A0;&#x4E0A;sizeof(octeon_resp_hdr_t)&#x518D;&#x52A0;8, &#x89C1;&#x4E3B;&#x7ED3;&#x6784;&#x4F53;G41</span>
    total_size <span class="token operator">+=</span> OCT_RESP_HDR_SIZE <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x8FD9;&#x4E2A;&#x5C31;&#x662F;&#x5728;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#x7684;output buffer, &#x4F46;&#x8981;&#x548C;refill&#x7684;&#x90A3;&#x4E2A;&#x66F4;&#x5E95;&#x5C42;&#x7684;buffer&#x533A;&#x522B;&#x5F00;</span>
    mem <span class="token operator">=</span> <span class="token function">cavium_alloc_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> total_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x4E3A;copy&#x4F1A;&#x7528;&#x6237;&#x6001;&#x505A;&#x7684;&#x51C6;&#x5907;  </span>
    copy_buf<span class="token operator">-&gt;</span>kern_outsize <span class="token operator">=</span> total_size <span class="token operator">-</span> OCT_RESP_HDR_SIZE <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">;</span>
    copy_buf<span class="token operator">-&gt;</span>kern_outptr  <span class="token operator">=</span> mem<span class="token punctuation">;</span>
    copy_buf<span class="token operator">-&gt;</span>user_bufcnt  <span class="token operator">=</span> cnt<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>   <span class="token punctuation">{</span>
        <span class="token comment">//&#x4FDD;&#x7559;&#x7528;&#x6237;&#x6001;buffer&#x7684;&#x5730;&#x5740;, &#x5F80;&#x56DE;&#x62F7;&#x8D1D;&#x8981;&#x7528;</span>
        copy_buf<span class="token operator">-&gt;</span>user_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token function">SOFT_REQ_OUTBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        copy_buf<span class="token operator">-&gt;</span>user_size<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
    <span class="token comment">//&#x586B;soft_req-&gt;outbuf</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> total_size<span class="token punctuation">)</span>
        <span class="token comment">//&#x628A;outbuf&#x8FD9;&#x4E2A;&#x6570;&#x7EC4;&#x91CC;&#x9762;&#x7684;&#x6307;&#x9488;&#x66F4;&#x65B0;&#x4E3A;&#x5185;&#x6838;&#x6001;&#x5730;&#x5740;</span>
        <span class="token function">SOFT_REQ_OUTBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> mem <span class="token operator">+</span> size<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>size <span class="token operator">+</span> OCT_MAX_USER_BUF_SIZE<span class="token punctuation">)</span> <span class="token operator">&gt;</span> total_size<span class="token punctuation">)</span>
            buf_size <span class="token operator">=</span> <span class="token punctuation">(</span>total_size <span class="token operator">-</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token keyword">else</span>
            buf_size <span class="token operator">=</span> OCT_MAX_USER_BUF_SIZE<span class="token punctuation">;</span>
        soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> buf_size<span class="token punctuation">;</span> 
        i<span class="token operator">++</span><span class="token punctuation">;</span>

    soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>cnt <span class="token operator">=</span> i<span class="token punctuation">;</span>
</code></pre>
<h5 id="c123-octeoncreatedatabuf"><a name="c123-octeoncreatedatabuf" class="anchor-navigation-ex-anchor" href="#c123-octeoncreatedatabuf"><i class="fa fa-link" aria-hidden="true"></i></a>C123. octeon_create_data_buf</h5>
<p>&#x6839;&#x636E;DMA&#x7684;&#x65B9;&#x5F0F;, &#x586B;soft_instr-&gt;dptr(&#x5F80;octeon&#x53BB;)&#x548C;soft_instr-&gt;rptr(&#x4ECE;octeon&#x6765;), &#x95EE;&#x9898;, &#x5728;&#x54EA;&#x91CC;&#x7528;&#x7684;&#x5462;?????</p>
<p>&#x4EE5;&#x4E0A;&#x4E24;&#x4E2A;ptr&#x53EF;&#x4EE5;&#x662F;&#x76F4;&#x63A5;&#x4E00;&#x4E2A;&#x6307;&#x9488;&#x5730;&#x5740;, &#x4E5F;&#x53EF;&#x4EE5;&#x662F;octeon_sg_entry_t &#x7684;&#x94FE;&#x8868;</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span>  <span class="token class-name">uint32_t</span> 
<span class="token function">octeon_create_data_buf</span><span class="token punctuation">(</span><span class="token class-name">octeon_device_t</span>            <span class="token operator">*</span>oct<span class="token punctuation">,</span>
                       <span class="token class-name">octeon_soft_instruction_t</span>  <span class="token operator">*</span>soft_instr<span class="token punctuation">,</span>
                       <span class="token class-name">octeon_soft_request_t</span>      <span class="token operator">*</span>soft_req<span class="token punctuation">)</span>
    dma_mode   <span class="token operator">=</span> <span class="token function">GET_SOFT_REQ_DMA_MODE</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    resp_order <span class="token operator">=</span> <span class="token function">GET_SOFT_REQ_RESP_ORDER</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x786E;&#x8BA4;buffer count&#x4E0D;&#x5927;&#x4E8E;MAX_BUFCNT, 16</span>
    <span class="token comment">//DMA&#x7C7B;&#x578B;</span>
    <span class="token comment">//&#x7B2C;&#x4E00;&#x79CD;: input&#x548C;output&#x90FD;&#x662F;direct</span>
    OCTEON_DMA_DIRECT <span class="token operator">:</span>soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>cnt&#x5FC5;&#x987B;&#x4E3A;<span class="token number">0</span>&#xFF1B;&#x6700;&#x5927;&#x652F;&#x6301;<span class="token number">16</span>K&#x7684;buffer<span class="token punctuation">;</span>
    &#x53EF;&#x4EE5;&#x6CA1;&#x6709;input<span class="token punctuation">,</span> &#x4F46;&#x5FC5;&#x987B;&#x6709;header&#x7684;buffer
        soft_instr<span class="token operator">-&gt;</span>ih<span class="token punctuation">.</span>gather   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        soft_instr<span class="token operator">-&gt;</span>irh<span class="token punctuation">.</span>scatter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x7533;&#x8BF7;input buf, &#x8FD9;&#x91CC;&#x597D;&#x50CF;&#x7F57;&#x55E6;&#x4E86;, &#x5E94;&#x8BE5;&#x4E0D;&#x7528;&#x518D;&#x7533;&#x8BF7;&#x4E00;&#x6B21;buffer</span>
        soft_instr<span class="token operator">-&gt;</span>dptr <span class="token operator">=</span>  <span class="token function">octeon_process_request_inbuf</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span>
                                                soft_instr<span class="token punctuation">,</span> soft_req<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//&#x662F;&#x54EA;&#x4E2A;iq</span>
            iq_no <span class="token operator">=</span> <span class="token function">SOFT_INSTR_IQ_NO</span><span class="token punctuation">(</span>soft_instr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            exhdr_size <span class="token operator">=</span> <span class="token function">SOFT_INSTR_EXHDR_COUNT</span><span class="token punctuation">(</span>soft_instr<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">;</span>

            <span class="token comment">//&#x8FD9;&#x91CC;&#x5728;&#x76F4;&#x63A5;DMA&#x6A21;&#x5F0F;&#x4E0B;, &#x5982;&#x679C;app&#x63D0;&#x4F9B;&#x4E86;&#x591A;&#x4E2A;inbuf, &#x5C31;&#x5408;&#x5E76;&#x5230;&#x65B0;&#x7684;&#x5927;buf&#x91CC;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>cnt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> i in all inbuf<span class="token punctuation">.</span>cnt<span class="token operator">:</span>
                    total_size <span class="token operator">+=</span> soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">//&#x603B;&#x7684;size&#x8FD8;&#x8981;&#x52A0;&#x4E0A;extra header</span>
                total_size <span class="token operator">+=</span> exhdr_size<span class="token punctuation">;</span> <span class="token comment">/* Add any extra header bytes present */</span>
                <span class="token comment">//&#x91CD;&#x65B0;&#x7533;&#x8BF7;buf, &#x5E95;&#x4E0B;&#x8981;&#x4E48;&#x662F;&#x4ECE;buffer&#x6C60;&#x6765;, &#x8981;&#x4E48;&#x662F;kmalloc(&#x53EF;dma)</span>
                buf <span class="token operator">=</span> <span class="token function">cavium_alloc_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> total_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//&#x5148;&#x62F7;extra header</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>exhdr_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   <span class="token function">cavium_memcpy</span><span class="token punctuation">(</span>tmpbuf<span class="token punctuation">,</span> soft_instr<span class="token operator">-&gt;</span>exhdr<span class="token punctuation">,</span> exhdr_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   tmpbuf <span class="token operator">+=</span> exhdr_size<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//&#x518D;&#x62F7;&#x6BCF;&#x4E2A;inbuf&#x7684;&#x5185;&#x5BB9;, &#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x662F;dada&#x7684;&#x7B2C;&#x4E8C;&#x6B21;&#x62F7;&#x8D1D;, &#x7B2C;&#x4E00;&#x6B21;&#x53D1;&#x751F;&#x5728;&#x4ECE;&#x7528;&#x6237;&#x6001;&#x62F7;&#x5230;&#x5185;&#x6838;&#x6001;, &#x89C1;C121</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token function">cavium_memcpy</span><span class="token punctuation">(</span>tmpbuf<span class="token punctuation">,</span> <span class="token function">SOFT_REQ_INBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span>soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  tmpbuf <span class="token operator">+=</span> soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                soft_instr<span class="token operator">-&gt;</span>dptr       <span class="token operator">=</span> buf<span class="token punctuation">;</span>
                soft_instr<span class="token operator">-&gt;</span>ih<span class="token punctuation">.</span>dlengsz <span class="token operator">=</span> total_size<span class="token punctuation">;</span>
                <span class="token function">SET_SOFT_INSTR_ALLOCFLAGS</span><span class="token punctuation">(</span>soft_instr<span class="token punctuation">,</span> OCTEON_DPTR_COALESCED<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//&#x53EA;&#x6709;&#x4E00;&#x4E2A;inbuf</span>
            <span class="token keyword">else</span>
                <span class="token comment">//&#x53EA;&#x6709;&#x4E00;&#x4E2A;buf&#x5C31;&#x4E0D;&#x7528;&#x62F7;&#x8D1D;&#x4E86;</span>
                soft_instr<span class="token operator">-&gt;</span>dptr        <span class="token operator">=</span> <span class="token function">SOFT_REQ_INBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                soft_instr<span class="token operator">-&gt;</span>ih<span class="token punctuation">.</span>dlengsz  <span class="token operator">=</span> soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">//&#x586B;rptr, &#x56E0;&#x4E3A;&#x5728;&#x76F4;&#x63A5;DMA&#x6A21;&#x5F0F;&#x4E0B;, soft_req-&gt;outbuf.cnt&#x5FC5;&#x987B;&#x4E3A;0</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>soft_instr<span class="token operator">-&gt;</span>ih<span class="token punctuation">.</span>raw<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>resp_order <span class="token operator">!=</span> OCTEON_RESP_NORESPONSE<span class="token punctuation">)</span><span class="token punctuation">)</span>
            soft_instr<span class="token operator">-&gt;</span>rptr <span class="token operator">=</span> <span class="token function">SOFT_REQ_OUTBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            soft_instr<span class="token operator">-&gt;</span>irh<span class="token punctuation">.</span>rlenssz  <span class="token operator">=</span> soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            soft_instr<span class="token operator">-&gt;</span>status_word <span class="token operator">=</span> outbuf&#x7684;&#x6700;&#x540E;<span class="token number">8</span>&#x4E2A;&#x5B57;&#x8282;
    <span class="token comment">//&#x7B2C;&#x4E8C;&#x79CD;:input&#x662F;gather, output&#x662F;direct</span>
    OCTEON_DMA_GATHER <span class="token operator">:</span>soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>cnt&#x5FC5;&#x987B;&#x4E3A;<span class="token number">0</span>
        soft_instr<span class="token operator">-&gt;</span>ih<span class="token punctuation">.</span>gather   <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x6A21;&#x5F0F;&#x4E0B;output&#x662F;&#x76F4;&#x63A5;&#x7684;</span>
        soft_instr<span class="token operator">-&gt;</span>rptr         <span class="token operator">=</span> <span class="token function">SOFT_REQ_OUTBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        soft_instr<span class="token operator">-&gt;</span>irh<span class="token punctuation">.</span>rlenssz  <span class="token operator">=</span> soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        soft_instr<span class="token operator">-&gt;</span>status_word <span class="token operator">=</span>
             <span class="token punctuation">(</span><span class="token class-name">uint64_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">SOFT_REQ_OUTBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x4E0A;&#x9762;&#x641E;&#x5B9A;&#x4E86;rptr, &#x73B0;&#x5728;&#x6765;&#x641E;dptr, &#x89C1;C1231</span>
        soft_instr<span class="token operator">-&gt;</span>dptr <span class="token operator">=</span> <span class="token function">octeon_create_sg_list</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> <span class="token operator">&amp;</span>soft_req<span class="token operator">-&gt;</span>inbuf
                         <span class="token punctuation">,</span> soft_instr<span class="token punctuation">,</span> OCTEON_DPTR_GATHER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x7B2C;&#x4E09;&#x79CD;:input&#x662F;direct, output&#x662F;scatter</span>
    OCTEON_DMA_SCATTER <span class="token operator">:</span> &#x6B64;DMA&#x4E0D;&#x652F;&#x6301;noresponse<span class="token punctuation">,</span> &#x5F88;&#x7B80;&#x5355;<span class="token punctuation">,</span> &#x5982;&#x679C;&#x4E0D;&#x7528;output<span class="token punctuation">,</span>&#x8FD8;&#x8981;scatter&#x5E72;&#x5565;<span class="token operator">?</span>
        soft_instr<span class="token operator">-&gt;</span>irh<span class="token punctuation">.</span>scatter <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x8FD9;&#x4E2A;&#x6A21;&#x5F0F;&#x4E0B;, &#x8981;&#x6C42;inbuf.cnt&#x5FC5;&#x987B;&#x4E3A;1???????&#x548C;&#x4E0A;&#x9762;&#x7B2C;&#x4E00;&#x79CD;DMA&#x6A21;&#x5F0F;&#x4E3A;&#x4EC0;&#x4E48;&#x6709;&#x5DEE;&#x522B;&#x5462;?</span>
        <span class="token comment">//&#x90A3;&#x4E48;&#x53EA;&#x6709;&#x4E00;&#x4E2A;inbuf, &#x5C31;&#x76F4;&#x63A5;&#x7528;&#x4F5C;dptr&#x4E86;</span>
        soft_instr<span class="token operator">-&gt;</span>dptr        <span class="token operator">=</span> <span class="token function">SOFT_REQ_INBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        soft_instr<span class="token operator">-&gt;</span>ih<span class="token punctuation">.</span>dlengsz  <span class="token operator">=</span> soft_req<span class="token operator">-&gt;</span>inbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x4E0A;&#x9762;&#x7B97;&#x662F;&#x641E;&#x5B9A;&#x4E86;dptr, &#x63A5;&#x5199;&#x6765;&#x641E;rptr, &#x89C1;C1231</span>
        soft_instr<span class="token operator">-&gt;</span>rptr <span class="token operator">=</span> <span class="token function">octeon_create_sg_list</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> <span class="token operator">&amp;</span>soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">,</span>
                              soft_instr<span class="token punctuation">,</span> OCTEON_RPTR_SCATTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>resp_order <span class="token operator">!=</span> OCTEON_RESP_NORESPONSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                soft_instr<span class="token operator">-&gt;</span>status_word <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>
                  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">SOFT_REQ_OUTBUF</span><span class="token punctuation">(</span>soft_req<span class="token punctuation">,</span> <span class="token punctuation">(</span>soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>cnt<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                   <span class="token operator">+</span> soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>size<span class="token punctuation">[</span>soft_req<span class="token operator">-&gt;</span>outbuf<span class="token punctuation">.</span>cnt<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//&#x7B2C;&#x56DB;&#x79CD;:input&#x662F;gather, output&#x662F;scatter</span>
    OCTEON_DMA_SCATTER_GATHER <span class="token operator">:</span>&#x662F;&#x4EE5;&#x4E0A;&#x4E24;&#x4E2A;&#x6A21;&#x5F0F;&#x7684;&#x7EFC;&#x5408;<span class="token punctuation">,</span> &#x540C;&#x4E0A;<span class="token punctuation">,</span> &#x4E0D;&#x652F;&#x6301;noresponse

    <span class="token comment">//input&#x548C;output&#x7684;buf&#x90FD;&#x641E;&#x5B9A;&#x4EE5;&#x540E;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>soft_instr<span class="token operator">-&gt;</span>ih<span class="token punctuation">.</span>raw<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">IQ_INSTR_MODE_32B</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> <span class="token function">SOFT_INSTR_IQ_NO</span><span class="token punctuation">(</span>soft_instr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            soft_instr<span class="token operator">-&gt;</span>ih<span class="token punctuation">.</span>fsz <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> 
            soft_instr<span class="token operator">-&gt;</span>ih<span class="token punctuation">.</span>fsz <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">SOFT_INSTR_EXHDR_COUNT</span><span class="token punctuation">(</span>soft_instr<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>soft_instr<span class="token operator">-&gt;</span>status_word<span class="token punctuation">)</span>
        <span class="token comment">//status&#x7F6E;&#x4E3A;COMPLETION_WORD_INIT</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>soft_instr<span class="token operator">-&gt;</span>status_word<span class="token punctuation">)</span> <span class="token operator">=</span> COMPLETION_WORD_INIT<span class="token punctuation">;</span>
</code></pre>
<h6 id="c1231-octeoncreatesglist"><a name="c1231-octeoncreatesglist" class="anchor-navigation-ex-anchor" href="#c1231-octeoncreatesglist"><i class="fa fa-link" aria-hidden="true"></i></a>C1231. octeon_create_sg_list</h6>
<pre class="language-"><code class="lang-c"><span class="token comment">/** The Scatter-Gather List Entry. The scatter or gather component used with
    a Octeon input instruction has this format. */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span> 

    <span class="token comment">/** The first 64 bit gives the size of data in each dptr.*/</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint16_t</span>  size<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">uint64_t</span>  size64<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> u<span class="token punctuation">;</span>

    <span class="token comment">/** The 4 dptr pointers for this entry. */</span>
    <span class="token class-name">uint64_t</span>     ptr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token class-name">octeon_sg_entry_t</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-c"><span class="token comment">//&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5E76;&#x4E0D;&#x62F7;&#x8D1D;data, &#x53EA;&#x662F;&#x7533;&#x8BF7;sg_count&#x4E2A;&#x4E0A;&#x9762;&#x7684;&#x7ED3;&#x6784;&#x4F53;, &#x7136;&#x540E;&#x628A;&#x91CC;&#x9762;&#x7684;4&#x4E2A;ptr&#x6307;&#x5411;outbuf</span>
<span class="token function">octeon_create_sg_list</span><span class="token punctuation">(</span><span class="token class-name">octeon_device_t</span>            <span class="token operator">*</span>oct<span class="token punctuation">,</span>
                      <span class="token class-name">octeon_buffer_t</span>            <span class="token operator">*</span>buf<span class="token punctuation">,</span> 
                      <span class="token class-name">octeon_soft_instruction_t</span>  <span class="token operator">*</span>soft_instr<span class="token punctuation">,</span>
                      <span class="token class-name">uint32_t</span>                    flags<span class="token punctuation">)</span>
    <span class="token comment">//cnt&#x5C31;&#x662F;buf&#x7684;&#x4E2A;&#x6570;</span>
    <span class="token comment">//gather&#x94FE;&#x8868;</span>
        <span class="token comment">//&#x4E5F;&#x662F;&#x5148;&#x7B97;total size, &#x52A0;&#x4E0A;&#x4E00;&#x4E9B;extra header, &#x6700;&#x5927;64K</span>
        soft_instr<span class="token operator">-&gt;</span>gather_bytes <span class="token operator">=</span> total_size<span class="token punctuation">;</span>
        soft_instr<span class="token operator">-&gt;</span>ih<span class="token punctuation">.</span>dlengsz   <span class="token operator">=</span> cnt<span class="token punctuation">;</span>
    <span class="token comment">//scatter&#x94FE;&#x8868;</span>
        <span class="token comment">//&#x540C;&#x6837;&#x5148;&#x7B97;total size, &#x52A0;&#x4E0A;&#x4E00;&#x4E9B;extra header, &#x6700;&#x5927;14*8K</span>
        soft_instr<span class="token operator">-&gt;</span>irh<span class="token punctuation">.</span>rlenssz   <span class="token operator">=</span> cnt<span class="token punctuation">;</span>
        soft_instr<span class="token operator">-&gt;</span>scatter_bytes <span class="token operator">=</span> total_size<span class="token punctuation">;</span>
    <span class="token comment">//&#x628A;cnt&#x6309;4&#x4E2A;&#x4E00;&#x7EC4;</span>
    sg_count <span class="token operator">=</span> <span class="token function">ROUNDUP4</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
    sg_list <span class="token operator">=</span> <span class="token function">octeon_alloc_sglist</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> soft_instr<span class="token punctuation">,</span> sg_count<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x7ED3;&#x6784;&#x4F53;&#x89C1;&#x4E0A;&#x9762;octeon_sg_entry_t, sg_list&#x9700;&#x8981;8&#x5B57;&#x8282;&#x5BF9;&#x9F50;</span>
        sg_list <span class="token operator">=</span> <span class="token function">cavium_alloc_buffer</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span><span class="token punctuation">(</span>sg_count<span class="token operator">*</span>OCT_SG_ENTRY_SIZE<span class="token punctuation">)</span><span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> OCTEON_DPTR_GATHER<span class="token punctuation">)</span>
            soft_instr<span class="token operator">-&gt;</span>gather_ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>sg_list<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            soft_instr<span class="token operator">-&gt;</span>scatter_ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>sg_list<span class="token punctuation">;</span>

    <span class="token comment">//&#x5411;sg_list[i].ptr[k]&#x586B;&#x7269;&#x7406;&#x5730;&#x5740;(&#x6216;&#x7ECF;&#x8FC7;IOMMU&#x7684;&#x5730;&#x5740;)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sg_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>k <span class="token operator">=</span> tmpcnt<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> cnt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">,</span> k<span class="token operator">++</span><span class="token punctuation">)</span>   <span class="token punctuation">{</span>
            size <span class="token operator">=</span> buf<span class="token operator">-&gt;</span>size<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">/* Gather list data is swapped and interpreted in Hardware.
               Scatter data is interpreted by core software. We need to do
               swapping of scatter list manually. */</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>flags <span class="token operator">==</span> OCTEON_RPTR_SCATTER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">octeon_swap_2B_data</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sg_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>u<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">-</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> size<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">CAVIUM_ADD_SG_SIZE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sg_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>flags <span class="token operator">==</span> OCTEON_DPTR_GATHER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sg_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ptr<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">octeon_pci_map_single</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>pci_dev<span class="token punctuation">,</span> <span class="token function">OCT_SOFT_REQ_BUFPTR</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">,</span> buf<span class="token operator">-&gt;</span>size<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> CAVIUM_PCI_DMA_TODEVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                sg_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ptr<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">octeon_pci_map_single</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>pci_dev<span class="token punctuation">,</span> <span class="token function">OCT_SOFT_REQ_BUFPTR</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">,</span> buf<span class="token operator">-&gt;</span>size<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> CAVIUM_PCI_DMA_FROMDEVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">octeon_swap_8B_data</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sg_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ptr<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        tmpcnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sg_list<span class="token punctuation">;</span> <span class="token comment">//&#x88AB;&#x5F53;&#x4F5C;rptr&#x6216;dptr</span>
</code></pre>
<h5 id="c124-&#x4E3B;&#x8981;&#x7684;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;"><a name="c124-&#x4E3B;&#x8981;&#x7684;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;" class="anchor-navigation-ex-anchor" href="#c124-&#x4E3B;&#x8981;&#x7684;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;"><i class="fa fa-link" aria-hidden="true"></i></a>C124. &#x4E3B;&#x8981;&#x7684;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;</h5>
<pre class="language-"><code class="lang-c"><span class="token function">octeon_query_request_status</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span>                 octeon_id<span class="token punctuation">,</span>
                            <span class="token class-name">octeon_query_request_t</span>  <span class="token operator">*</span>query<span class="token punctuation">)</span>
    <span class="token class-name">octeon_device_t</span>  <span class="token operator">*</span>octeon_dev <span class="token operator">=</span> <span class="token function">get_octeon_device</span><span class="token punctuation">(</span>query<span class="token operator">-&gt;</span>octeon_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">process_unordered_poll</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">//&#x6709;request_id&#x5C31;&#x53EF;&#x4EE5;&#x627E;&#x5230;pending entry</span>
        pending_entry  <span class="token operator">=</span> <span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>plist<span class="token operator">-&gt;</span>list<span class="token punctuation">[</span>query<span class="token operator">-&gt;</span>request_id<span class="token punctuation">]</span><span class="token punctuation">;</span>
        soft_instr <span class="token operator">=</span> pending_entry<span class="token operator">-&gt;</span>instr<span class="token punctuation">;</span>
        <span class="token comment">//COMPLETION_WORD_INIT&#x662F;&#x6700;&#x5F00;&#x59CB;&#x7684;&#x72B6;&#x6001;, &#x4E0D;&#x662F;init&#x8BF4;&#x660E;&#x5DF2;&#x7ECF;&#x5728;&#x5E72;&#x6D3B;&#x4E86;?</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>soft_instr<span class="token operator">-&gt;</span>status_word<span class="token punctuation">)</span> <span class="token operator">!=</span> COMPLETION_WORD_INIT<span class="token punctuation">)</span>
            <span class="token comment">//&#x5F97;&#x5230;&#x65B0;&#x7684;status</span>
            status <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_req_status_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>status64 <span class="token operator">&amp;</span> <span class="token number">0x00000000ffffffffULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token comment">//&#x662F;&#x5426;&#x8D85;&#x65F6;&#x4E86;?</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">cavium_check_timeout</span><span class="token punctuation">(</span>cavium_jiffies<span class="token punctuation">,</span> soft_instr<span class="token operator">-&gt;</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span> 
                status <span class="token operator">=</span> OCTEON_REQUEST_TIMEOUT<span class="token punctuation">;</span>
        <span class="token comment">//&#x4E0D;&#x662F;pending&#x8BF4;&#x660E;&#x7528;&#x5B8C;&#x4E86;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">!=</span> OCTEON_REQUEST_PENDING<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SOFT_INSTR_RESP_MODE</span><span class="token punctuation">(</span>soft_instr<span class="token punctuation">)</span> <span class="token operator">==</span> OCTEON_RESP_BLOCKING<span class="token punctuation">)</span>
                response_list <span class="token operator">=</span> <span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>response_list<span class="token punctuation">[</span>OCTEON_UNORDERED_BLOCKING_LIST<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                response_list <span class="token operator">=</span> <span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>response_list<span class="token punctuation">[</span>OCTEON_UNORDERED_NONBLOCKING_LIST<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">release_from_response_list</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> pending_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">release_from_pending_list</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span>pending_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">release_soft_instr</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">,</span> soft_instr<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x672C;&#x6B21;&#x67E5;&#x8BE2;&#x7684;&#x7ED3;&#x679C;, &#x4E00;&#x822C;&#x5F00;&#x59CB;&#x4F1A;&#x662F;OCTEON_REQUEST_PENDING, &#x6700;&#x540E;&#x662F;&#x5B8C;&#x6210;</span>
        query<span class="token operator">-&gt;</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span>
</code></pre>
<h2 id="&#x4E2D;&#x65AD;&#x5904;&#x7406;-&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;"><a name="&#x4E2D;&#x65AD;&#x5904;&#x7406;-&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#&#x4E2D;&#x65AD;&#x5904;&#x7406;-&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>5.4. &#x4E2D;&#x65AD;&#x5904;&#x7406; :&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x5668;&#x4EF6;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;</h2>
<pre class="language-"><code class="lang-c"><span class="token function">octeon_intr_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
        <span class="token keyword">return</span>  oct<span class="token operator">-&gt;</span>fn_list<span class="token punctuation">.</span><span class="token function">interrupt_handler</span><span class="token punctuation">(</span>oct<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x6BD4;&#x5982;</p>
<pre class="language-"><code class="lang-c">cn6xxx_interrupt_handler
<span class="token function">cn6xxx_interrupt_handler</span><span class="token punctuation">(</span><span class="token keyword">void</span>  <span class="token operator">*</span>dev<span class="token punctuation">)</span>
    <span class="token comment">//&#x901A;&#x8FC7;bar0&#x8BFB;INT_SUM&#x5BC4;&#x5B58;&#x5668;, &#x6CA1;&#x6709;&#x4E2D;&#x65AD;&#x5219;&#x9A6C;&#x4E0A;&#x9000;&#x51FA;</span>
    intr64 <span class="token operator">=</span> <span class="token function">OCTEON_READ64</span><span class="token punctuation">(</span>cn6xxx<span class="token operator">-&gt;</span>intr_sum_reg64<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>intr64 
        <span class="token keyword">return</span>

    <span class="token comment">//&#x9A6C;&#x4E0A;&#x5173;&#x672C;&#x4E2D;&#x65AD;</span>
    oct<span class="token operator">-&gt;</span>fn_list<span class="token punctuation">.</span><span class="token function">disable_interrupt</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>chip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>intr64 <span class="token operator">&amp;</span> CN63XX_INTR_ERR<span class="token punctuation">)</span>
        <span class="token function">cn6xxx_handle_pcie_error_intr</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> intr64<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>intr64 <span class="token operator">&amp;</span> CN63XX_INTR_PKT_DATA<span class="token punctuation">)</span> <span class="token comment">//&#x8FD9;&#x91CC;&#x662F;&#x4ECE;octeon&#x7F51;&#x53E3;&#x6765;&#x7684;&#x62A5;&#x6587;, &#x548C;response&#x6CA1;&#x6709;&#x5173;&#x7CFB;</span>
        <span class="token function">cn6xxx_droq_intr_handler</span><span class="token punctuation">(</span>oct<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     droq_time_mask <span class="token operator">=</span> <span class="token function">octeon_read_csr</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> CN63XX_SLI_PKT_TIME_INT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//&#x5BF9;&#x6BCF;&#x4E2A;q</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>oq_no <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> oq_no <span class="token operator">&lt;</span> oct<span class="token operator">-&gt;</span>num_oqs<span class="token punctuation">;</span> oq_no<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token comment">//&#x5148;&#x68C0;&#x67E5;&#x662F;&#x4E0D;&#x662F;&#x5728;mask&#x91CC;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span>droq_mask <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> oq_no<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                droq <span class="token operator">=</span> oct<span class="token operator">-&gt;</span>droq<span class="token punctuation">[</span>oq_no<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">//&#x4E00;&#x5171;&#x6536;&#x4E86;&#x591A;&#x5C11;&#x5305;?</span>
                pkt_count <span class="token operator">=</span> <span class="token function">octeon_droq_check_hw_for_pkts</span><span class="token punctuation">(</span>oct<span class="token punctuation">,</span> droq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pkt_count <span class="token operator">=</span> <span class="token function">OCTEON_READ32</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>pkts_sent_reg<span class="token punctuation">)</span>
                    <span class="token comment">//&#x4E3A;&#x4EC0;&#x4E48;&#x662F;&#x52A0;&#x5728;pkts_pending&#x4E0A;&#x5462;? &#x662F;&#x6307;&#x6536;&#x5230;&#x7684;&#x8FD8;&#x6CA1;&#x5904;&#x7406;&#x7684;&#x62A5;&#x6587;&#x6570;?</span>
                    <span class="token function">cavium_atomic_add</span><span class="token punctuation">(</span>pkt_count<span class="token punctuation">,</span> <span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>pkts_pending<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//&#x8FD9;&#x91CC;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD8;&#x8981;&#x5199;&#x56DE;&#x8FD9;&#x4E2A;&#x5BC4;&#x5B58;&#x5668;&#x5462;?</span>
                    <span class="token function">OCTEON_WRITE32</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>pkts_sent_reg<span class="token punctuation">,</span> pkt_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//&#x8FD8;&#x6709;&#x4E2A;poll&#x6A21;&#x5F0F;???? &#x597D;&#x50CF;&#x6CA1;&#x6253;&#x5F00;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>droq<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>poll_mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    droq<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span><span class="token function">napi_fn</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>octeon_id<span class="token punctuation">,</span> oq_no<span class="token punctuation">,</span> POLL_EVENT_INTR_ARRIVED<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    <span class="token comment">//&#x6253;&#x5F00;&#x4E86;USE_DROQ_THREADS&#x624D;&#x4F1A;&#x8C03;, &#x4E5F;&#x5C31;&#x662F;&#x8BF4;, &#x5373;&#x4F7F;&#x662F;&#x7528;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x6536;&#x5305;, &#x4E5F;&#x9700;&#x8981;&#x4E2D;&#x65AD;&#x89E6;&#x53D1;</span>
                    <span class="token function">cavium_wakeup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>droq<span class="token operator">-&gt;</span>wc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x8FD9;&#x4E2A;&#x4EFB;&#x52A1;&#x89C1;A18</span>
            <span class="token comment">//&#x4E0D;&#x7528;USE_DROQ_THREADS&#x65F6;&#x4F7F;&#x7528;tasklet, &#x89C1;INT1</span>
            <span class="token function">cavium_tasklet_schedule</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oct<span class="token operator">-&gt;</span>droq_tasklet<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>intr64 <span class="token operator">&amp;</span> <span class="token punctuation">(</span>CN63XX_INTR_DMA0_FORCE<span class="token operator">|</span>CN63XX_INTR_DMA1_FORCE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">//&#x8FD9;&#x91CC;&#x5F00;&#x59CB;&#x8BA9;comp_tasklet&#x5E72;&#x6D3B;, &#x89C1;INT2</span>
        <span class="token function">cavium_tasklet_schedule</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oct<span class="token operator">-&gt;</span>comp_tasklet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x597D;&#x50CF;&#x6CA1;&#x6709;&#x641C;&#x5230;&#x4EFB;&#x4F55;dma_ops&#x4E0B;&#x6302;&#x7684;&#x51FD;&#x6570;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>intr64 <span class="token operator">&amp;</span> CN63XX_INTR_DMA_DATA<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>dma_ops<span class="token punctuation">.</span>intr_handler<span class="token punctuation">)</span><span class="token punctuation">)</span>
        oct<span class="token operator">-&gt;</span>dma_ops<span class="token punctuation">.</span><span class="token function">intr_handler</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>oct<span class="token punctuation">,</span> intr64<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Clear the current interrupts */</span>
    <span class="token function">OCTEON_WRITE64</span><span class="token punctuation">(</span>cn6xxx<span class="token operator">-&gt;</span>intr_sum_reg64<span class="token punctuation">,</span> intr64<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Re-enable our interrupts  */</span>
    oct<span class="token operator">-&gt;</span>fn_list<span class="token punctuation">.</span><span class="token function">enable_interrupt</span><span class="token punctuation">(</span>oct<span class="token operator">-&gt;</span>chip<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="int1-octeondroqbh-&#x89C1;a19"><a name="int1-octeondroqbh-&#x89C1;a19" class="anchor-navigation-ex-anchor" href="#int1-octeondroqbh-&#x89C1;a19"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.1. INT1. octeon_droq_bh, &#x89C1;A19</h3>
<ul>
<li>&#x8FD9;&#x91CC;&#x7684;&#x6536;&#x5305;&#x548C;&#x53D1;&#x9001;&#x547D;&#x4EE4;&#x5B57;&#x91CC;&#x9762;&#x7684;response&#x5E94;&#x8BE5;&#x6CA1;&#x6709;&#x5173;&#x7CFB;, &#x53EA;&#x662F;&#x6536;octeon&#x4E3B;&#x52A8;&#x53D1;&#x8FC7;&#x6765;&#x7684;&#x5305;, &#x7136;&#x540E;&#x5206;&#x53D1;; &#x73B0;&#x5728;&#x8D70;&#x7684;&#x5E94;&#x8BE5;&#x662F;slow path, &#x800C;&#x4E14;&#x6CA1;&#x6709;&#x771F;&#x6B63;&#x7684;&quot;&#x4E0A;&#x5C42;&quot;&#x5904;&#x7406;&#x51FD;&#x6570;&#x6CE8;&#x518C;, &#x89C1;A181</li>
<li>&#x5173;&#x4E8E;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x7684;tasklet:<ol>
<li>tasklet&#x5DE5;&#x4F5C;&#x5728;&#x8F6F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;</li>
<li>tasklet&#x5728;&#x591A;CPU&#x4E4B;&#x95F4;&#x662F;&#x4E32;&#x884C;&#x5316;&#x6267;&#x884C;&#x7684;, &#x591A;CPU&#x4E0D;&#x4F1A;&#x540C;&#x65F6;&#x6267;&#x884C;&#x4E00;&#x4E2A;tasklet----&#x800C;&#x540C;&#x662F;&#x8F6F;&#x4E2D;&#x65AD;&#x7684;softirq&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x6267;&#x884C;</li>
<li>tasklet&#x59CB;&#x7EC8;&#x8FD0;&#x884C;&#x5728;&#x88AB;&#x521D;&#x59CB;&#x63D0;&#x4EA4;&#x7684;&#x540C;&#x4E00;&#x5904;&#x7406;&#x5668;&#x4E0A;&#xFF0C;workqueue&#x4E0D;&#x4E00;&#x5B9A; ----&#x5F85;&#x786E;&#x8BA4;</li>
</ol>
</li>
</ul>
<p>&#x7EFC;&#x4E0A;, &#x5373;&#x4F7F;&#x4E2D;&#x65AD;&#x6765;&#x7684;&#x5F88;&#x5FEB;, <code>tasklet_schedule(&amp;oct-&gt;droq_tasklet)</code>&#x4E0D;&#x65AD;&#x7684;&#x88AB;&#x8C03;&#x7528;, &#x90A3;&#x4E48;droq_tasklet&#x4E5F;&#x8FD8;&#x662F;&#x4F1A;&#x88AB;&#x4E32;&#x884C;&#x6267;&#x884C;.
&#x800C;&#x7EBF;&#x7A0B;&#x6536;&#x5305;&#x6A21;&#x5F0F;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x591A;CPU&#x4E00;&#x8D77;&#x6536;&#x5305;, &#x53EA;&#x8981;&#x4ED6;&#x4EEC;&#x4E0D;&#x662F;&#x5904;&#x7406;&#x540C;&#x4E00;&#x4E2A;Q. --&#x6700;&#x591A;32&#x4E2A;q</p>
<h3 id="int2-octeonrequestcompletionbh-&#x548C;a15&#x51E0;&#x4E4E;&#x4E00;&#x6837;"><a name="int2-octeonrequestcompletionbh-&#x548C;a15&#x51E0;&#x4E4E;&#x4E00;&#x6837;" class="anchor-navigation-ex-anchor" href="#int2-octeonrequestcompletionbh-&#x548C;a15&#x51E0;&#x4E4E;&#x4E00;&#x6837;"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.2. INT2. octeon_request_completion_bh, &#x548C;A15&#x51E0;&#x4E4E;&#x4E00;&#x6837;</h3>
<pre class="language-"><code class="lang-c"><span class="token keyword">void</span>
<span class="token function">octeon_request_completion_bh</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">octeon_device_t</span>    <span class="token operator">*</span>octeon_dev <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">octeon_device_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>pdev<span class="token punctuation">;</span>

    octeon_dev<span class="token operator">-&gt;</span>stats<span class="token punctuation">.</span>comp_tasklet_count<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token comment">/* process_ordered_list returns 1 if list is empty. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CVMCS_DMA_IC</span></span>
    <span class="token comment">/* No need to schedule this again, if too many pending,
      * then we got DMA_COUNT interrupt immediately */</span>
    <span class="token function">process_ordered_list</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">process_ordered_list</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">cavium_tasklet_schedule</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octeon_dev<span class="token operator">-&gt;</span>comp_tasklet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token function">check_unordered_blocking_list</span><span class="token punctuation">(</span>octeon_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="smartNIC_liquidIO_代码阅读driver篇之结构体.html" class="navigation navigation-prev " aria-label="Previous page: PCI-NIC 代码阅读 --driver篇之结构体">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="smartNIC_liquidIO_代码阅读真NIC篇.html" class="navigation navigation-next " aria-label="Next page: PCI-NIC 代码阅读 --真NIC篇">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"PCI-NIC 代码阅读 --driver篇","level":"1.16.12.3.4","depth":4,"next":{"title":"PCI-NIC 代码阅读 --真NIC篇","level":"1.16.12.3.5","depth":4,"path":"notes/smartNIC_liquidIO_代码阅读真NIC篇.md","ref":"notes/smartNIC_liquidIO_代码阅读真NIC篇.md","articles":[]},"previous":{"title":"PCI-NIC 代码阅读 --driver篇之结构体","level":"1.16.12.3.3","depth":4,"path":"notes/smartNIC_liquidIO_代码阅读driver篇之结构体.md","ref":"notes/smartNIC_liquidIO_代码阅读driver篇之结构体.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-livereload","-sharing","-lunr","-search","search-plus","-highlight","theme-comscore","prism","code","chapter-fold","github","splitter","wide-page","hide-navigation-buttons","anchor-navigation-ex","sequence@0.1.1","mermaid-gb3"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"chapter-fold":{},"prism":{"css":["prismjs/themes/prism.css"],"ignore":["mermaid","sequence"]},"sequence":{"theme":"simple"},"github":{"url":"https://github.com/Bai-Yingjie/Bai-Yingjie.github.io"},"splitter":{},"wide-page":{},"code":{"copyButtons":true},"fontsettings":{"theme":"white","family":"sans","size":2},"hide-navigation-buttons":{},"mermaid-gb3":{},"anchor-navigation-ex":{"mode":"float","pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"isRewritePageTitle":true,"showLevel":true,"tocLevel1Icon":"fa fa-hand-o-right","tocLevel2Icon":"fa fa-hand-o-right","tocLevel3Icon":"fa fa-hand-o-right","showGoTop":true,"isShowTocTitleIcon":true,"printLog":false,"multipleH1":true,"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false}},"theme-comscore":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"theme":"default","author":"Bai Yingjie","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"My Notes","language":"zh-hans","gitbook":"*"},"file":{"path":"notes/smartNIC_liquidIO_代码阅读driver篇.md","mtime":"2024-08-09T01:54:16.012Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2024-08-09T01:55:08.517Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-mermaid-gb3/book/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-theme-comscore/test.js"></script>
        
    

    <script src="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.min.js"></script>

    </body>
</html>

