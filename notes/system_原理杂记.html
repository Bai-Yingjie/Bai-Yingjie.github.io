
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>系统原理杂记 · My Notes</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Bai Yingjie">
        
        
    
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-wide-page/wide.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hide-navigation-buttons/index.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-theme-comscore/test.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    


    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="system_alpine.html" />
    
    
    <link rel="prev" href="system_libc_part3.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="as_title_kaiyuan.html">
            
                <a href="as_title_kaiyuan.html">
            
                    
                    开源
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="my_opensource.html">
            
                <a href="my_opensource.html">
            
                    
                    我的开源项目
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="my_upstream.html">
            
                <a href="my_upstream.html">
            
                    
                    我的upstream commit
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="as_title_system.html">
            
                <a href="as_title_system.html">
            
                    
                    系统分析和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="as_title_perf_misc.html">
            
                <a href="as_title_perf_misc.html">
            
                    
                    调试和分析记录系列
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="profiling_调试和分析记录5.html">
            
                <a href="profiling_调试和分析记录5.html">
            
                    
                    调试和分析记录5
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="profiling_调试和分析记录4.html">
            
                <a href="profiling_调试和分析记录4.html">
            
                    
                    调试和分析记录4
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.3" data-path="profiling_调试和分析记录3.html">
            
                <a href="profiling_调试和分析记录3.html">
            
                    
                    调试和分析记录3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.4" data-path="profiling_调试和分析记录2.html">
            
                <a href="profiling_调试和分析记录2.html">
            
                    
                    调试和分析记录2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.5" data-path="profiling_调试和分析记录1.html">
            
                <a href="profiling_调试和分析记录1.html">
            
                    
                    调试和分析记录1
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="调试和分析工具概览.html">
            
                <a href="调试和分析工具概览.html">
            
                    
                    profiling和debugging工具相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="profiling_Linux内核调试的方式以及工具集锦.html">
            
                <a href="profiling_Linux内核调试的方式以及工具集锦.html">
            
                    
                    Linux内核调试的方式以及工具集锦(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2" data-path="profiling_user_space_Ptrace_Utrace_Uprobes.html">
            
                <a href="profiling_user_space_Ptrace_Utrace_Uprobes.html">
            
                    
                    Ptrace, Utrace, Uprobes: Lightweight, Dynamic Tracing of User Apps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3" data-path="debugging_gdb备忘录.html">
            
                <a href="debugging_gdb备忘录.html">
            
                    
                    gdb备忘录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.4" data-path="profiling_perf命令备忘录.html">
            
                <a href="profiling_perf命令备忘录.html">
            
                    
                    perf命令备忘录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.5" data-path="profiling_perf命令备忘录2.html">
            
                <a href="profiling_perf命令备忘录2.html">
            
                    
                    perf命令备忘录2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6" data-path="profiling_perf学习笔记之实战篇.html">
            
                <a href="profiling_perf学习笔记之实战篇.html">
            
                    
                    perf学习笔记之实战篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.7" data-path="profiling_perf学习笔记之入门篇.html">
            
                <a href="profiling_perf学习笔记之入门篇.html">
            
                    
                    perf学习笔记之入门篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.8" data-path="profiling_用kprobe和perf_记录函数参数.html">
            
                <a href="profiling_用kprobe和perf_记录函数参数.html">
            
                    
                    使用kprobe和perf结合记录函数参数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.9" data-path="profiling_ftrace和trace-cmd记录.html">
            
                <a href="profiling_ftrace和trace-cmd记录.html">
            
                    
                    ftrace和trace-cmd记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.10" data-path="profiling_ftrace使用实例.html">
            
                <a href="profiling_ftrace使用实例.html">
            
                    
                    ftrace使用实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.11" data-path="profiling_systemtap实例.html">
            
                <a href="profiling_systemtap实例.html">
            
                    
                    systemtap实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.12" data-path="profiling_systemtap基础.html">
            
                <a href="profiling_systemtap基础.html">
            
                    
                    systemtap基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.13" data-path="profiling_perf-tools_example.html">
            
                <a href="profiling_perf-tools_example.html">
            
                    
                    perf-tools 系统tracing工具集
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.14" data-path="profiling_Comparing_SystemTap_and_bpftrace.html">
            
                <a href="profiling_Comparing_SystemTap_and_bpftrace.html">
            
                    
                    Comparing SystemTap and bpftrace(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.15" data-path="system_analysis_bcc和ebpf.html">
            
                <a href="system_analysis_bcc和ebpf.html">
            
                    
                    bcc和ebpf(starting)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="as_title_os_perf.html">
            
                <a href="as_title_os_perf.html">
            
                    
                    profiling和debugging实例
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="profiling_调查ftrace显示调用栈全0问题.html">
            
                <a href="profiling_调查ftrace显示调用栈全0问题.html">
            
                    
                    调查ftrace显示调用栈全0问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2" data-path="profiling_eoe_filter写tap设备失败问题.html">
            
                <a href="profiling_eoe_filter写tap设备失败问题.html">
            
                    
                    eoe_filter写tap设备失败问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.3" data-path="performance_ovs进程调查.html">
            
                <a href="performance_ovs进程调查.html">
            
                    
                    OVS进程调查
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.4" data-path="performance_ping流程和函数调用解析.html">
            
                <a href="performance_ping流程和函数调用解析.html">
            
                    
                    ping流程和函数调用解析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.5" data-path="profiling_VM互相ping场景下的延迟分析.html">
            
                <a href="profiling_VM互相ping场景下的延迟分析.html">
            
                    
                    VM互相ping场景下的延迟分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.6" data-path="debugging_ftrace_谁创建了bond0设备.html">
            
                <a href="debugging_ftrace_谁创建了bond0设备.html">
            
                    
                    谁创建了bond0设备: ftrace kprobe uprobe perf综合使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.7" data-path="profiling_unixbench之filecopy分析.html">
            
                <a href="profiling_unixbench之filecopy分析.html">
            
                    
                    unixbench之file copy分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.8" data-path="profiling_lmbench之lat_tcp分析.html">
            
                <a href="profiling_lmbench之lat_tcp分析.html">
            
                    
                    lmbench之lat_tcp分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="as_title_arch_perf.html">
            
                <a href="as_title_arch_perf.html">
            
                    
                    CPU ARCH相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.4.1" data-path="performance_CPU_microarchiteture_pmu.html">
            
                <a href="performance_CPU_microarchiteture_pmu.html">
            
                    
                    Top-down Microarchitecture Analysis Method(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="as_title_cloud.html">
            
                <a href="as_title_cloud.html">
            
                    
                    Cloud和容器相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="cloud_杂记.html">
            
                <a href="cloud_杂记.html">
            
                    
                    云杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="container_当代容器读书笔记.html">
            
                <a href="container_当代容器读书笔记.html">
            
                    
                    当代容器读书笔记
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="as_title_vdevice.html">
            
                <a href="as_title_vdevice.html">
            
                    
                    CPU和device虚拟化
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="as_title_gvisor.html">
            
                <a href="as_title_gvisor.html">
            
                    
                    gvisor
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1.1" data-path="golang_gvisor代码_KVM.html">
            
                <a href="golang_gvisor代码_KVM.html">
            
                    
                    gvisor KVM模式代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.2" data-path="golang_gvisor调试.html">
            
                <a href="golang_gvisor调试.html">
            
                    
                    gvisor调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.3" data-path="golang_gvisor_ptrace.html">
            
                <a href="golang_gvisor_ptrace.html">
            
                    
                    gvisor ptrace模式介绍(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="rust_vmm_brief.html">
            
                <a href="rust_vmm_brief.html">
            
                    
                    rust VMM(virtual machine monitor)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.1" data-path="rust_vmm_简介.html">
            
                <a href="rust_vmm_简介.html">
            
                    
                    rust-vmm简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.2" data-path="rust_firecracker_代码.html">
            
                <a href="rust_firecracker_代码.html">
            
                    
                    firecracker代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.3" data-path="rust_firecracker_使用.html">
            
                <a href="rust_firecracker_使用.html">
            
                    
                    firecracker使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.4" data-path="rust_cloud-hypervisor_代码.html">
            
                <a href="rust_cloud-hypervisor_代码.html">
            
                    
                    cloud hypervisor代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.5" data-path="rust_cloud-hypervisor_使用.html">
            
                <a href="rust_cloud-hypervisor_使用.html">
            
                    
                    cloud hypervisor使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.6" data-path="rust_cloud-hypervisor_问题与解决.html">
            
                <a href="rust_cloud-hypervisor_问题与解决.html">
            
                    
                    cloud hypervisor问题与解决
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="virtualization_virtio规范阅读笔记.html">
            
                <a href="virtualization_virtio规范阅读笔记.html">
            
                    
                    virtio规范阅读笔记.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="qemu_ovs_虚拟化环境.html">
            
                <a href="qemu_ovs_虚拟化环境.html">
            
                    
                    qemu OVS 虚拟化环境准备
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="qemu使用.html">
            
                <a href="qemu使用.html">
            
                    
                    Qemu使用(old)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="qemu_binary_translation.html">
            
                <a href="qemu_binary_translation.html">
            
                    
                    QEMU 指令翻译
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="as_title_networking.html">
            
                <a href="as_title_networking.html">
            
                    
                    计算机网络相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="networking_杂记2.html">
            
                <a href="networking_杂记2.html">
            
                    
                    networking杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="networking_杂记1.html">
            
                <a href="networking_杂记1.html">
            
                    
                    networking杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="networking_优化linux网络栈_接收路径.html">
            
                <a href="networking_优化linux网络栈_接收路径.html">
            
                    
                    优化linux网络栈: 接收路径(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="networking_优化linux网络栈_发送路径.html">
            
                <a href="networking_优化linux网络栈_发送路径.html">
            
                    
                    优化linux网络栈: 发送路径(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="networking_Potential_Performance_Bottleneck_in_Linux_TCP.html">
            
                <a href="networking_Potential_Performance_Bottleneck_in_Linux_TCP.html">
            
                    
                    Potential Performance Bottleneck in Linux TCP(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="networking_xdp入门.html">
            
                <a href="networking_xdp入门.html">
            
                    
                    Get started with XDP(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="networking_linux收包路径图解.html">
            
                <a href="networking_linux收包路径图解.html">
            
                    
                    linux收包路径图解(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8" data-path="as_title_qemu_ovs.html">
            
                <a href="as_title_qemu_ovs.html">
            
                    
                    Qemu OVS和DPDK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.8.1" data-path="OVS_DPDK_编译运行.html">
            
                <a href="OVS_DPDK_编译运行.html">
            
                    
                    OVS-DPDK编译运行
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8.2" data-path="OVS_架构和代码.html">
            
                <a href="OVS_架构和代码.html">
            
                    
                    OVS架构和代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8.3" data-path="OVS_DPDK_performance_HXT_ARM_server.html">
            
                <a href="OVS_DPDK_performance_HXT_ARM_server.html">
            
                    
                    OVS-DPDK for ARM server 性能测试环境
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8.4" data-path="DPDK_Mellanox.html">
            
                <a href="DPDK_Mellanox.html">
            
                    
                    DPDK Mellanox
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8.5" data-path="OVS_phy-vm-phy.html">
            
                <a href="OVS_phy-vm-phy.html">
            
                    
                    OVS PHY-VM-PHY
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8.6" data-path="networking_网络虚拟化用例记录.html">
            
                <a href="networking_网络虚拟化用例记录.html">
            
                    
                    网络虚拟化用例记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8.7" data-path="networking_网络虚拟化操作记录.html">
            
                <a href="networking_网络虚拟化操作记录.html">
            
                    
                    网络虚拟化操作记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.9" data-path="as_title_virtnet.html">
            
                <a href="as_title_virtnet.html">
            
                    
                    虚拟化网络
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.9.1" data-path="networking_tc_filter_连接veth和tap.html">
            
                <a href="networking_tc_filter_连接veth和tap.html">
            
                    
                    Connecting a veth device to tap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.2" data-path="networking_multicast_vxlan_flannel.html">
            
                <a href="networking_multicast_vxlan_flannel.html">
            
                    
                    multicast vxlan和flannel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.3" data-path="networking_virtio网络介绍.html">
            
                <a href="networking_virtio网络介绍.html">
            
                    
                    virtio网络介绍(网摘): vhost-net virtio-net vhost-user SRIOV
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.4" data-path="networking_virtualization_杂记.html">
            
                <a href="networking_virtualization_杂记.html">
            
                    
                    虚拟化网络杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.5" data-path="networking_linux虚拟网络接口.html">
            
                <a href="networking_linux虚拟网络接口.html">
            
                    
                    linux虚拟网络接口(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="as_title_arm_server.html">
            
                <a href="as_title_arm_server.html">
            
                    
                    ARM server
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="arm_server_杂记.html">
            
                <a href="arm_server_杂记.html">
            
                    
                    Arm server 杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="server_知识点.html">
            
                <a href="server_知识点.html">
            
                    
                    server知识点
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="as_title_embedded.html">
            
                <a href="as_title_embedded.html">
            
                    
                    嵌入式系统开发调试
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="embedded_debugging.html">
            
                <a href="embedded_debugging.html">
            
                    
                    嵌入式调试杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="uboot_杂记.html">
            
                <a href="uboot_杂记.html">
            
                    
                    uboot杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="buildroot_杂记.html">
            
                <a href="buildroot_杂记.html">
            
                    
                    buildroot杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="toolchain_升级gcc问题解决.html">
            
                <a href="toolchain_升级gcc问题解决.html">
            
                    
                    升级GCC7.3问题解决
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="kernel_异常打印分析实例.html">
            
                <a href="kernel_异常打印分析实例.html">
            
                    
                    kernel bug异常打印分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="as_title_linuxdaily.html">
            
                <a href="as_title_linuxdaily.html">
            
                    
                    Linux工程实践
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="linux_日常使用.html">
            
                <a href="linux_日常使用.html">
            
                    
                    日常linux使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="git_日常使用.html">
            
                <a href="git_日常使用.html">
            
                    
                    日常git使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="向kernel提交补丁.html">
            
                <a href="向kernel提交补丁.html">
            
                    
                    向kernel提交补丁
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="linux_ssh_relay.html">
            
                <a href="linux_ssh_relay.html">
            
                    
                    ssh relay
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5" data-path="gitlab_ci.html">
            
                <a href="gitlab_ci.html">
            
                    
                    gitlab CI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.6" data-path="docker_操作记录.html">
            
                <a href="docker_操作记录.html">
            
                    
                    docker操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.7" data-path="centos_操作记录.html">
            
                <a href="centos_操作记录.html">
            
                    
                    centos操作记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="as_title_golang.html">
            
                <a href="as_title_golang.html">
            
                    
                    Golang
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="as_title_golang1.html">
            
                <a href="as_title_golang1.html">
            
                    
                    入门
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1.1" data-path="golang_语法基础.html">
            
                <a href="golang_语法基础.html">
            
                    
                    Golang 语法基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.1.2" data-path="golang_json性能.html">
            
                <a href="golang_json性能.html">
            
                    
                    Golang json性能比较
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="golang_原理.html">
            
                <a href="golang_原理.html">
            
                    
                    Golang 原理相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.2.1" data-path="golang_interface原理.html">
            
                <a href="golang_interface原理.html">
            
                    
                    Golang interface原理(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2.2" data-path="golang_内存分配.html">
            
                <a href="golang_内存分配.html">
            
                    
                    Golang 内存分配(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="golang_标准库.html">
            
                <a href="golang_标准库.html">
            
                    
                    Golang 标准库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="golang_泛型.html">
            
                <a href="golang_泛型.html">
            
                    
                    Golang 泛型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="golang_我的反射代码.html">
            
                <a href="golang_我的反射代码.html">
            
                    
                    Golang 我的反射代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6" data-path="golang_问答.html">
            
                <a href="golang_问答.html">
            
                    
                    Golang 问答
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.7" data-path="golang_高效go.html">
            
                <a href="golang_高效go.html">
            
                    
                    Golang 高效go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8" data-path="golang_进阶.html">
            
                <a href="golang_进阶.html">
            
                    
                    Golang 进阶
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9" data-path="as_title_golang2.html">
            
                <a href="as_title_golang2.html">
            
                    
                    Golang 杂记
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.9.1" data-path="golang_杂记1.html">
            
                <a href="golang_杂记1.html">
            
                    
                    Golang 杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9.2" data-path="golang_杂记2.html">
            
                <a href="golang_杂记2.html">
            
                    
                    Golang 杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9.3" data-path="golang_杂记3.html">
            
                <a href="golang_杂记3.html">
            
                    
                    Golang 杂记3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9.4" data-path="golang_lib选型.html">
            
                <a href="golang_lib选型.html">
            
                    
                    Golang lib选型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9.5" data-path="golang_mod_proxy.html">
            
                <a href="golang_mod_proxy.html">
            
                    
                    go mod和go proxy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9.6" data-path="golang_汇编_arm64.html">
            
                <a href="golang_汇编_arm64.html">
            
                    
                    Golang 汇编语法和arm64小知识
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9.7" data-path="golang_cgo_swig.html">
            
                <a href="golang_cgo_swig.html">
            
                    
                    go调用c可以用swig
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.10" data-path="as_title_golang3.html">
            
                <a href="as_title_golang3.html">
            
                    
                    Golang 环境和工具链生成
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.10.1" data-path="golang_toolchain_ppc.html">
            
                <a href="golang_toolchain_ppc.html">
            
                    
                    go tools增加ppc32支持
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.2" data-path="golang_toolchain_compile_gccgo.html">
            
                <a href="golang_toolchain_compile_gccgo.html">
            
                    
                    编译gccgo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.3" data-path="golang_go_on_mips.html">
            
                <a href="golang_go_on_mips.html">
            
                    
                    go on mips boards(not so updated)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.10.3.1" data-path="golang_go_on_mips_part1.html">
            
                <a href="golang_go_on_mips_part1.html">
            
                    
                    part 1: cross compile go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.3.2" data-path="golang_go_on_mips_part2.html">
            
                <a href="golang_go_on_mips_part2.html">
            
                    
                    part 2: build native go compiler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.3.3" data-path="golang_go_on_mips_part3.html">
            
                <a href="golang_go_on_mips_part3.html">
            
                    
                    part 3: gccgo experiments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.3.4" data-path="golang_go_on_mips_part4.html">
            
                <a href="golang_go_on_mips_part4.html">
            
                    
                    part 4: Golang json performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.3.5" data-path="golang_gentoo_on_mips_board_and_build_go.html">
            
                <a href="golang_gentoo_on_mips_board_and_build_go.html">
            
                    
                    Gentoo on mips board and build go
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.11" data-path="as_title_golang4.html">
            
                <a href="as_title_golang4.html">
            
                    
                    微服务
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.11.1" data-path="golang_micro.html">
            
                <a href="golang_micro.html">
            
                    
                    go-micro和micro
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.2" data-path="golang_微服务概念.html">
            
                <a href="golang_微服务概念.html">
            
                    
                    微服务概念
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.12" data-path="as_title_golang5.html">
            
                <a href="as_title_golang5.html">
            
                    
                    解释器和编解码
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.12.1" data-path="golang_yeagi.html">
            
                <a href="golang_yeagi.html">
            
                    
                    解释器yeagi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.2" data-path="golang_tengo.html">
            
                <a href="golang_tengo.html">
            
                    
                    解释器tengo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.3" data-path="golang_govaluate.html">
            
                <a href="golang_govaluate.html">
            
                    
                    解释器govaluate
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.4" data-path="golang_encoding_gotiny.html">
            
                <a href="golang_encoding_gotiny.html">
            
                    
                    gotiny编解码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.5" data-path="golang_abs.html">
            
                <a href="golang_abs.html">
            
                    
                    解释器abs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.13" data-path="as_title_golang6.html">
            
                <a href="as_title_golang6.html">
            
                    
                    调试和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.13.1" data-path="golang_调试记录.html">
            
                <a href="golang_调试记录.html">
            
                    
                    Golang 调试记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.2" data-path="golang_topid性能优化.html">
            
                <a href="golang_topid性能优化.html">
            
                    
                    Golang topid性能优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.3" data-path="golang_gshell性能调试.html">
            
                <a href="golang_gshell性能调试.html">
            
                    
                    Golang gshell性能调试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.14" data-path="as_title_golang7.html">
            
                <a href="as_title_golang7.html">
            
                    
                    网络和消息中间件
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.14.1" data-path="golang_zmq.html">
            
                <a href="golang_zmq.html">
            
                    
                    消息中间件基本概念和zero mq
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.14.2" data-path="golang_mango.html">
            
                <a href="golang_mango.html">
            
                    
                    消息中间件mango
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.14.3" data-path="golang_libp2p.html">
            
                <a href="golang_libp2p.html">
            
                    
                    Golang p2p网络
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="as_title_rust.html">
            
                <a href="as_title_rust.html">
            
                    
                    Rust
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="rust_入门_brief.html">
            
                <a href="rust_入门_brief.html">
            
                    
                    Rust 入门系列
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1.1" data-path="rust_books.html">
            
                <a href="rust_books.html">
            
                    
                    Rust reference books
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.2" data-path="rust_入门1.html">
            
                <a href="rust_入门1.html">
            
                    
                    Rust 安装和基础语法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.3" data-path="rust_入门2.html">
            
                <a href="rust_入门2.html">
            
                    
                    Rust 泛型和内存所有权
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.4" data-path="rust_入门3.html">
            
                <a href="rust_入门3.html">
            
                    
                    Rust 闭包 容器 迭代器 生成器 线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.5" data-path="rust_工程构建.html">
            
                <a href="rust_工程构建.html">
            
                    
                    Rust 工程构建
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="rust_coding_brief.html">
            
                <a href="rust_coding_brief.html">
            
                    
                    Rust 代码积累
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.2.1" data-path="rust_序列化.html">
            
                <a href="rust_序列化.html">
            
                    
                    Rust 序列化原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.2" data-path="rust_知识点积累.html">
            
                <a href="rust_知识点积累.html">
            
                    
                    Rust 知识点更新
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.3" data-path="rust_adaptiveservice.html">
            
                <a href="rust_adaptiveservice.html">
            
                    
                    rust版本的adaptiveservice探索
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.4" data-path="rust_常用设施.html">
            
                <a href="rust_常用设施.html">
            
                    
                    Rust 常用设施
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.5" data-path="rust_代码小段.html">
            
                <a href="rust_代码小段.html">
            
                    
                    Rust 代码小段
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="others.html">
            
                <a href="others.html">
            
                    
                    其他
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.3.1" data-path="rust_mdbook_使用.html">
            
                <a href="rust_mdbook_使用.html">
            
                    
                    Rust 使用mdbook
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="as_title_scripts.html">
            
                <a href="as_title_scripts.html">
            
                    
                    脚本
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="shell_变量.html">
            
                <a href="shell_变量.html">
            
                    
                    shell变量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="shell_基础篇.html">
            
                <a href="shell_基础篇.html">
            
                    
                    shell命令和脚本记录-基础篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="shell_高级篇.html">
            
                <a href="shell_高级篇.html">
            
                    
                    shell命令和脚本记录-高级篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.4" data-path="shell_脚本片段.html">
            
                <a href="shell_脚本片段.html">
            
                    
                    shell脚本片段
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.5" data-path="python_记录.html">
            
                <a href="python_记录.html">
            
                    
                    python记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.6" data-path="lua_记录.html">
            
                <a href="lua_记录.html">
            
                    
                    lua记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.7" data-path="shell_rds脚本阅读.html">
            
                <a href="shell_rds脚本阅读.html">
            
                    
                    RDS脚本阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.8" data-path="Project_Euler.html">
            
                <a href="Project_Euler.html">
            
                    
                    Project Euler
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="as_title_app.html">
            
                <a href="as_title_app.html">
            
                    
                    应用相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="app_sysbench代码分析.html">
            
                <a href="app_sysbench代码分析.html">
            
                    
                    sysbench代码分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="as_title_algorithm.html">
            
                <a href="as_title_algorithm.html">
            
                    
                    算法相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" data-path="algorithm_radix_tree.html">
            
                <a href="algorithm_radix_tree.html">
            
                    
                    基数(radix)树(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="as_title_cos.html">
            
                <a href="as_title_cos.html">
            
                    
                    C和Operating System
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.1" data-path="system_libc_part1.html">
            
                <a href="system_libc_part1.html">
            
                    
                    libc概览1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="system_libc_part2.html">
            
                <a href="system_libc_part2.html">
            
                    
                    libc概览2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.3" data-path="system_libc_part3.html">
            
                <a href="system_libc_part3.html">
            
                    
                    libc概览3
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.15.4" data-path="system_原理杂记.html">
            
                <a href="system_原理杂记.html">
            
                    
                    系统原理杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.5" data-path="system_alpine.html">
            
                <a href="system_alpine.html">
            
                    
                    Alpine Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.6" data-path="system_进程间通信.html">
            
                <a href="system_进程间通信.html">
            
                    
                    进程间通信
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.7" data-path="system_特殊功能fd.html">
            
                <a href="system_特殊功能fd.html">
            
                    
                    eventfd timerfd signalfd和fd共享
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8" data-path="c_automake_autoconf.html">
            
                <a href="c_automake_autoconf.html">
            
                    
                    automake autoconf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.9" data-path="makefile_原理和实践.html">
            
                <a href="makefile_原理和实践.html">
            
                    
                    makefile
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.10" data-path="c_编程杂记高级篇.html">
            
                <a href="c_编程杂记高级篇.html">
            
                    
                    C编程杂记高级篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.11" data-path="c_编程杂记基础篇.html">
            
                <a href="c_编程杂记基础篇.html">
            
                    
                    C编程杂记基础篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.12" data-path="c_networking_socket高阶用法.html">
            
                <a href="c_networking_socket高阶用法.html">
            
                    
                    网络编程: Advanced Socket Topics(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.13" data-path="c_protobuf介绍.html">
            
                <a href="c_protobuf介绍.html">
            
                    
                    序列化: protobuf介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.14" data-path="c_进程间通信_共享文件和共享内存.html">
            
                <a href="c_进程间通信_共享文件和共享内存.html">
            
                    
                    进程间通信: 共享文件和共享内存(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.15" data-path="c_pthread_condition和mutex.html">
            
                <a href="c_pthread_condition和mutex.html">
            
                    
                    并发 任务 事件 和锁.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.16" data-path="kernel_user_space_howto.html">
            
                <a href="kernel_user_space_howto.html">
            
                    
                    kernel space和user space交互(网摘, linux2.6)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.17" data-path="CentOS_系统性能优化配置.html">
            
                <a href="CentOS_系统性能优化配置.html">
            
                    
                    CentOS 性能优化系统配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.18" data-path="OS_gentoo使用.html">
            
                <a href="OS_gentoo使用.html">
            
                    
                    gentoo使用记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="as_title_driver.html">
            
                <a href="as_title_driver.html">
            
                    
                    内核 设备和驱动相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1" data-path="device_driver_地址空间类型和DMA.html">
            
                <a href="device_driver_地址空间类型和DMA.html">
            
                    
                    地址空间类型和DMA
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.2" data-path="platform_device_driver.html">
            
                <a href="platform_device_driver.html">
            
                    
                    平台驱动杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3" data-path="platform_device_driver2.html">
            
                <a href="platform_device_driver2.html">
            
                    
                    平台驱动杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.4" data-path="device_driver_pci驱动概述.html">
            
                <a href="device_driver_pci驱动概述.html">
            
                    
                    pci驱动概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.5" data-path="device_driver_内核中的时间和延迟操作.html">
            
                <a href="device_driver_内核中的时间和延迟操作.html">
            
                    
                    内核中的时间和延迟操作.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.6" data-path="device_driver_杂记.html">
            
                <a href="device_driver_杂记.html">
            
                    
                    驱动调试杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.7" data-path="device_localbus_16bit读写.html">
            
                <a href="device_localbus_16bit读写.html">
            
                    
                    CPLD做8bit到16bit转换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.8" data-path="driver_位域和大小端.html">
            
                <a href="driver_位域和大小端.html">
            
                    
                    位域和大小端
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.9" data-path="as_title_driver1.html">
            
                <a href="as_title_driver1.html">
            
                    
                    nand
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.9.1" data-path="device_driver_octeon_nand.html">
            
                <a href="device_driver_octeon_nand.html">
            
                    
                    octeon nand flash驱动
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.9.2" data-path="device_driver_nand概率写失败问题分析.html">
            
                <a href="device_driver_nand概率写失败问题分析.html">
            
                    
                    Nand flash概率写失败问题分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.10" data-path="octeon_remote_pci.html">
            
                <a href="octeon_remote_pci.html">
            
                    
                    octeon remote-pci.c阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.11" data-path="Device_VFIO_notes.html">
            
                <a href="Device_VFIO_notes.html">
            
                    
                    VFIO简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12" data-path="as_title_driver2.html">
            
                <a href="as_title_driver2.html">
            
                    
                    智能网卡和DPDK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.12.1" data-path="smartNIC_智能网卡对比.html">
            
                <a href="smartNIC_智能网卡对比.html">
            
                    
                    智能网卡对比
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.2" data-path="octeon_pci_NIC.html">
            
                <a href="octeon_pci_NIC.html">
            
                    
                    octeon PCI NIC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.3" data-path="as_title_driver3.html">
            
                <a href="as_title_driver3.html">
            
                    
                    octeon liquidIO
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.12.3.1" data-path="smartNIC_liquidIO_代码阅读app篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读app篇.html">
            
                    
                    PCI-NIC 代码阅读 --app篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.3.2" data-path="smartNIC_liquidIO_代码阅读api篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读api篇.html">
            
                    
                    PCI-NIC 代码阅读 --api篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.3.3" data-path="smartNIC_liquidIO_代码阅读driver篇之结构体.html">
            
                <a href="smartNIC_liquidIO_代码阅读driver篇之结构体.html">
            
                    
                    PCI-NIC 代码阅读 --driver篇之结构体
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.3.4" data-path="smartNIC_liquidIO_代码阅读driver篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读driver篇.html">
            
                    
                    PCI-NIC 代码阅读 --driver篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.3.5" data-path="smartNIC_liquidIO_代码阅读真NIC篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读真NIC篇.html">
            
                    
                    PCI-NIC 代码阅读 --真NIC篇
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.12.4" data-path="networking_dpdk使用_2014.html">
            
                <a href="networking_dpdk使用_2014.html">
            
                    
                    DPDK使用(2014)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.13" data-path="device_nvme要点介绍.html">
            
                <a href="device_nvme要点介绍.html">
            
                    
                    nvme要点介绍
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="as_title_cpu.html">
            
                <a href="as_title_cpu.html">
            
                    
                    CPU Arch相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.1" data-path="CPU_interconnection_networks.html">
            
                <a href="CPU_interconnection_networks.html">
            
                    
                    CPU核互联模型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.2" data-path="cache_CPU和cache一致性原理.html">
            
                <a href="cache_CPU和cache一致性原理.html">
            
                    
                    CPU和cache一致性原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3" data-path="as_title_cpu1.html">
            
                <a href="as_title_cpu1.html">
            
                    
                    ARM64
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.3.1" data-path="CPU_ARM64_thunder_overview.html">
            
                <a href="CPU_ARM64_thunder_overview.html">
            
                    
                    thunder 概览
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.2" data-path="CPU_ARM64_thunder_开发板操作记录.html">
            
                <a href="CPU_ARM64_thunder_开发板操作记录.html">
            
                    
                    thunder 开发板操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.3" data-path="CPU_ARM64_thunder_bdk.html">
            
                <a href="CPU_ARM64_thunder_bdk.html">
            
                    
                    thunder BDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.4" data-path="CPU_ARM64_thunder_efi_rtc.html">
            
                <a href="CPU_ARM64_thunder_efi_rtc.html">
            
                    
                    thunder RTC时间和efi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.5" data-path="CPU_ARM64_thunder_uefi_fdt.html">
            
                <a href="CPU_ARM64_thunder_uefi_fdt.html">
            
                    
                    thunder uefi和fdt
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.6" data-path="CPU_ARM64_thunder_atf.html">
            
                <a href="CPU_ARM64_thunder_atf.html">
            
                    
                    thunder atf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.7" data-path="CPU_ARM64_thunder_kernel_boot.html">
            
                <a href="CPU_ARM64_thunder_kernel_boot.html">
            
                    
                    thunder kernel启动打印流程
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17.4" data-path="as_title_cpu2.html">
            
                <a href="as_title_cpu2.html">
            
                    
                    PPC
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.4.1" data-path="CPU_PPC启动多核Linux_流程和内存映射.html">
            
                <a href="CPU_PPC启动多核Linux_流程和内存映射.html">
            
                    
                    PPC启动多核linux: 流程和内存映射
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.4.2" data-path="CPU_PPC_kernel升级记录.html">
            
                <a href="CPU_PPC_kernel升级记录.html">
            
                    
                    PPC kernel升级记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17.5" data-path="as_title_cpu3.html">
            
                <a href="as_title_cpu3.html">
            
                    
                    MIPS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.5.1" data-path="CPU_MIPS_octeon地址空间和寄存器访问.html">
            
                <a href="CPU_MIPS_octeon地址空间和寄存器访问.html">
            
                    
                    octeon 地址空间和寄存器访问
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.2" data-path="CPU_MIPS_octeon操作记录.html">
            
                <a href="CPU_MIPS_octeon操作记录.html">
            
                    
                    octeon 操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.3" data-path="CPU_MIPS_octeon_包处理性能.html">
            
                <a href="CPU_MIPS_octeon_包处理性能.html">
            
                    
                    octeon 系列处理器包处理性能
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.4" data-path="CPU_MIPS_octeon_ddr调试记录.html">
            
                <a href="CPU_MIPS_octeon_ddr调试记录.html">
            
                    
                    octeon DDR调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.5" data-path="CPU_MIPS_octeon_BDK.html">
            
                <a href="CPU_MIPS_octeon_BDK.html">
            
                    
                    octeon CN78xx BDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.6" data-path="kernel_增加ECC中断.html">
            
                <a href="kernel_增加ECC中断.html">
            
                    
                    octeon 增加ECC中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.7" data-path="CPU_MIPS_octeon_hw-ddr2代码走读.html">
            
                <a href="CPU_MIPS_octeon_hw-ddr2代码走读.html">
            
                    
                    octeon hw-ddr2代码走读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.8" data-path="CPU_MIPS_octeon_reboot调试和ddr中断.html">
            
                <a href="CPU_MIPS_octeon_reboot调试和ddr中断.html">
            
                    
                    octeon reboot调试和DDR中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.9" data-path="CPU_MIPS_octeon中断.html">
            
                <a href="CPU_MIPS_octeon中断.html">
            
                    
                    octeon 中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.10" data-path="CPU_MIPS_octeon原子操作.html">
            
                <a href="CPU_MIPS_octeon原子操作.html">
            
                    
                    octeon 原子操作
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.11" data-path="CPU_MIPS_octeon网口代码分析.html">
            
                <a href="CPU_MIPS_octeon网口代码分析.html">
            
                    
                    octeon 网口代码分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >系统原理杂记</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#seccomp&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><b>1. </b>seccomp&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</a></li><li><span class="title-icon "></span><a href="#&#x7CFB;&#x7EDF;&#x6743;&#x9650;"><b>2. </b>&#x7CFB;&#x7EDF;&#x6743;&#x9650;</a></li><li><span class="title-icon "></span><a href="#smaps&#x89E3;&#x6790;&#x6027;&#x80FD;"><b>3. </b>smaps&#x89E3;&#x6790;&#x6027;&#x80FD;</a></li><ul><li><span class="title-icon "></span><a href="#&#x6253;&#x5F00;smaps&#x6587;&#x4EF6;&#x672C;&#x8EAB;"><b>3.1. </b>&#x6253;&#x5F00;smaps&#x6587;&#x4EF6;&#x672C;&#x8EAB;</a></li><li><span class="title-icon "></span><a href="#&#x52A0;&#x4E0A;&#x5B57;&#x7B26;&#x4E32;&#x64CD;&#x505A;"><b>3.2. </b>&#x52A0;&#x4E0A;&#x5B57;&#x7B26;&#x4E32;&#x64CD;&#x505A;</a></li><li><span class="title-icon "></span><a href="#&#x7ED3;&#x8BBA;"><b>3.3. </b>&#x7ED3;&#x8BBA;</a></li></ul><li><span class="title-icon "></span><a href="#&#x4F7F;&#x7528;&#x5176;&#x4ED6;&#x7528;&#x6237;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;"><b>4. </b>&#x4F7F;&#x7528;&#x5176;&#x4ED6;&#x7528;&#x6237;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;</a></li><ul><li><span class="title-icon "></span><a href="#&#x6539;&#x53D8;&#x6587;&#x4EF6;&#x7684;owner&#x4E3A;nobodynogroup-&#x8BBE;&#x7F6E;setuid&#x5C5E;&#x6027;"><b>4.1. </b>&#x6539;&#x53D8;&#x6587;&#x4EF6;&#x7684;owner&#x4E3A;nobody:nogroup, &#x8BBE;&#x7F6E;setuid&#x5C5E;&#x6027;</a></li></ul><li><span class="title-icon "></span><a href="#ruid-euid"><b>5. </b>ruid euid</a></li><ul><li><span class="title-icon "></span><a href="#&#x4EC0;&#x4E48;&#x662F;uid-euid"><b>5.1. </b>&#x4EC0;&#x4E48;&#x662F;uid euid?</a></li><li><span class="title-icon "></span><a href="#&#x8865;&#x5145;"><b>5.2. </b>&#x8865;&#x5145;</a></li><li><span class="title-icon "></span><a href="#&#x5B9E;&#x9A8C;"><b>5.3. </b>&#x5B9E;&#x9A8C;</a></li><ul><li><span class="title-icon "></span><a href="#&#x7136;&#x540E;&#x7528;&#x666E;&#x901A;user&#x542F;&#x52A8;"><b>5.3.1. </b>&#x7136;&#x540E;&#x7528;&#x666E;&#x901A;user&#x542F;&#x52A8;</a></li><li><span class="title-icon "></span><a href="#&#x7528;root&#x542F;&#x52A8;"><b>5.3.2. </b>&#x7528;root&#x542F;&#x52A8;</a></li></ul><li><span class="title-icon "></span><a href="#&#x8FDB;&#x7A0B;&#x7684;&#x6743;&#x9650;&#x662F;&#x770B;ruid-&#x800C;&#x4E0D;&#x662F;euid"><b>5.4. </b>&#x8FDB;&#x7A0B;&#x7684;&#x6743;&#x9650;&#x662F;&#x770B;ruid, &#x800C;&#x4E0D;&#x662F;euid</a></li><li><span class="title-icon "></span><a href="#golang&#x6743;&#x9650;&#x964D;&#x7EA7;"><b>5.5. </b>golang&#x6743;&#x9650;&#x964D;&#x7EA7;</a></li></ul><li><span class="title-icon "></span><a href="#&#x4EC0;&#x4E48;&#x662F;defunct&#x8FDB;&#x7A0B;"><b>6. </b>&#x4EC0;&#x4E48;&#x662F;defunct&#x8FDB;&#x7A0B;?</a></li><li><span class="title-icon "></span><a href="#cgroup-v2"><b>7. </b>cgroup v2</a></li><ul><li><span class="title-icon "></span><a href="#&#x8FDB;&#x7A0B;"><b>7.1. </b>&#x8FDB;&#x7A0B;</a></li><li><span class="title-icon "></span><a href="#&#x7EBF;&#x7A0B;"><b>7.2. </b>&#x7EBF;&#x7A0B;</a></li><li><span class="title-icon "></span><a href="#&#x63A7;&#x5236;&#x5668;&#x4F7F;&#x80FD;"><b>7.3. </b>&#x63A7;&#x5236;&#x5668;&#x4F7F;&#x80FD;</a></li><li><span class="title-icon "></span><a href="#&#x4E0D;&#x63A8;&#x8350;&#x52A8;&#x6001;&#x8FC1;&#x79FB;pid"><b>7.4. </b>&#x4E0D;&#x63A8;&#x8350;&#x52A8;&#x6001;&#x8FC1;&#x79FB;pid</a></li><li><span class="title-icon "></span><a href="#&#x8D44;&#x6E90;&#x9650;&#x5236;&#x7C7B;&#x578B;"><b>7.5. </b>&#x8D44;&#x6E90;&#x9650;&#x5236;&#x7C7B;&#x578B;</a></li><li><span class="title-icon "></span><a href="#&#x63A7;&#x5236;&#x5668;&#x7C7B;&#x578B;"><b>7.6. </b>&#x63A7;&#x5236;&#x5668;&#x7C7B;&#x578B;</a></li><ul><li><span class="title-icon "></span><a href="#cpu"><b>7.6.1. </b>CPU</a></li><li><span class="title-icon "></span><a href="#&#x5185;&#x5B58;"><b>7.6.2. </b>&#x5185;&#x5B58;</a></li><li><span class="title-icon "></span><a href="#io"><b>7.6.3. </b>IO</a></li><li><span class="title-icon "></span><a href="#pid"><b>7.6.4. </b>PID</a></li><li><span class="title-icon "></span><a href="#cpuset"><b>7.6.5. </b>Cpuset</a></li></ul><li><span class="title-icon "></span><a href="#&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4EA4;&#x4E92;"><b>7.7. </b>&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4EA4;&#x4E92;</a></li><li><span class="title-icon "></span><a href="#&#x548C;v1&#x7684;&#x5BF9;&#x6BD4;"><b>7.8. </b>&#x548C;V1&#x7684;&#x5BF9;&#x6BD4;</a></li></ul><li><span class="title-icon "></span><a href="#&#x7CFB;&#x7EDF;&#x5185;&#x5B58;&#x5360;&#x7528;&#x5206;&#x6790;"><b>8. </b>&#x7CFB;&#x7EDF;&#x5185;&#x5B58;&#x5360;&#x7528;&#x5206;&#x6790;</a></li><ul><li><span class="title-icon "></span><a href="#&#x5176;&#x4ED6;&#x7EDF;&#x8BA1;"><b>8.1. </b>&#x5176;&#x4ED6;&#x7EDF;&#x8BA1;</a></li><li><span class="title-icon "></span><a href="#vm&#x53C2;&#x6570;"><b>8.2. </b>vm&#x53C2;&#x6570;</a></li><li><span class="title-icon "></span><a href="#&#x6587;&#x4EF6;&#x7F13;&#x5B58;"><b>8.3. </b>&#x6587;&#x4EF6;&#x7F13;&#x5B58;</a></li></ul><li><span class="title-icon "></span><a href="#cpu&#x5360;&#x7528;&#x7387;&#x5206;&#x6790;"><b>9. </b>CPU&#x5360;&#x7528;&#x7387;&#x5206;&#x6790;</a></li><ul><li><span class="title-icon "></span><a href="#per-cpu&#x7EDF;&#x8BA1;-user--sys--softirq--idle--iowait--100"><b>9.1. </b>per CPU&#x7EDF;&#x8BA1; user + sys + softirq + idle + iowait = 100</a></li><li><span class="title-icon "></span><a href="#softirq&#x73B0;&#x8C61;"><b>9.2. </b>softirq&#x73B0;&#x8C61;</a></li><li><span class="title-icon "></span><a href="#&#x7ED3;&#x8BBA;_1"><b>9.3. </b>&#x7ED3;&#x8BBA;</a></li><li><span class="title-icon "></span><a href="#&#x8865;&#x5145;_1"><b>9.4. </b>&#x8865;&#x5145;</a></li></ul><li><span class="title-icon "></span><a href="#&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;&#x5417;"><b>10. </b>&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;&#x5417;?</a></li><ul><li><span class="title-icon "></span><a href="#preemption-and-context-switching"><b>10.1. </b>Preemption and Context Switching</a></li><li><span class="title-icon "></span><a href="#user-preemption"><b>10.2. </b>User Preemption</a></li><li><span class="title-icon "></span><a href="#kernel-preemption"><b>10.3. </b>Kernel Preemption</a></li><li><span class="title-icon "></span><a href="#&#x8C03;&#x5EA6;&#x4EE3;&#x7801;"><b>10.4. </b>&#x8C03;&#x5EA6;&#x4EE3;&#x7801;</a></li><li><span class="title-icon "></span><a href="#&#x4E00;&#x4E9B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;-&#x53EF;&#x80FD;&#x4F1A;&#x963B;&#x585E;-&#x6B64;&#x65F6;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;"><b>10.5. </b>&#x4E00;&#x4E9B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;, &#x53EF;&#x80FD;&#x4F1A;&#x963B;&#x585E;, &#x6B64;&#x65F6;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;</a></li><li><span class="title-icon "></span><a href="#&#x8C03;&#x5EA6;&#x5668;&#x7684;&#x53C2;&#x8003;&#x6587;&#x7AE0;"><b>10.6. </b>&#x8C03;&#x5EA6;&#x5668;&#x7684;&#x53C2;&#x8003;&#x6587;&#x7AE0;</a></li></ul><li><span class="title-icon "></span><a href="#signal&#x7684;&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;&#x548C;&#x6253;&#x65AD;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><b>11. </b>signal&#x7684;&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;&#x548C;&#x6253;&#x65AD;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</a></li><ul><li><span class="title-icon "></span><a href="#&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;"><b>11.1. </b>&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;</a></li><li><span class="title-icon "></span><a href="#signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><b>11.2. </b>signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</a></li></ul><li><span class="title-icon "></span><a href="#&#x5185;&#x6838;&#x6536;&#x62A5;&#x6587;&#x7684;&#x65F6;&#x95F4;&#x7247;&#x7B97;&#x5728;&#x54EA;&#x91CC;"><b>12. </b>&#x5185;&#x6838;&#x6536;&#x62A5;&#x6587;&#x7684;&#x65F6;&#x95F4;&#x7247;&#x7B97;&#x5728;&#x54EA;&#x91CC;?</a></li><ul><li><span class="title-icon "></span><a href="#&#x80CC;&#x666F;-&#x9A71;&#x52A8;&#x4E2D;&#x65AD;&#x5728;&#x54EA;&#x91CC;&#x6267;&#x884C;"><b>12.1. </b>&#x80CC;&#x666F;: &#x9A71;&#x52A8;&#x4E2D;&#x65AD;&#x5728;&#x54EA;&#x91CC;&#x6267;&#x884C;?</a></li><li><span class="title-icon "></span><a href="#&#x4E2D;&#x65AD;&#x7EBF;&#x7A0B;&#x5316;&#x540E;&#x7684;cpu-load"><b>12.2. </b>&#x4E2D;&#x65AD;&#x7EBF;&#x7A0B;&#x5316;&#x540E;&#x7684;CPU load</a></li><li><span class="title-icon "></span><a href="#&#x5230;&#x5E95;&#x4EC0;&#x4E48;&#x662F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;"><b>12.3. </b>&#x5230;&#x5E95;&#x4EC0;&#x4E48;&#x662F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;?</a></li><li><span class="title-icon "></span><a href="#&#x8F6F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;"><b>12.4. </b>&#x8F6F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;</a></li><ul><li><span class="title-icon "></span><a href="#softirq&#x6FC0;&#x6D3B;"><b>12.4.1. </b>softirq&#x6FC0;&#x6D3B;</a></li><li><span class="title-icon "></span><a href="#ksoftirqd&#x7EBF;&#x7A0B;"><b>12.4.2. </b>ksoftirqd&#x7EBF;&#x7A0B;</a></li></ul><li><span class="title-icon "></span><a href="#&#x4E0A;&#x4E0B;&#x6587;&#x5206;&#x7C7B;"><b>12.5. </b>&#x4E0A;&#x4E0B;&#x6587;&#x5206;&#x7C7B;</a></li><li><span class="title-icon "></span><a href="#&#x6536;&#x62A5;&#x7684;&#x65F6;&#x95F4;&#x7B97;&#x5728;&#x54EA;&#x91CC;"><b>12.6. </b>&#x6536;&#x62A5;&#x7684;&#x65F6;&#x95F4;&#x7B97;&#x5728;&#x54EA;&#x91CC;?</a></li></ul><li><span class="title-icon "></span><a href="#socket&#x4EC0;&#x4E48;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x53D1;&#x751F;&#x77ED;&#x8BFB;short-readpartial-read"><b>13. </b>socket&#x4EC0;&#x4E48;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x53D1;&#x751F;&#x77ED;&#x8BFB;short read/partial read?</a></li><li><span class="title-icon "></span><a href="#socket&#x901A;&#x4FE1;&#x7684;&#x65F6;&#x5019;-&#x8981;&#x5728;&#x5E94;&#x7528;&#x4FA7;&#x505A;&#x5B57;&#x8282;&#x5E8F;&#x8F6C;&#x6362;&#x5417;"><b>14. </b>socket&#x901A;&#x4FE1;&#x7684;&#x65F6;&#x5019;, &#x8981;&#x5728;&#x5E94;&#x7528;&#x4FA7;&#x505A;&#x5B57;&#x8282;&#x5E8F;&#x8F6C;&#x6362;&#x5417;?</a></li><li><span class="title-icon "></span><a href="#socket&#x7684;stream&#x6A21;&#x5F0F;&#x548C;datagram&#x6A21;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x4E0D;&#x540C;"><b>15. </b>socket&#x7684;stream&#x6A21;&#x5F0F;&#x548C;datagram&#x6A21;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x4E0D;&#x540C;?</a></li><ul><li><span class="title-icon "></span><a href="#socket&#x57FA;&#x7840;"><b>15.1. </b>socket&#x57FA;&#x7840;</a></li><li><span class="title-icon "></span><a href="#sockstream"><b>15.2. </b>SOCK_STREAM</a></li><li><span class="title-icon "></span><a href="#sockseqpacket"><b>15.3. </b>SOCK_SEQPACKET</a></li><li><span class="title-icon "></span><a href="#sockdgram"><b>15.4. </b>SOCK_DGRAM</a></li><li><span class="title-icon "></span><a href="#man-7-ip"><b>15.5. </b>man 7 ip</a></li><li><span class="title-icon "></span><a href="#man-7-tcp"><b>15.6. </b>man 7 tcp</a></li><li><span class="title-icon "></span><a href="#man-7-udp"><b>15.7. </b>man 7 udp</a></li><li><span class="title-icon "></span><a href="#man-7-unix"><b>15.8. </b>man 7 unix</a></li><li><span class="title-icon "></span><a href="#&#x4EC0;&#x4E48;&#x662F;message-boundires"><b>15.9. </b>&#x4EC0;&#x4E48;&#x662F;message boundires?</a></li><ul><li><span class="title-icon "></span><a href="#tcp&#x7684;stream&#x6A21;&#x5F0F;&#x600E;&#x4E48;&#x5B9A;&#x754C;"><b>15.9.1. </b>TCP&#x7684;stream&#x6A21;&#x5F0F;&#x600E;&#x4E48;&#x5B9A;&#x754C;?</a></li></ul></ul><li><span class="title-icon "></span><a href="#cgroup&#x914D;&#x7F6E;"><b>16. </b>cgroup&#x914D;&#x7F6E;</a></li><ul><li><span class="title-icon "></span><a href="#&#x5199;&#x5165;pid"><b>16.1. </b>&#x5199;&#x5165;pid</a></li><li><span class="title-icon "></span><a href="#rt&#x8C03;&#x5EA6;&#x57DF;&#x7684;&#x914D;&#x989D;"><b>16.2. </b>rt&#x8C03;&#x5EA6;&#x57DF;&#x7684;&#x914D;&#x989D;</a></li><li><span class="title-icon "></span><a href="#&#x4E00;&#x4E9B;&#x547D;&#x4EE4;"><b>16.3. </b>&#x4E00;&#x4E9B;&#x547D;&#x4EE4;</a></li></ul><li><span class="title-icon "></span><a href="#linux&#x8C03;&#x5EA6;&#x65B9;&#x5F0F;&#x6709;&#x54EA;&#x4E9B;"><b>17. </b>linux&#x8C03;&#x5EA6;&#x65B9;&#x5F0F;&#x6709;&#x54EA;&#x4E9B;?</a></li><ul><li><span class="title-icon "></span><a href="#&#x975E;&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;"><b>17.1. </b>&#x975E;&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;</a></li><li><span class="title-icon "></span><a href="#&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;"><b>17.2. </b>&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;</a></li></ul><li><span class="title-icon "></span><a href="#preemptive-kernel&#x662F;&#x4EC0;&#x4E48;&#x610F;&#x601D;"><b>18. </b>preemptive kernel&#x662F;&#x4EC0;&#x4E48;&#x610F;&#x601D;?</a></li><ul><li><span class="title-icon "></span><a href="#&#x4E3A;&#x4EC0;&#x4E48;&#x4E00;&#x76F4;&#x8BF4;&#x5185;&#x6838;&#x62A2;&#x5360;"><b>18.1. </b>&#x4E3A;&#x4EC0;&#x4E48;&#x4E00;&#x76F4;&#x8BF4;&#x5185;&#x6838;&#x62A2;&#x5360;?</a></li><li><span class="title-icon "></span><a href="#&#x5D4C;&#x5165;&#x5F0F;&#x8BBE;&#x5907;&#x9700;&#x8981;&#x62A2;&#x5360;&#x5417;"><b>18.2. </b>&#x5D4C;&#x5165;&#x5F0F;&#x8BBE;&#x5907;&#x9700;&#x8981;&#x62A2;&#x5360;&#x5417;?</a></li></ul><li><span class="title-icon "></span><a href="#&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#x548C;ucontexh"><b>19. </b>&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#x548C;ucontex.h</a></li><ul><li><span class="title-icon "></span><a href="#&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;"><b>19.1. </b>&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;</a></li><li><span class="title-icon "></span><a href="#&#x4F8B;&#x5B50;"><b>19.2. </b>&#x4F8B;&#x5B50;</a></li><li><span class="title-icon "></span><a href="#&#x4F7F;&#x7528;ucontexth&#x7684;api&#x5B9E;&#x73B0;&#x7528;&#x6237;&#x6001;&#x534F;&#x7A0B;"><b>19.3. </b>&#x4F7F;&#x7528;ucontext.h&#x7684;api&#x5B9E;&#x73B0;&#x7528;&#x6237;&#x6001;&#x534F;&#x7A0B;</a></li></ul><li><span class="title-icon "></span><a href="#&#x591A;&#x7EBF;&#x7A0B;&#x7684;&#x60C5;&#x51B5;&#x4E0B;-signal&#x88AB;deliver&#x5230;&#x54EA;&#x4E2A;&#x7EBF;&#x7A0B;"><b>20. </b>&#x591A;&#x7EBF;&#x7A0B;&#x7684;&#x60C5;&#x51B5;&#x4E0B;, signal&#x88AB;deliver&#x5230;&#x54EA;&#x4E2A;&#x7EBF;&#x7A0B;?</a></li><li><span class="title-icon "></span><a href="#&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x662F;&#x4EC0;&#x4E48;-&#x4E3A;&#x4EC0;&#x4E48;&#x80FD;&#x6253;&#x5370;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#x6808;"><b>21. </b>&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x662F;&#x4EC0;&#x4E48;? &#x4E3A;&#x4EC0;&#x4E48;&#x80FD;&#x6253;&#x5370;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#x6808;?</a></li><ul><li><span class="title-icon "></span><a href="#sighandler&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;"><b>21.1. </b>sighandler&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;</a></li><ul><li><span class="title-icon "></span><a href="#sigaltstack&#x51FD;&#x6570;&#x7528;&#x4E8E;&#x6307;&#x5B9A;sighandler&#x6808;"><b>21.1.1. </b>sigaltstack&#x51FD;&#x6570;&#x7528;&#x4E8E;&#x6307;&#x5B9A;sighandler&#x6808;</a></li></ul><li><span class="title-icon "></span><a href="#&#x56DE;&#x7B54;"><b>21.2. </b>&#x56DE;&#x7B54;</a></li></ul><li><span class="title-icon "></span><a href="#&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x539F;&#x7406;"><b>22. </b>&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x539F;&#x7406;</a></li><ul><li><span class="title-icon "></span><a href="#sigaction"><b>22.1. </b>sigaction</a></li><li><span class="title-icon "></span><a href="#pending&#x548C;blocked&#x5411;&#x91CF;"><b>22.2. </b>pending&#x548C;blocked&#x5411;&#x91CF;</a></li><li><span class="title-icon "></span><a href="#signal&#x7684;&#x4EA7;&#x751F;&#x548C;&#x6295;&#x9012;"><b>22.3. </b>signal&#x7684;&#x4EA7;&#x751F;&#x548C;&#x6295;&#x9012;</a></li><li><span class="title-icon "></span><a href="#signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;_1"><b>22.4. </b>signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</a></li><li><span class="title-icon "></span><a href="#siglongjmp"><b>22.5. </b>siglongjmp</a></li></ul><li><span class="title-icon "></span><a href="#futex&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><b>23. </b>futex&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</a></li><li><span class="title-icon "></span><a href="#mmap&#x548C;&#x5185;&#x6838;page"><b>24. </b>mmap&#x548C;&#x5185;&#x6838;page</a></li><ul><li><span class="title-icon "></span><a href="#shared&#x548C;private"><b>24.1. </b>shared&#x548C;private</a></li><li><span class="title-icon "></span><a href="#shared-map"><b>24.2. </b>shared map</a></li><li><span class="title-icon "></span><a href="#private-map"><b>24.3. </b>private map</a></li><li><span class="title-icon "></span><a href="#&#x533F;&#x540D;&#x6620;&#x5C04;"><b>24.4. </b>&#x533F;&#x540D;&#x6620;&#x5C04;</a></li></ul><li><span class="title-icon "></span><a href="#libevent&#x4E3B;&#x5FAA;&#x73AF;&#x5904;&#x7406;timer"><b>25. </b>libevent&#x4E3B;&#x5FAA;&#x73AF;&#x5904;&#x7406;timer</a></li><li><span class="title-icon "></span><a href="#&#x518D;&#x8BAE;rm"><b>26. </b>&#x518D;&#x8BAE;rm</a></li><ul><li><span class="title-icon "></span><a href="#&#x666E;&#x901A;&#x7528;&#x6237;&#x53EF;&#x4EE5;rm-root&#x7528;&#x6237;&#x7684;&#x6587;&#x4EF6;"><b>26.1. </b>&#x666E;&#x901A;&#x7528;&#x6237;&#x53EF;&#x4EE5;rm root&#x7528;&#x6237;&#x7684;&#x6587;&#x4EF6;</a></li></ul><li><span class="title-icon "></span><a href="#&#x5173;&#x4E8E;&#x70ED;&#x5347;&#x7EA7;-&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x6587;&#x4EF6;&#x53EF;&#x4EE5;&#x88AB;rm"><b>27. </b>&#x5173;&#x4E8E;&#x70ED;&#x5347;&#x7EA7;, &#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x6587;&#x4EF6;&#x53EF;&#x4EE5;&#x88AB;rm</a></li><li><span class="title-icon "></span><a href="#user&#x6709;&#x4EC0;&#x4E48;&#x7528;"><b>28. </b>__user&#x6709;&#x4EC0;&#x4E48;&#x7528;?</a></li><li><span class="title-icon "></span><a href="#&#x7528;&#x6237;&#x6001;&#x901A;&#x8FC7;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x9677;&#x5165;&#x5230;&#x5185;&#x6838;&#x6001;-&#x5185;&#x5B58;&#x6620;&#x5C04;&#x4F1A;&#x53D8;&#x5417;"><b>29. </b>&#x7528;&#x6237;&#x6001;&#x901A;&#x8FC7;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x9677;&#x5165;&#x5230;&#x5185;&#x6838;&#x6001;, &#x5185;&#x5B58;&#x6620;&#x5C04;&#x4F1A;&#x53D8;&#x5417;?</a></li><li><span class="title-icon "></span><a href="#what-happens-to-the-cache-contents-on-a-context-switch"><b>30. </b>What happens to the cache contents on a context switch?</a></li><li><span class="title-icon "></span><a href="#int&#x7684;&#x5199;&#x662F;&#x539F;&#x5B50;&#x7684;&#x5417;"><b>31. </b>int&#x7684;&#x5199;&#x662F;&#x539F;&#x5B50;&#x7684;&#x5417;?</a></li><ul><li><span class="title-icon "></span><a href="#&#x662F;-&#x4E5F;&#x4E0D;&#x662F;"><b>31.1. </b>&#x662F;, &#x4E5F;&#x4E0D;&#x662F;</a></li></ul><li><span class="title-icon "></span><a href="#uboot&#x4F20;mtdpart&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x540D;&#x5B57;&#x4ECE;&#x54EA;&#x6765;&#x7684;&#xFF1F;"><b>32. </b>uboot&#x4F20;mtdpart&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x540D;&#x5B57;&#x4ECE;&#x54EA;&#x6765;&#x7684;&#xFF1F;</a></li><li><span class="title-icon "></span><a href="#&#x4E3A;&#x4EC0;&#x4E48;&#x76F4;&#x63A5;&#x8003;&#x8FC7;&#x6765;&#x7684;ls&#x4E0D;&#x80FD;&#x7528;&#xFF1F;"><b>33. </b>&#x4E3A;&#x4EC0;&#x4E48;&#x76F4;&#x63A5;&#x8003;&#x8FC7;&#x6765;&#x7684;ls&#x4E0D;&#x80FD;&#x7528;&#xFF1F;</a></li><li><span class="title-icon "></span><a href="#fork&#x4E0E;malloc"><b>34. </b>fork&#x4E0E;malloc</a></li></ul></div><a href="#seccomp&#x7CFB;&#x7EDF;&#x8C03;&#x7528;" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><ul>
<li><a href="#seccomp&#x7CFB;&#x7EDF;&#x8C03;&#x7528;">seccomp&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</a></li>
<li><a href="#&#x7CFB;&#x7EDF;&#x6743;&#x9650;">&#x7CFB;&#x7EDF;&#x6743;&#x9650;</a></li>
<li><a href="#smaps&#x89E3;&#x6790;&#x6027;&#x80FD;">smaps&#x89E3;&#x6790;&#x6027;&#x80FD;</a><ul>
<li><a href="#&#x6253;&#x5F00;smaps&#x6587;&#x4EF6;&#x672C;&#x8EAB;">&#x6253;&#x5F00;smaps&#x6587;&#x4EF6;&#x672C;&#x8EAB;</a></li>
<li><a href="#&#x52A0;&#x4E0A;&#x5B57;&#x7B26;&#x4E32;&#x64CD;&#x505A;">&#x52A0;&#x4E0A;&#x5B57;&#x7B26;&#x4E32;&#x64CD;&#x505A;</a></li>
<li><a href="#&#x7ED3;&#x8BBA;">&#x7ED3;&#x8BBA;</a></li>
</ul>
</li>
<li><a href="#&#x4F7F;&#x7528;&#x5176;&#x4ED6;&#x7528;&#x6237;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;">&#x4F7F;&#x7528;&#x5176;&#x4ED6;&#x7528;&#x6237;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;</a><ul>
<li><a href="#&#x6539;&#x53D8;&#x6587;&#x4EF6;&#x7684;owner&#x4E3A;nobodynogroup-&#x8BBE;&#x7F6E;setuid&#x5C5E;&#x6027;">&#x6539;&#x53D8;&#x6587;&#x4EF6;&#x7684;owner&#x4E3A;nobody:nogroup, &#x8BBE;&#x7F6E;setuid&#x5C5E;&#x6027;</a></li>
</ul>
</li>
<li><a href="#ruid-euid">ruid euid</a><ul>
<li><a href="#&#x4EC0;&#x4E48;&#x662F;uid-euid">&#x4EC0;&#x4E48;&#x662F;uid euid?</a></li>
<li><a href="#&#x8865;&#x5145;">&#x8865;&#x5145;</a></li>
<li><a href="#&#x5B9E;&#x9A8C;">&#x5B9E;&#x9A8C;</a><ul>
<li><a href="#&#x7136;&#x540E;&#x7528;&#x666E;&#x901A;user&#x542F;&#x52A8;">&#x7136;&#x540E;&#x7528;&#x666E;&#x901A;user&#x542F;&#x52A8;</a></li>
<li><a href="#&#x7528;root&#x542F;&#x52A8;">&#x7528;root&#x542F;&#x52A8;</a></li>
</ul>
</li>
<li><a href="#&#x8FDB;&#x7A0B;&#x7684;&#x6743;&#x9650;&#x662F;&#x770B;ruid-&#x800C;&#x4E0D;&#x662F;euid">&#x8FDB;&#x7A0B;&#x7684;&#x6743;&#x9650;&#x662F;&#x770B;ruid, &#x800C;&#x4E0D;&#x662F;euid</a></li>
<li><a href="#golang&#x6743;&#x9650;&#x964D;&#x7EA7;">golang&#x6743;&#x9650;&#x964D;&#x7EA7;</a></li>
</ul>
</li>
<li><a href="#&#x4EC0;&#x4E48;&#x662F;defunct&#x8FDB;&#x7A0B;">&#x4EC0;&#x4E48;&#x662F;defunct&#x8FDB;&#x7A0B;?</a></li>
<li><a href="#cgroup-v2">cgroup v2</a><ul>
<li><a href="#&#x8FDB;&#x7A0B;">&#x8FDB;&#x7A0B;</a></li>
<li><a href="#&#x7EBF;&#x7A0B;">&#x7EBF;&#x7A0B;</a></li>
<li><a href="#&#x63A7;&#x5236;&#x5668;&#x4F7F;&#x80FD;">&#x63A7;&#x5236;&#x5668;&#x4F7F;&#x80FD;</a></li>
<li><a href="#&#x4E0D;&#x63A8;&#x8350;&#x52A8;&#x6001;&#x8FC1;&#x79FB;pid">&#x4E0D;&#x63A8;&#x8350;&#x52A8;&#x6001;&#x8FC1;&#x79FB;pid</a></li>
<li><a href="#&#x8D44;&#x6E90;&#x9650;&#x5236;&#x7C7B;&#x578B;">&#x8D44;&#x6E90;&#x9650;&#x5236;&#x7C7B;&#x578B;</a></li>
<li><a href="#&#x63A7;&#x5236;&#x5668;&#x7C7B;&#x578B;">&#x63A7;&#x5236;&#x5668;&#x7C7B;&#x578B;</a><ul>
<li><a href="#cpu">CPU</a></li>
<li><a href="#&#x5185;&#x5B58;">&#x5185;&#x5B58;</a></li>
<li><a href="#io">IO</a></li>
<li><a href="#pid">PID</a></li>
<li><a href="#cpuset">Cpuset</a></li>
</ul>
</li>
<li><a href="#&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4EA4;&#x4E92;">&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4EA4;&#x4E92;</a></li>
<li><a href="#&#x548C;v1&#x7684;&#x5BF9;&#x6BD4;">&#x548C;V1&#x7684;&#x5BF9;&#x6BD4;</a></li>
</ul>
</li>
<li><a href="#&#x7CFB;&#x7EDF;&#x5185;&#x5B58;&#x5360;&#x7528;&#x5206;&#x6790;">&#x7CFB;&#x7EDF;&#x5185;&#x5B58;&#x5360;&#x7528;&#x5206;&#x6790;</a><ul>
<li><a href="#&#x5176;&#x4ED6;&#x7EDF;&#x8BA1;">&#x5176;&#x4ED6;&#x7EDF;&#x8BA1;</a></li>
<li><a href="#vm&#x53C2;&#x6570;">vm&#x53C2;&#x6570;</a></li>
<li><a href="#&#x6587;&#x4EF6;&#x7F13;&#x5B58;">&#x6587;&#x4EF6;&#x7F13;&#x5B58;</a></li>
</ul>
</li>
<li><a href="#cpu&#x5360;&#x7528;&#x7387;&#x5206;&#x6790;">CPU&#x5360;&#x7528;&#x7387;&#x5206;&#x6790;</a><ul>
<li><a href="#per-cpu&#x7EDF;&#x8BA1;-user--sys--softirq--idle--iowait--100">per CPU&#x7EDF;&#x8BA1; user + sys + softirq + idle + iowait = 100</a></li>
<li><a href="#softirq&#x73B0;&#x8C61;">softirq&#x73B0;&#x8C61;</a></li>
<li><a href="#&#x7ED3;&#x8BBA;-1">&#x7ED3;&#x8BBA;</a></li>
<li><a href="#&#x8865;&#x5145;-1">&#x8865;&#x5145;</a></li>
</ul>
</li>
<li><a href="#&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;&#x5417;">&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;&#x5417;?</a><ul>
<li><a href="#preemption-and-context-switching">Preemption and Context Switching</a></li>
<li><a href="#user-preemption">User Preemption</a></li>
<li><a href="#kernel-preemption">Kernel Preemption</a></li>
<li><a href="#&#x8C03;&#x5EA6;&#x4EE3;&#x7801;">&#x8C03;&#x5EA6;&#x4EE3;&#x7801;</a></li>
<li><a href="#&#x4E00;&#x4E9B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;-&#x53EF;&#x80FD;&#x4F1A;&#x963B;&#x585E;-&#x6B64;&#x65F6;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;">&#x4E00;&#x4E9B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;, &#x53EF;&#x80FD;&#x4F1A;&#x963B;&#x585E;, &#x6B64;&#x65F6;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;</a></li>
<li><a href="#&#x8C03;&#x5EA6;&#x5668;&#x7684;&#x53C2;&#x8003;&#x6587;&#x7AE0;">&#x8C03;&#x5EA6;&#x5668;&#x7684;&#x53C2;&#x8003;&#x6587;&#x7AE0;</a></li>
</ul>
</li>
<li><a href="#signal&#x7684;&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;&#x548C;&#x6253;&#x65AD;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;">signal&#x7684;&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;&#x548C;&#x6253;&#x65AD;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</a><ul>
<li><a href="#&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;">&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;</a></li>
<li><a href="#signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;">signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</a></li>
</ul>
</li>
<li><a href="#&#x5185;&#x6838;&#x6536;&#x62A5;&#x6587;&#x7684;&#x65F6;&#x95F4;&#x7247;&#x7B97;&#x5728;&#x54EA;&#x91CC;">&#x5185;&#x6838;&#x6536;&#x62A5;&#x6587;&#x7684;&#x65F6;&#x95F4;&#x7247;&#x7B97;&#x5728;&#x54EA;&#x91CC;?</a><ul>
<li><a href="#&#x80CC;&#x666F;-&#x9A71;&#x52A8;&#x4E2D;&#x65AD;&#x5728;&#x54EA;&#x91CC;&#x6267;&#x884C;">&#x80CC;&#x666F;: &#x9A71;&#x52A8;&#x4E2D;&#x65AD;&#x5728;&#x54EA;&#x91CC;&#x6267;&#x884C;?</a></li>
<li><a href="#&#x4E2D;&#x65AD;&#x7EBF;&#x7A0B;&#x5316;&#x540E;&#x7684;cpu-load">&#x4E2D;&#x65AD;&#x7EBF;&#x7A0B;&#x5316;&#x540E;&#x7684;CPU load</a></li>
<li><a href="#&#x5230;&#x5E95;&#x4EC0;&#x4E48;&#x662F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;">&#x5230;&#x5E95;&#x4EC0;&#x4E48;&#x662F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;?</a></li>
<li><a href="#&#x8F6F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;">&#x8F6F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;</a><ul>
<li><a href="#softirq&#x6FC0;&#x6D3B;">softirq&#x6FC0;&#x6D3B;</a></li>
<li><a href="#ksoftirqd&#x7EBF;&#x7A0B;">ksoftirqd&#x7EBF;&#x7A0B;</a></li>
</ul>
</li>
<li><a href="#&#x4E0A;&#x4E0B;&#x6587;&#x5206;&#x7C7B;">&#x4E0A;&#x4E0B;&#x6587;&#x5206;&#x7C7B;</a></li>
<li><a href="#&#x6536;&#x62A5;&#x7684;&#x65F6;&#x95F4;&#x7B97;&#x5728;&#x54EA;&#x91CC;">&#x6536;&#x62A5;&#x7684;&#x65F6;&#x95F4;&#x7B97;&#x5728;&#x54EA;&#x91CC;?</a></li>
</ul>
</li>
<li><a href="#socket&#x4EC0;&#x4E48;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x53D1;&#x751F;&#x77ED;&#x8BFB;short-readpartial-read">socket&#x4EC0;&#x4E48;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x53D1;&#x751F;&#x77ED;&#x8BFB;short read/partial read?</a></li>
<li><a href="#socket&#x901A;&#x4FE1;&#x7684;&#x65F6;&#x5019;-&#x8981;&#x5728;&#x5E94;&#x7528;&#x4FA7;&#x505A;&#x5B57;&#x8282;&#x5E8F;&#x8F6C;&#x6362;&#x5417;">socket&#x901A;&#x4FE1;&#x7684;&#x65F6;&#x5019;, &#x8981;&#x5728;&#x5E94;&#x7528;&#x4FA7;&#x505A;&#x5B57;&#x8282;&#x5E8F;&#x8F6C;&#x6362;&#x5417;?</a></li>
<li><a href="#socket&#x7684;stream&#x6A21;&#x5F0F;&#x548C;datagram&#x6A21;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x4E0D;&#x540C;">socket&#x7684;stream&#x6A21;&#x5F0F;&#x548C;datagram&#x6A21;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x4E0D;&#x540C;?</a><ul>
<li><a href="#socket&#x57FA;&#x7840;">socket&#x57FA;&#x7840;</a></li>
<li><a href="#sock_stream">SOCK_STREAM</a></li>
<li><a href="#sock_seqpacket">SOCK_SEQPACKET</a></li>
<li><a href="#sock_dgram">SOCK_DGRAM</a></li>
<li><a href="#man-7-ip">man 7 ip</a></li>
<li><a href="#man-7-tcp">man 7 tcp</a></li>
<li><a href="#man-7-udp">man 7 udp</a></li>
<li><a href="#man-7-unix">man 7 unix</a></li>
<li><a href="#&#x4EC0;&#x4E48;&#x662F;message-boundires">&#x4EC0;&#x4E48;&#x662F;message boundires?</a><ul>
<li><a href="#tcp&#x7684;stream&#x6A21;&#x5F0F;&#x600E;&#x4E48;&#x5B9A;&#x754C;">TCP&#x7684;stream&#x6A21;&#x5F0F;&#x600E;&#x4E48;&#x5B9A;&#x754C;?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cgroup&#x914D;&#x7F6E;">cgroup&#x914D;&#x7F6E;</a><ul>
<li><a href="#&#x5199;&#x5165;pid">&#x5199;&#x5165;pid</a></li>
<li><a href="#rt&#x8C03;&#x5EA6;&#x57DF;&#x7684;&#x914D;&#x989D;">rt&#x8C03;&#x5EA6;&#x57DF;&#x7684;&#x914D;&#x989D;</a></li>
<li><a href="#&#x4E00;&#x4E9B;&#x547D;&#x4EE4;">&#x4E00;&#x4E9B;&#x547D;&#x4EE4;</a></li>
</ul>
</li>
<li><a href="#linux&#x8C03;&#x5EA6;&#x65B9;&#x5F0F;&#x6709;&#x54EA;&#x4E9B;">linux&#x8C03;&#x5EA6;&#x65B9;&#x5F0F;&#x6709;&#x54EA;&#x4E9B;?</a><ul>
<li><a href="#&#x975E;&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;">&#x975E;&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;</a></li>
<li><a href="#&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;">&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;</a></li>
</ul>
</li>
<li><a href="#preemptive-kernel&#x662F;&#x4EC0;&#x4E48;&#x610F;&#x601D;">preemptive kernel&#x662F;&#x4EC0;&#x4E48;&#x610F;&#x601D;?</a><ul>
<li><a href="#&#x4E3A;&#x4EC0;&#x4E48;&#x4E00;&#x76F4;&#x8BF4;&#x5185;&#x6838;&#x62A2;&#x5360;">&#x4E3A;&#x4EC0;&#x4E48;&#x4E00;&#x76F4;&#x8BF4;&#x5185;&#x6838;&#x62A2;&#x5360;?</a></li>
<li><a href="#&#x5D4C;&#x5165;&#x5F0F;&#x8BBE;&#x5907;&#x9700;&#x8981;&#x62A2;&#x5360;&#x5417;">&#x5D4C;&#x5165;&#x5F0F;&#x8BBE;&#x5907;&#x9700;&#x8981;&#x62A2;&#x5360;&#x5417;?</a></li>
</ul>
</li>
<li><a href="#&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#x548C;ucontexh">&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#x548C;ucontex.h</a><ul>
<li><a href="#&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;">&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;</a></li>
<li><a href="#&#x4F8B;&#x5B50;">&#x4F8B;&#x5B50;</a></li>
<li><a href="#&#x4F7F;&#x7528;ucontexth&#x7684;api&#x5B9E;&#x73B0;&#x7528;&#x6237;&#x6001;&#x534F;&#x7A0B;">&#x4F7F;&#x7528;ucontext.h&#x7684;api&#x5B9E;&#x73B0;&#x7528;&#x6237;&#x6001;&#x534F;&#x7A0B;</a></li>
</ul>
</li>
<li><a href="#&#x591A;&#x7EBF;&#x7A0B;&#x7684;&#x60C5;&#x51B5;&#x4E0B;-signal&#x88AB;deliver&#x5230;&#x54EA;&#x4E2A;&#x7EBF;&#x7A0B;">&#x591A;&#x7EBF;&#x7A0B;&#x7684;&#x60C5;&#x51B5;&#x4E0B;, signal&#x88AB;deliver&#x5230;&#x54EA;&#x4E2A;&#x7EBF;&#x7A0B;?</a></li>
<li><a href="#&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x662F;&#x4EC0;&#x4E48;-&#x4E3A;&#x4EC0;&#x4E48;&#x80FD;&#x6253;&#x5370;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#x6808;">&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x662F;&#x4EC0;&#x4E48;? &#x4E3A;&#x4EC0;&#x4E48;&#x80FD;&#x6253;&#x5370;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#x6808;?</a><ul>
<li><a href="#sighandler&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;">sighandler&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;</a><ul>
<li><a href="#sigaltstack&#x51FD;&#x6570;&#x7528;&#x4E8E;&#x6307;&#x5B9A;sighandler&#x6808;">sigaltstack&#x51FD;&#x6570;&#x7528;&#x4E8E;&#x6307;&#x5B9A;sighandler&#x6808;</a></li>
</ul>
</li>
<li><a href="#&#x56DE;&#x7B54;">&#x56DE;&#x7B54;</a></li>
</ul>
</li>
<li><a href="#&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x539F;&#x7406;">&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x539F;&#x7406;</a><ul>
<li><a href="#sigaction">sigaction</a></li>
<li><a href="#pending&#x548C;blocked&#x5411;&#x91CF;">pending&#x548C;blocked&#x5411;&#x91CF;</a></li>
<li><a href="#signal&#x7684;&#x4EA7;&#x751F;&#x548C;&#x6295;&#x9012;">signal&#x7684;&#x4EA7;&#x751F;&#x548C;&#x6295;&#x9012;</a></li>
<li><a href="#signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;-1">signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</a></li>
<li><a href="#siglongjmp">siglongjmp</a></li>
</ul>
</li>
<li><a href="#futex&#x7CFB;&#x7EDF;&#x8C03;&#x7528;">futex&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</a></li>
<li><a href="#mmap&#x548C;&#x5185;&#x6838;page">mmap&#x548C;&#x5185;&#x6838;page</a><ul>
<li><a href="#shared&#x548C;private">shared&#x548C;private</a></li>
<li><a href="#shared-map">shared map</a></li>
<li><a href="#private-map">private map</a></li>
<li><a href="#&#x533F;&#x540D;&#x6620;&#x5C04;">&#x533F;&#x540D;&#x6620;&#x5C04;</a></li>
</ul>
</li>
<li><a href="#libevent&#x4E3B;&#x5FAA;&#x73AF;&#x5904;&#x7406;timer">libevent&#x4E3B;&#x5FAA;&#x73AF;&#x5904;&#x7406;timer</a></li>
<li><a href="#&#x518D;&#x8BAE;rm">&#x518D;&#x8BAE;rm</a><ul>
<li><a href="#&#x666E;&#x901A;&#x7528;&#x6237;&#x53EF;&#x4EE5;rm-root&#x7528;&#x6237;&#x7684;&#x6587;&#x4EF6;">&#x666E;&#x901A;&#x7528;&#x6237;&#x53EF;&#x4EE5;rm root&#x7528;&#x6237;&#x7684;&#x6587;&#x4EF6;</a></li>
</ul>
</li>
<li><a href="#&#x5173;&#x4E8E;&#x70ED;&#x5347;&#x7EA7;-&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x6587;&#x4EF6;&#x53EF;&#x4EE5;&#x88AB;rm">&#x5173;&#x4E8E;&#x70ED;&#x5347;&#x7EA7;, &#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x6587;&#x4EF6;&#x53EF;&#x4EE5;&#x88AB;rm</a></li>
<li><a href="#__user&#x6709;&#x4EC0;&#x4E48;&#x7528;">__user&#x6709;&#x4EC0;&#x4E48;&#x7528;?</a></li>
<li><a href="#&#x7528;&#x6237;&#x6001;&#x901A;&#x8FC7;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x9677;&#x5165;&#x5230;&#x5185;&#x6838;&#x6001;-&#x5185;&#x5B58;&#x6620;&#x5C04;&#x4F1A;&#x53D8;&#x5417;">&#x7528;&#x6237;&#x6001;&#x901A;&#x8FC7;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x9677;&#x5165;&#x5230;&#x5185;&#x6838;&#x6001;, &#x5185;&#x5B58;&#x6620;&#x5C04;&#x4F1A;&#x53D8;&#x5417;?</a></li>
<li><a href="#what-happens-to-the-cache-contents-on-a-context-switch">What happens to the cache contents on a context switch?</a></li>
<li><a href="#int&#x7684;&#x5199;&#x662F;&#x539F;&#x5B50;&#x7684;&#x5417;">int&#x7684;&#x5199;&#x662F;&#x539F;&#x5B50;&#x7684;&#x5417;?</a><ul>
<li><a href="#&#x662F;-&#x4E5F;&#x4E0D;&#x662F;">&#x662F;, &#x4E5F;&#x4E0D;&#x662F;</a></li>
</ul>
</li>
<li><a href="#uboot&#x4F20;mtdpart&#x7684;&#x65F6;&#x5019;&#x540D;&#x5B57;&#x4ECE;&#x54EA;&#x6765;&#x7684;">uboot&#x4F20;mtdpart&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x540D;&#x5B57;&#x4ECE;&#x54EA;&#x6765;&#x7684;&#xFF1F;</a></li>
<li><a href="#&#x4E3A;&#x4EC0;&#x4E48;&#x76F4;&#x63A5;&#x8003;&#x8FC7;&#x6765;&#x7684;ls&#x4E0D;&#x80FD;&#x7528;">&#x4E3A;&#x4EC0;&#x4E48;&#x76F4;&#x63A5;&#x8003;&#x8FC7;&#x6765;&#x7684;ls&#x4E0D;&#x80FD;&#x7528;&#xFF1F;</a></li>
<li><a href="#fork&#x4E0E;malloc">fork&#x4E0E;malloc</a></li>
</ul>
<h1 id="seccomp&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><a name="seccomp&#x7CFB;&#x7EDF;&#x8C03;&#x7528;" class="anchor-navigation-ex-anchor" href="#seccomp&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><i class="fa fa-link" aria-hidden="true"></i></a>1. seccomp&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</h1>
<p>&#x5F88;&#x591A;sandbox&#x673A;&#x5236;&#x90FD;&#x4F7F;&#x7528;&#x4E86;&#x8FD9;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;, &#x5B83;&#x662F;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;filter&#x673A;&#x5236;.</p>
<pre class="language-"><code class="lang-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/seccomp.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/filter.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/audit.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ptrace.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">seccomp</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> operation<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>seccomp</code>&#x8BBE;&#x7F6E;calling&#x8FDB;&#x7A0B;&#x7684;Secure Computing&#x5C5E;&#x6027;,&#x6709;&#x51E0;&#x79CD;operation:</p>
<ul>
<li>SECCOMP_SET_MODE_STRICT: &#x53EA;&#x6709;&#x57FA;&#x672C;&#x7684;read, write, exit&#x548C;sigreturn&#x53EF;&#x4EE5;&#x7528;. &#x5176;&#x4ED6;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x4F1A;&#x89E6;&#x53D1;SIGKILL</li>
<li>SECCOMP_SET_MODE_FILTER: args&#x6307;&#x5411;sock_fprog, &#x8FD9;&#x662F;&#x4E2A;bpf&#x7684;&#x6307;&#x4EE4;, &#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x4EFB;&#x610F;&#x7EC4;&#x5408;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;filter&#x89C4;&#x5219;<pre class="language-"><code class="lang-c"><span class="token keyword">struct</span> <span class="token class-name">sock_fprog</span> <span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span>      len<span class="token punctuation">;</span>    <span class="token comment">/* Number of BPF instructions */</span>
  <span class="token keyword">struct</span> <span class="token class-name">sock_filter</span> <span class="token operator">*</span>filter<span class="token punctuation">;</span> <span class="token comment">/* Pointer to array of
                                 BPF instructions */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">sock_filter</span> <span class="token punctuation">{</span>            <span class="token comment">/* Filter block */</span>
  __u16 code<span class="token punctuation">;</span>                 <span class="token comment">/* Actual filter code */</span>
  __u8  jt<span class="token punctuation">;</span>                   <span class="token comment">/* Jump true */</span>
  __u8  jf<span class="token punctuation">;</span>                   <span class="token comment">/* Jump false */</span>
  __u32 k<span class="token punctuation">;</span>                    <span class="token comment">/* Generic multiuse field */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li>SECCOMP_RET_KILL_PROCESS: &#x5BFC;&#x81F4;&#x8FDB;&#x7A0B;&#x7EC8;&#x6B62;</li>
<li>SECCOMP_RET_KILL_THREAD: &#x5BFC;&#x81F4;&#x8C03;&#x7528;&#x8005;&#x7EBF;&#x7A0B;&#x7EC8;&#x6B62;, &#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x4E0D;&#x53D7;&#x5F71;&#x54CD;.</li>
<li>SECCOMP_RET_TRAP: &#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x4F1A;&#x89E6;&#x53D1;SIGSYS&#x4FE1;&#x53F7;</li>
<li>SECCOMP_RET_ERRNO:</li>
<li>SECCOMP_RET_TRACE:</li>
<li>SECCOMP_RET_LOG:</li>
<li>SECCOMP_RET_ALLOW:</li>
</ul>
<h1 id="&#x7CFB;&#x7EDF;&#x6743;&#x9650;"><a name="&#x7CFB;&#x7EDF;&#x6743;&#x9650;" class="anchor-navigation-ex-anchor" href="#&#x7CFB;&#x7EDF;&#x6743;&#x9650;"><i class="fa fa-link" aria-hidden="true"></i></a>2. &#x7CFB;&#x7EDF;&#x6743;&#x9650;</h1>
<p><code>man capabilities</code>
&#x6743;&#x9650;&#x68C0;&#x67E5;&#x662F;&#x57FA;&#x4E8E;thread&#x7684;, &#x7279;&#x6743;&#x7528;&#x6237;(root, euid=0)&#x7684;thread&#x4E0D;&#x7528;&#x68C0;&#x67E5;, &#x5176;&#x4ED6;&#x7528;&#x6237;&#x4F1A;&#x8D70;&#x6743;&#x9650;&#x68C0;&#x67E5;&#x6D41;&#x7A0B;.
linux&#x6743;&#x9650;&#x6709;&#x5F88;&#x591A;&#x7C7B;, &#x53EF;&#x4EE5;&#x5355;&#x72EC;&#x6253;&#x5F00;&#x548C;&#x5173;&#x95ED;
&#x6BD4;&#x5982;</p>
<ul>
<li>CAP_DAC_OVERRIDE: &#x6709;&#x8FD9;&#x4E2A;&#x5C5E;&#x6027;&#x5C31;&#x53EF;&#x4EE5;&#x8DF3;&#x8FC7;&#x6587;&#x4EF6;&#x6216;&#x76EE;&#x5F55;&#x7684;rwx&#x68C0;&#x67E5;</li>
<li>CAP_DAC_READ_SEARCH: &#x8DF3;&#x8FC7;read&#x5C5E;&#x6027;&#x68C0;&#x67E5;</li>
<li>CAP_KILL: &#x662F;&#x5426;&#x6709;kill&#x6743;&#x9650;</li>
<li>CAP_MKNOD: &#x662F;&#x5426;&#x80FD;&#x521B;&#x5EFA;ssh&#x8BBE;&#x5907;&#x6587;&#x4EF6;</li>
<li>CAP_NET_ADMIN: &#x7F51;&#x7EDC;&#x914D;&#x7F6E;</li>
<li>CAP_NET_RAW: &#x4F7F;&#x7528;raw socket</li>
<li>CAP_SYS_ADMIN: &#x6BD4;&#x5982;mount, setns, clone&#x7B49;</li>
</ul>
<p>&#x8FD8;&#x6709;&#x5176;&#x4ED6;&#x5F88;&#x591A;&#x5C5E;&#x6027;, &#x89C1;<code>man capabilities</code></p>
<p>&#x5B50;&#x8FDB;&#x7A0B;&#x7EE7;&#x627F;&#x7236;&#x8FDB;&#x7A0B;&#x7684;&#x5C5E;&#x6027;</p>
<h1 id="smaps&#x89E3;&#x6790;&#x6027;&#x80FD;"><a name="smaps&#x89E3;&#x6790;&#x6027;&#x80FD;" class="anchor-navigation-ex-anchor" href="#smaps&#x89E3;&#x6790;&#x6027;&#x80FD;"><i class="fa fa-link" aria-hidden="true"></i></a>3. smaps&#x89E3;&#x6790;&#x6027;&#x80FD;</h1>
<p>&#x6211;&#x8981;&#x89E3;&#x6790;<code>/proc/1/smaps</code>, &#x5B83;&#x7684;&#x683C;&#x5F0F;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code class="lang-sh">~ <span class="token comment"># cat /proc/1/smaps</span>
00010000-00013000 r-xp 00000000 00:02 <span class="token number">8237</span>                               /usr/bin/s6-svscan
Size:                 <span class="token number">12</span> kB
Rss:                  <span class="token number">12</span> kB
Pss:                  <span class="token number">12</span> kB
Shared_Clean:          <span class="token number">0</span> kB
Shared_Dirty:          <span class="token number">0</span> kB
Private_Clean:         <span class="token number">0</span> kB
Private_Dirty:        <span class="token number">12</span> kB
Referenced:           <span class="token number">12</span> kB
Anonymous:             <span class="token number">0</span> kB
AnonHugePages:         <span class="token number">0</span> kB
ShmemPmdMapped:        <span class="token number">0</span> kB
Shared_Hugetlb:        <span class="token number">0</span> kB
Private_Hugetlb:       <span class="token number">0</span> kB
Swap:                  <span class="token number">0</span> kB
SwapPss:               <span class="token number">0</span> kB
KernelPageSize:        <span class="token number">4</span> kB
MMUPageSize:           <span class="token number">4</span> kB
Locked:                <span class="token number">0</span> kB
VmFlags: rd ex mr mw me dw
00022000-00023000 r--p 00002000 00:02 <span class="token number">8237</span>                               /usr/bin/s6-svscan
Size:                  <span class="token number">4</span> kB
Rss:                   <span class="token number">4</span> kB
Pss:                   <span class="token number">4</span> kB
Shared_Clean:          <span class="token number">0</span> kB
Shared_Dirty:          <span class="token number">0</span> kB
Private_Clean:         <span class="token number">0</span> kB
Private_Dirty:         <span class="token number">4</span> kB
Referenced:            <span class="token number">4</span> kB
Anonymous:             <span class="token number">4</span> kB
AnonHugePages:         <span class="token number">0</span> kB
ShmemPmdMapped:        <span class="token number">0</span> kB
Shared_Hugetlb:        <span class="token number">0</span> kB
Private_Hugetlb:       <span class="token number">0</span> kB
Swap:                  <span class="token number">0</span> kB
SwapPss:               <span class="token number">0</span> kB
KernelPageSize:        <span class="token number">4</span> kB
MMUPageSize:           <span class="token number">4</span> kB
Locked:                <span class="token number">0</span> kB
VmFlags: rd mr mw me dw ac

<span class="token punctuation">..</span>.
</code></pre>
<p>&#x6211;&#x5199;&#x4E86;&#x4EE3;&#x7801;&#x628A;&#x6240;&#x6709;<code>Pss:                  xx kB</code>&#x52A0;&#x8D77;&#x6765;.</p>
<p>CPU&#x6D88;&#x8017;&#x5F88;&#x9AD8;. &#x8FD9;&#x91CC;&#x7684;&#x6D88;&#x8017;&#x5305;&#x62EC;&#x6253;&#x5F00;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x672C;&#x8EAB;, &#x548C;&#x5B57;&#x7B26;&#x4E32;&#x641C;&#x7D22;&#x548C;&#x8F6C;&#x6362;&#x7684;&#x6D88;&#x8017;.</p>
<h2 id="&#x6253;&#x5F00;smaps&#x6587;&#x4EF6;&#x672C;&#x8EAB;"><a name="&#x6253;&#x5F00;smaps&#x6587;&#x4EF6;&#x672C;&#x8EAB;" class="anchor-navigation-ex-anchor" href="#&#x6253;&#x5F00;smaps&#x6587;&#x4EF6;&#x672C;&#x8EAB;"><i class="fa fa-link" aria-hidden="true"></i></a>3.1. &#x6253;&#x5F00;smaps&#x6587;&#x4EF6;&#x672C;&#x8EAB;</h2>
<p>&#x53EA;&#x662F;&#x6253;&#x5F00;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x5C31;&#x5DF2;&#x7ECF;&#x5F88;&#x9AD8;&#x4E86;:
htop&#x663E;&#x793A;CPU&#x5728;40&#x5230;70&#x4E4B;&#x95F4;, &#x5747;&#x503C;&#x5927;&#x6982;&#x5728;50.<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829154401.png" alt=""><br>perf&#x53D1;&#x73B0;&#x5927;&#x90E8;&#x5206;&#x65F6;&#x95F4;&#x5728;&#x5185;&#x6838;&#x7684;<code>smaps_account()</code>&#x51FD;&#x6570;, &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5728;for&#x91CC;&#x8BA1;&#x7B97;&#x6BCF;&#x4E2A;page, &#x786E;&#x5B9E;&#x6BD4;&#x8F83;&#x8017;&#x65F6;.</p>
<h2 id="&#x52A0;&#x4E0A;&#x5B57;&#x7B26;&#x4E32;&#x64CD;&#x505A;"><a name="&#x52A0;&#x4E0A;&#x5B57;&#x7B26;&#x4E32;&#x64CD;&#x505A;" class="anchor-navigation-ex-anchor" href="#&#x52A0;&#x4E0A;&#x5B57;&#x7B26;&#x4E32;&#x64CD;&#x505A;"><i class="fa fa-link" aria-hidden="true"></i></a>3.2. &#x52A0;&#x4E0A;&#x5B57;&#x7B26;&#x4E32;&#x64CD;&#x505A;</h2>
<pre class="language-"><code class="lang-go">        buf<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/&quot;</span> <span class="token operator">+</span> pid <span class="token operator">+</span> <span class="token string">&quot;/smaps_rollup&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            i <span class="token operator">:=</span> bytes<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;\nPss:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> i <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
                buf <span class="token operator">=</span> buf<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
                size<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseUint</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
                <span class="token comment">//fmt.Fprintln(os.Stderr, string(bytes.TrimSpace(buf[4:24])), size)</span>
                pssSize <span class="token operator">=</span> size
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>&#x611F;&#x89C9;CPU&#x6CA1;&#x6709;&#x5347;&#x9AD8;&#x591A;&#x5C11;, &#x5E73;&#x5747;&#x4E5F;&#x5728;50+%.</p>
<h2 id="&#x7ED3;&#x8BBA;"><a name="&#x7ED3;&#x8BBA;" class="anchor-navigation-ex-anchor" href="#&#x7ED3;&#x8BBA;"><i class="fa fa-link" aria-hidden="true"></i></a>3.3. &#x7ED3;&#x8BBA;</h2>
<p>&#x6253;&#x5F00;<code>&quot;/proc/&quot; + pid + &quot;/smaps_rollup&quot;</code>&#x6216;<code>&quot;/proc/&quot; + pid + &quot;/smaps&quot;</code>&#x672C;&#x8EAB;&#x5C31;&#x5F88;&#x6D88;&#x8017;CPU.
&#x56E0;&#x4E3A;kernel&#x5728;open&#x7684;&#x65F6;&#x5019;&#x624D;&#x53BB;&#x8C03;&#x7528;<code>smaps_account()</code>&#x51FD;&#x6570;.</p>
<h1 id="&#x4F7F;&#x7528;&#x5176;&#x4ED6;&#x7528;&#x6237;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;"><a name="&#x4F7F;&#x7528;&#x5176;&#x4ED6;&#x7528;&#x6237;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;" class="anchor-navigation-ex-anchor" href="#&#x4F7F;&#x7528;&#x5176;&#x4ED6;&#x7528;&#x6237;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a>4. &#x4F7F;&#x7528;&#x5176;&#x4ED6;&#x7528;&#x6237;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;</h1>
<p>&#x5728;shell&#x91CC;&#x624B;&#x52A8;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x53EF;&#x6267;&#x884C;&#x7A0B;&#x5E8F;, &#x5176;user&#x662F;&#x5F53;&#x524D;&#x7684;&#x767B;&#x9646;&#x7528;&#x6237;.
&#x4F46;&#x6709;&#x7684;&#x65F6;&#x5019;, &#x6BD4;&#x5982;&#x5F00;&#x4E00;&#x4E2A;daemon&#x8FDB;&#x7A0B;, &#x4E0D;&#x60F3;&#x7528;&#x81EA;&#x5DF1;&#x7684;&#x7528;&#x6237;&#x6765;&#x542F;&#x52A8;, &#x4E0B;&#x9762;&#x662F;&#x65B9;&#x6CD5;:</p>
<h2 id="&#x6539;&#x53D8;&#x6587;&#x4EF6;&#x7684;owner&#x4E3A;nobodynogroup-&#x8BBE;&#x7F6E;setuid&#x5C5E;&#x6027;"><a name="&#x6539;&#x53D8;&#x6587;&#x4EF6;&#x7684;owner&#x4E3A;nobodynogroup-&#x8BBE;&#x7F6E;setuid&#x5C5E;&#x6027;" class="anchor-navigation-ex-anchor" href="#&#x6539;&#x53D8;&#x6587;&#x4EF6;&#x7684;owner&#x4E3A;nobodynogroup-&#x8BBE;&#x7F6E;setuid&#x5C5E;&#x6027;"><i class="fa fa-link" aria-hidden="true"></i></a>4.1. &#x6539;&#x53D8;&#x6587;&#x4EF6;&#x7684;owner&#x4E3A;nobody:nogroup, &#x8BBE;&#x7F6E;setuid&#x5C5E;&#x6027;</h2>
<p>&#x8FD9;&#x6B65;&#x9700;&#x8981;sudo&#x6743;&#x9650;</p>
<pre class="language-"><code class="lang-sh"><span class="token comment"># nobody&#x548C;nogroup&#x4E00;&#x822C;&#x7684;linux&#x7CFB;&#x7EDF;&#x90FD;&#x6709;</span>
<span class="token function">sudo</span> <span class="token function">chown</span> nobody:nogroup gshell
<span class="token comment"># user&#x548C;group&#x90FD;&#x8981;&#x8BBE;&#x7F6E;setuid&#x5C5E;&#x6027;</span>
<span class="token function">sudo</span> <span class="token function">chmod</span> ugo+ws gshell
<span class="token comment"># ls -l&#x770B;&#x5230;gshell&#x7A0B;&#x5E8F;&#x5DF2;&#x7ECF;&#x662F;nobody:nogroup&#x4E86;, &#x800C;&#x4E14;u&#x548C;g&#x90FD;&#x6709;s&#x5C5E;&#x6027;</span>
<span class="token comment"># &#x6211;&#x4E13;&#x95E8;&#x628A;o&#x7684;w&#x5C5E;&#x6027;&#x4E5F;&#x52A0;&#x4E0A;&#x4E86;</span>
<span class="token parameter variable">-rwsrwsrwx</span> <span class="token number">1</span> nobody nogroup <span class="token number">22610134</span> Sep <span class="token number">26</span> 01:14 gshell
</code></pre>
<h1 id="ruid-euid"><a name="ruid-euid" class="anchor-navigation-ex-anchor" href="#ruid-euid"><i class="fa fa-link" aria-hidden="true"></i></a>5. ruid euid</h1>
<h2 id="&#x4EC0;&#x4E48;&#x662F;uid-euid"><a name="&#x4EC0;&#x4E48;&#x662F;uid-euid" class="anchor-navigation-ex-anchor" href="#&#x4EC0;&#x4E48;&#x662F;uid-euid"><i class="fa fa-link" aria-hidden="true"></i></a>5.1. &#x4EC0;&#x4E48;&#x662F;uid euid?</h2>
<p>&#x6700;&#x4E3B;&#x8981;&#x662F;&#x770B;<code>man setuid</code>&#x548C;<code>man seteuid</code></p>
<blockquote>
<p>The distinction between a real and an effective user id is made because you may have the need to temporarily take another user&apos;s identity (most of the time, that would be <code>root</code>, but it could be any user). If you only had one user id, then there would be no way of changing back to your original user id afterwards (other than taking your word for granted, and in case you are <code>root</code>, using <code>root</code>&apos;s privileges to change to any user).</p>
<p>So, the real user id is who you really are (the one who owns the process), and the effective user id is what the operating system looks at to make a decision whether or not you are allowed to do something (most of the time, there are some exceptions).</p>
<p>When you log in, the login shell sets both the real and effective user id to the same value (your real user id) as supplied by the password file.</p>
<p>Now, it also happens that you execute a setuid program, and besides running as another user (e.g. <code>root</code>) the setuid program is <em>also</em> supposed to do something on your behalf. How does this work?
After executing the setuid program, it will have your real id (since you&apos;re the process owner) and the effective user id of the file owner (for example <code>root</code>) since it is setuid.</p>
<p>The program does whatever magic it needs to do with superuser privileges and then wants to do something on your behalf. That means, attempting to do something that you shouldn&apos;t be able to do <em>should fail</em>. How does it do that? Well, obviously by changing its effective user id to the real user id!</p>
<p>Now that setuid program has no way of switching back since all the kernel knows is your id and... <em>your id</em>. Bang, you&apos;re dead.</p>
<p>This is what the saved set-user id is for.</p>
</blockquote>
<p>&#x53C2;&#x8003;: 
<a href="https://stackoverflow.com/questions/32455684/difference-between-real-user-id-effective-user-id-and-saved-user-id" target="_blank">https://stackoverflow.com/questions/32455684/difference-between-real-user-id-effective-user-id-and-saved-user-id</a>
<a href="https://mudongliang.github.io/2020/09/17/ruid-euid-suid-usage-in-linux.html" target="_blank">https://mudongliang.github.io/2020/09/17/ruid-euid-suid-usage-in-linux.html</a>
<a href="https://stackoverflow.com/questions/33982789/difference-between-euid-suid-and-ruid-in-linux-systems" target="_blank">https://stackoverflow.com/questions/33982789/difference-between-euid-suid-and-ruid-in-linux-systems</a></p>
<h2 id="&#x8865;&#x5145;"><a name="&#x8865;&#x5145;" class="anchor-navigation-ex-anchor" href="#&#x8865;&#x5145;"><i class="fa fa-link" aria-hidden="true"></i></a>5.2. &#x8865;&#x5145;</h2>
<p>&#x4F7F;&#x7528;<code>ps -eo user,pid,euid,ruid,suid,cmd | grep gshell</code>&#x53EF;&#x4EE5;&#x67E5;&#x770B;&#x5404;&#x79CD;id</p>
<pre class="language-"><code>euid        EUID      effective user ID (alias uid).
ruid        RUID      real user ID.
suid        SUID      saved user ID.  (alias svuid).
</code></pre><h2 id="&#x5B9E;&#x9A8C;"><a name="&#x5B9E;&#x9A8C;" class="anchor-navigation-ex-anchor" href="#&#x5B9E;&#x9A8C;"><i class="fa fa-link" aria-hidden="true"></i></a>5.3. &#x5B9E;&#x9A8C;</h2>
<p>&#x5F53;&#x6211;<code>sudo chmod ugo+ws bin/gshell</code>&#x540E;, &#x770B;&#x5230;</p>
<pre class="language-"><code>-rwsrwsrwx 1 nobody nogroup 23M Oct 22 05:34 gshell
</code></pre><h3 id="&#x7136;&#x540E;&#x7528;&#x666E;&#x901A;user&#x542F;&#x52A8;"><a name="&#x7136;&#x540E;&#x7528;&#x666E;&#x901A;user&#x542F;&#x52A8;" class="anchor-navigation-ex-anchor" href="#&#x7136;&#x540E;&#x7528;&#x666E;&#x901A;user&#x542F;&#x52A8;"><i class="fa fa-link" aria-hidden="true"></i></a>5.3.1. &#x7136;&#x540E;&#x7528;&#x666E;&#x901A;user&#x542F;&#x52A8;</h3>
<p><code>bin/gshell -loglevel debug daemon -registry 10.182.105.179:11985 -bcast 9923</code>
&#x770B;&#x5230;:</p>
<pre class="language-"><code>$ ps -eo user,pid,euid,ruid,suid,cmd | grep gshell
nobody   27870 65534  1003 65534 bin/gshell -loglevel debug daemon -registry 10.182.105.179:11985 -bcast 9923
yingjieb 27893  1003  1003  1003 grep gshell
</code></pre><p>&#x5F88;&#x660E;&#x663E;:</p>
<ul>
<li>&#x666E;&#x901A;&#x8FDB;&#x7A0B;<code>grep</code>, &#x5176;euid ruid suid&#x90FD;&#x662F;&#x4E00;&#x81F4;&#x7684;, &#x5373;&#x90FD;&#x662F;1003(yingjieb)</li>
<li>&#x4F46;bin/gshell&#x5E26;s&#x5C5E;&#x6027;(&#x5373;setuid&#x5C5E;&#x6027;), &#x7528;&#x666E;&#x901A;&#x7528;&#x6237;&#x8FD0;&#x884C;, euid&#x548C;suid&#x662F;65534(nobody), ruid&#x662F;&#x542F;&#x52A8;&#x7528;&#x6237;</li>
</ul>
<h3 id="&#x7528;root&#x542F;&#x52A8;"><a name="&#x7528;root&#x542F;&#x52A8;" class="anchor-navigation-ex-anchor" href="#&#x7528;root&#x542F;&#x52A8;"><i class="fa fa-link" aria-hidden="true"></i></a>5.3.2. &#x7528;root&#x542F;&#x52A8;</h3>
<p><code>sudo bin/gshell -loglevel debug daemon -registry 10.182.105.179:11985 -bcast 9923</code>
&#x770B;&#x5230;:</p>
<pre class="language-"><code>$ ps -eo user,pid,euid,ruid,suid,cmd | grep gshell
root     27897     0     0     0 sudo bin/gshell -loglevel debug daemon -registry 10.182.105.179:11985 -bcast 9923
nobody   27898 65534     0 65534 bin/gshell -loglevel debug daemon -registry 10.182.105.179:11985 -bcast 9923
yingjieb 27910  1003  1003  1003 grep gshell
</code></pre><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;, &#x5148;&#x7528;root&#x542F;&#x52A8;&#x4E86;&#x8BE5;&#x7A0B;&#x5E8F;, &#x4F46;&#x4F1A;&#x4EE5;nobody fork&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x8FD0;&#x884C;, fork&#x7684;&#x8FDB;&#x7A0B;&#x7684;euid&#x548C;suid&#x662F;nobody, &#x4F46;ruid&#x8FD8;&#x662F;root.</p>
<h2 id="&#x8FDB;&#x7A0B;&#x7684;&#x6743;&#x9650;&#x662F;&#x770B;ruid-&#x800C;&#x4E0D;&#x662F;euid"><a name="&#x8FDB;&#x7A0B;&#x7684;&#x6743;&#x9650;&#x662F;&#x770B;ruid-&#x800C;&#x4E0D;&#x662F;euid" class="anchor-navigation-ex-anchor" href="#&#x8FDB;&#x7A0B;&#x7684;&#x6743;&#x9650;&#x662F;&#x770B;ruid-&#x800C;&#x4E0D;&#x662F;euid"><i class="fa fa-link" aria-hidden="true"></i></a>5.4. &#x8FDB;&#x7A0B;&#x7684;&#x6743;&#x9650;&#x662F;&#x770B;ruid, &#x800C;&#x4E0D;&#x662F;euid</h2>
<p>&#x6BD4;&#x5982;&#x4E0A;&#x9762;&#x7684;&#x4F8B;&#x5B50;, root&#x542F;&#x52A8;&#x7684;&#x8FDB;&#x7A0B;27898, &#x867D;&#x7136;euid&#x53D8;&#x6210;&#x4E86;nobody, &#x4F46;&#x5B9E;&#x9645;&#x8BE5;&#x8FDB;&#x7A0B;&#x8FD8;&#x662F;&#x53EF;&#x4EE5;&#x6709;root&#x6743;&#x9650;, &#x521B;&#x5EFA;&#x5220;&#x9664;&#x6743;&#x9650;&#x90FD;&#x662F;root&#x7684;.
&#x90A3;euid&#x6709;&#x5565;&#x7528;?</p>
<h2 id="golang&#x6743;&#x9650;&#x964D;&#x7EA7;"><a name="golang&#x6743;&#x9650;&#x964D;&#x7EA7;" class="anchor-navigation-ex-anchor" href="#golang&#x6743;&#x9650;&#x964D;&#x7EA7;"><i class="fa fa-link" aria-hidden="true"></i></a>5.5. golang&#x6743;&#x9650;&#x964D;&#x7EA7;</h2>
<p>&#x601D;&#x8DEF;&#x662F;&#x5148;&#x8BA9;bin&#x6587;&#x4EF6;&#x7684;owner&#x662F;nobody, &#x5E26;setuid&#x5C5E;&#x6027;. &#x7136;&#x540E;&#x4EFB;&#x4F55;&#x7528;&#x6237;&#x542F;&#x52A8;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;, euid&#x90FD;&#x662F;nobody&#x7684;.
&#x4F46;ruid&#x8FD8;&#x662F;&#x542F;&#x52A8;&#x7528;&#x6237;&#x7684;. &#x8981;&#x5728;&#x4EE3;&#x7801;&#x91CC;&#x6539;ruid:</p>
<pre class="language-"><code class="lang-go">        euid <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Geteuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Setreuid</span><span class="token punctuation">(</span>euid<span class="token punctuation">,</span> euid<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
</code></pre>
<p>&#x6539;&#x4E86;ruid&#x540E;, &#x518D;&#x7528;<code>ps -eo user,pid,euid,ruid,suid,cmd | grep gshell</code>&#x770B;, &#x6240;&#x6709;&#x7684;UID&#x90FD;&#x662F;nobody&#x4E86;.
&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x5C31;&#x53EA;&#x6709;nobody&#x6743;&#x9650;&#x4E86;.
&#x8865;&#x5145;, gid&#x4E5F;&#x8981;&#x8BBE;&#x7F6E;:
<code>ps -eo user,pid,euid,ruid,suid,egid,rgid,sgid,cmd | grep gshell</code></p>
<h1 id="&#x4EC0;&#x4E48;&#x662F;defunct&#x8FDB;&#x7A0B;"><a name="&#x4EC0;&#x4E48;&#x662F;defunct&#x8FDB;&#x7A0B;" class="anchor-navigation-ex-anchor" href="#&#x4EC0;&#x4E48;&#x662F;defunct&#x8FDB;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a>6. &#x4EC0;&#x4E48;&#x662F;defunct&#x8FDB;&#x7A0B;?</h1>
<p>gshell&#x8D77;&#x4E86;&#x4E00;&#x4E2A;&#x81EA;&#x5DF1;&#x7684;new version&#x7684;&#x8FDB;&#x7A0B;, &#x4F46;&#x663E;&#x793A;:</p>
<pre class="language-"><code class="lang-sh">$ <span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> gshell
yingjieb  <span class="token number">6762</span>  <span class="token number">9291</span>  <span class="token number">2</span> <span class="token number">12</span>:18 pts/9    00:00:02 bin/gshell <span class="token parameter variable">-wd</span> .working <span class="token parameter variable">-loglevel</span> debug daemon <span class="token parameter variable">-registry</span> <span class="token number">10.182</span>.105.138:11985 <span class="token parameter variable">-bcast</span> <span class="token number">9923</span> <span class="token parameter variable">-root</span> <span class="token parameter variable">-repo</span> gitlabe1.ext.net.nokia.com/godevsig/grepo/master <span class="token parameter variable">-update</span> http://10.182.105.179:8088/gshell/release/latest/%s
yingjieb  <span class="token number">6777</span>  <span class="token number">6762</span>  <span class="token number">0</span> <span class="token number">12</span>:18 pts/9    00:00:00 bin/gshell <span class="token parameter variable">-wd</span> .working <span class="token parameter variable">-loglevel</span> debug __start <span class="token parameter variable">-e</span> master.v1.1.3
yingjieb  <span class="token number">6799</span>  <span class="token number">6762</span>  <span class="token number">0</span> <span class="token number">12</span>:20 pts/9    00:00:00 <span class="token punctuation">[</span>gshell<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
</code></pre>
<p>&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x7684;<code>[gshell] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>defunct</span><span class="token punctuation">&gt;</span></span></code>&#x662F;&#x50F5;&#x5C38;&#x8FDB;&#x7A0B;:</p>
<blockquote>
<p>Processes marked <strong><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>defunct</span><span class="token punctuation">&gt;</span></span></code></strong> are dead processes (so-called <em>&quot;zombies&quot;</em>) that remain because their parent has not destroyed them properly. These processes will be destroyed by <code>init(8)</code> if the parent process exits.</p>
</blockquote>
<p>&#x50F5;&#x5C38;&#x8FDB;&#x7A0B;&#x4E0D;&#x80FD;&#x88AB;kill, &#x56E0;&#x4E3A;&#x5B83;&#x5DF2;&#x7ECF;&#x6B7B;&#x4E86;. &#x5B83;&#x8FD8;&#x5728;&#x8FD9;&#x91CC;&#x663E;&#x793A;&#x662F;&#x56E0;&#x4E3A;&#x5176;&#x7236;&#x8FDB;&#x7A0B;&#x8FD8;&#x5728;, &#x4F46;&#x6CA1;&#x6709;&#x6E05;&#x7406;&#x8FD9;&#x4E2A;&#x6B7B;&#x6389;&#x7684;&#x5B50;&#x8FDB;&#x7A0B;.
&#x5BF9;&#x5E94;&#x7684;go&#x4EE3;&#x7801;: &#x56E0;&#x4E3A;<code>Start()</code>&#x5E76;&#x4E0D;&#x4F1A;&#x7B49;&#x5F85;&#x5E76;&#x6E05;&#x7406;&#x5B50;&#x8FDB;&#x7A0B;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">if</span> err <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>cmdArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cmdArgs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    lg<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;start new gshell failed: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    lg<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;new version gshell started&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6CE8;: &#x8FD9;&#x91CC;&#x5B50;&#x8FDB;&#x7A0B;&#x6B7B;&#x6389;&#x7684;&#x539F;&#x56E0;&#x53EF;&#x4EE5;&#x7528;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x6355;&#x6349;</p>
<pre class="language-"><code class="lang-go">out<span class="token punctuation">,</span> err <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>cmdArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cmdArgs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Output</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
lg<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">&quot;out: %s, err: %v&quot;</span><span class="token punctuation">,</span> out<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
</code></pre>
<p>&#x662F;&#x56E0;&#x4E3A;&#x4F20;&#x5165;&#x7684;<code>-update</code>&#x9009;&#x9879;&#x65B0;&#x7684;binary&#x4E0D;&#x8BA4;&#x8BC6;.</p>
<h1 id="cgroup-v2"><a name="cgroup-v2" class="anchor-navigation-ex-anchor" href="#cgroup-v2"><i class="fa fa-link" aria-hidden="true"></i></a>7. cgroup v2</h1>
<p><a href="https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v2.html" target="_blank">https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v2.html</a></p>
<pre class="language-"><code>mount -t cgroup2 none $MOUNT_POINT
</code></pre><ul>
<li>&#x548C;v1&#x4E0D;&#x540C;, cgroup v2&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x6811;&#x7ED3;&#x6784;</li>
<li>&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x53EA;&#x80FD;&#x5C5E;&#x4E8E;&#x4E00;&#x4E2A;cgroup</li>
<li><code>mkdir $CGROUP_NAME</code>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5B50;cgroup</li>
</ul>
<h2 id="&#x8FDB;&#x7A0B;"><a name="&#x8FDB;&#x7A0B;" class="anchor-navigation-ex-anchor" href="#&#x8FDB;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a>7.1. &#x8FDB;&#x7A0B;</h2>
<ul>
<li>&#x628A;&#x8FDB;&#x7A0B;pid&#x5199;&#x8FDB;<code>cgroup.procs</code>&#x4F1A;migrate&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x5230;&#x8BE5;cgroup, &#x5305;&#x62EC;&#x5176;&#x6240;&#x6709;&#x7EBF;&#x7A0B;.</li>
<li>&#x6BCF;&#x6B21;&#x53EA;&#x80FD;&#x5199;&#x4E00;&#x4E2A;PID&#x5230;<code>cgroup.procs</code>&#x6587;&#x4EF6;, &#x5373;&#x4E00;&#x6B21;<code>write</code>&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x79FB;&#x52A8;&#x4E00;&#x4E2A;pid</li>
<li>&#x6CA1;&#x6709;&#x5B50;cgroup&#x5E76;&#x4E14;&#x91CC;&#x9762;&#x6CA1;&#x6709;pid&#x7684;cgrouup&#x53EF;&#x4EE5;&#x5220;&#x9664;: <code>rmdir $CGROUP_NAME</code><ul>
<li>&#x5982;&#x679C;&#x91CC;&#x9762;&#x53EA;&#x6709;zombie&#x8FDB;&#x7A0B;, &#x4E5F;&#x662F;&#x53EF;&#x4EE5;&#x5220;&#x9664;&#x7684;</li>
</ul>
</li>
<li><code>/proc/$PID/cgroup</code>&#x53EF;&#x4EE5;&#x663E;&#x5F0F;pid&#x6240;&#x5C5E;&#x7684;cgroup<pre class="language-"><code>  # cat /proc/842/cgroup
  ...
  0::/test-cgroup/test-cgroup-nested
</code></pre>  &#x5982;&#x679C;&#x8FD9;&#x4E2A;cgroup&#x88AB;&#x5220;&#x9664;&#x4E86;, &#x4F1A;&#x662F;&#x8FD9;&#x6837;: &#x8FD9;&#x4E2A;&#x60C5;&#x51B5;&#x4E0B;, &#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x4E00;&#x5B9A;&#x662F;&#x4E2A;&#x50F5;&#x5C38;&#x8FDB;&#x7A0B;<pre class="language-"><code>  # cat /proc/842/cgroup
  ...
  0::/test-cgroup/test-cgroup-nested (deleted)
</code></pre></li>
</ul>
<h2 id="&#x7EBF;&#x7A0B;"><a name="&#x7EBF;&#x7A0B;" class="anchor-navigation-ex-anchor" href="#&#x7EBF;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a>7.2. &#x7EBF;&#x7A0B;</h2>
<p>&#x5B98;&#x65B9;&#x89E3;&#x91CA;</p>
<blockquote>
<p>cgroup v2 supports thread granularity for a subset of controllers to support use cases requiring hierarchical resource distribution across the threads of a group of processes. By default, all threads of a process belong to the same cgroup, which also serves as the resource domain to host resource consumptions which are not specific to a process or thread. The thread mode allows threads to be spread across a subtree while still maintaining the common resource domain for them.</p>
</blockquote>
<ul>
<li>&#x9ED8;&#x8BA4;&#x6240;&#x6709;&#x7EBF;&#x7A0B;&#x5C5E;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;cgroup, &#x4F46;&#x4E5F;&#x652F;&#x6301;&#x5206;&#x5C5E;&#x4E8E;&#x591A;&#x4E2A;subtree. &#x5C31;&#x662F;&#x8BF4;&#x5728;&#x540C;&#x4E00;&#x4E2A;tree&#x4E0B;&#x9762;</li>
<li>&#x652F;&#x6301;thread&#x6A21;&#x5F0F;&#x7684;controller&#x53EB;<code>threaded controllers</code>; &#x4E0D;&#x652F;&#x6301;&#x7684;&#x53EB;<code>domain controllers</code></li>
<li>&#x9ED8;&#x8BA4;&#x521B;&#x5EFA;&#x7684;cgroup&#x662F;domain&#x6A21;&#x5F0F;, &#x7528;<code>echo threaded &gt; cgroup.type</code>&#x53EF;&#x4EE5;&#x5C06;&#x5176;&#x6539;&#x4E3A;threaded&#x6A21;&#x5F0F;, &#x4F46;&#x8981;&#x6EE1;&#x8DB3;&#x5982;&#x4E0B;&#x6761;&#x4EF6;:<ul>
<li>As the cgroup will join the parent&#x2019;s resource domain. The parent must either be a valid (threaded) domain or a threaded cgroup.</li>
<li>When the parent is an unthreaded domain, it must not have any domain controllers enabled or populated domain children. The root is exempt from this requirement.</li>
</ul>
</li>
<li>threaded cgroup&#x4E0B;&#x9762;&#x65B0;&#x5EFA;&#x7684;cgroup&#x9ED8;&#x8BA4;&#x662F;&#x65E0;&#x6548;&#x7684;
<code>A (threaded domain) - B (threaded) - C (domain, just created)</code>
&#x8FD9;&#x6837;&#x7684;cgroup&#x6811;, &#x5728;C&#x521A;&#x521A;&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019;, &#x9ED8;&#x8BA4;&#x662F;domain&#x63A7;&#x5236;&#x5668;, &#x4F46;&#x5B83;&#x7684;&#x7236;&#x8282;&#x70B9;&#x4E0A;&#x90FD;&#x4E0D;&#x662F;domain&#x63A7;&#x5236;&#x5668;. &#x8FD9;&#x6837;C&#x7684;<code>cgroup.type</code>&#x6587;&#x4EF6;&#x4F1A;&#x62A5;&#x544A;<code>domain (invalid)</code>, &#x76F4;&#x5230;&#x914D;&#x7F6E;&#x5176;&#x4E3A;threaded&#x6A21;&#x5F0F;.</li>
<li>&#x4E00;&#x4E2A;cgroup&#x53D8;&#x4E3A;threaded&#x6A21;&#x5F0F;&#x4F1A;&#x5BFC;&#x81F4;&#x5176;&#x7236;domain cgroup&#x53D8;&#x4E3A;threaded domain</li>
<li>&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;&#x7EBF;&#x7A0B;&#x53EA;&#x80FD;&#x5728;&#x4E00;&#x4E2A;threaded domain&#x4E0B;&#x5B58;&#x5728;.</li>
<li><blockquote>
<p>The threaded domain cgroup serves as the resource domain for the whole subtree, and, while the threads can be scattered across the subtree, all the processes are considered to be in the threaded domain cgroup. &#x201C;cgroup.procs&#x201D; in a threaded domain cgroup contains the PIDs of all processes in the subtree and is not readable in the subtree proper. However, &#x201C;cgroup.procs&#x201D; can be written to from anywhere in the subtree to migrate all threads of the matching process to the cgroup.
&#x8FD9;&#x6BB5;&#x8BF4;&#x7684;&#x662F;&#x7EBF;&#x7A0B;domain&#x7EC4;&#x7684;<code>cgroup.procs</code>&#x5305;&#x542B;&#x4E86;&#x5B50;&#x6811;&#x7684;&#x6240;&#x6709;<strong>&#x8FDB;&#x7A0B;</strong>, &#x56E0;&#x4E3A;&#x6B64;&#x65F6;&#x5B50;&#x6811;&#x91CC;&#x9762;&#x90FD;&#x662F;&#x7EBF;&#x7A0B;ID</p>
</blockquote>
</li>
<li><code>A (threaded domain) - B (threaded)</code>&#x5728;&#x8FD9;&#x4E2A;&#x6A21;&#x5F0F;&#x4E0B;, &#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x5728;B&#x4E2D;, &#x90A3;B&#x53EA;&#x7B97;&#x8FD9;&#x4E2A;&#x7EBF;&#x7A0B;&#x7684;&#x8D44;&#x6E90;. &#x4F46;B&#x6240;&#x5C5E;&#x7684;&#x8FDB;&#x7A0B;&#x6240;&#x6709;&#x8D44;&#x6E90;&#x90FD;&#x7B97;&#x5728;A&#x7684;&#x5934;&#x4E0A;, &#x56E0;&#x4E3A;A&#x662F;domain&#x63A7;&#x5236;&#x5668;</li>
</ul>
<h2 id="&#x63A7;&#x5236;&#x5668;&#x4F7F;&#x80FD;"><a name="&#x63A7;&#x5236;&#x5668;&#x4F7F;&#x80FD;" class="anchor-navigation-ex-anchor" href="#&#x63A7;&#x5236;&#x5668;&#x4F7F;&#x80FD;"><i class="fa fa-link" aria-hidden="true"></i></a>7.3. &#x63A7;&#x5236;&#x5668;&#x4F7F;&#x80FD;</h2>
<ul>
<li>&#x6BCF;&#x4E2A;cgroup&#x90FD;&#x652F;&#x6301;&#x63A7;&#x5236;&#x5668;&#x7C7B;&#x578B;<pre class="language-"><code># cat cgroup.controllers
cpu io memory
</code></pre></li>
<li>&#x9ED8;&#x8BA4;&#x5168;&#x90E8;&#x90FD;&#x662F;&#x4E0D;&#x4F7F;&#x80FD;&#x7684;. &#x9700;&#x8981;&#x663E;&#x5F0F;&#x4F7F;&#x80FD;:
<code># echo &quot;+cpu +memory -io&quot; &gt; cgroup.subtree_control</code></li>
<li>&#x53EA;&#x6709;&#x7A7A;&#x7684;domain cgroup&#x624D;&#x80FD;&#x4F7F;&#x80FD;domain&#x63A7;&#x5236;&#x5668;. &#x4F46;root&#x4E0D;&#x53D7;&#x6B64;&#x9650;&#x5236;</li>
</ul>
<h2 id="&#x4E0D;&#x63A8;&#x8350;&#x52A8;&#x6001;&#x8FC1;&#x79FB;pid"><a name="&#x4E0D;&#x63A8;&#x8350;&#x52A8;&#x6001;&#x8FC1;&#x79FB;pid" class="anchor-navigation-ex-anchor" href="#&#x4E0D;&#x63A8;&#x8350;&#x52A8;&#x6001;&#x8FC1;&#x79FB;pid"><i class="fa fa-link" aria-hidden="true"></i></a>7.4. &#x4E0D;&#x63A8;&#x8350;&#x52A8;&#x6001;&#x8FC1;&#x79FB;pid</h2>
<blockquote>
<p>Migrating a process across cgroups is a relatively expensive operation and stateful resources such as memory are not moved together with the process. This is an explicit design decision as there often exist inherent trade-offs between migration and various hot paths in terms of synchronization cost.</p>
<p>As such, migrating processes across cgroups frequently as a means to apply different resource restrictions is discouraged. A workload should be assigned to a cgroup according to the system&#x2019;s logical and resource structure once on start-up. Dynamic adjustments to resource distribution can be made by changing controller configuration through the interface files.</p>
</blockquote>
<p>&#x4EE5;&#x4E0A;&#x8BF4;&#x7684;&#x662F;&#x52A8;&#x6001;&#x8FC1;&#x79FB;pid&#x7684;cost&#x6709;&#x70B9;&#x5927;. &#x52A8;&#x6001;&#x7684;&#x914D;&#x7F6E;&#x53EF;&#x4EE5;&#x4F5C;&#x7528;&#x5728;&#x63A7;&#x5236;&#x5668;&#x7684;&#x76F8;&#x5173;&#x63A5;&#x53E3;&#x6587;&#x4EF6;&#x4E0A;.
&#x5C31;&#x662F;&#x8BF4;&#x8981;&#x9759;&#x6001;pid&#x5230;group, &#x4F46;group&#x7684;&#x914D;&#x7F6E;&#x53EF;&#x4EE5;&#x6539;.</p>
<h2 id="&#x8D44;&#x6E90;&#x9650;&#x5236;&#x7C7B;&#x578B;"><a name="&#x8D44;&#x6E90;&#x9650;&#x5236;&#x7C7B;&#x578B;" class="anchor-navigation-ex-anchor" href="#&#x8D44;&#x6E90;&#x9650;&#x5236;&#x7C7B;&#x578B;"><i class="fa fa-link" aria-hidden="true"></i></a>7.5. &#x8D44;&#x6E90;&#x9650;&#x5236;&#x7C7B;&#x578B;</h2>
<ul>
<li>Weights
&#x6BD4;&#x4F8B;&#x65B9;&#x5F0F;. &#x8303;&#x56F4;&#x4ECE;[1, 10000], &#x9ED8;&#x8BA4;100
&#x53EF;&#x4EE5;&#x8D85;&#x914D;</li>
<li>Limits
&#x9650;&#x989D;&#x65B9;&#x5F0F;, &#x4ECE;[0, max], &#x9ED8;&#x8BA4;max.
&#x53EF;&#x4EE5;&#x8D85;&#x914D;(&#x8FD9;&#x70B9;&#x548C;v1&#x4E0D;&#x4E00;&#x6837;?) -- &#x4E3A;&#x4EC0;&#x4E48;&#x53EF;&#x4EE5;&#x8D85;&#x914D;? &#x56E0;&#x4E3A;&#x666E;&#x901A;&#x6A21;&#x5F0F;&#x6536;CFS&#x8C03;&#x5EA6;, &#x5B8C;&#x5168;&#x516C;&#x5E73;, CPU 100%&#x5FD9;&#x4E5F;&#x53D7;&#x8C03;&#x5EA6;&#x9650;&#x5236;.</li>
<li>Protections
&#x4FDD;&#x62A4;&#x65B9;&#x5F0F;. &#x770B;&#x8D77;&#x6765;&#x662F;&#x4FDD;&#x62A4;&#x6700;&#x4F4E;&#x9650;&#x989D;.</li>
<li>Allocations
&#x5206;&#x914D;&#x65B9;&#x5F0F;.
&#x4E0D;&#x80FD;&#x8D85;&#x914D;. &#x4F3C;&#x4E4E;&#x5C31;&#x662F;&#x73B0;&#x5728;&#x7684;&#x7528;&#x6CD5;?</li>
</ul>
<h2 id="&#x63A7;&#x5236;&#x5668;&#x7C7B;&#x578B;"><a name="&#x63A7;&#x5236;&#x5668;&#x7C7B;&#x578B;" class="anchor-navigation-ex-anchor" href="#&#x63A7;&#x5236;&#x5668;&#x7C7B;&#x578B;"><i class="fa fa-link" aria-hidden="true"></i></a>7.6. &#x63A7;&#x5236;&#x5668;&#x7C7B;&#x578B;</h2>
<h3 id="cpu"><a name="cpu" class="anchor-navigation-ex-anchor" href="#cpu"><i class="fa fa-link" aria-hidden="true"></i></a>7.6.1. CPU</h3>
<blockquote>
<p>The &#x201C;cpu&#x201D; controllers regulates distribution of CPU cycles. This controller implements weight and absolute bandwidth limit models for normal scheduling policy and absolute bandwidth allocation model for realtime scheduling policy.
&#x8BF4;&#x7684;&#x5F88;&#x6E05;&#x695A;, CPU&#x7C7B;&#x578B;&#x7684;&#x63A7;&#x5236;&#x5668;&#x5B9E;&#x73B0;&#x4E86;&#x666E;&#x901A;&#x8C03;&#x5EA6;&#x6A21;&#x5F0F;&#x4E0B;&#x7684;&#x9650;&#x989D;&#x65B9;&#x5F0F;(&#x53EF;&#x4EE5;&#x8D85;&#x914D;)&#x4EE5;&#x53CA;&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;&#x6A21;&#x5F0F;&#x4E0B;&#x7684;&#x5206;&#x914D;&#x65B9;&#x5F0F;(&#x4E0D;&#x80FD;&#x8D85;&#x914D;)
WARNING: cgroup2 doesn&#x2019;t yet support control of realtime processes and the cpu controller can only be enabled when all RT processes are in the root cgroup. Be aware that system management software may already have placed RT processes into nonroot cgroups during the system boot process, and these processes may need to be moved to the root cgroup before the cpu controller can be enabled.
&#x8FD9;&#x4E2A;warn&#x7684;&#x610F;&#x601D;&#x662F;cgroup2&#x5BF9;RT&#x7684;&#x652F;&#x6301;&#x8FD8;&#x4E0D;&#x597D;?</p>
</blockquote>
<ul>
<li>&#x63A5;&#x53E3;&#x6587;&#x4EF6;<ul>
<li><code>cpu.stat</code> &#x7EDF;&#x8BA1;&#x4FE1;&#x606F;. &#x7ADF;&#x7136;&#x5C31;&#x6709;&#x5229;&#x7528;&#x7387;&#x548C;&#x7528;&#x6237;&#x6001; &#x5185;&#x6838;&#x6001;&#x65F6;&#x95F4;</li>
<li><code>cpu.weight</code> normal&#x8C03;&#x5EA6;&#x7528;&#x7684;&#x6BD4;&#x4F8B;&#x65B9;&#x5F0F;</li>
<li><code>cpu.max</code> &#x5E94;&#x8BE5;&#x662F;&#x7ED9;RT&#x7528;&#x7684; allocation&#x65B9;&#x5F0F;</li>
</ul>
</li>
</ul>
<h3 id="&#x5185;&#x5B58;"><a name="&#x5185;&#x5B58;" class="anchor-navigation-ex-anchor" href="#&#x5185;&#x5B58;"><i class="fa fa-link" aria-hidden="true"></i></a>7.6.2. &#x5185;&#x5B58;</h3>
<p>&#x5185;&#x5B58;&#x63A7;&#x5236;&#x5668;&#x662F;&#x6709;&#x72B6;&#x6001;&#x7684;, &#x5B9E;&#x73B0;&#x4E86;limit&#x65B9;&#x5F0F;&#x548C;protection&#x65B9;&#x5F0F;.
&#x76EE;&#x524D;&#x6709;&#x4E09;&#x79CD;&#x7C7B;&#x578B;&#x7684;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x80FD;&#x591F;&#x88AB;&#x7EDF;&#x8BA1;&#x5230;:</p>
<ul>
<li>&#x7528;&#x6237;&#x6001;&#x9875;&#x8868;: Userland memory - page cache and anonymous memory.</li>
<li>&#x5185;&#x6838;&#x6001;&#x6570;&#x636E;: Kernel data structures such as dentries and inodes.</li>
<li>TCP&#x7684;&#x5185;&#x5B58;: TCP socket buffers.</li>
</ul>
<p>&#x5982;&#x4E0B;&#x63A5;&#x53E3;&#x6587;&#x4EF6;:</p>
<ul>
<li><code>memory.current</code> &#x76EE;&#x524D;mem&#x5360;&#x7528;, &#x5E94;&#x662F;&#x5B9E;&#x9645;&#x503C;</li>
<li><code>memory.min</code> &#x53D7;&#x4FDD;&#x62A4;&#x7684;&#x6700;&#x5C0F;&#x503C;, &#x9ED8;&#x8BA4;&#x662F;0</li>
<li><code>memory.low</code> &#x5728;low&#x4E0B;&#x90FD;&#x4E0D;&#x4F1A;&#x88AB;kernel&#x56DE;&#x6536;</li>
<li><code>memory.high</code> &#x8D85;&#x8FC7;high&#x4F1A;&#x88AB;kernel&#x4E25;&#x683C;&#x56DE;&#x6536;</li>
<li><code>memory.max</code> &#x786C;&#x4E0A;&#x9650;. &#x8D85;&#x8FC7;OOM</li>
<li><code>memory.stat</code> &#x8BE6;&#x7EC6;&#x7EDF;&#x8BA1;: &#x533F;&#x540D;&#x9875; &#x6709;&#x540D;&#x9875; &#x6587;&#x4EF6; &#x5171;&#x4EAB;&#x5185;&#x5B58; slab </li>
</ul>
<h3 id="io"><a name="io" class="anchor-navigation-ex-anchor" href="#io"><i class="fa fa-link" aria-hidden="true"></i></a>7.6.3. IO</h3>
<p>&#x4F20;&#x7EDF;&#x4E0A;&#x5E94;&#x8BE5;&#x662F;&#x6307;disk IO</p>
<h3 id="pid"><a name="pid" class="anchor-navigation-ex-anchor" href="#pid"><i class="fa fa-link" aria-hidden="true"></i></a>7.6.4. PID</h3>
<p>&#x7528;&#x4E8E;&#x9650;&#x5236;PID&#x53EF;&#x4EE5;fork&#x548C;clone&#x7684;&#x6B21;&#x6570;</p>
<h3 id="cpuset"><a name="cpuset" class="anchor-navigation-ex-anchor" href="#cpuset"><i class="fa fa-link" aria-hidden="true"></i></a>7.6.5. Cpuset</h3>
<p>&#x6307;&#x5B9A;&#x6838;. &#x4E3B;&#x8981;&#x7528;&#x4E8E;NUMA&#x573A;&#x666F;. &#x53EF;&#x4EE5;&#x548C;CPU&#x4EE5;&#x53CA;mem&#x8054;&#x7528;. &#x6BD4;&#x5982;&#x5728;&#x4E00;&#x4E2A;cgroup tree&#x4E0B;&#x9762;, &#x540C;&#x65F6;&#x9650;&#x5236;CPU&#x4F7F;&#x7528;, MEM&#x4F7F;&#x7528;&#x4EE5;&#x53CA;&#x6307;&#x5B9A;CPU&#x6838;</p>
<ul>
<li><code>cpuset.cpus</code></li>
</ul>
<h2 id="&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4EA4;&#x4E92;"><a name="&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4EA4;&#x4E92;" class="anchor-navigation-ex-anchor" href="#&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4EA4;&#x4E92;"><i class="fa fa-link" aria-hidden="true"></i></a>7.7. &#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4EA4;&#x4E92;</h2>
<ul>
<li><code>cgroup.type</code>
&#x63A7;&#x5236;cgroup&#x662F;&#x5426;&#x4E3A;threaded&#x6A21;&#x5F0F;</li>
<li><code>cgroup.procs</code>
&#x8FDB;&#x7A0B;&#x52A0;&#x5165;cgroup. &#x6240;&#x6709;&#x7EBF;&#x7A0B;&#x4E5F;&#x4E00;&#x8D77;&#x52A0;&#x5165;
&#x5728;threaded&#x6A21;&#x5F0F;&#x4E0B;, &#x8BFB;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x8FD4;&#x56DE;<code>EOPNOTSUPP</code>, &#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;cgroup&#x53EA;&#x7BA1;&#x7EBF;&#x7A0B;, &#x7EBF;&#x7A0B;&#x6240;&#x5C5E;&#x7684;&#x8FDB;&#x7A0B;&#x5F52;&#x8FD9;&#x4E2A;threaded domain&#x7BA1;(&#x5728;cgroup tree&#x7684;&#x4E0A;&#x6E38;). &#x4F46;&#x5199;&#x8FD8;&#x662F;&#x4E00;&#x6837;&#x7684;&#x8BED;&#x4E49;.</li>
<li><code>cgroup.threads</code>
&#x7EBF;&#x7A0B;&#x52A0;&#x5165;cgroup. &#x53EA;&#x6709;&#x5728;&#x540C;&#x4E00;&#x4E2A;domain&#x7684;&#x7EBF;&#x7A0B;&#x624D;&#x80FD;&#x52A0;&#x5165;. &#x5373;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;&#x7EBF;&#x7A0B;, &#x53EA;&#x80FD;&#x5728;&#x540C;&#x4E00;&#x4E2A;domain&#x7684;&#x5B50;&#x6811;&#x4E0A;.</li>
<li><code>cgroup.subtree_control</code>
&#x7BA1;&#x4F7F;&#x80FD;&#x63A7;&#x5236;&#x5668;&#x7684;</li>
<li><code>cgroup.events</code>
&#x80FD;&#x663E;&#x793A;&#x8FD9;&#x4E2A;cgroup&#x53CA;&#x5176;&#x5B50;&#x6811;&#x5F53;&#x524D;&#x662F;&#x5426;&#x6709;&#x6709;&#x6548;&#x7684;pid. &#x6709;&#x6548;&#x5C31;&#x662F;&#x6307;&#x6709;&#x81F3;&#x5C11;&#x4E00;&#x4E2A;&#x975E;zombine&#x7684;pid</li>
<li><code>cgroup.freeze</code>
&#x5199;1&#x5C31;freeze&#x8FD9;&#x4E2A;cgroup</li>
</ul>
<h2 id="&#x548C;v1&#x7684;&#x5BF9;&#x6BD4;"><a name="&#x548C;v1&#x7684;&#x5BF9;&#x6BD4;" class="anchor-navigation-ex-anchor" href="#&#x548C;v1&#x7684;&#x5BF9;&#x6BD4;"><i class="fa fa-link" aria-hidden="true"></i></a>7.8. &#x548C;V1&#x7684;&#x5BF9;&#x6BD4;</h2>
<ul>
<li>v1&#x5141;&#x8BB8;&#x591A;&#x4E2A;&#x6811;, &#x800C;v2&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x6811;. &#x770B;&#x4F3C;v1&#x66F4;&#x7075;&#x6D3B;, &#x6BCF;&#x4E2A;tree&#x91CC;&#x9762;&#x8FD8;&#x53EF;&#x4EE5;&#x6709;&#x4EFB;&#x610F;&#x7684;&#x63A7;&#x5236;&#x5668;. &#x4F46;&#x8FC7;&#x8BBE;&#x8BA1;&#x4E86;.</li>
<li>v1&#x5141;&#x8BB8;&#x8FDB;&#x7A0B;&#x7684;&#x7EBF;&#x7A0B;&#x5206;&#x5C5E;&#x4E8E;&#x591A;&#x4E2A;cgroup. &#x800C;v2&#x53EA;&#x80FD;&#x662F;&#x5728;&#x4E00;&#x4E2A;domain; ok, &#x8FD8;&#x662F;v1&#x8FC7;&#x8BBE;&#x8BA1;&#x4E86;.</li>
<li>v1&#x4F1A;&#x6709;&#x7236;&#x5B50;&#x7ADE;&#x4E89;&#x73B0;&#x8C61;, &#x56E0;&#x4E3A;&#x7EBF;&#x7A0B;&#x53EF;&#x4EE5;&#x4EFB;&#x610F;&#x6240;&#x5C5E;.</li>
</ul>
<h1 id="&#x7CFB;&#x7EDF;&#x5185;&#x5B58;&#x5360;&#x7528;&#x5206;&#x6790;"><a name="&#x7CFB;&#x7EDF;&#x5185;&#x5B58;&#x5360;&#x7528;&#x5206;&#x6790;" class="anchor-navigation-ex-anchor" href="#&#x7CFB;&#x7EDF;&#x5185;&#x5B58;&#x5360;&#x7528;&#x5206;&#x6790;"><i class="fa fa-link" aria-hidden="true"></i></a>8. &#x7CFB;&#x7EDF;&#x5185;&#x5B58;&#x5360;&#x7528;&#x5206;&#x6790;</h1>
<p>&#x53C2;&#x8003;&#x6587;&#x7AE0;: </p>
<ul>
<li><a href="https://www.cnblogs.com/arnoldlu/p/8568330.html" target="_blank">https://www.cnblogs.com/arnoldlu/p/8568330.html</a></li>
<li><a href="http://linuxperf.com/?p=142" target="_blank">http://linuxperf.com/?p=142</a><pre class="language-"><code class="lang-sh"><span class="token function">cat</span> /proc/meminfo
MemTotal:        <span class="token number">8054880</span> kB---------------------&#x7269;&#x7406;&#x5185;&#x5B58;&#x603B;&#x5BB9;&#x91CF;&#xFF0C;&#x5BF9;&#x5E94;totalram_pages&#x5927;&#x5C0F;&#x3002;
MemFree:         <span class="token number">4004312</span> kB---------------------&#x7A7A;&#x95F2;&#x5185;&#x5B58;&#x5BB9;&#x91CF;&#xFF0C;&#x5BF9;&#x5E94;vm_stat<span class="token punctuation">[</span>NR_FREE_PAGES<span class="token punctuation">]</span>&#x5927;&#x5C0F;&#x3002;
MemAvailable:    <span class="token number">5678888</span> kB---------------------MemFree&#x51CF;&#x53BB;&#x4FDD;&#x7559;&#x5185;&#x5B58;&#xFF0C;&#x52A0;&#x4E0A;&#x90E8;&#x5206;pagecache&#x548C;&#x90E8;&#x5206;SReclaimable&#x3002;
Buffers:          <span class="token number">303016</span> kB---------------------&#x5757;&#x8BBE;&#x5907;&#x7F13;&#x51B2;&#x533A;&#x5927;&#x5C0F;.
Cached:          <span class="token number">2029616</span> kB---------------------&#x4E3B;&#x8981;&#x662F;vm_stat<span class="token punctuation">[</span>NR_FILE_PAGES<span class="token punctuation">]</span>,&#x518D;&#x51CF;&#x53BB;swap&#x51FA;&#x7684;&#x5927;&#x5C0F;&#x548C;&#x5757;&#x8BBE;&#x5907;&#x7F13;&#x51B2;&#x533A;&#x5927;&#x5C0F;&#x3002;Buffers+Cached<span class="token operator">=</span>Active<span class="token punctuation">(</span>file<span class="token punctuation">)</span>+Inactive<span class="token punctuation">(</span>file<span class="token punctuation">)</span>+Shmem&#x3002;
SwapCached:            <span class="token number">0</span> kB---------------------&#x4EA4;&#x6362;&#x7F13;&#x5B58;&#x4E0A;&#x7684;&#x5185;&#x5BB9;&#x5BB9;&#x91CF;&#x3002;
Active:          <span class="token number">2123084</span> kB---------------------Active<span class="token operator">=</span>Active<span class="token punctuation">(</span>anon<span class="token punctuation">)</span>+Active<span class="token punctuation">(</span>file<span class="token punctuation">)</span>&#x3002;
Inactive:        <span class="token number">1476268</span> kB---------------------Inactive<span class="token operator">=</span>Inactive<span class="token punctuation">(</span>anon<span class="token punctuation">)</span>+Inactive<span class="token punctuation">(</span>file<span class="token punctuation">)</span>&#x3002;
Active<span class="token punctuation">(</span>anon<span class="token punctuation">)</span>:    <span class="token number">1273544</span> kB---------------------&#x6D3B;&#x52A8;&#x533F;&#x540D;&#x5185;&#x5B58;&#xFF0C;&#x533F;&#x540D;&#x6307;&#x8FDB;&#x7A0B;&#x4E2D;&#x5806;&#x4E0A;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x6D3B;&#x52A8;&#x6307;&#x6700;&#x8FD1;&#x88AB;&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5B58;&#x3002;
Inactive<span class="token punctuation">(</span>anon<span class="token punctuation">)</span>:   <span class="token number">547988</span> kB---------------------&#x4E0D;&#x6D3B;&#x52A8;&#x533F;&#x540D;&#x5185;&#x5B58;&#xFF0C;&#x5728;&#x5185;&#x5B58;&#x4E0D;&#x8DB3;&#x65F6;&#x4F18;&#x5148;&#x91CA;&#x653E;&#x3002;
Active<span class="token punctuation">(</span>file<span class="token punctuation">)</span>:     <span class="token number">849540</span> kB---------------------&#x6D3B;&#x52A8;&#x6587;&#x4EF6;&#x7F13;&#x5B58;&#xFF0C;&#x8868;&#x793A;&#x5185;&#x5B58;&#x5185;&#x5BB9;&#x4E0E;&#x78C1;&#x76D8;&#x4E0A;&#x6587;&#x4EF6;&#x76F8;&#x5173;&#x8054;&#x3002;
Inactive<span class="token punctuation">(</span>file<span class="token punctuation">)</span>:   <span class="token number">928280</span> kB---------------------&#x4E0D;&#x6D3B;&#x52A8;&#x6587;&#x4EF6;&#x7F13;&#x5B58;&#x3002;
Unevictable:       <span class="token number">17152</span> kB---------------------&#x4E0D;&#x53EF;&#x79FB;&#x52A8;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5F53;&#x7136;&#x4E5F;&#x4E0D;&#x53EF;&#x91CA;&#x653E;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x4F1A;&#x653E;&#x5728;LRU&#x4E2D;&#x3002;
Mlocked:           <span class="token number">17152</span> kB---------------------&#x4F7F;&#x7528;mlocked<span class="token punctuation">(</span><span class="token punctuation">)</span>&#x5904;&#x7406;&#x7684;&#x9875;&#x9762;&#x3002;
SwapTotal:       <span class="token number">7812092</span> kB---------------------&#x4EA4;&#x6362;&#x7A7A;&#x95F4;&#x603B;&#x5BB9;&#x91CF;&#x3002;
SwapFree:        <span class="token number">7812092</span> kB---------------------&#x4EA4;&#x6362;&#x7A7A;&#x95F4;&#x5269;&#x4F59;&#x5BB9;&#x91CF;&#x3002;
Dirty:              <span class="token number">6796</span> kB---------------------&#x810F;&#x6570;&#x636E;&#xFF0C;&#x5728;&#x78C1;&#x76D8;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x5C1A;&#x672A;&#x5199;&#x5165;&#x78C1;&#x76D8;&#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x3002;
Writeback:             <span class="token number">0</span> kB---------------------&#x5F85;&#x56DE;&#x5199;&#x7684;&#x9875;&#x9762;&#x5927;&#x5C0F;&#x3002;
AnonPages:       <span class="token number">1283984</span> kB---------------------&#x5185;&#x6838;&#x4E2D;&#x5B58;&#x5728;&#x4E00;&#x4E2A;rmap<span class="token punctuation">(</span>Reverse Mapping<span class="token punctuation">)</span>&#x673A;&#x5236;&#xFF0C;&#x8D1F;&#x8D23;&#x7BA1;&#x7406;&#x533F;&#x540D;&#x5185;&#x5B58;&#x4E2D;&#x6BCF;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x9875;&#x9762;&#x6620;&#x5C04;&#x5230;&#x54EA;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;&#x90A3;&#x4E2A;&#x903B;&#x8F91;&#x5730;&#x5740;&#x7B49;&#x4FE1;&#x606F;&#x3002;rmap&#x4E2D;&#x8BB0;&#x5F55;&#x7684;&#x5185;&#x5B58;&#x9875;&#x7EFC;&#x5408;&#x5C31;&#x662F;AnonPages&#x503C;&#x3002;
Mapped:           <span class="token number">455248</span> kB---------------------&#x6620;&#x5C04;&#x7684;&#x6587;&#x4EF6;&#x5360;&#x7528;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x3002;
Shmem:            <span class="token number">550260</span> kB---------------------vm_stat<span class="token punctuation">[</span>NR_SHMEM<span class="token punctuation">]</span>&#xFF0C;tmpfs&#x6240;&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5B58;&#xFF0C;tmpfs&#x5373;&#x5229;&#x7528;&#x7269;&#x7406;&#x5185;&#x5B58;&#x6765;&#x63D0;&#x4F9B;RAM&#x78C1;&#x76D8;&#x529F;&#x80FD;&#x3002;&#x5728;tmpfa&#x4E0A;&#x4FDD;&#x5B58;&#x6587;&#x4EF6;&#x65F6;&#xFF0C;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x6682;&#x65F6;&#x5C06;&#x4ED6;&#x4EEC;&#x4FDD;&#x5B58;&#x5230;RAM&#x4E2D;&#x3002;
Slab:             <span class="token number">268208</span> kB---------------------slab&#x5206;&#x914D;&#x5668;&#x603B;&#x91CF;&#xFF0C;&#x901A;&#x8FC7;slabinfo&#x5DE5;&#x5177;&#x6216;&#x8005;/proc/slabinfo&#x6765;&#x67E5;&#x770B;&#x66F4;&#x8BE6;&#x7EC6;&#x7684;&#x4FE1;&#x606F;&#x3002;
SReclaimable:     <span class="token number">206964</span> kB---------------------&#x4E0D;&#x5B58;&#x5728;&#x6D3B;&#x8DC3;&#x5BF9;&#x8C61;&#xFF0C;&#x53EF;&#x56DE;&#x6536;&#x7684;slab&#x7F13;&#x5B58;vm_stat<span class="token punctuation">[</span>NR_SLAB_RECLAIMABLE<span class="token punctuation">]</span>&#x3002;
SUnreclaim:        <span class="token number">61244</span> kB---------------------&#x5BF9;&#x8C61;&#x5904;&#x4E8E;&#x6D3B;&#x8DC3;&#x72B6;&#x6001;&#xFF0C;&#x4E0D;&#x80FD;&#x88AB;&#x56DE;&#x6536;&#x7684;slab&#x5BB9;&#x91CF;&#x3002;
KernelStack:       <span class="token number">12736</span> kB---------------------&#x5185;&#x6838;&#x4EE3;&#x7801;&#x4F7F;&#x7528;&#x7684;&#x5806;&#x6808;&#x533A;&#x3002;
PageTables:        <span class="token number">50376</span> kB---------------------PageTables&#x5C31;&#x662F;&#x9875;&#x8868;&#xFF0C;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x5404;&#x4E2A;&#x7528;&#x6237;&#x8FDB;&#x7A0B;&#x7684;&#x903B;&#x8F91;&#x5730;&#x5740;&#x548C;&#x7269;&#x7406;&#x5730;&#x5740;&#x7684;&#x53D8;&#x5316;&#x5173;&#x7CFB;&#xFF0C;&#x672C;&#x8EAB;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;&#x5185;&#x5B58;&#x533A;&#x57DF;&#x3002;
NFS_Unstable:          <span class="token number">0</span> kB
Bounce:                <span class="token number">0</span> kB
WritebackTmp:          <span class="token number">0</span> kB
CommitLimit:    <span class="token number">11839532</span> kB
Committed_AS:    <span class="token number">7934688</span> kB
VmallocTotal:   <span class="token number">34359738367</span> kB------------------&#x7406;&#x8BBA;&#x4E0A;&#x5185;&#x6838;&#x53EF;&#x4EE5;&#x7528;&#x6765;&#x6620;&#x5C04;&#x7684;&#x903B;&#x8F91;&#x5730;&#x5740;&#x8303;&#x56F4;&#x3002;
VmallocUsed:           <span class="token number">0</span> kB---------------------&#x5185;&#x6838;&#x5C06;&#x7A7A;&#x95F2;&#x5185;&#x5B58;&#x9875;&#x3002;
VmallocChunk:          <span class="token number">0</span> kB
HardwareCorrupted:     <span class="token number">0</span> kB
AnonHugePages:         <span class="token number">0</span> kB
ShmemHugePages:        <span class="token number">0</span> kB
ShmemPmdMapped:        <span class="token number">0</span> kB
CmaTotal:              <span class="token number">0</span> kB
CmaFree:               <span class="token number">0</span> kB
HugePages_Total:       <span class="token number">0</span>
HugePages_Free:        <span class="token number">0</span>
HugePages_Rsvd:        <span class="token number">0</span>
HugePages_Surp:        <span class="token number">0</span>
Hugepagesize:       <span class="token number">2048</span> kB
DirectMap4k:      <span class="token number">226256</span> kB
DirectMap2M:     <span class="token number">5953536</span> kB
DirectMap1G:     <span class="token number">3145728</span> kB
</code></pre>
</li>
</ul>
<p><code>/proc/meminfo</code>&#x548C;<code>free</code>&#x7684;&#x5BF9;&#x5E94;&#x5173;&#x7CFB;&#x5982;&#x4E0B;&#xFF1A;</p>
<table>
<thead>
<tr>
<th>free</th>
<th>/proc/meminfo</th>
</tr>
</thead>
<tbody>
<tr>
<td>total</td>
<td>=MemTotal</td>
</tr>
<tr>
<td>used</td>
<td>=MemTotal - MemFree - (Cached + SReclaimable) - Buffers</td>
</tr>
<tr>
<td>free</td>
<td>=MemFree</td>
</tr>
<tr>
<td>shared</td>
<td>=Shmem</td>
</tr>
<tr>
<td>buffers</td>
<td>=Buffers</td>
</tr>
<tr>
<td>cache</td>
<td>=Cached + SReclaimable</td>
</tr>
<tr>
<td>available</td>
<td>=MemAvailable</td>
</tr>
</tbody>
</table>
<h2 id="&#x5176;&#x4ED6;&#x7EDF;&#x8BA1;"><a name="&#x5176;&#x4ED6;&#x7EDF;&#x8BA1;" class="anchor-navigation-ex-anchor" href="#&#x5176;&#x4ED6;&#x7EDF;&#x8BA1;"><i class="fa fa-link" aria-hidden="true"></i></a>8.1. &#x5176;&#x4ED6;&#x7EDF;&#x8BA1;</h2>
<pre class="language-"><code>/proc/buddyinfo
/proc/pagetypeinfo
/proc/vmstat
/proc/vmallocinfo
/proc/self/statm
/proc/self/maps
/proc/zoneinfo
/proc/slabinfo
/sys/kernel/mm/ksm
/proc/sys/vm/compact_memory
/proc/sys/vm/panic_on_oom
/proc/sys/vm/oom_kill_allocating_task
/proc/sys/vm/oom_dump_tasks
</code></pre><h2 id="vm&#x53C2;&#x6570;"><a name="vm&#x53C2;&#x6570;" class="anchor-navigation-ex-anchor" href="#vm&#x53C2;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>8.2. vm&#x53C2;&#x6570;</h2>
<pre class="language-"><code>/proc/sys/vm/highmem_is_dirtyable
/proc/sys/vm/legacy_va_layout
/proc/sys/vm/lowmem_reserve_ratio
/proc/sys/vm/max_map_count
/proc/sys/vm/mmap_min_addr
/proc/sys/vm/min_free_kbytes
/proc/sys/vm/stat_interval
/proc/sys/vm/vfs_cache_pressure
/proc/sys/vm/page-cluster
</code></pre><h2 id="&#x6587;&#x4EF6;&#x7F13;&#x5B58;"><a name="&#x6587;&#x4EF6;&#x7F13;&#x5B58;" class="anchor-navigation-ex-anchor" href="#&#x6587;&#x4EF6;&#x7F13;&#x5B58;"><i class="fa fa-link" aria-hidden="true"></i></a>8.3. &#x6587;&#x4EF6;&#x7F13;&#x5B58;</h2>
<pre class="language-"><code>/proc/sys/vm/dirty_background_bytes
/proc/sys/vm/dirty_background_ratio
/proc/sys/vm/dirty_bytes
/proc/sys/vm/dirty_ratio
/proc/sys/vm/dirty_expire_centisecs
/proc/sys/vm/drop_caches
</code></pre><h1 id="cpu&#x5360;&#x7528;&#x7387;&#x5206;&#x6790;"><a name="cpu&#x5360;&#x7528;&#x7387;&#x5206;&#x6790;" class="anchor-navigation-ex-anchor" href="#cpu&#x5360;&#x7528;&#x7387;&#x5206;&#x6790;"><i class="fa fa-link" aria-hidden="true"></i></a>9. CPU&#x5360;&#x7528;&#x7387;&#x5206;&#x6790;</h1>
<p>&#x4E0B;&#x9762;&#x7684;&#x6570;&#x636E;&#x5168;&#x90E8;&#x90FD;&#x662F;&#x4ECE;proc&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x91CC;&#x8BFB;&#x51FA;&#x6765;&#x7684;.</p>
<h2 id="per-cpu&#x7EDF;&#x8BA1;-user--sys--softirq--idle--iowait--100"><a name="per-cpu&#x7EDF;&#x8BA1;-user--sys--softirq--idle--iowait--100" class="anchor-navigation-ex-anchor" href="#per-cpu&#x7EDF;&#x8BA1;-user--sys--softirq--idle--iowait--100"><i class="fa fa-link" aria-hidden="true"></i></a>9.1. per CPU&#x7EDF;&#x8BA1; user + sys + softirq + idle + iowait = 100</h2>
<p><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829145654.png" alt=""><br>&#x770B;&#x5230;&#x56FE;&#x4E2D;core1&#x7684;&#x8FD9;&#x51E0;&#x4E2A;&#x503C;&#x52A0;&#x8D77;&#x6765;&#x662F;&#x7EDD;&#x5BF9;&#x7684;100
core0&#x4E5F;&#x4E00;&#x6837;, &#x7EDD;&#x5BF9;&#x7684;100</p>
<h2 id="softirq&#x73B0;&#x8C61;"><a name="softirq&#x73B0;&#x8C61;" class="anchor-navigation-ex-anchor" href="#softirq&#x73B0;&#x8C61;"><i class="fa fa-link" aria-hidden="true"></i></a>9.2. softirq&#x73B0;&#x8C61;</h2>
<p>&#x7CFB;&#x7EDF;&#x5728;&#x6253;&#x6D41;&#x7684;&#x65F6;&#x5019;, &#x5927;&#x7EA6;&#x6BCF;2&#x5206;&#x949F;&#x5C31;&#x6709;10&#x79D2;&#x7684;&#x51B2;&#x9AD8;, 2&#x4E2A;&#x6838;&#x52A0;&#x8D77;&#x6765;&#x521A;&#x597D;100.<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829145733.png" alt="">  </p>
<p>&#x4ECE;&#x4E0A;&#x9762;&#x7684;&#x56FE;&#x770B;, &#x5728;softirq&#x9AD8;&#x7684;&#x65F6;&#x5019;, &#x6709;100&#x7684;CPU&#x5360;&#x7528;. &#x6309;&#x7406;&#x8BF4;2&#x6838;&#x7684;CPU&#x5171;200, &#x90A3;&#x4E48;&#x5E94;&#x8BE5;&#x53EA;&#x5269;&#x4E0B;100&#x7684;CPU&#x4E86;. &#x4E5F;&#x5C31;&#x662F;&#x8BF4;, &#x5982;&#x679C;softirq&#x4E5F;&#x7B97;&#x662F;&quot;&#x72EC;&#x7ACB;&quot;&#x7684;&#x7EDF;&#x8BA1;&#x7684;&#x8BDD;, &#x6309;&#x8FDB;&#x7A0B;&#x7684;&#x53E0;&#x52A0;&#x4E0D;&#x5E94;&#x8BE5;&#x8D85;&#x8FC7;&#x5269;&#x4E0B;&#x7684;100. &#x662F;&#x5417;?</p>
<p>&#x4E0D;&#x662F;. &#x89C1;&#x4E0B;&#x56FE;: &#x5728;&#x84DD;&#x8272;&#x5C16;&#x5CF0;&#x7684;&#x65F6;&#x5019;, &#x6309;&#x8FDB;&#x7A0B;&#x7684;&#x7EDF;&#x8BA1;&#x5DF2;&#x7ECF;&#x8D85;&#x8FC7;&#x4E86;150.<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829145803.png" alt="">  </p>
<h2 id="&#x7ED3;&#x8BBA;_1"><a name="&#x7ED3;&#x8BBA;_1" class="anchor-navigation-ex-anchor" href="#&#x7ED3;&#x8BBA;_1"><i class="fa fa-link" aria-hidden="true"></i></a>9.3. &#x7ED3;&#x8BBA;</h2>
<ul>
<li>&#x6309;CPU&#x89C6;&#x89D2;&#x6765;&#x7EDF;&#x8BA1;, softirq&#x662F;&#x72EC;&#x7ACB;&#x7684;</li>
<li>&#x6309;&#x8FDB;&#x7A0B;&#x89C6;&#x89D2;&#x6765;&#x7EDF;&#x8BA1;, softirq&#x88AB;&#x7EDF;&#x8BA1;&#x8FDB;&#x4E86;sys. &#x56E0;&#x4E3A;proc&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x53EA;&#x63D0;&#x4F9B;user&#x548C;sys&#x7684;&#x5360;&#x7528;, &#x76EE;&#x524D;&#x6211;&#x7684;&#x7ED3;&#x8BBA;&#x662F;softirq&#x5728;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;&#x5360;&#x6BD4;(&#x6216;&#x8005;&#x8BF4;&quot;&#x62A2;&#x5360;&#x4E86;&quot;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;&#x5360;&#x6BD4;)&#x4F1A;&#x88AB;&#x52A0;&#x5230;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;sys&#x5360;&#x6BD4;&#x4E2D;.</li>
<li>&#x5F53;softirq&#x9AD8;&#x53D1;&#x751F;&#x65F6;, &#x901A;&#x5E38;&#x90FD;&#x662F;burst&#x7684;&#x7F51;&#x7EDC;&#x62A5;&#x6587;&#x7684;&#x5904;&#x7406;&#x5BFC;&#x81F4;&#x7684;. &#x5982;&#x679C;&#x53EA;&#x770B;&#x8FDB;&#x7A0B;&#x7684;CPU&#x5360;&#x7528;, &#x8981;&#x6CE8;&#x610F;&#x91CC;&#x9762;&#x5DF2;&#x7ECF;&#x5305;&#x62EC;&#x4E86;softirq&#x7684;&#x5360;&#x7528;.</li>
</ul>
<h2 id="&#x8865;&#x5145;_1"><a name="&#x8865;&#x5145;_1" class="anchor-navigation-ex-anchor" href="#&#x8865;&#x5145;_1"><i class="fa fa-link" aria-hidden="true"></i></a>9.4. &#x8865;&#x5145;</h2>
<p><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829145838.png" alt=""><br>&#x4E0A;&#x56FE;&#x663E;&#x793A;&#x4E86;cpu1&#x7684;softirq + idle + system + irq + user = 100<br>&#x6CE8;&#x610F;softirq&#x548C;irq&#x4E0D;&#x662F;&#x4E00;&#x4E2A;.<br>&#x6709;&#x4E2A;&#x8FDB;&#x7A0B;ksoftirqd&#x4E5F;&#x5360;&#x4E86;&#x5341;&#x51E0;&#x4E2A;&#x70B9;&#x7684;CPU. &#x5982;&#x679C;&#x628A;&#x5B83;&#x52A0;&#x5230;sys&#x7C7B;&#x91CC;, &#x5C31;&#x8D85;&#x4E86;100.<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829145920.png" alt=""><br>&#x53C8;&#x56E0;&#x4E3A;CPU1&#x7684;system + user&#x90FD;&#x53EA;&#x6709;&#x4E0D;&#x5230;5&#x4E2A;&#x70B9;, &#x6240;&#x4EE5;ksoftirqd&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x7684;&#x65F6;&#x95F4;&#x662F;&#x7B97;&#x5728;softirq&#x91CC;&#x9762;&#x7684;.<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829145943.png" alt="">  </p>
<h1 id="&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;&#x5417;"><a name="&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;&#x5417;" class="anchor-navigation-ex-anchor" href="#&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;&#x5417;"><i class="fa fa-link" aria-hidden="true"></i></a>10. &#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;&#x5417;?</h1>
<p>&#x4E0D;&#x662F;.
&#x867D;&#x7136;&#x5185;&#x6838;&#x4F1A;&#x5728;&#x8FD4;&#x56DE;&#x5230;&#x7528;&#x6237;&#x6001;&#x4E4B;&#x524D;, &#x68C0;&#x67E5;&#x662F;&#x5426;&#x8C03;&#x5EA6;, &#x4F46;&#x662F;&#x6709;&#x6761;&#x4EF6;&#x7684;:
&#x5B83;&#x68C0;&#x67E5;&#x4EFB;&#x52A1;&#x63CF;&#x8FF0;&#x7B26;&#x91CC;<code>need_resched</code>&#x5B57;&#x6BB5;&#x4EE5;&#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x8C03;&#x5EA6;.
&#x8FD9;&#x4E2A;&#x5B57;&#x6BB5;&#x5728;&#x8FDB;&#x7A0B;&#x65F6;&#x95F4;&#x7247;&#x7528;&#x5C3D;&#x7684;&#x65F6;&#x5019;, &#x7531;&#x51FD;&#x6570;<code>scheduler_tick()</code>&#x6765;&#x7F6E;&#x4F4D;, &#x6216;&#x8005;&#x662F;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#x4EFB;&#x52A1;&#x6765;&#x7684;&#x65F6;&#x5019;, &#x4E5F;&#x8981;&#x7F6E;&#x4F4D;&#x8FD9;&#x4E2A;flag.</p>
<h2 id="preemption-and-context-switching"><a name="preemption-and-context-switching" class="anchor-navigation-ex-anchor" href="#preemption-and-context-switching"><i class="fa fa-link" aria-hidden="true"></i></a>10.1. Preemption and Context Switching</h2>
<p>Context switching, the switching from one runnable task to another, is handled by the context_switch() function defined in kernel/sched.c. It is called by schedule() when a new process has been selected to run. It does two basic jobs:</p>
<p>Calls switch_mm(), which is defined in include/asm/mmu_context.h, to switch the virtual memory mapping from the previous process&apos;s to that of the new process.</p>
<p>Calls switch_to(), defined in include/asm/system.h, to switch the processor state from the previous process&apos;s to the current&apos;s. This involves saving and restoring stack information and the processor registers.</p>
<p>The kernel, however, must know when to call schedule(). If it only called schedule() when code explicitly did so, user-space programs could run indefinitely. Instead, the kernel provides the need_resched flag to signify whether a reschedule should be performed (See Table 3.2). This flag is set by scheduler_tick() when a process runs out of timeslice and by try_to_wake_up() when a process that has a higher priority than the currently running process is awakened. The kernel will check the flag, see that it is set, and call schedule() to switch to a new process. The flag is a message to the kernel that the scheduler should be invoked as soon as possible because another process deserves to run.</p>
<p>Functions for Accessing and Manipulating need_resched</p>
<table>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>set_tsk_need_resched(task)</td>
<td>Set the need_resched flag in the given process</td>
</tr>
<tr>
<td>clear_tsk_need_resched(task)</td>
<td>Clear the need_resched flag in the given process</td>
</tr>
<tr>
<td>need_resched()</td>
<td>Test the value of the need_resched flag; return true if set and false otherwise</td>
</tr>
</tbody>
</table>
<p>Upon returning to user-space or returning from an interrupt, the need_resched flag is checked. If it is set, the kernel invokes the scheduler before continuing.</p>
<p>The flag is per-process, and not simply global, because it is faster to access a value in the process descriptor (because of the speed of current and because it might be in a cache line) than a global variable. Historically, the flag was global before the 2.2 kernel. In 2.2 and 2.4, the flag was an int inside the task_struct. In 2.6, it was moved into a single bit of a special flag variable inside the thread_info structure. As you can see, the kernel developers are never satisfied.</p>
<h2 id="user-preemption"><a name="user-preemption" class="anchor-navigation-ex-anchor" href="#user-preemption"><i class="fa fa-link" aria-hidden="true"></i></a>10.2. User Preemption</h2>
<p>User preemption occurs when the kernel is about to return to user-space, need_resched is set, and therefore, the scheduler is invoked. If the kernel is returning to user-space, it knows it is in a safe quiescent state. In other words, if it is safe to continue executing the current task, it is also safe to pick a new task to execute. Consequently, whenever the kernel is preparing to return to user-space, either on return from an interrupt or after a system call, the value of need_resched is checked. If it is set, the scheduler is invoked to select a new (more fit) process to execute. Both the return paths for return from interrupt and return from system call are architecture-dependent and typically implemented in assembly in entry.S (which, aside from kernel entry code, also contains kernel exit code).</p>
<p>In short, user preemption can occur</p>
<ul>
<li>When returning to user-space from a system call</li>
<li>When returning to user-space from an interrupt handler</li>
</ul>
<h2 id="kernel-preemption"><a name="kernel-preemption" class="anchor-navigation-ex-anchor" href="#kernel-preemption"><i class="fa fa-link" aria-hidden="true"></i></a>10.3. Kernel Preemption</h2>
<p>The Linux kernel, unlike most other Unix variants and many other operating systems, is a fully preemptive kernel. In non-preemptive kernels, kernel code runs until completion. That is, the scheduler is not capable of rescheduling a task while it is in the kernel&#x2014;kernel code is scheduled cooperatively, not preemptively. Kernel code runs until it finishes (returns to user-space) or explicitly blocks. In the 2.6 kernel, however, the Linux kernel became preemptive; it is now possible to preempt a task at any point, so long as the kernel is in a state in which it is safe to reschedule.</p>
<p>So when is it safe to reschedule? The kernel is capable of preempting a task running in the kernel so long as it does not hold a lock. That is, locks are used as markers of regions of non-preemptibility. Because the kernel is SMP-safe, if a lock is not held, the current code is reentrant and capable of being preempted.</p>
<p>The first change in supporting kernel preemption was the addition of a preemption counter, preempt_count, to each process&apos;s task_struct. This counter begins at zero and increments for each lock that is acquired and decrements for each lock that is released. When the counter is zero, the kernel is preemptible. Upon return from interrupt, if returning to kernel-space, the kernel checks the values of need_resched and preempt_count. If need_resched is set and preempt_count is zero, then a more important task is runnable and it is safe to preempt. Thus, the scheduler is invoked. If preempt_count is nonzero, a lock is held and it is unsafe to reschedule. In that case, the interrupt returns as usual to the currently executing task. When all the locks that the current task is holding are released, preempt_count returns to zero. At that time, the unlock code checks if need_resched is set. If so, the scheduler will be invoked. Enabling and disabling kernel preemption is sometimes required in kernel code and will be discussed in Chapter 8.</p>
<p>Kernel preemption can also occur explicitly, when a task in the kernel blocks or explicitly calls schedule(). This form of kernel preemption has always been supported because no additional logic is required to ensure the kernel is in a state that is safe to preempt. It is assumed that the code that explicitly calls schedule() knows it is safe to reschedule.</p>
<p>Kernel preemption can occur</p>
<ul>
<li>When returning to kernel-space from an interrupt handler</li>
<li>When kernel code becomes preemptible again</li>
<li>If a task in the kernel explicitly calls schedule()</li>
<li>If a task in the kernel blocks (which results in a call to schedule())</li>
</ul>
<h2 id="&#x8C03;&#x5EA6;&#x4EE3;&#x7801;"><a name="&#x8C03;&#x5EA6;&#x4EE3;&#x7801;" class="anchor-navigation-ex-anchor" href="#&#x8C03;&#x5EA6;&#x4EE3;&#x7801;"><i class="fa fa-link" aria-hidden="true"></i></a>10.4. &#x8C03;&#x5EA6;&#x4EE3;&#x7801;</h2>
<p>&#x8C03;&#x5EA6;&#x53D1;&#x751F;&#x65F6;, <code>schedule()</code>&#x8C03;&#x7528;<code>context_switch()</code>&#x5B8C;&#x6210;&#x8C03;&#x5EA6;</p>
<h2 id="&#x4E00;&#x4E9B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;-&#x53EF;&#x80FD;&#x4F1A;&#x963B;&#x585E;-&#x6B64;&#x65F6;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;"><a name="&#x4E00;&#x4E9B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;-&#x53EF;&#x80FD;&#x4F1A;&#x963B;&#x585E;-&#x6B64;&#x65F6;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;" class="anchor-navigation-ex-anchor" href="#&#x4E00;&#x4E9B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;-&#x53EF;&#x80FD;&#x4F1A;&#x963B;&#x585E;-&#x6B64;&#x65F6;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;"><i class="fa fa-link" aria-hidden="true"></i></a>10.5. &#x4E00;&#x4E9B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;, &#x53EF;&#x80FD;&#x4F1A;&#x963B;&#x585E;, &#x6B64;&#x65F6;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;</h2>
<p>&#x57FA;&#x672C;&#x4E0A;&#x5927;&#x90E8;&#x5206;IO&#x76F8;&#x5173;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x53EF;&#x80FD;&#x963B;&#x585E;, &#x6BD4;&#x5982; open() read() write()&#x7B49;.
<a href="https://techpubs.jurassic.nl/manuals/0650/developer/Debugger_Ref/sgi_html/ch10.html" target="_blank">&#x8FD9;&#x91CC;</a>&#x5217;&#x51FA;&#x4E86;&#x5E38;&#x89C1;&#x7684;&#x53EF;&#x80FD;&#x963B;&#x585E;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</p>
<h2 id="&#x8C03;&#x5EA6;&#x5668;&#x7684;&#x53C2;&#x8003;&#x6587;&#x7AE0;"><a name="&#x8C03;&#x5EA6;&#x5668;&#x7684;&#x53C2;&#x8003;&#x6587;&#x7AE0;" class="anchor-navigation-ex-anchor" href="#&#x8C03;&#x5EA6;&#x5668;&#x7684;&#x53C2;&#x8003;&#x6587;&#x7AE0;"><i class="fa fa-link" aria-hidden="true"></i></a>10.6. &#x8C03;&#x5EA6;&#x5668;&#x7684;&#x53C2;&#x8003;&#x6587;&#x7AE0;</h2>
<p><a href="https://www.cs.montana.edu/~chandrima.sarkar/AdvancedOS/SchedulingLinux/index.html" target="_blank">https://www.cs.montana.edu/~chandrima.sarkar/AdvancedOS/SchedulingLinux/index.html</a>
<a href="https://www.cs.columbia.edu/~smb/classes/s06-4118/l13.pdf" target="_blank">https://www.cs.columbia.edu/~smb/classes/s06-4118/l13.pdf</a>
<a href="http://lass.cs.umass.edu/~shenoy/courses/spring20/lectures/Lec09.pdf" target="_blank">http://lass.cs.umass.edu/~shenoy/courses/spring20/lectures/Lec09.pdf</a>
<a href="https://medium.com/@bundetcom/understanding-linux-scheduler-5c683ff482d0" target="_blank">https://medium.com/@bundetcom/understanding-linux-scheduler-5c683ff482d0</a></p>
<h1 id="signal&#x7684;&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;&#x548C;&#x6253;&#x65AD;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><a name="signal&#x7684;&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;&#x548C;&#x6253;&#x65AD;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;" class="anchor-navigation-ex-anchor" href="#signal&#x7684;&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;&#x548C;&#x6253;&#x65AD;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><i class="fa fa-link" aria-hidden="true"></i></a>11. signal&#x7684;&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;&#x548C;&#x6253;&#x65AD;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</h1>
<p><code>man 7 signal</code></p>
<h2 id="&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;"><a name="&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;" class="anchor-navigation-ex-anchor" href="#&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;"><i class="fa fa-link" aria-hidden="true"></i></a>11.1. &#x9ED8;&#x8BA4;&#x884C;&#x4E3A;</h2>
<pre class="language-"><code>       Signal     Value     Action   Comment
       &#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;
       SIGHUP        1       Term    Hangup detected on controlling terminal
                                     or death of controlling process
       SIGINT        2       Term    Interrupt from keyboard
       SIGQUIT       3       Core    Quit from keyboard
       SIGILL        4       Core    Illegal Instruction
       SIGABRT       6       Core    Abort signal from abort(3)
       SIGFPE        8       Core    Floating-point exception
       SIGKILL       9       Term    Kill signal
       SIGSEGV      11       Core    Invalid memory reference
       SIGPIPE      13       Term    Broken pipe: write to pipe with no
                                     readers; see pipe(7)
       SIGALRM      14       Term    Timer signal from alarm(2)
       SIGTERM      15       Term    Termination signal
       SIGUSR1   30,10,16    Term    User-defined signal 1
       SIGUSR2   31,12,17    Term    User-defined signal 2
       SIGCHLD   20,17,18    Ign     Child stopped or terminated
       SIGCONT   19,18,25    Cont    Continue if stopped
       SIGSTOP   17,19,23    Stop    Stop process
       SIGTSTP   18,20,24    Stop    Stop typed at terminal
       SIGTTIN   21,21,26    Stop    Terminal input for background process
       SIGTTOU   22,22,27    Stop    Terminal output for background process
</code></pre><p>&#x6CE8;:</p>
<ul>
<li>&#x6709;&#x7684;signal&#x662F;&#x53D1;&#x7ED9;&#x6574;&#x4E2A;group&#x7684;, &#x6BD4;&#x5982;SIGINT, &#x4F1A;&#x53D1;&#x7ED9;&#x6574;&#x4E2A;PGRP, &#x4E5F;&#x5C31;&#x662F;&#x8BF4;, &#x5982;&#x679C;&#x4E00;&#x4E2A;&#x524D;&#x53F0;&#x7236;&#x8FDB;&#x7A0B;A&#x8D77;&#x4E86;&#x5B50;&#x8FDB;&#x7A0B;B, &#x90A3;&#x4E48;&#x5728;&#x524D;&#x53F0;Ctrl+C&#x6389;&#x8FDB;&#x7A0B;A, &#x90A3;&#x4E48;&#x9664;&#x4E86;&#x8FDB;&#x7A0B;A&#x4F1A;&#x6536;&#x5230;SIGINT, &#x8FDB;&#x7A0B;B&#x4E5F;&#x4F1A;&#x6536;&#x5230;SIGINT</li>
<li>&#x4F46;&#x5982;&#x679C;&#x662F;&#x7528;kill&#x547D;&#x4EE4;, &#x6BD4;&#x5982;<code>kill -SIGINT &#x8FDB;&#x7A0B;A</code>, &#x90A3;&#x4E48;&#x53EA;&#x6709;&#x8FDB;&#x7A0B;A&#x4F1A;&#x6536;&#x5230;SIGINT, &#x5176;&#x5B50;&#x8FDB;&#x7A0B;B&#x4E0D;&#x4F1A;&#x6536;&#x5230;SIGINT. &#x8FDB;&#x7A0B;A&#x7684;&#x9000;&#x51FA;&#x4E5F;&#x4E0D;&#x4F1A;&#x5BFC;&#x81F4;&#x5176;&#x5B50;&#x8FDB;&#x7A0B;B&#x9000;&#x51FA;</li>
<li>&#x7528;setpgid &#x6216; setsid&#x6765;&#x6539;&#x53D8;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x8FDB;&#x7A0B;&#x7EC4;, &#x53EF;&#x4EE5;&#x907F;&#x514D;&#x5B50;&#x8FDB;&#x7A0B;&#x6536;&#x5230;&#x524D;&#x53F0;&#x7684;SIGINT 
&#x8BE6;&#x89C1;<a href="https://stackoverflow.com/questions/6803395/child-process-receives-parents-sigint" target="_blank">https://stackoverflow.com/questions/6803395/child-process-receives-parents-sigint</a></li>
</ul>
<h2 id="signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><a name="signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;" class="anchor-navigation-ex-anchor" href="#signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><i class="fa fa-link" aria-hidden="true"></i></a>11.2. signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</h2>
<p>signal&#x6253;&#x65AD;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x884C;&#x4E3A;&#x6709;&#x51E0;&#x79CD;, &#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x7C7B;&#x578B;&#x4EE5;&#x53CA;&#x6CE8;&#x518C;sigaction&#x7684;&#x65F6;&#x5019;&#x6709;&#x6CA1;&#x6709;SA_RESTART&#x6807;&#x8BB0;&#x6709;&#x5173;</p>
<ul>
<li>&#x4E0B;&#x9762;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;, &#x5982;&#x679C;&#x6709;SA_RESTART&#x6807;&#x8BB0;&#x4E00;&#x822C;&#x4F1A;&#x88AB;&#x5185;&#x6838;&#x81EA;&#x52A8;&#x91CD;&#x65B0;&#x542F;&#x52A8;&#x8FD9;&#x4E2A;&#x8C03;&#x7528;. &#x5426;&#x5219;&#x8FD4;&#x56DE;error EINTR</li>
</ul>
<pre class="language-"><code>       * read(2),  readv(2),  write(2),  writev(2),  and ioctl(2) calls on &quot;slow&quot; devices.  A &quot;slow&quot; device is one where the I/O call may block for an indefinite time, for example, a
         terminal, pipe, or socket.  If an I/O call on a slow device has already transferred some data by the time it is interrupted by a signal handler, then the call will return  a
         success  status  (normally, the number of bytes transferred).  Note that a (local) disk is not a slow device according to this definition; I/O operations on disk devices are
         not interrupted by signals.

       * open(2), if it can block (e.g., when opening a FIFO; see fifo(7)).

       * wait(2), wait3(2), wait4(2), waitid(2), and waitpid(2).

       * Socket interfaces: accept(2), connect(2), recv(2), recvfrom(2), recvmmsg(2), recvmsg(2), send(2), sendto(2), and sendmsg(2), unless a timeout has been set on the socket (see
         below).

       * File locking interfaces: flock(2) and the F_SETLKW and F_OFD_SETLKW operations of fcntl(2)

       * POSIX message queue interfaces: mq_receive(3), mq_timedreceive(3), mq_send(3), and mq_timedsend(3).

       * futex(2) FUTEX_WAIT (since Linux 2.6.22; beforehand, always failed with EINTR).

       * getrandom(2).

       * pthread_mutex_lock(3), pthread_cond_wait(3), and related APIs.

       * futex(2) FUTEX_WAIT_BITSET.

       * POSIX semaphore interfaces: sem_wait(3) and sem_timedwait(3) (since Linux 2.6.22; beforehand, always failed with EINTR).

       * read(2) from an inotify(7) file descriptor (since Linux 3.8; beforehand, always failed with EINTR).
</code></pre><ul>
<li>&#x4E0B;&#x9762;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;EINTR, &#x4E0D;&#x7BA1;&#x662F;&#x5426;&#x6709;SA_RESTART</li>
</ul>
<pre class="language-"><code>       * &quot;Input&quot; socket interfaces, when a timeout (SO_RCVTIMEO) has been set on the socket using setsockopt(2): accept(2), recv(2), recvfrom(2), recvmmsg(2) (also  with  a  non-NULL
         timeout argument), and recvmsg(2).

       * &quot;Output&quot; socket interfaces, when a timeout (SO_RCVTIMEO) has been set on the socket using setsockopt(2): connect(2), send(2), sendto(2), and sendmsg(2).

       * Interfaces used to wait for signals: pause(2), sigsuspend(2), sigtimedwait(2), and sigwaitinfo(2).

       * File descriptor multiplexing interfaces: epoll_wait(2), epoll_pwait(2), poll(2), ppoll(2), select(2), and pselect(2).

       * System V IPC interfaces: msgrcv(2), msgsnd(2), semop(2), and semtimedop(2).

       * Sleep interfaces: clock_nanosleep(2), nanosleep(2), and usleep(3).

       * io_getevents(2).
</code></pre><h1 id="&#x5185;&#x6838;&#x6536;&#x62A5;&#x6587;&#x7684;&#x65F6;&#x95F4;&#x7247;&#x7B97;&#x5728;&#x54EA;&#x91CC;"><a name="&#x5185;&#x6838;&#x6536;&#x62A5;&#x6587;&#x7684;&#x65F6;&#x95F4;&#x7247;&#x7B97;&#x5728;&#x54EA;&#x91CC;" class="anchor-navigation-ex-anchor" href="#&#x5185;&#x6838;&#x6536;&#x62A5;&#x6587;&#x7684;&#x65F6;&#x95F4;&#x7247;&#x7B97;&#x5728;&#x54EA;&#x91CC;"><i class="fa fa-link" aria-hidden="true"></i></a>12. &#x5185;&#x6838;&#x6536;&#x62A5;&#x6587;&#x7684;&#x65F6;&#x95F4;&#x7247;&#x7B97;&#x5728;&#x54EA;&#x91CC;?</h1>
<h2 id="&#x80CC;&#x666F;-&#x9A71;&#x52A8;&#x4E2D;&#x65AD;&#x5728;&#x54EA;&#x91CC;&#x6267;&#x884C;"><a name="&#x80CC;&#x666F;-&#x9A71;&#x52A8;&#x4E2D;&#x65AD;&#x5728;&#x54EA;&#x91CC;&#x6267;&#x884C;" class="anchor-navigation-ex-anchor" href="#&#x80CC;&#x666F;-&#x9A71;&#x52A8;&#x4E2D;&#x65AD;&#x5728;&#x54EA;&#x91CC;&#x6267;&#x884C;"><i class="fa fa-link" aria-hidden="true"></i></a>12.1. &#x80CC;&#x666F;: &#x9A71;&#x52A8;&#x4E2D;&#x65AD;&#x5728;&#x54EA;&#x91CC;&#x6267;&#x884C;?</h2>
<p>&#x9A71;&#x52A8;&#x6536;&#x62A5;&#x8981;&#x6CE8;&#x518C;irq handler, &#x4E00;&#x822C;&#x7684;, &#x4F7F;&#x7528;:</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">int</span> <span class="token function">request_threaded_irq</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token class-name">irq_handler_t</span> handler<span class="token punctuation">,</span> <span class="token class-name">irq_handler_t</span> thread_fn<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> irqflags<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>devname<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span>
</code></pre>
<p>&#x5176;&#x4E2D;:
<code>handler</code>: &#x5728;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;&#x6267;&#x884C;
<code>thread_fn</code>: &#x4E0D;&#x4E3A;NULL&#x5C31;&#x4F1A;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x5185;&#x6838;&#x7EBF;&#x7A0B;<code>&quot;irq/%irq-%irq_name&quot;</code>&#x6765;&#x5904;&#x7406;&#x4E2D;&#x65AD;&#x4E0B;&#x534A;&#x90E8;.</p>
<p>&#x5F53;kernel&#x542F;&#x52A8;&#x53C2;&#x6570;&#x5305;&#x62EC;<code>threadirqs</code>&#x65F6;, &#x5373;&#x4F7F;<code>thread_fn</code>&#x4E3A;null, &#x4E5F;&#x4F1A;&#x5F3A;&#x5236;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x5185;&#x6838;&#x7EBF;&#x7A0B;, &#x5728;&#x8BE5;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x5185;&#x5904;&#x7406;&#x4E2D;&#x65AD;. <code>threadirqs</code>&#x53EA;&#x6709;&#x5728;<code>CONFIG_IRQ_FORCED_THREADING=y</code>&#x7684;&#x65F6;&#x5019;&#x624D;&#x751F;&#x6548;.</p>
<p>&#x5728;&#x677F;&#x5B50;&#x4E0A;&#x5B9E;&#x9A8C;, &#x4E0D;&#x52A0;<code>threadirqs</code>, fglt-b&#x4E0A;&#x6CA1;&#x6709;<code>irq/xxx</code>&#x7B49;&#x8FDB;&#x7A0B;. &#x52A0;&#x4E86;<code>threadirqs</code>, &#x591A;&#x4E86;&#x5341;&#x51E0;&#x4E2A;<code>irq/xxx</code>&#x8FDB;&#x7A0B;, &#x6BCF;&#x4E2A;&#x4E2D;&#x65AD;&#x4E00;&#x4E2A;.</p>
<p>&#x4E00;&#x822C;&#x7684;&#x7CFB;&#x7EDF;&#x4E0D;&#x4F1A;&#x914D;&#x7F6E;<code>threadirqs</code>&#x5F3A;&#x5236;&#x628A;&#x4E2D;&#x65AD;&#x7EBF;&#x7A0B;&#x5316;.
&#x6240;&#x4EE5;, &#x6839;&#x636E;&#x9A71;&#x52A8;&#x4E2D;&#x65AD;&#x6CE8;&#x518C;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;<code>request_threaded_irq()</code>&#x662F;&#x5426;&#x6709;<code>thread_fn</code>, &#x51B3;&#x5B9A;&#x4E2D;&#x65AD;&#x662F;&#x5728;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x8FD8;&#x662F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;</p>
<h2 id="&#x4E2D;&#x65AD;&#x7EBF;&#x7A0B;&#x5316;&#x540E;&#x7684;cpu-load"><a name="&#x4E2D;&#x65AD;&#x7EBF;&#x7A0B;&#x5316;&#x540E;&#x7684;cpu-load" class="anchor-navigation-ex-anchor" href="#&#x4E2D;&#x65AD;&#x7EBF;&#x7A0B;&#x5316;&#x540E;&#x7684;cpu-load"><i class="fa fa-link" aria-hidden="true"></i></a>12.2. &#x4E2D;&#x65AD;&#x7EBF;&#x7A0B;&#x5316;&#x540E;&#x7684;CPU load</h2>
<p>&#x4E0B;&#x9762;&#x662F;&#x6253;&#x5F00;<code>threadirqs</code>&#x540E;, <code>irq/24-eth0</code>&#x5C31;&#x662F;&#x677F;&#x5B50;eth0&#x7F51;&#x53E3;&#x6536;&#x62A5;&#x7684;&#x4E2D;&#x65AD;&#x88AB;&#x5F3A;&#x5236;&#x7EBF;&#x7A0B;&#x5316;&#x540E;&#x7684;&#x7EBF;&#x7A0B;&#x540D;.
&#x53EF;&#x4EE5;&#x770B;&#x5230;, &#x5728;&#x6253;&#x6D41;&#x7684;&#x65F6;&#x5019;, &#x8FD9;&#x4E2A;&#x7EBF;&#x7A0B;load&#x633A;&#x9AD8;&#x7684;.<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829150203.png" alt="">  </p>
<p>&#x9ED8;&#x8BA4;&#x7684;eth0&#x9A71;&#x52A8;&#x5E76;&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x7EBF;&#x7A0B;&#x5316;&#x4E2D;&#x65AD;, &#x8FD9;&#x91CC;&#x9762;&#x5927;&#x6982;15%&#x7684;CPU load&#x53EF;&#x80FD;&#x88AB;&#x5747;&#x644A;&#x5230;&#x5176;&#x4ED6;&#x8FDB;&#x7A0B;&#x4E2D;(&#x770B;&#x8D77;&#x6765;&#x662F;&#x7684;).
&#x6253;1000/2000/4000/6000pps &#x4E0A;&#x884C;dhcpv4 discovery</p>
<p>&#x6253;&#x5F00;threadirqs&#x529F;&#x80FD;:topid: <a href="http://10.182.105.138:9888/switchPerf/152917918" target="_blank">http://10.182.105.138:9888/switchPerf/152917918</a><br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829150229.png" alt="">  </p>
<p>&#x5173;&#x95ED;threadirqs&#x529F;&#x80FD;:topid&#xFF1A;<a href="http://10.182.105.138:9888/fgltb_dhcpv4/3501403790" target="_blank">http://10.182.105.138:9888/fgltb_dhcpv4/3501403790</a><br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829150248.png" alt="">  </p>
<p>&#x5BF9;&#x6BD4;&#x4E24;&#x7EC4;&#x6570;&#x636E;, &#x57FA;&#x672C;&#x4E0A;&#x53EF;&#x4EE5;&#x5F97;&#x5230;, &#x6BCF;&#x4E2A;app&#x7684;CPU load&#x91CC;, &#x90FD;&#x5305;&#x542B;&#x4E86;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x65F6;&#x95F4;, &#x6BD4;&#x8F83;&#x5747;&#x5300;, &#x5927;&#x6982;&#x90FD;&#x662F;&#x5728;2%&#x5DE6;&#x53F3;.
&#x4E2D;&#x65AD;&#x7EBF;&#x7A0B;&#x5316;&#x4E86;&#x4E4B;&#x540E;, &#x6BCF;&#x4E2A;app&#x7684;cpu&#x5360;&#x7528;&#x7EDF;&#x8BA1;&#x90FD;&#x7A0D;&#x5FAE;&#x964D;&#x4E86;&#x4E00;&#x70B9;, &#x8FD9;&#x4E9B;CPU&#x90FD;&#x88AB;&#x7B97;&#x5230;<code>irq/24-eth0</code>&#x4E0A;&#x4E86;.</p>
<p>&#x53E6;&#x5916;, &#x8FD9;&#x91CC;&#x9762;&#x6CA1;&#x6709;&#x770B;&#x5230;<code>ksoftirqd</code>&#x7B49;&#x8F6F;&#x4E2D;&#x65AD;&#x8FDB;&#x7A0B;, &#x8BF4;&#x660E;softirq&#x5927;&#x90E8;&#x5206;&#x90FD;&#x5728;&quot;&#x4E2D;&#x65AD;&quot;&#x4E2D;&#x5904;&#x7406;&#x4E86;.</p>
<h2 id="&#x5230;&#x5E95;&#x4EC0;&#x4E48;&#x662F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;"><a name="&#x5230;&#x5E95;&#x4EC0;&#x4E48;&#x662F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;" class="anchor-navigation-ex-anchor" href="#&#x5230;&#x5E95;&#x4EC0;&#x4E48;&#x662F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;"><i class="fa fa-link" aria-hidden="true"></i></a>12.3. &#x5230;&#x5E95;&#x4EC0;&#x4E48;&#x662F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;?</h2>
<blockquote>
<p>interrupt context : it specifies that the kernel is currently executing either an interrupt handler or a <strong>deferrable function</strong></p>
</blockquote>
<p>&#x6839;&#x636E;&#x4E0A;&#x9762;&#x7684;&#x5B9A;&#x4E49;, softirq&#x662F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;. &#x4ECE;&#x5C5E;&#x6027;&#x4E0A;&#x8BF4;, &#x662F;&#x7684;. &#x4F46;&#x4E25;&#x683C;&#x4ECE;CPU&#x89D2;&#x5EA6;&#x6765;&#x8BB2;, softirq&#x5E76;<strong>&#x4E0D;&#x603B;&#x662F;</strong>&#x5728;<strong>&#x786C;&#x4EF6;</strong>&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x6267;&#x884C;&#x7684;.</p>
<p>&#x4E0B;&#x6587;&#x4F1A;&#x8BB2;&#x5230;, softirq&#x5E76;&#x4E0D;&#x662F;&#x786C;&#x4EF6;&#x4E0A;&#x7684;&#x67D0;&#x79CD;&quot;&#x8F6F;&#x4EF6;&#x89E6;&#x53D1;&#x4E2D;&#x65AD;&quot;, &#x800C;&#x662F;kernel&#x7684;&#x4E00;&#x79CD;&#x5EF6;&#x8FDF;&#x6267;&#x884C;&#x7684;&#x673A;&#x5236;, &#x8FD9;&#x4E9B;&#x6267;&#x884C;&#x53EF;&#x80FD;&#x5728;<strong>&#x786C;&#x4EF6;&#x4E2D;&#x65AD;</strong>&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;, &#x4E5F;&#x53EF;&#x80FD;&#x662F;&#x5728;&#x666E;&#x901A;&#x7684;&#x5185;&#x6838;&#x6001;&#x4E0A;&#x4E0B;&#x6587;, &#x4F46;&#x5176;&#x73AF;&#x5883;&#x8FD8;&#x662F;&#x7C7B;&#x4F3C;&quot;&#x4E2D;&#x65AD;&quot;&#x73AF;&#x5883;&#x7684;, &#x6BD4;&#x5982;&#x62A2;&#x5360;&#x7EA7;&#x522B;&#x5F88;&#x9AD8;(&#x53EA;&#x80FD;&#x88AB;&#x786C;&#x4EF6;&#x4E2D;&#x65AD;&#x62A2;&#x5360;), &#x5355;&#x72EC;&#x7684;softirq&#x6808;&#x7B49;&#x7B49;.</p>
<h2 id="&#x8F6F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;"><a name="&#x8F6F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;" class="anchor-navigation-ex-anchor" href="#&#x8F6F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;"><i class="fa fa-link" aria-hidden="true"></i></a>12.4. &#x8F6F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;</h2>
<p>&#x4E00;&#x822C;&#x786C;&#x4E2D;&#x65AD;&#x4F1A;&#x5173;&#x4E2D;&#x65AD;(&#x6BD4;&#x5982;&#x5173;&#x95ED;eth&#x7684;&#x4E2D;&#x65AD;), &#x800C;&#x8F6F;&#x4E2D;&#x65AD;&#x867D;&#x7136;&#x4E5F;&#x662F;&#x5728;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;&#x6267;&#x884C;(&#x8FD9;&#x70B9;&#x5E76;&#x4E0D;&#x662F;always true), &#x4F46;&#x8F6F;&#x4E2D;&#x65AD;&#x662F;&#x5728;&#x4F7F;&#x80FD;&#x4E2D;&#x65AD;&#x7684;&#x72B6;&#x6001;&#x4E0B;&#x6267;&#x884C;&#x7684;; &#x5E76;&#x4E14;, &#x8F6F;&#x4E2D;&#x65AD;&#x53EF;&#x4EE5;&#x591A;&#x6838;&#x540C;&#x65F6;&#x6267;&#x884C;.
<code>&lt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>&#x6DF1;&#x5165;&#x7406;&#x89E3;linux&#x5185;&#x6838;</span><span class="token punctuation">&gt;</span></span>&gt;</code>&#x4E2D;, &#x628A;&#x8F6F;&#x4E2D;&#x65AD;&#x548C;tasklet&#x53EB;&#x505A;&#x5EF6;&#x8FDF;&#x6267;&#x884C;. <a href="https://www.oreilly.com/library/view/understanding-the-linux/0596005652/ch04s07.html#:~:text=As%20a%20matter%20of%20fact,handler%20or%20a%20deferrable%20function." target="_blank">&#x539F;&#x6587;</a>
&#x5BF9;&#x786C;&#x4EF6;&#x4E2D;&#x65AD;&#x6765;&#x8BF4;, &#x662F;&#x5173;&#x4E2D;&#x65AD;&#x60C5;&#x51B5;&#x4E0B;&#x4E32;&#x884C;&#x6267;&#x884C;&#x7684;, &#x901F;&#x5EA6;&#x8D8A;&#x5FEB;&#x8D8A;&#x597D;.
softirq&#x548C;tasklet&#x548C;workqueue&#x5C31;&#x662F;&#x7528;&#x6765;&#x8DD1;&#x4E0B;&#x534A;&#x90E8;&#x7684;.</p>
<ul>
<li>softirq&#x548C;tasklet&#x53C8;&#x53EB;<code>deferrable functions</code></li>
<li>tasklet&#x662F;&#x57FA;&#x4E8E;softirq&#x7684;
&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x95EE;&#x7684;&#x610F;&#x601D;&#x662F;kernel&#x5728;&#x6267;&#x884C;interrupt handler, &#x6216;&#x8005;&#x5728;&#x6267;&#x884C;<code>deferrable functions</code>
mpstat&#x53EF;&#x4EE5;&#x770B;&#x8F6F;&#x4E2D;&#x65AD;&#x7EDF;&#x8BA1;, &#x5B9E;&#x9645;&#x4E0A;&#x4E5F;&#x662F;&#x4ECE;<code>/proc/softirqs</code>&#x5F97;&#x5230;&#x7684;&#x6570;&#x636E;
&#x4E0B;&#x9762;&#x662F;&#x4E2A;4&#x6838;A53&#x7684;ARM&#x677F;&#x5B50;&#x4E0A;&#x7684;&#x7EDF;&#x8BA1;</li>
</ul>
<pre class="language-"><code class="lang-sh">~ <span class="token comment"># mpstat -I SCPU</span>
Linux <span class="token number">4.9</span>.199-Arm-Cortex_a53 <span class="token punctuation">(</span>fglt-b<span class="token punctuation">)</span>   03/08/70        _aarch64_       <span class="token punctuation">(</span><span class="token number">4</span> CPU<span class="token punctuation">)</span>

01:47:49     CPU      HI/s   TIMER/s  NET_TX/s  NET_RX/s   BLOCK/s IRQ_POLL/s TASKLET/s  SCHED/s HRTIMER/s     RCU/s
01:47:49       <span class="token number">0</span>      <span class="token number">0.00</span>    <span class="token number">100.00</span>      <span class="token number">0.00</span>      <span class="token number">3.58</span>      <span class="token number">0.00</span>      <span class="token number">0.00</span>      <span class="token number">0.14</span>     <span class="token number">98.45</span>      <span class="token number">0.00</span>     <span class="token number">48.13</span>
01:47:49       <span class="token number">1</span>      <span class="token number">0.00</span>     <span class="token number">87.55</span>      <span class="token number">0.00</span>      <span class="token number">8.61</span>      <span class="token number">0.00</span>      <span class="token number">0.00</span>      <span class="token number">0.00</span>     <span class="token number">98.95</span>      <span class="token number">0.00</span>     <span class="token number">38.53</span>
01:47:49       <span class="token number">2</span>      <span class="token number">0.00</span>     <span class="token number">79.42</span>      <span class="token number">0.00</span>      <span class="token number">6.46</span>      <span class="token number">0.00</span>      <span class="token number">0.00</span>      <span class="token number">3.09</span>     <span class="token number">98.73</span>      <span class="token number">0.00</span>     <span class="token number">47.22</span>
01:47:49       <span class="token number">3</span>      <span class="token number">0.00</span>     <span class="token number">65.90</span>      <span class="token number">0.00</span>      <span class="token number">2.41</span>      <span class="token number">0.00</span>      <span class="token number">0.00</span>      <span class="token number">0.00</span>     <span class="token number">97.61</span>      <span class="token number">0.00</span>     <span class="token number">39.11</span>
</code></pre>
<ul>
<li>softirq&#x662F;&#x9759;&#x6001;&#x5206;&#x914D;&#x7684;</li>
<li>tasklet&#x53EF;&#x4EE5;&#x52A8;&#x6001;&#x5206;&#x914D;, &#x6BD4;&#x5982;&#x52A0;&#x8F7D;&#x4E00;&#x4E2A;&#x5185;&#x6838;&#x6A21;&#x5757;&#x65F6;</li>
<li>&#x540C;&#x7C7B;&#x578B;&#x7684;softirq&#x4E5F;&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x8FD0;&#x884C;&#x5728;&#x591A;&#x6838;&#x4E0A;, &#x5FC5;&#x987B;&#x53EF;&#x91CD;&#x5165;, &#x7528;&#x9501;&#x4FDD;&#x62A4;&#x5173;&#x952E;&#x533A;. </li>
<li>&#x540C;&#x7C7B;tasklet&#x540C;&#x65F6;&#x53EA;&#x80FD;&#x4E00;&#x4E2A;&#x6838;&#x8FD0;&#x884C;, &#x4E0D;&#x7528;&#x62C5;&#x5FC3;&#x7ADE;&#x4E89;&#x95EE;&#x9898;.</li>
</ul>
<p><code>deferrable functions</code>&#x5728;&#x4F7F;&#x7528;&#x4E0A;, &#x7C7B;&#x4F3C;&#x4E2D;&#x65AD;, &#x90FD;&#x6709;&#x5982;&#x4E0B;&#x64CD;&#x4F5C;:</p>
<ul>
<li>&#x521D;&#x59CB;&#x5316;(<em>Initialization</em>): &#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x5EF6;&#x8FDF;&#x51FD;&#x6570;, &#x4E00;&#x822C;&#x5728;kernel&#x521D;&#x59CB;&#x5316;&#x65F6;&#x5019;&#x786E;&#x5B9A;&#x6216;&#x8005;&#x5728;module load&#x7684;&#x65F6;&#x5019;&#x505A;</li>
<li>&#x6FC0;&#x6D3B;(<em>Activation</em>): &#x6807;&#x8BB0;&#x4E3A;pending, pending&#x7684;&#x5EF6;&#x8FDF;&#x51FD;&#x6570;&#x4F1A;&#x5728;&#x4E0B;&#x6B21;&#x8C03;&#x5EA6;&#x5230;&#x7684;&#x65F6;&#x5019;&#x6267;&#x884C;. &#x5728;&#x4E2D;&#x65AD;&#x91CC;&#x4E5F;&#x53EF;&#x4EE5;&#x6807;&#x8BB0;.</li>
<li>&#x5C4F;&#x853D;(<em>Masking</em>): &#x4E34;&#x65F6;&#x7981;&#x6B62;&#x6267;&#x884C;</li>
<li>&#x6267;&#x884C;(<em>Execution</em>): &#x6267;&#x884C;pending&#x7684;<code>deferrable functions</code>, &#x5982;&#x679C;pending&#x7684;&#x5F88;&#x591A;, &#x53EA;&#x6267;&#x884C;&#x9884;&#x5B9A;&#x4E49;&#x7684;&#x4E00;&#x90E8;&#x5206;.</li>
</ul>
<p>&#x6FC0;&#x6D3B;&#x548C;&#x6267;&#x884C;&#x64CD;&#x4F5C;&#x662F;&#x540C;&#x4E00;&#x4E2A;CPU, &#x8FD9;&#x4E48;&#x8BBE;&#x8BA1;&#x4E3B;&#x8981;&#x662F;&#x8003;&#x8651;&#x5230;cache&#x7684;&#x5229;&#x7528;&#x7387;&#x4F1A;&#x9AD8;&#x4E00;&#x70B9;.</p>
<h3 id="softirq&#x6FC0;&#x6D3B;"><a name="softirq&#x6FC0;&#x6D3B;" class="anchor-navigation-ex-anchor" href="#softirq&#x6FC0;&#x6D3B;"><i class="fa fa-link" aria-hidden="true"></i></a>12.4.1. softirq&#x6FC0;&#x6D3B;</h3>
<p>&#x5728;&#x7528;<code>open_softirq()</code>&#x6CE8;&#x518C;softirq&#x540E;, <code>raise_softirq()</code>&#x51FD;&#x6570;&#x7528;&#x6765;&#x6FC0;&#x6D3B;softirq, &#x6267;&#x884C;&#x6D41;&#x7A0B;:</p>
<ol>
<li>&#x5173;&#x672C;&#x5730;&#x4E2D;&#x65AD;</li>
<li>&#x7ED9;&#x8FD9;&#x4E2A;softirq&#x6807;&#x8BB0;&#x4E3A;pending</li>
<li>&#x8C03;&#x7528;<code>wakeup_softirqd()</code>&#x5524;&#x9192;ksoftirqd&#x8FDB;&#x7A0B;</li>
<li>&#x5F00;&#x672C;&#x5730;&#x4E2D;&#x65AD;</li>
</ol>
<p>kernel&#x4F1A;&#x5728;&#x5173;&#x952E;&#x70B9;&#x4E0A;&#x68C0;&#x67E5;softirq&#x7684;pending&#x72B6;&#x6001;, &#x8FD9;&#x4E9B;&#x5173;&#x952E;&#x70B9;(checkpoints)&#x5305;&#x62EC;:</p>
<ul>
<li>kernel&#x8C03;&#x7528;<code>local_bh_enable</code></li>
<li>&#x5F53;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;<code>do_IRQ()</code>&#x5B8C;&#x6210;&#x786C;&#x4E2D;&#x65AD;&#x5904;&#x7406;, &#x6700;&#x540E;&#x8C03;&#x7528;<code>irq_exit()</code>&#x65F6;</li>
<li>apic timer<code>smp_apic_timer_interrupt()</code>&#x7ED3;&#x675F;&#x65F6;</li>
<li>&#x6838;&#x95F4;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x5B8C;&#x6210;&#x65F6;</li>
<li><em>ksoftirqd</em> &#x5185;&#x6838;&#x8FDB;&#x7A0B;&#x8FD0;&#x884C;&#x65F6;</li>
</ul>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;, &#x8FD9;&#x91CC;&#x9762;&#x65E2;&#x6709;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;, &#x53C8;&#x6709;&#x8FDB;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;. &#x5373;&#x8F6F;&#x4E2D;&#x65AD;&#x51FD;&#x6570;&#x53EF;&#x80FD;&#x5728;&#x4E0D;&#x540C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x6267;&#x884C;.</p>
<p>&#x5F53;&#x4EE5;&#x4E0A;checkpoint&#x68C0;&#x67E5;&#x5F97;&#x77E5;&#x6709;softirq&#x8981;&#x5904;&#x7406;&#x65F6;, &#x5C31;&#x4F1A;&#x8C03;&#x7528;<code>do_softirq()</code>, &#x5176;&#x6267;&#x884C;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;:</p>
<ul>
<li>in_interrupt()&#x5982;&#x679C;&#x662F;1, &#x8868;&#x793A;&#x5DF2;&#x7ECF;&#x5728;&#x4E2D;&#x65AD;&#x91CC;&#x8C03;&#x7528;&#x8FC7;&#x4E86;<code>do_softirq()</code>, &#x6216;&#x8005;&#x8FD9;&#x4E2A;softirq&#x88AB;&#x7981;&#x6B62;&#x4E86;. &#x76F4;&#x63A5;return</li>
<li><code>local_irq_save()</code>&#x5173;&#x4E2D;&#x65AD;</li>
<li>&#x5207;&#x6362;&#x5230;softirq&#x81EA;&#x5DF1;&#x7684;&#x6808;</li>
<li>&#x6267;&#x884C;<code>_ _do_softirq( )</code><ul>
<li>&#x8FD9;&#x91CC;&#x5E94;&#x8BE5;&#x628A;&#x6240;&#x6709;pending&#x7684;&#x4E8B;&#x60C5;&#x90FD;&#x505A;&#x5B8C;, &#x4F46;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x53EF;&#x80FD;&#x662F;&#x5728;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;, &#x6267;&#x884C;&#x592A;&#x4E45;&#x4F1A;&#x6709;&#x95EE;&#x9898;. &#x6240;&#x4EE5;&#x53EA;&#x80FD;&#x6267;&#x884C;&#x56FA;&#x5B9A;&#x6570;&#x91CF;&#x7684;work, &#x5269;&#x4E0B;&#x7684;&#x4EA4;&#x7ED9;ksoftirqd&#x7EBF;&#x7A0B;&#x5904;&#x7406;.</li>
<li>&#x9ED8;&#x8BA4;&#x5904;&#x7406;10&#x4E2A;work</li>
<li><code>local_bh_disable()</code>&#x7981;&#x6B62;&#x5E76;&#x53D1;&#x7684;<code>_ _do_softirq( )</code>&#x6267;&#x884C;? <strong>why? &#x4E0D;&#x662F;&#x8BF4;&#x597D;&#x4E86;softirq&#x652F;&#x6301;&#x5E76;&#x53D1;&#x5417;?</strong></li>
<li><code>local_irq_enable()</code>&#x5F00;&#x4E2D;&#x65AD;</li>
<li>&#x6267;&#x884C;&#x5BF9;&#x5E94;&#x7684;<code>softirq_vec[n]-&gt;action</code></li>
<li><code>wakeup_softirqd( )</code>&#x5524;&#x9192;ksoftirqd&#x5904;&#x7406;&#x8FD9;&#x91CC;&#x5269;&#x4E0B;&#x7684;work</li>
<li>softirq counter&#x51CF;&#x4E00;, &#x518D;&#x6B21;&#x4F7F;&#x80FD;</li>
</ul>
</li>
<li>&#x5207;&#x6362;&#x56DE;&#x4E4B;&#x524D;&#x7684;&#x6808;</li>
<li><code>local_irq_restore()</code>&#x5F00;&#x4E2D;&#x65AD;</li>
</ul>
<h3 id="ksoftirqd&#x7EBF;&#x7A0B;"><a name="ksoftirqd&#x7EBF;&#x7A0B;" class="anchor-navigation-ex-anchor" href="#ksoftirqd&#x7EBF;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a>12.4.2. ksoftirqd&#x7EBF;&#x7A0B;</h3>
<p>&#x8FD9;&#x4E2A;&#x7EBF;&#x7A0B;&#x662F;&#x7528;&#x6765;&#x505A;&#x5269;&#x4E0B;&#x6765;&#x7684;&#x5DE5;&#x4F5C;&#x7684;. </p>
<pre class="language-"><code class="lang-c">    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_INTERRUPTIBLE <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">schedule</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* now in TASK_RUNNING state */</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">local_softirq_pending</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">preempt_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">do_softirq</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">preempt_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">cond_resched</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x7EBF;&#x7A0B;&#x662F;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;softirq&#x8FC7;&#x5FEB;&#x4EA7;&#x751F;&#x7684;&#x65F6;&#x5019;, &#x5360;&#x7528;&#x4E2D;&#x65AD;&#x65F6;&#x95F4;&#x592A;&#x957F;&#x7684;&#x95EE;&#x9898;&#x7684;.
&#x56E0;&#x4E3A;softirq&#x53EF;&#x4EE5;&#x88AB;&#x81EA;&#x5DF1;, &#x6216;&#x8005;&#x88AB;&#x5916;&#x90E8;&#x4E8B;&#x4EF6;&#x6FC0;&#x6D3B;.</p>
<blockquote>
<p>Softirq functions may reactivate themselves; in fact, both the networking softirqs and the tasklet softirqs do this. Moreover, external events, such as packet flooding on a network card, may activate softirqs at very high frequency.</p>
</blockquote>
<h2 id="&#x4E0A;&#x4E0B;&#x6587;&#x5206;&#x7C7B;"><a name="&#x4E0A;&#x4E0B;&#x6587;&#x5206;&#x7C7B;" class="anchor-navigation-ex-anchor" href="#&#x4E0A;&#x4E0B;&#x6587;&#x5206;&#x7C7B;"><i class="fa fa-link" aria-hidden="true"></i></a>12.5. &#x4E0A;&#x4E0B;&#x6587;&#x5206;&#x7C7B;</h2>
<p>&#x524D;&#x9762;&#x5206;&#x6790;&#x4E86;, &#x8F6F;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;&#x53EF;&#x4EE5;&#x5728;&#x786C;&#x4E2D;&#x65AD;&#x4E2D;, &#x4E5F;&#x53EF;&#x80FD;&#x662F;kernel checkpoints, &#x4F46;&#x90FD;&#x4E0D;&#x662F;&#x7528;&#x6237;&#x8FDB;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;(&#x53EF;&#x80FD;&#x4E5F;&#x4E0D;&#x662F;&#x7EDD;&#x5BF9;&#x7684;, &#x6BD4;&#x5982;&#x7528;&#x6237;&#x6001;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x91CC;&#x9762;, &#x8C03;&#x7528;&#x7684;driver&#x51FD;&#x6570;&#x91CC;&#x6709;<code>local_bh_enable()</code>&#x8C03;&#x7528;, &#x90A3;&#x4E48;softirq&#x5C31;&#x662F;&#x5728;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x5904;&#x7406;&#x7684;)<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829150420.png" alt="">  </p>
<p>&#x7528;&#x6237;&#x4E0A;&#x4E0B;&#x6587;&#x6C38;&#x8FDC;&#x53EF;&#x80FD;&#x88AB;&#x62A2;&#x5360;<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829150436.png" alt="">  </p>
<p>&#x7EAF;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x6CA1;&#x6709;MM<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829150454.png" alt="">  </p>
<p>softirq&#x662F;&#x5728;&#x9884;&#x5B9A;&#x4E49;&#x7684;kernel &quot;checkpoint&quot;&#x91CC;&#x6267;&#x884C;&#x7684;<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829150513.png" alt="">  </p>
<p>&#x4E2D;&#x65AD;&#x91CC;&#x4E0D;&#x80FD;sleep<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829150531.png" alt="">  </p>
<h2 id="&#x6536;&#x62A5;&#x7684;&#x65F6;&#x95F4;&#x7B97;&#x5728;&#x54EA;&#x91CC;"><a name="&#x6536;&#x62A5;&#x7684;&#x65F6;&#x95F4;&#x7B97;&#x5728;&#x54EA;&#x91CC;" class="anchor-navigation-ex-anchor" href="#&#x6536;&#x62A5;&#x7684;&#x65F6;&#x95F4;&#x7B97;&#x5728;&#x54EA;&#x91CC;"><i class="fa fa-link" aria-hidden="true"></i></a>12.6. &#x6536;&#x62A5;&#x7684;&#x65F6;&#x95F4;&#x7B97;&#x5728;&#x54EA;&#x91CC;?</h2>
<p>&#x4ECE;&#x7528;&#x6237;&#x6001;&#x8C03;&#x7528;recv&#x5F00;&#x59CB;, &#x7528;&#x6237;&#x6001;&#x7B49;&#x5F85;packet<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829150548.png" alt="">  </p>
<p>&#x7F51;&#x5361;&#x6536;&#x62A5;, &#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;&#x9A71;&#x52A8;&#x5904;&#x7406;, &#x6FC0;&#x6D3B;softirq<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829150609.png" alt="">  </p>
<p>&#x8FD9;&#x4E2A;&#x56FE;&#x6709;&#x70B9;&#x7247;&#x9762;. &#x5927;&#x6982;&#x7387;&#x662F;&#x5728;&#x4E2D;&#x65AD;&#x4E0A;&#x4E0B;&#x6587;&#x5904;&#x7406;10&#x4E2A;, &#x5269;&#x4E0B;&#x7684;&#x53EB;&#x7ED9;ksoftirqd<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829150630.png" alt="">  </p>
<p>&#x5524;&#x9192;&#x7528;&#x6237;&#x8FDB;&#x7A0B;<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829150647.png" alt="">  </p>
<p>&#x8865;&#x5145;: kernel&#x7684;&#x4E00;&#x4E9B;api&#x7528;&#x4E8E;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x4E0A;&#x4E0B;&#x6587;<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829150708.png" alt="">  </p>
<p>&#x5B9E;&#x9645;&#x4E0A;, &#x7F51;&#x5361;&#x9A71;&#x52A8;&#x6536;&#x62A5;, IP&#x5C42;&#x5904;&#x7406;, &#x90FD;&#x4E0D;&#x4F1A;&#x7B97;&#x5728;&#x8FDB;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x4E0A;.
&#x4F46;&#x5230;TCP&#x9636;&#x6BB5;, &#x5DF2;&#x7ECF;&#x7ED1;&#x5B9A;&#x5230;socket&#x4E86;, <code>tcp_v4_do_rcv()</code>&#x6709;&#x53EF;&#x80FD;&#x5728;&#x8FDB;&#x7A0B;&#x4E0A;&#x4E0B;&#x6267;&#x884C;, &#x4E5F;&#x6709;&#x53EF;&#x80FD;&#x5728;softirq&#x4E0A;&#x4E0B;&#x6587;&#x6267;&#x884C;.
&#x7ED3;&#x5408;<code>&lt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Potential</span> <span class="token attr-name">Performance</span> <span class="token attr-name">Bottleneck</span> <span class="token attr-name">in</span> <span class="token attr-name">Linux</span> <span class="token attr-name">TCP</span><span class="token punctuation">&gt;</span></span>&gt;</code>&#x7684;&#x5206;&#x6790;, &#x5982;&#x679C;&#x6B63;&#x597D;&#x7528;&#x6237;&#x8FDB;&#x7A0B;&#x5728;run, &#x4F46;&#x8FD8;&#x6CA1;&#x6709;&#x8C03;&#x7528;<code>recv()</code>, &#x5C31;&#x4F1A;&#x5728;softirq&#x4E0A;&#x4E0B;&#x6587;&#x6267;&#x884C;<code>tcp_v4_do_rcv()</code><br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829150734.png" alt="">  </p>
<p>&#x90A3;&#x4E48;&#x6536;&#x62A5;&#x7684;&#x65F6;&#x95F4;&#x7B97;&#x5728;&#x8FDB;&#x7A0B;&#x5934;&#x4E0A;&#x5417;?<br>&#x7B54;: &#x5E94;&#x8BE5;&#x8BF4;&#x5927;&#x90E8;&#x5206;&#x65F6;&#x95F4;&#x4E0D;&#x4F1A;. &#x6BD4;&#x5982;&#x9A71;&#x52A8;&#x6536;&#x62A5;&#x548C;IP&#x5C42;&#x5904;&#x7406;.</p>
<h1 id="socket&#x4EC0;&#x4E48;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x53D1;&#x751F;&#x77ED;&#x8BFB;short-readpartial-read"><a name="socket&#x4EC0;&#x4E48;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x53D1;&#x751F;&#x77ED;&#x8BFB;short-readpartial-read" class="anchor-navigation-ex-anchor" href="#socket&#x4EC0;&#x4E48;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x53D1;&#x751F;&#x77ED;&#x8BFB;short-readpartial-read"><i class="fa fa-link" aria-hidden="true"></i></a>13. socket&#x4EC0;&#x4E48;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x53D1;&#x751F;&#x77ED;&#x8BFB;short read/partial read?</h1>
<p>&#x7B54;: &#x5E94;&#x8BE5;&#x4E3B;&#x8981;&#x662F;&#x548C;syscall&#x7684;&#x88AB;&#x6253;&#x65AD;&#x6709;&#x5173;; &#x6216;&#x8005;&#x5F53;&#x65F6;receive queue&#x91CC;&#x9762;&#x786E;&#x5B9E;&#x6CA1;&#x6709;&#x90A3;&#x4E48;&#x591A;&#x7684;&#x5B57;&#x8282;.</p>
<blockquote>
<p>A characteristic of earlier UNIX systems was that if a process caught a signal while the process was blocked in a &#x2018;&#x2018;slow&#x2019;&#x2019; system call, the system call was interrupted. The system call returned an error and errno was set to EINTR. This was done under the assumption that since a signal occurred and the process caught it, there is a good chance that something has happened that should wake up the blocked system call.</p>
<p>To prevent applications from having to handle interrupted system calls, 4.2BSD introduced the automatic restarting of certain interrupted system calls. The system calls that were automatically restarted are ioctl, read, readv, write, writev, wait, and waitpid. As we&#x2019;ve mentioned, the first five of these functions are interrupted by a signal only if they are operating on a slow device; wait and waitpid are always interrupted when a signal is caught. Since this caused a problem for some applications that didn&#x2019;t want the operation restarted if it was interrupted, 4.3BSD allowed the process to disable this feature on a per-signal basis.</p>
</blockquote>
<p>stackoverflow&#x7684;&#x56DE;&#x7B54;:
Interruption of a system call by a signal handler occurs only in the case of various blocking system calls, and happens when the system call is interrupted by a signal handler that was explicitly established by the programmer.</p>
<p>Furthermore, in the case where a blocking system call is interrupted by a signal handler, automatic system call restarting is an <em>optional</em> feature. You elect to automatically restart system calls by specifying the <code>SA_RESTART</code> flag when establishing the signal handler. As stated in (for example) the Linux <a href="http://man7.org/linux/man-pages/man7/signal.7.html" target="_blank">signal(7)</a> manual page:</p>
<pre class="language-"><code>   If  a  signal  handler  is  invoked while a system call or library
   function call is blocked, then either:

   * the call is automatically restarted  after  the  signal  handler
     returns; or

   * the call fails with the error EINTR.

   Which  of  these two behaviors occurs depends on the interface and
   whether or not  the  signal  handler  was  established  using  the
   SA_RESTART  flag (see sigaction(2)).
</code></pre><p>As hinted by the last sentence quoted above, even when you elect to use this feature, it does not work for all system calls, and the set of system calls for which it does work varies across UNIX implementations. The Linux <code>signal(7)</code> manual page notes a number of system calls that are automatically restarted when using the <code>SA_RESTART</code> flag, but also goes on to note various system calls that are never restarted, even if you specify that flag when establishing a handler, including:</p>
<pre class="language-"><code>   * &quot;Input&quot; socket interfaces, when a timeout (SO_RCVTIMEO) has been
     set  on  the  socket  using  setsockopt(2):  accept(2), recv(2),
     recvfrom(2), recvmmsg(2) (also with  a  non-NULL  timeout  argu&#x2010;
     ment), and recvmsg(2).

   * &quot;Output&quot;  socket  interfaces,  when  a timeout (SO_RCVTIMEO) has
     been set on the socket using setsockopt(2): connect(2), send(2),
     sendto(2), and sendmsg(2).

   * File   descriptor   multiplexing   interfaces:    epoll_wait(2),
     epoll_pwait(2), poll(2), ppoll(2), select(2), and pselect(2).

   * System  V  IPC  interfaces:  msgrcv(2), msgsnd(2), semop(2), and
     semtimedop(2).
</code></pre><p>For these system calls, manual restarting using a loop of the form described in APUE is essential, something like:</p>
<pre class="language-"><code>while ((ret = some_syscall(...)) == -1 &amp;&amp; errno == EINTR)
    continue;
if (ret == -1)
    /* Handle error */ ;
</code></pre><h1 id="socket&#x901A;&#x4FE1;&#x7684;&#x65F6;&#x5019;-&#x8981;&#x5728;&#x5E94;&#x7528;&#x4FA7;&#x505A;&#x5B57;&#x8282;&#x5E8F;&#x8F6C;&#x6362;&#x5417;"><a name="socket&#x901A;&#x4FE1;&#x7684;&#x65F6;&#x5019;-&#x8981;&#x5728;&#x5E94;&#x7528;&#x4FA7;&#x505A;&#x5B57;&#x8282;&#x5E8F;&#x8F6C;&#x6362;&#x5417;" class="anchor-navigation-ex-anchor" href="#socket&#x901A;&#x4FE1;&#x7684;&#x65F6;&#x5019;-&#x8981;&#x5728;&#x5E94;&#x7528;&#x4FA7;&#x505A;&#x5B57;&#x8282;&#x5E8F;&#x8F6C;&#x6362;&#x5417;"><i class="fa fa-link" aria-hidden="true"></i></a>14. socket&#x901A;&#x4FE1;&#x7684;&#x65F6;&#x5019;, &#x8981;&#x5728;&#x5E94;&#x7528;&#x4FA7;&#x505A;&#x5B57;&#x8282;&#x5E8F;&#x8F6C;&#x6362;&#x5417;?</h1>
<p>&#x7B54;: &#x8981;. &#x5C24;&#x5176;&#x662F;binary&#x7F16;&#x7801;&#x60C5;&#x51B5;&#x4E0B;. &#x4E00;&#x822C;&#x7C7B;&#x4F3C;GPB&#x7684;codec&#x5DF2;&#x7ECF;&#x505A;&#x4E86;. </p>
<h1 id="socket&#x7684;stream&#x6A21;&#x5F0F;&#x548C;datagram&#x6A21;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x4E0D;&#x540C;"><a name="socket&#x7684;stream&#x6A21;&#x5F0F;&#x548C;datagram&#x6A21;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x4E0D;&#x540C;" class="anchor-navigation-ex-anchor" href="#socket&#x7684;stream&#x6A21;&#x5F0F;&#x548C;datagram&#x6A21;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x4E0D;&#x540C;"><i class="fa fa-link" aria-hidden="true"></i></a>15. socket&#x7684;stream&#x6A21;&#x5F0F;&#x548C;datagram&#x6A21;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x4E0D;&#x540C;?</h1>
<h2 id="socket&#x57FA;&#x7840;"><a name="socket&#x57FA;&#x7840;" class="anchor-navigation-ex-anchor" href="#socket&#x57FA;&#x7840;"><i class="fa fa-link" aria-hidden="true"></i></a>15.1. socket&#x57FA;&#x7840;</h2>
<p><code>man socket</code></p>
<pre class="language-"><code class="lang-c">       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>          <span class="token comment">/* See NOTES */</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>domain&#x6709;&#x5982;&#x4E0B;&#x65B9;&#x5F0F;</p>
<pre class="language-"><code>       Name                Purpose                          Man page
       AF_UNIX, AF_LOCAL   Local communication              unix(7)
       AF_INET             IPv4 Internet protocols          ip(7)
       AF_INET6            IPv6 Internet protocols          ipv6(7)
       AF_IPX              IPX - Novell protocols
       AF_NETLINK          Kernel user interface device     netlink(7)
       AF_X25              ITU-T X.25 / ISO-8208 protocol   x25(7)
       AF_AX25             Amateur radio AX.25 protocol
       AF_ATMPVC           Access to raw ATM PVCs
       AF_APPLETALK        AppleTalk                        ddp(7)
       AF_PACKET           Low level packet interface       packet(7)
       AF_ALG              Interface to kernel crypto API
</code></pre><p>type&#x6709;</p>
<pre class="language-"><code>       SOCK_STREAM     Provides sequenced, reliable, two-way, connection-based byte streams.  An out-of-band data transmission mechanism may be supported.

       SOCK_DGRAM      Supports datagrams (connectionless, unreliable messages of a fixed maximum length).

       SOCK_SEQPACKET  Provides a sequenced, reliable, two-way connection-based data transmission path for datagrams of fixed maximum length; a consumer is required to read an entire packet with each input system call.

       SOCK_RAW        Provides raw network protocol access.

       SOCK_RDM        Provides a reliable datagram layer that does not guarantee ordering.

       SOCK_PACKET     Obsolete and should not be used in new programs; see packet(7).
</code></pre><p>type&#x8FD8;&#x652F;&#x6301;OR&#x6807;&#x8BB0;</p>
<pre class="language-"><code>       SOCK_NONBLOCK   Set the O_NONBLOCK file status flag on the new open file description.  Using this flag saves extra calls to fcntl(2) to achieve the same result.

       SOCK_CLOEXEC    Set the close-on-exec (FD_CLOEXEC) flag on the new file descriptor.  See the description of the O_CLOEXEC flag in open(2) for reasons why this may be useful.
</code></pre><p>socket&#x7684;&#x9009;&#x9879;&#x662F;SO_xxxx&#x5F62;&#x5F0F;&#x7684;, &#x7528;<code>setsockopt(2)</code>&#x6765;&#x8BBE;&#x7F6E;. &#x7528;<code>getsockopt(2)</code> &#x6765;&#x83B7;&#x53D6;.</p>
<pre class="language-"><code>SO_SNDBUF
              Sets or gets the maximum socket send buffer in bytes.  The
              kernel doubles this value (to allow space for bookkeeping
              overhead) when it is set using setsockopt(2), and this doubled
              value is returned by getsockopt(2).  The default value is set
              by the /proc/sys/net/core/wmem_default file and the maximum
              allowed value is set by the /proc/sys/net/core/wmem_max file.
              The minimum (doubled) value for this option is 2048.
</code></pre><p>&#x6211;&#x8FD9;&#x91CC;&#x663E;&#x793A;, &#x9ED8;&#x8BA4;&#x7684;&#x53D1;&#x9001;buf&#x662F;229K</p>
<pre class="language-"><code class="lang-sh">~ <span class="token comment"># cat /proc/sys/net/core/wmem_default</span>
<span class="token number">229376</span>
~ <span class="token comment"># cat /proc/sys/net/core/wmem_max</span>
<span class="token number">229376</span>
</code></pre>
<h2 id="sockstream"><a name="sockstream" class="anchor-navigation-ex-anchor" href="#sockstream"><i class="fa fa-link" aria-hidden="true"></i></a>15.2. SOCK_STREAM</h2>
<ul>
<li>AF_INET domain&#x91CC;&#x9762;&#x5BF9;&#x5E94;TCP, &#x6709;&#x94FE;&#x63A5;, &#x53EF;&#x9760;, &#x4FDD;&#x5E8F;.</li>
<li>&#x6CA1;&#x6709;&#x8BB0;&#x5F55;&#x8FB9;&#x754C;. &#x8FD9;&#x5C31;&#x662F;&#x5B57;&#x8282;&#x6D41;&#x7684;&#x6838;&#x5FC3;&#x8981;&#x4E49;.</li>
<li>&#x901A;&#x4FD7;&#x6765;&#x8BB2;, &#x53D1;&#x9001;&#x65B9;&#x53D1;2&#x6B21;5&#x5B57;&#x8282;, &#x63A5;&#x6536;&#x65B9;&#x53EF;&#x4EE5;&#x4E00;&#x6B21;&#x8BFB;&#x5230;10&#x4E2A;&#x5B57;&#x8282;. &#x5E76;&#x4E14;, &#x63A5;&#x6536;&#x65B9;&#x5E76;&#x4E0D;&#x77E5;&#x9053;&#x8FD9;10&#x4E2A;&#x5B57;&#x8282;&#x662F;&#x4E24;&#x6B21;&#x53D1;&#x9001;&#x7684;&#x8FD8;&#x662F;&#x4E00;&#x6B21;&#x53D1;&#x9001;&#x7684;.</li>
<li>send()&#x548C;recv()API, &#x652F;&#x6301;&#x5E26;&#x5916;&#x6570;&#x636E;&#x53D1;&#x9001;</li>
<li>&#x5982;&#x679C;&#x8D85;&#x65F6;&#x540E;&#x8FD8;&#x662F;&#x6709;&#x6BB5;&#x6570;&#x636E;&#x6CA1;&#x6709;&#x6536;&#x5230;, &#x5219;&#x8FD9;&#x4E2A;&#x8FDE;&#x63A5;&#x5C31;&#x662F;broken&#x4E86;.</li>
<li>&#x5BF9;broken&#x7684;&#x8FDE;&#x63A5;&#x8BFB;&#x5199;&#x4F1A;&#x4EA7;&#x751F;<code>SIGPIPE</code>&#x4FE1;&#x53F7;</li>
</ul>
<h2 id="sockseqpacket"><a name="sockseqpacket" class="anchor-navigation-ex-anchor" href="#sockseqpacket"><i class="fa fa-link" aria-hidden="true"></i></a>15.3. SOCK_SEQPACKET</h2>
<ul>
<li>&#x5E95;&#x5C42;&#x548C;SOCK_STREAM&#x4E00;&#x81F4;, &#x6709;&#x94FE;&#x63A5;, &#x53EF;&#x9760;, &#x4FDD;&#x5E8F;</li>
<li>&#x662F;packet&#x6A21;&#x5F0F;, &#x6709;&#x754C;. &#x4E00;&#x6B21;&#x8BFB;&#x4F1A;&#x628A;&#x8FD9;&#x4E2A;packet&#x7684;&#x6240;&#x6709;&#x6570;&#x636E;&#x8BFB;&#x51FA;, &#x8D85;&#x51FA;&#x7684;&#x6570;&#x636E;&#x4F1A;&#x88AB;&#x4E22;&#x5F03;.<blockquote>
<p>all message boundaries in incoming datagrams are preserved</p>
</blockquote>
</li>
</ul>
<h2 id="sockdgram"><a name="sockdgram" class="anchor-navigation-ex-anchor" href="#sockdgram"><i class="fa fa-link" aria-hidden="true"></i></a>15.4. SOCK_DGRAM</h2>
<ul>
<li>&#x65E0;&#x8FDE;&#x63A5;, &#x6709;size&#x9650;&#x5236;&#x7684;&#x6570;&#x636E;&#x62A5;&#x6A21;&#x5F0F;</li>
<li>&#x4F7F;&#x7528;sendto()&#x548C;recvfrom() API. recvfrom()&#x8FD4;&#x56DE;&#x4E0B;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x62A5;.<blockquote>
<p>Datagrams are generally received with recvfrom(2), which returns the next datagram along with the address of its sender.</p>
</blockquote>
</li>
<li>&#x5929;&#x7136;&#x6709;&#x754C;: &#x6240;&#x6709;&#x7684;&#x6536;&#x62A5;&#x90FD;&#x662F;&#x4E00;&#x4E2A;packet. &#x5C0F;&#x62A5;&#x76F4;&#x63A5;&#x6536;, &#x5927;&#x5305;&#x88AB;&#x622A;&#x65AD;, &#x5269;&#x4F59;&#x90E8;&#x5206;&#x4E22;&#x5F03;.<blockquote>
<p> All receive operations return only one packet.  When the packet is smaller than the passed buffer, only that much data is returned; when it is bigger, the packet is truncated and the MSG_TRUNC flag is set.</p>
</blockquote>
</li>
<li>&#x53D1;&#x9001;&#x7AEF;&#x7684;sendto()&#x548C;&#x63A5;&#x6536;&#x7AEF;&#x7684;recvfrom()&#x6C38;&#x8FDC;&#x662F;1:1&#x7684;, &#x4E00;&#x4E2A;&#x5BF9;&#x4E00;&#x4E2A;. &#x6BD4;&#x5982;sendto()&#x4E24;&#x6B21;, &#x4E5F;&#x5FC5;&#x987B;recvfrom()&#x4E24;&#x6B21;&#x624D;&#x80FD;&#x6536;&#x5B8C;&#x62A5;&#x6587;. &#x8FD9;&#x70B9;&#x548C;TCP&#x4E0D;&#x4E00;&#x6837;. &#x8FD9;&#x4E5F;&#x662F;data gram&#x7684;&#x542B;&#x4E49;.</li>
<li>&#x6709;&#x4E2A;api, &#x652F;&#x6301;&#x4E00;&#x6B21;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;, &#x6536;&#x591A;&#x4E2A;datagram: <code>recvmmsg()</code> &#x4F30;&#x8BA1;&#x662F;&#x5728;&#x5185;&#x6838;&#x6001;&#x591A;&#x6B21;recv&#x6536;&#x62A5;.</li>
</ul>
<h2 id="man-7-ip"><a name="man-7-ip" class="anchor-navigation-ex-anchor" href="#man-7-ip"><i class="fa fa-link" aria-hidden="true"></i></a>15.5. man 7 ip</h2>
<pre class="language-"><code class="lang-c">       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/ip.h&gt;</span> <span class="token comment">/* superset of previous */</span></span>

       tcp_socket <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       udp_socket <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       raw_socket <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>proc&#x4E0B;&#x9762;&#x6709;&#x4E9B;&#x5168;&#x5C40;&#x7684;&#x914D;&#x7F6E;: <code>/proc/sys/net/ipv4/</code></p>
<h2 id="man-7-tcp"><a name="man-7-tcp" class="anchor-navigation-ex-anchor" href="#man-7-tcp"><i class="fa fa-link" aria-hidden="true"></i></a>15.6. man 7 tcp</h2>
<pre class="language-"><code class="lang-c">       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/tcp.h&gt;</span></span>

       tcp_socket <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
<li>&#x4E00;&#x4E9B;&#x5168;&#x5C40;&#x7684;&#x914D;&#x7F6E;<pre class="language-"><code class="lang-sh">~ <span class="token comment"># cat /proc/sys/net/ipv4/tcp_wmem</span>
<span class="token number">4096</span>    <span class="token number">16384</span>   <span class="token number">4194304</span>
~ <span class="token comment"># cat /proc/sys/net/ipv4/tcp_rmem</span>
<span class="token number">4096</span>    <span class="token number">87380</span>   <span class="token number">6291456</span>
</code></pre>
</li>
<li>/proc/sys/net/core/rmem_max</li>
<li>/proc/sys/net/core/wmem_max</li>
<li>&#x652F;&#x6301;urgent data, &#x7528;send&#x7684;MSG_OOB&#x9009;&#x9879;&#x53D1;&#x9001;</li>
<li>&#x652F;&#x6301;ioctl</li>
</ul>
<h2 id="man-7-udp"><a name="man-7-udp" class="anchor-navigation-ex-anchor" href="#man-7-udp"><i class="fa fa-link" aria-hidden="true"></i></a>15.7. man 7 udp</h2>
<pre class="language-"><code class="lang-c">       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/udp.h&gt;</span></span>

       udp_socket <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
<li>&#x9ED8;&#x8BA4;&#x6700;&#x5927;MTU, &#x5199;&#x62A5;&#x6587;&#x8D85;&#x8FC7;MTU&#x4F1A;&#x6709;EMSG&#x2010;SIZE&#x9519;&#x8BEF;.</li>
</ul>
<h2 id="man-7-unix"><a name="man-7-unix" class="anchor-navigation-ex-anchor" href="#man-7-unix"><i class="fa fa-link" aria-hidden="true"></i></a>15.8. man 7 unix</h2>
<pre class="language-"><code class="lang-c">       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/un.h&gt;</span></span>

       unix_socket <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_UNIX<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       error <span class="token operator">=</span> <span class="token function">socketpair</span><span class="token punctuation">(</span>AF_UNIX<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>sv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
<li>&#x540C;&#x65F6;&#x652F;&#x6301;SOCK_STREAM&#x548C;SOCK_DGRAM, &#x5E76;&#x4E14;SOCK_DGRAM&#x662F;&#x53EF;&#x9760;&#x548C;&#x4FDD;&#x5E8F;&#x7684;</li>
<li>&#x4E5F;&#x652F;&#x6301;SOCK_SEQPACKET</li>
<li>&#x4E0D;&#x652F;&#x6301;out-of-band&#x6570;&#x636E;</li>
<li>&#x652F;&#x6301;fd&#x4F20;&#x9012;&#x5230;&#x5176;&#x4ED6;&#x8FDB;&#x7A0B;, &#x89C1;SCM_RIGHTS<blockquote>
<p>Send  or  receive a set of open file descriptors from another process.  The data portion contains an integer array of the file descriptors.  The passed file descriptors behave as though they have been created with dup(2).</p>
</blockquote>
</li>
<li>datagram&#x6A21;&#x5F0F;&#x65F6;, SO_SNDBUF&#x8D77;&#x4F5C;&#x7528;, &#x8FD9;&#x4E2A;&#x662F;send()&#x6570;&#x636E;&#x62A5;&#x7684;&#x4E0A;&#x9650;. &#x4E0A;&#x9650;&#x662F;: <code>2*SO_SNDBUF-32</code>
SO_RCVBUF&#x6CA1;&#x6709;&#x4F5C;&#x7528;</li>
</ul>
<h2 id="&#x4EC0;&#x4E48;&#x662F;message-boundires"><a name="&#x4EC0;&#x4E48;&#x662F;message-boundires" class="anchor-navigation-ex-anchor" href="#&#x4EC0;&#x4E48;&#x662F;message-boundires"><i class="fa fa-link" aria-hidden="true"></i></a>15.9. &#x4EC0;&#x4E48;&#x662F;message boundires?</h2>
<blockquote>
<p> UDP preserves message boundaries. If you send &quot;FOO&quot; and then &quot;BAR&quot; over UDP, the other end will receive two datagrams, one containing &quot;FOO&quot; and the other containing &quot;BAR&quot;.</p>
<p>If you send &quot;FOO&quot; and then &quot;BAR&quot; over TCP, no message boundary is preserved. The other end might get &quot;FOO&quot; and then &quot;BAR&quot;. Or it might get &quot;FOOBAR&quot;. Or it might get &quot;F&quot; and then &quot;OOB&quot; and then &quot;AR&quot;. TCP does not make any attempt to preserve application message boundaries -- it&apos;s just a stream of bytes in each direction.</p>
</blockquote>
<p>&#x5BF9;&#x4E8E;datagram&#x7C7B;&#x578B;&#x7684;&#x62A5;&#x6587;&#x63A5;&#x6536;, &#x7528;</p>
<pre class="language-"><code class="lang-c"><span class="token class-name">ssize_t</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
                        <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>src_addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<blockquote>
<p>The <code>recvfrom</code> function reads <strong>one packet</strong> from the socket <em>socket</em> into the buffer <em>buffer</em>. The <em>size</em> argument specifies the maximum number of bytes to be read.</p>
<p>UDP operates on messages, not streams like TCP does. There is a 1-to-1 relationship between <code>sendto()</code> and <code>recvfrom()</code> when using UDP</p>
<p>If the packet is longer than <var>size</var> bytes, then you get the first <var>size</var> bytes of the packet and the rest of the packet is lost. There&#x2019;s no way to read the rest of the packet. Thus, when you use a packet protocol, you must always know how long a packet to expect.</p>
<p>The arguments to this call are basically the same as the standard socket call. The Recvfrom() call reads <strong>one packet at a time</strong>. It returns the length of the message written to the buffer pointed to by the buf argument (the second argument). Even if one packet worth of message does not <strong>fill up</strong> the buffer, Recvfrom() will return immediately and will not read the second packet. However, if a message in a packet is too long to fit in the supplied buffer, the excess bytes are discarded.</p>
<p>By default, Recvfrom() is blocking: when a process issues a Recvfrom() that cannot be completed immediately (because there is no packet), the process is put to sleep waiting for a packet to arrive at the socket. Therefore, a call to Recvfrom() will return immediately only if a packet is available on the socket.</p>
<p>When the argument flags of Recvfrom() is set to MSG_NOBLOCK, Recvfrom() does not block if there is no data to be read, but returns immediately with a return value of 0 bytes. MSG_NOBLOCK is defined in $PDIR/include/systm.h. In an actual UNIX system, socket descriptors are set to be non-blocking using fcntl() with type O_NONBLOCK, and Recvfrom() returns errno EWOULDBLOCK when there is no data to be read on the non-blocking socket.</p>
</blockquote>
<h3 id="tcp&#x7684;stream&#x6A21;&#x5F0F;&#x600E;&#x4E48;&#x5B9A;&#x754C;"><a name="tcp&#x7684;stream&#x6A21;&#x5F0F;&#x600E;&#x4E48;&#x5B9A;&#x754C;" class="anchor-navigation-ex-anchor" href="#tcp&#x7684;stream&#x6A21;&#x5F0F;&#x600E;&#x4E48;&#x5B9A;&#x754C;"><i class="fa fa-link" aria-hidden="true"></i></a>15.9.1. TCP&#x7684;stream&#x6A21;&#x5F0F;&#x600E;&#x4E48;&#x5B9A;&#x754C;?</h3>
<p>stream&#x6D41;, &#x63A5;&#x6536;&#x65B9;&#x5E76;&#x4E0D;&#x77E5;&#x9053;&#x53D1;&#x9001;&#x653E;&#x5206;&#x591A;&#x5C11;&#x6B21;&#x53D1;&#x9001;&#x7684;. &#x63A5;&#x6536;&#x65B9;&#x53EA;&#x770B;&#x5230;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x6D41;. &#x8FD9;&#x5C31;&#x9700;&#x8981;&#x5728;&#x5E94;&#x7528;&#x5C42;&#x5B9A;&#x754C;, &#x5373;&#x53CC;&#x65B9;&#x7EA6;&#x5B9A;&#x5982;&#x4F55;&#x5206;&#x5272;&#x548C;&#x7406;&#x89E3;&#x8FD9;&#x4E2A;&#x5B57;&#x8282;&#x6D41;.
&#x901A;&#x5E38;&#x7684;&#x65B9;&#x6CD5;&#x6709;:</p>
<ul>
<li>&#x52A0;&#x56FA;&#x5B9A;size&#x7684;&#x5934;. &#x8FD9;&#x4E2A;&#x5934;&#x91CC;&#x6709;size&#x4FE1;&#x606F;<blockquote>
<p>So you first receive the header (fixed size), extract the message size information and then receive in a second loop the real user data.</p>
</blockquote>
</li>
<li>&#x52A0;delimiter, &#x5373;&#x7279;&#x6B8A;&#x7B26;&#x53F7;&#x6807;&#x8BB0;<blockquote>
<p>Alternatively some protocols are using delimiters to mark message boundaries.</p>
</blockquote>
</li>
</ul>
<h1 id="cgroup&#x914D;&#x7F6E;"><a name="cgroup&#x914D;&#x7F6E;" class="anchor-navigation-ex-anchor" href="#cgroup&#x914D;&#x7F6E;"><i class="fa fa-link" aria-hidden="true"></i></a>16. cgroup&#x914D;&#x7F6E;</h1>
<h2 id="&#x5199;&#x5165;pid"><a name="&#x5199;&#x5165;pid" class="anchor-navigation-ex-anchor" href="#&#x5199;&#x5165;pid"><i class="fa fa-link" aria-hidden="true"></i></a>16.1. &#x5199;&#x5165;pid</h2>
<p><code>/sys/fs/cgroup/cpu</code>&#x7684;cgroups&#x6811;&#x4E0B;&#x9762;, &#x6709;&#x4E24;&#x4E2A;&#x6587;&#x4EF6;</p>
<ul>
<li>cgroup.procs : &#x5C06;pid&#x5199;&#x5165;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;, &#x8FD9;&#x4E2A;pid&#x4E0B;&#x9762;&#x7684;&#x6240;&#x6709;&#x7EBF;&#x7A0B;&#x90FD;&#x53D7;cgroups&#x63A7;&#x5236;</li>
<li>tasks : &#x53EA;&#x6709;&#x8FD9;&#x4E2A;pid&#x7684;&#x7EBF;&#x7A0B;&#x53D7;cgroups&#x63A7;&#x5236;</li>
</ul>
<h2 id="rt&#x8C03;&#x5EA6;&#x57DF;&#x7684;&#x914D;&#x989D;"><a name="rt&#x8C03;&#x5EA6;&#x57DF;&#x7684;&#x914D;&#x989D;" class="anchor-navigation-ex-anchor" href="#rt&#x8C03;&#x5EA6;&#x57DF;&#x7684;&#x914D;&#x989D;"><i class="fa fa-link" aria-hidden="true"></i></a>16.2. rt&#x8C03;&#x5EA6;&#x57DF;&#x7684;&#x914D;&#x989D;</h2>
<pre class="language-"><code>/mnt/cgroups/cpu # cat cpu.rt_runtime_us
950000
</code></pre><h2 id="&#x4E00;&#x4E9B;&#x547D;&#x4EE4;"><a name="&#x4E00;&#x4E9B;&#x547D;&#x4EE4;" class="anchor-navigation-ex-anchor" href="#&#x4E00;&#x4E9B;&#x547D;&#x4EE4;"><i class="fa fa-link" aria-hidden="true"></i></a>16.3. &#x4E00;&#x4E9B;&#x547D;&#x4EE4;</h2>
<pre class="language-"><code class="lang-sh"><span class="token comment"># &#x67E5;&#x770B;cgBase&#x7EC4;&#x91CC;&#x7684;&#x8FDB;&#x7A0B;</span>
<span class="token function">cat</span> /mnt/cgroups/cpu/cgBase/cgroup.procs <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-i</span> <span class="token function">cat</span> /proc/<span class="token punctuation">{</span><span class="token punctuation">}</span>/comm
<span class="token comment"># &#x67E5;&#x770B;cgBase&#x7EC4;&#x91CC;&#x7684;&#x7EBF;&#x7A0B;</span>
<span class="token function">cat</span> /mnt/cgroups/cpu/cgBase/tasks <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-i</span> <span class="token function">cat</span> /proc/<span class="token punctuation">{</span><span class="token punctuation">}</span>/comm

<span class="token comment"># &#x67E5;&#x770B;cgNonDelayCrit&#x7EC4;&#x91CC;&#x7684;&#x8FDB;&#x7A0B;</span>
<span class="token function">cat</span> /mnt/cgroups/cpu/cgBase/cgNonDelayCrit/cgroup.procs <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-i</span> <span class="token function">cat</span> /proc/<span class="token punctuation">{</span><span class="token punctuation">}</span>/comm
<span class="token comment"># &#x67E5;&#x770B;cgNonDelayCrit&#x7EC4;&#x91CC;&#x7684;&#x7EBF;&#x7A0B;</span>
<span class="token function">cat</span> /mnt/cgroups/cpu/cgBase/cgNonDelayCrit/tasks <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-i</span> <span class="token function">cat</span> /proc/<span class="token punctuation">{</span><span class="token punctuation">}</span>/comm

<span class="token comment"># &#x67E5;&#x770B;onu_engine group</span>
<span class="token function">cat</span> /mnt/cgroups/cpu/cgBase/cgNonDelayCrit/onu_engine/cgroup.procs <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-i</span> <span class="token function">cat</span> /proc/<span class="token punctuation">{</span><span class="token punctuation">}</span>/comm

<span class="token comment"># &#x67E5;&#x770B;&#x6240;&#x6709;&#x4E0D;&#x5728;cgroup&#x7EC4;&#x7684;&#x8FDB;&#x7A0B;</span>
<span class="token function">cat</span> /mnt/cgroups/cpu/cgroup.procs <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-i</span> <span class="token function">cat</span> /proc/<span class="token punctuation">{</span><span class="token punctuation">}</span>/comm
</code></pre>
<h1 id="linux&#x8C03;&#x5EA6;&#x65B9;&#x5F0F;&#x6709;&#x54EA;&#x4E9B;"><a name="linux&#x8C03;&#x5EA6;&#x65B9;&#x5F0F;&#x6709;&#x54EA;&#x4E9B;" class="anchor-navigation-ex-anchor" href="#linux&#x8C03;&#x5EA6;&#x65B9;&#x5F0F;&#x6709;&#x54EA;&#x4E9B;"><i class="fa fa-link" aria-hidden="true"></i></a>17. linux&#x8C03;&#x5EA6;&#x65B9;&#x5F0F;&#x6709;&#x54EA;&#x4E9B;?</h1>
<p><code>man sched</code>
&#x6240;&#x6709;&#x7684;&#x8C03;&#x5EA6;&#x7B56;&#x7565;&#x662F;&#x5BF9;&#x540C;&#x4E00;&#x4E2A;&#x4F18;&#x5148;&#x7EA7;&#x4E0B;&#x9762;&#x7684;runnable&#x961F;&#x5217;&#x800C;&#x8A00;&#x7684;; &#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#x62A2;&#x5360;&#x4F4E;&#x4F18;&#x5148;&#x7EA7;&#x662F;&#x5B87;&#x5B99;&#x6CD5;&#x5219;, &#x6240;&#x6709;&#x8C03;&#x5EA6;&#x7B56;&#x7565;&#x5FC5;&#x987B;&#x90FD;&#x8981;&#x9075;&#x5B88;.</p>
<h2 id="&#x975E;&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;"><a name="&#x975E;&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;" class="anchor-navigation-ex-anchor" href="#&#x975E;&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;"><i class="fa fa-link" aria-hidden="true"></i></a>17.1. &#x975E;&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;</h2>
<p>SCHED_OTHER, SCHED_IDLE, SCHED_BATCH: &#x9759;&#x6001;&#x4F18;&#x5148;&#x7EA7;&#x662F;0</p>
<h2 id="&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;"><a name="&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;" class="anchor-navigation-ex-anchor" href="#&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;"><i class="fa fa-link" aria-hidden="true"></i></a>17.2. &#x5B9E;&#x65F6;&#x8C03;&#x5EA6;</h2>
<p>SCHED_FIFO, SCHED_RR: &#x9759;&#x6001;&#x4F18;&#x5148;&#x7EA7;&#x662F;1 - 99
SCHED_FIFO: &#x6CA1;&#x6709;&#x65F6;&#x95F4;&#x7247;, &#x4F4E;&#x4F18;&#x5148;&#x7EA7;&#x968F;&#x65F6;&#x88AB;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#x62A2;&#x5360;. &#x540C;&#x4E00;&#x4E2A;&#x4F18;&#x5148;&#x7EA7;&#x6309;&#x5148;&#x8FDB;&#x5148;&#x51FA;&#x6392;&#x961F;
SCHED_RR: &#x6709;&#x65F6;&#x95F4;&#x7247;, &#x6309;&#x65F6;&#x95F4;&#x7247;&#x8F6E;&#x8F6C;.</p>
<p>&#x5BF9;&#x4E8E;&#x5B9E;&#x65F6;&#x8C03;&#x5EA6;, &#x6240;&#x6709;&#x7684;&#x5B9E;&#x65F6;&#x4F18;&#x5148;&#x7EA7;&#x7EC4;&#x90FD;&#x5171;&#x4EAB;&#x4E09;&#x4E2A;&#x914D;&#x7F6E;:</p>
<ul>
<li>sched_rr_timeslice_ms : &#x7BA1;&#x8F6E;&#x8F6C;&#x7684;&#x65F6;&#x95F4;&#x7247;&#x7684;</li>
<li>sched_rt_period_us : &#x5B9E;&#x65F6;&#x4F18;&#x5148;&#x7EA7;&#x548C;&#x666E;&#x901A;&#x4F18;&#x5148;&#x7EA7;&#x7684;&#x603B;&#x65F6;&#x95F4;. &#x9ED8;&#x8BA4;1&#x79D2;. &#x5BF9;&#x5E94;100% CPU. </li>
<li>sched_rt_runtime_us : &#x53EF;&#x4EE5;&#x8BA4;&#x4E3A;&#x662F;&#x6240;&#x6709;&#x5B9E;&#x65F6;&#x4F18;&#x5148;&#x7EA7;&#x5360;&#x6BD4;. &#x9ED8;&#x8BA4;0.95&#x79D2;. &#x5373;95% CPU </li>
</ul>
<pre class="language-"><code class="lang-sh">~ <span class="token comment"># cat /proc/sys/kernel/sched_rr_timeslice_ms</span>
<span class="token number">10</span>
~ <span class="token comment"># cat /proc/sys/kernel/sched_rt_period_us</span>
<span class="token number">1000000</span>
~ <span class="token comment"># cat /proc/sys/kernel/sched_rt_runtime_us</span>
<span class="token number">950000</span>
~ <span class="token comment"># ls</span>
~ <span class="token comment"># zcat /proc/config.gz | grep -i empt</span>
<span class="token comment"># CONFIG_PREEMPT_NONE is not set</span>
<span class="token comment"># CONFIG_PREEMPT_VOLUNTARY is not set</span>
<span class="token assign-left variable">CONFIG_PREEMPT</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_PREEMPT_COUNT</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_PREEMPT_RCU</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_DEBUG_PREEMPT</span><span class="token operator">=</span>y
~ <span class="token comment"># zcat /proc/config.gz | grep -i hz</span>
<span class="token comment"># CONFIG_HZ_24 is not set</span>
<span class="token comment"># CONFIG_HZ_48 is not set</span>
<span class="token assign-left variable">CONFIG_HZ_100</span><span class="token operator">=</span>y
<span class="token comment"># CONFIG_HZ_128 is not set</span>
<span class="token comment"># CONFIG_HZ_250 is not set</span>
<span class="token comment"># CONFIG_HZ_256 is not set</span>
<span class="token comment"># CONFIG_HZ_1000 is not set</span>
<span class="token comment"># CONFIG_HZ_1024 is not set</span>
<span class="token assign-left variable">CONFIG_SYS_SUPPORTS_ARBIT_HZ</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_HZ</span><span class="token operator">=</span><span class="token number">100</span>
<span class="token assign-left variable">CONFIG_HZ_PERIODIC</span><span class="token operator">=</span>y
<span class="token comment"># CONFIG_NO_HZ_IDLE is not set</span>
<span class="token comment"># CONFIG_NO_HZ_FULL is not set</span>
<span class="token comment"># CONFIG_NO_HZ is not set</span>
</code></pre>
<p>&#x89E3;&#x91CA;&#x4E00;&#x4E0B;:</p>
<p>&#x51E0;&#x4E4E;&#x6240;&#x6709;&#x7684;moswa app &#x90FD;&#x662F;SCHED_RR, &#x9759;&#x6001;&#x5206;&#x914D;&#x4F18;&#x5148;&#x7EA7;; &#x540C;&#x4E00;&#x4E2A;&#x4F18;&#x5148;&#x7EA7;&#x5185;&#x6309;&#x65F6;&#x95F4;&#x7247;&#x8F6E;&#x8F6C;.</p>
<ul>
<li>&#x9ED8;&#x8BA4;&#x65F6;&#x95F4;&#x7247;10ms</li>
<li>&#x6240;&#x6709;&#x5B9E;&#x65F6;&#x4F18;&#x5148;&#x7EA7;&#x8FDB;&#x7A0B;&#x5360;CPU&#x6BD4;&#x4F8B;&#x4E0A;&#x9650; 95%<ul>
<li>&#x5373;&#x6709;5%&#x7684;CPU&#x7559;&#x7ED9;&#x4E86;&#x975E;&#x5B9E;&#x65F6;&#x4F18;&#x5148;&#x7EA7;, &#x76EE;&#x524D;&#x53EA;&#x6709;&#x5185;&#x6838;&#x7EBF;&#x7A0B;<code>loop* bio* ubi* spi1</code>&#x7B49;&#x51E0;&#x4E2A;&#x7EBF;&#x7A0B;&#x4EAB;&#x7528;</li>
<li>&#x8FD9;&#x4E2A;&#x4E0D;&#x5F52;cgroup&#x7BA1;, &#x4E5F;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;cgroup&#x7684;cg_base&#x6700;&#x5927;&#x53EA;&#x80FD;&#x914D;950000</li>
</ul>
</li>
<li>&#x76EE;&#x524D;&#x662F;&#x62A2;&#x5360;&#x5F0F;&#x8C03;&#x5EA6;, &#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x867D;&#x7136;5%&#x7559;&#x7ED9;&#x4E86;&#x975E;&#x5B9E;&#x65F6;&#x8FDB;&#x7A0B;, &#x4F46;&#x8FD9;&#x4E9B;&#x8FDB;&#x7A0B;&#x5927;&#x6982;&#x7387;&#x7ECF;&#x5E38;&#x88AB;&#x62A2;&#x5360;. &#x5E94;&#x8BE5;&#x8BF4;&#x7CFB;&#x7EDF;&#x8D8A;&#x5FD9;, &#x96EA;&#x5D29;&#x6548;&#x5E94;&#x8D8A;&#x660E;&#x663E;: &#x6709;&#x66F4;&#x591A;&#x7684;&#x62A2;&#x5360;&#x53D1;&#x751F;</li>
</ul>
<p>&#x63A8;&#x8350;&#x4F18;&#x5316;&#x601D;&#x8DEF;:</p>
<ul>
<li>&#x7981;&#x6B62;&#x5185;&#x6838;&#x62A2;&#x5360;CONFIG_PREEMPT=n&#x6216;&#x8005;CONFIG_PREEMPT_VOLUNTARY=y</li>
<li>&#x91CD;&#x65B0;&#x6574;&#x7406;&#x7CFB;&#x7EDF;&#x5B9E;&#x65F6;&#x8FDB;&#x7A0B;&#x548C;&#x975E;&#x5B9E;&#x65F6;&#x8FDB;&#x7A0B;&#x7B56;&#x7565;, &#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x7C97;&#x7CD9;&#x7684;&#x60F3;&#x6CD5;&#x662F;&#x4E1A;&#x52A1;&#x5904;&#x7406;&#x641E;SCHED_RR, &#x5E76;&#x4E14;&#x4E0D;&#x90A3;&#x4E48;&#x5728;&#x5185;&#x90E8;&#x7EC6;&#x5206;&#x4F18;&#x5148;&#x7EA7;, &#x6BD4;&#x5982;&#x6309;&#x4E1A;&#x52A1;&#x7EC4;&#x5B9A;&#x51E0;&#x4E2A;&#x5C31;&#x597D;&#x4E86;, &#x8BA9;&#x8C03;&#x5EA6;&#x5668;&#x53BB;&#x8F6E;&#x8F6C;&#x8C03;&#x5EA6;;
&#x5176;&#x4ED6;&#x8FDB;&#x7A0B;, &#x6BD4;&#x5982;ping, ssh, &#x5404;&#x79CD;&#x811A;&#x672C;&#x7684;&#x884D;&#x751F;&#x8FDB;&#x7A0B;, &#x975E;&#x6838;&#x5FC3;path&#x4E0B;&#x7684;eqpt&#x7B49;&#x8FDB;&#x7A0B;, &#x90FD;&#x653E;&#x5230;&#x975E;&#x5B9E;&#x65F6;</li>
<li>&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x589E;&#x5927;SCHED_RR&#x5230;100ms</li>
<li>&#x8C03;&#x6574;&#x5B9E;&#x65F6;&#x8FDB;&#x7A0B;&#x7EC4;&#x548C;&#x975E;&#x5B9E;&#x65F6;&#x8FDB;&#x7A0B;&#x7EC4;&#x7684;&#x6BD4;&#x4F8B;, &#x73B0;&#x5728;&#x662F;95% : 5%</li>
</ul>
<h1 id="preemptive-kernel&#x662F;&#x4EC0;&#x4E48;&#x610F;&#x601D;"><a name="preemptive-kernel&#x662F;&#x4EC0;&#x4E48;&#x610F;&#x601D;" class="anchor-navigation-ex-anchor" href="#preemptive-kernel&#x662F;&#x4EC0;&#x4E48;&#x610F;&#x601D;"><i class="fa fa-link" aria-hidden="true"></i></a>18. preemptive kernel&#x662F;&#x4EC0;&#x4E48;&#x610F;&#x601D;?</h1>
<p>&#x5185;&#x6838;&#x73B0;&#x5728;&#x6709;&#x4E09;&#x4E2A;&#x62A2;&#x5360;&#x6A21;&#x5F0F;:
<code>CONFIG_PREEMPT=y</code>&#x7684;&#x65F6;&#x5019;, &#x6253;&#x5F00;&#x5185;&#x6838;&#x62A2;&#x5360;; &#x4E3A;n&#x7684;&#x65F6;&#x5019;&#x5173;&#x95ED;&#x5185;&#x6838;&#x62A2;&#x5360;
&#x540E;&#x6765;&#x53C8;&#x52A0;&#x4E86;<code>CONFIG_PREEMPT_VOLUNTARY</code>, &#x610F;&#x601D;&#x662F;&#x4E3B;&#x52A8;&#x5728;&#x5185;&#x6838;&#x7279;&#x5B9A;&#x70B9;&#x53EF;&#x4EE5;&#x62A2;&#x5360;.</p>
<p>&#x62A2;&#x5360;&#x7684;&#x610F;&#x601D;&#x662F;&#x4F4E;&#x4F18;&#x5148;&#x7EA7;&#x88AB;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#x62A2;&#x5360;.</p>
<h2 id="&#x4E3A;&#x4EC0;&#x4E48;&#x4E00;&#x76F4;&#x8BF4;&#x5185;&#x6838;&#x62A2;&#x5360;"><a name="&#x4E3A;&#x4EC0;&#x4E48;&#x4E00;&#x76F4;&#x8BF4;&#x5185;&#x6838;&#x62A2;&#x5360;" class="anchor-navigation-ex-anchor" href="#&#x4E3A;&#x4EC0;&#x4E48;&#x4E00;&#x76F4;&#x8BF4;&#x5185;&#x6838;&#x62A2;&#x5360;"><i class="fa fa-link" aria-hidden="true"></i></a>18.1. &#x4E3A;&#x4EC0;&#x4E48;&#x4E00;&#x76F4;&#x8BF4;&#x5185;&#x6838;&#x62A2;&#x5360;?</h2>
<p>&#x7B54;: &#x56E0;&#x4E3A;&#x7528;&#x6237;&#x6001;&#x4EE3;&#x7801;&#x603B;&#x662F;&#x53EF;&#x4EE5;&#x88AB;&#x62A2;&#x5360;&#x7684;, &#x65E0;&#x8BBA;CONFIG_PREEMPT&#x600E;&#x4E48;&#x914D;&#x7F6E;. &#x4F8B;&#x5982;&#x7528;&#x6237;&#x6001;&#x4EE3;&#x7801;&#x7684;&#x6B7B;&#x5FAA;&#x73AF;&#x53D8;&#x91CF;&#x52A0;&#x4E00;, &#x4E5F;&#x662F;&#x6709;&#x65F6;&#x95F4;&#x7247;&#x7684;, &#x65F6;&#x95F4;&#x7247;&#x8017;&#x5C3D;&#x4E5F;&#x662F;&#x8981;&#x88AB;kernel&#x5207;&#x6362;&#x51FA;&#x53BB;&#x7684;.
&#x5185;&#x6838;&#x62A2;&#x5360;&#x8BF4;&#x7684;&#x662F;, &#x5F53;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x9677;&#x5165;&#x5230;&#x5185;&#x6838;&#x6001;, &#x4EE3;&#x8868;&#x8FD9;&#x4E2A;&#x8FDB;&#x884C;&#x8FD0;&#x884C;&#x7684;&#x5185;&#x6838;&#x4EE3;&#x7801;&#x80FD;&#x5426;&#x88AB;&#x62A2;&#x5360;. &#x5728;&#x53E4;&#x8001;&#x7684;kernel&#x7248;&#x672C;&#x91CC;&#x9762;, &#x5185;&#x6838;&#x6001;&#x4EE3;&#x7801;&#x662F;&#x4E0D;&#x80FD;&#x88AB;&#x62A2;&#x5360;&#x7684;. &#x540E;&#x6765;&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x5373;&#x4F7F;&#x54CD;&#x5E94;&#x684C;&#x9762;&#x7B49;UI&#x4E92;&#x52A8;&#x7B49;&#x573A;&#x666F;, &#x52A0;&#x5165;&#x4E86;&#x62A2;&#x5360;.
CONFIG_PREEMPT&#x7684;&#x89E3;&#x91CA;&#x5982;&#x4E0B;:</p>
<blockquote>
<p>This option reduces the latency of the kernel by making all kernel code (that is not executing in a critical section) preemptible. This allows reaction to interactive events by permitting a low priority process to be preempted involuntarily even if it is in kernel mode executing a system call and would otherwise not be about to reach a natural preemption point. This allows applications to run more &apos;smoothly&apos; even when the system is under load, at the cost of slightly lower throughput and a slight runtime overhead to kernel code.</p>
<p>Select this if you are building a kernel for a desktop or embedded system with latency requirements in the milliseconds range.</p>
</blockquote>
<h2 id="&#x5D4C;&#x5165;&#x5F0F;&#x8BBE;&#x5907;&#x9700;&#x8981;&#x62A2;&#x5360;&#x5417;"><a name="&#x5D4C;&#x5165;&#x5F0F;&#x8BBE;&#x5907;&#x9700;&#x8981;&#x62A2;&#x5360;&#x5417;" class="anchor-navigation-ex-anchor" href="#&#x5D4C;&#x5165;&#x5F0F;&#x8BBE;&#x5907;&#x9700;&#x8981;&#x62A2;&#x5360;&#x5417;"><i class="fa fa-link" aria-hidden="true"></i></a>18.2. &#x5D4C;&#x5165;&#x5F0F;&#x8BBE;&#x5907;&#x9700;&#x8981;&#x62A2;&#x5360;&#x5417;?</h2>
<p>&#x62A2;&#x5360;&#x4E3B;&#x8981;&#x662F;&#x7ED9;&#x7528;&#x6237;&#x4F53;&#x9A8C;&#x7528;&#x7684;, &#x6BD4;&#x5982;&#x7528;&#x6237;&#x7684;&#x9F20;&#x6807;&#x952E;&#x76D8;&#x5E0C;&#x671B;&#x80FD;&#x54CD;&#x5E94;&#x5FEB;&#x4E00;&#x70B9;. &#x5BF9;&#x65F6;&#x5EF6;&#x8981;&#x6C42;&#x9AD8;&#x7684;&#x7CFB;&#x7EDF;, &#x6BD4;&#x5982;&#x5DE5;&#x4E1A;&#x63A7;&#x5236;&#x7CFB;&#x7EDF;, &#x9700;&#x8981;&#x6253;&#x5F00;&#x5185;&#x6838;&#x62A2;&#x5360;. &#x800C;&#x4E00;&#x822C;&#x7684;&#x5D4C;&#x5165;&#x5F0F;&#x7CFB;&#x7EDF;, &#x5E94;&#x8BE5;&#x66F4;&#x8FFD;&#x6C42;&#x5904;&#x7406;&#x4E1A;&#x52A1;&#x7684;&#x541E;&#x5410;&#x91CF;, &#x6B64;&#x65F6;&#x4E0D;&#x62A2;&#x5360;&#x66F4;&#x5408;&#x9002;.
&#x4E00;&#x822C;&#x7684;x86&#x670D;&#x52A1;&#x5668;, &#x90FD;&#x5F00;&#x7684;&#x662F;<code>CONFIG_PREEMPT_VOLUNTARY=y</code>, &#x8FD9;&#x662F;&#x4E00;&#x79CD;&#x4ECB;&#x4E8E;&#x4E2D;&#x95F4;&#x7684;&#x72B6;&#x6001;.
<a href="https://www.codeblueprint.co.uk/2019/12/23/linux-preemption-latency-throughput.html" target="_blank">&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x5BF9;&#x6BD4;&#x8FC7;</a> <code>CONFIG_PREEMPT_VOLUNTARY</code>&#x6709;&#x5F88;&#x597D;&#x7684;&#x5E73;&#x8861;, &#x6240;&#x4EE5;&#x4E00;&#x822C;&#x7684;&#x4E3B;&#x6D41;OS(CentOS, Ubuntu, SUSE)&#x90FD;&#x9ED8;&#x8BA4;&#x6B64;&#x6A21;&#x5F0F;(&#x4F30;&#x8BA1;&#x662F;server&#x7248;&#x672C;).</p>
<h1 id="&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#x548C;ucontexh"><a name="&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#x548C;ucontexh" class="anchor-navigation-ex-anchor" href="#&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#x548C;ucontexh"><i class="fa fa-link" aria-hidden="true"></i></a>19. &#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#x548C;ucontex.h</h1>
<p>&#x53C2;&#x8003;:
<a href="https://www.jianshu.com/p/dfd7ac1402f0" target="_blank">&#x6211;&#x6240;&#x7406;&#x89E3;&#x7684;ucontext&#x65CF;&#x51FD;&#x6570;(&#x4E3B;&#x8981;&#x662F;&#x6982;&#x5FF5;&#x548C;&#x4F7F;&#x7528;)</a>
<a href="https://segmentfault.com/p/1210000009166339/read" target="_blank">&#x534F;&#x7A0B;&#xFF1A;posix::ucontext&#x7528;&#x6237;&#x7EA7;&#x7EBF;&#x7A0B;&#x5B9E;&#x73B0;&#x539F;&#x7406;&#x5206;&#x6790;(&#x5305;&#x62EC;&#x6C47;&#x7F16;&#x5B9E;&#x73B0;&#x539F;&#x7406;)</a></p>
<p>posix&#x63D0;&#x4F9B;&#x4E86;&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#x7684;API</p>
<pre class="language-"><code class="lang-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ucontext.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">getcontext</span><span class="token punctuation">(</span><span class="token class-name">ucontext_t</span> <span class="token operator">*</span>ucp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">setcontext</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">ucontext_t</span> <span class="token operator">*</span>ucp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">makecontext</span><span class="token punctuation">(</span><span class="token class-name">ucontext_t</span> <span class="token operator">*</span>ucp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">swapcontext</span><span class="token punctuation">(</span><span class="token class-name">ucontext_t</span> <span class="token operator">*</span>oucp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">ucontext_t</span> <span class="token operator">*</span>ucp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>man getcontext</code></p>
<h2 id="&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;"><a name="&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;" class="anchor-navigation-ex-anchor" href="#&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;"><i class="fa fa-link" aria-hidden="true"></i></a>19.1. &#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;</h2>
<p><code>ucontext_t</code>&#x63CF;&#x8FF0;&#x4E86;&#x7528;&#x6237;&#x6001;&#x4E0A;&#x4E0B;&#x6587;: &#x5176;&#x4E2D;<code>mcontext_t</code>&#x662F;&#x4E2A;&#x786C;&#x4EF6;&#x76F8;&#x5173;&#x7684;&#x7ED3;&#x6784;</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">ucontext_t</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">ucontext_t</span> <span class="token operator">*</span>uc_link<span class="token punctuation">;</span>
    <span class="token class-name">sigset_t</span>          uc_sigmask<span class="token punctuation">;</span>
    <span class="token class-name">stack_t</span>           uc_stack<span class="token punctuation">;</span>
    <span class="token class-name">mcontext_t</span>        uc_mcontext<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span> <span class="token class-name">ucontext_t</span><span class="token punctuation">;</span>
</code></pre>
<ul>
<li>getcontext()&#x51FD;&#x6570;&#x628A;&#x5F53;&#x524D;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x4FDD;&#x5B58;&#x5728;ucp&#x6307;&#x9488;&#x6307;&#x5411;&#x7684;ucontext_t&#x4E2D;</li>
<li>setcontext()&#x51FD;&#x6570;&#x6062;&#x590D;&#x5230;ucp&#x6307;&#x5411;&#x7684;&#x4E0A;&#x4E0B;&#x6587;, &#x7136;&#x540E;&#x4ECE;&#x90A3;&#x4E2A;&#x4E0A;&#x4E0B;&#x6587;&#x6267;&#x884C;. &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E0D;retrun. </li>
<li>makecontext()&#x51FD;&#x6570;&#x65B0;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x4E0A;&#x4E0B;&#x6587;, &#x5E76;&#x6307;&#x5B9A;&#x5728;&#x8FD9;&#x4E2A;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x6267;&#x884C;&#x7684;func</li>
<li>sighandler&#x4E5F;&#x53EF;&#x4EE5;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x4E0A;&#x4E0B;&#x6587;</li>
</ul>
<h2 id="&#x4F8B;&#x5B50;"><a name="&#x4F8B;&#x5B50;" class="anchor-navigation-ex-anchor" href="#&#x4F8B;&#x5B50;"><i class="fa fa-link" aria-hidden="true"></i></a>19.2. &#x4F8B;&#x5B50;</h2>
<p>&#x4E0B;&#x9762;&#x7684;&#x7A0B;&#x5E8F;&#x4E0D;&#x65AD;&#x6253;&#x5370;&quot;hello world&quot;
&#x56E0;&#x4E3A;&#x7B2C;10&#x884C;&#x8F6C;&#x800C;&#x5728;&#x7B2C;7&#x884C;&#x4FDD;&#x5B58;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x6267;&#x884C;, &#x6548;&#x679C;&#x5C31;&#x50CF;&#x76F4;&#x63A5;goto&#x5230;&#x7B2C;8&#x884C;&#x4E00;&#x6837;.</p>
<pre class="language-"><code class="lang-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ucontext.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> </span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span> 
  <span class="token class-name">ucontext_t</span> context<span class="token punctuation">;</span> 
  <span class="token function">getcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token function">setcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x4F7F;&#x7528;ucontexth&#x7684;api&#x5B9E;&#x73B0;&#x7528;&#x6237;&#x6001;&#x534F;&#x7A0B;"><a name="&#x4F7F;&#x7528;ucontexth&#x7684;api&#x5B9E;&#x73B0;&#x7528;&#x6237;&#x6001;&#x534F;&#x7A0B;" class="anchor-navigation-ex-anchor" href="#&#x4F7F;&#x7528;ucontexth&#x7684;api&#x5B9E;&#x73B0;&#x7528;&#x6237;&#x6001;&#x534F;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a>19.3. &#x4F7F;&#x7528;ucontext.h&#x7684;api&#x5B9E;&#x73B0;&#x7528;&#x6237;&#x6001;&#x534F;&#x7A0B;</h2>
<p><a href="https://www.jianshu.com/p/4f7d3aa83088" target="_blank">&#x57FA;&#x4E8E;ucontext.h&#x7684;&#x8F7B;&#x91CF;&#x7EA7;&#x534F;&#x7A0B;&#x5E93;</a></p>
<ul>
<li><strong>&#x534F;&#x7A0B;</strong>&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x4E00;&#x79CD;<strong>&#x7528;&#x6237;&#x6001;&#x7684;&#x8F7B;&#x91CF;&#x7EA7;&#x7EBF;&#x7A0B;</strong>, &#x5207;&#x6362;&#x7531;&#x7528;&#x6237;&#x5B9A;&#x4E49;</li>
<li>&#x534F;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#x5F88;&#x5FEB;, &#x56E0;&#x4E3A;&#x4E0D;&#x4F1A;&#x9677;&#x5165;&#x5185;&#x6838;&#x6001;</li>
<li><strong>&#x534F;&#x7A0B;&#x62E5;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x4E0A;&#x4E0B;&#x6587;&#x548C;&#x6808;</strong>, &#x534F;&#x7A0B;&#x8C03;&#x5EA6;&#x5207;&#x6362;&#x65F6;&#xFF0C;&#x5C06;&#x5BC4;&#x5B58;&#x5668;&#x4E0A;&#x4E0B;&#x6587;&#x548C;&#x6808;&#x4FDD;&#x5B58;&#x5230;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#xFF0C;&#x5728;&#x5207;&#x6362;&#x56DE;&#x6765;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6062;&#x590D;&#x5148;&#x524D;&#x4FDD;&#x5B58;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x4E0A;&#x4E0B;&#x6587;&#x548C;&#x6808;</li>
<li>&#x534F;&#x7A0B;&#x5177;&#x6709;<strong>&#x6781;&#x9AD8;&#x7684;&#x6267;&#x884C;&#x6548;&#x7387;</strong> &#x56E0;&#x4E3A;&#x5B50;&#x7A0B;&#x5E8F;&#x5207;&#x6362;&#x4E0D;&#x662F;&#x7EBF;&#x7A0B;&#x5207;&#x6362;&#xFF0C;&#x662F;&#x7531;&#x7A0B;&#x5E8F;&#x81EA;&#x8EAB;&#x63A7;&#x5236;&#xFF0C;&#x56E0;&#x6B64;<strong>&#x534F;&#x7A0B;&#x6CA1;&#x6709;&#x7EBF;&#x7A0B;&#x5207;&#x6362;&#x7684;&#x5F00;&#x9500;</strong>, <strong>&#x591A;&#x7EBF;&#x7A0B;&#x7684;&#x7EBF;&#x7A0B;&#x6570;&#x91CF;&#x8D8A;&#x591A;&#xFF0C;&#x534F;&#x7A0B;&#x7684;&#x6027;&#x80FD;&#x4F18;&#x52BF;&#x5C31;&#x8D8A;&#x660E;&#x663E;</strong></li>
<li><strong>&#x8BBF;&#x95EE;&#x5171;&#x4EAB;&#x8D44;&#x6E90;&#x4E0D;&#x9700;&#x8981;&#x591A;&#x7EBF;&#x7A0B;&#x7684;&#x9501;&#x673A;&#x5236;</strong>, &#x56E0;&#x4E3A;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;, &#x4E5F;&#x4E0D;&#x5B58;&#x5728;&#x540C;&#x65F6;&#x5199;&#x53D8;&#x91CF;&#x51B2;&#x7A81;, &#x6240;&#x4EE5;&#x5728;&#x534F;&#x7A0B;&#x4E2D;&#x63A7;&#x5236;&#x5171;&#x4EAB;&#x8D44;&#x6E90;&#x65E0;&#x9700;&#x52A0;&#x9501;, &#x53EA;&#x9700;&#x8981;&#x5224;&#x65AD;&#x72B6;&#x6001;&#x5C31;&#x597D;&#x4E86;&#xFF0C;&#x6267;&#x884C;&#x6548;&#x7387;&#x6BD4;&#x591A;&#x7EBF;&#x7A0B;&#x9AD8;&#x5F88;&#x591A;, &#x800C;&#x4E14;&#x4EE3;&#x7801;&#x7F16;&#x5199;&#x96BE;&#x5EA6;&#x4E5F;&#x53EF;&#x4EE5;&#x76F8;&#x5E94;&#x964D;&#x4F4E;</li>
<li>&#x4EE5;&#x540C;&#x6B65;&#x4EE3;&#x7801;&#x7684;&#x65B9;&#x5F0F;&#x5199;&#x5F02;&#x6B65;&#x903B;&#x8F91;</li>
<li>&#x65E0;&#x6CD5;&#x5229;&#x7528;&#x591A;&#x6838;&#x8D44;&#x6E90;, &#x9664;&#x975E;&#x548C;&#x591A;&#x8FDB;&#x7A0B;&#x914D;&#x5408;</li>
</ul>
<h1 id="&#x591A;&#x7EBF;&#x7A0B;&#x7684;&#x60C5;&#x51B5;&#x4E0B;-signal&#x88AB;deliver&#x5230;&#x54EA;&#x4E2A;&#x7EBF;&#x7A0B;"><a name="&#x591A;&#x7EBF;&#x7A0B;&#x7684;&#x60C5;&#x51B5;&#x4E0B;-signal&#x88AB;deliver&#x5230;&#x54EA;&#x4E2A;&#x7EBF;&#x7A0B;" class="anchor-navigation-ex-anchor" href="#&#x591A;&#x7EBF;&#x7A0B;&#x7684;&#x60C5;&#x51B5;&#x4E0B;-signal&#x88AB;deliver&#x5230;&#x54EA;&#x4E2A;&#x7EBF;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a>20. &#x591A;&#x7EBF;&#x7A0B;&#x7684;&#x60C5;&#x51B5;&#x4E0B;, signal&#x88AB;deliver&#x5230;&#x54EA;&#x4E2A;&#x7EBF;&#x7A0B;?</h1>
<p>&#x95EE;&#x7B54;: <a href="https://stackoverflow.com/questions/11679568/signal-handling-with-multiple-threads-in-linux" target="_blank">https://stackoverflow.com/questions/11679568/signal-handling-with-multiple-threads-in-linux</a></p>
<p>&#x5148;&#x51C6;&#x5907;&#x51E0;&#x4E2A;&#x77E5;&#x8BC6;:</p>
<ul>
<li>&#x6240;&#x6709;&#x7EBF;&#x7A0B;&#x90FD;&#x5728;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x7A7A;&#x95F4;</li>
<li>signal&#x90FD;&#x662F;&#x5148;&#x5165;queue, &#x5F85;&#x7EBF;&#x7A0B;&#x88AB;&#x8C03;&#x5EA6;&#x5230;&#x8FD0;&#x884C;&#x65F6;&#x518D;&#x6267;&#x884C;&#x7684;.</li>
<li>signal&#x662F;&#x5171;&#x4EAB;&#x7684;, &#x4F46;&#x6BCF;&#x4E2A;thread&#x53EF;&#x4EE5;&#x6709;&#x81EA;&#x5DF1;&#x7684;mask<a href="http://man7.org/linux/man-pages/man3/pthread_sigmask.3.html" target="_blank"><code>pthread_sigmask(3)</code></a></li>
</ul>
<p>&#x5185;&#x6838;&#x91CC;deliver signal&#x7684;&#x4EE3;&#x7801;:</p>
<pre class="language-"><code class="lang-c"><span class="token comment">/*
 * Now find a thread we can wake up to take the signal off the queue.
 *
 * If the main thread wants the signal, it gets first crack.
 * Probably the least surprising to the average bear.
 */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">wants_signal</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span>
        t <span class="token operator">=</span> p<span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>group <span class="token operator">||</span> <span class="token function">thread_group_empty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">/*
         * There is just one thread and it does not need to be woken.
         * It will dequeue unblocked signals before it runs again.
         */</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
         * Otherwise try to find a suitable thread.
         */</span>
        t <span class="token operator">=</span> signal<span class="token operator">-&gt;</span>curr_target<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wants_signal</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                t <span class="token operator">=</span> <span class="token function">next_thread</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> signal<span class="token operator">-&gt;</span>curr_target<span class="token punctuation">)</span>
                        <span class="token comment">/*
                         * No thread needs to be woken.
                         * Any eligible threads will see
                         * the signal in the queue soon.
                         */</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        signal<span class="token operator">-&gt;</span>curr_target <span class="token operator">=</span> t<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Found a killable thread.  If the signal will be fatal,
 * then start taking the whole group down immediately.
 */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sig_fatal</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> sig<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token punctuation">(</span>signal<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> SIGNAL_GROUP_EXIT<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token operator">-&gt;</span>real_blocked<span class="token punctuation">,</span> sig<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>sig <span class="token operator">==</span> SIGKILL <span class="token operator">||</span> <span class="token operator">!</span>p<span class="token operator">-&gt;</span>ptrace<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
         * This signal will be fatal to the whole group.
         */</span>
</code></pre>
<p>&#x7ED3;&#x8BBA;:</p>
<ul>
<li>&#x9ED8;&#x8BA4;&#x662F;deliver&#x7ED9;main thread, &#x5982;&#x679C;main thread&#x4E0D;want&#x8FD9;&#x4E2A;signal, &#x5C31;&#x5C1D;&#x8BD5;&#x4E0B;&#x4E00;&#x4E2A;thread</li>
<li>&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x7528;<a href="http://man7.org/linux/man-pages/man3/pthread_sigmask.3.html" target="_blank"><code>pthread_sigmask(3)</code></a>&#x8BBE;&#x7F6E;thread&#x7684;mask, &#x4ECE;&#x800C;&#x8BA9;signal&#x88AB;deliver&#x5230;&#x7279;&#x5B9A;&#x7684;thread.</li>
<li>&#x53EF;&#x4EE5;&#x5411;&#x6307;&#x5B9A;&#x7684;thread&#x53D1;signal. &#x89C1;<code>pthread_kill(3)</code> <code>tgkill(2)</code></li>
<li>&#x4E00;&#x4E9B;&#x540C;&#x6B65;&#x5F02;&#x5E38;, &#x6BD4;&#x5982;SIGSEGV&#x548C;SIGFPE, &#x662F;&#x7531;&#x5F53;&#x524D;thread&#x7684;&#x67D0;&#x4E2A;&#x6307;&#x4EE4;&#x5F15;&#x8D77;&#x7684;, &#x90A3;&#x4E48;signal&#x5C31;&#x76F4;&#x63A5;&#x88AB;deliver&#x5230;&#x8FD9;&#x4E2A;&#x7EBF;&#x7A0B;.</li>
<li>&#x6709;&#x4E9B;signal&#x662F;&#x4EE5;&#x8FDB;&#x7A0B;&#x4E3A;&#x5355;&#x4F4D;&#x4EA7;&#x751F;&#x7684;, &#x7406;&#x8BBA;&#x4E0A;&#x4F1A;&#x88AB;deliver&#x5230;&#x4EFB;&#x610F;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;. &#x4F46;&#x53C2;&#x8003;&#x7B2C;&#x4E00;&#x6761;, &#x901A;&#x5E38;&#x662F;deliver&#x5230;main thread.</li>
</ul>
<h1 id="&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x662F;&#x4EC0;&#x4E48;-&#x4E3A;&#x4EC0;&#x4E48;&#x80FD;&#x6253;&#x5370;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#x6808;"><a name="&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x662F;&#x4EC0;&#x4E48;-&#x4E3A;&#x4EC0;&#x4E48;&#x80FD;&#x6253;&#x5370;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#x6808;" class="anchor-navigation-ex-anchor" href="#&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x662F;&#x4EC0;&#x4E48;-&#x4E3A;&#x4EC0;&#x4E48;&#x80FD;&#x6253;&#x5370;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#x6808;"><i class="fa fa-link" aria-hidden="true"></i></a>21. &#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x662F;&#x4EC0;&#x4E48;? &#x4E3A;&#x4EC0;&#x4E48;&#x80FD;&#x6253;&#x5370;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#x6808;?</h1>
<p>&#x76EE;&#x524D;&#x5DF2;&#x77E5;&#x7684;&#x77E5;&#x8BC6;, &#x4EE5;golang&#x7684;signal&#x5904;&#x7406;&#x4E3A;&#x4F8B;:</p>
<ul>
<li>SIGKILL and SIGSTOP&#x4E0D;&#x80FD;&#x88AB;&#x6355;&#x83B7;</li>
<li>&#x540C;&#x6B65;&#x7684;signal, &#x4E00;&#x822C;&#x662F;SIGBUS, SIGFPE, and SIGSEGV, &#x662F;&#x7531;&#x6B63;&#x5728;&#x6267;&#x884C;&#x7684;go&#x7A0B;&#x5E8F;&#x5F15;&#x8D77;&#x7684; 
&#x5728;go&#x91CC;, &#x8FD9;&#x4E9B;signal&#x88AB;&#x8F6C;&#x6362;&#x4E3A;&#x8FD0;&#x884C;&#x65F6;&#x7684;panic</li>
<li>&#x5269;&#x4E0B;&#x7684;signal, &#x662F;&#x5176;&#x4ED6;&#x8FDB;&#x7A0B;&#x5F02;&#x6B65;&#x901A;&#x77E5;&#x7684;signal, &#x7528;os/signal&#x5305;&#x6765;&#x5904;&#x7406;</li>
</ul>
<p>&#x7ECF;&#x8FC7;&#x5B9E;&#x9A8C;&#x5F97;&#x5230;&#x7684;&#x73B0;&#x8C61;, &#x8FD8;&#x662F;&#x4EE5;golang&#x4E3A;&#x4F8B;:</p>
<ul>
<li>case 1: &#x5BF9;&#x4E8E;&#x4E00;&#x4E2A;&#x7EAF;&#x7528;&#x6237;&#x6001;&#x5FAA;&#x73AF;, ctrl+c(SIGINT)&#x80FD;&#x591F;&#x7ACB;&#x5373;&#x7EC8;&#x6B62;&#x8BE5;&#x8FDB;&#x7A0B;</li>
</ul>
<pre class="language-"><code class="lang-go">    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x4ECE;shell&#x6267;&#x884C;<code>kill -SIGQUIT</code>&#x547D;&#x4EE4;&#x53D1;&#x9001;SIGQUIT&#x4FE1;&#x53F7;&#x7ED9;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;, &#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x7684;call stack&#x80FD;&#x7CBE;&#x786E;&#x5B9A;&#x4F4D;&#x5230;for&#x5FAA;&#x73AF;&#x91CC;&#x7684;<code>i++</code>&#x90A3;&#x4E00;&#x884C;</p>
<pre class="language-"><code class="lang-sh">$ ./signal 
hello
^<span class="token punctuation">\</span>SIGQUIT: quit
<span class="token assign-left variable">PC</span><span class="token operator">=</span>0x48cfd5 <span class="token assign-left variable">m</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">sigcode</span><span class="token operator">=</span><span class="token number">128</span>

goroutine <span class="token number">1</span> <span class="token punctuation">[</span>running<span class="token punctuation">]</span>:
main.main<span class="token punctuation">(</span><span class="token punctuation">)</span>
        /repo/yingjieb/godev/practice/src/signal/main.go:15 +0x75 <span class="token assign-left variable">fp</span><span class="token operator">=</span>0xc0000aef60 <span class="token assign-left variable">sp</span><span class="token operator">=</span>0xc0000aef00 <span class="token assign-left variable">pc</span><span class="token operator">=</span>0x48cfd5
runtime.main<span class="token punctuation">(</span><span class="token punctuation">)</span>
        /usr/local/go/src/runtime/proc.go:203 +0x206 <span class="token assign-left variable">fp</span><span class="token operator">=</span>0xc0000aefe0 <span class="token assign-left variable">sp</span><span class="token operator">=</span>0xc0000aef60 <span class="token assign-left variable">pc</span><span class="token operator">=</span>0x42b136
runtime.goexit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        /usr/local/go/src/runtime/asm_amd64.s:1357 +0x1 <span class="token assign-left variable">fp</span><span class="token operator">=</span>0xc0000aefe8 <span class="token assign-left variable">sp</span><span class="token operator">=</span>0xc0000aefe0 <span class="token assign-left variable">pc</span><span class="token operator">=</span>0x453651
</code></pre>
<ul>
<li>case 2: &#x5BF9;&#x4E0A;&#x9762;&#x7684;for&#x7A0D;&#x52A0;&#x4E00;&#x53E5;sleep<pre class="language-"><code class="lang-go">  <span class="token keyword">for</span> <span class="token punctuation">{</span>
      i<span class="token operator">++</span>
      time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre>
&#x53D1;&#x9001;SIGQUIT&#x4E5F;&#x4E00;&#x6837;&#x80FD;&#x591F;<strong>&#x7ACB;&#x5373;</strong>&#x6253;&#x5370;&#x8C03;&#x7528;&#x6808;; &#x4E0D;&#x610F;&#x5916;&#x7684;, ctrl+c&#x4E5F;&#x80FD;&#x591F;&#x7ACB;&#x5373;&#x7EC8;&#x6B62;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;. 
&#x90FD;&#x4E0D;&#x53D7;sleep&#x7684;&#x5E72;&#x6270;.
&#x8C03;&#x7528;&#x6808;&#x663E;&#x793A;&#x4E24;&#x4E2A;goroutine(&#x5B9E;&#x9645;&#x4E0A;, &#x5982;&#x679C;&#x6709;&#x73AF;&#x5883;&#x53D8;&#x91CF;GOTRACEBACK=system, &#x80FD;&#x663E;&#x793A;&#x66F4;&#x591A;goroutine), sleep&#x7684;&#x8C03;&#x7528;&#x6808;&#x5C31;&#x662F;main&#x7A0B;&#x5E8F;&#x5F53;&#x524D;&#x7684;&#x4EE3;&#x7801;.</li>
</ul>
<p>&#x7ED3;&#x5408;&#x4EE3;&#x7801;&#x548C;&#x73B0;&#x8C61;&#x6765;&#x770B;, &#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x5728;&#x6536;&#x5230;SIGQUIT&#x65F6;, &#x5927;&#x6982;&#x7387;&#x662F;&#x5728;sleep, &#x6CA1;&#x6709;&#x5728;&#x8FD0;&#x884C;. &#x8FD9;&#x65F6;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x53D1;&#x73B0;&#x6709;&#x4EBA;&#x53D1;&#x9001;SIGQUIT&#x7ED9;&#x8BE5;&#x8FDB;&#x7A0B;, &#x5C31;&#x6267;&#x884C;&#x8BE5;&#x8FDB;&#x7A0B;&#x7684;sighandler. &#x5728;&#x672C;&#x4F8B;&#x4E2D;, &#x8FD9;&#x4E2A;sighandler&#x5C31;&#x662F;golang&#x9ED8;&#x8BA4;&#x7684;&#x5904;&#x7406;.</p>
<pre class="language-"><code class="lang-sh">$ ./signal 
hello
^<span class="token punctuation">\</span>SIGQUIT: quit
<span class="token assign-left variable">PC</span><span class="token operator">=</span>0x455813 <span class="token assign-left variable">m</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">sigcode</span><span class="token operator">=</span><span class="token number">128</span>

goroutine <span class="token number">6</span> <span class="token punctuation">[</span>syscall<span class="token punctuation">]</span>:
runtime.notetsleepg<span class="token punctuation">(</span>0x5613a0, 0x2540bc392, 0x0<span class="token punctuation">)</span>
        /usr/local/go/src/runtime/lock_futex.go:227 +0x34 <span class="token assign-left variable">fp</span><span class="token operator">=</span>0xc000064760 <span class="token assign-left variable">sp</span><span class="token operator">=</span>0xc000064730 <span class="token assign-left variable">pc</span><span class="token operator">=</span>0x409d04
runtime.timerproc<span class="token punctuation">(</span>0x561380<span class="token punctuation">)</span>
        /usr/local/go/src/runtime/time.go:311 +0x2f1 <span class="token assign-left variable">fp</span><span class="token operator">=</span>0xc0000647d8 <span class="token assign-left variable">sp</span><span class="token operator">=</span>0xc000064760 <span class="token assign-left variable">pc</span><span class="token operator">=</span>0x4450b1
runtime.goexit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        /usr/local/go/src/runtime/asm_amd64.s:1357 +0x1 <span class="token assign-left variable">fp</span><span class="token operator">=</span>0xc0000647e0 <span class="token assign-left variable">sp</span><span class="token operator">=</span>0xc0000647d8 <span class="token assign-left variable">pc</span><span class="token operator">=</span>0x453911
created by runtime.<span class="token punctuation">(</span>*timersBucket<span class="token punctuation">)</span>.addtimerLocked
        /usr/local/go/src/runtime/time.go:169 +0x10e

goroutine <span class="token number">1</span> <span class="token punctuation">[</span>sleep<span class="token punctuation">]</span>:
runtime.goparkunlock<span class="token punctuation">(</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span>
        /usr/local/go/src/runtime/proc.go:310
time.Sleep<span class="token punctuation">(</span>0x2540be400<span class="token punctuation">)</span>
        /usr/local/go/src/runtime/time.go:105 +0x157
main.main<span class="token punctuation">(</span><span class="token punctuation">)</span>
        /repo/yingjieb/godev/practice/src/signal/main.go:24 +0x88
</code></pre>
<p>golang&#x5BF9;&#x4E8E;&#x5404;&#x79CD;signal, &#x90FD;&#x6709;&#x9ED8;&#x8BA4;&#x7684;sighandler, &#x90A3;&#x4E48;&#x5982;&#x6807;&#x9898;&#x7684;&#x95EE;&#x9898;</p>
<ul>
<li>sighandler&#x4E00;&#x822C;&#x88AB;&#x8BA4;&#x4E3A;&#x662F;<strong>&#x5F02;&#x6B65;</strong>&#x7684;&#x65B9;&#x5F0F;&#x6267;&#x884C;, &#x548C;&#x6B63;&#x5E38;&#x7684;&#x8FDB;&#x7A0B;&#x4EE3;&#x7801;&#x662F;&#x4E24;&#x56DE;&#x4E8B;. &#x90A3;&#x4E48;sighandler&#x7A76;&#x7ADF;&#x662F;&#x5728;&#x4EC0;&#x4E48;&#x4E0A;&#x4E0B;&#x6587;&#x6267;&#x884C;&#x7684;?</li>
<li>&#x4EE5;SIGQUIT&#x7684;handler&#x4E3A;&#x4F8B;, &#x4E3A;&#x4EC0;&#x4E48;&#x4E00;&#x4E2A;&#x5F02;&#x6B65;&#x6267;&#x884C;&#x7684;handler, &#x80FD;&#x591F;&#x77E5;&#x9053;&#x6B63;&#x5E38;&#x4EE3;&#x7801;&#x7684;&#x8C03;&#x7528;&#x6808;?</li>
<li>&#x7ED3;&#x5408;case 1&#x548C;2, sighandler&#x88AB;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x673A;&#x662F;&#x600E;&#x6837;&#x7684;? case 2&#x4E2D;, &#x5927;&#x6982;&#x7387;&#x662F;&#x5728;&#x8FDB;&#x7A0B;&#x6CA1;&#x6709;&#x88AB;&#x6267;&#x884C;&#x7684;&#x65F6;&#x5019;&#x53D1;&#x751F;&#x4E86;SIGQUIT. &#x4F46;case 1&#x4E2D;, &#x8FDB;&#x7A0B;&#x6B7B;&#x5FAA;&#x73AF;&#x505A;<code>i++</code>, &#x4F1A;&#x7528;&#x5C3D;&#x8C03;&#x5EA6;&#x5668;&#x5206;&#x7ED9;&#x5B83;&#x7684;&#x65F6;&#x95F4;&#x7247;. &#x90A3;&#x4E48;sighandler&#x53C8;&#x662F;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x6267;&#x884C;&#x5462;?</li>
</ul>
<h2 id="sighandler&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;"><a name="sighandler&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;" class="anchor-navigation-ex-anchor" href="#sighandler&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;"><i class="fa fa-link" aria-hidden="true"></i></a>21.1. sighandler&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;</h2>
<blockquote>
<p>&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x5728;&#x7528;&#x6237;&#x6001;&#x65F6;-&gt;&#x8FDB;&#x7A0B;&#x7531;&#x4E8E;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6216;&#x4E2D;&#x65AD;&#x8FDB;&#x5165;&#x5185;&#x6838;-&gt;&#x8F6C;&#x5411;&#x7528;&#x6237;&#x6001;&#x6267;&#x884C;&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;-&gt;&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;&#x5B8C;&#x6BD5;&#x540E;&#x8FDB;&#x5165;&#x5185;&#x6838;-&gt;&#x8FD4;&#x56DE;&#x7528;&#x6237;&#x6001;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x7A0B;&#x5E8F;<br>&#x9996;&#x5148;&#x7A0B;&#x5E8F;&#x6267;&#x884C;&#x5728;&#x7528;&#x6237;&#x6001;&#xFF0C;&#x5728;&#x8FDB;&#x7A0B;&#x9677;&#x5165;&#x5185;&#x6838;&#x5E76;&#x4ECE;&#x5185;&#x6838;&#x8FD4;&#x56DE;&#x7684;&#x524D;&#x5915;&#xFF0C;&#x4F1A;&#x53BB;&#x68C0;&#x67E5;&#x6709;&#x6CA1;&#x6709;&#x4FE1;&#x53F7;&#x6CA1;&#x6709;&#x88AB;&#x5904;&#x7406;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x4E14;&#x6CA1;&#x6709;&#x88AB;&#x963B;&#x585E;&#x5C31;&#x4F1A;&#x8C03;&#x7528;&#x76F8;&#x5E94;&#x7684;&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x53BB;&#x5904;&#x7406;&#x3002;&#x9996;&#x5148;&#xFF0C;&#x5185;&#x6838;&#x5728;&#x7528;&#x6237;&#x6808;&#x4E0A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5C42;&#xFF0C;&#x8BE5;&#x5C42;&#x4E2D;&#x5C06;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x8BBE;&#x7F6E;&#x6210;&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x8FD9;&#x6837;&#xFF0C;&#x4ECE;&#x5185;&#x6838;&#x8FD4;&#x56DE;&#x7528;&#x6237;&#x6001;&#x65F6;&#xFF0C;&#x5C31;&#x4F1A;&#x6267;&#x884C;&#x8FD9;&#x4E2A;&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;&#x3002;&#x5F53;&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;&#x6267;&#x884C;&#x5B8C;&#xFF0C;&#x4F1A;&#x518D;&#x6B21;&#x8FDB;&#x5165;&#x5185;&#x6838;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x68C0;&#x6D4B;&#x6709;&#x6CA1;&#x6709;&#x4FE1;&#x53F7;&#x6CA1;&#x6709;&#x5904;&#x7406;&#xFF0C;&#x4EE5;&#x53CA;&#x6062;&#x590D;&#x539F;&#x5148;&#x7A0B;&#x5E8F;&#x4E2D;&#x65AD;&#x6267;&#x884C;&#x70B9;&#xFF0C;&#x6062;&#x590D;&#x5185;&#x6838;&#x6808;&#x7B49;&#x5DE5;&#x4F5C;&#xFF0C;&#x8FD9;&#x6837;&#xFF0C;&#x5F53;&#x4ECE;&#x5185;&#x6838;&#x8FD4;&#x56DE;&#x540E;&#x4FBF;&#x8FD4;&#x56DE;&#x5230;&#x539F;&#x5148;&#x7A0B;&#x5E8F;&#x6267;&#x884C;&#x7684;&#x5730;&#x65B9;&#x4E86;&#x3002;</p>
</blockquote>
<p>&#x5173;&#x952E;&#x70B9;&#x5728;kernel&#x5728;&#x6536;&#x5230;signal&#x7684;&#x65F6;&#x5019;, &#x4F1A;&#x5728;&#x7528;&#x6237;&#x6808;&#x4E0A;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x6808;&#x5E27;, &#x4F5C;&#x7528;&#x662F;&#x7ED9;sighandler&#x63D0;&#x4F9B;&#x8FD0;&#x884C;&#x4E0A;&#x4E0B;&#x6587;. &#x6211;&#x7406;&#x89E3;, &#x5982;&#x679C;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x6B63;&#x5728;&#x8FD0;&#x884C;(&#x5728;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x6838;&#x4E0A;), &#x5185;&#x6838;&#x5E94;&#x8BE5;&#x4F1A;&#x628A;&#x5B83;&#x8C03;&#x5EA6;&#x51FA;&#x53BB;, &#x518D;&#x5EFA;&#x7ACB;sighandler&#x7684;&#x6808;&#x5E27;.</p>
<h3 id="sigaltstack&#x51FD;&#x6570;&#x7528;&#x4E8E;&#x6307;&#x5B9A;sighandler&#x6808;"><a name="sigaltstack&#x51FD;&#x6570;&#x7528;&#x4E8E;&#x6307;&#x5B9A;sighandler&#x6808;" class="anchor-navigation-ex-anchor" href="#sigaltstack&#x51FD;&#x6570;&#x7528;&#x4E8E;&#x6307;&#x5B9A;sighandler&#x6808;"><i class="fa fa-link" aria-hidden="true"></i></a>21.1.1. sigaltstack&#x51FD;&#x6570;&#x7528;&#x4E8E;&#x6307;&#x5B9A;sighandler&#x6808;</h3>
<p><code>man sigaltstack</code>&#x89E3;&#x91CA;&#x5230;: <code>sigaltstack</code>&#x7528;&#x4E8E;&#x663E;&#x5F0F;&#x5EFA;&#x7ACB;&#x4E00;&#x4E2A;&#x6808;&#x5E27;. &#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;, kernel&#x4F1A;&#x5728;&#x7528;&#x6237;&#x6808;&#x4E0A;&#x5EFA;&#x7ACB;&#x8FD9;&#x4E2A;&#x6808;&#x5E27;, &#x4F46;&#x5BF9;&#x4E8E;&#x7528;&#x6237;&#x6808;&#x6EA2;&#x51FA;&#x9020;&#x6210;&#x7684;SIGSEGV&#x7684;&#x60C5;&#x51B5;, &#x5728;&#x7528;&#x6237;&#x6808;&#x4E0A;&#x7684;sighandler&#x4E5F;&#x5C31;&#x4E0D;&#x80FD;&#x6267;&#x884C;&#x4E86;. <code>sigaltstack()</code>&#x51FD;&#x6570;&#x7528;&#x4E8E;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;, &#x5728;&#x522B;&#x5904;&#x6307;&#x5B9A;&#x8FD9;&#x4E2A;&#x6808;&#x5E27;.</p>
<pre class="language-"><code class="lang-c">       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">sigaltstack</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">stack_t</span> <span class="token operator">*</span>ss<span class="token punctuation">,</span> <span class="token class-name">stack_t</span> <span class="token operator">*</span>old_ss<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<blockquote>
<p>The  most common usage of an alternate signal stack is to handle the SIGSEGV signal that is generated if the space available for the normal process stack is exhausted: in this case, a signal handler for SIGSEGV cannot be invoked on the process stack; if we wish to handle it, we must use an alternate signal stack.
Establishing an alternate signal stack is useful if a process expects that it may exhaust its standard stack.  This may occur, for example, because the stack  grows  so  large that  it  encounters  the upwardly growing heap, or it reaches a limit established by a call to setrlimit(RLIMIT_STACK, &amp;rlim).  If the standard stack is exhausted, the kernel sends the process a SIGSEGV signal.  In these circumstances the only way to catch this signal is on an alternate signal stack.</p>
</blockquote>
<h2 id="&#x56DE;&#x7B54;"><a name="&#x56DE;&#x7B54;" class="anchor-navigation-ex-anchor" href="#&#x56DE;&#x7B54;"><i class="fa fa-link" aria-hidden="true"></i></a>21.2. &#x56DE;&#x7B54;</h2>
<ul>
<li>sighandler&#x4E00;&#x822C;&#x88AB;&#x8BA4;&#x4E3A;&#x662F;<strong>&#x5F02;&#x6B65;</strong>&#x7684;&#x65B9;&#x5F0F;&#x6267;&#x884C;, &#x548C;&#x6B63;&#x5E38;&#x7684;&#x8FDB;&#x7A0B;&#x4EE3;&#x7801;&#x662F;&#x4E24;&#x56DE;&#x4E8B;. &#x90A3;&#x4E48;sighandler&#x7A76;&#x7ADF;&#x662F;&#x5728;&#x4EC0;&#x4E48;&#x4E0A;&#x4E0B;&#x6587;&#x6267;&#x884C;&#x7684;?<br>&#x7B54;: &#x9ED8;&#x8BA4;&#x5728;&#x7528;&#x6237;&#x6808;&#x4E0A;&#x65B0;&#x5EFA;&#x65B0;&#x7684;&#x6808;&#x5E27;&#x6765;&#x6267;&#x884C;. &#x53EF;&#x4EE5;&#x7528;<code>sigaltstack</code>&#x6539;&#x53D8;&#x8FD9;&#x4E2A;&#x6808;&#x5E27;&#x7684;&#x4F4D;&#x7F6E;</li>
<li>&#x4EE5;SIGQUIT&#x7684;handler&#x4E3A;&#x4F8B;, &#x4E3A;&#x4EC0;&#x4E48;&#x4E00;&#x4E2A;&#x5F02;&#x6B65;&#x6267;&#x884C;&#x7684;handler, &#x80FD;&#x591F;&#x77E5;&#x9053;&#x6B63;&#x5E38;&#x4EE3;&#x7801;&#x7684;&#x8C03;&#x7528;&#x6808;?<br>&#x7B54;: handler&#x6267;&#x884C;&#x7684;&#x65F6;&#x5019;, &#x662F;&#x5F02;&#x6B65;&#x7684;. &#x6B64;&#x65F6;&quot;&#x6B63;&#x5E38;&quot;&#x7684;&#x8FDB;&#x7A0B;&#x4EE3;&#x7801;&#x4F4D;&#x7F6E;&#x5E94;&#x8BE5;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E0A;&#x4E0B;&#x6587;&#x7684;PC&#x6307;&#x9488;&#x67E5;&#x5230;, &#x90A3;&#x4E48;&#x5C31;&#x53EF;&#x4EE5;&#x6808;&#x56DE;&#x6EAF;.</li>
<li>&#x7ED3;&#x5408;case 1&#x548C;2, sighandler&#x88AB;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x673A;&#x662F;&#x600E;&#x6837;&#x7684;? case 2&#x4E2D;, &#x5927;&#x6982;&#x7387;&#x662F;&#x5728;&#x8FDB;&#x7A0B;&#x6CA1;&#x6709;&#x88AB;&#x6267;&#x884C;&#x7684;&#x65F6;&#x5019;&#x53D1;&#x751F;&#x4E86;SIGQUIT. &#x4F46;case 1&#x4E2D;, &#x8FDB;&#x7A0B;&#x6B7B;&#x5FAA;&#x73AF;&#x505A;<code>i++</code>, &#x4F1A;&#x7528;&#x5C3D;&#x8C03;&#x5EA6;&#x5668;&#x5206;&#x7ED9;&#x5B83;&#x7684;&#x65F6;&#x95F4;&#x7247;. &#x90A3;&#x4E48;sighandler&#x53C8;&#x662F;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x6267;&#x884C;&#x5462;?<br>&#x7B54;: &#x5185;&#x6838;&#x5728;&#x8FD4;&#x56DE;&#x7528;&#x6237;&#x6001;&#x8FDB;&#x7A0B;&#x7684;&#x65F6;&#x5019;, &#x4F1A;&#x6267;&#x884C;sighandler. &#x4ECE;&#x5B9E;&#x9A8C;&#x7ED3;&#x679C;&#x6765;&#x770B;, &#x5411;&#x8FDB;&#x7A0B;&#x53D1;&#x9001;&#x4FE1;&#x53F7;&#x4F1A;&#x5524;&#x9192;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;.</li>
</ul>
<h1 id="&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x539F;&#x7406;"><a name="&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x539F;&#x7406;" class="anchor-navigation-ex-anchor" href="#&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x539F;&#x7406;"><i class="fa fa-link" aria-hidden="true"></i></a>22. &#x4FE1;&#x53F7;&#x5904;&#x7406;&#x539F;&#x7406;</h1>
<p><a href="http://courses.cms.caltech.edu/cs124/lectures/CS124Lec15.pdf" target="_blank">signal&#x539F;&#x7406;&#x8BB2;&#x4E49;</a></p>
<h2 id="sigaction"><a name="sigaction" class="anchor-navigation-ex-anchor" href="#sigaction"><i class="fa fa-link" aria-hidden="true"></i></a>22.1. sigaction</h2>
<p>sigaction&#x7ED3;&#x6784;&#x4F53;&#x5B9A;&#x4E49;&#x4E86;handler&#x7684;&#x5F62;&#x5F0F;: &#x7B2C;&#x4E09;&#x4E2A;&#x53C2;&#x6570;&#x5C31;&#x662F;ucontext<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829151809.png" alt="">  </p>
<h2 id="pending&#x548C;blocked&#x5411;&#x91CF;"><a name="pending&#x548C;blocked&#x5411;&#x91CF;" class="anchor-navigation-ex-anchor" href="#pending&#x548C;blocked&#x5411;&#x91CF;"><i class="fa fa-link" aria-hidden="true"></i></a>22.2. pending&#x548C;blocked&#x5411;&#x91CF;</h2>
<ul>
<li>kernel&#x7ED9;&#x6BCF;&#x4E2A;&#x8FDB;&#x7A0B;&#x7EF4;&#x62A4;&#x8FD9;&#x4E24;&#x4E2A;&#x5411;&#x91CF;</li>
<li>&#x987E;&#x540D;&#x601D;&#x4E49;, pending&#x5411;&#x91CF;&#x662F;&#x8981;&#x53D1;&#x7ED9;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x7684;&#x5411;&#x91CF;&#x8868;; &#x800C;blocked&#x5411;&#x91CF;&#x662F;&#x4E0D;&#x5141;&#x8BB8;&#x53D1;&#x9001;&#x7ED9;&#x8FDB;&#x7A0B;&#x7684;&#x5411;&#x91CF;&#x8868;. </li>
<li>&#x5F53;&#x4E00;&#x4E2A;signal&#x5DF2;&#x7ECF;&#x88AB;deliver&#x5230;&#x8FDB;&#x7A0B;, &#x8BE5;signal&#x4F1A;&#x81EA;&#x52A8;&#x88AB;kernel&#x653E;&#x5230;blocked&#x5411;&#x91CF;, &#x963B;&#x6B62;&#x8FDB;&#x7A0B;&#x5728;&#x5904;&#x7406;singal&#x7684;&#x65F6;&#x5019;, &#x53C8;&#x88AB;&#x540C;&#x7C7B;&#x578B;signal&#x4E2D;&#x65AD;. &#x7C7B;&#x4F3C;&#x4E8E;&#x5173;&#x4E2D;&#x65AD;. &#x4F46;&#x4E0D;&#x540C;&#x7C7B;&#x578B;&#x7684;signal&#x53EF;&#x4EE5;&#x6253;&#x65AD;&#x5F53;&#x524D;&#x7684;siganl handler&#x51FD;&#x6570;.<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829151825.png" alt="">  </li>
</ul>
<h2 id="signal&#x7684;&#x4EA7;&#x751F;&#x548C;&#x6295;&#x9012;"><a name="signal&#x7684;&#x4EA7;&#x751F;&#x548C;&#x6295;&#x9012;" class="anchor-navigation-ex-anchor" href="#signal&#x7684;&#x4EA7;&#x751F;&#x548C;&#x6295;&#x9012;"><i class="fa fa-link" aria-hidden="true"></i></a>22.3. signal&#x7684;&#x4EA7;&#x751F;&#x548C;&#x6295;&#x9012;</h2>
<ul>
<li>signal&#x4EA7;&#x751F;&#x65F6;, kernel&#x8981;&#x586B;&#x7684;&#x7ED3;&#x6784;&#x4F53;<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829151844.png" alt="">  </li>
<li>&#x4EA7;&#x751F;&#x548C;&#x6295;&#x9012;&#x662F;&#x4E24;&#x4E2A;&#x8FC7;&#x7A0B;<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829151907.png" alt="">  </li>
<li>&#x4EA7;&#x751F;signal&#x662F;&#x586B;&#x4E00;&#x4E9B;&#x7ED3;&#x6784;&#x4F53;, &#x7136;&#x540E;&#x628A;&#x8FDB;&#x7A0B;&#x72B6;&#x6001;&#x8F6C;&#x4E3A;ready(&#x5982;&#x679C;&#x4E4B;&#x524D;&#x662F;&#x7761;&#x7720;)<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829151924.png" alt=""><br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829151939.png" alt="">  </li>
<li>&#x6295;&#x9012;signal&#x5230;&#x8FDB;&#x7A0B;, &#x8FDB;&#x7A0B;&#x5FC5;&#x987B;&#x62E5;&#x6709;CPU&#x6267;&#x884C;&#x6743;&#x624D;&#x80FD;&#x8FD0;&#x884C;&#x5176;handler<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829151955.png" alt="">  </li>
<li>&#x9ED8;&#x8BA4;&#x7684;handler&#x7531;&#x5185;&#x6838;&#x6267;&#x884C;, &#x81EA;&#x5B9A;&#x4E49;&#x7684;handler&#x5FC5;&#x987B;&#x7B49;&#x5230;&#x7528;&#x6237;&#x6001;&#x6267;&#x884C;<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152011.png" alt="">  </li>
<li>handler&#x6267;&#x884C;&#x5B8C;&#x8FD8;&#x8981;&#x56DE;&#x5230;&#x5185;&#x6838;&#x6001;</li>
<li>signal&#x53EF;&#x4EE5;&#x6253;&#x65AD;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</li>
<li>handler&#x53EF;&#x4EE5;&#x8C03;&#x7528;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;, &#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x8FD4;&#x56DE;&#x540E;&#x8FD8;&#x662F;&#x56DE;&#x5230;handler&#x4E0A;&#x4E0B;&#x6587;</li>
<li>handler&#x53EF;&#x4EE5;&#x8C03;&#x7528;siglongjmp()&#x6765;&#x8DF3;&#x8F6C;&#x5230;&#x7528;&#x6237;&#x6001;&#x7684;&#x5176;&#x4ED6;&#x90E8;&#x5206;&#x4EE3;&#x7801;, &#x4F46;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x8FD8;&#x5728;handler?<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152054.png" alt=""><br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152112.png" alt="">  </li>
<li>SIGCHLD&#x9ED8;&#x8BA4;&#x662F;ignore&#x7684;, handler&#x662F;SIG<em>IGN&#x4E5F;&#x662F;&#x8981;&#x88AB;&#x8DF3;&#x8FC7;&#x7684;.<br>![](img/system</em>&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152133.png)  </li>
<li>&#x9ED8;&#x8BA4;&#x7684;handler <strong>SIG_DFL&#x5728;&#x5185;&#x6838;&#x6267;&#x884C;: &#x4E0D;&#x5230;&#x7528;&#x6237;&#x6001;</strong><br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152158.png" alt="">  </li>
<li>&#x4E0D;&#x662F;&#x5185;&#x6838;&#x5904;&#x7406;&#x7684;signal, &#x5185;&#x6838;&#x8981;&#x5524;&#x9192;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x5230;&#x5176;&#x7528;&#x6237;&#x6001;&#x5904;&#x7406;.<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152221.png" alt="">  </li>
<li>&#x4E0D;&#x80FD;&#x7B80;&#x5355;&#x7684;&#x628A;sighandler&#x8BBE;&#x4E3A;&#x8FD9;&#x6B21;&#x8FD4;&#x56DE;&#x7528;&#x6237;&#x6001;&#x7684;&#x5165;&#x53E3;, &#x800C;&#x662F;&#x8981;&#x4E3A;sighandler&#x5EFA;&#x7ACB;&#x81EA;&#x5DF1;&#x7684;&#x4E0A;&#x4E0B;&#x6587;; &#x6709;&#x4E00;&#x90E8;&#x5206;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x662F;&#x4ECE;kernel&#x6808;&#x62F7;&#x5230;&#x7528;&#x6237;&#x6808;&#x7684;. &#x65B0;&#x5EFA;&#x7684;sighandler&#x6808;&#x5E27;&#x5728;&#x7528;&#x6237;&#x6001;&#x6808;&#x4E0A;, &#x79F0;&#x4E3A;uctxt<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152242.png" alt=""><br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152300.png" alt="">  </li>
<li>handler&#x8FD4;&#x56DE;&#x7684;&#x65F6;&#x5019;, &#x8981;&#x8FD4;&#x56DE;&#x5230;&#x5185;&#x6838;&#x6001;. &#x8FD9;&#x662F;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x95F4;&#x63A5;&#x7684;sigreturn&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5B9E;&#x73B0;&#x7684;.<code>man sigreturn</code>&#x8BF4;&#x7684;&#x5F88;&#x6E05;&#x695A;: &#x73B0;&#x4EE3;linux&#x7CFB;&#x7EDF;&#x4E0A;, &#x662F;vdso&#x6216;libc&#x63D0;&#x4F9B;&#x7684;sigreturn wrapper, &#x5B83;&#x7684;&#x4F5C;&#x7528;&#x662F;&#x5229;&#x7528;&#x4E4B;&#x524D;&#x4FDD;&#x5B58;&#x5728;&#x6808;&#x4E0A;&#x7684;&#x76F8;&#x5173;&#x4FE1;&#x606F;, undo&#x6240;&#x6709;&#x4E4B;&#x524D;&#x4E3A;sig handler&#x8FD0;&#x884C;&#x505A;&#x7684;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;, &#x56DE;&#x590D;&#x8FDB;&#x7A0B;&#x88AB;signal&#x4E2D;&#x65AD;&#x4E4B;&#x524D;&#x7684;&#x4E0A;&#x4E0B;&#x6587;.<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152344.png" alt=""><br><code>do_signal</code>&#x662F;&#x7ED9;&#x7528;&#x6237;&#x7684;sighandler&#x8BBE;&#x7F6E;&#x8FD0;&#x884C;&#x73AF;&#x5883;, &#x5B9E;&#x9645;&#x7684;handler&#x4E0D;&#x662F;&#x5728;&#x5B83;&#x91CC;&#x9762;&#x6267;&#x884C;&#x7684;, &#x800C;&#x662F;&#x540E;&#x9762;&#x5185;&#x6838;&#x6001;&#x5207;&#x6362;&#x5230;&#x7528;&#x6237;&#x6001;&#x65F6;, &#x56E0;&#x4E3A;eip&#x7684;&#x6539;&#x53D8;, &#x5BFC;&#x81F4;&#x7528;&#x6237;&#x7684;sighandler&#x88AB;&#x6267;&#x884C;.
sighandler&#x53EF;&#x4EE5;&#x6267;&#x884C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;, &#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x95EE;&#x9898;.<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152538.png" alt=""><br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152549.png" alt="">  </li>
</ul>
<h2 id="signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;_1"><a name="signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;_1" class="anchor-navigation-ex-anchor" href="#signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;_1"><i class="fa fa-link" aria-hidden="true"></i></a>22.4. signal&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</h2>
<ul>
<li>&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x4F1A;&#x88AB;signal&#x6253;&#x65AD;, &#x5185;&#x6838;&#x9700;&#x8981;&#x8FD4;&#x56DE;EINTR&#x6765;&#x6307;&#x793A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x88AB;&#x6253;&#x65AD;&#x4E86;. &#x88AB;&#x6253;&#x65AD;&#x7684;read&#x548C;write&#x53EF;&#x80FD;&#x4F1A;&#x88AB;&#x5185;&#x6838;&#x91CD;&#x65B0;&#x6267;&#x884C;. &#x53EF;&#x4EE5;&#x914D;&#x7F6E;&#x662F;&#x8FD4;&#x56DE;EINTR&#x8FD8;&#x662F;rerun<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152608.png" alt=""><br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152621.png" alt="">  </li>
<li>&#x8FDB;&#x7A0B;&#x5728;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x671F;&#x95F4;&#x6536;&#x5230;signal, &#x90A3;&#x5B83;&#x7684;&#x4E4B;&#x524D;&#x90FD;&#x5728;&#x5185;&#x6838;&#x6001;.<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152636.png" alt="">  </li>
</ul>
<h2 id="siglongjmp"><a name="siglongjmp" class="anchor-navigation-ex-anchor" href="#siglongjmp"><i class="fa fa-link" aria-hidden="true"></i></a>22.5. siglongjmp</h2>
<ul>
<li>&#x8C03;&#x7528;siglongjmp&#x4F1A;&#x5BFC;&#x81F4;handler&#x9000;&#x51FA;, &#x5E76;&#x628A;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x4EA4;&#x7ED9;&#x7528;&#x6237;&#x6001;&#x8FDB;&#x7A0B;&#x7684;&#x90A3;&#x90E8;&#x5206;&#x4EE3;&#x7801;&#x6BB5;.
siglongjmp&#x548C;longjmp&#x5DEE;&#x4E0D;&#x591A;, &#x53EA;&#x662F;&#x591A;&#x4E86;&#x4E00;&#x4E9B;sig mask&#x7684;&#x64CD;&#x4F5C;.<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152701.png" alt="">  </li>
<li>siglongjmp&#x5E76;&#x6CA1;&#x6709;&#x7834;&#x73AF;&#x5185;&#x6838;&#x7684;sig&#x6295;&#x9012; &#x6267;&#x884C; &#x8FD4;&#x56DE;&#x7684;&#x6D41;&#x7A0B;.<br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152728.png" alt=""><br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152748.png" alt=""><br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152808.png" alt=""><br><img src="img/system_&#x539F;&#x7406;&#x6742;&#x8BB0;_20220829152821.png" alt="">  </li>
</ul>
<h1 id="futex&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><a name="futex&#x7CFB;&#x7EDF;&#x8C03;&#x7528;" class="anchor-navigation-ex-anchor" href="#futex&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><i class="fa fa-link" aria-hidden="true"></i></a>23. futex&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</h1>
<p>man futex
linux&#x7684;futex&#x53EF;&#x4EE5;&#x5F53;&#x4F5C;&#x6BD4;&#x8F83;-&#x963B;&#x585E;&#x7684;&#x539F;&#x5B50;&#x64CD;&#x4F5C;&#x4F7F;&#x7528;.</p>
<pre class="language-"><code class="lang-c">       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/futex.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">futex</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>uaddr<span class="token punctuation">,</span> <span class="token keyword">int</span> futex_op<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">,</span>
                 <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">timespec</span> <span class="token operator">*</span>timeout<span class="token punctuation">,</span>   <span class="token comment">/* or: uint32_t val2 */</span>
                 <span class="token keyword">int</span> <span class="token operator">*</span>uaddr2<span class="token punctuation">,</span> <span class="token keyword">int</span> val3<span class="token punctuation">)</span><span class="token punctuation">;</span>

       Note<span class="token operator">:</span> There is no glibc wrapper <span class="token keyword">for</span> this system call<span class="token punctuation">;</span> see NOTES<span class="token punctuation">.</span>
</code></pre>
<p><code>int *uaddr</code>&#x662F;&#x4E2A;&#x7528;&#x6237;&#x63D0;&#x4F9B;&#x7684;&#x5730;&#x5740;, &#x5176;&#x503C;&#x65F6;32&#x4F4D;&#x7684;, &#x5373;&#x4F7F;&#x5728;64&#x4F4D;&#x673A;&#x5668;&#x4E0A;, &#x4E5F;&#x662F;32&#x4F4D;.
&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x53EF;&#x4EE5;&#x5728;&#x5171;&#x4EAB;&#x5185;&#x5B58;&#x4E2D;, &#x6BD4;&#x5982;&#x7528;mmap(2) or shmat(2)&#x521B;&#x5EFA;&#x7684;&#x5171;&#x4EAB;&#x5185;&#x5B58;, &#x8FD9;&#x6837;&#x4E0D;&#x540C;&#x7684;&#x8FDB;&#x7A0B;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x540C;&#x4E00;&#x4E2A;futex, futex&#x5728;&#x5185;&#x6838;&#x4E2D;&#x770B;&#x7684;&#x662F;&#x8FD9;&#x4E2A;&#x6307;&#x9488;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;.
futex&#x652F;&#x6301;&#x50CF;epoll&#x7B49;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x8D85;&#x65F6;&#x673A;&#x5236;.</p>
<p>&#x5F53;futex_op&#x53EF;&#x4EE5;&#x662F;FUTEX_WAIT&#x4E5F;&#x53EF;&#x4EE5;&#x662F;FUTEX_WAKE, &#x5373;futex&#x6709;wait&#x548C;wakeup&#x4E24;&#x79CD;&#x529F;&#x80FD;.</p>
<ul>
<li>FUTEX_WAIT&#x65F6;, futex&#x6BD4;&#x8F83;&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x6307;&#x5411;&#x7684;32&#x4F4D;&#x503C;, &#x5982;&#x679C;&#x548C;val&#x76F8;&#x7B49;&#x5219;&#x4F11;&#x7720;; &#x4E0D;&#x7B49;&#x7684;&#x8BDD;, &#x9A6C;&#x4E0A;&#x8FD4;&#x56DE;, errorno&#x4E3A;EAGAIN.</li>
<li>FUTEX_WAKE&#x65F6;, &#x5524;&#x9192;val&#x4E2A;&#x7B49;&#x5F85;&#x5728;uaddr&#x4E0A;&#x7684;&#x7EBF;&#x7A0B;. &#x901A;&#x5E38;val&#x4E3A;1&#x4E2A;&#x968F;&#x673A;&#x7684;&#x7EBF;&#x7A0B;, &#x6216;&#x8005;&#x6240;&#x6709;(INT_MAX)&#x7684;&#x7EBF;&#x7A0B;.</li>
</ul>
<h1 id="mmap&#x548C;&#x5185;&#x6838;page"><a name="mmap&#x548C;&#x5185;&#x6838;page" class="anchor-navigation-ex-anchor" href="#mmap&#x548C;&#x5185;&#x6838;page"><i class="fa fa-link" aria-hidden="true"></i></a>24. mmap&#x548C;&#x5185;&#x6838;page</h1>
<p>mmap&#x7684;&#x4EFB;&#x52A1;&#x662F;&#x5728;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x91CC;, map&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x5230;&#x4E00;&#x4E2A;&#x865A;&#x62DF;&#x5730;&#x5740;&#x8303;&#x56F4;.
&#x5F53;&#x8FD9;&#x4E2A;&#x865A;&#x62DF;&#x5730;&#x5740;&#x88AB;&#x8BBF;&#x95EE;&#x7684;&#x65F6;&#x5019;, &#x6CA1;&#x6709;PTE&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x4EA7;&#x751F;page fault&#x5F02;&#x5E38;, kernel&#x624D;&#x5206;&#x914D;&#x7269;&#x7406;&#x9875;, &#x4ECE;&#x6587;&#x4EF6;copy&#x5B9E;&#x9645;&#x5185;&#x5BB9;&#x5230;&#x8FD9;&#x4E2A;&#x7269;&#x7406;&#x9875;.</p>
<ul>
<li>page&#x662F;&#x6709;cache&#x7684;, &#x4F7F;&#x7528;Least Recently Used (LRU)&#x7B56;&#x7565;&#x6362;&#x51FA;&#x4E0D;&#x7ECF;&#x5E38;&#x4F7F;&#x7528;&#x7684;page. &#x5F53;dirty page&#x8D85;&#x8FC7;&#x4E00;&#x4E2A;ratio, kernel&#x4F1A;flush&#x810F;&#x9875;.</li>
<li>Read-ahead&#x6280;&#x672F;&#x9884;&#x52A0;&#x8F7D;page&#x4ECE;&#x800C;&#x907F;&#x514D;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#x7684;&#x4EA7;&#x751F;.</li>
<li>madvise&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53EF;&#x4EE5;&#x544A;&#x77E5;kernel app&#x5BF9;&#x5185;&#x5BB9;&#x8303;&#x56F4;&#x7684;&#x671F;&#x671B;.</li>
</ul>
<h2 id="shared&#x548C;private"><a name="shared&#x548C;private" class="anchor-navigation-ex-anchor" href="#shared&#x548C;private"><i class="fa fa-link" aria-hidden="true"></i></a>24.1. shared&#x548C;private</h2>
<p>&#x7528;mmap&#x6765;map&#x6587;&#x4EF6;&#x4E00;&#x822C;&#x90FD;&#x7528;shared map. &#x987E;&#x540D;&#x601D;&#x4E49;, &#x591A;&#x4E2A;&#x8FDB;&#x7A0B;&#x90FD;&#x7528;shared map&#x4E00;&#x4E2A;&#x6587;&#x4EF6;, &#x4ED6;&#x4EEC;&#x7684;&#x6539;&#x52A8;&#x662F;&#x5F7C;&#x6B64;&#x53EF;&#x89C1;&#x7684;, &#x5199;&#x64CD;&#x4F5C;&#x4E5F;&#x4F1A;&#x771F;&#x6B63;&#x7684;&#x5199;&#x5230;&#x90A3;&#x4E2A;&#x6587;&#x4EF6;&#x91CC;.</p>
<pre class="language-"><code>MAP_SHARED
        Share this mapping.  Updates to the mapping are visible to
        other processes mapping the same region, and (in the case
        of file-backed mappings) are carried through to the
        underlying file.  (To precisely control when updates are
        carried through to the underlying file requires the use of
        msync(2).)
</code></pre><p>private map&#x4F7F;&#x7528;copy on write&#x6280;&#x672F;, &#x5199;&#x64CD;&#x4F5C;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x5199;&#x5230;&#x65B0;&#x5206;&#x914D;&#x7684;&#x7269;&#x7406;&#x9875;&#x4E0A;. &#x6240;&#x4EE5;&#x5199;&#x7684;&#x4E1C;&#x897F;&#x522B;&#x7684;&#x8FDB;&#x7A0B;&#x662F;&#x770B;&#x4E0D;&#x89C1;&#x7684;, &#x800C;&#x4E14;&#x5199;&#x7684;&#x5185;&#x5BB9;&#x4E0D;&#x4F1A;&#x771F;&#x6B63;&#x5199;&#x5230;&#x6587;&#x4EF6;&#x91CC;.</p>
<pre class="language-"><code>MAP_PRIVATE
        Create a private copy-on-write mapping.  Updates to the
        mapping are not visible to other processes mapping the
        same file, and are not carried through to the underlying
        file.  It is unspecified whether changes made to the file
        after the mmap() call are visible in the mapped region.
</code></pre><h2 id="shared-map"><a name="shared-map" class="anchor-navigation-ex-anchor" href="#shared-map"><i class="fa fa-link" aria-hidden="true"></i></a>24.2. shared map</h2>
<p>linux&#x7684;mmap&#x7CFB;&#x7EDF;&#x8C03;&#x7528;, &#x6BD4;&#x5982;:</p>
<pre class="language-"><code class="lang-c"><span class="token function">mmap</span><span class="token punctuation">(</span>
    <span class="token comment">/* addr = */</span> <span class="token number">0x400000</span><span class="token punctuation">,</span>
    <span class="token comment">/* length = */</span> <span class="token number">0x1000</span><span class="token punctuation">,</span>
    PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span>
    MAP_SHARED<span class="token punctuation">,</span>
    <span class="token comment">/* fd = */</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token comment">/* offset = */</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x4ECE;fd <code>3</code>&#x5230;<code>virtual memory areas</code> (<code>VMAs</code>)&#x7684;mapping.
&#x8FD9;&#x4E2A;mapping&#x4ECE;<code>VA 0x400000</code>&#x5F00;&#x59CB;, &#x957F;&#x5EA6;&#x4E3A;<code>0x1000</code>&#x5B57;&#x8282;, offset&#x662F;<code>0</code>.<br>&#x5047;&#x8BBE;fd 3&#x5BF9;&#x5E94;&#x7684;&#x6587;&#x4EF6;&#x662F;<code>/tmp/foo</code>,
&#x5185;&#x6838;&#x4E2D;&#x8FD9;&#x4E2A;mapping&#x8868;&#x793A;&#x4E3A;:</p>
<pre class="language-"><code>VMA:     VA:0x400000 -&gt; /tmp/foo:0x0
</code></pre><p>&#x521B;&#x5EFA;VMA&#x7684;&#x65F6;&#x5019;&#x5E76;&#x6CA1;&#x6709;&#x5206;&#x914D;<code>PA</code>, &#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;linux&#x8FD8;&#x6CA1;&#x6709;&#x51C6;&#x5907;&#x7269;&#x7406;&#x5730;&#x5740;&#x6765;&#x4FDD;&#x5B58;<code>/tmp/foo</code>&#x7684;&#x5185;&#x5BB9;. &#x76F4;&#x5230;&#x5E94;&#x7528;&#x8BFB;<code>VA</code>&#x5730;&#x5740;<code>0x400000</code>, &#x4EA7;&#x751F;&#x7F3A;&#x9875;&#x5F02;&#x5E38;, &#x624D;&#x5206;&#x914D;&#x7269;&#x7406;&#x9875;, &#x7136;&#x540E;copy&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#x5230;&#x8FD9;&#x4E2A;&#x7269;&#x7406;&#x9875;. &#x6BD4;&#x5982;kernel&#x9009;&#x62E9;&#x4E86;<code>PA:0x2fb000</code>, &#x6B64;&#x65F6;VMA&#x662F;&#x8FD9;&#x6837;&#x7684;:</p>
<pre class="language-"><code>VMA:     VA:0x400000 -&gt; /tmp/foo:0x0
Filemap:                /tmp/foo:0x0 -&gt; PA:0x2fb000
</code></pre><p>&#x8FD9;&#x91CC;&#x7684;Filemap&#x5BF9;&#x5E94;kernel&#x7684;<code>struct address_space</code></p>
<p>&#x8FD9;&#x4E2A;&#x65F6;&#x5019;kernel&#x4F7F;&#x7528;<code>page table entry</code> (<code>PTE</code>)&#x6765;&#x505A;<code>VA</code>&#x5230;<code>PA</code>&#x7684;&#x8F6C;&#x6362;&#x8868;.</p>
<pre class="language-"><code>VMA:     VA:0x400000 -&gt; /tmp/foo:0x0
Filemap:                /tmp/foo:0x0 -&gt; PA:0x2fb000
PTE:     VA:0x400000 -----------------&gt; PA:0x2fb000
</code></pre><p>&#x6CE8;&#x610F;, VMA&#x548C;Filemap&#x662F;&#x76F8;&#x5BF9;&#x72EC;&#x7ACB;&#x7684;&#x4E1C;&#x897F;, &#x800C;PTE&#x53D7;&#x4E8C;&#x8005;&#x7684;&#x5F71;&#x54CD;, &#x6BD4;&#x5982;:</p>
<ul>
<li>&#x8FD9;&#x4E2A;&#x5E94;&#x7528;&#x8C03;&#x7528;&#x4E86;munmap&#x7CFB;&#x7EDF;&#x8C03;&#x7528;, &#x8FD9;&#x5C31;&#x89E3;&#x9664;&#x4E86;<code>VMA:     VA:0x400000 -&gt; /tmp/foo:0x0</code>&#x7684;&#x6620;&#x5C04;, &#x8FDB;&#x800C;&#x89E3;&#x9664;&#x4E86;<code>PTE:     VA:0x400000 -----------------&gt; PA:0x2fb000</code>. &#x4F46;&#x662F;, <code>Filemap:                /tmp/foo:0x0 -&gt; PA:0x2fb000</code>&#x4E0D;&#x4E00;&#x5B9A;&#x5C31;&#x89E3;&#x9664;&#x4E86;, &#x56E0;&#x4E3A;&#x4ECE;&#x6587;&#x4EF6;<code>/tmp/foo:0x0</code>&#x5230;&#x7269;&#x7406;&#x5730;&#x5740;<code>PA:0x2fb000</code>&#x7684;&#x6620;&#x5C04;&#x4EE5;&#x540E;&#x8FD8;&#x80FD;&#x7528;&#x5F97;&#x4E0A;.</li>
<li>&#x8FD9;&#x4E2A;&#x5E94;&#x7528;&#x4E5F;&#x53EF;&#x80FD;&#x8C03;&#x7528;<code>ftruncate</code>&#x6765;invalidate&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x7684;&#x5185;&#x5BB9;. &#x8FD9;&#x5C31;&#x89E3;&#x9664;&#x4E86;<code>Filemap:                /tmp/foo:0x0 -&gt; PA:0x2fb000</code>, &#x8FDB;&#x800C;&#x89E3;&#x9664;&#x4E86;<code>PTE:     VA:0x400000 -----------------&gt; PA:0x2fb000</code>; &#x800C;<code>VMA:     VA:0x400000 -&gt; /tmp/foo:0x0</code>&#x5C31;&#x4E0D;&#x9700;&#x8981;&#x6539;&#x53D8;, &#x56E0;&#x4E3A;PTE&#x89E3;&#x9664;&#x4E86;, <code>VA:0x400000</code>&#x9700;&#x8981;&#x53E6;&#x4E00;&#x4E2A;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#x6765;&#x5206;&#x914D;&#x65B0;&#x7684;&#x7269;&#x7406;&#x9875;, &#x6240;&#x4EE5;VA&#x4ECD;&#x7136;&#x53CD;&#x5E94;&#x4E86;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#x7684;&#x6539;&#x53D8;.</li>
</ul>
<h2 id="private-map"><a name="private-map" class="anchor-navigation-ex-anchor" href="#private-map"><i class="fa fa-link" aria-hidden="true"></i></a>24.3. private map</h2>
<p>&#x5BF9;private map&#x6765;&#x8BF4;, &#x8BFB;&#x548C;&#x5199;&#x90FD;&#x53EF;&#x80FD;&#x4F1A;&#x6709;&#x7F3A;&#x9875;&#x5F02;&#x5E38;.
&#x9996;&#x6B21;&#x8BFB;&#x4EA7;&#x751F;&#x7684;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#x4F1A;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x53EA;&#x8BFB;&#x7684;&#x7269;&#x7406;&#x9875;:</p>
<pre class="language-"><code>VMA:     VA:0x400000 -&gt; /tmp/foo:0x0 (private)
Filemap:                /tmp/foo:0x0 -&gt; PA:0x2fb000
PTE:     VA:0x400000 -----------------&gt; PA:0x2fb000 (read-only)
</code></pre><p>&#x6B64;&#x65F6;&#x5982;&#x679C;&#x662F;shared map, &#x5199;&#x64CD;&#x505A;&#x4E5F;&#x4F1A;&#x5199;&#x5230;<code>PA:0x2fb000</code>. &#x4F46;private map&#x4F1A;&#x4EA7;&#x751F;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x7F3A;&#x9875;&#x5F02;&#x5E38;, kernel&#x53E6;&#x5916;&#x9009;&#x62E9;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x9875;(&#x6BD4;&#x5982;0x5ea000), &#x62F7;&#x8D1D;&#x4E4B;&#x524D;&#x7684;&#x7269;&#x7406;&#x9875;&#x5185;&#x5BB9;&#x5230;&#x8FD9;&#x4E2A;&#x65B0;&#x5206;&#x914D;&#x7684;&#x7269;&#x7406;&#x9875;, &#x7136;&#x540E;&#x66F4;&#x65B0;map:</p>
<pre class="language-"><code>VMA:     VA:0x400000 -&gt; /tmp/foo:0x0 (private)
Filemap:                /tmp/foo:0x0 -&gt; PA:0x2fb000
PTE:     VA:0x400000 -----------------&gt; PA:0x5ea000
</code></pre><h2 id="&#x533F;&#x540D;&#x6620;&#x5C04;"><a name="&#x533F;&#x540D;&#x6620;&#x5C04;" class="anchor-navigation-ex-anchor" href="#&#x533F;&#x540D;&#x6620;&#x5C04;"><i class="fa fa-link" aria-hidden="true"></i></a>24.4. &#x533F;&#x540D;&#x6620;&#x5C04;</h2>
<p>flag&#x91CC;&#x9762;&#x5982;&#x679C;&#x6709;<code>MAP_ANONYMOUS</code>&#x5C31;&#x4F7F;&#x7528;&#x533F;&#x540D;&#x6620;&#x5C04;, &#x5C31;&#x662F;&#x4E0D;&#x9700;&#x8981;&#x6587;&#x4EF6;&#x7684;&#x6620;&#x5C04;. &#x533F;&#x540D;&#x4E5F;&#x5206;shared&#x548C;private.</p>
<ul>
<li>shared&#x6A21;&#x5F0F;&#x4E0B;&#x9762;, &#x4F1A;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x7684;&#x96F6;&#x5B57;&#x8282;&#x7684;&#x6587;&#x4EF6;, &#x5927;&#x5BB6;&#x90FD;map&#x5230;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;.</li>
<li>private&#x6A21;&#x5F0F;&#x4E0B;&#x9762;, &#x5C31;&#x6CA1;&#x6709;&#x8FD9;&#x4E2A;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x4E86;. &#x800C;&#x662F;&#x4E00;&#x5F00;&#x59CB;&#x90FD;&#x7528;&#x4E00;&#x4E2A;&#x56FA;&#x5B9A;&#x7684;readonly&#x7684;&#x5168;&#x96F6;&#x7684;&#x9875;, &#x76F4;&#x5230;copy on write&#x65B0;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x53EF;&#x5199;&#x7684;&#x7269;&#x7406;&#x9875;.</li>
</ul>
<h1 id="libevent&#x4E3B;&#x5FAA;&#x73AF;&#x5904;&#x7406;timer"><a name="libevent&#x4E3B;&#x5FAA;&#x73AF;&#x5904;&#x7406;timer" class="anchor-navigation-ex-anchor" href="#libevent&#x4E3B;&#x5FAA;&#x73AF;&#x5904;&#x7406;timer"><i class="fa fa-link" aria-hidden="true"></i></a>25. libevent&#x4E3B;&#x5FAA;&#x73AF;&#x5904;&#x7406;timer</h1>
<p>&#x5728;libevent/event.c</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">int</span> <span class="token function">event_base_loop</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">event_base</span> <span class="token operator">*</span>base<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//&#x6CA1;&#x6709;event&#x5219;&#x9000;&#x51FA;&#x5FAA;&#x73AF;</span>
        <span class="token comment">//&#x4ECE;&#x5B9A;&#x65F6;&#x5668;&#x5806;&#x91CC;&#x7B97;&#x4E0B;&#x6B21;&#x8D85;&#x65F6;&#x65F6;&#x95F4;</span>
        <span class="token function">timeout_next</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tv_p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x8C03;&#x7528;&#x5E95;&#x5C42;poll, &#x5BF9;linux&#x6765;&#x8BF4;, &#x662F;epoll</span>
        res <span class="token operator">=</span> evsel<span class="token operator">-&gt;</span><span class="token function">dispatch</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> tv_p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//handle &#x5B9A;&#x65F6;&#x5668;&#x5806;, &#x628A;&#x6709;&#x6548;&#x7684;(active)&#x7684;&#x5B9A;&#x65F6;&#x5668;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x52A0;&#x5165;base&#x7684;active&#x961F;&#x5217;, &#x5E26;&#x4F18;&#x5148;&#x7EA7;&#x7684;&#x5165;&#x961F;&#x5217;</span>
        <span class="token function">timeout_process</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x771F;&#x6B63;&#x6267;&#x884C;active&#x961F;&#x5217;&#x91CC;&#x9762;&#x7684;&#x56DE;&#x8C03;; </span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">event_process_active</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">/* Activate every event whose timeout has elapsed. */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">timeout_process</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">event_base</span> <span class="token operator">*</span>base<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">gettime</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token operator">&amp;</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//&#x83B7;&#x53D6;&#x6BCF;&#x4E2A;timer</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ev <span class="token operator">=</span> <span class="token function">min_heap_top_</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>base<span class="token operator">-&gt;</span>timeheap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">evutil_timercmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ev<span class="token operator">-&gt;</span>ev_timeout<span class="token punctuation">,</span> <span class="token operator">&amp;</span>now<span class="token punctuation">,</span> <span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token comment">/* delete this event from the I/O queues */</span>
        <span class="token function">event_del_nolock_</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> EVENT_DEL_NOBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">event_debug</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;timeout_process: event: %p, call %p&quot;</span><span class="token punctuation">,</span>
             ev<span class="token punctuation">,</span> ev<span class="token operator">-&gt;</span>ev_callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x6B63;&#x5982;&#x4E0A;&#x9762;&#x6253;&#x5370;&#x7684;&#x63D0;&#x793A;&#x4E00;&#x6837;, &#x6267;&#x884C;&#x6BCF;&#x4E2A;timer&#x7684;&#x56DE;&#x8C03;.</span>
        <span class="token function">event_active_nolock_</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> EV_TIMEOUT<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//&#x5B9E;&#x9645;&#x4E0A;&#x8FD9;&#x91CC;&#x662F;&#x52A0;&#x5165;&#x5230;&#x4E00;&#x4E2A;&#x94FE;&#x8868;: base-&gt;activequeues, &#x7531;event_process_active()&#x6267;&#x884C;&#x8FD9;&#x4E2A;&#x94FE;&#x8868;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="&#x518D;&#x8BAE;rm"><a name="&#x518D;&#x8BAE;rm" class="anchor-navigation-ex-anchor" href="#&#x518D;&#x8BAE;rm"><i class="fa fa-link" aria-hidden="true"></i></a>26. &#x518D;&#x8BAE;rm</h1>
<p>rm&#x5B9E;&#x9645;&#x4E0A;&#x662F;unlink&#x8C03;&#x7528;, &#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x51CF;&#x5C0F;&#x6587;&#x4EF6;&#x7684;link&#x8BA1;&#x6570;.</p>
<ul>
<li>&#x5982;&#x679C;link&#x51CF;&#x5C0F;&#x5230;0, &#x800C;&#x4E14;&#x6CA1;&#x6709;&#x8FDB;&#x7A0B;open&#x5B83;, &#x6587;&#x4EF6;&#x4F1A;&#x88AB;&#x5220;&#x9664;.</li>
<li>&#x5982;&#x679C;link&#x51CF;&#x5C0F;&#x5230;0, &#x4F46;&#x6709;&#x8FDB;&#x7A0B;&#x5728;&#x4F7F;&#x7528;&#x5B83;, &#x90A3;&#x4E48;&#x6587;&#x4EF6;&#x5728;&#x8FDB;&#x7A0B;close&#x5B83;&#x4E4B;&#x524D;&#x90FD;&#x5B58;&#x5728;.
&#x89C1;<code>man 2 unlink</code>
&#x5B9E;&#x9A8C;&#x4E2D;, &#x6211;&#x7528;vim&#x6253;&#x5F00;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;, &#x5728;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x7A97;&#x53E3;rm&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;, rm&#x6CA1;&#x6709;&#x8FD4;&#x56DE;&#x4EFB;&#x4F55;&#x9519;&#x8BEF;, &#x6587;&#x4EF6;&#x5DF2;&#x7ECF;&#x4ECE;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E0D;&#x53EF;&#x89C1;. &#x4F46;&#x5B9E;&#x9645;&#x4E0A;, &#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x8FD8;&#x5B58;&#x5728;, vim&#x4F9D;&#x65E7;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#x5B83;.<h2 id="&#x666E;&#x901A;&#x7528;&#x6237;&#x53EF;&#x4EE5;rm-root&#x7528;&#x6237;&#x7684;&#x6587;&#x4EF6;"><a name="&#x666E;&#x901A;&#x7528;&#x6237;&#x53EF;&#x4EE5;rm-root&#x7528;&#x6237;&#x7684;&#x6587;&#x4EF6;" class="anchor-navigation-ex-anchor" href="#&#x666E;&#x901A;&#x7528;&#x6237;&#x53EF;&#x4EE5;rm-root&#x7528;&#x6237;&#x7684;&#x6587;&#x4EF6;"><i class="fa fa-link" aria-hidden="true"></i></a>26.1. &#x666E;&#x901A;&#x7528;&#x6237;&#x53EF;&#x4EE5;rm root&#x7528;&#x6237;&#x7684;&#x6587;&#x4EF6;</h2>
&#x5728;&#x4E00;&#x6B21;&#x5B9E;&#x9A8C;&#x4E2D;, &#x6211;&#x5728;test&#x6587;&#x4EF6;&#x5939;&#x4E2D;, &#x7528;root&#x8D26;&#x6237;&#x521B;&#x5EFA;&#x4E86;&#x6587;&#x4EF6;aaa, &#x4F46;&#x9000;&#x51FA;root&#x540E;, &#x7528;&#x666E;&#x901A;&#x8D26;&#x6237;&#x5C31;&#x80FD;&#x5220;&#x9664;aaa&#x6587;&#x4EF6;.<pre class="language-"><code class="lang-sh">yingjieb@yingjieb-VirtualBox ~/test
Linux Mint <span class="token number">19.1</span> Tessa $ ll
total <span class="token number">0</span>
yingjieb@yingjieb-VirtualBox ~/test
Linux Mint <span class="token number">19.1</span> Tessa $ <span class="token function">sudo</span> <span class="token function">touch</span> aaa
yingjieb@yingjieb-VirtualBox ~/test
Linux Mint <span class="token number">19.1</span> Tessa $ ll
total <span class="token number">0</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">0</span> Mar <span class="token number">4</span> <span class="token number">21</span>:12 aaa
yingjieb@yingjieb-VirtualBox ~/test
Linux Mint <span class="token number">19.1</span> Tessa $ <span class="token function">rm</span> <span class="token parameter variable">-f</span> aaa
yingjieb@yingjieb-VirtualBox ~/test
Linux Mint <span class="token number">19.1</span> Tessa $ ll
total <span class="token number">0</span>
</code></pre>
&#x600E;&#x4E48;, aaa&#x662F;<code>-rw-r--r--</code>&#x6743;&#x9650;, &#x7406;&#x8BBA;&#x4E0A;&#x4E0D;&#x5E94;&#x8BE5;&#x80FD;&#x88AB;&#x666E;&#x901A;&#x7528;&#x6237;&#x5220;&#x9664;&#x5440;?
&#x6709;&#x4EBA;&#x95EE;&#x4E86;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;, &#x89C1;: <a href="https://superuser.com/questions/1336951/user-can-delete-root-owned-files-in-their-home-directory-or-what-are-the-rules" target="_blank">https://superuser.com/questions/1336951/user-can-delete-root-owned-files-in-their-home-directory-or-what-are-the-rules</a><br>&#x5176;&#x5B9E;&#x539F;&#x7406;&#x662F;:<br>&#x76EE;&#x5F55;&#x548C;&#x6587;&#x4EF6;&#x7684;&#x5173;&#x7CFB;&#x662F;, &#x76EE;&#x5F55;&#x662F;&#x5BF9;&#x5176;&#x4E0B;&#x6587;&#x4EF6;&#x7684;link, &#x6240;&#x4EE5;shell&#x547D;&#x4EE4;<code>rm</code>&#x5176;&#x5B9E;&#x662F;<code>unlink</code>&#x8C03;&#x7528;, <code>unlink</code>&#x51CF;&#x5C0F;&#x5BF9;&#x6587;&#x4EF6;&#x7684;link&#x5F15;&#x7528;&#x6570;.<br>&#x5982;&#x679C;&#x5F15;&#x7528;&#x6570;&#x51CF;&#x5230;0, &#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x5C31;&#x6CA1;&#x4EBA;&#x5F15;&#x7528;&#x4E86;, &#x5C31;&#x88AB;&#x5220;&#x9664;&#x4E86;.<br>&#x5220;&#x9664;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;, &#x5E76;&#x4E0D;&#x662F;&#x4F5C;&#x7528;&#x4E8E;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;, &#x800C;&#x662F;&#x4F5C;&#x7528;&#x4E8E;&#x5B83;&#x7684;&#x76EE;&#x5F55;, &#x51CF;&#x5C0F;&#x76EE;&#x5F55;&#x5BF9;&#x6587;&#x4EF6;&#x7684;&#x5F15;&#x7528;.<br><strong>&#x6240;&#x4EE5;, &#x5728;&#x672C;&#x4F8B;&#x4E2D;, <code>rm</code>&#x4F5C;&#x7528;&#x4E8E;&#x76EE;&#x5F55;<code>~/test</code>, &#x8FD9;&#x662F;&#x4E2A;&#x7528;&#x6237;&#x6709;&#x6743;&#x9650;&#x8BBF;&#x95EE;&#x7684;&#x76EE;&#x5F55;. <code>rm</code>&#x64CD;&#x4F5C;&#x548C;&#x6587;&#x4EF6;<code>aaa</code>&#x7684;&#x6743;&#x9650;&#x6CA1;&#x6709;&#x5173;&#x7CFB;.</strong></li>
</ul>
<h1 id="&#x5173;&#x4E8E;&#x70ED;&#x5347;&#x7EA7;-&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x6587;&#x4EF6;&#x53EF;&#x4EE5;&#x88AB;rm"><a name="&#x5173;&#x4E8E;&#x70ED;&#x5347;&#x7EA7;-&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x6587;&#x4EF6;&#x53EF;&#x4EE5;&#x88AB;rm" class="anchor-navigation-ex-anchor" href="#&#x5173;&#x4E8E;&#x70ED;&#x5347;&#x7EA7;-&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x6587;&#x4EF6;&#x53EF;&#x4EE5;&#x88AB;rm"><i class="fa fa-link" aria-hidden="true"></i></a>27. &#x5173;&#x4E8E;&#x70ED;&#x5347;&#x7EA7;, &#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x6587;&#x4EF6;&#x53EF;&#x4EE5;&#x88AB;rm</h1>
<p>&#x6BD4;&#x5982;ubuntu&#x7CFB;&#x7EDF;&#x5728;update&#x7684;&#x65F6;&#x5019;, &#x4E00;&#x822C;&#x662F;&#x4E0D;&#x9700;&#x8981;&#x91CD;&#x542F;&#x7684;. &#x4F46;&#x65E2;&#x7136;&#x8981;&#x5347;&#x7EA7;, &#x5C31;&#x5FC5;&#x7136;&#x8981;&#x66FF;&#x6362;&#x6389;&#x539F;&#x6765;&#x7684;bin&#x6216;&#x8005;so&#x4E4B;&#x7C7B;&#x7684;&#x6587;&#x4EF6;, &#x53C8;&#x8981;app&#x4E0D;&#x91CD;&#x542F;, &#x600E;&#x4E48;&#x505A;&#x5230;&#x7684;&#x5462;?</p>
<p>&#x4EE5;vim&#x4E3A;&#x4F8B;, &#x5F53;&#x524D;&#x6B63;&#x5728;&#x6253;&#x5F00;vim&#x7A97;&#x53E3;&#x7F16;&#x8F91;, &#x540C;&#x65F6;&#x5728;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x7A97;&#x53E3;&#x5347;&#x7EA7;vim, &#x5347;&#x7EA7;&#x6210;&#x529F;&#x4E86;, &#x539F;&#x6765;&#x6253;&#x5F00;&#x7684;vim&#x8FD8;&#x80FD;&#x7EE7;&#x7EED;&#x4F7F;&#x7528;. &#x90A3;&#x6253;&#x5F00;&#x7684;vim&#x662F;&#x65B0;&#x7248;&#x672C;&#x8FD8;&#x662F;&#x8001;&#x7248;&#x672C;&#x5462;? --&#x662F;&#x8001;&#x7248;&#x672C;</p>
<p>&#x8FD9;&#x4E3B;&#x8981;&#x662F;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;&#x5DE5;&#x4F5C;, &#x6BCF;&#x4E2A;&#x6253;&#x5F00;&#x7684;&#x6587;&#x4EF6;, &#x90FD;&#x6709;&#x4E2A;&#x6587;&#x4EF6;&#x53E5;&#x67C4;, &#x8FD9;&#x4E2A;&#x53E5;&#x67C4;&#x662F;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x7684;&#x4E00;&#x4E2A;&#x8BBF;&#x95EE;&#x5B9E;&#x4F8B;; &#x53E5;&#x67C4;&#x91CC;&#x4FDD;&#x5B58;&#x4E86;&#x6587;&#x4EF6;&#x7684;&#x5B9E;&#x4F53;(inode)&#x5728;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x5F15;&#x7528;.</p>
<p>&#x5347;&#x7EA7;&#x7684;&#x8FC7;&#x7A0B;, &#x662F;&#x5148;&#x5220;&#x9664;&#x65E7;&#x6587;&#x4EF6;, &#x518D;&#x5199;&#x5165;&#x65B0;&#x6587;&#x4EF6;, &#x867D;&#x7136;&#x6587;&#x4EF6;&#x540D;&#x76F8;&#x540C;, &#x4F46;inode&#x4E0D;&#x540C;. &#x5DF2;&#x7ECF;&#x6253;&#x5F00;&#x7684;&#x65E7;&#x6587;&#x4EF6;, &#x5728;&#x5176;&#x53E5;&#x67C4;&#x91CC;&#x4FDD;&#x5B58;&#x7684;inode, &#x6307;&#x5411;&#x7684;&#x6587;&#x4EF6;&quot;&#x770B;&#x8D77;&#x6765;&quot;&#x4E0D;&#x5B58;&#x5728;&#x4E86;, &#x4F46;&#x5B9E;&#x9645;&#x8FD8;&#x5728;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x91CC;.</p>
<p>&#x6240;&#x6709;&#x5BF9;&#x8FD9;&#x4E2A;&#x8001;&#x7684;inode&#x7684;&#x5F15;&#x7528;&#x7ED3;&#x675F;&#x540E;, &#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x628A;&#x8FD9;&#x90E8;&#x5206;&#x5728;&#x78C1;&#x76D8;&#x4E0A;&#x7684;&#x5B9E;&#x4F53;&#x7A7A;&#x95F4;&#x6807;&#x8BB0;&#x4E3A;&#x7A7A;&#x95F2;.</p>
<pre class="language-"><code class="lang-sh"><span class="token comment">#&#x6253;&#x5F00;vim, &#x8FDB;&#x7A0B;&#x662F;28919</span>

<span class="token comment">#pmap&#x53D1;&#x73B0;&#x5176;mmap&#x7684;&#x6587;&#x4EF6;</span>
Linux Mint <span class="token number">19.1</span> Tessa $ pmap <span class="token number">28919</span>
<span class="token number">28919</span>: <span class="token function">vim</span> drivers/spi/spidev.c
0000556832e5d000 2940K r-x-- vim.gtk
000055683333b000 64K r---- vim.gtk
000055683334b000 104K rw--- vim.gtk

<span class="token comment">#&#x6B64;&#x65F6;, &#x5BF9;vim.gtk&#x7684;open&#x662F;&#x4E0D;&#x80FD;&#x5199;&#x7684;, &#x56E0;&#x4E3A;&#x5199;&#x662F;&#x5BF9;&#x540C;&#x4E00;&#x4E2A;inode&#x64CD;&#x4F5C;.</span>
Linux Mint <span class="token number">19.1</span> Tessa $ <span class="token function">sudo</span> <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/usr/bin/vim.gtk <span class="token assign-left variable">bs</span><span class="token operator">=</span>4M <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">1</span>
dd: failed to <span class="token function">open</span> <span class="token string">&apos;/usr/bin/vim.gtk&apos;</span><span class="token builtin class-name">:</span> Text <span class="token function">file</span> busy
yingjieb@yingjieb-VirtualBox ~
Linux Mint <span class="token number">19.1</span> Tessa $ <span class="token function">sudo</span> <span class="token function">cp</span> /usr/bin/x86_64-linux-gnu-gcc-7 /usr/bin/vim.gtk
cp: cannot create regular <span class="token function">file</span> <span class="token string">&apos;/usr/bin/vim.gtk&apos;</span><span class="token builtin class-name">:</span> Text <span class="token function">file</span> busy

<span class="token comment">#&#x4F46;&#x662F;&#x53EF;&#x4EE5;&#x5220;&#x9664;</span>
Linux Mint <span class="token number">19.1</span> Tessa $ <span class="token function">sudo</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> /usr/bin/vim.gtk

<span class="token comment">#&#x6B64;&#x65F6;pmap&#x80FD;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x88AB;&#x5220;&#x9664;&#x4E86;</span>
<span class="token comment">#&#x4F46;28919&#x8FDB;&#x7A0B;&#x7684;vim&#x8FD8;&#x80FD;&#x7EE7;&#x7EED;&#x4F7F;&#x7528;, &#x56E0;&#x4E3A;1. &#x5176;&#x6587;&#x4EF6;&#x5E76;&#x6CA1;&#x6709;&#x771F;&#x6B63;&#x6D88;&#x4EA1;. 2. &#x6587;&#x4EF6;&#x88AB;&#x88C5;&#x8F7D;&#x5230;&#x5185;&#x5B58;&#x91CC;&#x4E86;(page). </span>
<span class="token comment">#&#x6211;&#x4F30;&#x8BA1;&#x8FD9;&#x4E24;&#x9879;&#x90FD;&#x4E3A;&#x771F;. &#x6587;&#x4EF6;&#x88AB;mmap&#x5230;&#x8FDB;&#x7A0B;&#x5185;&#x5B58;&#x7A7A;&#x95F4;, &#x5373;&#x4F7F;&#x53EA;&#x6709;&#x90E8;&#x5206;&#x6587;&#x4EF6;&#x88AB;page&#x4E86;, &#x8BBF;&#x95EE;&#x53E6;&#x5916;&#x7684;&#x6587;&#x4EF6;&#x90E8;&#x5206;, &#x4F1A;&#x6709;page fault, &#x8FDB;&#x800C;&#x901A;&#x8FC7;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x88C5;&#x8F7D;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#x5230;&#x7269;&#x7406;&#x9875;.</span>
<span class="token comment">#&#x6211;&#x8BA4;&#x4E3A;&#x5373;&#x4F7F;page fault, &#x4E5F;&#x4F1A;&#x8BBF;&#x95EE;&#x5230;&#x8001;&#x7684;inode&#x7684;&#x6587;&#x4EF6;, &#x4E5F;&#x4F1A;&#x6210;&#x529F; -- &#x672A;&#x9A8C;&#x8BC1;</span>
Linux Mint <span class="token number">19.1</span> Tessa $ pmap <span class="token number">28919</span>
<span class="token number">28919</span>: <span class="token function">vim</span> drivers/spi/spidev.c
0000556832e5d000 2940K r-x-- vim.gtk <span class="token punctuation">(</span>deleted<span class="token punctuation">)</span>
000055683333b000 64K r---- vim.gtk <span class="token punctuation">(</span>deleted<span class="token punctuation">)</span>
000055683334b000 104K rw--- vim.gtk <span class="token punctuation">(</span>deleted<span class="token punctuation">)</span>

<span class="token comment">#&#x4E5F;&#x53EF;&#x4EE5;mv</span>
Linux Mint <span class="token number">19.1</span> Tessa $ <span class="token function">sudo</span> <span class="token function">mv</span> /usr/bin/vim.gtk /usr/bin/vim.gtk.back
<span class="token comment">#&#x6B64;&#x65F6;pmap&#x77E5;&#x9053;inode&#x6CA1;&#x53D8;, &#x6587;&#x4EF6;&#x53D8;&#x4E86;.</span>
Linux Mint <span class="token number">19.1</span> Tessa $ pmap <span class="token number">28919</span>
<span class="token number">28919</span>: <span class="token function">vim</span> drivers/spi/spidev.c
0000556832e5d000 2940K r-x-- vim.gtk.back
000055683333b000 64K r---- vim.gtk.back
000055683334b000 104K rw--- vim.gtk.back


<span class="token comment">#&#x5220;&#x9664;vim.gtk&#x540E;, &#x53EF;&#x4EE5;&#x65B0;&#x5EFA;&#x4E2A;&#x540C;&#x540D;&#x6587;&#x4EF6;; &#x4F46;&#x65B0;&#x6587;&#x4EF6;&#x6709;&#x65B0;&#x7684;inode</span>
Linux Mint <span class="token number">19.1</span> Tessa $ <span class="token function">sudo</span> <span class="token function">cp</span> vim.gtk.save /usr/bin/vim.gtk
Linux Mint <span class="token number">19.1</span> Tessa $ llh /usr/bin/vim.gtk
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">3</span>.1M Jun <span class="token number">13</span> <span class="token number">17</span>:08 /usr/bin/vim.gtk
<span class="token comment">#pmap&#x4F9D;&#x7136;&#x663E;&#x793A;vim.gtk&#x662F;&#x5DF2;&#x7ECF;&#x5220;&#x9664;&#x72B6;&#x6001;, &#x56E0;&#x4E3A;&#x8FD9;&#x91CC;&#x7528;&#x7684;&#x8001;&#x7684;inode</span>
Linux Mint <span class="token number">19.1</span> Tessa $ pmap <span class="token number">28919</span>
<span class="token number">28919</span>: <span class="token function">vim</span> drivers/spi/spidev.c
0000556832e5d000 2940K r-x-- vim.gtk <span class="token punctuation">(</span>deleted<span class="token punctuation">)</span>
000055683333b000 64K r---- vim.gtk <span class="token punctuation">(</span>deleted<span class="token punctuation">)</span>
000055683334b000 104K rw--- vim.gtk <span class="token punctuation">(</span>deleted<span class="token punctuation">)</span>
</code></pre>
<p>&#x7ED3;&#x8BBA;:</p>
<ul>
<li>mv&#x6587;&#x4EF6;&#x4E0D;&#x6539;&#x53D8;&#x6587;&#x4EF6;&#x7684;inode, &#x53EA;&#x6539;&#x53D8;&#x6587;&#x4EF6;&#x540D;;</li>
<li>cp&#x65B0;&#x6587;&#x4EF6;&#x5230;&#x6B63;&#x5728;&#x6253;&#x5F00;&#x7684;&#x6587;&#x4EF6;&#x662F;&#x975E;&#x6CD5;&#x7684;, &#x56E0;&#x4E3A;cp&#x8981;open&#x8FD9;&#x4E2A;&#x76EE;&#x7684;&#x6587;&#x4EF6;, &#x662F;&#x5BF9;&#x540C;&#x4E00;&#x4E2A;inode&#x64CD;&#x4F5C;. &#x5982;&#x679C;&#x5408;&#x6CD5;, &#x90A3;&#x6B63;&#x5728;&#x6267;&#x884C;&#x7684;&#x6587;&#x4EF6;, &#x5176;&#x5185;&#x5BB9;&#x66F4;&#x6539;&#x4F1A;&#x5F15;&#x53D1;&#x672A;&#x77E5;&#x9519;&#x8BEF;.</li>
<li>rm&#x6253;&#x5F00;&#x7684;&#x6587;&#x4EF6;&#x662F;&#x53EF;&#x4EE5;&#x7684;, &#x6216;&#x8005;&#x8BF4;&quot;&#x770B;&#x8D77;&#x6765;&quot;&#x662F;&#x9A6C;&#x4E0A;&#x751F;&#x6548;&#x7684;, &#x4F46;&#x5B9E;&#x9645;&#x4E0A;, &#x5982;&#x679C;&#x8001;&#x7684;inode&#x8FD8;&#x5728;&#x88AB;&#x5F15;&#x7528;, &#x8FD8;&#x662F;&#x80FD;&#x88AB;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x8BBF;&#x95EE;&#x5230;.</li>
<li>&#x5347;&#x7EA7;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x7684;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;, &#x6BD4;&#x5982;vim.gtk, &#x8981;&#x5236;&#x9020;&#x65B0;&#x7684;inode, &#x5177;&#x4F53;&#x662F;: &#x5148;rm, &#x518D;cp&#x6210;&#x540C;&#x540D;&#x6587;&#x4EF6;</li>
<li>&#x5347;&#x7EA7;&#x540E;&#x7684;&#x6587;&#x4EF6;, &#x53EA;&#x6709;app&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x7684;&#x65F6;&#x5019;&#x624D;&#x751F;&#x6548;.</li>
</ul>
<h1 id="user&#x6709;&#x4EC0;&#x4E48;&#x7528;"><a name="user&#x6709;&#x4EC0;&#x4E48;&#x7528;" class="anchor-navigation-ex-anchor" href="#user&#x6709;&#x4EC0;&#x4E48;&#x7528;"><i class="fa fa-link" aria-hidden="true"></i></a>28. __user&#x6709;&#x4EC0;&#x4E48;&#x7528;?</h1>
<p>&#x5185;&#x6838;&#x91CC;&#x9762;, &#x7528;&#x6237;&#x6307;&#x9488;&#x6709;<code>__user</code>&#x524D;&#x7F00;, &#x5176;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;<br><code># define __user __attribute__((noderef, address_space(1)))</code></p>
<p>&#x4F46;&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981;&#x5B83;? kernel&#x4E0D;&#x662F;&#x80FD;&#x8BBF;&#x95EE;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;&#x6240;&#x6709;&#x5185;&#x5B58;&#x5417;? &#x4E3A;&#x4EC0;&#x4E48;&#x6709;&#x7684;&#x6587;&#x7AE0;&#x8BF4;kernel&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x7528;&#x6237;&#x6001;&#x5185;&#x5B58;?<br>&#x7B54;: kernel&#x662F;&#x80FD;&#x8BBF;&#x95EE;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x6240;&#x6709;&#x5185;&#x5B58;&#x7A7A;&#x95F4;, &#x5F53;&#x7136;&#x4E5F;&#x5305;&#x62EC;&#x5176;&#x7528;&#x6237;&#x6001;&#x7A7A;&#x95F4;, &#x6240;&#x4EE5;<code>__user</code>&#x5E76;&#x4E0D;&#x80FD;&#x963B;&#x6B62;kernel&#x8BBF;&#x95EE;&#x7528;&#x6237;&#x6001;&#x7A7A;&#x95F4;, &#x4F46;&#x7528;<code>__user</code>&#x5F80;&#x5F80;&#x8868;&#x793A;&#x5176;&#x540E;&#x9762;&#x7684;&#x6307;&#x9488;&#x662F;&#x7528;&#x6237;&#x6001;&#x7684;, &#x53EF;&#x80FD;&#x4E0D;&#x5B89;&#x5168;, &#x6216;&#x8005;&#x662F;&#x65E0;&#x6548;&#x7684;, <code>__user</code>&#x63D0;&#x793A;&#x5F00;&#x53D1;&#x8005;&#x6216;&#x8005;&#x7CFB;&#x7EDF;&#x8981;&#x591A;&#x52A0;&#x6CE8;&#x610F;, &#x540C;&#x6837;&#x7684;, &#x7406;&#x8BBA;&#x4E0A;<code>memcpy</code>&#x548C;<code>strcpy</code>&#x4E5F;&#x80FD;&#x62F7;&#x8D1D;&#x4E1C;&#x897F;&#x5230;&#x7528;&#x6237;&#x6001;&#x7A7A;&#x95F4;, &#x4F46;&#x5B9E;&#x9645;&#x4E2D;, &#x4E00;&#x822C;&#x7528;<code>copy_to_user</code>&#x4FDD;&#x8BC1;&#x5B89;&#x5168;&#x6027;. </p>
<p>&#x4E0B;&#x9762;&#x662F;Linus Torvalds&#x7684;&#x89E3;&#x91CA;:  </p>
<blockquote>
<p>This is important to remember: for gcc, the sparse annotations are meaningless. They can still be useful just to tell the programmer that &quot;hey, that pointer you got wasn&apos;t a normal pointer&quot; in a fairly readable manner, but in the end, unless you use sparse, they don&apos;t actually do anything.<br>HOWEVER. When you do use parse, it is another matter entirely. For &quot;sparse&quot;, that &quot;<strong>iomem&quot; has lots of meaning:<br>`# define </strong>iomem <strong>attribute</strong>((noderef, address_space(2)))`<br>ie &quot;iomem&quot; means two separate things: it means that sparse should complain<br>if the pointer is ever dereferenced (it&apos;s a &quot;noderef&quot; pointer) directly, and it&apos;s in &quot;address space 2&quot; as opposed to the normal address space (0).<br>Now, that means that sparse will complain if such a pointer is ever passed into a function that wants a regular pointer (because it is not a normal pointer, and you obviously shouldn&apos;t do things like &quot;strcmp()&quot; etc on it), and sparse will also complain if you try to cast it to another pointer in another address space.</p>
</blockquote>
<h1 id="&#x7528;&#x6237;&#x6001;&#x901A;&#x8FC7;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x9677;&#x5165;&#x5230;&#x5185;&#x6838;&#x6001;-&#x5185;&#x5B58;&#x6620;&#x5C04;&#x4F1A;&#x53D8;&#x5417;"><a name="&#x7528;&#x6237;&#x6001;&#x901A;&#x8FC7;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x9677;&#x5165;&#x5230;&#x5185;&#x6838;&#x6001;-&#x5185;&#x5B58;&#x6620;&#x5C04;&#x4F1A;&#x53D8;&#x5417;" class="anchor-navigation-ex-anchor" href="#&#x7528;&#x6237;&#x6001;&#x901A;&#x8FC7;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x9677;&#x5165;&#x5230;&#x5185;&#x6838;&#x6001;-&#x5185;&#x5B58;&#x6620;&#x5C04;&#x4F1A;&#x53D8;&#x5417;"><i class="fa fa-link" aria-hidden="true"></i></a>29. &#x7528;&#x6237;&#x6001;&#x901A;&#x8FC7;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x9677;&#x5165;&#x5230;&#x5185;&#x6838;&#x6001;, &#x5185;&#x5B58;&#x6620;&#x5C04;&#x4F1A;&#x53D8;&#x5417;?</h1>
<p>&#x4E0D;&#x4F1A;</p>
<blockquote>
<p>You&apos;ve got the general idea mostly right, but make this adjustment: there&apos;s only one &quot;kernelspace&quot; for the whole machine, and all processes share it.</p>
<p>When a process is active, it can either be running in &quot;user mode&quot; or &quot;kernel mode&quot;.</p>
<p>In user mode, the instructions being executed by the CPU are in the userspace side of the memory map. The program is running its own code, or code from a userspace library. In user mode, a process has limited abilities. There is a flag in the CPU which tells it not to allow the use of privileged instructions, and kernel memory, although it exists in the process&apos;s memory map, is inaccessible. (You wouldn&apos;t want let any program just read and write the kernel&apos;s memory - all security would be gone.)</p>
<p>When a process wants to do something other than move data around in its own (userspace) virtual memory, like open a file for example, it must make a syscall. Each CPU architecture has its own unique quirky method of making syscalls, but they all boil down to this: a magic instruction is executed, the CPU turns on the &quot;privileged mode&quot; flag, and jumps to a special address in kernelspace, the &quot;syscall entry point&quot;.</p>
<p>Now the process is running in kernel mode. Instructions being executed are located in kernel memory, and they can read and write any memory they want to. The kernel examines the request that the process just made and decides what to do with it.</p>
<p>In the open example, the kernel receives 2 or 3 parameters corresponding to the arguments of int open(const char *filename, int flags[, int mode]). The first argument provides an example of when kernelspace needs access to userspace. You said open(&quot;foo&quot;, O_RDONLY) so the string &quot;foo&quot; is part of your program in userspace. The syscall mechanism only passed a pointer, not a string, so the kernel must read the string from user memory.</p>
<p>To find the requested file, the kernel may consult with filesystem drivers (to figure out where the file is) and block device drivers (to load the necessary blocks from disk) or network device drivers and protocols (to load the file from a remote source). All of those things are part of the kernel, i.e. in kernelspace, regardless of whether they are built-in or were loaded as modules.</p>
<p>If the request can&apos;t be satisfied immediately, the kernel may put the process to sleep. That means the process will be taken off the CPU until a response is received from the disk or network. Another process may get a chance to run now. Later, when the response comes in, your process starts running again (still in kernel mode). Now that it&apos;s found the file, the open syscall can finish up (check the permissions, create a file descriptor) and return to userspace.</p>
<p>Returning to userspace is a simple matter of putting the CPU back in non-privileged mode and restoring the registers to what they were before the user-&gt;kernel transition, with the instruction pointer pointing at the instruction after the magic syscall instruction.</p>
<p>Besides syscalls, there are other things that can cause a transition from user mode to kernel mode, including:</p>
<p>page faults - if your process accesses a virtual memory address that doesn&apos;t have a physical address assigned to it, the CPU enters kernel mode and jumps to the page fault handler. The kernel then decides whether the virtual address is valid or not, and it either creates a physical page and resumes the process in userspace where it left off, or sends a SIGSEGV.</p>
<p>interrupts - some hardware (network, disk, serial port, etc.) notifies the CPU that it requires attention. The CPU enters kernel mode and jumps to a handler, the kernel responds to it and then resumes the userspace process that was running before the interrupt.</p>
<p>Loading a module is done with a syscall that asks the kernel to copy the module&apos;s code and data into kernelspace and run its initialization code in kernel mode.</p>
<p>This is pretty long, so I&apos;m stopping. I hope the walk-through focusing on user-kernel transitions has provided enough examples to solidify the idea.</p>
</blockquote>
<h1 id="what-happens-to-the-cache-contents-on-a-context-switch"><a name="what-happens-to-the-cache-contents-on-a-context-switch" class="anchor-navigation-ex-anchor" href="#what-happens-to-the-cache-contents-on-a-context-switch"><i class="fa fa-link" aria-hidden="true"></i></a>30. What happens to the cache contents on a context switch?</h1>
<blockquote>
<p>In a multicore processor, what happens to the contents of a core&apos;s cache (say L1) when a context switch occurs on that cache?</p>
<p>Is the behaviour dependent on the architecture or is it a general behaviour followed by all chip manufacturers?</p>
<p>That depends both on the processor (not just the processor series, it can vary from model to model) and the operating systems, but there are general principles. Whether a processor is multicore has no direct impact on this aspect; the same process could be executing on multiple cores simultaneously (if it&apos;s multithreaded), and memory can be shared between processes, so cache synchronization is unavoidable regardless of what happens on a context switch.</p>
<p>When a processor looks up a memory location in the cache, if there is an MMU, it can use either the physical or the virtual address of that location (sometimes even a combination of both, but that&apos;s not really relevant here).</p>
<p>With physical addresses, it doesn&apos;t matter which process is accessing the address, the contents can be shared. So there is no need to invalidate the cache content during a context switch. If the two processes map the same physical page with different attributes, this is handled by the MMU (acting as a MPU (memory protection unit)). The downside of a physically addressed cache is that the MMU has to sit between the processor and the cache, so the cache lookup is slow. L1 caches are almost never physically addresses; higher-level caches may be.</p>
<p>The same virtual address can denote different memory locations in different processes. Hence, with a virtually addressed cache, the processor and the operating system must cooperate to ensure that a process will find the right memory. There are several common techniques. The context-switching code provided by the operating system can invalidate the whole cache; this is correct but very costly. Some CPU architectures have room in their cache line for an ASID (address space identifier) the hardware version of a process ID, also used by the MMU. This effectively separates cache entries from different processes, and means that two processes that map the same page will have incoherent views of the same physical page (there is usually a special ASID value indicating a shared page, but these need to be flushed if they are not mapped to the same address in all processes where they are mapped). If the operating system takes care that different processes use non-overlapping address spaces (which defeats some of the purpose of using virtual memory, but can be done sometimes), then cache lines remain valid.</p>
<p>Most processors that have an MMU also have a TLB. The TLB is a cache of mappings from virtual addresses to physical addresses. The TLB is consulted before lookups in physically-addressed caches, to determine the physical address quickly when possible; the processor may start the cache lookup before the TLB lookup is complete, as often candidate cache lines can be identified from the middle bits of the address, between the bits that determine the offset in a cache line and the bits that determine the page. Virtually-addressed caches bypass the TLB if there is a cache hit, although the processor may initiate the TLB lookup while it is querying the cache, in case of a miss.</p>
<p>The TLB itself must be managed during a context switch. If the TLB entries contain an ASID, they can remain in place; the operating system only needs to flush TLB entries if their ASID has changed meaning (e.g. because a process has exited). If the TLB entries are global, they must be invalidated when switching to a different context.</p>
</blockquote>
<h1 id="int&#x7684;&#x5199;&#x662F;&#x539F;&#x5B50;&#x7684;&#x5417;"><a name="int&#x7684;&#x5199;&#x662F;&#x539F;&#x5B50;&#x7684;&#x5417;" class="anchor-navigation-ex-anchor" href="#int&#x7684;&#x5199;&#x662F;&#x539F;&#x5B50;&#x7684;&#x5417;"><i class="fa fa-link" aria-hidden="true"></i></a>31. int&#x7684;&#x5199;&#x662F;&#x539F;&#x5B50;&#x7684;&#x5417;?</h1>
<p>&#x6BD4;&#x5982;&#x4E00;&#x4E2A;64&#x4F4D;CPU, &#x5199;&#x4E00;&#x4E2A;<code>i int64</code>&#x662F;&#x539F;&#x5B50;&#x7684;&#x5417;? &#x6211;&#x4EEC;&#x77E5;&#x9053;, <code>i++</code>&#x5E76;&#x4E0D;&#x662F;&#x539F;&#x5B50;&#x7684;, &#x56E0;&#x4E3A;&#x5B83;&#x6709;&#x8BFB;-&#x66F4;&#x6539;-&#x5199;&#x4E09;&#x4E2A;&#x8FC7;&#x7A0B;.<br>&#x90A3;&#x5355;&#x7EAF;&#x7684;&#x5199;&#x53D8;&#x91CF;<code>i</code>&#x662F;&#x539F;&#x5B50;&#x7684;&#x5417;?  </p>
<p>&#x539F;&#x5B50;&#x7684;&#x610F;&#x601D;&#x662F;&#x6BD4;&#x5982;<br>Thread A: <code>i = 0x08</code><br>Thread B: <code>i = 0x80</code><br>&#x90A3;&#x4E48;, &#x6700;&#x7EC8;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x7684;&#x7ED3;&#x679C;&#x8981;&#x4E48;&#x662F;0x08, &#x8981;&#x4E48;&#x662F;0x80. &#x4E0D;&#x53EF;&#x80FD;&#x662F;&#x4E2D;&#x95F4;&#x7684;&#x67D0;&#x4E2A;&#x503C;.</p>
<h2 id="&#x662F;-&#x4E5F;&#x4E0D;&#x662F;"><a name="&#x662F;-&#x4E5F;&#x4E0D;&#x662F;" class="anchor-navigation-ex-anchor" href="#&#x662F;-&#x4E5F;&#x4E0D;&#x662F;"><i class="fa fa-link" aria-hidden="true"></i></a>31.1. &#x662F;, &#x4E5F;&#x4E0D;&#x662F;</h2>
<ul>
<li>&#x4E00;&#x822C;&#x662F;&#x7684;. &#x548C;&#x53D8;&#x91CF;&#x662F;&#x5426;cache line&#x5BF9;&#x9F50;&#x6709;&#x5173;. &#x9ED8;&#x8BA4;&#x7684;&#x6574;&#x578B;&#x53D8;&#x91CF;&#x88AB;&#x7F16;&#x8BD1;&#x5668;&#x5B89;&#x6392;&#x5230;&#x81EA;&#x7136;&#x5730;&#x5740;&#x5BF9;&#x9F50;&#x7684;&#x5730;&#x65B9;, &#x5728;&#x73B0;&#x4EE3;CPU&#x4E0A;, cache line&#x5BF9;&#x9F50;&#x7684;&#x53D8;&#x91CF;&#x4F1A;&#x843D;&#x5728;&#x4E00;&#x4E2A;cache line&#x91CC;&#x9762;.<br>CPU&#x5BF9;&#x5185;&#x5B58;&#x7684;&#x66F4;&#x6539;&#x662F;&#x4EE5;cache line&#x4E3A;&#x5355;&#x4F4D;&#x7684;, &#x8FD9;&#x4E2A;&#x66F4;&#x65B0;&#x662F;&#x539F;&#x5B50;&#x7684;. &#x5982;&#x679C;&#x540C;&#x65F6;&#x591A;&#x4E2A;CPU&#x7684;&#x6838;&#x5FC3;&#x90FD;&#x66F4;&#x65B0;&#x6307;&#x5411;&#x540C;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x7684;cache line, &#x6BD4;&#x5982;CPU0&#x5728;&#x5176;L1 cache&#x91CC;&#x9762;&#x6539;&#x4E86;&#x53D8;&#x91CF;A, CPU1&#x4E5F;&#x5728;&#x5176;cacheline&#x91CC;&#x9762;&#x66F4;&#x6539;&#x4E86;&#x76F8;&#x540C;&#x7684;&#x53D8;&#x91CF;A, &#x4F46;&#x6700;&#x7EC8;&#x53EA;&#x80FD;&#x6709;&#x4E00;&#x4E2A;cacheline&#x771F;&#x6B63;&#x5199;&#x5230;L2, &#x5373;&#x4F7F;&#x4E24;&#x4E2A;CPU&#x7269;&#x7406;&#x4E0A;&quot;&#x540C;&#x65F6;&quot;&#x53D1;&#x751F;&#x8FD9;&#x4E2A;&#x66F4;&#x6539;&#x64CD;&#x4F5C;, &#x603B;&#x7EBF;&#x4E5F;&#x4F1A;&#x4EF2;&#x88C1;.<br>&#x7ED3;&#x679C;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;A&#x8981;&#x4E48;&#x662F;CPU0&#x6539;&#x7684;&#x503C;, &#x8981;&#x4E48;&#x662F;CPU1&#x6539;&#x7684;&#x503C;. &#x4E0D;&#x53EF;&#x80FD;&#x662F;&#x4E2D;&#x95F4;&#x503C;</li>
<li>&#x5982;&#x679C;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;, &#x56E0;&#x4E3A;&#x7A0B;&#x5E8F;&#x7684;&#x6709;&#x610F;&#x64CD;&#x4F5C;, &#x8DE8;&#x4E86;&#x4E24;&#x4E2A;cache line. &#x90A3;&#x4E48;&#x5728;&#x66F4;&#x65B0;&#x5B83;&#x7684;&#x65F6;&#x5019;, &#x5C31;&#x4E0D;&#x662F;&#x539F;&#x5B50;&#x7684;. &#x4E24;&#x4E2A;CPU&#x540C;&#x65F6;&#x6539;&#x7684;&#x65F6;&#x5019;, &#x5176;&#x503C;&#x6709;&#x53EF;&#x80FD;&#x4E0D;&#x662F;&#x4E8C;&#x9009;&#x4E00;, &#x800C;&#x662F;&#x4E24;&#x4E2A;&#x62FC;&#x51FA;&#x6765;&#x7684;. &#x4F46;&#x4E5F;&#x4E0D;&#x53EF;&#x80FD;&#x662F;&#x5176;&#x4ED6;&#x4E71;&#x4E03;&#x516B;&#x7CDF;&#x7684;&#x503C;.</li>
</ul>
<h1 id="uboot&#x4F20;mtdpart&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x540D;&#x5B57;&#x4ECE;&#x54EA;&#x6765;&#x7684;&#xFF1F;"><a name="uboot&#x4F20;mtdpart&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x540D;&#x5B57;&#x4ECE;&#x54EA;&#x6765;&#x7684;&#xFF1F;" class="anchor-navigation-ex-anchor" href="#uboot&#x4F20;mtdpart&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x540D;&#x5B57;&#x4ECE;&#x54EA;&#x6765;&#x7684;&#xFF1F;"><i class="fa fa-link" aria-hidden="true"></i></a>32. uboot&#x4F20;mtdpart&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x540D;&#x5B57;&#x4ECE;&#x54EA;&#x6765;&#x7684;&#xFF1F;</h1>
<p>&#x6BD4;&#x5982;uboot&#x4F1A;&#x4F20;cmdline&#x7ED9;&#x5185;&#x6838;</p>
<pre class="language-"><code>mtdparts=octeon_nand0:0x20000000@0x0(nand);bootflash:0x20000@0x140000(statusA),0x20000@0x160000(statusB),0x140000@0x180000(bootA),0x140000@0x2c0000(bootB),0x1900000@0x400000(linuxA),0x1900000@0x1d00000(linuxB)
</code></pre><p>&#x90A3;&#x4E48;octeon_nand0&#x548C;bootflash&#x600E;&#x4E48;&#x6765;&#x7684;&#xFF1F; 
&#x4E0B;&#x9762;&#x662F;&#x5185;&#x6838;&#x7684;&#x542F;&#x52A8;&#x8BB0;&#x5F55;&#xFF1A;</p>
<pre class="language-"><code>[02.11] [   30.741082] Bootbus flash: Setting flash for 64MB flash at 0x1bc00000
[02.11] [   30.760360] bootflash: Found 1 x16 devices at 0x0 in 8-bit bank. Manufacturer ID 0x0000c2 Chip ID 0x00007e
[02.11] [   30.782739] Amd/Fujitsu Extended Query Table at 0x0040
[02.11] [   30.800628]   Amd/Fujitsu Extended Query version 1.3.
[02.11] [   30.818400] number of CFI chips: 1
[02.11] [   30.834545] 6 cmdlinepart partitions found on MTD device bootflash
[02.11] [   30.853523] Creating 6 MTD partitions on &quot;bootflash&quot;:
[02.11] [   30.871305] 0x000000140000-0x000000160000 : &quot;statusA&quot;
[02.11] [   30.889434] 0x000000160000-0x000000180000 : &quot;statusB&quot;
[02.11] [   30.907519] 0x000000180000-0x0000002c0000 : &quot;bootA&quot;
[02.11] [   30.925437] 0x0000002c0000-0x000000400000 : &quot;bootB&quot;
[02.11] [   30.943334] 0x000000400000-0x000001d00000 : &quot;linuxA&quot;
[02.11] [   30.961321] 0x000001d00000-0x000003600000 : &quot;linuxB&quot;
[02.11] [   30.979710] cvmx_nand_initialize: Setting timing parameter mode to 0
[02.11] [   30.998826] octeon-nand 1070001000000.nand-flash-interface: NAND using BCH ecc
[02.11] [   31.018967] NAND 1 OOB size: 64, write size: 2048, erase size: 131072
[02.11] [   31.038133] NAND device: Manufacturer ID: 0x2c, Chip ID: 0xf1 (Micron NAND 128MiB 3,3V 8-bit), 128MiB, page size: 2048, OOB size: 64
[02.11] [   31.063631] Scanning device for bad blocks
[02.11] [   31.159228] mtd: octeon_nand0: partitioning exceeds flash size, truncating
[02.11] [   31.178825] 1 cmdlinepart partitions found on MTD device octeon_nand0
[02.11] [   31.197990] Creating 1 MTD partitions on &quot;octeon_nand0&quot;:
[02.11] [   31.216023] 0x000000000000-0x000008000000 : &quot;nand&quot;
[02.11] [   31.238898] Freeing unused kernel memory: 8952K (ffffffff80792000 - ffffffff81050000)
</code></pre><p>&#x5148;&#x8BF4;bootflash&#xFF1A;<br>&#x5728;arch/mips/cavium-octeon/flash_setup.c&#x4E2D;&#xFF0C; &#x662F;cfi_flash&#x7684;&#x9A71;&#x52A8;
&#x5728;&#x5B83;&#x7684;probe&#x51FD;&#x6570;&#x91CC;&#x9762;&#xFF0C;&#x5199;&#x6B7B;&#x4E86;&#x540D;&#x5B57;&#xFF1A;<br><code>flash_map.name = &quot;bootflash&quot;;</code><br>&#x5E76;&#x8C03;&#x7528;mtd_device_parse_register&#x6765;&#x89E3;&#x6790;mtd&#x5206;&#x533A;&#xFF0C; &#x4F20;&#x5165;type cmdlinepart&#xFF0C;&#x610F;&#x601D;&#x662F;&#x4F18;&#x5148;&#x4F7F;&#x7528;cmdlinepart&#x6765;&#x89E3;&#x6790;mtd&#x5206;&#x533A;
&#x5B9E;&#x9645;&#x4E0A;&#xFF0C;mtd&#x652F;&#x6301;&#x4E24;&#x79CD;&#xFF0C;&#x6309;&#x987A;&#x5E8F;&#x662F;&quot;cmdlinepart&quot;&#x548C;&quot;ofpart&quot;<br>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x91CC;&#x9762;&#x8C03;&#x7528;&#xFF1A;<br>parse_mtd_partitions&#x4F1A;&#x6839;&#x636E;&#x4EE5;&#x4E0A;&#x4E24;&#x79CD;&#x89C4;&#x5219;&#x521B;&#x5EFA;mtd&#x5206;&#x533A;&#x3002;</p>
<p>&#x53E6;&#x5916;&#xFF1A;uboot&#x91CC;&#x9762;&#x4E5F;&#x6709;&#x5173;&#x4E8E;mtd&#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x4F30;&#x8BA1;&#x662F;&#x7ED9;uboot&#x81EA;&#x5DF1;&#x770B;&#x7684;&#x3002;</p>
<pre class="language-"><code class="lang-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MTDPARTS_DEFAULT</span>                <span class="token expression">\        </span></span>
    <span class="token string">&quot;octeon_nor0:2560k(bootloader)ro,&quot;</span>          \
    <span class="token string">&quot;2m(kernel),&quot;</span>                   \            
    <span class="token string">&quot;3520k(cramfs),&quot;</span>                \            
    <span class="token string">&quot;64k(environment)ro\0&quot;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MTDIDS_DEFAULT</span>  <span class="token string">&quot;nor0=octeon_nor0\0&quot;</span></span>
</code></pre>
<h1 id="&#x4E3A;&#x4EC0;&#x4E48;&#x76F4;&#x63A5;&#x8003;&#x8FC7;&#x6765;&#x7684;ls&#x4E0D;&#x80FD;&#x7528;&#xFF1F;"><a name="&#x4E3A;&#x4EC0;&#x4E48;&#x76F4;&#x63A5;&#x8003;&#x8FC7;&#x6765;&#x7684;ls&#x4E0D;&#x80FD;&#x7528;&#xFF1F;" class="anchor-navigation-ex-anchor" href="#&#x4E3A;&#x4EC0;&#x4E48;&#x76F4;&#x63A5;&#x8003;&#x8FC7;&#x6765;&#x7684;ls&#x4E0D;&#x80FD;&#x7528;&#xFF1F;"><i class="fa fa-link" aria-hidden="true"></i></a>33. &#x4E3A;&#x4EC0;&#x4E48;&#x76F4;&#x63A5;&#x8003;&#x8FC7;&#x6765;&#x7684;ls&#x4E0D;&#x80FD;&#x7528;&#xFF1F;</h1>
<p>mount debian&#x7684;rootfs&#xFF0C;&#x4ECE;&#x4E0B;&#x9762;&#x8003;&#x4E86;&#x4E00;&#x4E2A;perl&#x4F46;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x8FD0;&#x884C;&#xFF0C;&#x63D0;&#x793A;not found&#x3002;
&#x5176;&#x5B9E;&#x4E0D;&#x662F;&#x8FD9;&#x4E2A;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x627E;&#x4E0D;&#x5230;&#xFF0C;&#x800C;&#x662F;&#x5B83;&#x4F9D;&#x8D56;&#x7684;&#x52A8;&#x6001;&#x5E93;&#x4E0D;&#x6EE1;&#x8DB3;&#x3002;&#x672C;&#x8D28;&#x4E0A;&#x8FD8;&#x662F;&#x4E2A;&#x4F9D;&#x8D56;&#x95EE;&#x9898;&#x3002;
&#x53EF;&#x4EE5;&#x5728;&#x7F16;&#x8BD1;&#x7684;&#x65F6;&#x5019;&#x7528;-static&#x6765;&#x7F16;&#x6210;&#x9759;&#x6001;&#x94FE;&#x63A5;&#xFF0C;&#x8FD9;&#x6837;&#x968F;&#x4FBF;&#x8003;&#x5230;&#x54EA;&#x91CC;&#x90FD;&#x80FD;&#x7528;&#x4E86;&#x3002;</p>
<h1 id="fork&#x4E0E;malloc"><a name="fork&#x4E0E;malloc" class="anchor-navigation-ex-anchor" href="#fork&#x4E0E;malloc"><i class="fa fa-link" aria-hidden="true"></i></a>34. fork&#x4E0E;malloc</h1>
<p>&#x95EE;&#x9898;:
&#x5728;fork&#x4E4B;&#x524D;, &#x7236;&#x8FDB;&#x7A0B;malloc&#x4E86;&#x5185;&#x5B58;, &#x6BD4;&#x5982;char *p;
&#x90A3;&#x4E48;:</p>
<ol>
<li>&#x5B50;&#x8FDB;&#x7A0B;&#x80FD;&#x6B63;&#x5E38;&#x8BBF;&#x95EE;p&#x5417;? &#x5185;&#x5BB9;&#x4E0E;&#x7236;&#x8FDB;&#x7A0B;&#x4E00;&#x6837;&#x5417;?</li>
<li>&#x5B50;&#x8FDB;&#x7A0B;&#x4FEE;&#x6539;&#x4E86;p&#x5185;&#x5B58;&#x7684;&#x5185;&#x5BB9;, &#x7236;&#x8FDB;&#x7A0B;&#x80FD;&#x770B;&#x5230;&#x5417;?</li>
<li>&#x5B50;&#x8FDB;&#x7A0B;&#x9700;&#x8981;free(p)&#x5417;?</li>
</ol>
<p>&#x56DE;&#x7B54;:</p>
<pre class="language-"><code class="lang-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>something <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>something<span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">pid_t</span> child_pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//child</span>
    <span class="token punctuation">{</span> 
        <span class="token comment">/*&#x5B50;&#x8FDB;&#x7A0B;&#x80FD;&#x591F;&#x8BBF;&#x95EE;&#x8FD9;&#x4E2A;&#x6307;&#x9488;, &#x5E76;&#x4E14;&#x5185;&#x5BB9;&#x4E00;&#x6837;*/</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;from child:%s\n&quot;</span><span class="token punctuation">,</span> something<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*&#x5B50;&#x8FDB;&#x7A0B;&#x4FEE;&#x6539;&#x8FD9;&#x5757;&#x5185;&#x5B58;, &#x4F46;&#x4E0D;&#x5F71;&#x54CD;&#x7236;&#x8FDB;&#x7A0B; C-O-W*/</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>something<span class="token punctuation">,</span> <span class="token string">&quot;change to 11111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;from child:%s\n&quot;</span><span class="token punctuation">,</span> something<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*&#x867D;&#x7136;&#x7236;&#x5B50;&#x8FDB;&#x7A0B;&#x662F;&#x72EC;&#x7ACB;&#x7684;&#x8FDB;&#x7A0B;&#x7A7A;&#x95F4;, &#x4F46;&#x8FD9;&#x91CC;&#x6307;&#x9488;&#x7684;&#x5730;&#x5740;&#x5374;&#x662F;&#x4E00;&#x6837;&#x7684;*/</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;from child:addr %p\n&quot;</span><span class="token punctuation">,</span> something<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*&#x5982;&#x679C;&#x4E0D;&#x8C03;&#x7528;exec*&#x51FD;&#x6570;, &#x548C;exit*&#x51FD;&#x6570;, &#x90A3;&#x4E48;&#x786E;&#x5B9E;&#x9700;&#x8981;&#x5728;&#x5B50;&#x8FDB;&#x7A0B;&#x4E5F;free, &#x6240;&#x4EE5;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x91CC;free&#x5E94;&#x8BE5;&#x5199;&#x5728;&#x6700;&#x540E;return&#x4E4B;&#x524D;, &#x8FD9;&#x6837;&#x7236;&#x5B50;&#x90FD;&#x90FD;&#x8981;&#x8C03;&#x7528;*/</span>
        <span class="token function">free</span><span class="token punctuation">(</span>something<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token comment">//parent</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">int</span> status<span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>status<span class="token punctuation">)</span> <span class="token operator">!=</span> child_pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;from parent:%s\n&quot;</span><span class="token punctuation">,</span> something<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;from parent:addr %p\n&quot;</span><span class="token punctuation">,</span> something<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>something<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;dddddddddddddddddd\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD0;&#x884C;&#x7ED3;&#x679C;</p>
<pre class="language-"><code class="lang-sh">$ gcc test_fork_malloc.c
ASBLX28:/home/yingjieb/tmp
$ ./a.out             
from child:hello
from child:change to <span class="token number">11111</span>
from child:addr 0x84ec010
dddddddddddddddddd
from parent:hello
from parent:addr 0x84ec010
dddddddddddddddddd
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="system_libc_part3.html" class="navigation navigation-prev " aria-label="Previous page: libc概览3">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="system_alpine.html" class="navigation navigation-next " aria-label="Next page: Alpine Linux">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"系统原理杂记","level":"1.15.4","depth":2,"next":{"title":"Alpine Linux","level":"1.15.5","depth":2,"path":"notes/system_alpine.md","ref":"notes/system_alpine.md","articles":[]},"previous":{"title":"libc概览3","level":"1.15.3","depth":2,"path":"notes/system_libc_part3.md","ref":"notes/system_libc_part3.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-livereload","-sharing","-lunr","-search","search-plus","-highlight","theme-comscore","prism","code","chapter-fold","github","splitter","wide-page","hide-navigation-buttons","anchor-navigation-ex","sequence","mermaid-gb3"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"chapter-fold":{},"prism":{"css":["prismjs/themes/prism.css"],"ignore":["mermaid","sequence"]},"sequence":{"theme":"simple"},"github":{"url":"https://github.com/Bai-Yingjie/Bai-Yingjie.github.io"},"splitter":{},"wide-page":{},"code":{"copyButtons":true},"fontsettings":{"theme":"white","family":"sans","size":2},"hide-navigation-buttons":{},"mermaid-gb3":{},"anchor-navigation-ex":{"mode":"float","pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"isRewritePageTitle":true,"showLevel":true,"tocLevel1Icon":"fa fa-hand-o-right","tocLevel2Icon":"fa fa-hand-o-right","tocLevel3Icon":"fa fa-hand-o-right","showGoTop":true,"isShowTocTitleIcon":true,"printLog":false,"multipleH1":true,"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false}},"theme-comscore":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"theme":"default","author":"Bai Yingjie","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"My Notes","language":"zh-hans","gitbook":"*"},"file":{"path":"notes/system_原理杂记.md","mtime":"2022-11-17T15:34:06.801Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-11-17T15:35:10.518Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-mermaid-gb3/book/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-theme-comscore/test.js"></script>
        
    

    <script src="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.min.js"></script>

    </body>
</html>

