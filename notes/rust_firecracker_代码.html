
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>firecracker代码 · My Notes</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Bai Yingjie">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-coldark-cold.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-wide-page/wide.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hide-navigation-buttons/index.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="rust_firecracker_使用.html" />
    
    
    <link rel="prev" href="rust_vmm_简介.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    简介
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Golang</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="golang_汇编_arm64.html">
            
                <a href="golang_汇编_arm64.html">
            
                    
                    汇编语法和arm64小知识
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Rust</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="rust_入门_brief.html">
            
                <a href="rust_入门_brief.html">
            
                    
                    入门系列
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="rust_books.html">
            
                <a href="rust_books.html">
            
                    
                    reference books
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="rust_入门1.html">
            
                <a href="rust_入门1.html">
            
                    
                    安装和基础语法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="rust_入门2.html">
            
                <a href="rust_入门2.html">
            
                    
                    泛型和内存所有权
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="rust_入门3.html">
            
                <a href="rust_入门3.html">
            
                    
                    闭包 容器 迭代器 生成器 线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="rust_工程构建.html">
            
                <a href="rust_工程构建.html">
            
                    
                    工程构建
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="rust_vmm_brief.html">
            
                <a href="rust_vmm_brief.html">
            
                    
                    VMM(virtual machine monitor)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" data-path="rust_vmm_简介.html">
            
                <a href="rust_vmm_简介.html">
            
                    
                    rust-vmm简介
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="3.2.2" data-path="rust_firecracker_代码.html">
            
                <a href="rust_firecracker_代码.html">
            
                    
                    firecracker代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.3" data-path="rust_firecracker_使用.html">
            
                <a href="rust_firecracker_使用.html">
            
                    
                    firecracker使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.4" data-path="rust_cloud-hypervisor_代码.html">
            
                <a href="rust_cloud-hypervisor_代码.html">
            
                    
                    cloud hypervisor代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.5" data-path="rust_cloud-hypervisor_使用.html">
            
                <a href="rust_cloud-hypervisor_使用.html">
            
                    
                    cloud hypervisor使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.6" data-path="rust_cloud-hypervisor_问题与解决.html">
            
                <a href="rust_cloud-hypervisor_问题与解决.html">
            
                    
                    cloud hypervisor问题与解决
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="rust_coding_brief.html">
            
                <a href="rust_coding_brief.html">
            
                    
                    代码积累
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.3.1" data-path="rust_coding_序列化.html">
            
                <a href="rust_coding_序列化.html">
            
                    
                    序列化原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.2" data-path="rust_coding_知识点积累.html">
            
                <a href="rust_coding_知识点积累.html">
            
                    
                    知识点更新
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="others.html">
            
                <a href="others.html">
            
                    
                    其他
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.4.1" data-path="rust_mdbook_使用.html">
            
                <a href="rust_mdbook_使用.html">
            
                    
                    使用mdbook
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >firecracker代码</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#runwithoutapi&#x6D41;&#x7A0B;"><b>1. </b>run_without_api&#x6D41;&#x7A0B;</a></li><ul><li><span class="title-icon "></span><a href="#buildmicrovmfromjson"><b>1.1. </b>build_microvm_from_json</a></li></ul><li><span class="title-icon "></span><a href="#event-manager"><b>2. </b>event manager</a></li><li><span class="title-icon "></span><a href="#aarch64-&#x7269;&#x7406;&#x5185;&#x5B58;layout"><b>3. </b>aarch64 &#x7269;&#x7406;&#x5185;&#x5B58;layout</a></li><li><span class="title-icon "></span><a href="#devicesbus"><b>4. </b>devices::Bus</a></li><li><span class="title-icon "></span><a href="#&#x5E95;&#x5C42;serial"><b>5. </b>&#x5E95;&#x5C42;serial</a></li><ul><li><span class="title-icon "></span><a href="#&#x7528;&#x6CD5;"><b>5.1. </b>&#x7528;&#x6CD5;</a></li><li><span class="title-icon "></span><a href="#serial&#x7ED3;&#x6784;&#x4F53;"><b>5.2. </b>Serial&#x7ED3;&#x6784;&#x4F53;</a></li><li><span class="title-icon "></span><a href="#&#x4E09;&#x4E2A;trait"><b>5.3. </b>&#x4E09;&#x4E2A;Trait</a></li><li><span class="title-icon "></span><a href="#&#x81EA;&#x5B9A;&#x4E49;error"><b>5.4. </b>&#x81EA;&#x5B9A;&#x4E49;Error</a></li><li><span class="title-icon "></span><a href="#&#x7528;noevents&#x7684;&#x5B9E;&#x4F8B;&#x5316;&#x7684;serial"><b>5.5. </b>&#x7528;NoEvents&#x7684;&#x5B9E;&#x4F8B;&#x5316;&#x7684;Serial</a></li><li><span class="title-icon "></span><a href="#driver&#x5728;&#x54EA;&#x91CC;&#x8BFB;&#x5199;"><b>5.6. </b>driver&#x5728;&#x54EA;&#x91CC;&#x8BFB;&#x5199;?</a></li></ul><li><span class="title-icon "></span><a href="#serialwrapper"><b>6. </b>SerialWrapper</a></li><ul><li><span class="title-icon "></span><a href="#&#x4ECE;stdin&#x8BFB;&#x8F93;&#x5165;&#x53D1;&#x7ED9;guest&#x6D41;&#x7A0B;"><b>6.1. </b>&#x4ECE;stdin&#x8BFB;&#x8F93;&#x5165;&#x53D1;&#x7ED9;guest&#x6D41;&#x7A0B;</a></li><li><span class="title-icon "></span><a href="#&#x5B9E;&#x73B0;&#x4E86;busdevice&#x7684;&#x6309;&#x5730;&#x5740;&#x8BFB;&#x5199;&#x7684;trait"><b>6.2. </b>&#x5B9E;&#x73B0;&#x4E86;BusDevice&#x7684;&#x6309;&#x5730;&#x5740;&#x8BFB;&#x5199;&#x7684;trait</a></li></ul><li><span class="title-icon "></span><a href="#attachvirtiodevice"><b>7. </b>attach_virtio_device</a></li><ul><li><span class="title-icon "></span><a href="#vmregisterioeventqueueevt-ioaddr-i--as--u32"><b>7.1. </b>vm.register_ioevent(queue_evt, &amp;io_addr, i  as  u32)</a></li><li><span class="title-icon "></span><a href="#vmregisterirqfd"><b>7.2. </b>vm.register_irqfd</a></li><li><span class="title-icon "></span><a href="#kvm&#x7684;irq&#x76F8;&#x5173;api"><b>7.3. </b>kvm&#x7684;irq&#x76F8;&#x5173;API</a></li><ul><li><span class="title-icon "></span><a href="#kvmcreateirqchip"><b>7.3.1. </b>KVM_CREATE_IRQCHIP</a></li><li><span class="title-icon "></span><a href="#kvmsetgsirouting"><b>7.3.2. </b>KVM_SET_GSI_ROUTING</a></li><li><span class="title-icon "></span><a href="#kvmirqfd"><b>7.3.3. </b>KVM_IRQFD</a></li><li><span class="title-icon "></span><a href="#kvmcreatedevice"><b>7.3.4. </b>KVM_CREATE_DEVICE</a></li><li><span class="title-icon "></span><a href="#arm-gic-v3"><b>7.3.5. </b>ARM gic v3</a></li></ul><li><span class="title-icon "></span><a href="#mmiotransport"><b>7.4. </b>MmioTransport</a></li><ul><li><span class="title-icon "></span><a href="#impl-mmiotransport"><b>7.4.1. </b>impl MmioTransport</a></li><li><span class="title-icon "></span><a href="#&#x5B9E;&#x73B0;busdevice"><b>7.4.2. </b>&#x5B9E;&#x73B0;BusDevice</a></li></ul><li><span class="title-icon "></span><a href="#device"><b>7.5. </b>device</a></li><ul><li><span class="title-icon "></span><a href="#device&#x7684;&#x72B6;&#x6001;&#x6709;"><b>7.5.1. </b>device&#x7684;&#x72B6;&#x6001;&#x6709;</a></li><li><span class="title-icon "></span><a href="#irqtrigger"><b>7.5.2. </b>IrqTrigger</a></li><li><span class="title-icon "></span><a href="#virtiodevice-trait"><b>7.5.3. </b>VirtioDevice trait</a></li></ul><li><span class="title-icon "></span><a href="#virtio&#x8BBE;&#x5907;&#x6846;&#x56FE;"><b>7.6. </b>VirtIO&#x8BBE;&#x5907;&#x6846;&#x56FE;</a></li><li><span class="title-icon "></span><a href="#virtio-net"><b>7.7. </b>virtIO net</a></li><ul><li><span class="title-icon "></span><a href="#net&#x5B9E;&#x73B0;&#x4E86;virtiodevice"><b>7.7.1. </b>Net&#x5B9E;&#x73B0;&#x4E86;VirtioDevice</a></li><li><span class="title-icon "></span><a href="#net&#x8FD8;&#x5B9E;&#x73B0;&#x4E86;muteventsubscriber"><b>7.7.2. </b>Net&#x8FD8;&#x5B9E;&#x73B0;&#x4E86;MutEventSubscriber</a></li></ul></ul></ul></div><a href="#runwithoutapi&#x6D41;&#x7A0B;" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><p>firecracker&#x662F;&#x6700;&#x7EC8;&#x7684;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;:<br><img src="img/rust_firecracker_&#x4EE3;&#x7801;_20220825223907.png" alt="">  </p>
<h1 id="runwithoutapi&#x6D41;&#x7A0B;"><a name="runwithoutapi&#x6D41;&#x7A0B;" class="anchor-navigation-ex-anchor" href="#runwithoutapi&#x6D41;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a>1. run_without_api&#x6D41;&#x7A0B;</h1>
<p>&#x8FD9;&#x91CC;&#x91CD;&#x70B9;&#x8003;&#x5BDF;<code>build/cargo_target/x86_64-unknown-linux-musl/release/firecracker --no-api --config-file myvmconfig.json</code>&#x65B9;&#x5F0F;&#x8FD0;&#x884C;&#x7684;firecracker<br>myvmconfig.json&#x5185;&#x5BB9;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code class="lang-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;boot-source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;kernel_image_path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;build/kernel/linux-5.10/vmlinux-5.10-x86_64.bin&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;boot_args&quot;</span><span class="token operator">:</span> <span class="token string">&quot;console=ttyS0 reboot=k panic=1 pci=off&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;initrd_path&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;drives&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;drive_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rootfs&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;path_on_host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;build/rootfs/bionic.rootfs.ext4&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;is_root_device&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">&quot;partuuid&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;is_read_only&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token property">&quot;cache_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Unsafe&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;io_engine&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Sync&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;rate_limiter&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;machine-config&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;vcpu_count&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;mem_size_mib&quot;</span><span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>
    <span class="token property">&quot;smt&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">&quot;track_dirty_pages&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;balloon&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;network-interfaces&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;vsock&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;logger&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;metrics&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mmds-config&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x7ECF;&#x8FC7;&#x524D;&#x9762;&#x7684;&#x547D;&#x4EE4;&#x884C;&#x53C2;&#x6570;&#x89E3;&#x6790;, &#x6700;&#x540E;&#x8C03;&#x7528;</p>
<pre class="language-"><code class="lang-rust"><span class="token function">run_without_api</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span>seccomp_filters<span class="token punctuation">,</span> <span class="token comment">//&#x8FD9;&#x4E2A;&#x662F;seccomp&#x7684;bpf&#x4EE3;&#x7801;</span>
    vmm_config_json<span class="token punctuation">,</span> <span class="token comment">//&#x8FD9;&#x4E2A;&#x662F;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x5B57;&#x7B26;&#x4E32;</span>
    instance_info<span class="token punctuation">,</span>
    boot_timer_enabled<span class="token punctuation">,</span>
    mmds_size_limit<span class="token punctuation">,</span>
    metadata_json<span class="token punctuation">.</span><span class="token function">as_deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5148;&#x4ECE;json&#x6784;&#x5EFA;vmm, &#x7136;&#x540E;&#x5728;&#x5FAA;&#x73AF;&#x91CC;run:</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">fn</span> <span class="token function-definition function">run_without_api</span><span class="token punctuation">(</span>
    seccomp_filters<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">BpfThreadMap</span><span class="token punctuation">,</span>
    config_json<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    instance_info<span class="token punctuation">:</span> <span class="token class-name">InstanceInfo</span><span class="token punctuation">,</span>
    bool_timer_enabled<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    mmds_size_limit<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    metadata_json<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">FcExitCode</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> event_manager <span class="token operator">=</span> <span class="token class-name">EventManager</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to create EventManager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the firecracker metrics object responsible for periodically printing metrics.</span>
    <span class="token keyword">let</span> firecracker_metrics <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">metrics<span class="token punctuation">::</span></span><span class="token class-name">PeriodicMetrics</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    event_manager<span class="token punctuation">.</span><span class="token function">add_subscriber</span><span class="token punctuation">(</span>firecracker_metrics<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Build the microVm. We can ignore VmResources since it&apos;s not used without api.</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> vmm<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token function">build_microvm_from_json</span><span class="token punctuation">(</span>
        seccomp_filters<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> event_manager<span class="token punctuation">,</span>
        <span class="token comment">// Safe to unwrap since &apos;--no-api&apos; requires this to be set.</span>
        config_json<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        instance_info<span class="token punctuation">,</span>
        bool_timer_enabled<span class="token punctuation">,</span>
        mmds_size_limit<span class="token punctuation">,</span>
        metadata_json<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> vmm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>res<span class="token punctuation">,</span> vmm<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span>exit_code<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">return</span> exit_code<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// Start the metrics.</span>
    firecracker_metrics
        <span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Poisoned lock&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token namespace">metrics<span class="token punctuation">::</span></span><span class="token constant">WRITE_METRICS_PERIOD_MS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Run the EventManager that drives everything in the microVM.</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        event_manager
            <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to start the event manager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>exit_code<span class="token punctuation">)</span> <span class="token operator">=</span> vmm<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shutdown_exit_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> exit_code<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>build_microvm_from_json&#x5C31;&#x7528;&#x5230;&#x4E86;&#x6838;&#x5FC3;&#x6A21;&#x5757;vmm <code>firecracker/src/vmm/src</code></p>
<h2 id="buildmicrovmfromjson"><a name="buildmicrovmfromjson" class="anchor-navigation-ex-anchor" href="#buildmicrovmfromjson"><i class="fa fa-link" aria-hidden="true"></i></a>1.1. build_microvm_from_json</h2>
<pre class="language-"><code class="lang-rust">build_microvm_from_json
    <span class="token comment">//&#x6839;&#x636E;json&#x586B;&#x5145;VmResources&#x7ED3;&#x6784;&#x4F53;&#x5E76;&#x521D;&#x59CB;&#x5316;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> vm_resources <span class="token operator">=</span> <span class="token class-name">VmResources</span><span class="token punctuation">::</span><span class="token function">from_json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> vmm <span class="token operator">=</span> <span class="token namespace">vmm<span class="token punctuation">::</span>builder<span class="token punctuation">::</span></span><span class="token function">build_microvm_for_boot</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vm_resources<span class="token punctuation">)</span>
        <span class="token comment">//&#x5EFA;&#x7ACB;guest&#x5185;&#x5B58;, &#x601D;&#x8DEF;&#x662F;&#x5728;host&#x4E0A;mmap, &#x5E76;&#x8BB0;&#x5F55;&#x5185;&#x5B58;region&#x5230;&#x53D8;&#x91CF;</span>
        <span class="token keyword">let</span> guest_memory <span class="token operator">=</span> <span class="token function">create_guest_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//&#x5728;x86&#x4E0A;, 0-768M&#x662F;&#x5185;&#x5B58;, 768M&#x5230;4G&#x662F;MMIO, 4G&#x4EE5;&#x4E0A;&#x8FD8;&#x662F;&#x5185;&#x5B58;</span>
            <span class="token keyword">let</span> arch_mem_regions <span class="token operator">=</span> <span class="token namespace">arch<span class="token punctuation">::</span></span><span class="token function">arch_memory_regions</span><span class="token punctuation">(</span>mem_size<span class="token punctuation">)</span>
            <span class="token namespace">vm_memory<span class="token punctuation">::</span></span><span class="token function">create_guest_memory</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arch_mem_regions<span class="token punctuation">)</span>
                &#x4E3A;&#x6BCF;&#x4E2A;region mmap&#x4E00;&#x4E2A;region
                    <span class="token comment">//&#x5148;mmap&#x4E00;&#x4E2A;&#x5927;&#x7684;size, size=&#x539F;size+2&#x4E2A;page, &#x5C5E;&#x6027;&#x662F;libc::PROT_NONE</span>
                    <span class="token comment">// Map the guarded range to PROT_NONE</span>
                    <span class="token keyword">let</span> guard_addr <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
                        <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token function">mmap</span><span class="token punctuation">(</span>
                            <span class="token namespace">std<span class="token punctuation">::</span>ptr<span class="token punctuation">::</span></span><span class="token function">null_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            guarded_size<span class="token punctuation">,</span>
                            <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">PROT_NONE</span><span class="token punctuation">,</span>
                            <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">MAP_ANONYMOUS</span> <span class="token operator">|</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">MAP_PRIVATE</span> <span class="token operator">|</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">MAP_NORESERVE</span><span class="token punctuation">,</span>
                            <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                            <span class="token number">0</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>

                    <span class="token comment">//&#x518D;&#x5728;&#x521A;&#x521A;map&#x7684;region&#x91CC;&#x9762;, &#x7528;&#x539F;size map&#x4E00;&#x4E2A;&#x8BFB;&#x5199;region</span>
                    <span class="token comment">// Inside the protected range, starting with guard_addr + PAGE_SIZE,</span>
                    <span class="token comment">// map the requested range with received protection and flags</span>
                    <span class="token keyword">let</span> region_addr <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
                        <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token function">mmap</span><span class="token punctuation">(</span>
                            region_start_addr <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token namespace">libc<span class="token punctuation">::</span></span>c_void<span class="token punctuation">,</span> <span class="token comment">//&#x524D;&#x9762;&#x8FD4;&#x56DE;&#x7684;addr&#x52A0;&#x4E2A;page</span>
                            size<span class="token punctuation">,</span>
                            prot<span class="token punctuation">,</span>
                            flags <span class="token operator">|</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">MAP_FIXED</span><span class="token punctuation">,</span>
                            fd<span class="token punctuation">,</span>
                            offset <span class="token keyword">as</span> <span class="token namespace">libc<span class="token punctuation">::</span></span>off_t<span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token comment">//&#x6700;&#x540E;build MmapRegion&#x5E76;&#x8FD4;&#x56DE;, &#x7528;&#x7684;&#x662F;https://github.com/rust-vmm/vm-memory</span>
                <span class="token comment">//&#x5230;&#x8FD9;&#x91CC;&#x597D;&#x50CF;&#x53EA;&#x662F;&#x751F;&#x6210;GuestMemoryMmap&#x6570;&#x636E;&#x7ED3;&#x679C;, &#x5E76;&#x6CA1;&#x6709;&#x5B9E;&#x9645;&#x64CD;&#x4F5C;&#x5565;</span>
        <span class="token comment">//&#x52A0;&#x8F7D;linux &#x5185;&#x6838;, &#x4EE3;&#x7801;&#x5728;firecracker/src/vmm/src/builder.rs</span>
        <span class="token keyword">let</span> entry_addr <span class="token operator">=</span> <span class="token function">load_kernel</span><span class="token punctuation">(</span>boot_config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>guest_memory<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> kernel_file <span class="token operator">=</span> &#x5148;open kernel&#x6587;&#x4EF6;
            <span class="token comment">//&#x4F7F;&#x7528;&#x4E86;https://github.com/rust-vmm/linux-loader</span>
            <span class="token comment">//&#x4E0B;&#x9762;&#x7684;Loader&#x5728;x86&#x4E0A;&#x662F;ELF, &#x5728;ARM&#x4E0A;&#x662F;PE</span>
            <span class="token comment">//&#x628A;kernel_file&#x52A0;&#x8F7D;&#x5230;guest_memory</span>
            <span class="token keyword">let</span> entry_addr <span class="token operator">=</span> <span class="token class-name">Loader</span><span class="token punctuation">::</span><span class="token function">load</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">,</span> <span class="token class-name">GuestMemoryMmap</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                            <span class="token operator">&amp;</span>guest_memory<span class="token punctuation">,</span> <span class="token operator">&amp;</span>kernel_file<span class="token punctuation">,</span> <span class="token namespace">arch<span class="token punctuation">::</span></span><span class="token function">get_kernel_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment">//&#x4E0A;&#x9762;&#x8FD9;&#x4E2A;get_kernel_start()&#x5728;x86&#x4E0A;&#x662F;1MB, aarch64&#x4E0A;&#x662F;2GB</span>
                            <span class="token comment">//&#x5148;&#x8BFB;elf header, &#x89E3;&#x6790;&#x6240;&#x6709;program header&#x5230;</span>
                            <span class="token keyword">let</span> <span class="token keyword">mut</span> phdrs<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token namespace">elf<span class="token punctuation">::</span></span><span class="token class-name">Elf64_Phdr</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                            <span class="token keyword">for</span> &#x6BCF;&#x4E2A;phdr
                                <span class="token comment">//&#x5199;&#x5165;guest&#x5185;&#x5B58;, &#x4F3C;&#x4E4E;&#x53EA;&#x662F;&#x5199;&#x5165;host&#x4E0A;mmap&#x7684;&#x5185;&#x5B58;. &#x53EF;&#x80FD;&#x540E;&#x9762;&#x4F1A;&#x7528;kvm&#x7684;api&#x628A;&#x8FD9;&#x4E9B;&#x5185;&#x5B58;&#x6620;&#x5C04;&#x6210;guest&#x5185;&#x5B58;</span>
                                guest_mem<span class="token punctuation">.</span><span class="token function">read_exact_from</span><span class="token punctuation">(</span>mem_offset<span class="token punctuation">,</span> kernel_image<span class="token punctuation">,</span> phdr<span class="token punctuation">.</span>p_filesz <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span>

        <span class="token comment">//&#x4ECE;guest_memory find &#x4E00;&#x4E2A;region, &#x5E76;&#x5199;&#x5165;initrd&#x7684;&#x5185;&#x5BB9;;</span>
        <span class="token comment">//&#x5728;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x91CC;, initrd&#x662F;null</span>
        <span class="token keyword">let</span> initrd <span class="token operator">=</span> <span class="token function">load_initrd_from_config</span><span class="token punctuation">(</span>boot_config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>guest_memory<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token comment">//&#x91CD;&#x5199;cmdline, &#x518D;&#x539F;&#x57FA;&#x7840;&#x4E0A;&#x589E;&#x52A0;virtio&#x7B49;&#x914D;&#x7F6E;</span>

        <span class="token comment">//&#x521B;&#x5EFA;VM</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> vmm<span class="token punctuation">,</span> <span class="token keyword">mut</span> vcpus<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">create_vmm_and_vcpus</span><span class="token punctuation">(</span>
            instance_info<span class="token punctuation">,</span>
            event_manager<span class="token punctuation">,</span>
            guest_memory<span class="token punctuation">,</span>
            <span class="token class-name">None</span><span class="token punctuation">,</span>
            track_dirty_pages<span class="token punctuation">,</span>
            vcpu_config<span class="token punctuation">.</span>vcpu_count<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
            <span class="token comment">// Set up Kvm Vm and register memory regions.</span>
            <span class="token comment">//&#x8C03;&#x7528;kvm-ioctls</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> vm <span class="token operator">=</span> <span class="token function">setup_kvm_vm</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>guest_memory<span class="token punctuation">,</span> track_dirty_pages<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
                <span class="token comment">//open /dev/kvm, &#x7136;&#x540E;ioctl KVM_CREATE_VM</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> vm <span class="token operator">=</span> <span class="token class-name">Vm</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                vm<span class="token punctuation">.</span><span class="token function">memory_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token comment">//&#x6BCF;&#x4E2A;region&#x8C03;&#x7528; ioctl KVM_SET_USER_MEMORY_REGION</span>

            <span class="token comment">//MMIO_MEM_START&#x5728;x86&#x4E0A;&#x662F;(4G-768M), &#x5728;aarch64&#x4E0A;&#x662F;1G</span>
            <span class="token comment">//IRQ_BASE&#x5230;IRQ_MAX&#x5728;x86&#x4E0A;&#x662F;5&#x5230;23, &#x5728;aarch64&#x4E0A;&#x662F;32&#x5230;128</span>
            <span class="token comment">//&#x8FD9;&#x91CC;&#x8BF4;&#x7684;&#x662F;virtio&#x8BBE;&#x5907;&#x7528;&#x7684;irq&#x53F7;&#x8303;&#x56F4;</span>
            <span class="token comment">//mmio_device_manager&#x5305;&#x62EC;mmio_base, irq, &#x548C;bus</span>
            <span class="token keyword">let</span> mmio_device_manager <span class="token operator">=</span> <span class="token class-name">MMIODeviceManager</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">arch<span class="token punctuation">::</span></span><span class="token constant">MMIO_MEM_START</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token namespace">arch<span class="token punctuation">::</span></span><span class="token constant">IRQ_BASE</span><span class="token punctuation">,</span> <span class="token namespace">arch<span class="token punctuation">::</span></span><span class="token constant">IRQ_MAX</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//IrqManager&#x662F;&#x7BA1;&#x7406;(first..last)irq&#x8303;&#x56F4;&#x7684;&#x7B80;&#x5355;&#x7ED3;&#x6784;&#x4F53;</span>
                <span class="token class-name">IrqManager</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//device&#x7684;bus&#x662F;&#x4E2A;BtreeMap&#x7EC4;&#x7EC7;&#x7684;&#x6309;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x5212;&#x5206;&#x7684;&#x8BBE;&#x5907;&#x7684;&#x96C6;&#x5408;</span>
                <span class="token namespace">devices<span class="token punctuation">::</span></span><span class="token class-name">Bus</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment">//&#x521B;&#x5EFA;&#x4E2D;&#x65AD;&#x63A7;&#x5236;&#x5668;</span>
            <span class="token function">setup_interrupt_controller</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span>  vm<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
                <span class="token comment">//x86&#x4E0A;&#x662F;ioctl KVM_CREATE_IRQCHIP</span>
                <span class="token comment">//aarch64&#x4E0A;&#x662F;GICv2::create(vm, vcpu_count)</span>
                vm<span class="token punctuation">.</span><span class="token function">setup_irqchip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//&#x65B0;&#x5EFA;&#x4E2A;eventfd</span>
            <span class="token keyword">let</span> vcpus_exit_evt <span class="token operator">=</span> <span class="token class-name">EventFd</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">EFD_NONBLOCK</span><span class="token punctuation">)</span>
            vcpus <span class="token operator">=</span> <span class="token function">create_vcpus</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vm<span class="token punctuation">,</span> vcpu_count<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vcpus_exit_evt<span class="token punctuation">)</span>
                <span class="token comment">//for&#x91CC;&#x521B;&#x5EFA;n&#x4E2A;vCPU, ioctl KVM_CREATE_VCPU</span>
                <span class="token keyword">let</span> vcpu <span class="token operator">=</span> <span class="token class-name">Vcpu</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                vcpu<span class="token punctuation">.</span>kvm_vcpu<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">set_stdout_nonblocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// servial device&#x662F;pio&#x8BBE;&#x5907;, &#x5728;x86&#x4E0A;&#x6709;, aarch64&#x4E0A;&#x6CA1;&#x6709;</span>
            <span class="token keyword">let</span> serial_device <span class="token operator">=</span> <span class="token function">setup_serial_device</span><span class="token punctuation">(</span>event_manager<span class="token punctuation">,</span> stdin<span class="token punctuation">,</span> stdout<span class="token punctuation">)</span>
                <span class="token comment">//&#x7531;Serial device&#x5199;1&#x4EA7;&#x751F;event</span>
                <span class="token keyword">let</span> interrupt_evt <span class="token operator">=</span> <span class="token class-name">EventFdTrigger</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">EventFd</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token constant">EFD_NONBLOCK</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">//&#x8868;&#x793A;in buffer ready</span>
                <span class="token keyword">let</span> kick_stdin_read_evt <span class="token operator">=</span> <span class="token class-name">EventFdTrigger</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">EventFd</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token constant">EFD_NONBLOCK</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">//SerialWrapper&#x662F;event&#x548C;Servial&#x7684;&#x6865;&#x6881;</span>
                <span class="token keyword">let</span> serial <span class="token operator">=</span> <span class="token class-name">SerialWrapper</span> <span class="token punctuation">{</span>
                    serial<span class="token punctuation">:</span> <span class="token class-name">Serial</span><span class="token punctuation">::</span><span class="token function">with_events</span><span class="token punctuation">(</span>
                        interrupt_evt<span class="token punctuation">,</span>
                        <span class="token class-name">SerialEventsWrapper</span> <span class="token punctuation">{</span>
                            metrics<span class="token punctuation">:</span> <span class="token constant">METRICS</span><span class="token punctuation">.</span>uart<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            buffer_ready_event_fd<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>kick_stdin_read_evt<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        out<span class="token punctuation">,</span>
                    <span class="token punctuation">)</span><span class="token punctuation">,</span>
                    input<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//&#x52A0;&#x5165;event manager, &#x6700;&#x540E;&#x7684;event loop&#x91CC;&#x9762;&#x4F1A;&#x76D1;&#x542C;stdin&#x548C;kick_stdin_read_evt fd</span>
                event_manager<span class="token punctuation">.</span><span class="token function">add_subscriber</span><span class="token punctuation">(</span>serial<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//&#x53EA;&#x6709;x86&#x6709;pio device, &#x628A;&#x4E0A;&#x9762;&#x7684;serial_device&#x52A0;&#x5165;&#x5230;pio_device_manager</span>
            <span class="token keyword">let</span> pio_device_manager <span class="token operator">=</span> <span class="token function">create_pio_dev_manager_with_legacy_devices</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vm<span class="token punctuation">,</span> serial_device<span class="token punctuation">,</span> reset_evt<span class="token punctuation">)</span>

            <span class="token keyword">let</span> vmm <span class="token operator">=</span> <span class="token class-name">Vmm</span> <span class="token punctuation">{</span>
                events_observer<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">SerialStdin</span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                instance_info<span class="token punctuation">:</span> instance_info<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                shutdown_exit_code<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                vm<span class="token punctuation">,</span>
                guest_memory<span class="token punctuation">,</span>
                uffd<span class="token punctuation">,</span>
                vcpus_handles<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                vcpus_exit_evt<span class="token punctuation">,</span>
                mmio_device_manager<span class="token punctuation">,</span>
                <span class="token attribute attr-name">#[cfg(target_arch = <span class="token string">&quot;x86_64&quot;</span>)]</span>
                pio_device_manager<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">//&#x6700;&#x540E;&#x8FD4;&#x56DE;vmm, vcpus</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vmm<span class="token punctuation">,</span> vcpus<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">//&#x8FD9;&#x4E2A;&#x662F;&#x7ED9;&#x6D4B;&#x8BD5;&#x7528;&#x7684;, kernel&#x542F;&#x52A8;&#x5B8C;&#x6210;&#x540E;, test&#x7248;&#x672C;&#x7684;init&#x4F1A;&#x76F4;&#x63A5;&#x5199;/dev/mem&#x67D0;&#x4E2A;&#x5730;&#x5740;&#x9B54;&#x672F;&#x5B57;(123)</span>
        <span class="token function">attach_boot_timer_device</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mu vmm<span class="token punctuation">,</span> request_ts<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> boot_timer <span class="token operator">=</span> <span class="token namespace">devices<span class="token punctuation">::</span>pseudo<span class="token punctuation">::</span></span><span class="token class-name">BootTimer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>request_ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//&#x5728;mmio&#x91CC;&#x9762;&#x5206;&#x914D;&#x5730;&#x5740;&#x7A7A;&#x95F4;, &#x6240;&#x8C13;&#x7684;&#x6CE8;&#x518C;&#x5C31;&#x662F;&#x6309;&#x5730;&#x5740;&#x7A7A;&#x95F4;assign&#x8BBE;&#x5907;, &#x8BBE;&#x5907;&#x6709;&#x8BFB;&#x5199;&#x51FD;&#x6570;</span>
            vmm<span class="token punctuation">.</span>mmio_device_manager<span class="token punctuation">.</span><span class="token function">register_mmio_boot_timer</span><span class="token punctuation">(</span>boot_timer<span class="token punctuation">)</span>
        <span class="token comment">//&#x76EE;&#x524D;balloon&#x8BBE;&#x5907;&#x6CA1;&#x4F7F;&#x80FD;</span>
        <span class="token function">attach_balloon_device</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span>  vmm<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span>  boot_cmdline<span class="token punctuation">,</span> balloon<span class="token punctuation">,</span> event_manager<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
            <span class="token function">attach_virtio_device</span><span class="token punctuation">(</span>event_manager<span class="token punctuation">,</span> vmm<span class="token punctuation">,</span> id<span class="token punctuation">,</span> balloon<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span>
                event_manager<span class="token punctuation">.</span><span class="token function">add_subscriber</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> device <span class="token operator">=</span> <span class="token class-name">MmioTransport</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>vmm<span class="token punctuation">.</span><span class="token function">guest_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//&#x5206;&#x914D;mmio&#x5730;&#x5740;&#x8303;&#x56F4;, &#x6CE8;&#x518C;&#x5230;mmio manager; &#x5E76;&#x4FEE;&#x6539;cmdline</span>
                vmm<span class="token punctuation">.</span>mmio_device_manager<span class="token punctuation">.</span><span class="token function">register_mmio_virtio_for_boot</span><span class="token punctuation">(</span>vmm<span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> device<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span>

        <span class="token comment">//&#x53EF;&#x80FD;&#x6709;&#x591A;&#x4E2A;virtio&#x5757;&#x8BBE;&#x5907;</span>
        <span class="token function">attach_block_devices</span><span class="token punctuation">(</span>
            <span class="token operator">&amp;</span><span class="token keyword">mut</span> vmm<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span><span class="token keyword">mut</span> boot_cmdline<span class="token punctuation">,</span>
            vm_resources<span class="token punctuation">.</span>block<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            event_manager<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> &#x6BCF;&#x4E2A; block
                <span class="token comment">//&#x5982;&#x679C;&#x662F;root device, &#x5C31;&#x589E;&#x52A0;cmdline &quot;root=/dev/vda&quot;&#x6216;&quot;root=PARTUUID=partuuid&quot;</span>
                <span class="token comment">//&#x89C1;&#x4E0B;&#x9762;&#x7684;&#x51FD;&#x6570;&#x5206;&#x6790;</span>
                <span class="token function">attach_virtio_device</span><span class="token punctuation">(</span>event_manager<span class="token punctuation">,</span> vmm<span class="token punctuation">,</span> id<span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token comment">//&#x53EF;&#x80FD;&#x6709;&#x591A;&#x4E2A;virtio net&#x8BBE;&#x5907;</span>
        <span class="token function">attach_net_devices</span><span class="token punctuation">(</span>
            <span class="token operator">&amp;</span><span class="token keyword">mut</span> vmm<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span><span class="token keyword">mut</span> boot_cmdline<span class="token punctuation">,</span>
            vm_resources<span class="token punctuation">.</span>net_builder<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            event_manager<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token comment">//&#x5BF9;&#x5E94;virtio socket device</span>
        <span class="token comment">//guest&#x53EF;&#x4EE5;&#x901A;&#x8FC7;AF_VSOCK&#x901A;&#x8FC7;vsock device&#x548C;host&#x7684;AF_UNIX socket&#x901A;&#x4FE1;</span>
        <span class="token function">attach_unixsock_vsock_device</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> vmm<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> boot_cmdline<span class="token punctuation">,</span> unix_vsock<span class="token punctuation">,</span> event_manager<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token function">configure_system_for_boot</span><span class="token punctuation">(</span>
            <span class="token operator">&amp;</span>vmm<span class="token punctuation">,</span>
            vcpus<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            vcpu_config<span class="token punctuation">,</span>
            entry_addr<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>initrd<span class="token punctuation">,</span>
            boot_cmdline<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token comment">//&#x542F;&#x52A8;vcpu&#x5230;pause&#x72B6;&#x6001;</span>
        <span class="token comment">// Move vcpus to their own threads and start their state machine in the &apos;Paused&apos; state.</span>
        vmm<span class="token punctuation">.</span><span class="token function">start_vcpus</span><span class="token punctuation">(</span>
            vcpus<span class="token punctuation">,</span>
            seccomp_filters
                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;vcpu&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">ok_or_else</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">MissingSeccompFilters</span><span class="token punctuation">(</span><span class="token string">&quot;vcpu&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span>
                <span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
            <span class="token comment">//&#x7ED9;&#x6BCF;&#x4E2A;vcpu&#x8D77;&#x4E2A;thread</span>
            <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token class-name">Builder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token comment">//Runs the vCPU in KVM context in a loop. Handles KVM_EXITs then goes back in.</span>
                <span class="token comment">//run&#x7684;&#x903B;&#x8F91;&#x662F;&#x6267;&#x884C;StateMachine&#x5FAA;&#x73AF;</span>
                <span class="token comment">//state machine&#x4ECE;paused&#x5F00;&#x59CB;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//&#x72B6;&#x6001;&#x673A;&#x5FAA;&#x73AF;</span>
                    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>state_fn<span class="token punctuation">)</span> <span class="token operator">=</span> state_machine<span class="token punctuation">.</span>function <span class="token punctuation">{</span>
                        <span class="token comment">// Run the current state handler, and get the next one.</span>
                            state_machine <span class="token operator">=</span> <span class="token function">state_fn</span><span class="token punctuation">(</span>machine<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">//&#x4F7F;&#x80FD;seccomp</span>
        <span class="token namespace">seccompiler<span class="token punctuation">::</span></span><span class="token function">apply_filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// The vcpus start off in the `Paused` state, let them run.</span>
        vmm<span class="token punctuation">.</span><span class="token function">resume_vm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">Internal</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>mmio_device_manager<span class="token punctuation">.</span><span class="token function">kick_devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//&#x5BF9;&#x6BCF;&#x4E2A;vCPU send event</span>

        <span class="token keyword">let</span> vmm <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>vmm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        event_manager<span class="token punctuation">.</span><span class="token function">add_subscriber</span><span class="token punctuation">(</span>vmm<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>VmResources&#x5B9A;&#x4E49;&#x5982;&#x4E0B;:
&#x4E00;&#x4E2A;VMM&#x5C31;&#x7531;block vsock balloon net&#x7B49;builder&#x6784;&#x6210;</p>
<pre class="language-"><code class="lang-rust"><span class="token attribute attr-name">#[derive(Default)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">VmResources</span> <span class="token punctuation">{</span>
    <span class="token comment">/// The vCpu and memory configuration for this microVM.</span>
    vm_config<span class="token punctuation">:</span> <span class="token class-name">VmConfig</span><span class="token punctuation">,</span>
    <span class="token comment">/// The boot configuration for this microVM.</span>
    boot_config<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">BootConfig</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">/// The block devices.</span>
    <span class="token keyword">pub</span> block<span class="token punctuation">:</span> <span class="token class-name">BlockBuilder</span><span class="token punctuation">,</span>
    <span class="token comment">/// The vsock device.</span>
    <span class="token keyword">pub</span> vsock<span class="token punctuation">:</span> <span class="token class-name">VsockBuilder</span><span class="token punctuation">,</span>
    <span class="token comment">/// The balloon device.</span>
    <span class="token keyword">pub</span> balloon<span class="token punctuation">:</span> <span class="token class-name">BalloonBuilder</span><span class="token punctuation">,</span>
    <span class="token comment">/// The network devices builder.</span>
    <span class="token keyword">pub</span> net_builder<span class="token punctuation">:</span> <span class="token class-name">NetBuilder</span><span class="token punctuation">,</span>
    <span class="token comment">/// The optional Mmds data store.</span>
    <span class="token comment">// This is initialised on demand (if ever used), so that we don&apos;t allocate it unless it&apos;s</span>
    <span class="token comment">// actually used.</span>
    <span class="token keyword">pub</span> mmds<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">Mmds</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">/// Data store limit for the mmds.</span>
    <span class="token keyword">pub</span> mmds_size_limit<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    <span class="token comment">/// Whether or not to load boot timer device.</span>
    <span class="token keyword">pub</span> boot_timer<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="event-manager"><a name="event-manager" class="anchor-navigation-ex-anchor" href="#event-manager"><i class="fa fa-link" aria-hidden="true"></i></a>2. event manager</h1>
<p><code>https://github.com/rust-vmm/event-manager</code>
&#x4F7F;&#x7528;&#x4E86;epoll&#x673A;&#x5236;&#x7684;&#x4E8B;&#x4EF6;&#x9A71;&#x52A8;&#x5E93;<br><img src="img/rust_firecracker_&#x4EE3;&#x7801;_20220825225125.png" alt="">  </p>
<p>&#x57FA;&#x672C;&#x4E0A;&#x662F;&#x4E2A;epoll&#x7684;event loop, event subscriber&#x6CE8;&#x518C;&#x7684;&#x65F6;&#x5019;&#x6389;&#x54DF;init, &#x5728;loop&#x91CC;&#x6709;&#x5BF9;&#x5E94;&#x7684;event&#x5C31;&#x8C03;&#x7528;process.</p>
<h1 id="aarch64-&#x7269;&#x7406;&#x5185;&#x5B58;layout"><a name="aarch64-&#x7269;&#x7406;&#x5185;&#x5B58;layout" class="anchor-navigation-ex-anchor" href="#aarch64-&#x7269;&#x7406;&#x5185;&#x5B58;layout"><i class="fa fa-link" aria-hidden="true"></i></a>3. aarch64 &#x7269;&#x7406;&#x5185;&#x5B58;layout</h1>
<pre class="language-"><code class="lang-rust"><span class="token comment">//      ==== Address map in use in ARM development systems today ====</span>
<span class="token comment">//</span>
<span class="token comment">//              - 32-bit -              - 36-bit -          - 40-bit -</span>
<span class="token comment">//1024GB    +                   +                      +-------------------+     &lt;- 40-bit</span>
<span class="token comment">//          |                                           | DRAM              |</span>
<span class="token comment">//          ~                   ~                       ~                   ~</span>
<span class="token comment">//          |                                           |                   |</span>
<span class="token comment">//          |                                           |                   |</span>
<span class="token comment">//          |                                           |                   |</span>
<span class="token comment">//          |                                           |                   |</span>
<span class="token comment">//544GB     +                   +                       +-------------------+</span>
<span class="token comment">//          |                                           | Hole or DRAM      |</span>
<span class="token comment">//          |                                           |                   |</span>
<span class="token comment">//512GB     +                   +                       +-------------------+</span>
<span class="token comment">//          |                                           |       Mapped      |</span>
<span class="token comment">//          |                                           |       I/O         |</span>
<span class="token comment">//          ~                   ~                       ~                   ~</span>
<span class="token comment">//          |                                           |                   |</span>
<span class="token comment">//256GB     +                   +                       +-------------------+</span>
<span class="token comment">//          |                                           |       Reserved    |</span>
<span class="token comment">//          ~                   ~                       ~                   ~</span>
<span class="token comment">//          |                                           |                   |</span>
<span class="token comment">//64GB      +                   +-----------------------+-------------------+   &lt;- 36-bit</span>
<span class="token comment">//          |                   |                   DRAM                    |</span>
<span class="token comment">//          ~                   ~                   ~                       ~</span>
<span class="token comment">//          |                   |                                           |</span>
<span class="token comment">//          |                   |                                           |</span>
<span class="token comment">//34GB      +                   +-----------------------+-------------------+</span>
<span class="token comment">//          |                   |                  Hole or DRAM             |</span>
<span class="token comment">//32GB      +                   +-----------------------+-------------------+</span>
<span class="token comment">//          |                   |                   Mapped I/O              |</span>
<span class="token comment">//          ~                   ~                       ~                   ~</span>
<span class="token comment">//          |                   |                                           |</span>
<span class="token comment">//16GB      +                   +-----------------------+-------------------+</span>
<span class="token comment">//          |                   |                   Reserved                |</span>
<span class="token comment">//          ~                   ~                       ~                   ~</span>
<span class="token comment">//4GB       +-------------------+-----------------------+-------------------+   &lt;- 32-bit</span>
<span class="token comment">//          |           2GB of DRAM                                         |</span>
<span class="token comment">//          |                                                               |</span>
<span class="token comment">//2GB       +-------------------+-----------------------+-------------------+</span>
<span class="token comment">//          |                           Mapped I/O                          |</span>
<span class="token comment">//1GB       +-------------------+-----------------------+-------------------+</span>
<span class="token comment">//          |                          ROM &amp; RAM &amp; I/O                      |</span>
<span class="token comment">//0GB       +-------------------+-----------------------+-------------------+   0</span>
<span class="token comment">//              - 32-bit -              - 36-bit -              - 40-bit -</span>
<span class="token comment">//</span>
<span class="token comment">// Taken from (http://infocenter.arm.com/help/topic/com.arm.doc.den0001c/DEN0001C_principles_of_arm_memory_maps.pdf).</span>

<span class="token comment">/// Start of RAM on 64 bit ARM.</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">DRAM_MEM_START</span><span class="token punctuation">:</span> <span class="token keyword">u64</span> <span class="token operator">=</span> <span class="token number">0x8000_0000</span><span class="token punctuation">;</span> <span class="token comment">// 2 GB.</span>
<span class="token comment">/// The maximum RAM size.</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">DRAM_MEM_MAX_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">u64</span> <span class="token operator">=</span> <span class="token number">0x00FF_8000_0000</span><span class="token punctuation">;</span> <span class="token comment">// 1024 - 2 = 1022G.</span>

<span class="token comment">/// Kernel command line maximum size.</span>
<span class="token comment">/// As per `arch/arm64/include/uapi/asm/setup.h`.</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">CMDLINE_MAX_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">2048</span><span class="token punctuation">;</span>

<span class="token comment">/// Maximum size of the device tree blob as specified in https://www.kernel.org/doc/Documentation/arm64/booting.txt.</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">FDT_MAX_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0x20_0000</span><span class="token punctuation">;</span>

<span class="token comment">// As per virt/kvm/arm/vgic/vgic-kvm-device.c we need</span>
<span class="token comment">// the number of interrupts our GIC will support to be:</span>
<span class="token comment">// * bigger than 32</span>
<span class="token comment">// * less than 1023 and</span>
<span class="token comment">// * a multiple of 32.</span>
<span class="token comment">/// The highest usable SPI on aarch64.</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">IRQ_MAX</span><span class="token punctuation">:</span> <span class="token keyword">u32</span> <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>

<span class="token comment">/// First usable interrupt on aarch64.</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">IRQ_BASE</span><span class="token punctuation">:</span> <span class="token keyword">u32</span> <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>

<span class="token comment">/// Below this address will reside the GIC, above this address will reside the MMIO devices.</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">MAPPED_IO_START</span><span class="token punctuation">:</span> <span class="token keyword">u64</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span> <span class="token comment">// 1 GB</span>
</code></pre>
<h1 id="devicesbus"><a name="devicesbus" class="anchor-navigation-ex-anchor" href="#devicesbus"><i class="fa fa-link" aria-hidden="true"></i></a>4. devices::Bus</h1>
<p>&#x4E00;&#x4E2A;device&#x90FD;&#x5BF9;&#x5E94;&#x4E00;&#x6BB5;&#x5730;&#x5740;&#x7A7A;&#x95F4;, &#x4E00;&#x4E2A;bus&#x5305;&#x62EC;&#x591A;&#x4E2A;device, &#x6309;BtreeMap&#x7EC4;&#x7EC7;, key&#x662F;device&#x7684;&#x5730;&#x5740;&#x8303;&#x56F4;, value&#x662F;BusDevice</p>
<pre class="language-"><code class="lang-rust"><span class="token comment">/// A device container for routing reads and writes over some address space.</span>
<span class="token comment">///</span>
<span class="token comment">/// This doesn&apos;t have any restrictions on what kind of device or address space this applies to. The</span>
<span class="token comment">/// only restriction is that no two devices can overlap in this address space.</span>
<span class="token attribute attr-name">#[derive(Clone, Default)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Bus</span> <span class="token punctuation">{</span>
    <span class="token comment">//bus&#x4E0B;&#x9762;&#x662F;BtreeMap&#x7BA1;&#x7406;&#x7684;device</span>
    devices<span class="token punctuation">:</span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">BusRange</span><span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">BusDevice</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Bus&#x6709;get_device, insert, read, write&#x65B9;&#x6CD5;.
read&#x548C;write&#x7684;&#x57FA;&#x672C;&#x903B;&#x8F91;&#x662F;&#x901A;&#x8FC7;&#x5730;&#x5740;&#x6765;&#x5224;&#x65AD;&#x662F;&#x54EA;&#x4E2A;device, &#x7136;&#x540E;lock&#x8FD9;&#x4E2A;&#x8BBE;&#x5907;, &#x7136;&#x540E;read/write
&#x6BD4;&#x5982;:</p>
<pre class="language-"><code class="lang-rust">    <span class="token comment">/// Reads data from the device that owns the range containing `addr` and puts it into `data`.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// Returns true on success, otherwise `data` is untouched.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> addr<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token comment">//self.get_device(addr)&#x8FD4;&#x56DE;(offset,dev), offset&#x5C31;&#x662F;&quot;&#x8BBE;&#x5907;&#x5185;&quot;&#x504F;&#x79FB;&#x5730;&#x5740;</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_device</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// OK to unwrap as lock() failing is a serious error condition and should panic.</span>
            dev<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to acquire device lock&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token boolean">true</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h1 id="&#x5E95;&#x5C42;serial"><a name="&#x5E95;&#x5C42;serial" class="anchor-navigation-ex-anchor" href="#&#x5E95;&#x5C42;serial"><i class="fa fa-link" aria-hidden="true"></i></a>5. &#x5E95;&#x5C42;serial</h1>
<p><code>vm-superio-0.5.0/src/serial.rs</code>
serial&#x662F;&#x4E2A;&#x6CDB;&#x578B;&#x7684;&#x7ED3;&#x6784;&#x4F53;:</p>
<blockquote>
<p>The serial console emulation is done by emulating a serial COM port.
Each serial COM port (COM1-4) has an associated Port I/O address base and 12 registers mapped into 8 consecutive Port I/O locations (with the first one being the base). This structure emulates the registers that make sense for UART 16550 (and below) and helps in the interaction between the driver and device by using a <a href="https://docs.rs/vm_superio/0.5.0/vm_superio/trait.Trigger.html" target="_blank"><code>Trigger</code></a> object for notifications. It also writes the guest&apos;s output to an <code>out</code> Write object.</p>
</blockquote>
<p>serial&#x6A21;&#x62DF;&#x4E86;UART&#x7684;16550&#x7684;12&#x4E2A;&#x5BC4;&#x5B58;&#x5668;</p>
<h2 id="&#x7528;&#x6CD5;"><a name="&#x7528;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#&#x7528;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>5.1. &#x7528;&#x6CD5;</h2>
<pre class="language-"><code class="lang-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token punctuation">{</span>sink<span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token class-name">Deref</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">vm_superio<span class="token punctuation">::</span></span><span class="token class-name">Trigger</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">vm_superio<span class="token punctuation">::</span></span><span class="token class-name">Serial</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">vmm_sys_util<span class="token punctuation">::</span>eventfd<span class="token punctuation">::</span></span><span class="token class-name">EventFd</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">EventFdTrigger</span><span class="token punctuation">(</span><span class="token class-name">EventFd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">impl</span> <span class="token class-name">Trigger</span> <span class="token keyword">for</span> <span class="token class-name">EventFdTrigger</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">E</span> <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">trigger</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">EventFdTrigger</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Target</span> <span class="token operator">=</span> <span class="token class-name">EventFd</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Target</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">EventFdTrigger</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>flag<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">EventFdTrigger</span><span class="token punctuation">(</span><span class="token class-name">EventFd</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">try_clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">EventFdTrigger</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">try_clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> intr_evt <span class="token operator">=</span> <span class="token class-name">EventFdTrigger</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">EFD_NONBLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> serial <span class="token operator">=</span> <span class="token class-name">Serial</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>intr_evt<span class="token punctuation">.</span><span class="token function">try_clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// std::io::Sink can be used if user is not interested in guest&apos;s output.</span>
<span class="token keyword">let</span> serial_with_sink <span class="token operator">=</span> <span class="token class-name">Serial</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>intr_evt<span class="token punctuation">,</span> <span class="token function">sink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Write 0x01 to THR register.</span>
serial<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Read from RBR register.</span>
<span class="token keyword">let</span> value <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Send more bytes to the guest in one shot.</span>
<span class="token keyword">let</span> input <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token char">b&apos;a&apos;</span><span class="token punctuation">,</span> <span class="token char">b&apos;b&apos;</span><span class="token punctuation">,</span> <span class="token char">b&apos;c&apos;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// Before enqueuing bytes we first check if there is enough free space</span>
<span class="token comment">// in the FIFO.</span>
<span class="token keyword">if</span> serial<span class="token punctuation">.</span><span class="token function">fifo_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> input<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    serial<span class="token punctuation">.</span><span class="token function">enqueue_raw_bytes</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="serial&#x7ED3;&#x6784;&#x4F53;"><a name="serial&#x7ED3;&#x6784;&#x4F53;" class="anchor-navigation-ex-anchor" href="#serial&#x7ED3;&#x6784;&#x4F53;"><i class="fa fa-link" aria-hidden="true"></i></a>5.2. Serial&#x7ED3;&#x6784;&#x4F53;</h2>
<p>&#x8FD9;&#x662F;&#x4E2A;&#x6CDB;&#x578B;, &#x9700;&#x8981;&#x7528;&#x4E09;&#x4E2A;trait: Trigger, SerialEvents, Write&#x6765;&#x5B9E;&#x4F8B;&#x5316;.</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Serial</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trigger</span><span class="token punctuation">,</span> <span class="token constant">EV</span><span class="token punctuation">:</span> <span class="token class-name">SerialEvents</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">:</span> <span class="token class-name">Write</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Some UART registers.</span>
    baud_divisor_low<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    baud_divisor_high<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    interrupt_enable<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    interrupt_identification<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    line_control<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    line_status<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    modem_control<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    modem_status<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    scratch<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    <span class="token comment">// This is the buffer that is used for achieving the Receiver register</span>
    <span class="token comment">// functionality in FIFO mode. Reading from RBR will return the oldest</span>
    <span class="token comment">// unread byte from the RX FIFO.</span>
    in_buffer<span class="token punctuation">:</span> <span class="token class-name">VecDeque</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// Used for notifying the driver about some in/out events.</span>
    interrupt_evt<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span>
    events<span class="token punctuation">:</span> <span class="token constant">EV</span><span class="token punctuation">,</span>
    out<span class="token punctuation">:</span> <span class="token class-name">W</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x4E09;&#x4E2A;trait"><a name="&#x4E09;&#x4E2A;trait" class="anchor-navigation-ex-anchor" href="#&#x4E09;&#x4E2A;trait"><i class="fa fa-link" aria-hidden="true"></i></a>5.3. &#x4E09;&#x4E2A;Trait</h2>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">SerialEvents</span> <span class="token punctuation">{</span>
    <span class="token comment">/// The driver reads data from the input buffer.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">buffer_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// The driver successfully wrote one byte to serial output.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">out_byte</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// An error occurred while writing a byte to serial output resulting in a lost byte.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">tx_lost_byte</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// This event can be used by the consumer to re-enable events coming from</span>
    <span class="token comment">/// the serial input.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">in_buffer_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//&#x4E00;&#x822C;&#x90FD;&#x662F;EventFD, &#x7528;&#x4E8E;trigger&#x901A;&#x77E5;guest driver?</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Trigger</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Underlying type for the potential error conditions returned by `Self::trigger`.</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">E</span><span class="token punctuation">;</span>

    <span class="token comment">/// Trigger an event.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">trigger</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">E</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//Write&#x5C31;&#x662F;io&#x54EA;&#x4E2A;Write</span>
</code></pre>
<h2 id="&#x81EA;&#x5B9A;&#x4E49;error"><a name="&#x81EA;&#x5B9A;&#x4E49;error" class="anchor-navigation-ex-anchor" href="#&#x81EA;&#x5B9A;&#x4E49;error"><i class="fa fa-link" aria-hidden="true"></i></a>5.4. &#x81EA;&#x5B9A;&#x4E49;Error</h2>
<pre class="language-"><code class="lang-rust"><span class="token comment">/// Errors encountered while handling serial console operations.</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Error</span><span class="token operator">&lt;</span><span class="token class-name">E</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Failed to trigger interrupt.</span>
    <span class="token class-name">Trigger</span><span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">/// Couldn&apos;t write/flush to the given destination.</span>
    <span class="token class-name">IOError</span><span class="token punctuation">(</span><span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">/// No space left in FIFO.</span>
    <span class="token class-name">FullFifo</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x7528;noevents&#x7684;&#x5B9E;&#x4F8B;&#x5316;&#x7684;serial"><a name="&#x7528;noevents&#x7684;&#x5B9E;&#x4F8B;&#x5316;&#x7684;serial" class="anchor-navigation-ex-anchor" href="#&#x7528;noevents&#x7684;&#x5B9E;&#x4F8B;&#x5316;&#x7684;serial"><i class="fa fa-link" aria-hidden="true"></i></a>5.5. &#x7528;NoEvents&#x7684;&#x5B9E;&#x4F8B;&#x5316;&#x7684;Serial</h2>
<p>NoEvents&#x7ED3;&#x6784;&#x4F53;&#x5C31;&#x662F;&#x5B9E;&#x73B0;&#x4E86;&#x4E00;&#x4E2A;&#x5565;&#x4E5F;&#x4E0D;&#x5E72;&#x7684;SerialEvents</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">NoEvents</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">SerialEvents</span> <span class="token keyword">for</span> <span class="token class-name">NoEvents</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">buffer_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">out_byte</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">tx_lost_byte</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">in_buffer_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4E00;&#x4E2A;&#x66F4;&#x5177;&#x4F53;&#x7684;&#x5B9E;&#x4F8B;&#x5316;:</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trigger</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">:</span> <span class="token class-name">Write</span><span class="token operator">&gt;</span> <span class="token class-name">Serial</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">NoEvents</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Creates a new `Serial` instance which writes the guest&apos;s output to</span>
    <span class="token comment">/// `out` and uses `trigger` object to notify the driver about new</span>
    <span class="token comment">/// events.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Arguments</span>
    <span class="token comment">/// * `trigger` - The Trigger object that will be used to notify the driver</span>
    <span class="token comment">///               about events.</span>
    <span class="token comment">/// * `out` - An object for writing guest&apos;s output to. In case the output</span>
    <span class="token comment">///           is not of interest,</span>
    <span class="token comment">///           [std::io::Sink](https://doc.rust-lang.org/std/io/struct.Sink.html)</span>
    <span class="token comment">///           can be used here.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Example</span>
    <span class="token comment">///</span>
    <span class="token comment">/// You can see an example of how to use this function in the</span>
    <span class="token comment">/// [`Example` section from `Serial`](struct.Serial.html#example).</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>trigger<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span> out<span class="token punctuation">:</span> <span class="token class-name">W</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Serial</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">NoEvents</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">with_events</span><span class="token punctuation">(</span>trigger<span class="token punctuation">,</span> <span class="token class-name">NoEvents</span><span class="token punctuation">,</span> out<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x540C;&#x6837;&#x7684;<code>Serial<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">T:</span></span> <span class="token attr-name">Trigger,</span> <span class="token attr-name"><span class="token namespace">EV:</span></span> <span class="token attr-name">SerialEvents,</span> <span class="token attr-name"><span class="token namespace">W:</span></span> <span class="token attr-name">Write</span><span class="token punctuation">&gt;</span></span></code>&#x662F;&#x8303;&#x56F4;&#x66F4;&#x5927;&#x7684;&#x6CDB;&#x578B;:</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trigger</span><span class="token punctuation">,</span> <span class="token constant">EV</span><span class="token punctuation">:</span> <span class="token class-name">SerialEvents</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">:</span> <span class="token class-name">Write</span><span class="token operator">&gt;</span> <span class="token class-name">Serial</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token constant">EV</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Creates a new `Serial` instance which writes the guest&apos;s output to</span>
    <span class="token comment">/// `out`, uses `trigger` object to notify the driver about new</span>
    <span class="token comment">/// events, and invokes the `serial_evts` implementation of `SerialEvents`</span>
    <span class="token comment">/// during operation.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Arguments</span>
    <span class="token comment">/// * `trigger` - The `Trigger` object that will be used to notify the driver</span>
    <span class="token comment">///               about events.</span>
    <span class="token comment">/// * `serial_evts` - The `SerialEvents` implementation used to track the occurrence</span>
    <span class="token comment">///                   of significant events in the serial operation logic.</span>
    <span class="token comment">/// * `out` - An object for writing guest&apos;s output to. In case the output</span>
    <span class="token comment">///           is not of interest,</span>
    <span class="token comment">///           [std::io::Sink](https://doc.rust-lang.org/std/io/struct.Sink.html)</span>
    <span class="token comment">///           can be used here.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">with_events</span><span class="token punctuation">(</span>trigger<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span> serial_evts<span class="token punctuation">:</span> <span class="token constant">EV</span><span class="token punctuation">,</span> out<span class="token punctuation">:</span> <span class="token class-name">W</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token comment">//&#x7528;&#x4E86;&#x5F88;&#x591A;const&#x5B9A;&#x4E49;&#x4E2A;u8&#x7684;&#x5E38;&#x91CF;, &#x6BD4;&#x5982;DEFAULT_BAUD_DIVISOR_LOW&#x662F;0x0C</span>
        <span class="token class-name">Serial</span> <span class="token punctuation">{</span>
            baud_divisor_low<span class="token punctuation">:</span> <span class="token constant">DEFAULT_BAUD_DIVISOR_LOW</span><span class="token punctuation">,</span>
            baud_divisor_high<span class="token punctuation">:</span> <span class="token constant">DEFAULT_BAUD_DIVISOR_HIGH</span><span class="token punctuation">,</span>
            interrupt_enable<span class="token punctuation">:</span> <span class="token constant">DEFAULT_INTERRUPT_ENABLE</span><span class="token punctuation">,</span>
            interrupt_identification<span class="token punctuation">:</span> <span class="token constant">DEFAULT_INTERRUPT_IDENTIFICATION</span><span class="token punctuation">,</span>
            line_control<span class="token punctuation">:</span> <span class="token constant">DEFAULT_LINE_CONTROL</span><span class="token punctuation">,</span>
            line_status<span class="token punctuation">:</span> <span class="token constant">DEFAULT_LINE_STATUS</span><span class="token punctuation">,</span>
            modem_control<span class="token punctuation">:</span> <span class="token constant">DEFAULT_MODEM_CONTROL</span><span class="token punctuation">,</span>
            modem_status<span class="token punctuation">:</span> <span class="token constant">DEFAULT_MODEM_STATUS</span><span class="token punctuation">,</span>
            scratch<span class="token punctuation">:</span> <span class="token constant">DEFAULT_SCRATCH</span><span class="token punctuation">,</span>
            in_buffer<span class="token punctuation">:</span> <span class="token class-name">VecDeque</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            interrupt_evt<span class="token punctuation">:</span> trigger<span class="token punctuation">,</span>
            events<span class="token punctuation">:</span> serial_evts<span class="token punctuation">,</span>
            out<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Provides a reference to the interrupt event object.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">interrupt_evt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token class-name">T</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>interrupt_evt
    <span class="token punctuation">}</span>

    <span class="token comment">/// Provides a reference to the serial events object.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">events</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token constant">EV</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>events
    <span class="token punctuation">}</span>

    <span class="token comment">//&#x5177;&#x4F53;&#x64CD;&#x4F5C;, &#x79C1;&#x6709;&#x65B9;&#x6CD5;, &#x57FA;&#x672C;&#x4E0A;&#x662F;&#x5BF9;&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5404;field&#x8FDB;&#x884C;&#x64CD;&#x4F5C;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">is_dlab_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>line_control <span class="token operator">&amp;</span> <span class="token constant">LCR_DLAB_BIT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//&#x8FD8;&#x6709;&#x5F88;&#x591A;, &#x7701;&#x7565;</span>

    <span class="token comment">//&#x8BFB;&#x5199;&#x51FD;&#x6570;, &#x8C01;&#x6765;&#x8BFB;&#x5199;? driver</span>

    <span class="token comment">//write&#x4E0D;&#x662F;io Write&#x7684;&#x683C;&#x5F0F;, offset&#x662F;&#x9884;&#x5B9A;&#x4E49;&#x7684;&#x5E38;&#x91CF;&#x8868;&#x4E2D;&#x7684;&#x5E38;&#x91CF;</span>

    <span class="token comment">/// Handles a write request from the driver at `offset` offset from the</span>
    <span class="token comment">/// base Port I/O address.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Arguments</span>
    <span class="token comment">/// * `offset` - The offset that will be added to the base PIO address</span>
    <span class="token comment">///              for writing to a specific register.</span>
    <span class="token comment">/// * `value` - The byte that should be written.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Example</span>
    <span class="token comment">///</span>
    <span class="token comment">/// You can see an example of how to use this function in the</span>
    <span class="token comment">/// [`Example` section from `Serial`](struct.Serial.html#example).</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> offset<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">E</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> offset <span class="token punctuation">{</span>
            <span class="token constant">DLAB_LOW_OFFSET</span> <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_dlab_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>baud_divisor_low <span class="token operator">=</span> value<span class="token punctuation">,</span>
            <span class="token constant">DLAB_HIGH_OFFSET</span> <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_dlab_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>baud_divisor_high <span class="token operator">=</span> value<span class="token punctuation">,</span>
            <span class="token comment">//&#x5173;&#x952E;&#x8DEF;&#x5F84;, &#x6BCF;&#x6B21;&#x5199;&#x5165;&#x4E00;&#x4E2A;&#x5B57;&#x8282;; &#x5199;&#x5230;stdout</span>
            <span class="token constant">DATA_OFFSET</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">self</span>
                        <span class="token punctuation">.</span>out <span class="token comment">//&#x91CD;&#x70B9;&#x662F;&#x8FD9;&#x91CC;, &#x8FD9;&#x4E2A;out&#x4E00;&#x822C;&#x662F;stdout, guest driver&#x7684;write, &#x901A;&#x8FC7;&#x8FD9;&#x91CC;&#x7684;Serial Device(Self), &#x5199;&#x5230;stdout</span>
                        <span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">IOError</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">and_then</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">self</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">IOError</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">self</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">out_byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>err<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                            <span class="token keyword">self</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">tx_lost_byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            err
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// Because we cannot block the driver, the THRE interrupt is sent</span>
                    <span class="token comment">// irrespective of whether we are able to write the byte or not</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">thr_empty_interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">Trigger</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//&#x8BFB;&#x7684;&#x903B;&#x8F91;&#x662F;&#x4ECE;self.in_buffer pop&#x51FA;&#x4E00;&#x4E2A;&#x5B57;&#x8282;, &#x8FD4;&#x56DE;&#x7ED9;&#x8C03;&#x7528;&#x8005;.</span>

    <span class="token comment">/// Handles a read request from the driver at `offset` offset from the</span>
    <span class="token comment">/// base Port I/O address.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// Returns the read value.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Arguments</span>
    <span class="token comment">/// * `offset` - The offset that will be added to the base PIO address</span>
    <span class="token comment">///              for reading from a specific register.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Example</span>
    <span class="token comment">///</span>
    <span class="token comment">/// You can see an example of how to use this function in the</span>
    <span class="token comment">/// [`Example` section from `Serial`](struct.Serial.html#example).</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> offset<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u8</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> offset <span class="token punctuation">{</span>
            <span class="token constant">DLAB_LOW_OFFSET</span> <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_dlab_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>baud_divisor_low<span class="token punctuation">,</span>
            <span class="token constant">DLAB_HIGH_OFFSET</span> <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_dlab_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>baud_divisor_high<span class="token punctuation">,</span>
            <span class="token constant">DATA_OFFSET</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// Here we emulate the reset method for when RDA interrupt</span>
                <span class="token comment">// was raised (i.e. read the receive buffer and clear the</span>
                <span class="token comment">// interrupt identification register and RDA bit when no</span>
                <span class="token comment">// more data is available).</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">del_interrupt</span><span class="token punctuation">(</span><span class="token constant">IIR_RDA_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> byte <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>in_buffer<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_or_default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>in_buffer<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">clear_lsr_rda_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">in_buffer_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">buffer_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                byte
            <span class="token punctuation">}</span>
            <span class="token constant">LCR_OFFSET</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>line_control<span class="token punctuation">,</span>
            <span class="token constant">MCR_OFFSET</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>modem_control<span class="token punctuation">,</span>
            <span class="token constant">LSR_OFFSET</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>line_status<span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Returns how much space is still available in the FIFO.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Example</span>
    <span class="token comment">///</span>
    <span class="token comment">/// You can see an example of how to use this function in the</span>
    <span class="token comment">/// [`Example` section from `Serial`](struct.Serial.html#example).</span>
    <span class="token attribute attr-name">#[inline]</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">fifo_capacity</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">usize</span> <span class="token punctuation">{</span>
        <span class="token constant">FIFO_SIZE</span> <span class="token operator">-</span> <span class="token keyword">self</span><span class="token punctuation">.</span>in_buffer<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Helps in sending more bytes to the guest in one shot, by storing</span>
    <span class="token comment">/// `input` bytes in UART buffer and letting the driver know there is</span>
    <span class="token comment">/// some pending data to be read by setting RDA bit and its corresponding</span>
    <span class="token comment">/// interrupt when not already triggered.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Arguments</span>
    <span class="token comment">/// * `input` - The data to be sent to the guest.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Returns</span>
    <span class="token comment">///</span>
    <span class="token comment">/// The function returns the number of bytes it was able to write to the fifo,</span>
    <span class="token comment">/// or `FullFifo` error when the fifo is full. Users can use</span>
    <span class="token comment">/// [`fifo_capacity`](#method.fifo_capacity) before calling this function</span>
    <span class="token comment">/// to check the available space.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Example</span>
    <span class="token comment">///</span>
    <span class="token comment">/// You can see an example of how to use this function in the</span>
    <span class="token comment">/// [`Example` section from `Serial`](struct.Serial.html#example).</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">enqueue_raw_bytes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">E</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> write_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_in_loop_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">fifo_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">FullFifo</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            write_count <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>cmp<span class="token punctuation">::</span></span><span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">fifo_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> write_count <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>in_buffer<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..</span>write_count<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">set_lsr_rda_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//&#x5C31;&#x662F;&#x7ED9;Self.interrupt_evt&#x8FD9;&#x4E2A;eventfd&#x5199;1</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">received_data_interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">Trigger</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>write_count<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="driver&#x5728;&#x54EA;&#x91CC;&#x8BFB;&#x5199;"><a name="driver&#x5728;&#x54EA;&#x91CC;&#x8BFB;&#x5199;" class="anchor-navigation-ex-anchor" href="#driver&#x5728;&#x54EA;&#x91CC;&#x8BFB;&#x5199;"><i class="fa fa-link" aria-hidden="true"></i></a>5.6. driver&#x5728;&#x54EA;&#x91CC;&#x8BFB;&#x5199;?</h2>
<p>&#x5F85;&#x7EED;</p>
<h1 id="serialwrapper"><a name="serialwrapper" class="anchor-navigation-ex-anchor" href="#serialwrapper"><i class="fa fa-link" aria-hidden="true"></i></a>6. SerialWrapper</h1>
<p>SerialWrapper&#x5305;&#x62EC;&#x4E86;&#x5E95;&#x5C42;Serial&#x8BBE;&#x5907;&#x548C;input
SerialWrapper: <code>firecracker/src/devices/src/legacy/serial.rs</code>
&#x5E95;&#x5C42;Serial: <code>vm-superio-0.5.0/src/serial.rs</code></p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">SerialWrapper</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trigger</span><span class="token punctuation">,</span> <span class="token constant">EV</span><span class="token punctuation">:</span> <span class="token class-name">SerialEvents</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">:</span> <span class="token class-name">Write</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> serial<span class="token punctuation">:</span> <span class="token class-name">Serial</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token constant">EV</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> input<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">ReadableFd</span> <span class="token operator">+</span> <span class="token class-name">Send</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x662F;Serial device&#x548C;event loop&#x4E4B;&#x95F4;&#x7684;&#x6865;&#x6881;.
&#x4E4B;&#x95F4;&#x7528;eventfd&#x6765;&#x901A;&#x77E5;</p>
<pre class="language-"><code>Host                VMM                        Guest
stdin/stdout        Serial&#x8BBE;&#x5907; read/write      driver
</code></pre><p>&#x5177;&#x4F53;&#x6765;&#x8BB2;, guest driver&#x901A;&#x8FC7;BusDevice&#x5411;Serial&#x8BBE;&#x5907;&#x53D1;&#x51FA;&#x8BFB;&#x5199;&#x8BF7;&#x6C42;, VMM&#x8C03;&#x7528;Serial&#x8BBE;&#x5907;&#x7684;read/write&#x51FD;&#x6570;&#x6765;&#x5B8C;&#x6210;&#x54CD;&#x5E94;&#x5E76;&#x5728;&#x67D0;&#x4E9B;&#x60C5;&#x51B5;&#x4E0B;&#x89E6;&#x53D1;&#x4E2D;&#x65AD;&#x901A;&#x77E5;(&#x53EF;&#x80FD;&#x662F;&#x7ED9;PioManager), &#x6BD4;&#x5982;&#x5728;&#x7ED9;in_buffer&#x8BFB;&#x5230;data&#x540E;&#x4EA7;&#x751F;received_data_interrupt. Serial&#x7ED3;&#x6784;&#x4F53;&#x6765;&#x7EF4;&#x62A4;UART16550&#x7684;&#x786C;&#x4EF6;&#x7684;&#x5BC4;&#x5B58;&#x5668;level&#x7684;&#x884C;&#x4E3A;. </p>
<h2 id="&#x4ECE;stdin&#x8BFB;&#x8F93;&#x5165;&#x53D1;&#x7ED9;guest&#x6D41;&#x7A0B;"><a name="&#x4ECE;stdin&#x8BFB;&#x8F93;&#x5165;&#x53D1;&#x7ED9;guest&#x6D41;&#x7A0B;" class="anchor-navigation-ex-anchor" href="#&#x4ECE;stdin&#x8BFB;&#x8F93;&#x5165;&#x53D1;&#x7ED9;guest&#x6D41;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a>6.1. &#x4ECE;stdin&#x8BFB;&#x8F93;&#x5165;&#x53D1;&#x7ED9;guest&#x6D41;&#x7A0B;</h2>
<p>SerialWrapper&#x7684;<code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EventFdTrigger,</span> <span class="token attr-name">SerialEventsWrapper,</span> <span class="token attr-name">W</span><span class="token punctuation">&gt;</span></span></code>&#x7684;&#x5B9E;&#x4F8B;&#x5B9E;&#x73B0;&#x4E86;recv_bytes</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">W</span><span class="token punctuation">:</span> <span class="token class-name">Write</span><span class="token operator">&gt;</span> <span class="token class-name">SerialWrapper</span><span class="token operator">&lt;</span><span class="token class-name">EventFdTrigger</span><span class="token punctuation">,</span> <span class="token class-name">SerialEventsWrapper</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">recv_bytes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> avail_cap <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">.</span><span class="token function">fifo_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>input<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> out <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0u8</span><span class="token punctuation">;</span> avail_cap<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//&#x6307;&#x5B9A;cap&#x7684;vec</span>
            <span class="token comment">//&#x4ECE;stdin&#x8BFB;</span>
            <span class="token keyword">let</span> count <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> out<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">//&#x770B;&#x6765;&amp;mut Vec&lt;u8&gt;&#x80FD;&#x5F53;&#x4F5C;&amp;mut [u8]</span>
            <span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>serial
                    <span class="token comment">//&#x8FD9;&#x4E2A;&#x6709;&#x70B9;&#x8BB2;&#x7A76;&#x4E86;, raw_input&#x5E76;&#x4E0D;&#x662F;&#x5E95;&#x5C42;Serial&#x7684;&#x65B9;&#x6CD5;, &#x800C;&#x662F;&#x672C;&#x6587;&#x4EF6;&#x5B9A;&#x4E49;&#x7684;trait</span>
                    <span class="token comment">//&#x5E95;&#x5C42;&#x8C03;&#x7528;&#x7684;&#x662F;Servial&#x8BBE;&#x5907;&#x7684;enqueue_raw_bytes&#x65B9;&#x6CD5;, &#x5F80;&#x5E95;&#x5C42;Servial&#x7684;in_buffer&#x586B;&#x6570;&#x636E;</span>
                    <span class="token punctuation">.</span><span class="token function">raw_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>out<span class="token punctuation">[</span><span class="token punctuation">..</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token function">from_raw_os_error</span><span class="token punctuation">(</span><span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">ENOBUFS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token function">from_raw_os_error</span><span class="token punctuation">(</span><span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">ENOTTY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;recv_bytes&#x88AB;MutEventSubscriber trait&#x8C03;&#x7528;, SerialWrapper&#x4E5F;&#x5B9E;&#x73B0;&#x4E86;MutEventSubscriber
&#x91CC;&#x9762;&#x7684;process&#x5C31;&#x8C03;&#x7528;&#x4E86;recv_bytes
&#x5177;&#x4F53;&#x6CA1;&#x600E;&#x4E48;&#x770B;&#x61C2;</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">W</span><span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token operator">&gt;</span> <span class="token class-name">MutEventSubscriber</span>
    <span class="token keyword">for</span> <span class="token class-name">SerialWrapper</span><span class="token operator">&lt;</span><span class="token class-name">EventFdTrigger</span><span class="token punctuation">,</span> <span class="token class-name">SerialEventsWrapper</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token comment">//process&#x4F1A;&#x5728;&#x53D1;&#x751F;event&#x7684;&#x65F6;&#x5019;&#x88AB;&#x8C03;&#x7528;, &#x4F20;&#x5165;event&#x548C;ops&#x7528;&#x6765;&#x8868;&#x793A;event&#x7C7B;&#x578B;&#x548C;&#x7EF4;&#x62A4;event</span>
    <span class="token comment">//&#x53EF;&#x80FD;&#x6709;&#x591A;&#x4E2A;fd&#x7684;&#x6E90;&#x5934;, &#x4F46;&#x90FD;&#x5171;&#x7528;&#x8FD9;&#x4E00;&#x4E2A;process&#x51FD;&#x6570;.</span>
    <span class="token comment">/// Handle events on the serial input fd.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token class-name">Events</span><span class="token punctuation">,</span> ops<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">EventOps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token attribute attr-name">#[inline]</span>
        <span class="token keyword">fn</span> <span class="token function-definition function">unregister_source</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">AsRawFd</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>ops<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">EventOps</span><span class="token punctuation">,</span> source<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">match</span> ops<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">Events</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token class-name">EventSet</span><span class="token punctuation">::</span><span class="token constant">IN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">error!</span><span class="token punctuation">(</span><span class="token string">&quot;Could not unregister source fd: {}&quot;</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">as_raw_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">let</span> input_fd <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">serial_input_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> buffer_ready_fd <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">buffer_ready_evt_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> input_fd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> buffer_ready_fd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token macro property">error!</span><span class="token punctuation">(</span><span class="token string">&quot;Serial does not have a configured input source.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> buffer_ready_fd <span class="token operator">==</span> event<span class="token punctuation">.</span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">consume_buffer_ready_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token macro property">error!</span><span class="token punctuation">(</span><span class="token string">&quot;Detach serial device input source due to error in consuming the buffer ready event: {:?}&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">unregister_source</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">unregister_source</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer_ready_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// We expect to receive: `EventSet::IN`, `EventSet::HANG_UP` or</span>
        <span class="token comment">// `EventSet::ERROR`. To process all these events we just have to</span>
        <span class="token comment">// read from the serial input.</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">recv_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// Handle EOF if the event came from the input source.</span>
                <span class="token keyword">if</span> input_fd <span class="token operator">==</span> event<span class="token punctuation">.</span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> count <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                    <span class="token function">unregister_source</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">unregister_source</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer_ready_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token macro property">warn!</span><span class="token punctuation">(</span><span class="token string">&quot;Detached the serial input due to peer close/error.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">match</span> e<span class="token punctuation">.</span><span class="token function">raw_os_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Some</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span> <span class="token keyword">if</span> errno <span class="token operator">==</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">ENOBUFS</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token function">unregister_source</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//&#x8FD9;&#x91CC;&#x662F;none-block read&#x6CA1;&#x4E1C;&#x897F;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x8FD4;&#x56DE;EAGAIN&#x6216;&#x8005;EWOULDBLOCK, &#x90FD;&#x5DEE;&#x4E0D;&#x591A;</span>
                    <span class="token class-name">Some</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span> <span class="token keyword">if</span> errno <span class="token operator">==</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">EWOULDBLOCK</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">handle_ewouldblock</span><span class="token punctuation">(</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">Some</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span> <span class="token keyword">if</span> errno <span class="token operator">==</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">ENOTTY</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token macro property">error!</span><span class="token punctuation">(</span><span class="token string">&quot;The serial device does not have the input source attached.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">unregister_source</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">unregister_source</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer_ready_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">Some</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token class-name">None</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Unknown error, detach the serial input source.</span>
                        <span class="token function">unregister_source</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">unregister_source</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer_ready_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token macro property">warn!</span><span class="token punctuation">(</span><span class="token string">&quot;Detached the serial input due to peer close/error.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Initial registration of pollable objects.</span>
    <span class="token comment">/// If serial input is present, register the serial input FD as readable.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ops<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">EventOps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//input&#x5C31;&#x662F;stdin, buffer_ready_event_fd&#x5C31;&#x662F;&#x524D;&#x9762;&#x7684;kick_stdin_read_evt&#x8FD9;&#x4E2A;eventfd</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>input<span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">.</span><span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>buffer_ready_event_fd<span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> serial_fd <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">serial_input_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> buf_ready_evt <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">buffer_ready_evt_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> serial_fd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
                <span class="token comment">//&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x628A;stdin&#x52A0;&#x5230;epoll</span>
                <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Events</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>serial_fd<span class="token punctuation">,</span> <span class="token class-name">EventSet</span><span class="token punctuation">::</span><span class="token constant">IN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token macro property">warn!</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to register serial input fd: {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//&#x8FD9;&#x4E2A;&#x5B9E;&#x9645;&#x4E0A;&#x662F;kick_stdin_read_evt&#x8FD9;&#x4E2A;eventfd</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Events</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf_ready_evt<span class="token punctuation">,</span> <span class="token class-name">EventSet</span><span class="token punctuation">::</span><span class="token constant">IN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token macro property">warn!</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to register serial buffer ready event: {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x5B9E;&#x73B0;&#x4E86;busdevice&#x7684;&#x6309;&#x5730;&#x5740;&#x8BFB;&#x5199;&#x7684;trait"><a name="&#x5B9E;&#x73B0;&#x4E86;busdevice&#x7684;&#x6309;&#x5730;&#x5740;&#x8BFB;&#x5199;&#x7684;trait" class="anchor-navigation-ex-anchor" href="#&#x5B9E;&#x73B0;&#x4E86;busdevice&#x7684;&#x6309;&#x5730;&#x5740;&#x8BFB;&#x5199;&#x7684;trait"><i class="fa fa-link" aria-hidden="true"></i></a>6.2. &#x5B9E;&#x73B0;&#x4E86;BusDevice&#x7684;&#x6309;&#x5730;&#x5740;&#x8BFB;&#x5199;&#x7684;trait</h2>
<p>&#x6309;&#x603B;&#x7EBF;&#x5730;&#x5740;&#x8BFB;&#x5199;, &#x6700;&#x7EC8;&#x8F6C;&#x5316;&#x4E3A;&#x8BBE;&#x5907;&#x5185;&#x504F;&#x79FB;&#x5730;&#x5740;&#x8BFB;&#x5199;</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">W</span><span class="token punctuation">:</span> <span class="token class-name">Write</span> <span class="token operator">+</span> <span class="token class-name">Send</span><span class="token operator">&gt;</span> <span class="token class-name">BusDevice</span>
    <span class="token keyword">for</span> <span class="token class-name">SerialWrapper</span><span class="token operator">&lt;</span><span class="token class-name">EventFdTrigger</span><span class="token punctuation">,</span> <span class="token class-name">SerialEventsWrapper</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token comment">//&#x8BFB;&#x662F;&#x4ECE;&#x5185;&#x90E8;in_buffer&#x8BFB;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> offset<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">.</span><span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>missed_read_count<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>offset <span class="token keyword">as</span> <span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//&#x5199;&#x662F;&#x5199;&#x5230;stdout</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> offset<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">.</span><span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>missed_write_count<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>offset <span class="token keyword">as</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Counter incremented for any handle_write() error.</span>
            <span class="token macro property">error!</span><span class="token punctuation">(</span><span class="token string">&quot;Failed the write to serial: {:?}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">.</span><span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>error_count<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="attachvirtiodevice"><a name="attachvirtiodevice" class="anchor-navigation-ex-anchor" href="#attachvirtiodevice"><i class="fa fa-link" aria-hidden="true"></i></a>7. attach_virtio_device</h1>
<pre class="language-"><code class="lang-rust"><span class="token comment">/// Attaches a VirtioDevice device to the device manager and event manager.</span>
<span class="token keyword">fn</span> <span class="token function-definition function">attach_virtio_device</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">VirtioDevice</span> <span class="token operator">+</span> <span class="token class-name">MutEventSubscriber</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    event_manager<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">EventManager</span><span class="token punctuation">,</span>
    vmm<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vmm</span><span class="token punctuation">,</span>
    id<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    device<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    cmdline<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">LoaderKernelCmdline</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>result<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StartMicrovmError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">self</span><span class="token punctuation">::</span><span class="token class-name">StartMicrovmError</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token comment">//&#x6CE8;&#x518C;&#x4E8B;&#x4EF6;&#x8BA2;&#x9605;</span>
    event_manager<span class="token punctuation">.</span><span class="token function">add_subscriber</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> device <span class="token operator">=</span> <span class="token class-name">MmioTransport</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>vmm<span class="token punctuation">.</span><span class="token function">guest_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vmm<span class="token punctuation">.</span>mmio_device_manager
        <span class="token punctuation">.</span><span class="token function">register_mmio_virtio_for_boot</span><span class="token punctuation">(</span>vmm<span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> device<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span>
            <span class="token comment">//&#x5206;&#x914D;mmio&#x7684;addr len&#x548C;irq&#x8D44;&#x6E90;, &#x7B56;&#x7565;&#x662F;&#x4F9D;&#x6B21;&#x987A;&#x5E8F;&#x5206;&#x914D;</span>
            <span class="token keyword">let</span> mmio_slot <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">allocate_new_slot</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">register_mmio_virtio</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> device_id<span class="token punctuation">,</span> mmio_device<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mmio_slot<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> locked_device <span class="token operator">=</span> mmio_device<span class="token punctuation">.</span><span class="token function">locked_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                identifier <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DeviceType</span><span class="token punctuation">::</span><span class="token class-name">Virtio</span><span class="token punctuation">(</span>locked_device<span class="token punctuation">.</span><span class="token function">device_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> device_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//&#x5BF9;&#x6BCF;&#x4E2A;queue</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> queue_evt<span class="token punctuation">)</span> <span class="token keyword">in</span> locked_device<span class="token punctuation">.</span><span class="token function">queue_events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token comment">//NOTIFY_REG_OFFSET&#x662F;0x50, &#x52A0;&#x4E0A;slot.addr&#x8FD9;&#x4E2A;mmio device&#x7684;base&#x5730;&#x5740;</span>
                    <span class="token comment">//&#x6CE8;&#x610F;, &#x5E76;&#x4E0D;&#x662F;&#x6240;&#x6709;&#x7684;mmio&#x8BBE;&#x5907;&#x7684;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x8BBF;&#x95EE;&#x90FD;&#x4F1A;&#x89E6;&#x53D1;event, &#x8FD9;&#x4E2A;io_addr&#x53EA;&#x662F;&#x7279;&#x5B9A;&#x5730;&#x5740;, &#x7528;&#x6765;notify device&#x7684;.</span>
                    <span class="token keyword">let</span> io_addr <span class="token operator">=</span> <span class="token class-name">IoEventAddress</span><span class="token punctuation">::</span><span class="token class-name">Mmio</span><span class="token punctuation">(</span>slot<span class="token punctuation">.</span>addr <span class="token operator">+</span> <span class="token keyword">u64</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token namespace">devices<span class="token punctuation">::</span>virtio<span class="token punctuation">::</span></span><span class="token constant">NOTIFY_REG_OFFSET</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//&#x8FD9;&#x4E2A;queue_evt&#x662F;&#x6BCF;&#x4E2A;queue&#x7684;eventfd, &#x5199;io_addr&#x5C31;&#x4F1A;&#x89E6;&#x53D1;event, &#x8BF4;&#x660E;guest driver&#x8981;&#x901A;&#x77E5;device&#x6765;&#x5E72;&#x6D3B;&#x4E86;</span>
                    <span class="token comment">//&#x8C03;&#x7528;&#x4E86;kvm&#x7684;ioctl</span>
                    vm<span class="token punctuation">.</span><span class="token function">register_ioevent</span><span class="token punctuation">(</span>queue_evt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>io_addr<span class="token punctuation">,</span> i <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token comment">//&#x5199;&#x8FD9;&#x6307;&#x5B9A;&#x5730;&#x5740;&#x7684;&#x65F6;&#x5019;&#x53D1;event&#x5230;queue_evt</span>
                vm<span class="token punctuation">.</span><span class="token function">register_irqfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x6CE8;&#x518C;&#x4E2D;&#x65AD;&#x6CE8;&#x5165;guest&#x7684;eventfd&#x548C;irq&#x53F7;, &#x8C03;&#x7528;kvm ioctl KVM_IRQFD; &#x610F;&#x601D;&#x662F;&#x53EA;&#x8981;&#x8FD9;&#x4E2A;eventfd&#x88AB;&#x5199;&#x5165;, &#x5185;&#x6838;&#x7684;kvm&#x6A21;&#x5757;&#x5C31;&#x4F1A;&#x7ED9;guest&#x53D1;&#x6307;&#x5B9A;&#x7684;irq&#x53F7;&#x4E2D;&#x65AD;.</span>
                <span class="token function">register_mmio_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="vmregisterioeventqueueevt-ioaddr-i--as--u32"><a name="vmregisterioeventqueueevt-ioaddr-i--as--u32" class="anchor-navigation-ex-anchor" href="#vmregisterioeventqueueevt-ioaddr-i--as--u32"><i class="fa fa-link" aria-hidden="true"></i></a>7.1. vm.register_ioevent(queue_evt, &amp;io_addr, i  as  u32)</h2>
<p>&#x4E09;&#x4E2A;&#x53C2;&#x6570;&#x5982;&#x4E0B;:</p>
<blockquote>
<p><code>fd</code> - <code>EventFd</code> which will be signaled. When signaling, the usual <code>vmexit</code> to userspace is prevented.<br><code>addr</code> - Address being written to.<br><code>datamatch</code> - Limits signaling <code>fd</code> to only the cases where the value being written is equal to this parameter. The size of <code>datamatch</code> is important and it must match the expected size of the guest&apos;s write.</p>
</blockquote>
<p>guest&#x9A71;&#x52A8;&#x9700;&#x8981;&#x67D0;&#x79CD;&#x65B9;&#x6CD5;&#x6765;&#x901A;&#x77E5;device, kvm&#x7684;ioeventfd&#x5C31;&#x662F;&#x5E72;&#x8FD9;&#x4E2A;&#x7528;&#x7684;. &#x7528;eventfd&#x7684;&#x597D;&#x5904;&#x662F;&#x8FD9;&#x4E2A;guest driver&#x5230;device&#x7684;&#x901A;&#x77E5;&#x4E0D;&#x9700;&#x8981;vmexit.</p>
<blockquote>
<p>Registers an event to be signaled whenever a certain address is written to. When signaling, the usual <code>vmexit</code> to userspace is prevented.</p>
</blockquote>
<p>&#x5BF9;&#x5E94;KVM&#x7684;<code>KVM_IOEVENTFD</code>  </p>
<blockquote>
<p>This ioctl attaches or detaches an ioeventfd to a legal pio/mmio address within the guest. A guest write in the registered address will signal the provided event instead of triggering an exit.</p>
<p>If datamatch flag is set, the event will be signaled only if the written value to the registered address is equal to datamatch in struct kvm_ioeventfd.</p>
</blockquote>
<p>&#x6CE8;&#x610F;: &#x8FD9;&#x4E2A;&#x5BF9;&#x6BCF;&#x4E2A;queue&#x90FD;&#x8C03;&#x7528;&#x4E86;<code>vm.register_ioevent(queue_evt, &amp;io_addr, i as u32)</code>, &#x4F5C;&#x7528;&#x662F;&#x7ED9;<code>io_addr</code>&#x5730;&#x5740;&#x7ED1;&#x5B9A;&#x4E00;&#x4E2A;<code>queue_evt</code>, &#x5F53;driver&#x5199;<code>i</code>&#x5230;&#x8FD9;&#x4E2A;<code>io_aadr</code>&#x5730;&#x5740;&#x7684;&#x65F6;&#x5019;, signal&#x7ED9;<code>queue_evt</code>.
&#x4F46;&#x95EE;&#x9898;&#x662F;, &#x5982;&#x679C;&#x662F;&#x591A;&#x4E2A;queue, &#x591A;&#x4E2A;<code>queue_evt</code>&#x90FD;&quot;&#x7ED1;&#x5B9A;&quot;&#x5230;&#x540C;&#x4E00;&#x4E2A;<code>io_addr</code>.<br>&#x6211;&#x731C;&#x6D4B;&#x8FD9;&#x4E2A;API&#x662F;&#x652F;&#x6301;&#x591A;&#x4E2A;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x5BF9;&#x5E94;&#x591A;&#x4E2A;eventfd&#x7684;, &#x53EF;&#x80FD;&#x7531;datamatch&#x7684;&#x503C;&#x6765;&#x533A;&#x5206;&#x8FD9;&#x4E2A;signal&#x53D1;&#x9001;&#x5230;&#x54EA;&#x4E2A;eventfd</p>
<h2 id="vmregisterirqfd"><a name="vmregisterirqfd" class="anchor-navigation-ex-anchor" href="#vmregisterirqfd"><i class="fa fa-link" aria-hidden="true"></i></a>7.2. vm.register_irqfd</h2>
<p><code>vm.register_irqfd(locked_device.interrupt_evt(), slot.irqs[0])</code>
&#x8C03;&#x7528;kvm&#x7684;ioctl&#x7684;<code>KVM_IRQFD</code>(&#x89C1;&#x4E0B;&#x9762;)
IRQFD&#x662F;device&#x5199;eventfd, &#x901A;&#x8FC7;kvm&#x89E6;&#x53D1;guest&#x4E2D;&#x65AD;&#x7684;&#x673A;&#x5236;.</p>
<h2 id="kvm&#x7684;irq&#x76F8;&#x5173;api"><a name="kvm&#x7684;irq&#x76F8;&#x5173;api" class="anchor-navigation-ex-anchor" href="#kvm&#x7684;irq&#x76F8;&#x5173;api"><i class="fa fa-link" aria-hidden="true"></i></a>7.3. kvm&#x7684;irq&#x76F8;&#x5173;API</h2>
<p><a href="https://www.kernel.org/doc/html/latest/virt/kvm/api.html" target="_blank">https://www.kernel.org/doc/html/latest/virt/kvm/api.html</a></p>
<h3 id="kvmcreateirqchip"><a name="kvmcreateirqchip" class="anchor-navigation-ex-anchor" href="#kvmcreateirqchip"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.1. KVM_CREATE_IRQCHIP</h3>
<p>Creates an interrupt controller model in the kernel. On x86, creates a virtual ioapic, a virtual PIC (two PICs, nested), and sets up future vcpus to have a local APIC. IRQ routing for GSIs 0-15 is set to both PIC and IOAPIC; GSI 16-23 only go to the IOAPIC. On arm64, a GICv2 is created. Any other GIC versions require the usage of KVM_CREATE_DEVICE, which also supports creating a GICv2. Using KVM_CREATE_DEVICE is preferred over KVM_CREATE_IRQCHIP for GICv2. On s390, a dummy irq routing table is created.</p>
<h3 id="kvmsetgsirouting"><a name="kvmsetgsirouting" class="anchor-navigation-ex-anchor" href="#kvmsetgsirouting"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.2. KVM_SET_GSI_ROUTING</h3>
<p>Sets the GSI routing table entries, overwriting any previously set entries.</p>
<h3 id="kvmirqfd"><a name="kvmirqfd" class="anchor-navigation-ex-anchor" href="#kvmirqfd"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.3. KVM_IRQFD</h3>
<p>Allows setting an eventfd to directly trigger a guest interrupt. kvm_irqfd.fd specifies the file descriptor to use as the eventfd and kvm_irqfd.gsi specifies the irqchip pin toggled by this event. When an event is triggered on the eventfd, an interrupt is injected into the guest using the specified gsi pin. The irqfd is removed using the KVM_IRQFD_FLAG_DEASSIGN flag, specifying both kvm_irqfd.fd and kvm_irqfd.gsi.</p>
<p>With KVM_CAP_IRQFD_RESAMPLE, KVM_IRQFD supports a de-assert and notify mechanism allowing emulation of level-triggered, irqfd-based interrupts. When KVM_IRQFD_FLAG_RESAMPLE is set the user must pass an additional eventfd in the kvm_irqfd.resamplefd field. When operating in resample mode, posting of an interrupt through kvm_irq.fd asserts the specified gsi in the irqchip. When the irqchip is resampled, such as from an EOI, the gsi is de-asserted and the user is notified via kvm_irqfd.resamplefd. It is the user&#x2019;s responsibility to re-queue the interrupt if the device making use of it still requires service. Note that closing the resamplefd is not sufficient to disable the irqfd. The KVM_IRQFD_FLAG_RESAMPLE is only necessary on assignment and need not be specified with KVM_IRQFD_FLAG_DEASSIGN.</p>
<p>On arm64, gsi routing being supported, the following can happen:</p>
<ul>
<li>in case no routing entry is associated to this gsi, injection fails</li>
<li>in case the gsi is associated to an irqchip routing entry, irqchip.pin + 32 corresponds to the injected SPI ID.</li>
<li>in case the gsi is associated to an MSI routing entry, the MSI message and device ID are translated into an LPI (support restricted to GICv3 ITS in-kernel emulation).</li>
</ul>
<h3 id="kvmcreatedevice"><a name="kvmcreatedevice" class="anchor-navigation-ex-anchor" href="#kvmcreatedevice"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.4. KVM_CREATE_DEVICE</h3>
<p>Creates an emulated device in the kernel. The file descriptor returned in fd can be used with KVM_SET/GET/HAS_DEVICE_ATTR.</p>
<p>If the KVM_CREATE_DEVICE_TEST flag is set, only test whether the device type is supported (not necessarily whether it can be created in the current vm).</p>
<p>Individual devices should not define flags. Attributes should be used for specifying any behavior that is not implied by the device type number.</p>
<h4 id="&#x90FD;&#x6709;&#x54EA;&#x4E9B;&#x53EF;&#x4EE5;&#x88AB;create"><a name="&#x90FD;&#x6709;&#x54EA;&#x4E9B;&#x53EF;&#x4EE5;&#x88AB;create" class="anchor-navigation-ex-anchor" href="#&#x90FD;&#x6709;&#x54EA;&#x4E9B;&#x53EF;&#x4EE5;&#x88AB;create"><i class="fa fa-link" aria-hidden="true"></i></a>&#x90FD;&#x6709;&#x54EA;&#x4E9B;&#x53EF;&#x4EE5;&#x88AB;create</h4>
<ul>
<li><a href="https://www.kernel.org/doc/html/latest/virt/kvm/devices/index.html" target="_blank">Devices</a><ul>
<li><a href="https://www.kernel.org/doc/html/latest/virt/kvm/devices/arm-vgic-its.html" target="_blank">ARM Virtual Interrupt Translation Service (ITS)</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/virt/kvm/devices/arm-vgic.html" target="_blank">ARM Virtual Generic Interrupt Controller v2 (VGIC)</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/virt/kvm/devices/arm-vgic-v3.html" target="_blank">ARM Virtual Generic Interrupt Controller v3 and later (VGICv3)</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/virt/kvm/devices/mpic.html" target="_blank">MPIC interrupt controller</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/virt/kvm/devices/s390_flic.html" target="_blank">FLIC (floating interrupt controller)</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/virt/kvm/devices/vcpu.html" target="_blank">Generic vcpu interface</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/virt/kvm/devices/vfio.html" target="_blank">VFIO virtual device</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/virt/kvm/devices/vm.html" target="_blank">Generic vm interface</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/virt/kvm/devices/xics.html" target="_blank">XICS interrupt controller</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/virt/kvm/devices/xive.html" target="_blank">POWER9 eXternal Interrupt Virtualization Engine (XIVE Gen1)</a></li>
</ul>
</li>
</ul>
<h3 id="arm-gic-v3"><a name="arm-gic-v3" class="anchor-navigation-ex-anchor" href="#arm-gic-v3"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.5. ARM gic v3</h3>
<p>Only one VGIC instance may be instantiated through this API. The created VGIC will act as the VM interrupt controller, requiring emulated user-space devices to inject interrupts to the VGIC instead of directly to CPUs. It is not possible to create both a GICv3 and GICv2 on the same VM.</p>
<p>Creating a guest GICv3 device requires a host GICv3 as well.</p>
<h4 id="kvmdevarmvgicgrpaddr"><a name="kvmdevarmvgicgrpaddr" class="anchor-navigation-ex-anchor" href="#kvmdevarmvgicgrpaddr"><i class="fa fa-link" aria-hidden="true"></i></a>KVM_DEV_ARM_VGIC_GRP_ADDR</h4>
<p>&#x5B9A;&#x4E49;&#x4E86;vgic&#x5BC4;&#x5B58;&#x5668;&#x5728;guest&#x7269;&#x7406;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x7684;&#x57FA;&#x5730;&#x5740;</p>
<ul>
<li><p>KVM_VGIC_V3_ADDR_TYPE_DIST (rw, 64-bit)
Base address in the guest physical address space of the GICv3 distributor register mappings. Only valid for KVM_DEV_TYPE_ARM_VGIC_V3. This address needs to be 64K aligned and the region covers 64 KByte.</p>
</li>
<li><p>KVM_VGIC_V3_ADDR_TYPE_REDIST (rw, 64-bit)
Base address in the guest physical address space of the GICv3 redistributor register mappings. There are two 64K pages for each VCPU and all of the redistributor pages are contiguous. Only valid for KVM_DEV_TYPE_ARM_VGIC_V3. This address needs to be 64K aligned.</p>
</li>
</ul>
<h2 id="mmiotransport"><a name="mmiotransport" class="anchor-navigation-ex-anchor" href="#mmiotransport"><i class="fa fa-link" aria-hidden="true"></i></a>7.4. MmioTransport</h2>
<p>mplements the MMIO transport for virtio devices.</p>
<p>This requires 3 points of installation to work with a VM:</p>
<ol>
<li>Mmio reads and writes must be sent to this device at what is referred to here as MMIO base.</li>
<li><code>Mmio::queue_evts</code> must be installed at <code>virtio::NOTIFY_REG_OFFSET</code> offset from the MMIO base. Each event in the array must be signaled if the index is written at that offset.</li>
<li><code>Mmio::interrupt_evt</code> must signal an interrupt that the guest driver is listening to when it is written to.</li>
</ol>
<p>Typically one page (4096 bytes) of MMIO address space is sufficient to handle this transport and inner virtio device.</p>
<p>&#x5BF9;&#x5E94;&#x7684;&#x7ED3;&#x6784;&#x4F53;:</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">MmioTransport</span> <span class="token punctuation">{</span>
    device<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">VirtioDevice</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// The register where feature bits are stored.</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> features_select<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token comment">// The register where features page is selected.</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> acked_features_select<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> queue_select<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> device_status<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> config_generation<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    mem<span class="token punctuation">:</span> <span class="token class-name">GuestMemoryMmap</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> interrupt_status<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">AtomicUsize</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="impl-mmiotransport"><a name="impl-mmiotransport" class="anchor-navigation-ex-anchor" href="#impl-mmiotransport"><i class="fa fa-link" aria-hidden="true"></i></a>7.4.1. impl MmioTransport</h3>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span> <span class="token class-name">MmioTransport</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Constructs a new MMIO transport for the given virtio device.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>mem<span class="token punctuation">:</span> <span class="token class-name">GuestMemoryMmap</span><span class="token punctuation">,</span> device<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">VirtioDevice</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">MmioTransport</span> <span class="token punctuation">{</span>
        <span class="token comment">//&#x8FD9;&#x91CC;&#x5C0F;&#x77E5;&#x8BC6;&#x70B9;: device.lock()&#x8FD4;&#x56DE;&#x7684;&#x662F;mutextGuard, &#x5B83;&#x4F1A;&#x5728;&#x751F;&#x547D;&#x5468;&#x671F;&#x7ED3;&#x675F;&#x540E;&#x81EA;&#x52A8;&#x8C03;&#x7528;unlock. </span>
        <span class="token comment">//&#x4E0D;&#x7528;&#x62C5;&#x5FC3;&#x4E00;&#x76F4;&#x4F1A;lock, &#x56E0;&#x4E3A;device.lock()&#x7684;&#x58F0;&#x660E;&#x5468;&#x671F;&#x53EA;&#x6709;&#x4E0B;&#x9762;&#x4E00;&#x884C;</span>
        <span class="token comment">//&#x8FD9;&#x884C;&#x7ED3;&#x675F;&#x4E86;&#x5176;&#x5B9E;&#x5C31;&#x5DF2;&#x7ECF;unlock&#x4E86;.</span>
        <span class="token keyword">let</span> interrupt_status <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Poisoned lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//new&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;</span>
        <span class="token class-name">MmioTransport</span> <span class="token punctuation">{</span>
            device<span class="token punctuation">,</span>
            features_select<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            acked_features_select<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            queue_select<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            device_status<span class="token punctuation">:</span> <span class="token namespace">device_status<span class="token punctuation">::</span></span><span class="token constant">INIT</span><span class="token punctuation">,</span>
            config_generation<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            mem<span class="token punctuation">,</span>
            interrupt_status<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">locked_device</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">MutexGuard</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">VirtioDevice</span> <span class="token operator">+</span> <span class="token keyword">static</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>device<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Poisoned lock&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Gets the encapsulated VirtioDevice.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">device</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">VirtioDevice</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>device<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">check_device_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> set<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> clr<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>device_status <span class="token operator">&amp;</span> <span class="token punctuation">(</span>set <span class="token operator">|</span> clr<span class="token punctuation">)</span> <span class="token operator">==</span> set
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">are_queues_valid</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">locked_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">queues</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>q<span class="token closure-punctuation punctuation">|</span></span> q<span class="token punctuation">.</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>mem<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//&#x6CE8;&#x610F;&#x5230;&#x6CDB;&#x578B;U, &#x5E76;&#x6CA1;&#x6709;&#x7EA6;&#x675F;;</span>
    <span class="token comment">//&#x8FD9;&#x91CC;&#x7684;&#x610F;&#x601D;&#x662F;&#x5165;&#x53C2;d&#x7684;&#x7C7B;&#x578B;&#x662F;U, &#x8868;&#x793A;&#x9ED8;&#x8BA4;&#x503C;.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">with_queue</span><span class="token operator">&lt;</span><span class="token class-name">U</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> d<span class="token punctuation">:</span> <span class="token class-name">U</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">U</span>
    <span class="token keyword">where</span>
        <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">Queue</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">U</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span>
            <span class="token punctuation">.</span><span class="token function">locked_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">queues</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>queue_select <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">None</span> <span class="token operator">=&gt;</span> d<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">with_queue_mut</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Queue</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span>
            <span class="token punctuation">.</span><span class="token function">locked_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">queues_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get_mut</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>queue_select <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">f</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token boolean">true</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">update_queue_field</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Queue</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">check_device_status</span><span class="token punctuation">(</span>
            <span class="token namespace">device_status<span class="token punctuation">::</span></span><span class="token constant">FEATURES_OK</span><span class="token punctuation">,</span>
            <span class="token namespace">device_status<span class="token punctuation">::</span></span><span class="token constant">DRIVER_OK</span> <span class="token operator">|</span> <span class="token namespace">device_status<span class="token punctuation">::</span></span><span class="token constant">FAILED</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">with_queue_mut</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token macro property">warn!</span><span class="token punctuation">(</span>
                <span class="token string">&quot;update virtio queue in invalid state 0x{:x}&quot;</span><span class="token punctuation">,</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>device_status
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        &#x91CD;&#x7F6E;&#x7ED3;&#x6784;&#x4F53;<span class="token string">&quot;&#x5BC4;&#x5B58;&#x5668;&quot;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//&#x6839;&#x636E;VirtIO Spec 1.0, section 2.1.1 and 3.1.1</span>
    <span class="token comment">//&#x5728;device&#x7684;write&#x91CC;&#x9762;&#x8C03;&#x7528;, &#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x7ED9;guest&#x7684;driver&#x7528;&#x7684;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">set_device_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x5B9E;&#x73B0;busdevice"><a name="&#x5B9E;&#x73B0;busdevice" class="anchor-navigation-ex-anchor" href="#&#x5B9E;&#x73B0;busdevice"><i class="fa fa-link" aria-hidden="true"></i></a>7.4.2. &#x5B9E;&#x73B0;BusDevice</h3>
<p>&#x6839;&#x636E;virtIO&#x89C4;&#x8303;MMIO transport&#x65B9;&#x5F0F;:<br><a href="https://docs.oasis-open.org/virtio/virtio/v1.2/csd01/virtio-v1.2-csd01.html#x1-1650002" target="_blank">https://docs.oasis-open.org/virtio/virtio/v1.2/csd01/virtio-v1.2-csd01.html#x1-1650002</a></p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span> <span class="token class-name">BusDevice</span> <span class="token keyword">for</span> <span class="token class-name">MmioTransport</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> offset<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> offset <span class="token punctuation">{</span>
            <span class="token number">0x00</span><span class="token punctuation">..=</span><span class="token number">0xff</span> <span class="token keyword">if</span> data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token keyword">match</span> offset <span class="token punctuation">{</span>
                    <span class="token number">0x0</span> <span class="token operator">=&gt;</span> <span class="token constant">MMIO_MAGIC_VALUE</span><span class="token punctuation">,</span>
                    <span class="token number">0x04</span> <span class="token operator">=&gt;</span> <span class="token constant">MMIO_VERSION</span><span class="token punctuation">,</span>
                    <span class="token number">0x08</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">locked_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">device_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token number">0x0c</span> <span class="token operator">=&gt;</span> <span class="token constant">VENDOR_ID</span><span class="token punctuation">,</span> <span class="token comment">// vendor id</span>
                    <span class="token number">0x10</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">//32bit&#x7684;feature flag</span>
                        <span class="token keyword">let</span> <span class="token keyword">mut</span> features <span class="token operator">=</span> <span class="token keyword">self</span>
                            <span class="token punctuation">.</span><span class="token function">locked_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">avail_features_by_page</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>features_select<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>features_select <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
                            features <span class="token operator">|=</span> <span class="token number">0x1</span><span class="token punctuation">;</span> <span class="token comment">// enable support of VirtIO Version 1</span>
                        <span class="token punctuation">}</span>
                        features
                    <span class="token punctuation">}</span>
                    <span class="token comment">//&#x5BF9;&#x5DF2;&#x7ECF;&#x9009;&#x4E2D;&#x7684;queue(QueueSel), &#x8BFB;&#x51FA;queue&#x5185;&#x5143;&#x7D20;&#x4E2A;&#x6570;; Reading from the register returns the maximum size (number of elements) of the queue the device is ready to process or zero (0x0) if the queue is not available.</span>
                    <span class="token number">0x34</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">with_queue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>q<span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">u32</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">get_max_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">//&#x5BF9;&#x5DF2;&#x7ECF;&#x9009;&#x4E2D;&#x7684;queue, &#x5199;1&#x8868;&#x793A;ready. &#x8BFB;&#x662F;&#x8BFB;&#x4E0A;&#x4E00;&#x6B21;&#x7684;&#x503C;</span>
                    <span class="token number">0x44</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">with_queue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>q<span class="token closure-punctuation punctuation">|</span></span> q<span class="token punctuation">.</span>ready <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">//&#x4E2D;&#x65AD;&#x72B6;&#x6001;&#x5BC4;&#x5B58;&#x5668;, &#x8981;&#x4E48;&#x662F;Used Buffer Notification(bit 0), &#x8981;&#x4E48;&#x662F;Configuration Change Notification(bit 1)</span>
                    <span class="token number">0x60</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>interrupt_status<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
                    <span class="token comment">//&#x8BBE;&#x5907;&#x72B6;&#x6001;&#x5BC4;&#x5B58;&#x5668;.</span>
                    <span class="token number">0x70</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>device_status<span class="token punctuation">,</span>
                    <span class="token comment">//&#x914D;&#x7F6E;&#x7A7A;&#x95F4;&#x539F;&#x5B50;&#x6027;&#x5BC4;&#x5B58;&#x5668;, &#x4E24;&#x6B21;&#x8BFB;&#x7684;&#x4E00;&#x6837;&#x5C31;&#x662F;&#x539F;&#x5B50;&#x7684;?</span>
                    <span class="token number">0xfc</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>config_generation<span class="token punctuation">,</span>
                    _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token macro property">warn!</span><span class="token punctuation">(</span><span class="token string">&quot;unknown virtio mmio register read: 0x{:x}&quot;</span><span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token namespace">byte_order<span class="token punctuation">::</span></span><span class="token function">write_le_u32</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x6CE8;&#x610F;&#x8FD9;&#x91CC;, &#x4F7F;&#x7528;byte_order&#x7684;&#x5C0F;&#x7AEF;&#x5199;</span>
            <span class="token punctuation">}</span>
            <span class="token number">0x100</span><span class="token punctuation">..=</span><span class="token number">0xfff</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">locked_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read_config</span><span class="token punctuation">(</span>offset <span class="token operator">-</span> <span class="token number">0x100</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token macro property">warn!</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;invalid virtio mmio read: 0x{:x}:0x{:x}&quot;</span><span class="token punctuation">,</span>
                    offset<span class="token punctuation">,</span>
                    data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> offset<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">fn</span> <span class="token function-definition function">hi</span><span class="token punctuation">(</span>v<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">GuestAddress</span><span class="token punctuation">,</span> x<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>v <span class="token operator">&amp;</span> <span class="token number">0xffff_ffff</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token keyword">u64</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">fn</span> <span class="token function-definition function">lo</span><span class="token punctuation">(</span>v<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">GuestAddress</span><span class="token punctuation">,</span> x<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>v <span class="token operator">&amp;</span> <span class="token operator">!</span><span class="token number">0xffff_ffff</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">u64</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">match</span> offset <span class="token punctuation">{</span>
            <span class="token number">0x00</span><span class="token punctuation">..=</span><span class="token number">0xff</span> <span class="token keyword">if</span> data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token namespace">byte_order<span class="token punctuation">::</span></span><span class="token function">read_le_u32</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&#x6309;&#x5C0F;&#x7AEF;&#x65B9;&#x5F0F;&#x7406;&#x89E3;data</span>
                <span class="token keyword">match</span> offset <span class="token punctuation">{</span>
                    <span class="token comment">//Device (host) features word selection. &#x5199;&#x8FD9;&#x4E2A;&#x5BC4;&#x5B58;&#x5668;&#x9009;&#x62E9;feature flag</span>
                    <span class="token number">0x14</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>features_select <span class="token operator">=</span> v<span class="token punctuation">,</span>
                    <span class="token comment">//Flags representing device features understood and activated by the driver</span>
                    <span class="token number">0x20</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">check_device_status</span><span class="token punctuation">(</span>
                            <span class="token namespace">device_status<span class="token punctuation">::</span></span><span class="token constant">DRIVER</span><span class="token punctuation">,</span>
                            <span class="token namespace">device_status<span class="token punctuation">::</span></span><span class="token constant">FEATURES_OK</span> <span class="token operator">|</span> <span class="token namespace">device_status<span class="token punctuation">::</span></span><span class="token constant">FAILED</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">locked_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">ack_features_by_page</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>acked_features_select<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token macro property">warn!</span><span class="token punctuation">(</span>
                                <span class="token string">&quot;ack virtio features in invalid state 0x{:x}&quot;</span><span class="token punctuation">,</span>
                                <span class="token keyword">self</span><span class="token punctuation">.</span>device_status
                            <span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//Activated (guest) features word selection</span>
                    <span class="token number">0x24</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>acked_features_select <span class="token operator">=</span> v<span class="token punctuation">,</span>
                    <span class="token comment">//&#x8FD9;&#x4E2A;&#x5C31;&#x662F;QueueSel, &#x4E5F;&#x53EB;Virtual queue index, &#x4ECE;0&#x5F00;&#x59CB;</span>
                    <span class="token number">0x30</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>queue_select <span class="token operator">=</span> v<span class="token punctuation">,</span>
                    <span class="token comment">//Virtual queue size</span>
                    <span class="token number">0x38</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">update_queue_field</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>q<span class="token closure-punctuation punctuation">|</span></span> q<span class="token punctuation">.</span>size <span class="token operator">=</span> v <span class="token keyword">as</span> <span class="token keyword">u16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">//queue read</span>
                    <span class="token comment">//Writing one (0x1) to this register notifies the device that it can execute requests from this virtual queue.</span>
                    <span class="token number">0x44</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">update_queue_field</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>q<span class="token closure-punctuation punctuation">|</span></span> q<span class="token punctuation">.</span>ready <span class="token operator">=</span> v <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">//&#x4E2D;&#x65AD;&#x5E94;&#x7B54;</span>
                    <span class="token number">0x64</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">check_device_status</span><span class="token punctuation">(</span><span class="token namespace">device_status<span class="token punctuation">::</span></span><span class="token constant">DRIVER_OK</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">self</span><span class="token punctuation">.</span>interrupt_status
                                <span class="token punctuation">.</span><span class="token function">fetch_and</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>v <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//Device status: Writing non-zero values to this register sets the status flags, indicating the driver progress</span>
                    <span class="token number">0x70</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">set_device_status</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">//Virtual queue&#x2019;s Descriptor Area 64 bit long physical address</span>
                    <span class="token number">0x80</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">update_queue_field</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>q<span class="token closure-punctuation punctuation">|</span></span> <span class="token function">lo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> q<span class="token punctuation">.</span>desc_table<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token number">0x84</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">update_queue_field</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>q<span class="token closure-punctuation punctuation">|</span></span> <span class="token function">hi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> q<span class="token punctuation">.</span>desc_table<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">//Virtual queue&#x2019;s Driver Area 64 bit long physical address</span>
                    <span class="token number">0x90</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">update_queue_field</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>q<span class="token closure-punctuation punctuation">|</span></span> <span class="token function">lo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> q<span class="token punctuation">.</span>avail_ring<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token number">0x94</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">update_queue_field</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>q<span class="token closure-punctuation punctuation">|</span></span> <span class="token function">hi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> q<span class="token punctuation">.</span>avail_ring<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">//Virtual queue&#x2019;s Device Area 64 bit long physical address</span>
                    <span class="token number">0xa0</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">update_queue_field</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>q<span class="token closure-punctuation punctuation">|</span></span> <span class="token function">lo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> q<span class="token punctuation">.</span>used_ring<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token number">0xa4</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">update_queue_field</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>q<span class="token closure-punctuation punctuation">|</span></span> <span class="token function">hi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> q<span class="token punctuation">.</span>used_ring<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token macro property">warn!</span><span class="token punctuation">(</span><span class="token string">&quot;unknown virtio mmio register write: 0x{:x}&quot;</span><span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token number">0x100</span><span class="token punctuation">..=</span><span class="token number">0xfff</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">check_device_status</span><span class="token punctuation">(</span><span class="token namespace">device_status<span class="token punctuation">::</span></span><span class="token constant">DRIVER</span><span class="token punctuation">,</span> <span class="token namespace">device_status<span class="token punctuation">::</span></span><span class="token constant">FAILED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">locked_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write_config</span><span class="token punctuation">(</span>offset <span class="token operator">-</span> <span class="token number">0x100</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token macro property">warn!</span><span class="token punctuation">(</span><span class="token string">&quot;can not write to device config data area before driver is ready&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token macro property">warn!</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;invalid virtio mmio write: 0x{:x}:0x{:x}&quot;</span><span class="token punctuation">,</span>
                    offset<span class="token punctuation">,</span>
                    data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="device"><a name="device" class="anchor-navigation-ex-anchor" href="#device"><i class="fa fa-link" aria-hidden="true"></i></a>7.5. device</h2>
<h3 id="device&#x7684;&#x72B6;&#x6001;&#x6709;"><a name="device&#x7684;&#x72B6;&#x6001;&#x6709;" class="anchor-navigation-ex-anchor" href="#device&#x7684;&#x72B6;&#x6001;&#x6709;"><i class="fa fa-link" aria-hidden="true"></i></a>7.5.1. device&#x7684;&#x72B6;&#x6001;&#x6709;</h3>
<pre class="language-"><code class="lang-rust"><span class="token comment">/// Enum that indicates if a VirtioDevice is inactive or has been activated</span>
<span class="token comment">/// and memory attached to it.</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">DeviceState</span> <span class="token punctuation">{</span>
    <span class="token class-name">Inactive</span><span class="token punctuation">,</span>
    <span class="token class-name">Activated</span><span class="token punctuation">(</span><span class="token class-name">GuestMemoryMmap</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;enum&#x4E5F;&#x6709;&#x65B9;&#x6CD5;, &#x5176;&#x4E2D;<code>mem()</code>&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;GuestmemoryMmap</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span> <span class="token class-name">DeviceState</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Checks if the device is activated.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">is_activated</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            <span class="token class-name">DeviceState</span><span class="token punctuation">::</span><span class="token class-name">Inactive</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token class-name">DeviceState</span><span class="token punctuation">::</span><span class="token class-name">Activated</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Gets the memory attached to the device if it is activated.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">mem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">GuestMemoryMmap</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            <span class="token class-name">DeviceState</span><span class="token punctuation">::</span><span class="token class-name">Activated</span><span class="token punctuation">(</span><span class="token keyword">ref</span> mem<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">DeviceState</span><span class="token punctuation">::</span><span class="token class-name">Inactive</span> <span class="token operator">=&gt;</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="irqtrigger"><a name="irqtrigger" class="anchor-navigation-ex-anchor" href="#irqtrigger"><i class="fa fa-link" aria-hidden="true"></i></a>7.5.2. IrqTrigger</h3>
<p>IrqTrigger&#x5305;&#x542B;&#x4E00;&#x4E2A;eventFd&#x53EB;<code>irq_evt</code>, <code>trigger_irq</code>&#x65B9;&#x6CD5;&#x5C31;&#x662F;&#x5199;&#x8FD9;&#x4E2A;eventFd.</p>
<pre class="language-"><code class="lang-rust"><span class="token comment">/// Helper struct that is responsible for triggering guest IRQs</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">IrqTrigger</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> irq_status<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">AtomicUsize</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> irq_evt<span class="token punctuation">:</span> <span class="token class-name">EventFd</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">IrqTrigger</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">Self</span> <span class="token punctuation">{</span>
            irq_status<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AtomicUsize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            irq_evt<span class="token punctuation">:</span> <span class="token class-name">EventFd</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">EFD_NONBLOCK</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">trigger_irq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> irq_type<span class="token punctuation">:</span> <span class="token class-name">IrqType</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>result<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> irq <span class="token operator">=</span> <span class="token keyword">match</span> irq_type <span class="token punctuation">{</span>
            <span class="token class-name">IrqType</span><span class="token punctuation">::</span><span class="token class-name">Config</span> <span class="token operator">=&gt;</span> <span class="token constant">VIRTIO_MMIO_INT_CONFIG</span><span class="token punctuation">,</span>
            <span class="token class-name">IrqType</span><span class="token punctuation">::</span><span class="token class-name">Vring</span> <span class="token operator">=&gt;</span> <span class="token constant">VIRTIO_MMIO_INT_VRING</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//irq&#x72B6;&#x6001;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>irq_status<span class="token punctuation">.</span><span class="token function">fetch_or</span><span class="token punctuation">(</span>irq <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//eventfd&#x5199;1</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>irq_evt<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>e<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token macro property">error!</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to send irq to the guest: {:?}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            e
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="virtiodevice-trait"><a name="virtiodevice-trait" class="anchor-navigation-ex-anchor" href="#virtiodevice-trait"><i class="fa fa-link" aria-hidden="true"></i></a>7.5.3. VirtioDevice trait</h3>
<pre class="language-"><code class="lang-rust"><span class="token comment">/// Trait for virtio devices to be driven by a virtio transport.</span>
<span class="token comment">///</span>
<span class="token comment">/// The lifecycle of a virtio device is to be moved to a virtio transport, which will then query the</span>
<span class="token comment">/// device. The virtio devices needs to create queues, events and event fds for interrupts and expose</span>
<span class="token comment">/// them to the transport via get_queues/get_queue_events/get_interrupt/get_interrupt_status fns.</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">VirtioDevice</span><span class="token punctuation">:</span> <span class="token class-name">AsAny</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Get the available features offered by device.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">avail_features</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u64</span><span class="token punctuation">;</span>

    <span class="token comment">/// Get acknowledged features of the driver.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">acked_features</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u64</span><span class="token punctuation">;</span>

    <span class="token comment">/// Set acknowledged features of the driver.</span>
    <span class="token comment">/// This function must maintain the following invariant:</span>
    <span class="token comment">/// - self.avail_features() &amp; self.acked_features() = self.get_acked_features()</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">set_acked_features</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> acked_features<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">has_feature</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> feature<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">acked_features</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> feature<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// The virtio device type.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">device_type</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u32</span><span class="token punctuation">;</span>

    <span class="token comment">/// Returns the device queues.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">queues</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Queue</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">/// Returns a mutable reference to the device queues.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">queues_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token class-name">Queue</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">/// Returns the device queues event fds.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">queue_events</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">EventFd</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">/// Returns the device interrupt eventfd.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">interrupt_evt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token class-name">EventFd</span><span class="token punctuation">;</span>

    <span class="token comment">/// Returns the current device interrupt status.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">interrupt_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">AtomicUsize</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token comment">/// The set of feature bits shifted by `page * 32`.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">avail_features_by_page</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> page<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u32</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> avail_features <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">avail_features</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> page <span class="token punctuation">{</span>
            <span class="token comment">// Get the lower 32-bits of the features bitfield.</span>
            <span class="token number">0</span> <span class="token operator">=&gt;</span> avail_features <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
            <span class="token comment">// Get the upper 32-bits of the features bitfield.</span>
            <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>avail_features <span class="token operator">&gt;&gt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token macro property">warn!</span><span class="token punctuation">(</span><span class="token string">&quot;Received request for unknown features page.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token number">0u32</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Acknowledges that this set of features should be enabled.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">ack_features_by_page</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> page<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> v <span class="token operator">=</span> <span class="token keyword">match</span> page <span class="token punctuation">{</span>
            <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token keyword">u64</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token keyword">u64</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token macro property">warn!</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot acknowledge unknown features page: {}&quot;</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token number">0u64</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// Check if the guest is ACK&apos;ing a feature that we didn&apos;t claim to have.</span>
        <span class="token keyword">let</span> avail_features <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">avail_features</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> unrequested_features <span class="token operator">=</span> v <span class="token operator">&amp;</span> <span class="token operator">!</span>avail_features<span class="token punctuation">;</span>
        <span class="token keyword">if</span> unrequested_features <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token macro property">warn!</span><span class="token punctuation">(</span><span class="token string">&quot;Received acknowledge request for unknown feature: {:x}&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Don&apos;t count these features as acked.</span>
            v <span class="token operator">&amp;=</span> <span class="token operator">!</span>unrequested_features<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">set_acked_features</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">acked_features</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Reads this device configuration space at `offset`.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">read_config</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> offset<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// Writes to this device configuration space at `offset`.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">write_config</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> offset<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// Performs the formal activation for a device, which can be verified also with `is_activated`.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">activate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> mem<span class="token punctuation">:</span> <span class="token class-name">GuestMemoryMmap</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ActivateResult</span><span class="token punctuation">;</span>

    <span class="token comment">/// Checks if the resources of this device are activated.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">is_activated</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span><span class="token punctuation">;</span>

    <span class="token comment">/// Optionally deactivates this device and returns ownership of the guest memory map, interrupt</span>
    <span class="token comment">/// event, and queue events.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">EventFd</span><span class="token punctuation">,</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">EventFd</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">None</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="virtio&#x8BBE;&#x5907;&#x6846;&#x56FE;"><a name="virtio&#x8BBE;&#x5907;&#x6846;&#x56FE;" class="anchor-navigation-ex-anchor" href="#virtio&#x8BBE;&#x5907;&#x6846;&#x56FE;"><i class="fa fa-link" aria-hidden="true"></i></a>7.6. VirtIO&#x8BBE;&#x5907;&#x6846;&#x56FE;</h2>
<p><img src="img/rust_firecracker_mmio_virtio.svg" alt="">  </p>
<h2 id="virtio-net"><a name="virtio-net" class="anchor-navigation-ex-anchor" href="#virtio-net"><i class="fa fa-link" aria-hidden="true"></i></a>7.7. virtIO net</h2>
<p>virtIO net&#x7684;&#x5B9A;&#x4E49;&#x5F88;&#x590D;&#x6742;</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Net</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>

    <span class="token keyword">pub</span> tap<span class="token punctuation">:</span> <span class="token class-name">Tap</span><span class="token punctuation">,</span> <span class="token comment">//&#x5BF9;&#x63A5;&#x7684;tap&#x8BBE;&#x5907;</span>

    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> avail_features<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> acked_features<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>

    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> queues<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Queue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> queue_evts<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">EventFd</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> rx_rate_limiter<span class="token punctuation">:</span> <span class="token class-name">RateLimiter</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> tx_rate_limiter<span class="token punctuation">:</span> <span class="token class-name">RateLimiter</span><span class="token punctuation">,</span>

    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> rx_deferred_frame<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    rx_deferred_irqs<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>

    rx_bytes_read<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    rx_frame_buf<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">;</span> <span class="token constant">MAX_BUFFER_SIZE</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    tx_iovec<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">GuestAddress</span><span class="token punctuation">,</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    tx_frame_buf<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">;</span> <span class="token constant">MAX_BUFFER_SIZE</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> irq_trigger<span class="token punctuation">:</span> <span class="token class-name">IrqTrigger</span><span class="token punctuation">,</span> <span class="token comment">//&#x4E2D;&#x65AD;&#x89E6;&#x53D1;, &#x91CC;&#x9762;&#x662F;eventfd</span>

    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> config_space<span class="token punctuation">:</span> <span class="token class-name">ConfigSpace</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> guest_mac<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">MacAddr</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> device_state<span class="token punctuation">:</span> <span class="token class-name">DeviceState</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> activate_evt<span class="token punctuation">:</span> <span class="token class-name">EventFd</span><span class="token punctuation">,</span>

    <span class="token keyword">pub</span> mmds_ns<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">MmdsNetworkStack</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>

    <span class="token attribute attr-name">#[cfg(test)]</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> mocks<span class="token punctuation">:</span> <span class="token class-name">Mocks</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Net&#x5B9E;&#x73B0;&#x4E86;&#x5F88;&#x591A;&#x65B9;&#x6CD5;, &#x6BD4;&#x5982;&#x4EA4;&#x6362;tap&#x8BBE;&#x5907;&#x548C;queue&#x7684;&#x6570;&#x636E;:</p>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span> <span class="token class-name">Net</span> <span class="token punctuation">{</span>
    <span class="token function">new_with_tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">guest_mac</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">iface_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">mmds_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">signal_used_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">.</span>irq_trigger<span class="token punctuation">.</span><span class="token function">trigger_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token function">signal_rx_used_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">do_write_frame_to_guest</span><span class="token punctuation">(</span>
    <span class="token function">write_frame_to_guest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">read_from_mmds_or_tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//&#x5904;&#x7406;&#x4ECE;tap&#x8BBE;&#x5907;&#x6765;&#x7684;&#x6570;&#x636E;, &#x7136;&#x540E;&#x7ED9;guest&#x53D1;irq: </span>
    <span class="token comment">//self.signal_used_queue() -&gt; self.irq_trigger.trigger_irq(IrqType::Vring) &#x8FD8;&#x662F;&#x5199;eventfd</span>
    <span class="token function">process_rx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token function">handle_deferred_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">resume_rx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">process_tx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">read_tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">process_rx_queue_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">process_tap_rx_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">process_tx_queue_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">process_virtio_queues</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="net&#x5B9E;&#x73B0;&#x4E86;virtiodevice"><a name="net&#x5B9E;&#x73B0;&#x4E86;virtiodevice" class="anchor-navigation-ex-anchor" href="#net&#x5B9E;&#x73B0;&#x4E86;virtiodevice"><i class="fa fa-link" aria-hidden="true"></i></a>7.7.1. Net&#x5B9E;&#x73B0;&#x4E86;VirtioDevice</h3>
<p>&#x76F8;&#x5BF9;&#x6BD4;&#x8F83;&#x8584;&#x7684;&#x4E00;&#x5C42;, &#x5B9E;&#x73B0;&#x4E86;&#x4E0B;&#x9762;&#x7684;&#x65B9;&#x6CD5;:<br><img src="img/rust_firecracker_&#x4EE3;&#x7801;_20220825230957.png" alt="">  </p>
<h3 id="net&#x8FD8;&#x5B9E;&#x73B0;&#x4E86;muteventsubscriber"><a name="net&#x8FD8;&#x5B9E;&#x73B0;&#x4E86;muteventsubscriber" class="anchor-navigation-ex-anchor" href="#net&#x8FD8;&#x5B9E;&#x73B0;&#x4E86;muteventsubscriber"><i class="fa fa-link" aria-hidden="true"></i></a>7.7.2. Net&#x8FD8;&#x5B9E;&#x73B0;&#x4E86;MutEventSubscriber</h3>
<pre class="language-"><code class="lang-rust"><span class="token keyword">impl</span> <span class="token class-name">MutEventSubscriber</span> <span class="token keyword">for</span> <span class="token class-name">Net</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token class-name">Events</span><span class="token punctuation">,</span> ops<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">EventOps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> source <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> event_set <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">event_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// TODO: also check for errors. Pending high level discussions on how we want</span>
        <span class="token comment">// to handle errors in devices.</span>
        <span class="token keyword">let</span> supported_events <span class="token operator">=</span> <span class="token class-name">EventSet</span><span class="token punctuation">::</span><span class="token constant">IN</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>supported_events<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>event_set<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token macro property">warn!</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Received unknown event: {:?} from source: {:?}&quot;</span><span class="token punctuation">,</span>
                event_set<span class="token punctuation">,</span> source
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_activated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> virtq_rx_ev_fd <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>queue_evts<span class="token punctuation">[</span><span class="token constant">RX_INDEX</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">as_raw_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> virtq_tx_ev_fd <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>queue_evts<span class="token punctuation">[</span><span class="token constant">TX_INDEX</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">as_raw_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> rx_rate_limiter_fd <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>rx_rate_limiter<span class="token punctuation">.</span><span class="token function">as_raw_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> tx_rate_limiter_fd <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tx_rate_limiter<span class="token punctuation">.</span><span class="token function">as_raw_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> tap_fd <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tap<span class="token punctuation">.</span><span class="token function">as_raw_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> activate_fd <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>activate_evt<span class="token punctuation">.</span><span class="token function">as_raw_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Looks better than C style if/else if/else.</span>
            <span class="token keyword">match</span> source <span class="token punctuation">{</span>
                _ <span class="token keyword">if</span> source <span class="token operator">==</span> virtq_rx_ev_fd <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">process_rx_queue_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                _ <span class="token keyword">if</span> source <span class="token operator">==</span> tap_fd <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">process_tap_rx_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//tap&#x8BBE;&#x5907;&#x6765;&#x6570;&#x636E;&#x4E86;</span>
                _ <span class="token keyword">if</span> source <span class="token operator">==</span> virtq_tx_ev_fd <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">process_tx_queue_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                _ <span class="token keyword">if</span> source <span class="token operator">==</span> rx_rate_limiter_fd <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">process_rx_rate_limiter_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                _ <span class="token keyword">if</span> source <span class="token operator">==</span> tx_rate_limiter_fd <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">process_tx_rate_limiter_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                _ <span class="token keyword">if</span> activate_fd <span class="token operator">==</span> source <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">process_activate_event</span><span class="token punctuation">(</span>ops<span class="token punctuation">)</span><span class="token punctuation">,</span>
                _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token macro property">warn!</span><span class="token punctuation">(</span><span class="token string">&quot;Net: Spurious event received: {:?}&quot;</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token constant">METRICS</span><span class="token punctuation">.</span>net<span class="token punctuation">.</span>event_fails<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token macro property">warn!</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Net: The device is not yet activated. Spurious event received: {:?}&quot;</span><span class="token punctuation">,</span>
                source
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ops<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">EventOps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// This function can be called during different points in the device lifetime:</span>
        <span class="token comment">//  - shortly after device creation,</span>
        <span class="token comment">//  - on device activation (is-activated already true at this point),</span>
        <span class="token comment">//  - on device restore from snapshot.</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_activated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">register_runtime_events</span><span class="token punctuation">(</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">register_activate_event</span><span class="token punctuation">(</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="rust_vmm_简介.html" class="navigation navigation-prev " aria-label="Previous page: rust-vmm简介">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="rust_firecracker_使用.html" class="navigation navigation-next " aria-label="Next page: firecracker使用">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"firecracker代码","level":"3.2.2","depth":2,"next":{"title":"firecracker使用","level":"3.2.3","depth":2,"path":"notes/rust_firecracker_使用.md","ref":"notes/rust_firecracker_使用.md","articles":[]},"previous":{"title":"rust-vmm简介","level":"3.2.1","depth":2,"path":"notes/rust_vmm_简介.md","ref":"notes/rust_vmm_简介.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","-lunr","-search","search-plus","-highlight","prism","prism-themes","expandable-chapters-small","github","disqus","splitter","wide-page","hide-navigation-buttons","anchor-navigation-ex"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"prism":{"css":["prism-themes/themes/prism-coldark-cold.css"]},"disqus":{"useIdentifier":false,"shortName":"bai-yingjie-notes"},"github":{"url":"https://github.com/Bai-Yingjie/Bai-Yingjie.github.io"},"splitter":{},"wide-page":{},"fontsettings":{"theme":"white","family":"sans","size":2},"hide-navigation-buttons":{},"anchor-navigation-ex":{"mode":"float","pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"isRewritePageTitle":true,"showLevel":true,"tocLevel1Icon":"fa fa-hand-o-right","tocLevel2Icon":"fa fa-hand-o-right","tocLevel3Icon":"fa fa-hand-o-right","showGoTop":true,"isShowTocTitleIcon":true,"printLog":false,"multipleH1":true,"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false}},"prism-themes":{},"expandable-chapters-small":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"theme":"default","author":"Bai Yingjie","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"My Notes","language":"zh-hans","gitbook":"*"},"file":{"path":"notes/rust_firecracker_代码.md","mtime":"2022-08-28T23:26:18.425Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-08-28T23:27:00.384Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

