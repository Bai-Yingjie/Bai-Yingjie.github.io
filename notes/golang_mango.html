
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>消息中间件mango · My Notes</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Bai Yingjie">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-wide-page/wide.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hide-navigation-buttons/index.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="golang_libp2p.html" />
    
    
    <link rel="prev" href="golang_zmq.html" />
    

    </head>
    <body>
        


<div class="book">
    <div class="book-summary">
        
            <div class="theme-code-header">
                <a href="" class="link">
                    <h1 class="title">My Notes</h1>
                </a>
            </div>
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    开源
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="my_opensource.html">
            
                <a href="my_opensource.html">
            
                    
                    我的开源项目
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="my_upstream.html">
            
                <a href="my_upstream.html">
            
                    
                    我的upstream commit
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    系统分析和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="system_analysis_bcc和ebpf.html">
            
                <a href="system_analysis_bcc和ebpf.html">
            
                    
                    bcc和ebpf(starting)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="performance_ovs进程调查.html">
            
                <a href="performance_ovs进程调查.html">
            
                    
                    OVS进程调查
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="performance_ping流程和函数调用解析.html">
            
                <a href="performance_ping流程和函数调用解析.html">
            
                    
                    ping流程和函数调用解析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="CentOS_系统性能优化配置.html">
            
                <a href="CentOS_系统性能优化配置.html">
            
                    
                    CentOS 性能优化系统配置
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    ARM server
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="arm_server_杂记.html">
            
                <a href="arm_server_杂记.html">
            
                    
                    Arm server 杂记
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    嵌入式系统开发调试
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="embedded_debugging.html">
            
                <a href="embedded_debugging.html">
            
                    
                    嵌入式调试杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="uboot_杂记.html">
            
                <a href="uboot_杂记.html">
            
                    
                    uboot杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="buildroot_杂记.html">
            
                <a href="buildroot_杂记.html">
            
                    
                    buildroot杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="toolchain_升级gcc问题解决.html">
            
                <a href="toolchain_升级gcc问题解决.html">
            
                    
                    升级GCC7.3问题解决
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Linux工程实践
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="linux_日常使用.html">
            
                <a href="linux_日常使用.html">
            
                    
                    日常linux使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="git_日常使用.html">
            
                <a href="git_日常使用.html">
            
                    
                    日常git使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="向kernel提交补丁.html">
            
                <a href="向kernel提交补丁.html">
            
                    
                    向kernel提交补丁
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="linux_ssh_relay.html">
            
                <a href="linux_ssh_relay.html">
            
                    
                    ssh relay
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="gitlab_ci.html">
            
                <a href="gitlab_ci.html">
            
                    
                    gitlab CI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="docker_操作记录.html">
            
                <a href="docker_操作记录.html">
            
                    
                    docker操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="centos_操作记录.html">
            
                <a href="centos_操作记录.html">
            
                    
                    centos操作记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Golang
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    入门
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1.1" data-path="golang_语法基础.html">
            
                <a href="golang_语法基础.html">
            
                    
                    Golang 语法基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.2" data-path="golang_json性能.html">
            
                <a href="golang_json性能.html">
            
                    
                    Golang json性能比较
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="golang_原理.html">
            
                <a href="golang_原理.html">
            
                    
                    Golang 原理相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.2.1" data-path="golang_interface原理.html">
            
                <a href="golang_interface原理.html">
            
                    
                    Golang interface原理(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.2" data-path="golang_内存分配.html">
            
                <a href="golang_内存分配.html">
            
                    
                    Golang 内存分配(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="golang_标准库.html">
            
                <a href="golang_标准库.html">
            
                    
                    Golang 标准库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="golang_我的反射代码.html">
            
                <a href="golang_我的反射代码.html">
            
                    
                    Golang 我的反射代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="golang_问答.html">
            
                <a href="golang_问答.html">
            
                    
                    Golang 问答
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="golang_高效go.html">
            
                <a href="golang_高效go.html">
            
                    
                    Golang 高效go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" data-path="golang_进阶.html">
            
                <a href="golang_进阶.html">
            
                    
                    Golang 进阶
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Golang 杂记
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.8.1" data-path="golang_杂记1.html">
            
                <a href="golang_杂记1.html">
            
                    
                    Golang 杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8.2" data-path="golang_杂记2.html">
            
                <a href="golang_杂记2.html">
            
                    
                    Golang 杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8.3" data-path="golang_杂记3.html">
            
                <a href="golang_杂记3.html">
            
                    
                    Golang 杂记3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8.4" data-path="golang_lib选型.html">
            
                <a href="golang_lib选型.html">
            
                    
                    Golang lib选型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8.5" data-path="golang_mod_proxy.html">
            
                <a href="golang_mod_proxy.html">
            
                    
                    go mod和go proxy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8.6" data-path="golang_汇编_arm64.html">
            
                <a href="golang_汇编_arm64.html">
            
                    
                    Golang 汇编语法和arm64小知识
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8.7" data-path="golang_cgo_swig.html">
            
                <a href="golang_cgo_swig.html">
            
                    
                    go调用c可以用swig
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.9" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Golang 环境和工具链生成
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.9.1" data-path="golang_toolchain_ppc.html">
            
                <a href="golang_toolchain_ppc.html">
            
                    
                    go tools增加ppc32支持.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9.2" data-path="golang_toolchain_compile_gccgo.html">
            
                <a href="golang_toolchain_compile_gccgo.html">
            
                    
                    编译gccgo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9.3" data-path="golang_go_on_mips.html">
            
                <a href="golang_go_on_mips.html">
            
                    
                    go on mips boards(not so updated)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.9.3.1" data-path="golang_go_on_mips_part1.html">
            
                <a href="golang_go_on_mips_part1.html">
            
                    
                    part 1: cross compile go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9.3.2" data-path="golang_go_on_mips_part2.html">
            
                <a href="golang_go_on_mips_part2.html">
            
                    
                    part 2: build native go compiler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9.3.3" data-path="golang_go_on_mips_part3.html">
            
                <a href="golang_go_on_mips_part3.html">
            
                    
                    part 3: gccgo experiments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9.3.4" data-path="golang_go_on_mips_part4.html">
            
                <a href="golang_go_on_mips_part4.html">
            
                    
                    part 4: Golang json performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9.3.5" data-path="golang_gentoo_on_mips_board_and_build_go.html">
            
                <a href="golang_gentoo_on_mips_board_and_build_go.html">
            
                    
                    Gentoo on mips board and build go
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.10" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    微服务
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.10.1" data-path="golang_micro.html">
            
                <a href="golang_micro.html">
            
                    
                    go-micro和micro
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.10.2" data-path="golang_微服务概念.html">
            
                <a href="golang_微服务概念.html">
            
                    
                    微服务概念
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.11" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    解释器和编解码
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.11.1" data-path="golang_yeagi.html">
            
                <a href="golang_yeagi.html">
            
                    
                    解释器yeagi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.11.2" data-path="golang_tengo.html">
            
                <a href="golang_tengo.html">
            
                    
                    解释器tengo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.11.3" data-path="golang_govaluate.html">
            
                <a href="golang_govaluate.html">
            
                    
                    解释器govaluate
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.11.4" data-path="golang_encoding_gotiny.html">
            
                <a href="golang_encoding_gotiny.html">
            
                    
                    gotiny编解码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.11.5" data-path="golang_abs.html">
            
                <a href="golang_abs.html">
            
                    
                    解释器abs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.12" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    调试和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.12.1" data-path="golang_调试记录.html">
            
                <a href="golang_调试记录.html">
            
                    
                    Golang 调试记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.12.2" data-path="golang_topid性能优化.html">
            
                <a href="golang_topid性能优化.html">
            
                    
                    Golang topid性能优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.12.3" data-path="golang_gshell性能调试.html">
            
                <a href="golang_gshell性能调试.html">
            
                    
                    Golang gshell性能调试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.13" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    网络和消息中间件
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.13.1" data-path="golang_zmq.html">
            
                <a href="golang_zmq.html">
            
                    
                    消息中间件基本概念和zero mq
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.7.13.2" data-path="golang_mango.html">
            
                <a href="golang_mango.html">
            
                    
                    消息中间件mango
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.13.3" data-path="golang_libp2p.html">
            
                <a href="golang_libp2p.html">
            
                    
                    Golang p2p网络
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Rust
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="rust_入门_brief.html">
            
                <a href="rust_入门_brief.html">
            
                    
                    Rust 入门系列
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1.1" data-path="rust_books.html">
            
                <a href="rust_books.html">
            
                    
                    Rust reference books
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.2" data-path="rust_入门1.html">
            
                <a href="rust_入门1.html">
            
                    
                    Rust 安装和基础语法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.3" data-path="rust_入门2.html">
            
                <a href="rust_入门2.html">
            
                    
                    Rust 泛型和内存所有权
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.4" data-path="rust_入门3.html">
            
                <a href="rust_入门3.html">
            
                    
                    Rust 闭包 容器 迭代器 生成器 线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.5" data-path="rust_工程构建.html">
            
                <a href="rust_工程构建.html">
            
                    
                    Rust 工程构建
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="rust_coding_brief.html">
            
                <a href="rust_coding_brief.html">
            
                    
                    Rust 代码积累
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.2.1" data-path="rust_序列化.html">
            
                <a href="rust_序列化.html">
            
                    
                    Rust 序列化原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.2" data-path="rust_知识点积累.html">
            
                <a href="rust_知识点积累.html">
            
                    
                    Rust 知识点更新
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.3" data-path="rust_adaptiveservice.html">
            
                <a href="rust_adaptiveservice.html">
            
                    
                    rust版本的adaptiveservice探索
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.4" data-path="rust_常用设施.html">
            
                <a href="rust_常用设施.html">
            
                    
                    Rust 常用设施
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.5" data-path="rust_代码小段.html">
            
                <a href="rust_代码小段.html">
            
                    
                    Rust 代码小段
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="others.html">
            
                <a href="others.html">
            
                    
                    其他
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.3.1" data-path="rust_mdbook_使用.html">
            
                <a href="rust_mdbook_使用.html">
            
                    
                    Rust 使用mdbook
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    C开发
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="c_automake_autoconf.html">
            
                <a href="c_automake_autoconf.html">
            
                    
                    automake autoconf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="makefile_原理和实践.html">
            
                <a href="makefile_原理和实践.html">
            
                    
                    makefile
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="c_编程杂记高级篇.html">
            
                <a href="c_编程杂记高级篇.html">
            
                    
                    C编程杂记高级篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="c_编程杂记基础篇.html">
            
                <a href="c_编程杂记基础篇.html">
            
                    
                    C编程杂记基础篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5" data-path="c_networking_socket高阶用法.html">
            
                <a href="c_networking_socket高阶用法.html">
            
                    
                    网络编程: Advanced Socket Topics(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.6" data-path="c_protobuf介绍.html">
            
                <a href="c_protobuf介绍.html">
            
                    
                    序列化: protobuf介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.7" data-path="c_进程间通信_共享文件和共享内存.html">
            
                <a href="c_进程间通信_共享文件和共享内存.html">
            
                    
                    进程间通信: 共享文件和共享内存(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.8" data-path="c_pthread_condition和mutex.html">
            
                <a href="c_pthread_condition和mutex.html">
            
                    
                    并发 任务 事件 和锁.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.9" data-path="kernel_user_space_howto.html">
            
                <a href="kernel_user_space_howto.html">
            
                    
                    kernel space和user space交互(网摘, linux2.6)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    脚本
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="shell_变量.html">
            
                <a href="shell_变量.html">
            
                    
                    shell变量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="shell_基础篇.html">
            
                <a href="shell_基础篇.html">
            
                    
                    shell命令和脚本记录-基础篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="shell_高级篇.html">
            
                <a href="shell_高级篇.html">
            
                    
                    shell命令和脚本记录-高级篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="shell_脚本片段.html">
            
                <a href="shell_脚本片段.html">
            
                    
                    shell脚本片段
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="python_记录.html">
            
                <a href="python_记录.html">
            
                    
                    python记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6" data-path="lua_记录.html">
            
                <a href="lua_记录.html">
            
                    
                    lua记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.7" data-path="shell_rds脚本阅读.html">
            
                <a href="shell_rds脚本阅读.html">
            
                    
                    RDS脚本阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8" data-path="Project_Euler.html">
            
                <a href="Project_Euler.html">
            
                    
                    Project Euler
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    cloud和容器相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="cloud_杂记.html">
            
                <a href="cloud_杂记.html">
            
                    
                    云杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="container_当代容器读书笔记.html">
            
                <a href="container_当代容器读书笔记.html">
            
                    
                    当代容器读书笔记
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Operating System
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="system_libc_part1.html">
            
                <a href="system_libc_part1.html">
            
                    
                    libc概览1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="system_libc_part2.html">
            
                <a href="system_libc_part2.html">
            
                    
                    libc概览2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="system_libc_part3.html">
            
                <a href="system_libc_part3.html">
            
                    
                    libc概览3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.4" data-path="system_原理杂记.html">
            
                <a href="system_原理杂记.html">
            
                    
                    系统原理杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.5" data-path="system_alpine.html">
            
                <a href="system_alpine.html">
            
                    
                    Alpine Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.6" data-path="system_进程间通信.html">
            
                <a href="system_进程间通信.html">
            
                    
                    进程间通信
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.7" data-path="system_特殊功能fd.html">
            
                <a href="system_特殊功能fd.html">
            
                    
                    eventfd timerfd signalfd和fd共享
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    CPU和device虚拟化
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    gvisor
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1.1" data-path="golang_gvisor代码_KVM.html">
            
                <a href="golang_gvisor代码_KVM.html">
            
                    
                    gvisor KVM模式代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.1.2" data-path="golang_gvisor调试.html">
            
                <a href="golang_gvisor调试.html">
            
                    
                    gvisor调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.1.3" data-path="golang_gvisor_ptrace.html">
            
                <a href="golang_gvisor_ptrace.html">
            
                    
                    gvisor ptrace模式介绍(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13.2" data-path="rust_vmm_brief.html">
            
                <a href="rust_vmm_brief.html">
            
                    
                    rust VMM(virtual machine monitor)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.2.1" data-path="rust_vmm_简介.html">
            
                <a href="rust_vmm_简介.html">
            
                    
                    rust-vmm简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2.2" data-path="rust_firecracker_代码.html">
            
                <a href="rust_firecracker_代码.html">
            
                    
                    firecracker代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2.3" data-path="rust_firecracker_使用.html">
            
                <a href="rust_firecracker_使用.html">
            
                    
                    firecracker使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2.4" data-path="rust_cloud-hypervisor_代码.html">
            
                <a href="rust_cloud-hypervisor_代码.html">
            
                    
                    cloud hypervisor代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2.5" data-path="rust_cloud-hypervisor_使用.html">
            
                <a href="rust_cloud-hypervisor_使用.html">
            
                    
                    cloud hypervisor使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2.6" data-path="rust_cloud-hypervisor_问题与解决.html">
            
                <a href="rust_cloud-hypervisor_问题与解决.html">
            
                    
                    cloud hypervisor问题与解决
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13.3" data-path="virtualization_virtio规范阅读笔记.html">
            
                <a href="virtualization_virtio规范阅读笔记.html">
            
                    
                    virtio规范阅读笔记.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.4" data-path="qemu_ovs_虚拟化环境.html">
            
                <a href="qemu_ovs_虚拟化环境.html">
            
                    
                    qemu OVS 虚拟化环境准备
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.5" data-path="qemu使用.html">
            
                <a href="qemu使用.html">
            
                    
                    Qemu使用(old)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    计算机网络相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" data-path="networking_杂记1.html">
            
                <a href="networking_杂记1.html">
            
                    
                    networking杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Qemu OVS和DPDK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.2.1" data-path="OVS_DPDK_编译运行.html">
            
                <a href="OVS_DPDK_编译运行.html">
            
                    
                    OVS-DPDK编译运行
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2.2" data-path="OVS_架构和代码.html">
            
                <a href="OVS_架构和代码.html">
            
                    
                    OVS架构和代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2.3" data-path="OVS_DPDK_performance_HXT_ARM_server.html">
            
                <a href="OVS_DPDK_performance_HXT_ARM_server.html">
            
                    
                    OVS-DPDK for ARM server 性能测试环境
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2.4" data-path="DPDK_Mellanox.html">
            
                <a href="DPDK_Mellanox.html">
            
                    
                    DPDK Mellanox
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2.5" data-path="OVS_phy-vm-phy.html">
            
                <a href="OVS_phy-vm-phy.html">
            
                    
                    OVS PHY-VM-PHY
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2.6" data-path="networking_网络虚拟化用例记录.html">
            
                <a href="networking_网络虚拟化用例记录.html">
            
                    
                    网络虚拟化用例记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2.7" data-path="networking_网络虚拟化操作记录.html">
            
                <a href="networking_网络虚拟化操作记录.html">
            
                    
                    网络虚拟化操作记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    虚拟化网络
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.3.1" data-path="networking_tc_filter_连接veth和tap.html">
            
                <a href="networking_tc_filter_连接veth和tap.html">
            
                    
                    Connecting a veth device to tap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.3.2" data-path="networking_multicast_vxlan_flannel.html">
            
                <a href="networking_multicast_vxlan_flannel.html">
            
                    
                    multicast vxlan和flannel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.3.3" data-path="networking_virtio网络介绍.html">
            
                <a href="networking_virtio网络介绍.html">
            
                    
                    virtio网络介绍(网摘): vhost-net virtio-net vhost-user SRIOV
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.3.4" data-path="networking_virtualization_杂记.html">
            
                <a href="networking_virtualization_杂记.html">
            
                    
                    虚拟化网络杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.3.5" data-path="networking_linux虚拟网络接口.html">
            
                <a href="networking_linux虚拟网络接口.html">
            
                    
                    linux虚拟网络接口(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    内核 设备和驱动相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.1" data-path="driver_驱动中使用工作队列轮询.html">
            
                <a href="driver_驱动中使用工作队列轮询.html">
            
                    
                    驱动中使用工作队列轮询
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="device_driver_杂记.html">
            
                <a href="device_driver_杂记.html">
            
                    
                    驱动调试杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.3" data-path="device_driver_原理相关.html">
            
                <a href="device_driver_原理相关.html">
            
                    
                    kernel和驱动原理相关
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.4" data-path="device_localbus_16bit读写.html">
            
                <a href="device_localbus_16bit读写.html">
            
                    
                    CPLD做8bit到16bit转换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.5" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    nand
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.5.1" data-path="device_driver_octeon_nand.html">
            
                <a href="device_driver_octeon_nand.html">
            
                    
                    octeon nand flash驱动
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.5.2" data-path="device_driver_nand概率写失败问题分析.html">
            
                <a href="device_driver_nand概率写失败问题分析.html">
            
                    
                    Nand flash概率写失败问题分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15.6" data-path="octeon_remote_pci.html">
            
                <a href="octeon_remote_pci.html">
            
                    
                    octeon remote-pci.c阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.7" data-path="Device_VFIO_notes.html">
            
                <a href="Device_VFIO_notes.html">
            
                    
                    VFIO简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    智能网卡和DPDK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.8.1" data-path="smartNIC_智能网卡对比.html">
            
                <a href="smartNIC_智能网卡对比.html">
            
                    
                    智能网卡对比
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8.2" data-path="octeon_pci_NIC.html">
            
                <a href="octeon_pci_NIC.html">
            
                    
                    octeon PCI NIC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    octeon liquidIO
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.8.3.1" data-path="smartNIC_liquidIO_代码阅读app篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读app篇.html">
            
                    
                    PCI-NIC 代码阅读 --app篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8.3.2" data-path="smartNIC_liquidIO_代码阅读api篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读api篇.html">
            
                    
                    PCI-NIC 代码阅读 --api篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8.3.3" data-path="smartNIC_liquidIO_代码阅读driver篇之结构体.html">
            
                <a href="smartNIC_liquidIO_代码阅读driver篇之结构体.html">
            
                    
                    PCI-NIC 代码阅读 --driver篇之结构体
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8.3.4" data-path="smartNIC_liquidIO_代码阅读driver篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读driver篇.html">
            
                    
                    PCI-NIC 代码阅读 --driver篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8.3.5" data-path="smartNIC_liquidIO_代码阅读真NIC篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读真NIC篇.html">
            
                    
                    PCI-NIC 代码阅读 --真NIC篇
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15.8.4" data-path="networking_dpdk使用_2014.html">
            
                <a href="networking_dpdk使用_2014.html">
            
                    
                    DPDK使用(2014)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15.9" data-path="device_nvme要点介绍.html">
            
                <a href="device_nvme要点介绍.html">
            
                    
                    nvme要点介绍
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    CPU Arch相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    ARM64
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1.1" data-path="CPU_ARM64_thunder_overview.html">
            
                <a href="CPU_ARM64_thunder_overview.html">
            
                    
                    thunder 概览
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.1.2" data-path="CPU_ARM64_thunder_开发板操作记录.html">
            
                <a href="CPU_ARM64_thunder_开发板操作记录.html">
            
                    
                    thunder 开发板操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.1.3" data-path="CPU_ARM64_thunder_bdk.html">
            
                <a href="CPU_ARM64_thunder_bdk.html">
            
                    
                    thunder BDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.1.4" data-path="CPU_ARM64_thunder_efi_rtc.html">
            
                <a href="CPU_ARM64_thunder_efi_rtc.html">
            
                    
                    thunder RTC时间和efi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.1.5" data-path="CPU_ARM64_thunder_uefi_fdt.html">
            
                <a href="CPU_ARM64_thunder_uefi_fdt.html">
            
                    
                    thunder uefi和fdt
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.1.6" data-path="CPU_ARM64_thunder_atf.html">
            
                <a href="CPU_ARM64_thunder_atf.html">
            
                    
                    thunder atf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.1.7" data-path="CPU_ARM64_thunder_kernel_boot.html">
            
                <a href="CPU_ARM64_thunder_kernel_boot.html">
            
                    
                    thunder kernel启动打印流程
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.2" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    PPC
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.2.1" data-path="CPU_PPC启动多核Linux_流程和内存映射.html">
            
                <a href="CPU_PPC启动多核Linux_流程和内存映射.html">
            
                    
                    PPC启动多核linux: 流程和内存映射
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.2.2" data-path="CPU_PPC_kernel升级记录.html">
            
                <a href="CPU_PPC_kernel升级记录.html">
            
                    
                    PPC kernel升级记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    MIPS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.3.1" data-path="CPU_MIPS_octeon地址空间和寄存器访问.html">
            
                <a href="CPU_MIPS_octeon地址空间和寄存器访问.html">
            
                    
                    octeon 地址空间和寄存器访问
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.2" data-path="CPU_MIPS_octeon操作记录.html">
            
                <a href="CPU_MIPS_octeon操作记录.html">
            
                    
                    octeon 操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.3" data-path="CPU_MIPS_octeon_包处理性能.html">
            
                <a href="CPU_MIPS_octeon_包处理性能.html">
            
                    
                    octeon 系列处理器包处理性能
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.4" data-path="CPU_MIPS_octeon_ddr调试记录.html">
            
                <a href="CPU_MIPS_octeon_ddr调试记录.html">
            
                    
                    octeon DDR调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.5" data-path="CPU_MIPS_octeon_BDK.html">
            
                <a href="CPU_MIPS_octeon_BDK.html">
            
                    
                    octeon CN78xx BDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.6" data-path="kernel_增加ECC中断.html">
            
                <a href="kernel_增加ECC中断.html">
            
                    
                    octeon 增加ECC中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.7" data-path="CPU_MIPS_octeon_hw-ddr2代码走读.html">
            
                <a href="CPU_MIPS_octeon_hw-ddr2代码走读.html">
            
                    
                    octeon hw-ddr2代码走读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.8" data-path="CPU_MIPS_octeon_reboot调试和ddr中断.html">
            
                <a href="CPU_MIPS_octeon_reboot调试和ddr中断.html">
            
                    
                    octeon reboot调试和DDR中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.9" data-path="CPU_MIPS_octeon中断.html">
            
                <a href="CPU_MIPS_octeon中断.html">
            
                    
                    octeon 中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.10" data-path="CPU_MIPS_octeon原子操作.html">
            
                <a href="CPU_MIPS_octeon原子操作.html">
            
                    
                    octeon 原子操作
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.11" data-path="CPU_MIPS_octeon网口代码分析.html">
            
                <a href="CPU_MIPS_octeon网口代码分析.html">
            
                    
                    octeon 网口代码分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="" target="_blank" class="gitbook-link">
            Author: Bai Yingjie
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >消息中间件mango</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#&#x5E93;&#x5730;&#x5740;"><b>1. </b>&#x5E93;&#x5730;&#x5740;</a></li><li><span class="title-icon "></span><a href="#&#x4EE3;&#x7801;&#x8D70;&#x8BFB;"><b>2. </b>&#x4EE3;&#x7801;&#x8D70;&#x8BFB;</a></li><ul><li><span class="title-icon "></span><a href="#&#x63A5;&#x53E3;&#x62BD;&#x8C61;"><b>2.1. </b>&#x63A5;&#x53E3;&#x62BD;&#x8C61;</a></li><ul><li><span class="title-icon "></span><a href="#socketgo"><b>2.1.1. </b>socket.go</a></li><li><span class="title-icon "></span><a href="#optionsgo"><b>2.1.2. </b>options.go</a></li><li><span class="title-icon "></span><a href="#pipego"><b>2.1.3. </b>pipe.go</a></li><li><span class="title-icon "></span><a href="#messagego"><b>2.1.4. </b>message.go</a></li><li><span class="title-icon "></span><a href="#protocolgo"><b>2.1.5. </b>protocol.go</a></li><li><span class="title-icon "></span><a href="#transportgo"><b>2.1.6. </b>transport.go</a></li><li><span class="title-icon "></span><a href="#&#x9876;&#x5C42;listenergo&#x548C;dialergo"><b>2.1.7. </b>&#x9876;&#x5C42;listener.go&#x548C;dialer.go</a></li><li><span class="title-icon "></span><a href="#devicego"><b>2.1.8. </b>device.go</a></li></ul><li><span class="title-icon "></span><a href="#transport"><b>2.2. </b>transport</a></li><ul><li><span class="title-icon "></span><a href="#transporttransportgo"><b>2.2.1. </b>transport/transport.go</a></li><li><span class="title-icon "></span><a href="#transporthandshakergo"><b>2.2.2. </b>transport/handshaker.go</a></li><li><span class="title-icon "></span><a href="#transportconngo"><b>2.2.3. </b>transport/conn.go</a></li><li><span class="title-icon "></span><a href="#transporttcptcpgo"><b>2.2.4. </b>transport/tcp/tcp.go</a></li><li><span class="title-icon "></span><a href="#transport&#x5C0F;&#x8282;"><b>2.2.5. </b>transport&#x5C0F;&#x8282;</a></li><li><span class="title-icon "></span><a href="#transportinprocinprocgo"><b>2.2.6. </b>transport/inproc/inproc.go</a></li><li><span class="title-icon "></span><a href="#transportipc"><b>2.2.7. </b>transport/ipc</a></li></ul><li><span class="title-icon "></span><a href="#internalcore"><b>2.3. </b>internal/core</a></li><ul><li><span class="title-icon "></span><a href="#internalcoresocketgo"><b>2.3.1. </b>internal/core/socket.go</a></li><li><span class="title-icon "></span><a href="#internalcorepipego"><b>2.3.2. </b>internal/core/pipe.go</a></li><li><span class="title-icon "></span><a href="#internalcoredialergo"><b>2.3.3. </b>internal/core/dialer.go</a></li><li><span class="title-icon "></span><a href="#internalcorelistenergo"><b>2.3.4. </b>internal/core/listener.go</a></li><li><span class="title-icon "></span><a href="#&#x603B;&#x7ED3;_3"><b>2.3.5. </b>&#x603B;&#x7ED3;</a></li></ul><li><span class="title-icon "></span><a href="#protocol"><b>2.4. </b>protocol</a></li><ul><li><span class="title-icon "></span><a href="#protocolreqreqgo"><b>2.4.1. </b>protocol/req/req.go</a></li><li><span class="title-icon "></span><a href="#protocolreprepgo"><b>2.4.2. </b>protocol/rep/rep.go</a></li><li><span class="title-icon "></span><a href="#req-rep&#x7591;&#x95EE;"><b>2.4.3. </b>req rep&#x7591;&#x95EE;</a></li><li><span class="title-icon "></span><a href="#xreq&#x548C;xrep"><b>2.4.4. </b>xreq&#x548C;xrep</a></li><li><span class="title-icon "></span><a href="#&#x518D;&#x770B;&#x6838;&#x5FC3;&#x5C42;&#x7684;&#x6838;&#x5FC3;&#x4EF7;&#x503C;"><b>2.4.5. </b>&#x518D;&#x770B;&#x6838;&#x5FC3;&#x5C42;&#x7684;&#x6838;&#x5FC3;&#x4EF7;&#x503C;</a></li></ul></ul></ul></div><a href="#&#x5E93;&#x5730;&#x5740;" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><ul>
<li><a href="#&#x5E93;&#x5730;&#x5740;">&#x5E93;&#x5730;&#x5740;</a></li>
<li><a href="#&#x4EE3;&#x7801;&#x8D70;&#x8BFB;">&#x4EE3;&#x7801;&#x8D70;&#x8BFB;</a><ul>
<li><a href="#&#x63A5;&#x53E3;&#x62BD;&#x8C61;">&#x63A5;&#x53E3;&#x62BD;&#x8C61;</a><ul>
<li><a href="#socketgo">socket.go</a><ul>
<li><a href="#socket">socket</a></li>
<li><a href="#context">context</a></li>
</ul>
</li>
<li><a href="#optionsgo">options.go</a></li>
<li><a href="#pipego">pipe.go</a></li>
<li><a href="#messagego">message.go</a><ul>
<li><a href="#message-pool">message pool</a></li>
<li><a href="#msg&#x5BF9;&#x8C61;&#x7684;buffer&#x7BA1;&#x7406;">msg&#x5BF9;&#x8C61;&#x7684;buffer&#x7BA1;&#x7406;</a></li>
</ul>
</li>
<li><a href="#protocolgo">protocol.go</a><ul>
<li><a href="#&#x79BB;&#x7528;&#x6237;&#x6700;&#x8FD1;&#x7684;newsocket">&#x79BB;&#x7528;&#x6237;&#x6700;&#x8FD1;&#x7684;NewSocket</a></li>
</ul>
</li>
<li><a href="#transportgo">transport.go</a><ul>
<li><a href="#tranpipe&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x8FDE;&#x63A5;conn">TranPipe&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x8FDE;&#x63A5;conn</a></li>
<li><a href="#transport&#x662F;newdialer&#x548C;newlistener&#x548C;&#x547D;&#x540D;&#x65B9;&#x5F0F;&#x7684;&#x7EC4;&#x5408;">transport&#x662F;NewDialer&#x548C;NewListener&#x548C;&#x547D;&#x540D;&#x65B9;&#x5F0F;&#x7684;&#x7EC4;&#x5408;</a></li>
<li><a href="#trandialer-tranlistener">TranDialer TranListener</a></li>
<li><a href="#&#x603B;&#x7ED3;">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#&#x9876;&#x5C42;listenergo&#x548C;dialergo">&#x9876;&#x5C42;listener.go&#x548C;dialer.go</a></li>
<li><a href="#devicego">device.go</a></li>
</ul>
</li>
<li><a href="#transport">transport</a><ul>
<li><a href="#transporttransportgo">transport/transport.go</a></li>
<li><a href="#transporthandshakergo">transport/handshaker.go</a></li>
<li><a href="#transportconngo">transport/conn.go</a><ul>
<li><a href="#recv&#x548C;send&#x5199;&#x7684;&#x5F88;&#x6709;&#x6C34;&#x5E73;">recv&#x548C;send&#x5199;&#x7684;&#x5F88;&#x6709;&#x6C34;&#x5E73;</a></li>
<li><a href="#&#x53D1;&#x9001;&#x63A5;&#x6536;&#x603B;&#x7ED3;">&#x53D1;&#x9001;&#x63A5;&#x6536;&#x603B;&#x7ED3;</a></li>
<li><a href="#option&#x51FD;&#x6570;&#x5C31;&#x662F;&#x5B57;&#x7B26;&#x4E32;&#x7248;&#x672C;&#x7684;ioctl">option&#x51FD;&#x6570;&#x5C31;&#x662F;&#x5B57;&#x7B26;&#x4E32;&#x7248;&#x672C;&#x7684;ioctl</a></li>
<li><a href="#header&#x548C;&#x540C;&#x6B65;&#x534F;&#x8BAE;&#x63E1;&#x624B;">header&#x548C;&#x540C;&#x6B65;&#x534F;&#x8BAE;&#x63E1;&#x624B;</a></li>
<li><a href="#&#x540E;&#x53F0;&#x63E1;&#x624B;&#x63A5;&#x53E3;">&#x540E;&#x53F0;&#x63E1;&#x624B;&#x63A5;&#x53E3;</a></li>
</ul>
</li>
<li><a href="#transporttcptcpgo">transport/tcp/tcp.go</a><ul>
<li><a href="#newdialer&#x548C;newlistener">NewDialer&#x548C;NewListener</a></li>
<li><a href="#dialer">dialer</a></li>
<li><a href="#listener">listener</a></li>
<li><a href="#adress&#x548C;close">adress&#x548C;close</a></li>
<li><a href="#set&#x548C;get-option">Set&#x548C;Get Option</a></li>
<li><a href="#&#x603B;&#x7ED3;-1">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#transport&#x5C0F;&#x8282;">transport&#x5C0F;&#x8282;</a></li>
<li><a href="#transportinprocinprocgo">transport/inproc/inproc.go</a><ul>
<li><a href="#&#x5168;&#x5C40;listener&#x8868;">&#x5168;&#x5C40;listener&#x8868;</a></li>
<li><a href="#listen">Listen</a></li>
<li><a href="#accept">Accept</a></li>
<li><a href="#dial">Dial</a></li>
<li><a href="#send&#x548C;recv">Send&#x548C;Recv</a></li>
<li><a href="#&#x603B;&#x7ED3;-2">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#transportipc">transport/ipc</a></li>
</ul>
</li>
<li><a href="#internalcore">internal/core</a><ul>
<li><a href="#internalcoresocketgo">internal/core/socket.go</a><ul>
<li><a href="#newdialer&#x548C;newlistener-1">NewDialer&#x548C;NewListener</a></li>
<li><a href="#socket&#x5177;&#x4F53;&#x5B9A;&#x4E49;">socket&#x5177;&#x4F53;&#x5B9A;&#x4E49;</a></li>
<li><a href="#&#x6838;&#x5FC3;&#x52A8;&#x4F5C;-addpipe">&#x6838;&#x5FC3;&#x52A8;&#x4F5C;: addPipe</a></li>
<li><a href="#send&#x548C;recv-1">send&#x548C;recv</a></li>
</ul>
</li>
<li><a href="#internalcorepipego">internal/core/pipe.go</a><ul>
<li><a href="#pipe&#x5B9A;&#x4E49;">pipe&#x5B9A;&#x4E49;</a></li>
<li><a href="#pipelist">pipeList</a></li>
<li><a href="#addpipe&#x548C;id&#x751F;&#x6210;">addPipe&#x548C;ID&#x751F;&#x6210;</a></li>
<li><a href="#pipe&#x7684;send&#x548C;recv">pipe&#x7684;send&#x548C;recv</a></li>
<li><a href="#&#x4E3A;&#x4EC0;&#x4E48;&#x5E95;&#x5C42;send&#x6216;&#x8005;recv&#x5931;&#x8D25;&#x8981;close&#x6389;pipe">&#x4E3A;&#x4EC0;&#x4E48;&#x5E95;&#x5C42;send&#x6216;&#x8005;recv&#x5931;&#x8D25;&#x8981;close&#x6389;pipe?</a></li>
<li><a href="#&#x643A;&#x5E26;&#x989D;&#x5916;&#x6570;&#x636E;&#x7684;&#x5178;&#x578B;&#x6A21;&#x5F0F;-setprivate">&#x643A;&#x5E26;&#x989D;&#x5916;&#x6570;&#x636E;&#x7684;&#x5178;&#x578B;&#x6A21;&#x5F0F;: SetPrivate</a></li>
</ul>
</li>
<li><a href="#internalcoredialergo">internal/core/dialer.go</a></li>
<li><a href="#internalcorelistenergo">internal/core/listener.go</a></li>
<li><a href="#&#x603B;&#x7ED3;-3">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#protocol">protocol</a><ul>
<li><a href="#protocolreqreqgo">protocol/req/req.go</a><ul>
<li><a href="#&#x6838;&#x5FC3;&#x7ED3;&#x6784;&#x4F53;&#x5B9A;&#x4E49;">&#x6838;&#x5FC3;&#x7ED3;&#x6784;&#x4F53;&#x5B9A;&#x4E49;</a></li>
<li><a href="#&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x6709;context">&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x6709;context?</a></li>
<li><a href="#req&#x7684;sendmsg">req&#x7684;SendMsg</a></li>
<li><a href="#&#x53D1;&#x9001;&#x5C0F;&#x8282;">&#x53D1;&#x9001;&#x5C0F;&#x8282;</a></li>
<li><a href="#newsocket">NewSocket</a></li>
<li><a href="#addpipe&#x65B9;&#x6CD5;">AddPipe&#x65B9;&#x6CD5;</a></li>
<li><a href="#recvmsg">RecvMsg</a></li>
<li><a href="#receiver&#x51FD;&#x6570;">receiver()&#x51FD;&#x6570;</a></li>
<li><a href="#&#x63A5;&#x6536;&#x5C0F;&#x7ED3;">&#x63A5;&#x6536;&#x5C0F;&#x7ED3;</a></li>
<li><a href="#req&#x5C0F;&#x7ED3;">REQ&#x5C0F;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#protocolreprepgo">protocol/rep/rep.go</a><ul>
<li><a href="#newsocket-1">NewSocket</a></li>
<li><a href="#addpipe">AddPipe</a></li>
<li><a href="#&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;sender">&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;sender</a></li>
<li><a href="#&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;receiver">&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;receiver</a></li>
<li><a href="#recvmsg-1">RecvMsg</a></li>
<li><a href="#sendmsg">SendMsg</a></li>
<li><a href="#rep&#x5C0F;&#x8282;">REP&#x5C0F;&#x8282;</a></li>
</ul>
</li>
<li><a href="#req-rep&#x7591;&#x95EE;">req rep&#x7591;&#x95EE;</a></li>
<li><a href="#xreq&#x548C;xrep">xreq&#x548C;xrep</a><ul>
<li><a href="#xreq">xreq</a></li>
<li><a href="#xrep">xrep</a></li>
</ul>
</li>
<li><a href="#&#x518D;&#x770B;&#x6838;&#x5FC3;&#x5C42;&#x7684;&#x6838;&#x5FC3;&#x4EF7;&#x503C;">&#x518D;&#x770B;&#x6838;&#x5FC3;&#x5C42;&#x7684;&#x6838;&#x5FC3;&#x4EF7;&#x503C;</a><ul>
<li><a href="#&#x603B;&#x7ED3;-4">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="&#x5E93;&#x5730;&#x5740;"><a name="&#x5E93;&#x5730;&#x5740;" class="anchor-navigation-ex-anchor" href="#&#x5E93;&#x5730;&#x5740;"><i class="fa fa-link" aria-hidden="true"></i></a>1. &#x5E93;&#x5730;&#x5740;</h1>
<p><a href="https://github.com/nanomsg/mangos.git" target="_blank">https://github.com/nanomsg/mangos.git</a>
mangos&#x662F;nanomsg&#x7684;&#x7EAF;go&#x7248;&#x672C;&#x5B9E;&#x73B0;.</p>
<blockquote>
<p>Mangos&#x2122; is an implementation in pure Go of the SP (&#x201C;Scalability Protocols&#x201D;) messaging system. These are colloquially known as a &#x201C;nanomsg&#x201D;.</p>
<p>The design is intended to make it easy to add new transports with almost trivial effort, as well as new topologies (&#x201C;protocols&#x201D; in SP parlance.)</p>
<p>At present, all of the Req/Rep, Pub/Sub, Pair, Bus, Push/Pull, and Surveyor/Respondent patterns are supported. This project also supports an experimental protocol called Star.</p>
</blockquote>
<h1 id="&#x4EE3;&#x7801;&#x8D70;&#x8BFB;"><a name="&#x4EE3;&#x7801;&#x8D70;&#x8BFB;" class="anchor-navigation-ex-anchor" href="#&#x4EE3;&#x7801;&#x8D70;&#x8BFB;"><i class="fa fa-link" aria-hidden="true"></i></a>2. &#x4EE3;&#x7801;&#x8D70;&#x8BFB;</h1>
<p>mangos&#x7684;&#x9876;&#x5C42;go&#x6587;&#x4EF6;, &#x662F;&#x5178;&#x578B;&#x7684;&#x62BD;&#x8C61;&#x5B9A;&#x4E49;&#x6A21;&#x5F0F;: &#x5148;&#x5728;&#x9876;&#x5C42;&#x5B9A;&#x4E49;&#x597D;&#x62BD;&#x8C61;, &#x5B50;&#x6587;&#x4EF6;&#x5939;&#x7BA1;&#x5B9E;&#x73B0;. &#x8FD9;&#x662F;&#x81EA;&#x9876;&#x5411;&#x4E0B;&#x7684;&#x8BBE;&#x8BA1;&#x65B9;&#x6CD5;.</p>
<h2 id="&#x63A5;&#x53E3;&#x62BD;&#x8C61;"><a name="&#x63A5;&#x53E3;&#x62BD;&#x8C61;" class="anchor-navigation-ex-anchor" href="#&#x63A5;&#x53E3;&#x62BD;&#x8C61;"><i class="fa fa-link" aria-hidden="true"></i></a>2.1. &#x63A5;&#x53E3;&#x62BD;&#x8C61;</h2>
<h3 id="socketgo"><a name="socketgo" class="anchor-navigation-ex-anchor" href="#socketgo"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.1. socket.go</h3>
<p>socket.go&#x63D0;&#x4F9B;&#x4E86;socket&#x7684;&#x62BD;&#x8C61;. &#x8FD9;&#x91CC;&#x7684;socket&#x662F;zeroMQ&#x7684;socket&#x6982;&#x5FF5;, &#x662F;&#x5BF9;&#x66F4;&#x5E95;&#x5C42;&quot;socket&quot;&#x7684;&#x573A;&#x666F;&#x5316;&#x62BD;&#x8C61;.
socket&#x662F;&#x5E94;&#x7528;&#x4FA7;&#x8BBF;&#x95EE;&#x8FD9;&#x4E2A;SP system&#x7684;&#x63A5;&#x53E3;.
socket.go&#x662F;&#x5BF9;<code>internal/core/socket.go</code>&#x7684;&#x5BF9;&#x5916;&#x5448;&#x73B0;, core&#x7684;socket.go&#x662F;&#x5B9E;&#x73B0;&#x8005;.</p>
<h4 id="socket"><a name="socket" class="anchor-navigation-ex-anchor" href="#socket"><i class="fa fa-link" aria-hidden="true"></i></a>socket</h4>
<p>&#x63A5;&#x53E3;&#x8BBE;&#x8BA1;&#x7684;&#x5F88;&#x7B80;&#x6D01;, &#x7B26;&#x5408;zeroMQ&#x7C7B;&#x4F3C;&#x7684;&#x62BD;&#x8C61;.</p>
<pre><code class="lang-go">// Socket is the main access handle applications use to access the SP
// system.  It is an abstraction of an application&apos;s &quot;connection&quot; to a
// messaging topology.  Applications can have more than one Socket open
// at a time.
type Socket interface {
    // Info returns information about the protocol (numbers and names)
    // and peer protocol.
    Info() ProtocolInfo

    // Close closes the open Socket.  Further operations on the socket
    // will return ErrClosed.
    Close() error

    // Send puts the message on the outbound send queue.  It blocks
    // until the message can be queued, or the send deadline expires.
    // If a queued message is later dropped for any reason,
    // there will be no notification back to the application.
    Send([]byte) error

    // Recv receives a complete message.  The entire message is received.
    Recv() ([]byte, error)

    // SendMsg puts the message on the outbound send.  It works like Send,
    // but allows the caller to supply message headers.  AGAIN, the Socket
    // ASSUMES OWNERSHIP OF THE MESSAGE.
    SendMsg(*Message) error

    // RecvMsg receives a complete message, including the message header,
    // which is useful for protocols in raw mode.
    RecvMsg() (*Message, error)

    // Dial connects a remote endpoint to the Socket.  The function
    // returns immediately, and an asynchronous goroutine is started to
    // establish and maintain the connection, reconnecting as needed.
    // If the address is invalid, then an error is returned.
    Dial(addr string) error

    DialOptions(addr string, options map[string]interface{}) error

    // NewDialer returns a Dialer object which can be used to get
    // access to the underlying configuration for dialing.
    NewDialer(addr string, options map[string]interface{}) (Dialer, error)

    // Listen connects a local endpoint to the Socket.  Remote peers
    // may connect (e.g. with Dial) and will each be &quot;connected&quot; to
    // the Socket.  The accepter logic is run in a separate goroutine.
    // The only error possible is if the address is invalid.
    Listen(addr string) error

    ListenOptions(addr string, options map[string]interface{}) error

    NewListener(addr string, options map[string]interface{}) (Listener, error)

    // GetOption is used to retrieve an option for a socket.
    GetOption(name string) (interface{}, error)

    // SetOption is used to set an option for a socket.
    SetOption(name string, value interface{}) error

    // OpenContext creates a new Context.  If a protocol does not
    // support separate contexts, this will return an error.
    OpenContext() (Context, error)

    // SetPipeEventHook sets a PipeEventHook function to be called when a
    // Pipe is added or removed from this socket (connect/disconnect).
    // The previous hook is returned (nil if none.)  (Only one hook can
    // be used at a time.)
    SetPipeEventHook(PipeEventHook) PipeEventHook
}
</code></pre>
<ul>
<li>Send&#x548C;Recv&#x662F;&#x4E0D;&#x5E26;header&#x7684;, &#x800C;SendMsg&#x548C;RecvMsg&#x5E26;header; &#x53D1;&#x9001;&#x90FD;&#x662F;&#x53D1;&#x5F80;outbound Q. Q&#x6EE1;&#x4E86;&#x4F1A;&#x963B;&#x585E;</li>
<li>Dial&#x8868;&#x8FBE;&#x7684;&#x662F;connect, Listen&#x662F;bind</li>
<li>GetOption&#x548C;SetOption&#x7528;&#x6765;&#x8BBE;&#x7F6E;&#x5E95;&#x5C42;socket</li>
</ul>
<h4 id="context"><a name="context" class="anchor-navigation-ex-anchor" href="#context"><i class="fa fa-link" aria-hidden="true"></i></a>context</h4>
<p>&#x6BCF;&#x4E2A;protocol&#x90FD;&#x6709;&#x4E2A;&#x9ED8;&#x8BA4;&#x7684;context. &#x53EA;&#x6709;&#x90E8;&#x5206;protocol&#x5141;&#x8BB8;&#x81EA;&#x5EFA;context
context&#x7684;&#x62BD;&#x8C61;&#x548C;socket&#x4E00;&#x6837;? &#x53EA;&#x662F;socket&#x7684;&#x5B50;&#x96C6;? -- context&#x662F;&#x5EFA;&#x7ACB;&#x5728;socket&#x4E4B;&#x4E0A;&#x7684;, &#x987E;&#x540D;&#x601D;&#x4E49;, &#x662F;&#x5E26;&#x4E0A;&#x4E0B;&#x6587;&#x7684;socket.</p>
<pre><code class="lang-go">// Context is a protocol context, and represents the upper side operations
// that applications will want to use.  Every socket has a default context,
// but only a certain protocols will allow the creation of additional
// Context instances (only if separate stateful contexts make sense for
// a given protocol).
type Context interface {

    // Close closes the open Socket.  Further operations on the socket
    // will return ErrClosed.
    Close() error

    // GetOption is used to retrieve an option for a socket.
    GetOption(name string) (interface{}, error)

    // SetOption is used to set an option for a socket.
    SetOption(name string, value interface{}) error

    // Send puts the message on the outbound send queue.  It blocks
    // until the message can be queued, or the send deadline expires.
    // If a queued message is later dropped for any reason,
    // there will be no notification back to the application.
    Send([]byte) error

    // Recv receives a complete message.  The entire message is received.
    Recv() ([]byte, error)

    // SendMsg puts the message on the outbound send.  It works like Send,
    // but allows the caller to supply message headers.  AGAIN, the Socket
    // ASSUMES OWNERSHIP OF THE MESSAGE.
    SendMsg(*Message) error

    // RecvMsg receives a complete message, including the message header,
    // which is useful for protocols in raw mode.
    RecvMsg() (*Message, error)
}
</code></pre>
<h3 id="optionsgo"><a name="optionsgo" class="anchor-navigation-ex-anchor" href="#optionsgo"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.2. options.go</h3>
<p>&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x7684;option, &#x90FD;&#x5728;&#x8FD9;&#x91CC;&#x5B9A;&#x4E49;, &#x6CE8;&#x91CA;&#x5199;&#x7684;&#x975E;&#x5E38;&#x786E;&#x5207;.
options&#x5927;&#x5927;&#x5C0F;&#x5C0F;&#x5305;&#x62EC;&#x5F88;&#x591A;, &#x6BD4;&#x5982;raw mode, &#x6BD4;&#x5982;&#x8D85;&#x65F6;&#x65F6;&#x95F4;, Q&#x7684;size
&#x4E3E;&#x51E0;&#x4E2A;&#x4F8B;&#x5B50;:</p>
<pre><code class="lang-go">const (
    // OptionRaw is used to test if the socket in RAW mod.  The details of
    // how this varies from normal mode vary from protocol to protocol,
    // but RAW mode is generally minimal protocol processing, and
    // stateless.  RAW mode sockets are constructed with different
    // protocol constructor.  Raw mode is generally used with Device()
    // or similar proxy configurations.
    OptionRaw = &quot;RAW&quot;

    // OptionRecvDeadline is the time until the next Recv times out.  The
    // value is a time.Duration.  Zero value may be passed to indicate that
    // no timeout should be applied.  A negative value indicates a
    // non-blocking operation.  By default there is no timeout.
    OptionRecvDeadline = &quot;RECV-DEADLINE&quot; //&#x9ED8;&#x8BA4;&#x4E0D;&#x8D85;&#x65F6;, &#x6C38;&#x8FDC;&#x7B49;

    // OptionRetryTime is used by REQ.  The argument is a time.Duration.
    // When a request has not been replied to within the given duration,
    // the request will automatically be resent to an available peer.
    // This value should be longer than the maximum possible processing
    // and transport time.  The value zero indicates that no automatic
    // retries should be sent.  The default value is one minute.
    //
    // Note that changing this option is only guaranteed to affect requests
    // sent after the option is set.  Changing the value while a request
    // is outstanding may not have the desired effect.
    OptionRetryTime = &quot;RETRY-TIME&quot; //&#x9ED8;&#x8BA4;&#x4E00;&#x5206;&#x949F;

    // OptionSubscribe is used by SUB/XSUB.  The argument is a []byte.
    // The application will receive messages that start with this prefix.
    // Multiple subscriptions may be in effect on a given socket.  The
    // application will not receive messages that do not match any current
    // subscriptions.  (If there are no subscriptions for a SUB/XSUB
    // socket, then the application will not receive any messages.  An
    // empty prefix can be used to subscribe to all messages.)
    OptionSubscribe = &quot;SUBSCRIBE&quot; //subscribe&#x901A;&#x8FC7;option&#x6765;&#x64CD;&#x4F5C;

    // OptionWriteQLen is used to set the size, in messages, of the write
    // queue channel. By default, it&apos;s 128. This option cannot be set if
    // Dial or Listen has been called on the socket.
    OptionWriteQLen = &quot;WRITEQ-LEN&quot; //&#x53D1;&#x9001;q&#x7684;&#x5927;&#x5C0F;, &#x9ED8;&#x8BA4;128&#x4E2A;message

    // OptionLinger is used to set the linger property.  This is the amount
    // of time to wait for send queues to drain when Close() is called.
    // Close() may block for up to this long if there is unsent data, but
    // will return as soon as all data is delivered to the transport.
    // Value is a time.Duration.  Default is one second.
    OptionLinger = &quot;LINGER&quot; // close&#x9ED8;&#x8BA4;&#x7B49;&#x5F85;1&#x79D2;, &#x597D;&#x8BA9;&#x8FD8;&#x6CA1;&#x53D1;&#x9001;&#x51FA;&#x53BB;&#x7684;msg&#x53D1;&#x51FA;&#x53BB;.

    // OptionMaxRecvSize supplies the maximum receive size for inbound
    // messages.  This option exists because the wire protocol allows
    // the sender to specify the size of the incoming message, and
    // if the size were overly large, a bad remote actor could perform a
    // remote Denial-Of-Service by requesting ridiculously  large message
    // sizes and then stalling on send.  The default value is 1MB.
    //
    // A value of 0 removes the limit, but should not be used unless
    // absolutely sure that the peer is trustworthy.
    //
    // Not all transports honor this limit.  For example, this limit
    // makes no sense when used with inproc.
    //
    // Note that the size includes any Protocol specific header.  It is
    // better to pick a value that is a little too big, than too small.
    //
    // This option is only intended to prevent gross abuse  of the system,
    // and not a substitute for proper application message verification.
    //
    // This option is type int64.
    OptionMaxRecvSize = &quot;MAX-RCV-SIZE&quot; //&#x8FD9;&#x4E2A;&#x5389;&#x5BB3;&#x4E86;, DDOS, &#x9ED8;&#x8BA4;&#x6700;&#x5927;&#x6536;1MB, &#x9632;&#x6B62;&#x5BF9;&#x7AEF;&#x9971;&#x548C;&#x653B;&#x51FB;.

    // OptionReconnectTime is the initial interval used for connection
    // attempts.  If a connection attempt does not succeed, then ths socket
    // will wait this long before trying again.  An optional exponential
    // backoff may cause this value to grow.  See OptionMaxReconnectTime
    // for more details.   This is a time.Duration whose default value is
    // 100msec.  This option must be set before starting any dialers.
    OptionReconnectTime = &quot;RECONNECT-TIME&quot; //&#x91CD;&#x8FDE;&#x95F4;&#x9694;, &#x9ED8;&#x8BA4;100ms

    // OptionBestEffort enables non-blocking send operations on the
    // socket. Normally (for some socket types), a socket will block if
    // there are no receivers, or the receivers are unable to keep up
    // with the sender. (Multicast sockets types like Bus or Star do not
    // behave this way.)  If this option is set, instead of blocking, the
    // message will be silently discarded.  The value is a boolean, and
    // defaults to False.
    OptionBestEffort = &quot;BEST-EFFORT&quot; //&#x8FD9;&#x4E2A;&#x5389;&#x5BB3;&#x4E86;, &#x6709;&#x8FD9;&#x4E2A;&#x6807;&#x8BB0;&#x7684;socket, &#x5982;&#x679C;&#x9047;&#x5230;&#x53D1;&#x9001;&#x65F6;&#x5BF9;&#x7AEF;&#x6CA1;&#x51C6;&#x5907;&#x597D;&#x7B49;&#x60C5;&#x51B5;, &#x76F4;&#x63A5;&#x4E22;&#x5F03;msg

    // OptionLocalAddr expresses a local address.  For dialers, this is
    // the (often random) address that was locally bound.  For listeners,
    // it is usually the service address.  The value is a net.Addr.  This
    // is generally a read-only value for pipes, though it might sometimes
    // be available on dialers or listeners.
    OptionLocalAddr = &quot;LOCAL-ADDR&quot; //&#x83B7;&#x53D6;&#x672C;&#x5730;&#x5730;&#x5740;

    // OptionRemoteAddr expresses a remote address.  For dialers, this is
    // the service address.  For listeners, its the address of the far
    // end dialer.  The value is a net.Addr.  It is generally read-only
    // and available only on pipes and dialers.
    OptionRemoteAddr = &quot;REMOTE-ADDR&quot; //&#x83B7;&#x53D6;&#x5BF9;&#x7AEF;&#x5730;&#x5740;, &#x5BF9;pipe&#x548C;dialer&#x6709;&#x6548;.

    &#x7B49;&#x7B49;
</code></pre>
<h3 id="pipego"><a name="pipego" class="anchor-navigation-ex-anchor" href="#pipego"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.3. pipe.go</h3>
<p>pipe&#x4F3C;&#x4E4E;&#x5F88;&#x91CD;&#x8981;, &#x4F46;&#x63A5;&#x53E3;&#x5B9A;&#x4E49;&#x5F88;&#x7B80;&#x5355;:</p>
<pre><code class="lang-go">// Pipe represents the high level interface to a low level communications
// channel.  There is one of these associated with a given TCP connection,
// for example.  This interface is intended for application use.
//
// Note that applications cannot send or receive data on a Pipe directly.
type Pipe interface {

    // ID returns the numeric ID for this Pipe.  This will be a
    // 31 bit (bit 32 is clear) value for the Pipe, which is unique
    // across all other Pipe instances in the application, while
    // this Pipe exists.  (IDs are recycled on Close, but only after
    // all other Pipe values are used.)
    ID() uint32

    // Address returns the address (URL form) associated with the Pipe.
    // This matches the string passed to Dial() or Listen().
    Address() string

    // GetOption returns an arbitrary option.  The details will vary
    // for different transport types.
    GetOption(name string) (interface{}, error)

    // Listener returns the Listener for this Pipe, or nil if none.
    Listener() Listener

    // Dialer returns the Dialer for this Pipe, or nil if none.
    Dialer() Dialer

    // Close closes the Pipe.  This does a disconnect, or something similar.
    // Note that if a dialer is present and active, it will redial.
    Close() error
}
</code></pre>
<h3 id="messagego"><a name="messagego" class="anchor-navigation-ex-anchor" href="#messagego"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.4. message.go</h3>
<p>message&#x662F;&#x5BF9;&#x6570;&#x636E;&#x7684;&#x627F;&#x8F7D;&#x8F7D;&#x4F53;, &#x5305;&#x62EC;header
&#x5BF9;mesage&#x7684;&#x5206;&#x5305;&#x56E0;protocol&#x800C;&#x5F02;.
&#x8FD9;&#x91CC;&#x7684;message&#x4E0D;&#x5305;&#x62EC;&#x6BD4;&#x5982;tcp/ip&#x5934;. &#x5BF9;transport&#x6765;&#x8BF4;, &#x8FD9;&#x4E2A;message&#x5C31;&#x662F;&#x4E2A;&#x5927;&#x7684;payload.</p>
<pre><code class="lang-go">// Message encapsulates the messages that we exchange back and forth.  The
// meaning of the Header and Body fields, and where the splits occur, will
// vary depending on the protocol.  Note however that any headers applied by
// transport layers (including TCP/ethernet headers, and SP protocol
// independent length headers), are *not* included in the Header.
type Message struct {
    // Header carries any protocol (SP) specific header.  Applications
    // should not modify or use this unless they are using Raw mode.
    // No user data may be placed here.
    Header []byte

    // Body carries the body of the message.  This can also be thought
    // of as the message &quot;payload&quot;.
    Body []byte

    // Pipe may be set on message receipt, to indicate the Pipe from
    // which the Message was received.  There are no guarantees that the
    // Pipe is still active, and applications should only use this for
    // informational purposes.
    Pipe Pipe //&#x8FD9;&#x4E2A;&#x6709;&#x70B9;&#x50CF;channel in channel&#x7684;&#x610F;&#x601D;.

    bbuf   []byte
    hbuf   []byte
    bsize  int
    refcnt int32
}
</code></pre>
<h4 id="message-pool"><a name="message-pool" class="anchor-navigation-ex-anchor" href="#message-pool"><i class="fa fa-link" aria-hidden="true"></i></a>message pool</h4>
<p>&#x548C;&#x6807;&#x51C6;&#x5E93;fmt&#x5305;&#x4E00;&#x6837;, msg&#x4E5F;&#x7528;&#x4E86;pool&#x6A21;&#x5F0F;, &#x6309;&#x7167;msg&#x7684;size&#x8FDB;&#x884C;&#x4E86;&#x5206;&#x5757;.
&#x8FD9;&#x6837;&#x505A;&#x662F;&#x4E3A;&#x4E86;&#x51CF;&#x5C0F;GC&#x7684;&#x538B;&#x529B;.</p>
<pre><code class="lang-go">type msgCacheInfo struct {
    maxbody int
    pool    *sync.Pool
}

func newMsg(sz int) *Message {
    m := &amp;Message{}
    m.bbuf = make([]byte, 0, sz) //&#x5B9E;&#x9645;&#x7684;size&#x5168;&#x90E8;&#x5728;body&#x4E2D;&#x5206;&#x914D;
    m.hbuf = make([]byte, 0, 32) //&#x8FD9;&#x91CC;&#x5F88;&#x6E05;&#x695A;, &#x9ED8;&#x8BA4;&#x7684;header&#x5927;&#x5C0F;&#x4E3A;32&#x5B57;&#x8282;
    m.bsize = sz
    return m
}

// We can tweak these!
var messageCache = []msgCacheInfo{
    {
        maxbody: 64,
        pool: &amp;sync.Pool{
            New: func() interface{} { return newMsg(64) },
        },
    }, {
        maxbody: 128,
        pool: &amp;sync.Pool{
            New: func() interface{} { return newMsg(128) },
        },
    }, {
    ...
    &#x4E00;&#x76F4;&#x7FFB;&#x500D;&#x5230;65536
</code></pre>
<p>&#x8865;&#x5145;: sync.Pool&#x53EF;&#x4EE5;&#x4F20;&#x5165;&#x4E00;&#x4E2A;New&#x51FD;&#x6570;, &#x5728;pool&#x91CC;&#x9762;&#x6CA1;&#x6709;&#x5BF9;&#x8C61;&#x7684;&#x65F6;&#x5019;, &#x9ED8;&#x8BA4;new&#x4E00;&#x4E2A;.
&#x6709;&#x4E86;&#x8FD9;&#x4E2A;Pool, &#x53EF;&#x4EE5;&#x624B;&#x52A8;free msg, &#x8FDB;&#x4E00;&#x6B65;&#x51CF;&#x8F7B;gc&#x538B;&#x529B;.</p>
<pre><code class="lang-go">// Free releases the message to the pool from which it was allocated.
// While this is not strictly necessary thanks to GC, doing so allows
// for the resources to be recycled without engaging GC.  This can have
// rather substantial benefits for performance.
func (m *Message) Free() {
    if m != nil {
        if atomic.AddInt32(&amp;m.refcnt, -1) == 0 {
            for i := range messageCache {
                if m.bsize == messageCache[i].maxbody {
                    messageCache[i].pool.Put(m) //free&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x8FD4;&#x8FD8;&#x5230;pool
                    return
                }
            }
        }
    }
}
</code></pre>
<h4 id="msg&#x5BF9;&#x8C61;&#x7684;buffer&#x7BA1;&#x7406;"><a name="msg&#x5BF9;&#x8C61;&#x7684;buffer&#x7BA1;&#x7406;" class="anchor-navigation-ex-anchor" href="#msg&#x5BF9;&#x8C61;&#x7684;buffer&#x7BA1;&#x7406;"><i class="fa fa-link" aria-hidden="true"></i></a>msg&#x5BF9;&#x8C61;&#x7684;buffer&#x7BA1;&#x7406;</h4>
<p>msg&#x5BF9;&#x8C61;&#x6709;&#x5982;&#x4E0B;&#x65B9;&#x6CD5;:</p>
<ul>
<li>&#x4E0A;&#x9762;&#x8BF4;&#x7684;Free()</li>
<li>Clone() &#x53EA;&#x662F;&#x628A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x52A0;&#x4E00;, &#x8868;&#x793A;&#x8FD9;&#x4E2A;msg&#x662F;&#x5171;&#x4EAB;&#x7684;. &#x8C03;&#x7528;Clone()&#x7684;&#x4EBA;&#x4E0D;&#x8981;&#x4FEE;&#x6539;msg, &#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;msg&#x8FD8;&#x662F;&#x522B;&#x4EBA;&#x7684;.</li>
<li>Dup() &#x6DF1;&#x62F7;&#x8D1D;&#x8FD9;&#x4E2A;msg, &#x53EF;&#x4EE5;&#x4FEE;&#x6539;.</li>
<li>MakeUnique() &#x4E00;&#x822C;&#x7528;<code>m = m.MakeUnique()</code>&#x6765;&#x4FDD;&#x8BC1;&#x8FD9;&#x4E2A;msg&#x662F;&#x81EA;&#x5DF1;&#x72EC;&#x4EAB;&#x7684;: &#x5982;&#x679C;msg&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E3A;1, &#x8FD4;&#x56DE;msg&#x672C;&#x8EAB;; &#x5426;&#x5219;Dup()&#x4E00;&#x4EFD;, &#x5220;&#x6389;&#x539F;msg, &#x8FD4;&#x56DE;Dup&#x7684;, &#x5373;MakeUnique()&#x540E;, &#x539F;msg&#x4E5F;&#x4E0D;&#x80FD;&#x4F7F;&#x7528;&#x4E86;.</li>
</ul>
<p>&#x6700;&#x540E;&#x662F;NewMessage()&#x51FD;&#x6570;: &#x4ECE;pool&#x4E2D;new&#x4E00;&#x4E2A;msg</p>
<pre><code class="lang-go">// NewMessage is the supported way to obtain a new Message.  This makes
// use of a &quot;cache&quot; which greatly reduces the load on the garbage collector.
func NewMessage(sz int) *Message {
    var m *Message
    for i := range messageCache {
        if sz &lt; messageCache[i].maxbody {
            m = messageCache[i].pool.Get().(*Message)
            break
        }
    }
    if m == nil {
        m = newMsg(sz)
    }

    m.Body = m.bbuf //Body&#x5C31;&#x662F;bbuf
    m.Header = m.hbuf //Header&#x5C31;&#x662F;hbuf
    atomic.StoreInt32(&amp;m.refcnt, 1)
    return m
}
</code></pre>
<h3 id="protocolgo"><a name="protocolgo" class="anchor-navigation-ex-anchor" href="#protocolgo"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.5. protocol.go</h3>
<p>protocol&#x5C31;&#x662F;&#x573A;&#x666F;&#x5316;&#x7684;&#x5957;&#x8DEF;&#x7C7B;&#x578B;: &#x6BD4;&#x5982;Req/Rep Pub/Sub</p>
<pre><code class="lang-go">// Useful constants for protocol numbers.  Note that the major protocol number
// is stored in the upper 12 bits, and the minor (subprotocol) is located in
// the bottom 4 bits.
const (
    ProtoPair       = (1 * 16)
    ProtoPub        = (2 * 16)
    ProtoSub        = (2 * 16) + 1
    ProtoReq        = (3 * 16)
    ProtoRep        = (3 * 16) + 1
    ProtoPush       = (5 * 16)
    ProtoPull       = (5 * 16) + 1
    ProtoSurveyor   = (6 * 16) + 2
    ProtoRespondent = (6 * 16) + 3
    ProtoBus        = (7 * 16)
    ProtoStar       = (100 * 16) // Experimental!
)
</code></pre>
<p>protocol&#x5C31;&#x662F;&#x4E0B;&#x9762;&#x7684;&#x63A5;&#x53E3;:</p>
<pre><code class="lang-go">// ProtocolPipe represents the handle that a Protocol implementation has
// to the underlying stream transport.  It can be thought of as one side
// of a TCP, IPC, or other type of connection.
type ProtocolPipe interface {
    // ID returns a unique 31-bit value associated with this.
    // The value is unique for a given socket, at a given time.
    ID() uint32

    // Close does what you think.
    Close() error

    // SendMsg sends a message.  On success it returns nil. This is a
    // blocking call.
    SendMsg(*Message) error

    // RecvMsg receives a message.  It blocks until the message is
    // received.  On error, the pipe is closed and nil is returned.
    RecvMsg() *Message

    // SetPrivate is used to set protocol private data.
    SetPrivate(interface{})

    // GetPrivate returns the previously stored protocol private data.
    GetPrivate() interface{}
}
</code></pre>
<p>context&#x5C31;&#x662F;protocol+&#x4F7F;&#x7528;&#x4E0A;&#x4E0B;&#x6587;; &#x6240;&#x6709;context&#x90FD;&#x662F;stateful&#x7684;.
&#x5947;&#x602A;&#x7684;&#x662F;<code>RecvMsg() (*Message, error)</code>&#x7684;&#x7B7E;&#x540D;, &#x53EA;&#x6709;&#x5B83;&#x548C;protocol&#x957F;&#x5F97;&#x4E0D;&#x4E00;&#x6837;</p>
<pre><code class="lang-go">// ProtocolContext is a &quot;context&quot; for a protocol, which contains the
// various stateful operations such as timers, etc. necessary for
// running the protocol.  This is separable from the protocol itself
// as the protocol may permit the creation of multiple contexts.
type ProtocolContext interface {
    // Close closes the context.
    Close() error

    // SendMsg sends the message.  The message may be queued, or
    // may be delivered immediately, depending on the nature of
    // the protocol.  On success, the context assumes ownership
    // of the message.  On error, the caller retains ownership,
    // and may either resend the message or dispose of it otherwise.
    SendMsg(*Message) error

    // RecvMsg receives a complete message, including the message header,
    // which is useful for protocols in raw mode.
    RecvMsg() (*Message, error)

    // GetOption is used to retrieve the current value of an option.
    // If the protocol doesn&apos;t recognize the option, EBadOption should
    // be returned.
    GetOption(string) (interface{}, error)

    // SetOption is used to set an option.  EBadOption is returned if
    // the option name is not recognized, EBadValue if the value is
    // invalid.
    SetOption(string, interface{}) error
}
</code></pre>
<p>ProtocolBase&#x533F;&#x540D;&#x5305;&#x542B;&#x4E86;ProtocolContext</p>
<pre><code class="lang-go">// ProtocolBase provides the protocol-specific handling for sockets.
// This is the new style API for sockets, and is how protocols provide
// their specific handling.
type ProtocolBase interface {
    ProtocolContext

    // Info returns the information describing this protocol.
    Info() ProtocolInfo

    // XXX: Revisit these when we can use Pipe natively.

    // AddPipe is called when a new Pipe is added to the socket.
    // Typically this is as a result of connect or accept completing.
    // The pipe ID will be unique for the socket at this time.
    // The implementation must not call back into the socket, but it
    // may reject the pipe by returning a non-nil result.
    AddPipe(ProtocolPipe) error

    // RemovePipe is called when a Pipe is removed from the socket.
    // Typically this indicates a disconnected or closed connection.
    // This is called exactly once, after the underlying transport pipe
    // is closed.  The Pipe ID will still be valid.
    RemovePipe(ProtocolPipe)

    // OpenContext is a request to create a unique instance of the
    // protocol state machine, allowing concurrent use of states on
    // a given protocol socket.  Protocols that don&apos;t support this
    // should return ErrProtoOp.
    OpenContext() (ProtocolContext, error)
}
</code></pre>
<p>ProtocolInfo&#x5B9A;&#x4E49;:</p>
<pre><code class="lang-go">// ProtocolInfo is a description of the protocol.
type ProtocolInfo struct {
    Self     uint16
    Peer     uint16
    SelfName string
    PeerName string
}
</code></pre>
<h4 id="&#x79BB;&#x7528;&#x6237;&#x6700;&#x8FD1;&#x7684;newsocket"><a name="&#x79BB;&#x7528;&#x6237;&#x6700;&#x8FD1;&#x7684;newsocket" class="anchor-navigation-ex-anchor" href="#&#x79BB;&#x7528;&#x6237;&#x6700;&#x8FD1;&#x7684;newsocket"><i class="fa fa-link" aria-hidden="true"></i></a>&#x79BB;&#x7528;&#x6237;&#x6700;&#x8FD1;&#x7684;NewSocket</h4>
<p>&#x7528;&#x6237;&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019;, &#x4E00;&#x822C;&#x4F1A;&#x8C03;&#x7528;NewSocket, &#x8FD9;&#x4E2A;API&#x5C31;&#x662F;&#x5BF9;&#x4E0B;&#x9762;protocol&#x7684;MakeSocket&#x7684;&#x8C03;&#x7528;.</p>
<pre><code class="lang-go">// MakeSocket creates a Socket on top of a Protocol.
func MakeSocket(proto Protocol) Socket {
    return core.MakeSocket(proto)
}
</code></pre>
<p>&#x6838;&#x5FC3;&#x5C42;&#x7684;&#x5B9E;&#x73B0;&#x5982;&#x4E0B;</p>
<pre><code class="lang-go">func newSocket(proto mangos.ProtocolBase) *socket {
    s := &amp;socket{
        proto:         proto,
        reconnMinTime: defaultReconnMinTime,
        reconnMaxTime: defaultReconnMaxTime,
        maxRxSize:     defaultMaxRxSize,
    }
    return s
}

// MakeSocket is intended for use by Protocol implementations.  The intention
// is that they can wrap this to provide a &quot;proto.NewSocket()&quot; implementation.
func MakeSocket(proto mangos.ProtocolBase) mangos.Socket {
    return newSocket(proto)
}
</code></pre>
<h3 id="transportgo"><a name="transportgo" class="anchor-navigation-ex-anchor" href="#transportgo"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.6. transport.go</h3>
<p>&#x63D0;&#x4F9B;&#x7ED9;transport&#x7C7B;&#x578B;&#x5B9E;&#x73B0;&#x65B9;&#x4F7F;&#x7528;&#x7684;&#x7EDF;&#x4E00;&#x7684;transport&#x7684;&#x62BD;&#x8C61;. &#x8FD9;&#x662F;root&#x4E0B;&#x7684;tansport.go&#x6587;&#x4EF6;, transport&#x4E0B;&#x9762;&#x8FD8;&#x6709;&#x81EA;&#x5DF1;&#x7684;transport.go &#x8FD9;&#x4E24;&#x4E2A;&#x6587;&#x4EF6;&#x4EE5;&#x540E;&#x4F30;&#x8BA1;&#x4F1A;merge&#x5230;&#x4E00;&#x8D77;.</p>
<h4 id="tranpipe&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x8FDE;&#x63A5;conn"><a name="tranpipe&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x8FDE;&#x63A5;conn" class="anchor-navigation-ex-anchor" href="#tranpipe&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x8FDE;&#x63A5;conn"><i class="fa fa-link" aria-hidden="true"></i></a>TranPipe&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x8FDE;&#x63A5;conn</h4>
<p>&#x6CE8;&#x610F;, ransport&#x7684;&#x5B9E;&#x73B0;&#x65B9;&#x624D;&#x5173;&#x5FC3;pipe, &#x5E94;&#x7528;&#x4FA7;&#x4E0D;&#x8981;&#x7528;pipe.</p>
<pre><code class="lang-go">// TranPipe behaves like a full-duplex message-oriented connection between two
// peers.  Callers may call operations on a Pipe simultaneously from
// different goroutines.  (These are different from net.Conn because they
// provide message oriented semantics.)
//
// Pipe is only intended for use by transport implementors, and should
// not be directly used in applications.
type TranPipe interface {

    // Send sends a complete message.  In the event of a partial send,
    // the Pipe will be closed, and an error is returned.  For reasons
    // of efficiency, we allow the message to be sent in a scatter/gather
    // list.
    Send(*Message) error

    // Recv receives a complete message.  In the event that either a
    // complete message could not be received, an error is returned
    // to the caller and the Pipe is closed.
    //
    // To mitigate Denial-of-Service attacks, we limit the max message
    // size to 1M.
    Recv() (*Message, error)

    // Close closes the underlying transport.  Further operations on
    // the Pipe will result in errors.  Note that messages that are
    // queued in transport buffers may still be received by the remote
    // peer.
    Close() error

    // GetOption returns an arbitrary transport specific option on a
    // pipe.  Options for pipes are read-only and specific to that
    // particular connection. If the property doesn&apos;t exist, then
    // ErrBadOption should be returned.
    GetOption(string) (interface{}, error)
}
</code></pre>
<h4 id="transport&#x662F;newdialer&#x548C;newlistener&#x548C;&#x547D;&#x540D;&#x65B9;&#x5F0F;&#x7684;&#x7EC4;&#x5408;"><a name="transport&#x662F;newdialer&#x548C;newlistener&#x548C;&#x547D;&#x540D;&#x65B9;&#x5F0F;&#x7684;&#x7EC4;&#x5408;" class="anchor-navigation-ex-anchor" href="#transport&#x662F;newdialer&#x548C;newlistener&#x548C;&#x547D;&#x540D;&#x65B9;&#x5F0F;&#x7684;&#x7EC4;&#x5408;"><i class="fa fa-link" aria-hidden="true"></i></a>transport&#x662F;NewDialer&#x548C;NewListener&#x548C;&#x547D;&#x540D;&#x65B9;&#x5F0F;&#x7684;&#x7EC4;&#x5408;</h4>
<p>&#x4E0B;&#x9762;&#x4F1A;&#x770B;&#x5230;&#x5F88;&#x6E05;&#x695A;, &#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x65E8;&#x5728;&#x7EDF;&#x4E00;transport&#x7684;&#x62BD;&#x8C61;, &#x6211;&#x4EEC;&#x4ECE;&#x4E0A;&#x5230;&#x4E0B;&#x770B;:</p>
<pre><code class="lang-go">// Transport is the interface for transport suppliers to implement.
type Transport interface {
    // Scheme returns a string used as the prefix for SP &quot;addresses&quot;.
    // This is similar to a URI scheme.  For example, schemes can be
    // &quot;tcp&quot; (for &quot;tcp://xxx...&quot;), &quot;ipc&quot;, &quot;inproc&quot;, etc.
    Scheme() string

    // NewDialer creates a new Dialer for this Transport.
    NewDialer(url string, sock Socket) (TranDialer, error)

    // NewListener creates a new PipeListener for this Transport.
    // This generally also arranges for an OS-level file descriptor to be
    // opened, and bound to the the given address, as well as establishing
    // any &quot;listen&quot; backlog.
    NewListener(url string, sock Socket) (TranListener, error)
}
</code></pre>
<p>&#x4E00;&#x4E2A;transport&#x672C;&#x8D28;&#x8981;&#x63D0;&#x4F9B;</p>
<ul>
<li>&#x4E00;&#x4E2A;&#x547D;&#x540D;&#x89C4;&#x5219;: &#x6BD4;&#x5982;&quot;tcp://xxx...&quot;</li>
<li>&#x4E00;&#x4E2A;NewDialer&#x65B9;&#x6CD5;</li>
<li>&#x4E00;&#x4E2A;NewListener&#x65B9;&#x6CD5;</li>
</ul>
<h4 id="trandialer-tranlistener"><a name="trandialer-tranlistener" class="anchor-navigation-ex-anchor" href="#trandialer-tranlistener"><i class="fa fa-link" aria-hidden="true"></i></a>TranDialer TranListener</h4>
<p>TranDialer TranListener&#x90FD;&#x5206;&#x522B;&#x6709;&#x522B;&#x540D;Dialer&#x548C;Listener</p>
<pre><code class="lang-go">// TranDialer represents the client side of a connection.  Clients initiate
// the connection.
//
// TranDialer is only intended for use by transport implementors, and should
// not be directly used in applications.
type TranDialer interface {
    // Dial is used to initiate a connection to a remote peer.
    Dial() (TranPipe, error)

    // SetOption sets a local option on the dialer.
    // ErrBadOption can be returned for unrecognized options.
    // ErrBadValue can be returned for incorrect value types.
    SetOption(name string, value interface{}) error

    // GetOption gets a local option from the dialer.
    // ErrBadOption can be returned for unrecognized options.
    GetOption(name string) (value interface{}, err error)
}

// TranListener represents the server side of a connection.  Servers respond
// to a connection request from clients.
//
// TranListener is only intended for use by transport implementors, and should
// not be directly used in applications.
type TranListener interface {

    // Listen actually begins listening on the interface.  It is
    // called just prior to the Accept() routine normally. It is
    // the socket equivalent of bind()+listen().
    Listen() error

    // Accept completes the server side of a connection.  Once the
    // connection is established and initial handshaking is complete,
    // the resulting connection is returned to the client.
    Accept() (TranPipe, error)

    // Close ceases any listening activity, and will specifically close
    // any underlying file descriptor.  Once this is done, the only way
    // to resume listening is to create a new Server instance.  Presumably
    // this function is only called when the last reference to the server
    // is about to go away.  Established connections are unaffected.
    Close() error

    // SetOption sets a local option on the listener.
    // ErrBadOption can be returned for unrecognized options.
    // ErrBadValue can be returned for incorrect value types.
    SetOption(name string, value interface{}) error

    // GetOption gets a local option from the listener.
    // ErrBadOption can be returned for unrecognized options.
    GetOption(name string) (value interface{}, err error)

    // Address gets the local address.  The value may not be meaningful
    // until Listen() has been called.
    Address() string
}
</code></pre>
<p>&#x4EE5;&#x4E0A;&#x7684;&quot;&#x4E8C;&#x7EA7;&quot;&#x63A5;&#x53E3;&#x4F9D;&#x7136;&#x4E0D;&#x662F;&#x6700;&#x7EC8;&#x7684;&#x63A5;&#x53E3;, &#x6700;&#x7EC8;&#x7684;&#x63A5;&#x53E3;&#x662F;<code>TranPipe</code>, &#x5C31;&#x662F;&#x672C;&#x8282;&#x6700;&#x5F00;&#x5934;&#x7684;&#x63A5;&#x53E3;&#x5B9A;&#x4E49;.</p>
<h4 id="&#x603B;&#x7ED3;"><a name="&#x603B;&#x7ED3;" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x603B;&#x7ED3;</h4>
<p>&#x8FD9;&#x91CC;&#x5BF9;transport&#x7684;&#x62BD;&#x8C61;&#x662F;&quot;&#x5206;&#x7EA7;&quot;&#x7684;. &#x63A5;&#x53E3;&#x7684;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x63A5;&#x53E3;, &#x662F;&#x5BF9;&quot;&#x53E6;&#x4E00;&#x4EF6;&#x4E8B;&quot;&#x7684;&#x62BD;&#x8C61;.<br>&#x6BD4;&#x5982;<code>Transport</code>&#x7684;<code>NewDialer()</code>&#x65B9;&#x6CD5;, &#x8FD4;&#x56DE;<code>TranDialer</code>&#x62BD;&#x8C61;; &#x518D;&#x7531;&#x5176;&#x7684;<code>Dial()</code>&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;<code>TranPipe</code>&#x62BD;&#x8C61;, &#x540E;&#x8005;&#x624D;&#x6709;<code>Send(*Message) error</code>&#x548C;<code>Recv() (*Message, error)</code>&#x65B9;&#x6CD5;.</p>
<ul>
<li>&#x62BD;&#x8C61;&#x662F;&#x6709;&#x5C42;&#x6B21;&#x7684;, &#x62BD;&#x8C61;&#x8FD4;&#x56DE;&#x62BD;&#x8C61;.</li>
</ul>
<p>&#x5BF9;&#x6BD4;&#x6211;&#x6A21;&#x7CCA;&#x7684;&#x5BF9;transport&#x7684;&#x62BD;&#x8C61;&#x8BA4;&#x77E5;: transport&#x4F3C;&#x4E4E;&#x5E94;&#x8BE5;&#x662F;&#x5305;&#x62EC;&#x4E86;send recv&#x7B49;&#x591A;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x5355;&#x4E00;&#x63A5;&#x53E3;.<br>mangos&#x7684;&#x62BD;&#x8C61;&#x66F4;&#x6709;&#x5C42;&#x6B21;, &#x66F4;&#x6E05;&#x6670;.</p>
<h3 id="&#x9876;&#x5C42;listenergo&#x548C;dialergo"><a name="&#x9876;&#x5C42;listenergo&#x548C;dialergo" class="anchor-navigation-ex-anchor" href="#&#x9876;&#x5C42;listenergo&#x548C;dialergo"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.7. &#x9876;&#x5C42;listener.go&#x548C;dialer.go</h3>
<p>&#x548C;transport&#x7684;listener&#x548C;dialer&#x5B8C;&#x5168;&#x4E0D;&#x4E00;&#x6837;, &#x9876;&#x5C42;&#x7684;&#x5B9A;&#x4E49;&#x662F;&#x9762;&#x5411;&#x7528;&#x6237;api&#x7684;.</p>
<pre><code class="lang-go">// Listener is an interface to the underlying listener for a transport
// and address.
type Listener interface {
    // Close closes the listener, and removes it from any active socket.
    // Further operations on the Listener will return ErrClosed.
    Close() error

    // Listen starts listening for new connectons on the address.
    Listen() error

    // Address returns the string (full URL) of the Listener.
    Address() string

    // SetOption sets an option on the Listener. Setting options
    // can only be done before Listen() has been called.
    SetOption(name string, value interface{}) error

    // GetOption gets an option value from the Listener.
    GetOption(name string) (interface{}, error)
}
</code></pre>
<pre><code class="lang-go">// Dialer is an interface to the underlying dialer for a transport
// and address.
type Dialer interface {
    // Close closes the dialer, and removes it from any active socket.
    // Further operations on the Dialer will return ErrClosed.
    Close() error

    // Dial starts connecting on the address.  If a connection fails,
    // it will restart.
    Dial() error

    // Address returns the string (full URL) of the Listener.
    Address() string

    // SetOption sets an option on the Dialer. Setting options
    // can only be done before Dial() has been called.
    SetOption(name string, value interface{}) error

    // GetOption gets an option value from the Listener.
    GetOption(name string) (interface{}, error)
}
</code></pre>
<h3 id="devicego"><a name="devicego" class="anchor-navigation-ex-anchor" href="#devicego"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.8. device.go</h3>
<p>&#x7528;&#x4E8E;&#x5728;socket&#x4E4B;&#x95F4;&#x8F6C;&#x53D1;, &#x8FD9;&#x4E24;&#x4E2A;socket&#x5FC5;&#x987B;&#x90FD;&#x662F;raw&#x6A21;&#x5F0F;</p>
<pre><code class="lang-go">func Device(s1 Socket, s2 Socket) error {
    go forwarder(s1, s2)
    if s2 != s1 {
        go forwarder(s2, s1)
    }
    return nil
}

// Forwarder takes messages from one socket, and sends them to the other.
// The sockets must be of compatible types, and must be in Raw mode.
func forwarder(fromSock Socket, toSock Socket) {
    for {
        m, err := fromSock.RecvMsg()
        if err != nil {
            // Probably closed socket, nothing else we can do.
            return
        }

        err = toSock.SendMsg(m)
        if err != nil {
            return
        }
    }
}
</code></pre>
<h2 id="transport"><a name="transport" class="anchor-navigation-ex-anchor" href="#transport"><i class="fa fa-link" aria-hidden="true"></i></a>2.2. transport</h2>
<h3 id="transporttransportgo"><a name="transporttransportgo" class="anchor-navigation-ex-anchor" href="#transporttransportgo"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.1. transport/transport.go</h3>
<p>&#x63D0;&#x4F9B;&#x6CE8;&#x518C;transport&#x5B9E;&#x73B0;&#x5230;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x8868;&#x7684;&#x65B9;&#x6CD5;</p>
<pre><code class="lang-go">var transports = map[string]Transport{}

// RegisterTransport is used to register the transport globally,
// after which it will be available for all sockets.  The
// transport will override any others registered for the same
// scheme.
func RegisterTransport(t Transport) {
    lock.Lock()
    transports[t.Scheme()] = t
    lock.Unlock()
}

// GetTransport is used by a socket to lookup the transport
// for a given scheme.
func GetTransport(scheme string) Transport {
    lock.RLock()
    defer lock.RUnlock()
    if t, ok := transports[scheme]; ok {
        return t
    }
    return nil
}
</code></pre>
<p>&#x591A;&#x51FA;&#x4F7F;&#x7528;&#x4E86;&#x6280;&#x5DE7;: type&#x548C;&#x7B49;&#x53F7;&#x5B9E;&#x9645;&#x4E0A;&#x662F;alias</p>
<pre><code class="lang-go">// Pipe is a transport pipe.
type Pipe = mangos.TranPipe

// Dialer is a factory that creates Pipes by connecting to remote listeners.
type Dialer = mangos.TranDialer

// Listener is a factory that creates Pipes by listening to inbound dialers.
type Listener = mangos.TranListener

// Transport is our transport operations.
type Transport = mangos.Transport
</code></pre>
<h3 id="transporthandshakergo"><a name="transporthandshakergo" class="anchor-navigation-ex-anchor" href="#transporthandshakergo"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.2. transport/handshaker.go</h3>
<p>&#x8FD9;&#x91CC;handshaker&#x662F;&#x5BF9;&#x5F02;&#x6B65;&#x63E1;&#x624B;&#x7684;&#x62BD;&#x8C61;. &#x6240;&#x8C13;&#x5F02;&#x6B65;&#x63E1;&#x624B;&#x5C31;&#x662F;&#x63E1;&#x624B;&#x4F1A;&#x5728;&#x540E;&#x53F0;&#x8FDB;&#x884C;, &#x4E0D;block&#x5F53;&#x524D;&#x6D41;&#x7A0B;.</p>
<pre><code class="lang-go">// Handshaker is used to support dealing with asynchronous
// handshaking used for some transports.  This allows the
// initial handshaking to be done in the background, without
// stalling the server&apos;s accept queue.  This is important to
// ensure that a slow remote peer cannot bog down the server
// or effect a denial-of-service for new connections.
type Handshaker interface {
    // Start injects a pipe into the handshaker.  The
    // handshaking is done asynchronously on a Go routine.
    Start(Pipe)

    // Waits for until a pipe has completely finished the
    // handshaking and returns it.
    Wait() (Pipe, error)

    // Close is used to close the handshaker.  Any existing
    // negotiations will be canceled, and the underlying
    // transport sockets will be closed.  Any new attempts
    // to start will return mangos.ErrClosed.
    Close()
}
</code></pre>
<h3 id="transportconngo"><a name="transportconngo" class="anchor-navigation-ex-anchor" href="#transportconngo"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.3. transport/conn.go</h3>
<p>&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x5B9E;&#x73B0;&#x4E86;&#x57FA;&#x4E8E;net.conn&#x7684;TranPipe. &#x8FD9;&#x4E2A;TranPipe&#x4E5F;&#x6709;&#x522B;&#x540D;connPipe, &#x5176;&#x4ED6;&#x7684;stream&#x5F0F;&#x7684;transport&#x5B9E;&#x73B0;&#x53EF;&#x4EE5;&#x88AB;&#x88AB;&#x5305;&#x88C5;&#x6210;connPipe, &#x4F7F;&#x7528;&#x8FD9;&#x91CC;&#x901A;&#x7528;&#x7684;&#x5206;&#x5305;&#x65B9;&#x6CD5;&#x548C;&#x63E1;&#x624B;&#x534F;&#x8BAE;.</p>
<pre><code class="lang-go">// conn implements the Pipe interface on top of net.Conn.  The
// assumption is that transports using this have similar wire protocols,
// and conn is meant to be used as a building block.
type conn struct {
    c       net.Conn
    proto   ProtocolInfo
    open    bool
    options map[string]interface{} //&#x5BF9;&#x4E8E;option, &#x4E00;&#x628A;get set&#x64CD;&#x4F5C;&#x4E0D;&#x9891;&#x7E41;, &#x7528;string&#x7C7B;&#x7684;map&#x518D;&#x5408;&#x9002;&#x4E0D;&#x8FC7;&#x4E86;.
    maxrx   int
    sync.Mutex
}
</code></pre>
<h4 id="recv&#x548C;send&#x5199;&#x7684;&#x5F88;&#x6709;&#x6C34;&#x5E73;"><a name="recv&#x548C;send&#x5199;&#x7684;&#x5F88;&#x6709;&#x6C34;&#x5E73;" class="anchor-navigation-ex-anchor" href="#recv&#x548C;send&#x5199;&#x7684;&#x5F88;&#x6709;&#x6C34;&#x5E73;"><i class="fa fa-link" aria-hidden="true"></i></a>recv&#x548C;send&#x5199;&#x7684;&#x5F88;&#x6709;&#x6C34;&#x5E73;</h4>
<p>&#x5BF9;net&#x5E93;, encoding/binary&#x5E93;&#x7684;&#x4F7F;&#x7528;&#x5F88;&#x5230;&#x4F4D;:</p>
<pre><code class="lang-go">// Recv implements the TranPipe Recv method.  The message received is expected
// as a 64-bit size (network byte order) followed by the message itself.
func (p *conn) Recv() (*Message, error) {
    var sz int64
    var err error
    var msg *Message

    //&#x5148;&#x8BFB;size
    //binary&#x6807;&#x51C6;&#x5E93;&#x89E3;&#x6790;&#x5B57;&#x8282;&#x5E8F;&#x5217;&#x5230;size, &#x5230;&#x7ED3;&#x6784;&#x4F53;&#x90FD;&#x884C;. &#x9700;&#x8981;&#x6307;&#x660E;&#x5927;&#x5C0F;&#x7AEF;.
    if err = binary.Read(p.c, binary.BigEndian, &amp;sz); err != nil {
        return nil, err
    }

    // Limit messages to the maximum receive value, if not
    // unlimited.  This avoids a potential denial of service.
    if sz &lt; 0 || (p.maxrx &gt; 0 &amp;&amp; sz &gt; int64(p.maxrx)) {
        return nil, mangos.ErrTooLong
    }

    //&#x6839;&#x636E;size&#x51C6;&#x5907;buffer
    //&#x8FD9;&#x91CC;&#x662F;&#x4ECE;pool&#x91CC;new msg
    msg = mangos.NewMessage(int(sz))
    msg.Body = msg.Body[0:sz]

    //&#x7528;io.ReadFull&#x8BFB;&#x5B8C;&#x6574;&#x7684;msg, &#x4E5F;&#x5C31;&#x662F;size&#x957F;&#x5EA6;&#x7684;msg.
    //&#x5F88;&#x660E;&#x663E;, &#x8FD9;&#x91CC;&#x7684;&#x524D;&#x63D0;&#x662F;stream&#x65B9;&#x5F0F;&#x7684;&#x6570;&#x636E;&#x62A5;.
    if _, err = io.ReadFull(p.c, msg.Body); err != nil {
        msg.Free()
        return nil, err
    }
    return msg, nil
}

// Send implements the Pipe Send method.  The message is sent as a 64-bit
// size (network byte order) followed by the message itself.
func (p *conn) Send(msg *Message) error {
    //&#x4F7F;&#x7528;net&#x5305;&#x7684;Buffer&#x5BF9;&#x8C61;&#x53D1;&#x9001;
    //net&#x7684;Buffer&#x662F;[][]byte, &#x662F;&#x5178;&#x578B;scatter&#x6A21;&#x5F0F;, &#x5373;&#x79BB;&#x6563;buffer&#x6A21;&#x5F0F;.
    var buff = net.Buffers{}

    //&#x8FD9;&#x91CC;size&#x4E00;&#x5B9A;&#x662F;&#x5927;&#x7AEF;&#x683C;&#x5F0F;&#x7684;, &#x800C;&#x4E14;&#x8FD9;&#x4E2A;size&#x662F;header&#x548C;body&#x7684;&#x548C;.
    // Serialize the length header
    l := uint64(len(msg.Header) + len(msg.Body))
    lbyte := make([]byte, 8)
    binary.BigEndian.PutUint64(lbyte, l)

    //lbyte&#x662F;&#x5927;&#x7AEF;, msg.Header, msg.Body&#x8FD8;&#x662F;&#x539F;&#x59CB;&#x5B57;&#x8282;&#x5E8F;
    //&#x7528;append&#x6765;&#x7EC4;&#x5305;, &#x56E0;&#x4E3A;&#x662F;&#x4E8C;&#x7EF4;byte, append&#x53EA;&#x62F7;&#x8D1D;`[]byte`&#x5934;, &#x4E0D;&#x5B58;&#x5728;&#x989D;&#x5916;&#x6570;&#x636E;&#x62F7;&#x8D1D;.
    // Attach the length header along with the actual header and body
    buff = append(buff, lbyte, msg.Header, msg.Body)

    //buffer&#x81EA;&#x5E26;&#x7684;writeTo&#x51FD;&#x6570;, &#x4E00;&#x628A;&#x5199;&#x5B8C;.
    if _, err := buff.WriteTo(p.c); err != nil {
        return err
    }

    msg.Free()
    return nil
}
</code></pre>
<p>&#x6CE8;&#x610F;, &#x4EE5;&#x4E0A;&#x7684;&#x51FD;&#x6570;&#x4E2D;&#x7684;header&#x90E8;&#x5206;&#x662F;<code>[]byte</code>, &#x5BF9;&#x5176;&#x5177;&#x4F53;&#x7684;header&#x683C;&#x5F0F;&#x6CA1;&#x6709;&#x8BA4;&#x77E5;.</p>
<h4 id="&#x53D1;&#x9001;&#x63A5;&#x6536;&#x603B;&#x7ED3;"><a name="&#x53D1;&#x9001;&#x63A5;&#x6536;&#x603B;&#x7ED3;" class="anchor-navigation-ex-anchor" href="#&#x53D1;&#x9001;&#x63A5;&#x6536;&#x603B;&#x7ED3;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x53D1;&#x9001;&#x63A5;&#x6536;&#x603B;&#x7ED3;</h4>
<ul>
<li>&#x53D1;&#x9001;&#x63A5;&#x6536;&#x90FD;&#x662F;&#x5148;&#x6709;&#x4E2A;size, &#x518D;&#x6839;&#x636E;size&#x53D6;&#x51FA;&quot;payload&quot;. size&#x662F;header+body&#x7684;&#x603B;&#x5927;&#x5C0F;<ul>
<li>&#x56E0;&#x4E3A;&#x5171;&#x4EAB;size, &#x6240;&#x4EE5;&#x63A5;&#x6536;&#x65B9;&#x6CA1;&#x6709;&#x529E;&#x6CD5;&#x5206;&#x522B;&#x77E5;&#x9053;Header&#x548C;Body&#x7684;&#x5927;&#x5C0F;. &#x6240;&#x4EE5;&#x53EA;&#x80FD;&#x90FD;&#x7528;Body&#x6765;&#x63A5;&#x6536;</li>
<li>&#x5373;&#x53D1;&#x9001;&#x65B9;&#x53D1;&#x7684;&#x662F;Header+Body, &#x5230;&#x63A5;&#x6536;&#x65B9;&#x7ED3;&#x6784;&#x4F53;&#x4E2D;, Header&#x4E3A;&#x7A7A;, Body&#x662F;&#x539F;Header+Body</li>
</ul>
</li>
<li>&#x4F7F;&#x7528;&#x4E86;encoding/binary&#x5BF9;&#x5B57;&#x8282;&#x5E8F;&#x5217;&#x8FDB;&#x884C;&quot;&#x89E3;&#x91CA;&quot;, &#x6BD4;&#x5982;size&#x5C31;&#x662F;&#x6309;&#x5927;&#x7AEF;&#x5B57;&#x8282;&#x5E8F;&#x89E3;&#x6790;&#x7684;.</li>
<li>&#x53D1;&#x9001;&#x7684;&#x662F;net.Buffers, &#x662F;&#x4E2A;&#x4E8C;&#x7EF4;byte <code>[][]byte</code>, &#x672C;&#x8D28;&#x4E0A;&#x662F;scatter&#x7684;&#x6307;&#x9488;&#x6570;&#x7EC4;, &#x4E0D;&#x62F7;&#x8D1D;&#x6570;&#x636E;</li>
<li>&#x63A5;&#x6536;&#x7528;&#x7684;&#x662F;sync.Pool&#x7684;&#x5185;&#x5B58;&#x6C60;&#x5316;&#x65B9;&#x5F0F;, &#x51CF;&#x5C0F;gc&#x538B;&#x529B;.</li>
<li>&#x5BF9;header&#x548C;body&#x4E0D;&#x505A;&#x5047;&#x8BBE;, &#x4E5F;&#x6CA1;&#x6709;&#x77E5;&#x8BC6;. &#x53D1;&#x9001;&#x63A5;&#x6536;&#x8BA4;&#x4E3A;&#x4ED6;&#x4EEC;&#x90FD;&#x662F;[]byte</li>
</ul>
<h4 id="option&#x51FD;&#x6570;&#x5C31;&#x662F;&#x5B57;&#x7B26;&#x4E32;&#x7248;&#x672C;&#x7684;ioctl"><a name="option&#x51FD;&#x6570;&#x5C31;&#x662F;&#x5B57;&#x7B26;&#x4E32;&#x7248;&#x672C;&#x7684;ioctl" class="anchor-navigation-ex-anchor" href="#option&#x51FD;&#x6570;&#x5C31;&#x662F;&#x5B57;&#x7B26;&#x4E32;&#x7248;&#x672C;&#x7684;ioctl"><i class="fa fa-link" aria-hidden="true"></i></a>option&#x51FD;&#x6570;&#x5C31;&#x662F;&#x5B57;&#x7B26;&#x4E32;&#x7248;&#x672C;&#x7684;ioctl</h4>
<pre><code class="lang-go">func (p *conn) GetOption(n string) (interface{}, error) {
    switch n {
    case mangos.OptionMaxRecvSize:
        return p.maxrx, nil
    }
    if v, ok := p.options[n]; ok {
        return v, nil
    }
    return nil, mangos.ErrBadProperty
}

func (p *conn) SetOption(n string, v interface{}) {
    switch n {
    case mangos.OptionMaxRecvSize:
        p.maxrx = v.(int)
    }
    p.options[n] = v
}
</code></pre>
<h4 id="header&#x548C;&#x540C;&#x6B65;&#x534F;&#x8BAE;&#x63E1;&#x624B;"><a name="header&#x548C;&#x540C;&#x6B65;&#x534F;&#x8BAE;&#x63E1;&#x624B;" class="anchor-navigation-ex-anchor" href="#header&#x548C;&#x540C;&#x6B65;&#x534F;&#x8BAE;&#x63E1;&#x624B;"><i class="fa fa-link" aria-hidden="true"></i></a>header&#x548C;&#x540C;&#x6B65;&#x534F;&#x8BAE;&#x63E1;&#x624B;</h4>
<pre><code class="lang-go">// connHeader is exchanged during the initial handshake.
type connHeader struct {
    Zero     byte // must be zero
    S        byte // &apos;S&apos;
    P        byte // &apos;P&apos;
    Version  byte // only zero at present
    Proto    uint16
    Reserved uint16 // always zero at present
}
</code></pre>
<p>header&#x91CC;&#x9762;&#x56FA;&#x5B9A;&#x7684;&#x5B57;&#x6BB5;&#x610F;&#x4E49;</p>
<p>&#x63E1;&#x624B;&#x7684;&#x8FC7;&#x7A0B;&#x662F;&#x4EA4;&#x6362;header&#x7684;&#x8FC7;&#x7A0B;.</p>
<pre><code class="lang-go">// handshake establishes an SP connection between peers.  Both sides must
// send the header, then both sides must wait for the peer&apos;s header.
// As a side effect, the peer&apos;s protocol number is stored in the conn.
// Also, various properties are initialized.
func (p *conn) handshake() error {
    var err error

    h := connHeader{S: &apos;S&apos;, P: &apos;P&apos;, Proto: p.proto.Self}
    //&#x8FD9;&#x91CC;&#x7684;binary.Write&#x5C31;&#x662F;&#x76F4;&#x63A5;&#x5BF9;&#x5E95;&#x5C42;conn p.c &#x505A;send&#x64CD;&#x4F5C;.
    if err = binary.Write(p.c, binary.BigEndian, &amp;h); err != nil {
        return err
    }

    //&#x518D;&#x4ECE;&#x5BF9;&#x7AEF;&#x8BFB;&#x51FA;handshake&#x4FE1;&#x606F;
    if err = binary.Read(p.c, binary.BigEndian, &amp;h); err != nil {
        _ = p.c.Close()
        return err
    }
    if h.Zero != 0 || h.S != &apos;S&apos; || h.P != &apos;P&apos; || h.Reserved != 0 {
        _ = p.c.Close()
        return mangos.ErrBadHeader
    }
    // The only version number we support at present is &quot;0&quot;, at offset 3.
    if h.Version != 0 {
        _ = p.c.Close()
        return mangos.ErrBadVersion
    }

    // The protocol number lives as 16-bits (big-endian) at offset 4.
    if h.Proto != p.proto.Peer {
        _ = p.c.Close()
        return mangos.ErrBadProto
    }
    p.open = true
    return nil
}
</code></pre>
<h4 id="&#x540E;&#x53F0;&#x63E1;&#x624B;&#x63A5;&#x53E3;"><a name="&#x540E;&#x53F0;&#x63E1;&#x624B;&#x63A5;&#x53E3;" class="anchor-navigation-ex-anchor" href="#&#x540E;&#x53F0;&#x63E1;&#x624B;&#x63A5;&#x53E3;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x540E;&#x53F0;&#x63E1;&#x624B;&#x63A5;&#x53E3;</h4>
<p>&#x4E0A;&#x9762;&#x662F;&#x540C;&#x6B65;&#x7684;&#x63E1;&#x624B;&#x51FD;&#x6570;, &#x662F;&#x5177;&#x4F53;&#x5B9E;&#x73B0;. &#x540C;&#x6B65;&#x7684;&#x63A5;&#x53E3;&#x53EF;&#x4EE5;&#x88AB;&#x5F02;&#x6B65;&#x6846;&#x67B6;&#x5F02;&#x6B65;&#x5316;, &#x6765;&#x6EE1;&#x8DB3;handshaker&#x7684;&#x8981;&#x6C42;
&#x57FA;&#x672C;&#x4E0A;, &#x63E1;&#x624B;&#x662F;&#x5E95;&#x5C42;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x540E;&#x8981;&#x505A;&#x7684;&#x7B2C;&#x4E00;&#x4EF6;&#x4E8B;.
&#x4E0B;&#x9762;&#x662F;conn.go&#x63D0;&#x4F9B;&#x7684;&#x5F02;&#x6B65;&#x5305;&#x88C5;&#x6846;&#x67B6;, &#x662F;&#x627F;&#x4E0A;(transport/handshaker.go&#x8981;&#x6C42;&#x7684;&#x540E;&#x53F0;&#x63E1;&#x624B;)&#x542F;&#x4E0B;(&#x5404;&#x4E2A;transport&#x7C7B;&#x578B;&#x5B9E;&#x73B0;&#x7684;handshake)</p>
<pre><code class="lang-go">type connHandshakerPipe interface {
    handshake() error //&#x88AB;&#x5305;&#x88C5;&#x7684;&#x5BF9;&#x8C61;&#x8981;&#x5B9E;&#x73B0;handshake&#x51FD;&#x6570;
    Pipe //&#x548C;send recv&#x7B49;tranpipe&#x63A5;&#x53E3;, &#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#x662F;&#x5BF9;&#x6240;&#x6709;transport&#x7C7B;&#x578B;&#x7684;&#x7EDF;&#x4E00;&#x62BD;&#x8C61;.
}

type connHandshakerItem struct {
    c connHandshakerPipe
    e error
}
type connHandshaker struct {
    workq  map[connHandshakerPipe]bool //interface&#x53EF;&#x4EE5;&#x5F53;map&#x7684;key
    doneq  []*connHandshakerItem //&#x6CE8;&#x610F;&#x8FD9;&#x91CC;, handshaker&#x662F;&#x4E2A;&#x6C47;&#x805A;&#x8005;, &#x8FD9;&#x91CC;&#x5305;&#x62EC;&#x4E86;listen&#x540E;accept&#x7684;&#x6240;&#x6709;conn(&#x88AB;&#x5305;&#x88C5;&#x4E3A;connHandshakerPipe)
    closed bool
    cv     *sync.Cond
    sync.Mutex
}
</code></pre>
<p>&#x5148;&#x770B;start: &#x4E00;&#x4E2A;connHandshaker&#x53EF;&#x4EE5;&#x548C;&#x591A;&#x4E2A;pipe&#x540E;&#x53F0;&#x63E1;&#x624B;, &#x6BCF;&#x4E2A;pipe&#x90FD;&#x542F;&#x52A8;&#x4E00;&#x4E2A;go routine; &#x4E00;&#x4E2A;pipe&#x4EE3;&#x8868;&#x4E86;&#x4E00;&#x4E2A;conn</p>
<pre><code class="lang-go">func (h *connHandshaker) Start(p Pipe) {
    // If the following type assertion fails, then its a software bug.
    conn := p.(connHandshakerPipe)
    h.Lock()
    h.workq[conn] = true //&#x6807;&#x8BB0;&#x8FD9;&#x4E2A;conn&#x6B63;&#x5728;&#x63E1;&#x624B;&#x4E2D;
    h.Unlock()
    go h.worker(conn)
}

func (h *connHandshaker) worker(conn connHandshakerPipe) {
    item := &amp;connHandshakerItem{c: conn}
    item.e = conn.handshake() //&#x8FD9;&#x91CC;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x540C;&#x6B65;&#x7248;&#x672C;&#x7684;handshake&#x51FD;&#x6570;. &#x6B64;&#x65F6;&#x5FC5;&#x7136;&#x5DF2;&#x7ECF;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;, &#x5426;&#x5219;&#x4E5F;&#x4E0D;&#x4F1A;&#x6709;conn&#x5BF9;&#x8C61;.
    h.Lock()
    defer h.Unlock()

    delete(h.workq, conn)

    //&#x6709;&#x9519;&#x8BEF;&#x5C31;close&#x6389;&#x8FD9;&#x4E2A;conn
    if item.e != nil {
        _ = item.c.Close()
        item.c = nil
    } else if h.closed {
        item.e = mangos.ErrClosed
        _ = item.c.Close()
    }

    //&#x628A;&#x7ED3;&#x679C;&#x653E;&#x5230;doneq&#x91CC;
    h.doneq = append(h.doneq, item)
    h.cv.Broadcast() //&#x5E7F;&#x64AD;&#x4F1A;&#x5524;&#x9192;&#x6240;&#x6709;&#x7B49;&#x5F85;&#x7684;goroutine, &#x4F46;&#x5B9E;&#x9645;&#x4E0A;wait&#x8DEF;&#x5F84;&#x4E0A;&#x6709;&#x9501;, &#x7ED3;&#x679C;&#x662F;&#x53EA;&#x80FD;&#x6709;&#x4E00;&#x4E2A;routine&#x5728;cv&#x4E0A;wait. &#x5176;&#x4ED6;&#x4EBA;&#x5728;&#x9501;&#x4E0A;wait.
}
</code></pre>
<p>wait&#x662F;&#x7B49;&#x5F85;&#x8FD4;&#x56DE;&#x4EFB;&#x610F;&#x4E00;&#x4E2A;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;&#x63E1;&#x624B;&#x7684;conn</p>
<pre><code class="lang-go">func (h *connHandshaker) Wait() (Pipe, error) {
    h.Lock()
    defer h.Unlock()
    for len(h.doneq) == 0 &amp;&amp; !h.closed {
        h.cv.Wait() //&#x6301;&#x6709;&#x9501;&#x7684;wait
    }
    if h.closed {
        return nil, mangos.ErrClosed
    }
    item := h.doneq[0] //&#x6309;&#x5B8C;&#x6210;&#x987A;&#x5E8F;&#x53D6;
    h.doneq = h.doneq[1:] //&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x88AB;&#x9501;&#x4FDD;&#x62A4;
    return item.c, item.e
}
</code></pre>
<p>close</p>
<pre><code class="lang-go">func (h *connHandshaker) Close() {
    h.Lock()
    h.closed = true
    h.cv.Broadcast()
    for conn := range h.workq {
        _ = conn.Close()
    }
    for len(h.doneq) != 0 {
        item := h.doneq[0]
        h.doneq = h.doneq[1:]
        if item.c != nil {
            _ = item.c.Close()
        }
    }
    h.Unlock()
}
</code></pre>
<h3 id="transporttcptcpgo"><a name="transporttcptcpgo" class="anchor-navigation-ex-anchor" href="#transporttcptcpgo"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.4. transport/tcp/tcp.go</h3>
<p>tcp&#x5B9E;&#x73B0;&#x4E86;Scheme NewDialer NewListener&#x65B9;&#x6CD5;, &#x6EE1;&#x8DB3;&#x4E86;transport&#x63A5;&#x53E3;.</p>
<pre><code class="lang-go">type tcpTran int

func (t tcpTran) Scheme() string {
    return &quot;tcp&quot;
}
</code></pre>
<p>&#x6709;&#x610F;&#x601D;&#x7684;&#x662F;, tcpTran&#x53EA;&#x662F;&#x4E2A;int&#x7C7B;&#x578B;&#x7684;&#x91CD;&#x547D;&#x540D;.
&#x5728;init&#x91CC;, &#x6CE8;&#x518C;&#x8FD9;&#x4E2A;tcpTran&#x7C7B;&#x578B;</p>
<pre><code class="lang-go">const (
    // Transport is a transport.Transport for TCP.
    Transport = tcpTran(0)
)

//&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x6CE8;&#x518C;&#x63A5;&#x53E3;&#x7C7B;&#x578B;: transports[t.Scheme()] = t
func init() {
    transport.RegisterTransport(Transport)
}
</code></pre>
<h4 id="newdialer&#x548C;newlistener"><a name="newdialer&#x548C;newlistener" class="anchor-navigation-ex-anchor" href="#newdialer&#x548C;newlistener"><i class="fa fa-link" aria-hidden="true"></i></a>NewDialer&#x548C;NewListener</h4>
<p>&#x8FD9;&#x4E24;&#x4E2A;&#x63A5;&#x53E3;&#x7C7B;&#x4F3C;&#x5DE5;&#x5382;&#x7C7B;, &#x5176;&#x4EA7;&#x54C1;transport.Dialer&#x548C;transport.Listener&#x624D;&#x662F;&#x91CD;&#x70B9;.</p>
<pre><code class="lang-go">func (t tcpTran) NewDialer(addr string, sock mangos.Socket) (transport.Dialer, error) {
    var err error
    //StripScheme&#x628A;tcp://192.168.0.1:1234&#x4E2D;&#x7684;192.168.0.1:1234&#x90E8;&#x5206;&#x63D0;&#x53D6;&#x51FA;&#x6765;
    if addr, err = transport.StripScheme(t, addr); err != nil {
        return nil, err
    }

    // check to ensure the provided addr resolves correctly.
    //&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x8C03;&#x7528;net.ResolveTCPAddr
    if _, err = transport.ResolveTCPAddr(addr); err != nil {
        return nil, err
    }

    d := &amp;dialer{ //&#x8FD4;&#x56DE;&#x91CD;&#x70B9;, &#x5C31;&#x662F;&#x8FD9;&#x4E2A;dialer
        addr:  addr,
        proto: sock.Info(), //&#x8FD9;&#x91CC;transport&#x4E5F;&#x5173;&#x5FC3;&#x5E94;&#x7528;socket&#x7C7B;&#x578B;&#x4E86;?
        hs:    transport.NewConnHandshaker(), //handshake&#x662F;&#x5E94;&#x7528;&#x4FA7;socket&#x4EA4;&#x6362;&#x4FE1;&#x606F;&#x7684;&#x5F00;&#x59CB;
    }

    return d, nil
}

func (t tcpTran) NewListener(addr string, sock mangos.Socket) (transport.Listener, error) {
    var err error
    l := &amp;listener{ //&#x8FD4;&#x56DE;&#x91CD;&#x70B9;, &#x5C31;&#x662F;&#x8FD9;&#x4E2A;listener
        proto:  sock.Info(),
        closeq: make(chan struct{}),
    }

    if addr, err = transport.StripScheme(t, addr); err != nil {
        return nil, err
    }

    l.addr = addr

    l.handshaker = transport.NewConnHandshaker()
    return l, nil
}
</code></pre>
<h4 id="dialer"><a name="dialer" class="anchor-navigation-ex-anchor" href="#dialer"><i class="fa fa-link" aria-hidden="true"></i></a>dialer</h4>
<p>dialer&#x8981;&#x5B9E;&#x73B0;Dial GetOption&#x548C;SetOption&#x63A5;&#x53E3;</p>
<pre><code class="lang-go">type dialer struct {
    addr        string
    proto       transport.ProtocolInfo
    hs          transport.Handshaker
    maxRecvSize int
    d           net.Dialer
    lock        sync.Mutex
}

func (d *dialer) Dial() (_ transport.Pipe, err error) {
    conn, err := d.d.Dial(&quot;tcp&quot;, d.addr) // &#x5148;dail&#x5F97;&#x5230;conn, &#x4E5F;&#x5C31;&#x662F;pipe
    if err != nil {
        return nil, err
    }

    p := transport.NewConnPipe(conn, d.proto) //&#x5305;&#x88C5;&#x5DF2;&#x6709;&#x7684;conn&#x5F97;&#x5230;connPipe, stream&#x65B9;&#x5F0F;&#x7684;Conn&#x90FD;&#x53EF;&#x4EE5;&#x7528;&#x5B83;&#x6765;&#x5B9E;&#x73B0;transport. &#x4F46;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x91CC;&#x8981;&#x77E5;&#x9053;proto? proto&#x662F;&#x5E94;&#x7528;&#x4FA7;socket&#x7684;&#x7C7B;&#x578B;, &#x5305;&#x62EC;&#x81EA;&#x5DF1;&#x548C;&#x5BF9;&#x7AEF;.
    d.lock.Lock()
    p.SetOption(mangos.OptionMaxRecvSize, d.maxRecvSize) //&#x4F3C;&#x4E4E;&#x9ED8;&#x8BA4;maxRecvSize&#x4E3A;0
    d.lock.Unlock()
    d.hs.Start(p) //&#x91CC;&#x9762;&#x4F1A;&#x65AD;&#x8A00;p&#x662F;connHandshakerPipe, &#x56E0;&#x4E3A;NewConnPipe()&#x8FD4;&#x56DE;&#x7684;p, &#x5B9E;&#x73B0;&#x4E86;handshake()&#x51FD;&#x6570;. &#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x7684;handshake()&#x51FD;&#x6570;&#x662F;&#x5C0F;&#x5199;&#x5F00;&#x5934;, &#x5916;&#x90E8;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x8C03;&#x7528;. &#x4F46;go&#x7F16;&#x8BD1;&#x5668;&#x7684;&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x8FD8;&#x662F;&#x4F1A;&#x5224;&#x5B9A;p&#x5B9E;&#x73B0;&#x4E86;&#x4E0D;&#x5BF9;&#x5916;&#x7684;handshake()&#x51FD;&#x6570;.
    return d.hs.Wait() //&#x5148;start&#x518D;wait, &#x8FD9;&#x5C31;&#x662F;&#x540C;&#x6B65;&#x5316;&#x4E86;, &#x5B9E;&#x9645;&#x5C31;&#x50CF;&#x662F;&#x8C03;&#x4E86;p.handshake()&#x51FD;&#x6570;. &#x4F46;&#x5B9E;&#x9645;&#x4E0A;handshake()&#x662F;&#x4E0D;&#x5BF9;&#x5916;&#x7684;, &#x53EA;&#x80FD;&#x7528;&#x5F02;&#x6B65;&#x518D;&#x540C;&#x6B65;&#x5316;&#x64CD;&#x4F5C;.
}
</code></pre>
<p>&#x6CE8;: &#x8FD9;&#x91CC;&#x628A;&#x63A5;&#x53E3;&#x7684;&#x9690;&#x542B;&#x5C5E;&#x6027;&#x7528;&#x7684;&#x51FA;&#x795E;&#x5165;&#x5316;. p&#x662F;&#x4E2A;interface, &#x628A;p&#x4F20;&#x5165;&#x7ED9;<code>d.hs.Start(p)</code>&#x65F6;, p&#x7684;&#x65B9;&#x6CD5;&#x96C6;&#x53D8;&#x6210;&#x4E86;TranPipe&#x63A5;&#x53E3;&#x7684;&#x65B9;&#x6CD5;&#x96C6;; &#x5728;<code>transport/conn.go</code>&#x91CC;&#x7684;start&#x5B9E;&#x73B0;&#x4E2D;, &#x65AD;&#x8A00;&#x5165;&#x53C2;TranPipe&#x662F;<code>conn := p.(connHandshakerPipe)</code>
&#x56E0;&#x4E3A;p&#x662F;<code>transport/conn.go</code>&#x91CC;NewConnPipe()&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x7684;, &#x4FDD;&#x8BC1;&#x80FD;&#x88AB;&#x540C;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x91CC;&#x7684;start&#x51FD;&#x6570;&#x65AD;&#x8A00;&#x6210;&#x529F;. &#x800C;&#x4E14;&#x5176;&#x7B7E;&#x540D;&#x51FD;&#x6570;handshake()&#x53EF;&#x4EE5;&#x5C0F;&#x5199;. &#x8FD9;&#x4E9B;&#x90FD;&#x662F;&#x5185;&#x90E8;&#x7684;&#x4E8B;&#x60C5;.</p>
<h4 id="listener"><a name="listener" class="anchor-navigation-ex-anchor" href="#listener"><i class="fa fa-link" aria-hidden="true"></i></a>listener</h4>
<p>listener&#x8981;&#x590D;&#x6742;&#x70B9;, &#x8981;&#x5B9E;&#x73B0;Accept Listen Address Close&#x548C;Set/Get Option&#x7684;&#x65B9;&#x6CD5;</p>
<pre><code class="lang-go">type listener struct {
    addr        string
    bound       net.Addr
    proto       transport.ProtocolInfo
    l           net.Listener
    lc          net.ListenConfig
    maxRecvSize int
    handshaker  transport.Handshaker
    closeq      chan struct{}
    once        sync.Once
    lock        sync.Mutex
}
</code></pre>
<p>Accept()&#x4E00;&#x822C;&#x7D27;&#x8DDF;&#x7740;Listen()&#x4E4B;&#x540E;, &#x7B49;&#x5F85;&#x5E76;&#x8FD4;&#x56DE;&#x534F;&#x5546;&#x6210;&#x529F;&#x7684;pipe</p>
<pre><code class="lang-go">func (l *listener) Accept() (transport.Pipe, error) {

    if l.l == nil {
        return nil, mangos.ErrClosed
    }
    return l.handshaker.Wait()
}
</code></pre>
<p>Listen&#x542F;&#x52A8;&#x4E86;&#x4E00;&#x4E2A;goroutine&#x6765;&#x505A;accept</p>
<pre><code class="lang-go">func (l *listener) Listen() (err error) {
    select {
    case &lt;-l.closeq:
        return mangos.ErrClosed //&#x5982;&#x679C;&#x4E4B;&#x524D;&#x8FD9;&#x4E2A;listener&#x88AB;close()&#x8FC7;, &#x5C31;&#x4E0D;&#x80FD;&#x518D;listen&#x4E86;.
    default:
    }
    l.l, err = l.lc.Listen(context.Background(), &quot;tcp&quot;, l.addr)
    if err != nil {
        return
    }
    l.bound = l.l.Addr()
    go func() {
        for {
            conn, err := l.l.Accept()
            if err != nil {
                select {
                case &lt;-l.closeq:
                    return
                default:
                    // We probably should be checking
                    // if this is a temporary error.
                    // If we run out of files we will
                    // spin hard here.
                    time.Sleep(time.Millisecond)
                    continue
                }
            }
            p := transport.NewConnPipe(conn, l.proto) //stream&#x5F0F;&#x7684;conn&#x90FD;&#x88AB;&#x5305;&#x88C5;&#x6210;&#x4E00;&#x4E2A;connPipe, connPipe&#x5B9A;&#x4E49;&#x4E86;&#x9ED8;&#x8BA4;&#x7684;&#x5206;&#x5305;&#x89C4;&#x5219;&#x548C;&#x63E1;&#x624B;&#x534F;&#x8BAE;.
            l.lock.Lock()
            p.SetOption(mangos.OptionMaxRecvSize, l.maxRecvSize) //maxRecvSize&#x8BBE;&#x7F6E;&#x6539;&#x53D8;&#x540E;, &#x5F71;&#x54CD;&#x4EE5;&#x540E;&#x7684;conn
            l.lock.Unlock()
            l.handshaker.Start(p) //&#x6CE8;&#x610F;&#x8FD9;&#x91CC;, listen&#x7684;&#x7ED3;&#x679C;&#x53EA;&#x6709;&#x5728;&#x8FD9;&#x91CC;&#x6709;&#x6240;&#x4F53;&#x73B0;, &#x548C;l&#x8054;&#x7CFB;&#x5728;&#x4E00;&#x8D77;. &#x4F1A;&#x5728;socket.Accept()&#x7528;&#x6237;&#x4FA7;api&#x4E2D;wait&#x5E76;&#x8FD4;&#x56DE;transport.Pipe
        }
    }()
    return
}
</code></pre>
<h4 id="adress&#x548C;close"><a name="adress&#x548C;close" class="anchor-navigation-ex-anchor" href="#adress&#x548C;close"><i class="fa fa-link" aria-hidden="true"></i></a>adress&#x548C;close</h4>
<p>address&#x8FD4;&#x56DE;&#x5168;&#x79F0;, &#x6BD4;&#x5982;<code>tcp://192.168.1.1:1111</code>
close&#x5148;&#x7528;close channel&#x7684;&#x65B9;&#x5F0F;&#x6539;&#x53D8;listener&#x7684;&#x72B6;&#x6001;, &#x8FD9;&#x6837;&#x5176;&#x4ED6;&#x4F8B;&#x7A0B;&#x53EF;&#x4EE5;&#x5B89;&#x5168;&#x7684;&#x68C0;&#x67E5;listener&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x88AB;close&#x6389;&#x4E86;. -- &#x4F3C;&#x4E4E;&#x6BD4;bool&#x7684;&#x65B9;&#x5F0F;&#x5148;&#x8FDB;&#x4E9B;?
close&#x7684;&#x610F;&#x601D;&#x662F;&#x505C;&#x6B62;listen&#x548C;accept, &#x4F46;&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x5EFA;&#x7ACB;&#x7684;&#x8FDE;&#x63A5;&#x4E0D;&#x53D7;&#x5F71;&#x54CD;.</p>
<pre><code class="lang-go">func (l *listener) Address() string {
    if b := l.bound; b != nil {
        return &quot;tcp://&quot; + b.String()
    }
    return &quot;tcp://&quot; + l.addr
}

func (l *listener) Close() error {
    l.once.Do(func() {
        close(l.closeq)
        if l.l != nil {
            _ = l.l.Close()
        }
        l.handshaker.Close()
    })
    return nil
}
</code></pre>
<h4 id="set&#x548C;get-option"><a name="set&#x548C;get-option" class="anchor-navigation-ex-anchor" href="#set&#x548C;get-option"><i class="fa fa-link" aria-hidden="true"></i></a>Set&#x548C;Get Option</h4>
<p>&#x548C;dialer&#x7C7B;&#x4F3C;, &#x6709;</p>
<ul>
<li>OptionMaxRecvSize</li>
<li>OptionKeepAliveTime</li>
</ul>
<h4 id="&#x603B;&#x7ED3;_1"><a name="&#x603B;&#x7ED3;_1" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;_1"><i class="fa fa-link" aria-hidden="true"></i></a>&#x603B;&#x7ED3;</h4>
<p>tcp&#x662F;stream&#x65B9;&#x5F0F;&#x7684;transport, &#x5E95;&#x5C42;&#x4F7F;&#x7528;net&#x6807;&#x51C6;&#x5E93;&#x7684;&#x65B9;&#x6CD5;, &#x6700;&#x4E3B;&#x8981;&#x7684;&#x662F;&#x628A;net.Conn&#x5305;&#x88C5;&#x6210;&#x4E86;connPipe, &#x540E;&#x8005;&#x662F;mangos&#x7684;&#x7EDF;&#x4E00;&#x5316;&#x7684;&#x6D41;&#x5F0F;pipe&#x7684;&#x5B9E;&#x73B0;, &#x6709;&#x6700;&#x7B80;&#x5355;&#x7684;&#x6839;&#x636E;header+body&#x7684;size&#x5B9A;&#x754C;&#x65B9;&#x6CD5;, &#x548C;&#x534F;&#x8BAE;&#x63E1;&#x624B;&#x7684;&#x65B9;&#x6CD5;.
&#x53EF;&#x4EE5;&#x8BF4;, tcp&#x4F7F;&#x7528;&#x4E86;connPipe&#x7684;&quot;helper&quot;&#x65B9;&#x6CD5;, &#x5B9E;&#x73B0;&#x4E86;&#x6D41;&#x5F0F;transport, &#x6EE1;&#x8DB3;&#x4E86;transport&#x7684;&#x6240;&#x6709;&#x63A5;&#x53E3;&#x8981;&#x6C42;.
<del>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;, mangos&#x505A;&#x4E3A;nanomsg&#x7684;&#x7EAF;go&#x7248;&#x672C;&#x5B9E;&#x73B0;, &#x5E76;&#x6CA1;&#x6709;follow&#x5176;&#x524D;&#x8EAB;zeroMQ&#x5BF9;&#x62A5;&#x6587;&#x683C;&#x5F0F;&#x7684;&#x89C4;&#x5B9A;, &#x5373;&#x5206;frame&#x7684;&#x89C4;&#x5B9A;.</del>  -- &#x6709;&#x5F85;&#x786E;&#x8BA4;.</p>
<h3 id="transport&#x5C0F;&#x8282;"><a name="transport&#x5C0F;&#x8282;" class="anchor-navigation-ex-anchor" href="#transport&#x5C0F;&#x8282;"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.5. transport&#x5C0F;&#x8282;</h3>
<ul>
<li>transport&#x662F;&#x77E5;&#x9053;&#x9876;&#x5C42;socket&#x4FE1;&#x606F;&#x7684;, &#x56E0;&#x4E3A;transport&#x5148;&#x4E8E;protocol&#x52A8;&#x4F5C;, &#x6BD4;&#x5982;&#x5728;client dial&#x7684;&#x65F6;&#x5019;, &#x5C31;&#x8981;&#x63E1;&#x624B;&#x4EA4;&#x6362;protocol&#x7684;&#x4FE1;&#x606F;&#x505A;&#x9A8C;&#x8BC1;. server listen&#x7684;&#x65F6;&#x5019;&#x4E5F;&#x5982;&#x662F;. </li>
</ul>
<h3 id="transportinprocinprocgo"><a name="transportinprocinprocgo" class="anchor-navigation-ex-anchor" href="#transportinprocinprocgo"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.6. transport/inproc/inproc.go</h3>
<p>&#x524D;&#x9762;&#x6211;&#x4EEC;&#x77E5;&#x9053;, transport&#x9996;&#x5148;&#x8981;&#x5B9E;&#x73B0;NewDialer, NewListener, &#x540E;&#x7EED;&#x8981;&#x5B9E;&#x73B0;Dial&#x548C;Listen&#x65B9;&#x6CD5;, &#x6700;&#x540E;&#x4E00;&#x5C42;&#x8981;&#x5B9E;&#x73B0;Send&#x548C;Recv. &#x6CE8;&#x610F;Send&#x548C;Recv&#x90FD;&#x662F;&#x89C4;&#x5B9A;&#x597D;&#x7684;<code>m *mangos.Message</code> -- &#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x89C4;&#x5B9A;&#x4E2A;interface&#x6765;&#x505A;msg&#x62BD;&#x8C61;?</p>
<h4 id="&#x5168;&#x5C40;listener&#x8868;"><a name="&#x5168;&#x5C40;listener&#x8868;" class="anchor-navigation-ex-anchor" href="#&#x5168;&#x5C40;listener&#x8868;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5168;&#x5C40;listener&#x8868;</h4>
<pre><code class="lang-go">var listeners struct {
    // Who is listening, on which &quot;address&quot;?
    byAddr map[string]*listener //&#x8BB0;&#x5F55;&#x4E86;&#x5168;&#x5C40;&#x7684;&#x540D;&#x5B57;
    cv     sync.Cond
    mx     sync.Mutex
}
</code></pre>
<h4 id="listen"><a name="listen" class="anchor-navigation-ex-anchor" href="#listen"><i class="fa fa-link" aria-hidden="true"></i></a>Listen</h4>
<p>NewListener&#x5C31;&#x4E0D;&#x770B;&#x4E86;, &#x5C31;&#x662F;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x5E26;Listen&#x529F;&#x80FD;&#x548C;Accept&#x529F;&#x80FD;&#x7684;&#x5BF9;&#x8C61;.
Listen&#x5F88;&#x7B80;&#x5355;, &#x5982;&#x679C;&#x8981;Listen&#x7684;&#x540D;&#x5B57;&#x6CA1;&#x6709;&#x4EBA;&#x7528;, &#x8868;&#x793A;&#x53EF;&#x4EE5;listen, &#x5C31;&#x8BB0;&#x5F55;&#x5230;&#x5168;&#x5C40;&#x8868;&#x4E2D;.</p>
<pre><code class="lang-go">func (l *listener) Listen() error {
    listeners.mx.Lock()
    if l.closed {
        listeners.mx.Unlock()
        return mangos.ErrClosed
    }
    if _, ok := listeners.byAddr[l.addr]; ok {
        listeners.mx.Unlock()
        return mangos.ErrAddrInUse
    }

    l.active = true
    listeners.byAddr[l.addr] = l
    listeners.cv.Broadcast() //&#x8FD9;&#x91CC;&#x8981;&#x5E7F;&#x64AD;&#x7ED9;&#x8C01;&#x5462;?
    listeners.mx.Unlock()
    return nil
}
</code></pre>
<h4 id="accept"><a name="accept" class="anchor-navigation-ex-anchor" href="#accept"><i class="fa fa-link" aria-hidden="true"></i></a>Accept</h4>
<p>&#x6BCF;&#x6B21;Accept&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x65B0;&#x7684;inproc&#x7C7B;&#x578B;&#x7684;server</p>
<pre><code class="lang-go">func (l *listener) Accept() (mangos.TranPipe, error) {
    server := &amp;inproc{
        selfProto: l.selfProto,
        peerProto: l.peerProto,
        addr:      addr(l.addr),
    }
    server.readyq = make(chan struct{})
    server.closeq = make(chan struct{})

    listeners.mx.Lock()
    if !l.active || l.closed {
        listeners.mx.Unlock()
        return nil, mangos.ErrClosed
    }
    l.accepters = append(l.accepters, server) //&#x8FD9;&#x91CC;&#x8FD9;&#x4E48;&#x65E9;&#x5C31;add&#x4E86;, &#x4E0D;&#x597D;&#x5427;? &#x8981;&#x4E0D;&#x653E;&#x5230;case&#x91CC; -- &#x6839;&#x636E;&#x4E0B;&#x6587;&#x903B;&#x8F91;, &#x4E00;&#x5B9A;&#x8981;&#x5148;&#x5728;l.accepters&#x91CC;&#x6709;server
    listeners.cv.Broadcast()
    listeners.mx.Unlock()

    select {
    case &lt;-server.readyq: //&#x7B49;&#x7740;&#x6709;&#x4EBA;&#x5199;readq, &#x8BF4;&#x660E;&#x5C31;&#x6709;&#x4E2A;&#x65B0;&#x8FDE;&#x63A5;; &#x6838;&#x5FC3;&#x5C42;&#x4F1A;&#x5728;for&#x91CC;&#x8C03;&#x7528;&#x8FD9;&#x91CC;&#x7684;Accept
        return server, nil
    case &lt;-server.closeq:
        return nil, mangos.ErrClosed
    }
}
</code></pre>
<h4 id="dial"><a name="dial" class="anchor-navigation-ex-anchor" href="#dial"><i class="fa fa-link" aria-hidden="true"></i></a>Dial</h4>
<pre><code class="lang-go">func (d *dialer) Dial() (transport.Pipe, error) {

    var server *inproc
    client := &amp;inproc{
        selfProto: d.selfProto,
        peerProto: d.peerProto,
        addr:      addr(d.addr), //client&#x4E5F;&#x76F4;&#x63A5;&#x7528;dial&#x7684;addr, &#x4E0D;&#x5408;&#x9002;&#x5427;?
    }
    client.readyq = make(chan struct{})
    client.closeq = make(chan struct{})

    listeners.mx.Lock()

    // NB: No timeouts here!
    for {
        var l *listener
        var ok bool
        if l, ok = listeners.byAddr[d.addr]; !ok || l == nil { //&#x4E00;&#x5B9A;&#x8981;&#x5148;&#x6709;listenr&#x624D;&#x80FD;Dial, &#x4E0D;&#x652F;&#x6301;&#x5148;&#x6709;client, &#x518D;&#x6709;server. -- &#x5176;&#x5B9E;&#x6CA1;&#x5FC5;&#x8981;
            listeners.mx.Unlock()
            return nil, mangos.ErrConnRefused
        }

        if (client.selfProto != l.peerProto) || //&#x8FD9;&#x662F;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x534F;&#x5546;&#x673A;&#x5236;
            (client.peerProto != l.selfProto) {
            listeners.mx.Unlock()
            return nil, mangos.ErrBadProto
        }

        if len(l.accepters) != 0 {
            server = l.accepters[len(l.accepters)-1] //&#x53D6;&#x6700;&#x540E;&#x4E00;&#x4E2A;server
            l.accepters = l.accepters[:len(l.accepters)-1]
            break
        }

        listeners.cv.Wait()
        continue
    }

    listeners.mx.Unlock()

    //&#x5230;&#x8FD9;&#x91CC;client&#x548C;server&#x5DF2;&#x7ECF;&#x914D;&#x5BF9;.
    server.wq = make(chan *transport.Message) //&#x624D;&#x5EFA;&#x7ACB;server&#x7684;&#x901A;&#x9053;, &#x6CE8;&#x610F;&#x90FD;&#x662F;unbuffer&#x7C7B;&#x578B;&#x7684;
    server.rq = make(chan *transport.Message)
    client.rq = server.wq //client&#x548C;server&#x5171;&#x7528;&#x4E00;&#x4E2A;channel, &#x53EA;&#x662F;&#x65B9;&#x5411;&#x4E0D;&#x4E00;&#x6837;
    client.wq = server.rq
    server.peer = client
    client.peer = server

    close(server.readyq)
    close(client.readyq)
    return client, nil
}
</code></pre>
<h4 id="send&#x548C;recv"><a name="send&#x548C;recv" class="anchor-navigation-ex-anchor" href="#send&#x548C;recv"><i class="fa fa-link" aria-hidden="true"></i></a>Send&#x548C;Recv</h4>
<pre><code class="lang-go">func (p *inproc) Send(m *mangos.Message) error {

    // Upper protocols expect to have to pick header and body part.
    // Also we need to have a fresh copy of the message for receiver, to
    // break ownership.
    nmsg := mangos.NewMessage(len(m.Header) + len(m.Body))
    nmsg.Body = append(nmsg.Body, m.Header...)
    nmsg.Body = append(nmsg.Body, m.Body...) //&#x590D;&#x5236;&#x62A5;&#x6587;, &#x4F46;&#x662F;&#x4E0D;free?
    select {
    case p.wq &lt;- nmsg: //&#x5C31;&#x662F;&#x628A;&#x62F7;&#x8D1D;&#x540E;&#x7684;msg&#x653E;&#x5230;channel&#x91CC;
        return nil
    case &lt;-p.closeq:
        nmsg.Free()
        return mangos.ErrClosed
    case &lt;-p.peer.closeq:
        nmsg.Free()
        return mangos.ErrClosed
    }
}
</code></pre>
<pre><code class="lang-go">func (p *inproc) Recv() (*transport.Message, error) {

    select {
    case m := &lt;-p.rq: //&#x63A5;&#x6536;&#x7684;&#x65F6;&#x5019;&#x4E0D;&#x590D;&#x5236;msg
        return m, nil
    case &lt;-p.closeq:
        return nil, mangos.ErrClosed
    case &lt;-p.peer.closeq:
        return nil, mangos.ErrClosed
    }
}
</code></pre>
<h4 id="&#x603B;&#x7ED3;_2"><a name="&#x603B;&#x7ED3;_2" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;_2"><i class="fa fa-link" aria-hidden="true"></i></a>&#x603B;&#x7ED3;</h4>
<ul>
<li>server&#x548C;client&#x90FD;&#x662F;<code>*inproc</code>&#x7C7B;&#x578B;</li>
<li>Send msg&#x662F;&#x62F7;&#x8D1D;&#x5F0F;&#x7684;.</li>
<li>&#x57FA;&#x4E8E;&#x540D;&#x5B57;&#x67E5;&#x627E;&#x548C;&#x5171;&#x4EAB;channel&#x7684;&#x6D88;&#x606F;&#x4F20;&#x9012;, &#x5F00;&#x9500;&#x6BD4;&#x8F83;&#x5C0F;.</li>
</ul>
<h3 id="transportipc"><a name="transportipc" class="anchor-navigation-ex-anchor" href="#transportipc"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.7. transport/ipc</h3>
<h2 id="internalcore"><a name="internalcore" class="anchor-navigation-ex-anchor" href="#internalcore"><i class="fa fa-link" aria-hidden="true"></i></a>2.3. internal/core</h2>
<h3 id="internalcoresocketgo"><a name="internalcoresocketgo" class="anchor-navigation-ex-anchor" href="#internalcoresocketgo"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.1. internal/core/socket.go</h3>
<h4 id="newdialer&#x548C;newlistener_1"><a name="newdialer&#x548C;newlistener_1" class="anchor-navigation-ex-anchor" href="#newdialer&#x548C;newlistener_1"><i class="fa fa-link" aria-hidden="true"></i></a>NewDialer&#x548C;NewListener</h4>
<p>transport&#x63D0;&#x4F9B;&#x4E86;<code>GetTransport()</code>&#x51FD;&#x6570;&#x4ECE;&#x5168;&#x5C40;map&#x8868;<code>var transports = map[string]Transport{}</code>&#x4E2D;&#x83B7;&#x53D6;&#x5DF2;&#x7ECF;&#x6CE8;&#x518C;&#x7684;transport&#x5DE5;&#x5382;&#x5BF9;&#x8C61;, &#x8BE5;&#x5BF9;&#x8C61;&#x7684;NewDialer&#x548C;NewListener&#x65B9;&#x6CD5;&#x4F1A;&#x65B0;&#x5EFA;&#x8FDE;&#x63A5;.
&#x800C;&#x8FD9;&#x91CC;internal core&#x91CC;&#x9762;, &#x5C31;&#x8C03;&#x7528;&#x4E86;<code>GetTransport()</code>, &#x6839;&#x636E;&#x4F20;&#x5165;&#x7684;string, &#x8FD4;&#x56DE;<code>mangos.Dialer</code>. &#x6CE8;&#x610F;&#x8FD9;&#x4E2A;Dialer&#x5DF2;&#x7ECF;&#x4E0D;&#x662F;transport&#x7684;Dialer&#x4E86;.</p>
<pre><code class="lang-go">func (s *socket) NewDialer(addr string, options map[string]interface{}) (mangos.Dialer, error) {
    t := s.getTransport(addr)
    td, err := t.NewDialer(addr, s) //&#x8C03;&#x7528;transport&#x5C42;&#x7684;NewDialer
    d := &amp;dialer{
        d:             td,
        s:             s,    //&#x5F88;&#x91CD;&#x8981;, dialer&#x4FDD;&#x6301;&#x4E86;&#x8FD9;&#x4E2A;socket&#x7684;&#x4FE1;&#x606F;
        reconnMinTime: s.reconnMinTime,
        reconnMaxTime: s.reconnMaxTime,
        asynch:        s.dialAsynch,
        addr:          addr,
    }
    for n, v := range options {
        //&#x5904;&#x7406;options
        d.SetOption(n, v)
        &#x6216;td.SetOption(n, v)
    }
    s.dialers = append(s.dialers, d) //&#x628A;&#x521A;&#x624D;New&#x7684;dialer&#x5173;&#x8054;&#x5230;socket; socket&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x4E2A;dialer
    return d, nil
}
</code></pre>
<p>&#x4E0A;&#x9762;&#x7684;NewDialer&#x5C31;&#x662F;&#x9876;&#x5C42;API
<code>func (s *socket) Dial(addr string) error</code>&#x6216;<code>func (s *socket) DialOptions(addr string, opts map[string]interface{}) error</code>&#x8C03;&#x7528;&#x4E0B;&#x6765;&#x7684;.</p>
<pre><code class="lang-go">func (s *socket) Dial(addr string) error
    s.DialOptions(addr, nil)
        d, err := s.NewDialer(addr, opts)
        return d.Dial() //&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x5E76;&#x4E0D;&#x662F;transport&#x7684;Dial, &#x800C;&#x662F;&#x5E94;&#x7528;&#x4FA7;&#x7684;dial; &#x5E94;&#x7528;&#x4FA7;&#x7684;dial&#x7B7E;&#x540D;&#x4E0D;&#x540C;, &#x5B83;&#x6CA1;&#x6709;&#x8FD4;&#x56DE;conn
</code></pre>
<p>&#x540C;&#x6837;&#x7684;listen&#x4E5F;&#x662F;&#x7C7B;&#x4F3C;&#x7684;&#x8FC7;&#x7A0B;</p>
<pre><code class="lang-go">socket.ListenOptions &#x6216;socket.Listen
    l := socket.NewListener()
    l.Listen() //&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x5F00;&#x59CB;Listen, &#x8FD9;&#x4E5F;&#x662F;&#x5E94;&#x7528;&#x4FA7;&#x7684;listen, &#x53EA;&#x8FD4;&#x56DE;error
</code></pre>
<p>&#x540E;&#x9762;&#x4F1A;&#x770B;&#x5230;, &#x5E94;&#x7528;&#x4FA7;Dial&#x548C;Listen&#x540E;, conn&#x7684;&#x4FE1;&#x606F;&#x662F;&#x901A;&#x8FC7;socket&#x7684;addPipe&#x65B9;&#x6CD5;&#x6765;&#x4FDD;&#x5B58;&#x7684;.</p>
<h4 id="socket&#x5177;&#x4F53;&#x5B9A;&#x4E49;"><a name="socket&#x5177;&#x4F53;&#x5B9A;&#x4E49;" class="anchor-navigation-ex-anchor" href="#socket&#x5177;&#x4F53;&#x5B9A;&#x4E49;"><i class="fa fa-link" aria-hidden="true"></i></a>socket&#x5177;&#x4F53;&#x5B9A;&#x4E49;</h4>
<p>&#x5728;core&#x770B;&#x8D77;&#x6765;, socket&#x6301;&#x6709;&#x591A;&#x4E2A;listener, &#x591A;&#x4E2A;dialer, &#x4EE5;&#x53CA;&#x771F;&#x6B63;&#x7684;conn(&#x4E5F;&#x5C31;&#x662F;&#x8FD9;&#x91CC;&#x7684;pipeList).</p>
<pre><code class="lang-go">// socket is the meaty part of the core information.
type socket struct {
    proto mangos.ProtocolBase

    sync.Mutex

    closed        bool          // true if Socket was closed at API level
    reconnMinTime time.Duration // reconnect time after error or disconnect
    reconnMaxTime time.Duration // max reconnect interval
    maxRxSize     int           // max recv size
    dialAsynch    bool          // asynchronous dialing?

    listeners []*listener
    dialers   []*dialer
    pipes     pipeList //&#x5B9A;&#x4E49;&#x4E8E;pipe.go
    pipehook  mangos.PipeEventHook //&#x63D0;&#x4F9B;&#x7ED9;app&#x5C42;&#x7684;hook&#x51FD;&#x6570;&#x5165;&#x53E3;
}
</code></pre>
<p>&#x6700;&#x540E;&#x4E00;&#x4E2A;hook&#x518D;&#x8BE6;&#x7EC6;&#x770B;&#x4E00;&#x4E0B;: &#x5728;socket&#x7684;pipe&#x4E2D;&#x67A2;&#x7CFB;&#x7EDF;&#x53D1;&#x751F;&#x53D8;&#x5316;&#x65F6;, &#x8C03;&#x7528;&#x8FD9;&#x4E2A;hook.</p>
<pre><code class="lang-go">const (
    // PipeEventAttaching is called before the Pipe is registered with the
    // socket.  The intention is to permit the application to reject
    // a pipe before it is attached.
    PipeEventAttaching = iota

    // PipeEventAttached occurs after the Pipe is attached.
    // Consequently, it is possible to use the Pipe for delivering
    // events to sockets, etc.
    PipeEventAttached

    // PipeEventDetached occurs after the Pipe has been detached
    // from the socket.
    PipeEventDetached
)
</code></pre>
<p>&#x6362;&#x7B97;&#x6210;y&#x7684;&#x8BF4;&#x6CD5;&#x5C31;&#x662F;. onConnect, onDisconnect.</p>
<h4 id="&#x6838;&#x5FC3;&#x52A8;&#x4F5C;-addpipe"><a name="&#x6838;&#x5FC3;&#x52A8;&#x4F5C;-addpipe" class="anchor-navigation-ex-anchor" href="#&#x6838;&#x5FC3;&#x52A8;&#x4F5C;-addpipe"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6838;&#x5FC3;&#x52A8;&#x4F5C;: addPipe</h4>
<blockquote>
<p>  // AddPipe is called when a new Pipe is added to the socket.
    // Typically this is as a result of connect or accept completing.
    // The pipe ID will be unique for the socket at this time.
    // The implementation must not call back into the socket, but it
    // may reject the pipe by returning a non-nil result.
    &#x5C31;&#x662F;&#x8BF4;&#x6BCF;&#x5F53;&#x6709;&#x8FDE;&#x63A5;&#x7684;&#x65F6;&#x5019;, &#x5C31;&#x4F1A;addPipe</p>
</blockquote>
<pre><code class="lang-go">func (s *socket) addPipe(tp transport.Pipe, d *dialer, l *listener) 
    p := newPipe(tp, s, d, l)
    s.pipes.Add(p)
    ph(mangos.PipeEventAttaching, p) //&#x8C03;&#x7528;hook
    s.proto.AddPipe(p) //&#x8FD9;&#x4E2A;pipe&#x4E5F;&#x4F1A;&#x88AB;add&#x5230;ProtocolBase
    ph(mangos.PipeEventAttached, p) //&#x8C03;&#x7528;hook
</code></pre>
<p>&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x7684;&#x8FD9;&#x53E5;&#x4EE3;&#x7801;&#x6709;&#x5B66;&#x95EE;:
<code>s.proto.AddPipe(p)</code></p>
<ul>
<li><code>p</code>&#x662F;&#x4E2A;<code>*core.pipe</code>&#x7C7B;&#x578B;, &#x672C;&#x8EAB;&#x662F;&#x5C0F;&#x5199;&#x7684;, &#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x88AB;&#x5916;&#x90E8;&#x4F7F;&#x7528;. &#x4F46;&#x8FD9;&#x91CC;&#x8C03;&#x7528;protocol&#x7684;&#x63A5;&#x53E3;&#x51FD;&#x6570;:
<code>AddPipe(p)</code>, &#x628A;<code>p</code>&#x5F53;&#x4F5C;<code>ProtocolPipe</code>&#x6765;&#x770B;, &#x5C31;&#x628A;pipe&#x7684;&quot;&#x80FD;&#x529B;&quot;&#x8F93;&#x51FA;&#x4E86;.</li>
<li>&#x8FD9;&#x91CC;&#x7684;s.proto&#x662F;mangos.ProtocolBase, &#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x6BCF;&#x4E2A;protocol&#x7684;&#x5B9E;&#x73B0;&#x8005;&#x7684;socket&#x5BF9;&#x8C61;. &#x6BD4;&#x5982;req.socket</li>
<li>&#x8981;&#x8F93;&#x51FA;&#x80FD;&#x529B;, &#x4E0D;&#x4E00;&#x5B9A;&#x8981;&#x81EA;&#x5DF1;&#x58F0;&#x660E;; &#x8C03;&#x7528;&#x522B;&#x4EBA;&#x7684;&#x63A5;&#x53E3;, &#x628A;&#x81EA;&#x5DF1;&#x5305;&#x88C5;&#x51FA;&#x53BB;&#x4E5F;&#x53EF;&#x4EE5;.</li>
</ul>
<h4 id="send&#x548C;recv_1"><a name="send&#x548C;recv_1" class="anchor-navigation-ex-anchor" href="#send&#x548C;recv_1"><i class="fa fa-link" aria-hidden="true"></i></a>send&#x548C;recv</h4>
<p>socket&#x7684;&#x91CD;&#x5934;&#x620F;, &#x8FD9;&#x662F;&#x6838;&#x5FC3;&#x5C42;&#x7684;&#x5BF9;&#x7528;&#x6237;&#x5C42;API&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x7684;&#x5730;&#x65B9;:</p>
<pre><code class="lang-go">func (s *socket) SendMsg(msg *Message) error {
    return s.proto.SendMsg(msg) //&#x4E0D;&#x8981;&#x56F0;&#x60D1; &#x8FD9;&#x91CC;&#x8FD8;&#x6CA1;&#x5230;transport. &#x8FD9;&#x91CC;&#x7684;send&#x9700;&#x8981;protocol&#x6765;&#x51B3;&#x5B9A;&#x53D1;&#x9001;&#x7ED9;&#x8C01;, &#x600E;&#x4E48;&#x53D1;. &#x6240;&#x4EE5;&#x8981;&#x7528;s.proto&#x5BF9;&#x8C61;&#x6765;send.
}

func (s *socket) Send(b []byte) error {
    msg := mangos.NewMessage(len(b))
    msg.Body = append(msg.Body, b...) //&#x8FD9;&#x91CC;&#x6253;&#x6563;&#x518D;&#x62FC;&#x63A5;&#x6027;&#x80FD;&#x4F1A;&#x4E0D;&#x4F1A;&#x6709;&#x95EE;&#x9898;? &#x4E0D;&#x7528;&#x4E2A;bytes.Buffer&#x5565;&#x7684;? &#x770B;&#x8FD9;&#x91CC;&#x7684;&#x60C5;&#x51B5;&#x662F;&#x62F7;&#x8D1D;&#x53D1;&#x9001;. &#x8FD9;&#x91CC;https://gist.github.com/xogeny/b819af6a0cf8ba1caaef&#x4F3C;&#x4E4E;&#x662F;&#x8BF4;copy&#x548C;append&#x6027;&#x80FD;&#x5DEE;&#x4E0D;&#x591A;
    return s.SendMsg(msg)
}

func (s *socket) RecvMsg() (*Message, error) {
    return s.proto.RecvMsg()
}

func (s *socket) Recv() ([]byte, error) {
    msg, err := s.RecvMsg()
    if err != nil {
        return nil, err
    }
    b := make([]byte, 0, len(msg.Body)) //&#x8FD4;&#x56DE;&#x65B0;buffer&#x800C;&#x4E0D;&#x662F;transport&#x4FA7;&#x5E95;&#x5C42;&#x7684;buffer; &#x800C;&#x4E14;&#x662F;&#x53BB;&#x4E86;&#x5934;&#x7684;; &#x800C;&#x4E14;&#x8FD9;&#x4E2A;buffer&#x662F;&#x76F4;&#x63A5;make&#x51FA;&#x6765;&#x7684;, &#x4E0D;&#x662F;&#x7528;&#x7684;pool&#x7684;buffer.
    b = append(b, msg.Body...)
    msg.Free() //&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x7684;Free&#x662F;&#x8FD4;&#x8FD8;&#x7ED9;pool
    return b, nil
}
</code></pre>
<h3 id="internalcorepipego"><a name="internalcorepipego" class="anchor-navigation-ex-anchor" href="#internalcorepipego"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.2. internal/core/pipe.go</h3>
<p>&#x8FD9;&#x91CC;&#x7684;pipe&#x5B9E;&#x73B0;&#x4E86;&#x591A;&#x4E2A;&#x63A5;&#x53E3;:</p>
<ul>
<li><p>pipe.go.Pipe&#x63A5;&#x53E3;, &#x6682;&#x65F6;&#x4E0D;&#x77E5;&#x9053;&#x54EA;&#x91CC;&#x7528;&#x4E86;</p>
<pre><code class="lang-go">// Pipe represents the high level interface to a low level communications
// channel.  There is one of these associated with a given TCP connection,
// for example.  This interface is intended for application use.
//
// Note that applications cannot send or receive data on a Pipe directly.
type Pipe interface {

  // ID returns the numeric ID for this Pipe.  This will be a
  // 31 bit (bit 32 is clear) value for the Pipe, which is unique
  // across all other Pipe instances in the application, while
  // this Pipe exists.  (IDs are recycled on Close, but only after
  // all other Pipe values are used.)
  ID() uint32

  // Address returns the address (URL form) associated with the Pipe.
  // This matches the string passed to Dial() or Listen().
  Address() string

  // GetOption returns an arbitrary option.  The details will vary
  // for different transport types.
  GetOption(name string) (interface{}, error)

  // Listener returns the Listener for this Pipe, or nil if none.
  Listener() Listener

  // Dialer returns the Dialer for this Pipe, or nil if none.
  Dialer() Dialer

  // Close closes the Pipe.  This does a disconnect, or something similar.
  // Note that if a dialer is present and active, it will redial.
  Close() error
}
</code></pre>
</li>
<li><p>protocol.go.ProtocolPipe&#x63A5;&#x53E3;, &#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#x88AB;protocol&#x7684;&#x5B9E;&#x73B0;&#x8005;&#x4F7F;&#x7528;. &#x5177;&#x4F53;&#x6765;&#x8BB2;, &#x5728;protocol&#x7684;&#x5B9E;&#x73B0;&#x5B9E;&#x4F8B;&#x7684;AddPipe()&#x88AB;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;, ProtocolPipe&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#x4F1A;&#x88AB;&#x4F20;&#x5165;.</p>
<pre><code class="lang-go">// ProtocolPipe represents the handle that a Protocol implementation has
// to the underlying stream transport.  It can be thought of as one side
// of a TCP, IPC, or other type of connection.
type ProtocolPipe interface {
  // ID returns a unique 31-bit value associated with this.
  // The value is unique for a given socket, at a given time.
  ID() uint32

  // Close does what you think.
  Close() error

  // SendMsg sends a message.  On success it returns nil. This is a
  // blocking call.
  SendMsg(*Message) error

  // RecvMsg receives a message.  It blocks until the message is
  // received.  On error, the pipe is closed and nil is returned.
  RecvMsg() *Message

  // SetPrivate is used to set protocol private data.
  SetPrivate(interface{})

  // GetPrivate returns the previously stored protocol private data.
  GetPrivate() interface{}
}
</code></pre>
</li>
</ul>
<h4 id="pipe&#x5B9A;&#x4E49;"><a name="pipe&#x5B9A;&#x4E49;" class="anchor-navigation-ex-anchor" href="#pipe&#x5B9A;&#x4E49;"><i class="fa fa-link" aria-hidden="true"></i></a>pipe&#x5B9A;&#x4E49;</h4>
<p>&#x5728;core&#x770B;&#x8D77;&#x6765;, pipe&#x7684;&#x4FE1;&#x606F;&#x5F88;&#x4E30;&#x5BCC;: &#x5B83;&#x6BEB;&#x65E0;&#x7591;&#x95EE;&#x7684;&#x6301;&#x6709;&#x5E95;&#x5C42;transport&#x7684;pipe&#x5BF9;&#x8C61;, &#x540C;&#x65F6;&#x5B83;&#x8FD8;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;pipe&#x7684;listender&#x548C;dialer, &#x5373;&#x77E5;&#x9053;&#x5BF9;&#x7AEF;&#x548C;&#x81EA;&#x5DF1;&#x7684;&#x4FE1;&#x606F;. &#x5B83;&#x8FD8;&#x6301;&#x6709;socket&#x5BF9;&#x8C61;, &#x77E5;&#x9053;app&#x5C42;&#x7684;&#x60F3;&#x6CD5;.<br>&#x603B;&#x7ED3;: pipe&#x662F;&#x4E2A;&#x4E2D;&#x67A2;.</p>
<pre><code class="lang-go">// pipe wraps the Pipe data structure with the stuff we need to keep
// for the core.  It implements the Pipe interface.
type pipe struct {
    id        uint32
    p         transport.Pipe
    l         *listener
    d         *dialer
    s         *socket
    closeOnce sync.Once
    data      interface{} // Protocol private
    added     bool
    closing   bool
    lock      sync.Mutex // held across calls to remPipe and addPipe
}
</code></pre>
<h4 id="pipelist"><a name="pipelist" class="anchor-navigation-ex-anchor" href="#pipelist"><i class="fa fa-link" aria-hidden="true"></i></a>pipeList</h4>
<p>pipeList&#x662F;&#x4E2A;map, &#x4FDD;&#x5B58;&#x4E86;&#x6240;&#x6709;&#x7684;pipe&#x5B9E;&#x4F8B;, &#x6BCF;&#x4E2A;pipe&#x5B9E;&#x4F8B;&#x6709;&#x4E2A;&#x72EC;&#x7279;&#x7684;uint32 ID</p>
<pre><code class="lang-go">type pipeList struct {
    pipes map[uint32]*pipe
    lock  sync.Mutex
}
</code></pre>
<h4 id="addpipe&#x548C;id&#x751F;&#x6210;"><a name="addpipe&#x548C;id&#x751F;&#x6210;" class="anchor-navigation-ex-anchor" href="#addpipe&#x548C;id&#x751F;&#x6210;"><i class="fa fa-link" aria-hidden="true"></i></a>addPipe&#x548C;ID&#x751F;&#x6210;</h4>
<p>socket&#x4E2D;&#x8C03;&#x7528;addPipe&#x4F1A;&#x65B0;&#x751F;&#x6210;&#x4E00;&#x4E2A;uint32 ID, &#x4ECE;&#x968F;&#x673A;&#x6570;&#x5F00;&#x59CB;, &#x5168;&#x5C40;&#x552F;&#x4E00;.
&#x539F;&#x7406;&#x662F;&#x5728;&#x5168;&#x5C40;&#x8868;<code>map[uint32]struct{}</code>&#x4E2D;, &#x4F9D;&#x6B21;&#x627E;&#x4E2A;&#x6CA1;&#x88AB;&#x4F7F;&#x7528;&#x7684;ID.
&#x662F;&#x7684;, ID&#x88AB;&#x4F7F;&#x7528;&#x5B8C;&#x4E86;&#x8FD8;&#x4F1A;&#x8FD8;&#x5230;&#x8FD9;&#x4E2A;map&#x91CC;.
&#x771F;&#x6B63;&#x7684;add&#x662F;&#x8C03;&#x7528;Add&#x628A;p&#x6309;&#x7167;p.id</p>
<pre><code class="lang-go">func (l *pipeList) Add(p *pipe) {
    l.lock.Lock()
    if l.pipes == nil {
        l.pipes = make(map[uint32]*pipe)
    }
    l.pipes[p.id] = p
    l.lock.Unlock()
}
</code></pre>
<h4 id="pipe&#x7684;send&#x548C;recv"><a name="pipe&#x7684;send&#x548C;recv" class="anchor-navigation-ex-anchor" href="#pipe&#x7684;send&#x548C;recv"><i class="fa fa-link" aria-hidden="true"></i></a>pipe&#x7684;send&#x548C;recv</h4>
<p>pipe&#x662F;&#x539F;&#x59CB;conn&#x7684;&#x5C01;&#x88C5;, &#x6240;&#x4EE5;send recv&#x90FD;&#x662F;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x5E95;&#x5C42;transport&#x7684;&#x63A5;&#x53E3;; &#x6240;&#x4EE5;&#x5230;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x662F;&#x5E94;&#x7528;&#x4FA7;&#x7684;&#x53D1;&#x9001;&#x63A5;&#x6536;&#x4E86;.</p>
<pre><code class="lang-go">func (p *pipe) SendMsg(msg *mangos.Message) error {

    if err := p.p.Send(msg); err != nil {
        _ = p.Close()
        return err
    }
    return nil
}

func (p *pipe) RecvMsg() *mangos.Message {

    msg, err := p.p.Recv()
    if err != nil {
        _ = p.Close() //API&#x5B9A;&#x4E49;&#x7684;&#x5F88;&#x660E;&#x767D;, &#x5982;&#x679C;&#x5E95;&#x5C42;Recv&#x8FD4;&#x56DE;&#x9519;&#x8BEF;, &#x5C31;close&#x6389;&#x8FD9;&#x4E2A;pipe
        return nil
    }
    msg.Pipe = p //&#x8FD9;&#x91CC;&#x503C;&#x5F97;&#x6CE8;&#x610F;, &#x4ECE;msg&#x91CC;&#x80FD;&#x591F;&#x62FF;&#x5230;pipe&#x7684;&#x4FE1;&#x606F;, &#x8FDB;&#x800C;&#x80FD;&#x62FF;&#x5230;&#x6240;&#x6709;&#x4FE1;&#x606F;. &#x4F46;&#x4E0D;&#x4FDD;&#x8BC1;&#x5230;msg&#x7684;&#x5904;&#x7406;&#x7684;&#x65F6;&#x5019;, pipe&#x8FD8;&#x5728;.
    return msg
}
</code></pre>
<h4 id="&#x4E3A;&#x4EC0;&#x4E48;&#x5E95;&#x5C42;send&#x6216;&#x8005;recv&#x5931;&#x8D25;&#x8981;close&#x6389;pipe"><a name="&#x4E3A;&#x4EC0;&#x4E48;&#x5E95;&#x5C42;send&#x6216;&#x8005;recv&#x5931;&#x8D25;&#x8981;close&#x6389;pipe" class="anchor-navigation-ex-anchor" href="#&#x4E3A;&#x4EC0;&#x4E48;&#x5E95;&#x5C42;send&#x6216;&#x8005;recv&#x5931;&#x8D25;&#x8981;close&#x6389;pipe"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4E3A;&#x4EC0;&#x4E48;&#x5E95;&#x5C42;send&#x6216;&#x8005;recv&#x5931;&#x8D25;&#x8981;close&#x6389;pipe?</h4>
<p>&#x90A3;&#x540E;&#x9762;&#x8FD8;&#x600E;&#x4E48;&#x6574;?<br>&#x800C;&#x4E14;&#x5728;close&#x4E2D;, &#x4F1A;&#x5F7B;&#x5E95;&#x5173;&#x95ED;transport&#x5C42;&#x7684;&#x8FDE;&#x63A5;</p>
<pre><code class="lang-go">func (p *pipe) Close() error {
    p.closeOnce.Do(func() {
        // Close the underlying transport pipe first.
        _ = p.p.Close()

        // Deregister it from the socket.  This will also arrange
        // for asynchronously running the event callback, and
        // releasing the pipe ID for reuse.
        p.lock.Lock()
        p.closing = true
        if p.added {
            p.s.remPipe(p)
        }
        p.lock.Unlock()

        if p.d != nil {
            // Inform the dialer so that it will redial.
            go p.d.pipeClosed() //&#x8FD9;&#x91CC;&#x503C;&#x5F97;&#x5173;&#x6CE8;, &#x91CC;&#x9762;&#x4F1A;&#x5EF6;&#x8FDF;&#x8C03;&#x7528;redial&#x51FD;&#x6570;&#x91CD;&#x65B0;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;, redial&#x4F1A;&#x4E0D;&#x65AD;&#x91CD;&#x8BD5;.
        }
    })
    return nil
}
</code></pre>
<p>&#x6240;&#x4EE5;&#x56DE;&#x7B54;&#x4E0A;&#x9762;&#x7684;&#x95EE;&#x9898;, &#x53D1;&#x9001;&#x6216;&#x8005;&#x63A5;&#x6536;&#x5931;&#x8D25;&#x90FD;&#x4F1A;close&#x6389;&#x8FDE;&#x63A5;. &#x4F46;close&#x7684;&#x6D41;&#x7A0B;&#x6700;&#x540E;&#x542F;&#x52A8;&#x4E86;redial&#x6D41;&#x7A0B;.<br>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;, &#x6BD4;&#x5982;&#x53D1;&#x9001;&#x5931;&#x8D25;&#x7684;&#x60C5;&#x51B5;&#x4E0B;, mangos&#x5E76;&#x4E0D;&#x662F;&#x76F4;&#x63A5;&#x91CD;&#x65B0;&#x518D;send&#x4E00;&#x6B21;, &#x800C;&#x662F;&#x628A;&#x6574;&#x4E2A;&#x8FDE;&#x63A5;&#x90FD;&#x5173;&#x6389;, &#x518D;&#x91CD;&#x65B0;&#x5EFA;&#x7ACB;&#x65B0;&#x8FDE;&#x63A5;&#x6765;&#x91CD;&#x53D1;.</p>
<h4 id="&#x643A;&#x5E26;&#x989D;&#x5916;&#x6570;&#x636E;&#x7684;&#x5178;&#x578B;&#x6A21;&#x5F0F;-setprivate"><a name="&#x643A;&#x5E26;&#x989D;&#x5916;&#x6570;&#x636E;&#x7684;&#x5178;&#x578B;&#x6A21;&#x5F0F;-setprivate" class="anchor-navigation-ex-anchor" href="#&#x643A;&#x5E26;&#x989D;&#x5916;&#x6570;&#x636E;&#x7684;&#x5178;&#x578B;&#x6A21;&#x5F0F;-setprivate"><i class="fa fa-link" aria-hidden="true"></i></a>&#x643A;&#x5E26;&#x989D;&#x5916;&#x6570;&#x636E;&#x7684;&#x5178;&#x578B;&#x6A21;&#x5F0F;: SetPrivate</h4>
<p>&#x4F7F;&#x7528;&#x4E07;&#x80FD;&#x7684;interface&#x505A;&#x4E3A;&#x8F93;&#x5165;</p>
<pre><code class="lang-go">func (p *pipe) SetPrivate(i interface{}) {
    p.data = i
}

func (p *pipe) GetPrivate() interface{} {
    return p.data
}
</code></pre>
<h3 id="internalcoredialergo"><a name="internalcoredialergo" class="anchor-navigation-ex-anchor" href="#internalcoredialergo"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.3. internal/core/dialer.go</h3>
<p>&#x5728;socket.go&#x91CC;, NewDialer&#x5C31;&#x662F;new&#x7684;&#x4E0B;&#x9762;&#x7684;dialer</p>
<pre><code class="lang-go">type dialer struct {
    sync.Mutex
    d             transport.Dialer
    s             *socket
    addr          string
    closed        bool
    active        bool
    asynch        bool
    redialer      *time.Timer
    reconnTime    time.Duration
    reconnMinTime time.Duration
    reconnMaxTime time.Duration
    closeq        chan struct{}
}
</code></pre>
<p>dial&#x6D41;&#x7A0B;</p>
<pre><code class="lang-go">func (d *dialer) Dial() error {
    d.Lock()
    if d.active {
        d.Unlock()
        return mangos.ErrAddrInUse
    }
    if d.closed {
        d.Unlock()
        return mangos.ErrClosed
    }
    d.closeq = make(chan struct{})
    d.active = true
    d.reconnTime = d.reconnMinTime
    if d.asynch {
        go d.redial()
        d.Unlock()
        return nil
    }
    d.Unlock()
    return d.dial(false) //&#x5C31;&#x662F;&#x4E0B;&#x9762;&#x7684;dial&#x51FD;&#x6570;
}

func (d *dialer) dial(redial bool) error {
    d.Lock()
    if d.closed {
        d.Unlock()
        return errors.ErrClosed
    }
    if d.asynch {
        redial = true
    }
    d.Unlock()

    p, err := d.d.Dial()
    if err == nil {
        d.s.addPipe(p, d, nil) //dial&#x6210;&#x529F;&#x4E86;&#x5C31;addPipe&#x5230;socket
        return nil
    }

    //&#x5230;&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x4E0D;&#x6210;&#x529F;, &#x9700;&#x8981;&#x91CD;&#x8BD5;
    d.Lock()
    defer d.Unlock()

    // We&apos;re no longer dialing, so let another reschedule happen, if
    // appropriate.   This is quite possibly paranoia.  We should only
    // be in this routine in the following circumstances:
    //
    // 1. Initial dialing (via Dial())
    // 2. After a previously created pipe fails and is closed due to error.
    // 3. After timing out from a failed connection attempt.

    //&#x6CA1;&#x8BA9;&#x4F60;&#x91CD;&#x8BD5;&#x5C31;&#x8FD4;&#x56DE;
    if !redial {
        return err
    }
    switch err {
    case mangos.ErrClosed: //&#x5BF9;&#x7AEF;&#x4E0D;&#x7ED9;&#x8FDE;
        // Stop redialing, no further action.

    default: //&#x7F13;&#x542F;&#x52A8;&#x903B;&#x8F91;
        // Exponential backoff, and jitter.  Our backoff grows at
        // about 1.3x on average, so we don&apos;t penalize a failed
        // connection too badly.
        minfact := float64(1.1)
        maxfact := float64(1.5)
        actfact := rand.Float64()*(maxfact-minfact) + minfact
        rtime := d.reconnTime
        if d.reconnMaxTime != 0 {
            d.reconnTime = time.Duration(actfact * float64(d.reconnTime))
            if d.reconnTime &gt; d.reconnMaxTime {
                d.reconnTime = d.reconnMaxTime
            }
        }
        d.redialer = time.AfterFunc(rtime, d.redial) //AfterFunc&#x4F1A;&#x542F;&#x52A8;&#x4E00;&#x4E2A;goroutine&#x6765;&#x5EF6;&#x8FDF;&#x6267;&#x884C;d.redial; &#x8FD9;&#x91CC;&#x8FD8;&#x7528;&#x4E86;&#x7ECF;&#x5178;&#x7684; &#x65B9;&#x6CD5;&#x8F6C;&#x51FD;&#x6570;&#x7684;&#x7F16;&#x8BD1;&#x5668;&#x9ED1;&#x79D1;&#x6280;
    }
    return err
}

func (d *dialer) redial() {
    _ = d.dial(true)
}
</code></pre>
<p>&#x603B;&#x7684;&#x6765;&#x8BF4;, dialer&#x5B9E;&#x73B0;&#x4E86;&#x5BF9;&#x5E95;&#x5C42;transport&#x7684;dail, &#x652F;&#x6301;&#x540E;&#x53F0;redial, &#x652F;&#x6301;dail&#x5931;&#x8D25;&#x91CD;&#x8BD5;(&#x4E0D;&#x662F;&#x9A6C;&#x4E0A;, &#x800C;&#x662F;&#x5E26;&#x7F13;&#x542F;&#x52A8;&#x7684;&#x91CD;&#x8BD5;); &#x652F;&#x6301;&#x591A;&#x79CD;option:</p>
<ul>
<li>OptionReconnectTime</li>
<li>OptionMaxReconnectTime</li>
<li>OptionDialAsynch</li>
</ul>
<h3 id="internalcorelistenergo"><a name="internalcorelistenergo" class="anchor-navigation-ex-anchor" href="#internalcorelistenergo"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.4. internal/core/listener.go</h3>
<p>listener&#x662F;&#x5BF9;transport&#x7684;listener&#x7684;&#x7B80;&#x5355;&#x5305;&#x88C5;</p>
<pre><code class="lang-go">type listener struct {
    sync.Mutex
    l      transport.Listener
    s      *socket
    addr   string
    closed bool
    active bool
}
</code></pre>
<p>Listen&#x5148;&#x67E5;&#x770B;&#x72B6;&#x6001;, &#x518D;&#x8C03;&#x7528;transport&#x7684;Listen.</p>
<pre><code class="lang-go">func (l *listener) Listen() error {
    // This function sets up a goroutine to accept inbound connections.
    // The accepted connection will be added to a list of accepted
    // connections.  The Listener just needs to listen continuously,
    // as we assume that we want to continue to receive inbound
    // connections without limit.

    l.Lock()
    if l.closed {
        l.Unlock()
        return mangos.ErrClosed
    }
    if l.active {
        l.Unlock()
        return mangos.ErrAddrInUse
    }
    l.active = true
    l.Unlock()
    if err := l.l.Listen(); err != nil {
        l.Lock()
        l.active = false
        l.Unlock()
        return err
    }

    go l.serve() //serve()&#x51FD;&#x6570;&#x624D;&#x662F;&#x4E0D;&#x65AD;&#x7684;&#x5728;&#x5FAA;&#x73AF;&#x91CC;Accept&#x8FDE;&#x63A5;&#x7684;&#x4E3B;&#x4F53;
    return nil
}
</code></pre>
<p>server()&#x51FD;&#x6570;&#x662F;&#x88AB;go&#x7684;</p>
<pre><code class="lang-go">// serve spins in a loop, calling the accepter&apos;s Accept routine.
func (l *listener) serve() {
    for {
        l.Lock()
        if l.closed {
            l.Unlock()
            break
        }
        l.Unlock()

        // If the underlying PipeListener is closed, or not
        // listening, we expect to return back with an error.
        if tp, err := l.l.Accept(); err == mangos.ErrClosed {
            return
        } else if err == nil {
            l.s.addPipe(tp, nil, l) //&#x628A;&#x63E1;&#x624B;&#x540E;&#x7684;tranPipe&#x52A0;&#x5165;socket.
        } else {
            // Debounce a little bit, to avoid thrashing the CPU.
            time.Sleep(time.Second / 100)
        }
    }
}
</code></pre>
<h3 id="&#x603B;&#x7ED3;_3"><a name="&#x603B;&#x7ED3;_3" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;_3"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.5. &#x603B;&#x7ED3;</h3>
<p>core&#x7684;&#x6838;&#x5FC3;&#x662F;pipe. &#x5B83;&#x627F;&#x4E0A;&#x542F;&#x4E0B;</p>
<ul>
<li>&#x4E0A;&#x9762;&#x7684;socket&#x8D1F;&#x8D23;&#x7B26;&#x5408;app&#x7684;&#x60F3;&#x8C61;, socket&#x7684;send&#x548C;recv&#x90FD;&#x8981;&#x6309;&#x7167;protocol&#x7684;&#x5957;&#x8DEF;&#x6765;&#x6574;, &#x6BD4;&#x5982;&#x591A;&#x64AD;&#x5565;&#x7684;</li>
<li>&#x4E0B;&#x9762;&#x7684;dialer&#x548C;listener&#x5BF9;&#x4E0B;&#x5BF9;&#x63A5;transport&#x7684;dialer&#x548C;listener, &#x63D0;&#x4F9B;&#x4E86;&#x989D;&#x5916;&#x7684;&#x91CD;&#x8BD5;&#x8FDE;&#x63A5;, &#x540E;&#x53F0;&#x8FDE;&#x63A5;, routine&#x5316;accpet&#x7B49;&#x529F;&#x80FD;.</li>
<li>dialer&#x548C;listener&#x6210;&#x529F;&#x8FD4;&#x56DE;&#x7684;&#x8FDE;&#x63A5;, &#x88AB;&#x5305;&#x88C5;&#x6210;pipe, add&#x5230;socket&#x91CC;. &#x6838;&#x5FC3;&#x662F;
<code>func (s *socket) addPipe(tp transport.Pipe, d *dialer, l *listener)</code><ul>
<li>&#x5BF9;dialer&#x6765;&#x8BF4;, &#x4F1A;&#x8FD9;&#x6837;&#x8C03;&#x7528;<code>d.s.addPipe(p, d, nil)</code></li>
<li>&#x5BF9;listener&#x6765;&#x8BF4;, &#x4F1A;&#x8FD9;&#x6837;&#x8C03;&#x7528;<code>l.s.addPipe(tp, nil, l)</code></li>
<li>&#x6700;&#x7EC8;&#x90FD;&#x662F;add&#x5230;socket&#x7684;pipes&#x4E2D;, &#x8FD9;&#x662F;&#x4E2A;&#x6309;ID&#x7D22;&#x5F15;&#x7684;pipe&#x8868; <code>map[uint32]*pipe</code></li>
</ul>
</li>
</ul>
<h2 id="protocol"><a name="protocol" class="anchor-navigation-ex-anchor" href="#protocol"><i class="fa fa-link" aria-hidden="true"></i></a>2.4. protocol</h2>
<p>protocol&#x662F;&#x9AD8;&#x4E8E;socket&#x5C42;&#x7684;&#x62BD;&#x8C61;, &#x662F;socket&#x7684;&#x573A;&#x666F;&#x5316;&#x6A21;&#x5F0F;&#x7684;&#x5F52;&#x7EB3;, &#x7EE7;&#x627F;&#x81EA;zeroMQ. &#x76EE;&#x524D;&#x652F;&#x6301;</p>
<ul>
<li>bus</li>
<li>pair</li>
<li>pub/sub</li>
<li>pull/push</li>
<li>req/rep</li>
<li>star</li>
<li>&#x4EE5;&#x53CA;&#x4EE5;&#x4E0A;&#x5E26;x&#x7248;&#x672C;&#x7684;.</li>
</ul>
<p>&#x4E0B;&#x9762;&#x4ECE;&#x6700;&#x57FA;&#x672C;&#x7684;req/rep&#x5F00;&#x59CB;, &#x770B;&#x770B;protocol&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x7684;</p>
<h3 id="protocolreqreqgo"><a name="protocolreqreqgo" class="anchor-navigation-ex-anchor" href="#protocolreqreqgo"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.1. protocol/req/req.go</h3>
<p>&#x6BCF;&#x4E2A;protocol&#x90FD;&#x6709;&#x7EDF;&#x4E00;&#x7684;&#x534F;&#x8BAE;&#x7F16;&#x53F7;, req/rep&#x7684;&#x5927;&#x534F;&#x8BAE;&#x53F7;&#x4E00;&#x6837;, &#x540E;&#x56DB;&#x4F4D;&#x5C0F;&#x534F;&#x8BAE;&#x53F7;&#x4E0D;&#x540C;</p>
<pre><code class="lang-go">// Protocol identity information.
const (
    Self     = protocol.ProtoReq //48
    Peer     = protocol.ProtoRep //49
    SelfName = &quot;req&quot;
    PeerName = &quot;rep&quot;
)
</code></pre>
<p>req.go&#x53EA;&#x4F9D;&#x8D56;protocol&#x5305;, &#x5B83;&#x5BF9;core&#x5305;&#x662F;&#x65E0;&#x611F;&#x77E5;&#x7684;.&#x6240;&#x4EE5;&#x867D;&#x7136;core.pipe&#x662F;&#x552F;&#x4E00;&#x7684;mangos.ProtocolPipe&#x5B9E;&#x73B0;&#x8005;, &#x4F46;core.pipe&#x4E5F;&#x662F;&#x5C0F;&#x5199;, &#x800C;&#x4E14;req.go&#x4E5F;&#x4E0D;&#x5F15;&#x7528;core, &#x90A3;&#x600E;&#x4E48;&#x5B9E;&#x4F8B;&#x5316;mangos.ProtocolPipe&#x7684;?</p>
<h4 id="&#x6838;&#x5FC3;&#x7ED3;&#x6784;&#x4F53;&#x5B9A;&#x4E49;"><a name="&#x6838;&#x5FC3;&#x7ED3;&#x6784;&#x4F53;&#x5B9A;&#x4E49;" class="anchor-navigation-ex-anchor" href="#&#x6838;&#x5FC3;&#x7ED3;&#x6784;&#x4F53;&#x5B9A;&#x4E49;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6838;&#x5FC3;&#x7ED3;&#x6784;&#x4F53;&#x5B9A;&#x4E49;</h4>
<p>req&#x7684;socket&#x6838;&#x5FC3;&#x5F53;&#x7136;&#x662F;socket&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x4F8B;:</p>
<pre><code class="lang-go">type socket struct {
    sync.Mutex
    defCtx  *context              // default context
    ctxs    map[*context]struct{} // all contexts (set)
    ctxByID map[uint32]*context   // contexts by request ID
    nextID  uint32                // next request ID
    closed  bool                  // true if we are closed
    sendq   []*context            // contexts waiting to send
    readyq  []*pipe               // pipes available for sending
}
</code></pre>
<p>socket&#x6301;&#x6709;&#x7684;context&#x548C;pipe&#x5728;&#x672C;&#x6587;&#x4EF6;&#x5B9A;&#x4E49;:</p>
<pre><code class="lang-go">type pipe struct {
    p      protocol.Pipe
    s      *socket //&#x53CD;&#x5411;&#x6301;&#x6709;socket
    closed bool
}

type context struct {
    s          *socket //&#x53CD;&#x5411;&#x6301;&#x6709;socket
    cond       *sync.Cond
    resendTime time.Duration     // tunable resend time
    sendExpire time.Duration     // how long to wait in send
    recvExpire time.Duration     // how long to wait in recv
    sendTimer  *time.Timer       // send timer
    recvTimer  *time.Timer       // recv timer
    resender   *time.Timer       // resend timeout
    reqMsg     *protocol.Message // message for transmit
    repMsg     *protocol.Message // received reply
    sendMsg    *protocol.Message // messaging waiting for send
    lastPipe   *pipe             // last pipe used for transmit
    reqID      uint32            // request ID
    recvWait   bool              // true if a thread is blocked in RecvMsg
    bestEffort bool              // if true, don&apos;t block waiting in send
    queued     bool              // true if we need to send a message
    closed     bool              // true if we are closed
}
</code></pre>
<h4 id="&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x6709;context"><a name="&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x6709;context" class="anchor-navigation-ex-anchor" href="#&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x6709;context"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x6709;context?</h4>
<p>&#x56E0;&#x4E3A;socket&#x7684;SendMsg, RecvMsg&#x90FD;&#x4F9D;&#x8D56;context&#x53D1;&#x9001;</p>
<pre><code class="lang-go">func (s *socket) SendMsg(m *protocol.Message) error {
    return s.defCtx.SendMsg(m)
}
</code></pre>
<h4 id="req&#x7684;sendmsg"><a name="req&#x7684;sendmsg" class="anchor-navigation-ex-anchor" href="#req&#x7684;sendmsg"><i class="fa fa-link" aria-hidden="true"></i></a>req&#x7684;SendMsg</h4>
<p>&#x6700;&#x9876;&#x5C42;&#x662F;context send</p>
<pre><code class="lang-go">func (c *context) SendMsg(m *protocol.Message) error {
    s := c.s
    id := atomic.AddUint32(&amp;s.nextID, 1)
    id |= 0x80000000

    // cooked mode, we stash the header
    m.Header = append([]byte{}, //&#x6309;&#x7167;&#x5927;&#x7AEF;&#x5B57;&#x8282;&#x5E8F;&#x53D1;id
        byte(id&gt;&gt;24), byte(id&gt;&gt;16), byte(id&gt;&gt;8), byte(id))

    s.Lock() //&#x6BCF;&#x4E2A;context&#x53EA;&#x80FD;&#x540C;&#x65F6;&#x53D1;&#x9001;&#x4E00;&#x4E2A;msg
    defer s.Unlock()
    if s.closed || c.closed {
        return protocol.ErrClosed
    }

    //&#x4E0A;&#x4E00;&#x6B21;&#x8FD8;&#x6CA1;&#x53D1;&#x9001;&#x51FA;&#x53BB;, &#x54EA;&#x91CC;&#x6709;&#x95EE;&#x9898;&#x4E86;...
    //&#x56E0;&#x4E3A;req/rep&#x662F;&#x540C;&#x6B65;&#x6A21;&#x5F0F;, &#x53D6;&#x6D88;&#x4E0A;&#x6B21;&#x7684;&#x53D1;&#x9001;: &#x4E0A;&#x6B21;&#x7684;msg&#x4F1A;&#x88AB;free&#x6389;, &#x5EF6;&#x8FDF;&#x7684;timer&#x88AB;stop; &#x5E76;&#x628A;&#x8FD9;&#x4E2A;context&#x4ECE;socket&#x7684;sendq&#x91CC;&#x9762;&#x5220;&#x6389;: s.sendq = append(s.sendq[:i], s.sendq[i+1:]...); &#x6700;&#x540E;&#x5E7F;&#x64AD;c.cond.Broadcast()
    c.cancel() // this cancels any pending send or recv calls
    c.unscheduleSend() //&#x4F3C;&#x4E4E;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x591A;&#x4F59;&#x4E86;, &#x5728;c.cancel()&#x4E2D;&#x8C03;&#x7528;&#x8FC7;&#x4E86;

    c.reqID = id
    c.queued = true
    c.sendMsg = m

    s.sendq = append(s.sendq, c) //&#x672C;&#x6B21;&#x7684;context&#x52A0;&#x5165;socket&#x7684;sendq

    if c.bestEffort {
        // for best effort case, we just immediately go the
        // reqMsg, and schedule it as a send.  No waiting.
        // This means that if the message cannot be delivered
        // immediately, it will still get a chance later.
        s.send() //&#x6CA1;&#x770B;&#x61C2;&#x4E0A;&#x9762;&#x7684;&#x6CE8;&#x91CA;, &#x4F46;&#x8FD9;&#x91CC;&#x660E;&#x663E;&#x662F;&#x8C03;&#x7528;socket&#x7684;&#x539F;&#x59CB;send, &#x4E0D;&#x7BA1;&#x9519;&#x8BEF;&#x9A6C;&#x4E0A;&#x8FD4;&#x56DE;
        return nil //&#x8FD9;&#x91CC;&#x8FD4;&#x56DE;&#x4E86;, &#x90A3;&#x4E0A;&#x9762;sendq&#x600E;&#x4E48;&#x529E;? &#x4E0D;&#x5220;&#x6389;&#x5417;?
    }

    expired := false
    if c.sendExpire &gt; 0 {
        c.sendTimer = time.AfterFunc(c.sendExpire, func() { //&#x8D85;&#x65F6;&#x5C31;&#x53D6;&#x6D88;&#x7684;&#x51FD;&#x6570;
            s.Lock()
            if c.sendMsg == m {
                expired = true
                c.cancel() // also does a wake up
            }
            s.Unlock()
        })
    }

    s.send() //&#x89E6;&#x53D1;&#x540E;&#x53F0;send

    // This sleeps until someone picks us up for scheduling.
    // It is responsible for providing the blocking semantic and
    // ultimately back-pressure.  Note that we will &quot;continue&quot; if
    // the send is canceled by a subsequent send.
    for c.sendMsg == m &amp;&amp; !expired &amp;&amp; !c.closed {
        //sync.Cond.Wait&#x63A5;&#x53E3;&#x9700;&#x8981;&#x5728;for&#x91CC;&#x9762;&#x8C03;&#x7528;
        c.cond.Wait() //&#x5178;&#x578B;&#x7684;&#x573A;&#x666F;&#x662F;&#x4E0A;&#x9762;&#x7684;s.send&#x628A;c.sendMsg&#x7F6E;&#x4E3A;nil, &#x89E3;&#x9664;&#x8FD9;&#x91CC;&#x7684;for&#x5FAA;&#x73AF;, &#x9000;&#x51FA;wait&#x5F80;&#x4E0B;&#x8D70;. &#x4F46;&#x5982;&#x679C;readyq&#x4E2D;&#x6CA1;&#x6709;&#x53EF;&#x7528;&#x7684;pipe, &#x5C31;&#x662F;&#x8BF4;&#x6CA1;&#x6709;&#x6709;&#x6548;&#x7684;&#x8FDE;&#x63A5;, SendMsg&#x4F1A;block&#x5728;&#x8FD9;&#x91CC;, &#x76F4;&#x5230;&#x6709;&#x53EF;&#x7528;&#x7684;&#x8FDE;&#x63A5;&#x4E3A;&#x6B62;.
    }
    if c.sendMsg == m { //&#x5230;&#x8FD9;&#x91CC;, &#x8981;&#x4E48;&#x5C31;&#x662F;&#x8D85;&#x65F6;&#x4E86;, &#x8981;&#x4E48;&#x5C31;&#x662F;close&#x4E86;;&#x8FD9;&#x4E2A;m&#x73B0;&#x5728;&#x662F;&#x53D1;&#x4E0D;&#x4E86;&#x4E86;
        c.unscheduleSend() //&#x5220;&#x9664;m&#x5BF9;&#x5E94;&#x7684;context
        c.sendMsg = nil //&#x5C31;&#x662F;&#x8BF4;&#x8FD9;&#x4E2A;m&#x4E0D;&#x53D1;&#x4E86;
        c.reqID = 0
        if c.closed {
            return protocol.ErrClosed
        }
        return protocol.ErrSendTimeout //&#x8FD4;&#x56DE;&#x9519;&#x8BEF;, m&#x5E76;&#x6CA1;&#x6709;&#x53D1;&#x9001;.
    }
    return nil
}
</code></pre>
<p>context send&#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86;socket send
&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x7684;send&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x53C2;&#x6570;&#x548C;&#x8FD4;&#x56DE;&#x503C;: &#x9700;&#x8981;&#x77E5;&#x9053;&#x7684;&#x5DF2;&#x7ECF;&#x5168;&#x90E8;&#x77E5;&#x9053;, &#x5B83;&#x8981;&#x505A;&#x7684;&#x5C31;&#x662F;&#x8C03;&#x5EA6;&#x53D1;&#x9001;.</p>
<pre><code class="lang-go">func (s *socket) send() {
    for len(s.sendq) != 0 &amp;&amp; len(s.readyq) != 0 { //&#x6709;&#x5F85;&#x53D1;&#x9001;&#x7684;context &#x5E76;&#x4E14;&#x6709;ready&#x7684;pipe
        c := s.sendq[0] //&#x53D6;&#x51FA;&#x7B2C;&#x4E00;&#x4E2A;&#x5F85;&#x53D1;context
        s.sendq = s.sendq[1:]
        c.queued = false

        var m *protocol.Message
        if m = c.sendMsg; m != nil { //&#x4ECE;sendMsg&#x8F6C;&#x79FB;&#x5230;reqMsg
            c.reqMsg = m
            c.sendMsg = nil
            s.ctxByID[c.reqID] = c //&#x6309;ID&#x8BB0;&#x5F55;context
            c.cond.Broadcast()
        } else {
            m = c.reqMsg
        }
        m.Clone()    //&#x589E;&#x52A0;msg&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;, &#x8BE5;msg&#x662F;&#x5171;&#x4EAB;&#x6A21;&#x5F0F;.

        p := s.readyq[0] //&#x53D6;&#x7B2C;&#x4E00;&#x4E2A;ready &#x7684;pipe
        s.readyq = s.readyq[1:]

        // Schedule a retransmit for the future.
        c.lastPipe = p //ready&#x7684;pipe&#x4FDD;&#x5B58;&#x5230;lastPipe&#x91CC;
        if c.resendTime &gt; 0 {
            id := c.reqID
            c.resender = time.AfterFunc(c.resendTime, func() { //&#x9ED8;&#x8BA4;&#x4E00;&#x5206;&#x949F;&#x91CD;&#x53D1;
                c.resendMessage(id)
            })
        }
        go p.sendCtx(c, m) //&#x540E;&#x53F0;&#x53D1;&#x9001;, &#x6CE8;&#x610F;go&#x4E86;&#x4EE5;&#x540E;, &#x5C31;&#x8131;&#x79BB;&#x4E86;&#x9501;&#x7684;&#x4FDD;&#x62A4;&#x4E86;
    }
}
</code></pre>
<p>sendCtx()&#x4F1A;&#x8C03;&#x7528;&#x5E95;&#x5C42;&#x7684;pipe&#x6765;&#x53D1;&#x9001;, &#x4E00;&#x822C;&#x53D1;&#x9001;&#x5B8C;&#x8FD8;&#x4F1A;&#x8C03;&#x5EA6;&#x81EA;&#x5DF1;&#x7EE7;&#x7EED;&#x53D1;&#x9001;.</p>
<pre><code class="lang-go">func (p *pipe) sendCtx(c *context, m *protocol.Message) {
    s := p.s

    // Send this message.  If an error occurs, we examine the
    // error.  If it is ErrClosed, we don&apos;t schedule our self.
    if err := p.p.SendMsg(m); err != nil {
        m.Free()
        if err == protocol.ErrClosed {
            return
        }
    }
    s.Lock() //&#x91CD;&#x65B0;&#x8C03;&#x5EA6;&#x53D1;&#x9001;&#x8FD8;&#x662F;&#x9700;&#x8981;&#x83B7;&#x53D6;&#x9501;.
    if !s.closed &amp;&amp; !p.closed {
        s.readyq = append(s.readyq, p)
        s.send() //&#x91CD;&#x65B0;&#x8C03;&#x5EA6;
    }
    s.Unlock()
}
</code></pre>
<h4 id="&#x53D1;&#x9001;&#x5C0F;&#x8282;"><a name="&#x53D1;&#x9001;&#x5C0F;&#x8282;" class="anchor-navigation-ex-anchor" href="#&#x53D1;&#x9001;&#x5C0F;&#x8282;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x53D1;&#x9001;&#x5C0F;&#x8282;</h4>
<ul>
<li>req/rep&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x540C;&#x6B65;&#x6A21;&#x5F0F;, &#x5176;&#x5B9E;&#x5E76;&#x6CA1;&#x6709;&#x540C;&#x65F6;&#x53D1;&#x9001;&#x7684;&#x8BF4;&#x6CD5;</li>
<li>&#x4F46;&#x5373;&#x4F7F;&#x662F;&#x7B80;&#x5355;&#x7684;&#x540C;&#x6B65;&#x53D1;&#x9001;, &#x8FD9;&#x91CC;&#x4E5F;&#x8981;&#x8D70;&#x4E09;&#x6B65;:<ul>
<li>&#x7B2C;&#x4E00;&#x6B65;, &#x8981;send&#x7684;message&#x4F1A;&#x548C;context&#x6765;&#x7ED3;&#x5408;, &#x88AB;&#x653E;&#x5230;socket&#x7684;sendq&#x4E2D;&#x7B49;&#x5F85;&#x53D1;&#x9001;</li>
<li>&#x7B2C;&#x4E8C;&#x6B65;, &#x8C03;&#x7528;socket.send()&#x6765;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;. &#x6240;&#x8C13;&#x8C03;&#x5EA6;&#x5C31;&#x662F;&#x4ECE;sendq&#x53D6;context, &#x4ECE;readyq&#x53D6;pipe</li>
<li>&#x7B2C;&#x4E09;&#x6B65;, &#x7528;&#x9009;&#x5B9A;&#x7684;pipe&#x6765;&#x53D1;&#x9001;&#x8FD9;&#x4E2A;context&#x4E2D;&#x7684;msg. &#x6BCF;&#x4E2A;&#x5F85;&#x53D1;&#x9001;&#x7684;context&#x90FD;&#x4F1A;&#x5728;&#x72EC;&#x7ACB;&#x7684;goroutine&#x4E2D;&#x53D1;&#x9001;. &#x5728;&#x672C;&#x6B65;&#x9AA4;&#x4F1A;&#x89E6;&#x53D1;&#x63A5;&#x4E0B;&#x6765;&#x7684;&#x8C03;&#x5EA6;send, &#x5373;&#x7B2C;&#x4E8C;&#x4E09;&#x6B65;&#x662F;&#x53CD;&#x590D;&#x4E92;&#x76F8;&#x8C03;&#x7528;&#x7684;, &#x76F4;&#x5230;&#x6240;&#x6709;&#x5F85;&#x53D1;&#x7684;msg&#x90FD;&#x53D1;&#x9001;&#x5B8C;&#x6210;.</li>
</ul>
</li>
<li>&#x7EFC;&#x4E0A;, &#x8FD9;&#x91CC;&#x7684;&#x8BBE;&#x8BA1;&#x662F;&#x5178;&#x578B;&#x7684;&#x540C;&#x6B65;&#x5F02;&#x6B65;&#x5316;, &#x518D;&#x540C;&#x6B65;&#x5316;&#x7684;&#x8FC7;&#x7A0B;. &#x540C;&#x6B65;&#x5F02;&#x6B65;&#x5316;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x5148;&#x7F13;&#x5B58;(&#x6307;&#x9488;)&#x518D;&#x8C03;&#x5EA6;&#x7684;&#x6A21;&#x5F0F;, &#x4E3A;&#x7684;&#x662F;&#x5FEB;&#x901F;&#x4ECE;&#x53D1;&#x9001;&#x8FD4;&#x56DE;; &#x518D;&#x6B21;&#x540C;&#x6B65;&#x5316;&#x662F;&#x4E3A;&#x4E86;&#x6A21;&#x5F0F;&#x7B80;&#x5355;?</li>
<li>SendMsg&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x5FEB;&#x901F;&#x8FD4;&#x56DE;, &#x4F46;&#x5728;&#x540E;&#x53F0;&#x53D1;&#x9001;</li>
<li>&#x53D1;&#x9001;&#x5931;&#x8D25;&#x4F1A;&#x91CD;&#x4F20;</li>
</ul>
<h4 id="newsocket"><a name="newsocket" class="anchor-navigation-ex-anchor" href="#newsocket"><i class="fa fa-link" aria-hidden="true"></i></a>NewSocket</h4>
<p>&#x770B;&#x4E86;send, &#x6211;&#x4EEC;&#x518D;&#x56DE;&#x8FC7;&#x5934;&#x6765;&#x4ECE;&#x6700;&#x5F00;&#x59CB;&#x7684;NewSocket&#x770B;&#x8D77;.NewSocket&#x662F;&#x5BF9;&#x4E0A;&#x7684;&#x9876;&#x5C42;API
&#x5728;&#x5B9E;&#x73B0;&#x4E0A;, req&#x7528;&#x4E86;core&#x7684;MakeSocket&#x63A5;&#x53E3;, &#x4F20;&#x5165;&#x4E00;&#x4E2A;req.socket&#x5B9E;&#x4F8B;&#x5F53;&#x4F5C;protocolBase</p>
<pre><code class="lang-go">// NewSocket allocates a new Socket using the REQ protocol.
func NewSocket() (protocol.Socket, error) {
    return protocol.MakeSocket(NewProtocol()), nil
}

// NewProtocol allocates a new protocol implementation.
func NewProtocol() protocol.Protocol {
    s := &amp;socket{
        nextID:  uint32(time.Now().UnixNano()), // quasi-random
        ctxs:    make(map[*context]struct{}),
        ctxByID: make(map[uint32]*context),
    }
    s.defCtx = &amp;context{
        s:          s,
        cond:       sync.NewCond(s), //NewCond&#x9700;&#x8981;&#x4F20;&#x5165;&#x4E00;&#x4E2A;locker, &#x800C;s&#x533F;&#x540D;&#x5305;&#x542B;&#x4E86;sync.Mutex, &#x5C31;&#x662F;&#x4E2A;locker
        resendTime: time.Minute,
    }
    s.ctxs[s.defCtx] = struct{}{}
    return s
}
</code></pre>
<h4 id="addpipe&#x65B9;&#x6CD5;"><a name="addpipe&#x65B9;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#addpipe&#x65B9;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>AddPipe&#x65B9;&#x6CD5;</h4>
<p>req.socket&#x7684;AddPipe&#x65B9;&#x6CD5;&#x4F1A;&#x88AB;core.socket&#x5728;&#x9876;&#x5C42;dial&#x548C;listen&#x7684;&#x65F6;&#x5019;&#x6709;&#x65B0;&#x7684;conn&#x4EA7;&#x751F;&#x65F6;&#x8C03;&#x7528;, &#x4F1A;&#x628A;transport&#x5C42;&#x7684;conn&quot;&#x901A;&#x9053;&quot;&#x5316;, &#x4FDD;&#x5B58;&#x5728;req.socket&#x7684;readyq&#x91CC;. &#x5BF9;REQ&#x7C7B;&#x578B;&#x7684;socket&#x6765;&#x8BF4;, &#x6240;&#x8C13;&#x7684;readyq&#x5C31;&#x662F;&#x6240;&#x6709;&#x5BF9;&#x7AEF;&#x80FD;&#x63D0;&#x4F9B;REP&#x7C7B;&#x578B;&#x7684;socket.</p>
<pre><code class="lang-go">func (s *socket) AddPipe(pp protocol.Pipe) error {
    p := &amp;pipe{
        p: pp,
        s: s,
    }
    pp.SetPrivate(p)
    s.Lock()
    defer s.Unlock()
    if s.closed {
        return protocol.ErrClosed
    }
    s.readyq = append(s.readyq, p)
    s.send() //&#x6709;&#x65B0;&#x7684;rep&#x8FDE;&#x63A5;&#x4E86;, &#x89E6;&#x53D1;&#x4E00;&#x6B21;&#x8C03;&#x5EA6;send
    go p.receiver() //&#x540E;&#x9762;&#x4F1A;&#x8BB2;
    return nil
}
</code></pre>
<h4 id="recvmsg"><a name="recvmsg" class="anchor-navigation-ex-anchor" href="#recvmsg"><i class="fa fa-link" aria-hidden="true"></i></a>RecvMsg</h4>
<p>&#x65E0;&#x8BBA;&#x662F;send&#x8FD8;&#x662F;recv msg, &#x90FD;&#x8981;&#x5728;context&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x8FDB;&#x884C;. &#x56E0;&#x4E3A;&#x4E0D;&#x540C;&#x4E8E;linux&#x6982;&#x5FF5;&#x4E0A;&#x7684;socket&#x53EA;&#x7BA1;&quot;&#x901A;&#x9053;&quot;; &#x8FD9;&#x91CC;&#x7684;socket&#x7684;&#x6982;&#x5FF5;&#x662F;&#x5E94;&#x7528;&#x573A;&#x666F;&#x4E0B;&#x7684;&#x5982;&#x4F55;&#x4F7F;&#x7528;socket&#x7684;&#x62BD;&#x8C61;, &#x662F;&#x6709;&#x72B6;&#x6001;&#x7684;, &#x5FC5;&#x987B;&#x5728;&#x72B6;&#x6001;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x8FDB;&#x884C;.</p>
<pre><code class="lang-go">func (s *socket) SendMsg(m *protocol.Message) error {
    return s.defCtx.SendMsg(m)
}

func (s *socket) RecvMsg() (*protocol.Message, error) {
    return s.defCtx.RecvMsg()
}
</code></pre>
<p>ok, &#x4ECE;RecvMsg&#x5F00;&#x59CB;: RecvMsg&#x662F;&#x8981;&#x770B;&#x72B6;&#x6001;&#x7684;, &#x800C;&#x4E14;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5E76;&#x4E0D;&#x662F;&#x8C03;&#x7528;&#x539F;&#x59CB;&#x63A5;&#x53E3;recv, &#x800C;&#x662F;&quot;&#x7B49;&#x5F85;&quot;msg&#x5230;&#x4F4D; -- &#x5E94;&#x8BE5;&#x6709;&#x4E2A;&#x540E;&#x53F0;&#x7684;routine&#x4E00;&#x76F4;&#x5728;&#x6536;&#x5305;.</p>
<pre><code class="lang-go">func (c *context) RecvMsg() (*protocol.Message, error) {
    s := c.s
    s.Lock()
    defer s.Unlock()
    if s.closed || c.closed {
        return nil, protocol.ErrClosed
    }
    if c.recvWait || c.reqID == 0 {
        return nil, protocol.ErrProtoState
    }
    c.recvWait = true
    id := c.reqID
    expired := false

    if c.recvExpire &gt; 0 {
        c.recvTimer = time.AfterFunc(c.recvExpire, func() {
            s.Lock()
            if c.reqID == id {
                expired = true
                c.cancel()
            }
            s.Unlock()
        })
    }

    for id == c.reqID &amp;&amp; c.repMsg == nil {
        c.cond.Wait() //&#x5728;&#x8FD9;&#x91CC;&#x7B49;&#x5F85;&#x5176;&#x4ED6;routine&#x6536;&#x5305;&#x5B8C;&#x6210;. &#x6CE8;&#x610F;, cond.Wait&#x4F1A;&#x81EA;&#x52A8;unlock s&#x7684;mutex&#x9501;, &#x8FD9;&#x662F;c.cond&#x521D;&#x59CB;&#x5316;&#x65F6;&#x6307;&#x660E;&#x7684;. wait&#x8FD4;&#x56DE;&#x8FD9;&#x4E2A;tmux&#x9501;&#x4F1A;&#x81EA;&#x52A8;lock. &#x4E5F;&#x5C31;&#x662F;&#x8BF4;wait&#x671F;&#x95F4;, s&#x7684;mutex&#x9501;&#x662F;&#x5F00;&#x653E;&#x7684;. &#x53E6;&#x5916;, go&#x7684;mutex&#x9501;&#x548C;routine&#x6CA1;&#x6709;&#x5173;&#x7CFB;, &#x53EF;&#x4EE5;&#x5728;&#x4E00;&#x4E2A;routine&#x91CC;lock, &#x4F46;&#x5B89;&#x6392;&#x5176;&#x4ED6;routine&#x53BB;unlock
    } //&#x53E6;&#x5916;, cond.Wait&#x662F;&#x5728;for&#x91CC;&#x5FAA;&#x73AF;&#x7684;, &#x662F;&#x6709;&#x6761;&#x4EF6;&#x9000;&#x51FA;&#x7684;. &#x5373;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#x8FD8;&#x662F;&#x7EE7;&#x7EED;wait, &#x5373;&#x4F7F;&#x4E2D;&#x95F4;&#x88AB;&#x5524;&#x9192;&#x8FC7;.

    m := c.repMsg
    c.reqID = 0
    c.repMsg = nil
    c.recvWait = false
    c.cond.Broadcast() //&#x5230;&#x8FD9;&#x91CC;&#x662F;broadcast&#x7ED9;&#x8C01;&#x5462;?

    if m == nil {
        if expired {
            return nil, protocol.ErrRecvTimeout
        }
        if c.closed {
            return nil, protocol.ErrClosed
        }
        return nil, protocol.ErrCanceled
    }
    return m, nil
}
</code></pre>
<p>&#x6CE8;: context.RecvMsg&#x662F;&#x4E00;&#x5904;cond.Wait()&#x70B9;, &#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x70B9;&#x53D1;&#x751F;&#x5728;context.SendMsg. &#x8FD9;&#x4E24;&#x4E2A;&#x5730;&#x65B9;&#x7684;wait()&#x90FD;&#x662F;&#x5728;&#x6761;&#x4EF6;&#x5FAA;&#x73AF;&#x91CC;, &#x5373;&#x4F7F;&#x5E7F;&#x64AD;&#x5F0F;&#x7684;<code>c.cond.Broadcast()</code>&#x4E5F;&#x6CA1;&#x5173;&#x7CFB;. &#x4E0D;&#x662F;&#x81EA;&#x5DF1;&#x60F3;&#x8981;&#x7684;&#x9000;&#x51FA;&#x6761;&#x4EF6;, &#x8FD8;&#x662F;&#x4F1A;&#x7EE7;&#x7EED;wait.</p>
<h4 id="receiver&#x51FD;&#x6570;"><a name="receiver&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#receiver&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>receiver()&#x51FD;&#x6570;</h4>
<p>&#x524D;&#x9762;&#x63D0;&#x5230;, &#x5F53;&#x9876;&#x5C42;&#x6BD4;&#x5982;dial()&#x6210;&#x529F;&#x4E86;&#x4E4B;&#x540E;, &#x7CFB;&#x7EDF;&#x4F1A;&#x628A;&#x4E00;&#x4E2A;pipe&#x5B9E;&#x4F8B;AddPipe()&#x5230;protocol, &#x4E5F;&#x5C31;&#x662F;add&#x5230;&#x8FD9;&#x91CC;.
&#x8FD9;&#x4E2A;add&#x6D41;&#x7A0B;&#x7684;&#x6700;&#x540E;, &#x4F1A;
<code>go p.receiver()</code> &#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x4E00;&#x4E2A;&#x63E1;&#x4E86;&#x624B;&#x7684;&#x8FDE;&#x63A5;, &#x90FD;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;go routine, &#x6765;receive msg, &#x53EF;&#x4EE5;&#x60F3;&#x8C61;, &#x8FD9;&#x4E2A;receiver&#x4E00;&#x5B9A;&#x662F;&#x4E2A;for&#x5FAA;&#x73AF;, &#x4ECE;&#x5E95;&#x5C42;&#x6536;&#x4E86;msg&#x4E4B;&#x540E;&#x6765;&#x7F13;&#x5B58;&#x5230;&#x54EA;&#x91CC;.</p>
<pre><code class="lang-go">func (p *pipe) receiver() {
    s := p.s
    for {
        m := p.p.RecvMsg() //&#x4ECE;&#x5E95;&#x5C42;&#x6536;&#x5B8C;&#x6574;&#x7684;msg
        if m == nil { //m&#x4E3A;nil&#x7684;&#x65F6;&#x5019;, &#x8BF4;&#x660E;&#x5E95;&#x5C42;recv&#x51FA;&#x73B0;&#x4E86;&#x9519;&#x8BEF;, &#x7CFB;&#x7EDF;&#x4F1A;&#x5173;&#x95ED;&#x9519;&#x8BEF;&#x8FDE;&#x63A5;, &#x542F;&#x52A8;redial&#x6D41;&#x7A0B;&#x65B0;&#x5EFA;&#x8FDE;&#x63A5;. 
            break
        }
        if len(m.Body) &lt; 4 {
            m.Free()
            continue
        }
        m.Header = append(m.Header, m.Body[:4]...) //m.Body&#x7684;&#x524D;4&#x4E2A;&#x5B57;&#x8282;&#x80AF;&#x5B9A;&#x88AB;REP&#x5F53;&#x4F5C;&#x7279;&#x6B8A;&#x7528;&#x5904;&#x4E86;...
        m.Body = m.Body[4:]

        id := binary.BigEndian.Uint32(m.Header) //&#x8FD8;&#x539F;&#x53D1;&#x9001;&#x65F6;&#x7684;ID

        s.Lock()
        // Since we just received a reply, stick our send at the
        // head of the list, since that&apos;s a good indication that
        // we&apos;re ready for another request.
        for i, rp := range s.readyq {
            if p == rp { //&#x8FD9;&#x4E2A;pipe&#x53EF;&#x4EE5;&#x6536;rep, &#x628A;&#x5B83;&#x6362;&#x5230;readyq&#x7684;&#x5934;. readyq&#x7684;&#x5934;&#x8D1F;&#x8D23;&#x53D1;&#x9001;
                s.readyq[0], s.readyq[i] = s.readyq[i], s.readyq[0]
                break
            }
        }

        if c, ok := s.ctxByID[id]; ok { //&#x6309;ID&#x627E;&#x5230;&#x53D1;&#x9001;&#x7684;context
            c.unscheduleSend()
            c.reqMsg.Free() //&#x5230;&#x8FD9;&#x91CC;&#x5DF2;&#x7ECF;&#x63A5;&#x6536;&#x5230;&#x4E86;REP, &#x80AF;&#x5B9A;&#x4E4B;&#x524D;&#x53D1;&#x9001;&#x7684;REQ&#x7684;msg&#x5C31;&#x53EF;&#x4EE5;free&#x4E86;. 
            c.reqMsg = nil
            c.repMsg = m //&#x6536;&#x5305;&#x5C31;&#x662F;&#x6536;&#x5230;c.repMsg&#x4E2D;&#x4E86;.
            delete(s.ctxByID, id)
            if c.resender != nil {
                c.resender.Stop() //&#x4E5F;&#x4E0D;&#x7528;resend&#x4E86;
                c.resender = nil
            }
            c.cond.Broadcast() //RecvMsg&#x51FD;&#x6570;&#x91CC;&#x6B63;&#x5728;&#x7B49;&#x7740;&#x8FD9;&#x4E2A;&#x5E7F;&#x64AD;&#x5462;
        } else {
            // No matching receiver so just drop it.
            m.Free()
        }
        s.Unlock()
    }

    go p.Close()
}
</code></pre>
<h4 id="&#x63A5;&#x6536;&#x5C0F;&#x7ED3;"><a name="&#x63A5;&#x6536;&#x5C0F;&#x7ED3;" class="anchor-navigation-ex-anchor" href="#&#x63A5;&#x6536;&#x5C0F;&#x7ED3;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x63A5;&#x6536;&#x5C0F;&#x7ED3;</h4>
<p>&#x6BCF;&#x4E2A;&#x6210;&#x529F;&#x63E1;&#x624B;&#x534F;&#x5546;&#x7684;&#x8FDE;&#x63A5;&#x90FD;&#x4F1A;&#x88AB;add&#x5230;protocol&#x91CC;, &#x88AB;protocol&#x77E5;&#x9053;. protocol&#x4F1A;&#x542F;&#x52A8;&#x4E00;&#x4E2A;receiver routine, &#x8FD9;&#x4E2A;receiver&#x8D1F;&#x8D23;&#x6536;&#x5305;. &#x7136;&#x540E;&#x4ECE;headder&#x8FD8;&#x539F;&#x53D1;&#x9001;&#x65F6;&#x7684;ID, &#x67E5;&#x8868;&#x5F97;&#x5230;&#x5F53;&#x65F6;&#x7684;context. &#x7136;&#x540E;&#x628A;&#x63A5;&#x6536;&#x5230;&#x7684;msg&#x653E;&#x5230;<code>c.repMsg = m</code>, &#x6700;&#x540E;&#x8FD4;&#x56DE;&#x8FD9;&#x4E2A;msg</p>
<h4 id="req&#x5C0F;&#x7ED3;"><a name="req&#x5C0F;&#x7ED3;" class="anchor-navigation-ex-anchor" href="#req&#x5C0F;&#x7ED3;"><i class="fa fa-link" aria-hidden="true"></i></a>REQ&#x5C0F;&#x7ED3;</h4>
<p>&#x4ECE;&#x7528;&#x6237;&#x4FA7;&#x770B;&#x6765;, req&#x7684;&#x4F7F;&#x7528;&#x5F88;&#x7B80;&#x5355;:</p>
<pre><code class="lang-go">sock, err = req.NewSocket() //&#x65B0;&#x5EFA;req&#x7684;socket, &#x540C;&#x65F6;&#x4E5F;&#x65B0;&#x5EFA;&#x4E86;&#x9ED8;&#x8BA4;&#x7684;context; &#x6807;&#x51C6;API&#x7684;send recv&#x90FD;&#x8D70;&#x9ED8;&#x8BA4;&#x7684;context
err = sock.Dial(url) //&#x6838;&#x5FC3;&#x5C42;&#x4F1A;&#x8C03;&#x7528;url&#x4EE3;&#x8868;&#x7684;transport&#x7C7B;&#x578B;&#x7684;Dial, &#x6210;&#x529F;&#x5C31;AddPipe(); &#x5931;&#x8D25;&#x4F1A;&#x91CD;&#x8BD5;, &#x77E5;&#x9053;&#x8FD4;&#x56DE;errClosed
sock.Send([]byte(&quot;DATE&quot;))
msg, err = sock.Recv()
</code></pre>
<ul>
<li>req.NewSocket()&#x8C03;&#x7528;&#x6838;&#x5FC3;&#x5C42;&#x7684;MakeSocket(REQ&#x7684;&#x63A5;&#x53E3;&#x5B9E;&#x4F8B;)&#x6765;&#x521B;&#x5EFA;socket. &#x7279;&#x522B;&#x7684;, &#x9ED8;&#x8BA4;&#x7684;&#x6700;&#x5927;rx size&#x662F;1M</li>
<li>REQ&#x7684;socket&#x6709;<ul>
<li>&#x9ED8;&#x8BA4;&#x7684;context</li>
<li>sendq &#x4EE3;&#x8868;&#x7684;&#x8981;&#x53D1;&#x9001;&#x7684;context</li>
<li>readq &#x4EE3;&#x8868;&#x4E86;&#x6240;&#x6709;&#x53EF;&#x7528;&#x7684;&#x8FDE;&#x63A5;</li>
<li>nextID &#x7528;&#x4E8E;&#x7ED9;&#x6BCF;&#x4E2A;req&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x552F;&#x4E00;&#x7684;ID, &#x8FD9;&#x4E2A;ID&#x7528;&#x6765;&#x53CD;&#x67E5;ctxByID&#x8868;&#x5F97;&#x5230;context</li>
</ul>
</li>
<li>req.socket.AddPipe()&#x4F1A;&#x88AB;&#x6838;&#x5FC3;&#x5C42;&#x6846;&#x67B6;&#x5728;&#x65B0;&#x8FDE;&#x63A5;&#x5EFA;&#x7ACB;&#x6210;&#x529F;&#x540E;&#x8C03;&#x7528;. &#x8FD9;&#x91CC;&#x7684;AddPipe()&#x542F;&#x52A8;&#x4E86;receiver routine&#x6765;&#x4E0D;&#x65AD;&#x7684;&#x6536;&#x62A5;&#x6587;.<ul>
<li>&#x6BCF;&#x4E2A;&#x65B0;&#x8FDE;&#x63A5;&#x90FD;&#x4F1A;AddPipe(), &#x6240;&#x4EE5;&#x4E00;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;receiver routine</li>
<li>&#x4ECE;&#x6536;&#x5230;&#x7684;&#x62A5;&#x6587;&#x7684;Header&#x90E8;&#x5206;&#x6062;&#x590D;request ID, &#x8FD9;&#x4E2A;ID&#x662F;&#x53D1;&#x9001;&#x7684;&#x65F6;&#x5019;&#x586B;&#x7684;, &#x4EE3;&#x8868;&#x4E86;&#x4E00;&#x4E2A;req&#x7684;&#x552F;&#x4E00;&#x5B58;&#x5728;.</li>
<li>&#x7528;&#x8FD9;&#x4E2A;ID&#x67E5;&#x5230;&#x5F53;&#x65F6;&#x53D1;&#x9001;&#x7684;context, &#x5E76;&#x7ED9;&#x8FD9;&#x4E2A;context&#x7684;&#x7B49;&#x5F85;routine&#x53D1;&#x5E7F;&#x64AD;&#x5524;&#x9192;</li>
</ul>
</li>
<li>socket&#x7684;&#x63A5;&#x6536;&#x5FC5;&#x987B;&#x7ED3;&#x5408;context&#x6765;&#x63A5;&#x6536;, &#x9ED8;&#x8BA4;&#x4F7F;&#x7528;default context&#x6765;&#x63A5;&#x6536;<ul>
<li>context&#x548C;&#x5177;&#x4F53;&#x7684;&#x8FDE;&#x63A5;(pipe)&#x6CA1;&#x6709;&#x7ED1;&#x5B9A;&#x5173;&#x7CFB;</li>
<li>RecvMsg()&#x662F;&#x7528;&#x6237;&#x884C;&#x4E3A;, &#x6CA1;&#x6709;msg&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x963B;&#x585E;. &#x67D0;&#x4E2A;&#x8FDE;&#x63A5;&#x7684;receiver routine&#x6536;&#x5230;&#x62A5;&#x6587;&#x540E;, &#x67E5;&#x5230;&#x662F;&#x8FD9;&#x4E2A;context&#x7684;&#x62A5;&#x6587;, &#x5176;&#x53D1;&#x9001;&#x7684;&#x5E7F;&#x64AD;&#x5524;&#x9192;&#x4F1A;&#x89E3;&#x9664;&#x672C;RecvMsg&#x8DEF;&#x5F84;&#x4E0A;&#x7684;wait.</li>
<li>RecvMsg()&#x8FD8;&#x8D1F;&#x8D23;&#x5524;&#x9192;&#x672C;context&#x4E0A;&#x7B49;&#x5F85;&#x7684;SendMsg()</li>
</ul>
</li>
<li>SendMsg&#x4E5F;&#x662F;&#x8981;&#x7ED3;&#x5408;context, &#x9ED8;&#x8BA4;&#x4E5F;&#x662F;&#x9ED8;&#x8BA4;&#x7684;context&#x6765;&#x53D1;&#x9001;<ul>
<li>&#x5F97;&#x5230;requestID, &#x548C;context&#x4E00;&#x8D77;&#x8BB0;&#x5F55;&#x5230;socket&#x7684;sendq&#x4E2D;</li>
<li>&#x771F;&#x6B63;&#x7684;&#x53D1;&#x9001;&#x5B9E;&#x9645;&#x4E0A;&#x6709;&#x70B9;&#x50CF;softirq, &#x662F;&#x4E2A;&#x89E6;&#x53D1;&#x70B9;: &#x8C03;&#x7528;send()&#x7684;&#x65F6;&#x5019;, &#x5B9E;&#x9645;&#x4E0A;&#x662F;trigger&#x4E86;&#x4E00;&#x6B21;&#x540E;&#x53F0;&#x53D1;&#x9001;&#x5E8F;&#x5217;, &#x8BE5;&#x5E8F;&#x5217;&#x4E2D;&#x4F1A;&#x628A;&#x6240;&#x6709;&#x4E4B;&#x524D;&#x7684;&#x62A5;&#x6587;&#x90FD;&#x53D1;&#x51FA;&#x53BB;. &#x771F;&#x6B63;&#x7684;&quot;&#x901A;&#x9053;&quot;&#x7EA7;&#x53D1;&#x9001;&#x662F;&#x6BCF;&#x4E2A;&#x62A5;&#x6587;&#x90FD;&#x5728;&#x540E;&#x53F0;&#x53D1;&#x9001;<code>go p.sendCtx(c, m)</code>; &#x5728;&#x6CA1;&#x6709;&#x771F;&#x6B63;&#x53D1;&#x9001;&#x5B8C;&#x6210;&#x4E4B;&#x524D;, &#x5C31;&quot;&#x5E7F;&#x64AD;&quot;&#x5230;&#x8BE5;context&#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x5F80;&#x4E0B;&#x8D70;&#x4E86;(&#x89C1;&#x4E0B;&#x4E00;&#x6761;), &#x6BCF;&#x4E2A;&#x5F85;&#x53D1;&#x7684;msg&#x90FD;&quot;&#x5E7F;&#x64AD;&quot;&#x4E00;&#x6B21;.</li>
<li>&#x5982;&#x679C;&#x672C;context&#x8FD8;&#x662F;&#x5728;&#x53D1;&#x672C;msg, &#x6216;&#x8005;&#x6CA1;&#x6709;&#x8D85;&#x65F6;, &#x5C31;&#x4E00;&#x76F4;wait(&#x4E00;&#x822C;&#x8FD9;&#x4E2A;&#x6761;&#x4EF6;&#x4E0D;&#x6210;&#x7ACB;)</li>
<li>&#x7EFC;&#x4E0A;, &#x53D1;&#x9001;&#x662F;softirq&#x5F0F;&#x7684;&#x89E6;&#x53D1;&#x4E00;&#x6CE2;&#x5F02;&#x6B65;&#x53D1;&#x9001;(<code>go p.sendCtx(c, m)</code>), &#x4F46;&#x4E0D;&#x7528;&#x7B49;&#x771F;&#x6B63;&#x7684;&#x62A5;&#x6587;&#x4ECE;&quot;&#x901A;&#x9053;&quot;socket&#x53D1;&#x9001;&#x5B8C;&#x6BD5;.</li>
</ul>
</li>
<li>&#x7528;&#x6237;&#x4FA7;&#x53D1;&#x9001;&#x548C;&#x63A5;&#x6536;&#x90FD;&#x6709;&#x8D85;&#x65F6;&#x8BBE;&#x5B9A;</li>
<li>&#x53D1;&#x9001;&#x6709;&#x91CD;&#x53D1;&#x673A;&#x5236;, &#x9ED8;&#x8BA4;1&#x5206;&#x949F;&#x91CD;&#x53D1;. &#x4F46;&#x4F3C;&#x4E4E;&#x6027;&#x80FD;&#x5F88;&#x582A;&#x5FE7;, &#x56E0;&#x4E3A;&#x6BCF;&#x4E2A;sendq&#x91CC;&#x9762;&#x7684;context, &#x5728;&#x771F;&#x6B63;&#x53D1;&#x9001;&#x4E4B;&#x524D;, &#x90FD;&#x65E0;&#x6761;&#x4EF6;&#x8D77;&#x4E00;&#x4E2A;1&#x5206;&#x949F;&#x5B9A;&#x65F6;&#x5668;&#x6765;&#x91CD;&#x53D1;. &#x5C31;&#x4E0D;&#x80FD;&#x53D1;&#x9001;&#x5931;&#x8D25;&#x4E86;&#x518D;&#x8D77;&#x5B9A;&#x65F6;&#x5668;&#x91CD;&#x53D1;&#x5417;?</li>
</ul>
<h3 id="protocolreprepgo"><a name="protocolreprepgo" class="anchor-navigation-ex-anchor" href="#protocolreprepgo"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.2. protocol/rep/rep.go</h3>
<h4 id="newsocket_1"><a name="newsocket_1" class="anchor-navigation-ex-anchor" href="#newsocket_1"><i class="fa fa-link" aria-hidden="true"></i></a>NewSocket</h4>
<p>NewSocket&#x7684;&#x5957;&#x8DEF;&#x548C;REQ&#x4E00;&#x6837;: &#x8C03;&#x7528;&#x6838;&#x5FC3;&#x5C42;protocol&#x7684;&#x51FD;&#x6570;MakeSocket, &#x4F20;&#x5165;&#x81EA;&#x5DF1;&#x7684;&#x63A5;&#x53E3;&#x5B9E;&#x73B0;</p>
<pre><code class="lang-go">// NewSocket allocates a new Socket using the REP protocol.
func NewSocket() (protocol.Socket, error) {
    //&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x662F;REP&#x7C7B;&#x578B;&#x7684;protocol&#x7684;&#x5B9E;&#x73B0;&#x7684;&#x5B9E;&#x4F8B;
    return protocol.MakeSocket(NewProtocol()), nil
}
</code></pre>
<p>REP&#x7C7B;&#x578B;&#x7684;protocol&#x7684;&#x5B9E;&#x73B0;&#x7684;&#x5B9E;&#x4F8B;:</p>
<pre><code class="lang-go">// NewProtocol allocates a protocol state for the REP protocol.
func NewProtocol() protocol.Protocol {
    s := &amp;socket{
        ttl:      8, //&#x9ED8;&#x8BA4;&#x6700;&#x5927;&#x652F;&#x6301;8&#x8DF3;, &#x5373;&#x4E2D;&#x95F4;&#x6709;7&#x4E2A;&quot;router&quot;&#x5B58;&#x5728;
        contexts: make(map[*context]struct{}),
        recvQ:    make(chan recvQEntry), // unbuffered! &#x6CE8;&#x91CA;&#x5199;&#x7684;&#x5F88;&#x6E05;&#x695A;, &#x975E;&#x7F13;&#x51B2;&#x7684;channel
        master: &amp;context{
            closeQ: make(chan struct{}),
        },
    }
    s.master.s = s
    s.contexts[s.master] = struct{}{}
    return s
}
</code></pre>
<p>&#x5176;&#x6838;&#x5FC3;&#x5B9E;&#x73B0;&#x7ED3;&#x6784;&#x4F53;:</p>
<pre><code class="lang-go">type socket struct {
    closed   bool
    ttl      int
    sendQLen int
    recvQ    chan recvQEntry //&#x8FD9;&#x4E2A;socket&#x53EA;&#x6709;recvQ, &#x6CA1;&#x6709;sendQ? &#x800C;&#x4E14;&#x8FD9;&#x4E2A;recvQ&#x53EF;&#x4EE5;&#x5927;&#x7EA6;&#x8BA4;&#x4E3A;&#x53EA;&#x6709;1&#x4E2A;&#x69FD;&#x4F4D;.
    contexts map[*context]struct{}
    master   *context
    sync.Mutex
}
</code></pre>
<h4 id="addpipe"><a name="addpipe" class="anchor-navigation-ex-anchor" href="#addpipe"><i class="fa fa-link" aria-hidden="true"></i></a>AddPipe</h4>
<p>&#x5728;AddPipe()&#x7684;&#x65F6;&#x5019;, &#x540C;&#x65F6;&#x8D77;&#x4E86;sender routine&#x548C;receiver routine.
&#x8FD9;&#x91CC;&#x7684;protocol.Pipe&#x662F;&#x5BF9;&#x5E95;&#x5C42;transport.Pipe&#x7684;&#x5C01;&#x88C5;, &#x5B9E;&#x73B0;&#x4E86;&#x6838;&#x5FC3;&#x5C42;ProtocolPipe&#x7684;&#x63A5;&#x53E3;&#x8981;&#x6C42;.</p>
<pre><code class="lang-go">func (s *socket) AddPipe(pp protocol.Pipe) error {
    p := &amp;pipe{
        p:      pp,
        s:      s,
        sendQ:  make(chan *protocol.Message, s.sendQLen), //sendQlen&#x662F;&#x6709;Q size&#x7684;
        closeQ: make(chan struct{}),
    }
    pp.SetPrivate(p) //&#x5404;&#x79CD;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x53D8;&#x8EAB;&#x6210;&#x4E86;&#x540D;&#x6B63;&#x8A00;&#x987A;&#x7684;&#x63A5;&#x53E3;&#x7684;&#x4F7F;&#x7528;
    s.Lock()
    if s.closed {
        s.Unlock()
        return protocol.ErrClosed
    }
    go p.sender() //&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;sender
    go p.receiver() //&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;receiver
    s.Unlock()
    return nil
}

func (s *socket) RemovePipe(pp protocol.Pipe) {
    p := pp.GetPrivate().(*pipe) //&#x8FD9;&#x91CC;&#x5BF9;&#x5E94;&#x4E86;AddPipe&#x7684;&#x65F6;&#x5019;SetPrivate(&#x5B58;&#x94B1;), &#x8FD9;&#x91CC;&#x5C31;&#x6765;&#x53D6;&#x94B1;&#x4E86;.
    close(p.closeQ)
}
</code></pre>
<p>&#x6CE8;&#x610F;, </p>
<ul>
<li>&#x8FD9;&#x91CC;&#x7684;sendQLen&#x9ED8;&#x8BA4;&#x4E3A;0; &#x4F46;&#x4E00;&#x822C;&#x4F1A;&#x8C03;&#x7528;<code>SetOption()</code>&#x63A5;&#x53E3;&#x628A;<code>protocol.OptionWriteQLen</code>&#x8BBE;&#x4E3A;1, &#x9700;&#x8981;&#x624B;&#x52A8;&#x8BBE;&#x7F6E;.</li>
</ul>
<pre><code class="lang-go">protocol/rep/rep_test.go-101-   p := GetSocket(t, xreq.NewSocket)
protocol/rep/rep_test.go:102:   MustSucceed(t, s.SetOption(mangos.OptionWriteQLen, 1))
protocol/rep/rep_test.go-103-   MustSucceed(t, p.SetOption(mangos.OptionReadQLen, 1))
</code></pre>
<p>&#x672C;&#x6587;&#x8BED;&#x5883;&#x4E0B;&#x7684;</p>
<ul>
<li>socket&#x6709;recvQ</li>
<li>pipe&#x6709;sendQ</li>
</ul>
<h4 id="&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;sender"><a name="&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;sender" class="anchor-navigation-ex-anchor" href="#&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;sender"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;sender</h4>
<p>&#x4ECE;sendQ&#x91CC;&#x9762;&#x62FF;&#x4E00;&#x4E2A;msg, &#x53D1;&#x9001;; &#x53D1;&#x9001;&#x5931;&#x8D25;&#x5C31;&#x5173;&#x95ED;&#x8FD9;&#x4E2A;pipe.</p>
<pre><code class="lang-go">func (p *pipe) sender() {
    for {
        select {
        case m := &lt;-p.sendQ:
            if p.p.SendMsg(m) != nil {
                p.close()
                return
            }
        case &lt;-p.closeQ:
            return
        }
    }
}
</code></pre>
<h4 id="&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;receiver"><a name="&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;receiver" class="anchor-navigation-ex-anchor" href="#&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;receiver"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x4E00;&#x4E2A;receiver</h4>
<p>&#x4ECE;&#x5E95;&#x5C42;&#x901A;&#x9053;&#x6536;&#x5305;, &#x68C0;&#x67E5;hops&#x662F;&#x5426;&#x8D85;&#x8FC7;ttl
&#x6700;&#x540E;&#x653E;&#x5230;socket&#x7684;recvQ&#x4E2D;</p>
<pre><code class="lang-go">func (p *pipe) receiver() {
    s := p.s
outer:
    for {
        m := p.p.RecvMsg() //&#x4ECE;protocol pipe&#x6536;msg, &#x5176;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x5728;core/pipe.go; &#x6700;&#x7EC8;&#x662F;transport&#x5C42;&#x6536;&#x5305;
        if m == nil {
            break
        }

        // Move backtrace from body to header.
        // &#x6BCF;4&#x4E2A;&#x5B57;&#x8282;&#x8868;&#x793A;&#x4E00;&#x8DF3;, &#x6700;&#x5F00;&#x59CB;&#x90FD;&#x4F1A;&#x6709;&#x4E00;&#x8DF3;; &#x6700;&#x9AD8;&#x4F4D;&#x4E0D;&#x662F;0&#x5C31;&#x4E0D;&#x662F;&#x4E00;&#x8DF3;
        // hop&#x4FE1;&#x606F;&#x662F;&#x4FDD;&#x5B58;&#x5728;body&#x91CC;&#x9762;&#x7684;, &#x56E0;&#x4E3A;header&#x597D;&#x50CF;&#x662F;&#x56FA;&#x5B9A;&#x5B57;&#x8282;&#x7684;, &#x4E0D;&#x53EF;&#x80FD;&#x628A;&#x6240;&#x6709;hop&#x90FD;&#x653E;&#x8FDB;&#x53BB;.
        hops := 0
        for {
            if hops &gt;= s.ttl {
                m.Free() // ErrTooManyHops
                continue outer
            }
            hops++
            if len(m.Body) &lt; 4 {
                m.Free() // ErrGarbled
                continue outer
            }
            m.Header = append(m.Header, m.Body[:4]...)
            m.Body = m.Body[4:]
            // Check for high order bit set (0x80000000, big endian)
            if m.Header[len(m.Header)-4]&amp;0x80 != 0 {
                break
            }
        }

        entry := recvQEntry{m: m, p: p}
        select {
        case s.recvQ &lt;- entry: //&#x6536;&#x5230;&#x653E;&#x5230;recvQ
        case &lt;-p.closeQ:
            // Either the pipe or the socket has closed (which
            // closes the pipe.)  In either case, we have no
            // way to return a response, so we have to abandon.
            m.Free()
            break outer
        }
    }
    go p.close()
}
</code></pre>
<h4 id="recvmsg_1"><a name="recvmsg_1" class="anchor-navigation-ex-anchor" href="#recvmsg_1"><i class="fa fa-link" aria-hidden="true"></i></a>RecvMsg</h4>
<p>&#x7528;&#x6237;&#x8C03;&#x7528;Recv, core&#x4F1A;&#x8C03;&#x7528;&#x5230;&#x8FD9;&#x91CC;</p>
<pre><code class="lang-go">func (c *context) RecvMsg() (*protocol.Message, error) {
    s := c.s
    s.Lock()

    //&#x5148;&#x662F;&#x68C0;&#x67E5;&#x4E9B;&#x72B6;&#x6001;
    if c.closed {
        s.Unlock()
        return nil, protocol.ErrClosed
    }
    //&#x5728;&#x8FD9;&#x4E2A;recv&#x6CA1;&#x6709;&#x7ED3;&#x675F;&#x4E4B;&#x524D;, &#x4E0D;&#x80FD;&#x518D;&#x6B21;recv; &#x5C31;&#x662F;&#x8BF4;recv&#x8DEF;&#x5F84;&#x4E0B;&#x4E0D;&#x80FD;&#x6709;&#x5E76;&#x53D1;
    if c.recvWait {
        s.Unlock()
        return nil, protocol.ErrProtoState
    }
    c.recvWait = true

    cq := c.closeQ
    wq := nilQ
    expireTime := c.recvExpire
    s.Unlock()

    if expireTime &gt; 0 {
        wq = time.After(expireTime)
    }

    var err error
    var m *protocol.Message
    var p *pipe

    select {
    case entry := &lt;-s.recvQ: //&#x4ECE;recvQ&#x91CC;&#x9762;&#x53D6;&#x4E00;&#x4E2A;. &#x8FD9;&#x4E2A;recvQ&#x662F;unbuffered&#x7684;. &#x6240;&#x6709;&#x8FDE;&#x63A5;&#x7684;receiver routine&#x90FD;&#x4F1A;&#x5F80;&#x8FD9;&#x91CC;&#x5199;. &#x4F46;&#x8BFB;&#x5C31;&#x53EA;&#x6709;&#x7528;&#x6237;&#x6001;API&#x8C03;&#x7528;&#x4E0B;&#x6765;, &#x800C;&#x4E14;&#x6574;&#x4E2A;&#x90FD;&#x662F;unbuffered.
        m, p = entry.m, entry.p
    case &lt;-wq:
        err = protocol.ErrRecvTimeout
    case &lt;-cq:
        err = protocol.ErrClosed
    }

    s.Lock()

    if m != nil {
        c.backtrace = append([]byte{}, m.Header...) //&#x8FD9;&#x6B21;&#x7684;header&#x4FDD;&#x5B58;&#x5728;context&#x7684;backtrace&#x91CC;, &#x6CE8;&#x610F;backtrace&#x53EA;&#x6709;&#x4E00;&#x4E2A;msg&#x7684;header
        m.Header = nil
        c.recvPipe = p //&#x4FDD;&#x5B58;&#x4ECE;&#x54EA;&#x4E2A;pipe&#x6765;&#x7684;msg
    }
    c.recvWait = false
    s.Unlock()
    return m, err
}
</code></pre>
<h4 id="sendmsg"><a name="sendmsg" class="anchor-navigation-ex-anchor" href="#sendmsg"><i class="fa fa-link" aria-hidden="true"></i></a>SendMsg</h4>
<p>&#x7528;&#x6237;&#x8C03;&#x7528;send, &#x6838;&#x5FC3;&#x5C42;&#x4F1A;&#x8C03;&#x7528;&#x5230;&#x8FD9;&#x91CC;
rep&#x670D;&#x52A1;&#x5668;&#x7684;&#x903B;&#x8F91;&#x662F;, &#x5FC5;&#x987B;&#x5148;recv, &#x518D;send, &#x8FD9;&#x4E24;&#x8005;&#x5FC5;&#x987B;&#x6210;&#x5BF9;&#x51FA;&#x73B0;. &#x800C;&#x4E14;&#x4E2D;&#x95F4;&#x4E0D;&#x80FD;&#x6709;&#x5176;&#x4ED6;&#x7684;recv&#x6216;send.</p>
<pre><code class="lang-go">func (c *context) SendMsg(m *protocol.Message) error {
    r := c.s
    r.Lock()

    if r.closed || c.closed {
        r.Unlock()
        return protocol.ErrClosed
    }
    if c.backtrace == nil { //&#x6CA1;&#x6709;recv&#x8FC7;, &#x72B6;&#x6001;&#x9519;&#x8BEF;
        r.Unlock()
        return protocol.ErrProtoState
    }
    p := c.recvPipe //&#x53D1;&#x9001;&#x6765;&#x7684;&#x901A;&#x9053;
    c.recvPipe = nil

    bestEffort := c.bestEffort
    timeQ := nilQ
    if bestEffort {
        timeQ = closedQ
    } else if c.sendExpire &gt; 0 {
        timeQ = time.After(c.sendExpire)
    }

    m.Header = c.backtrace //&#x56DE;&#x590D;&#x7ED9;client&#x7684;header&#x5C31;&#x662F;client&#x5F53;&#x65F6;&#x53D1;&#x8FC7;&#x6765;&#x7684;, &#x4E00;&#x6A21;&#x4E00;&#x6837;.
    c.backtrace = nil
    cq := c.closeQ
    r.Unlock()

    select { //&#x8FD9;&#x4E2A;&#x662F;&#x7ECF;&#x5178;&#x7684;select&#x7ED3;&#x6784;:&#x5E26;timeout, &#x5E26;close&#x7684;&#x9009;&#x62E9;&#x5668;
    case &lt;-cq:
        m.Header = nil
        return protocol.ErrClosed
    case &lt;-p.closeQ:
        // Pipe closed, so no way to get it to the recipient.
        // Just discard the message.
        m.Free()
        return nil
    case &lt;-timeQ: //&#x8FD9;&#x91CC;&#x6709;&#x4E2A;bug: &#x5728;best effort&#x6A21;&#x5F0F;&#x4E0B;, timeQ&#x662F;&#x5DF2;&#x7ECF;&#x5173;&#x95ED;&#x7684;Q, &#x6839;&#x636E;select&#x8BED;&#x4E49;, &#x5047;&#x5982;sendQ&#x4E5F;&#x80FD;&#x5199;, select&#x4F1A;&#x968F;&#x673A;&#x9009;&#x4E00;&#x4E2A;case&#x6267;&#x884C;; &#x90A3;&#x4E48;m&#x53EF;&#x80FD;&#x6839;&#x672C;&#x5C31;&#x6CA1;&#x6709;&#x88AB;&#x5C1D;&#x8BD5;&#x53D1;&#x9001;&#x5230;sendQ&#x4E2D;, &#x56E0;&#x4E3A;timeQ&#x5148;&#x6267;&#x884C;&#x4E86;.
        if bestEffort {
            // No way to report to caller, so just discard
            // the message.
            m.Free()
            return nil
        }
        m.Header = nil
        return protocol.ErrSendTimeout

    case p.sendQ &lt;- m: //&quot;&#x53D1;&#x9001;&quot;&#x5230;&#x6536;&#x62A5;&#x6587;&#x7684;pipe&#x7684;sendQ&#x4E2D;
        return nil
    }
}
</code></pre>
<h4 id="rep&#x5C0F;&#x8282;"><a name="rep&#x5C0F;&#x8282;" class="anchor-navigation-ex-anchor" href="#rep&#x5C0F;&#x8282;"><i class="fa fa-link" aria-hidden="true"></i></a>REP&#x5C0F;&#x8282;</h4>
<p>&#x4ECE;&#x7528;&#x6237;&#x4FA7;&#x770B;&#x6765;, &#x4F7F;&#x7528;rep&#x5F88;&#x7B80;&#x5355;:</p>
<pre><code class="lang-go">sock, err = rep.NewSocket() //&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;rep socket&#x5B9E;&#x4F8B;
err = sock.Listen(url) //&#x63A5;&#x53D7;&#x8FDE;&#x63A5;. &#x6838;&#x5FC3;&#x5C42;&#x6709;&#x4E2A;goroutine&#x4F1A;&#x5FAA;&#x73AF;&#x7B49;&#x5F85;&#x65B0;&#x8FDE;&#x63A5;. &#x6BCF;&#x4E2A;&#x6210;&#x529F;&#x5EFA;&#x7ACB;&#x7684;&#x8FDE;&#x63A5;&#x90FD;&#x4F1A;&#x8C03;&#x7528;protocol&#x7684;AddPipe()&#x52A8;&#x4F5C;, &#x540E;&#x8005;&#x4F1A;&#x8D77;&#x540E;&#x53F0;&#x7684;sender&#x548C;receiver
msg, err = sock.Recv() //&#x7528;&#x6237;&#x53D1;&#x8D77;&#x4E00;&#x6B21;recv, &#x4F1A;&#x4ECE;socket.recvQ&#x4E2D;&#x63A5;&#x6536;&#x4E00;&#x4E2A;msg, &#x8FD9;&#x6837;&quot;&#x4F17;&#x591A;&quot;&#x7684;&#x8FDE;&#x63A5;&#x7684;receiver routine&#x7684;&#x5199;recvQ&#x7684;&#x52A8;&#x4F5C;&#x624D;&#x80FD;&#x5F80;&#x4E0B;&#x8D70;. &#x8FD9;&#x4E2A;recvQ&#x662F;&#x963B;&#x585E;&#x7684;.

&#x7528;&#x6237;&#x5728;recv&#x548C;send&#x4E4B;&#x95F4;&#x505A;&#x4E1A;&#x52A1;&#x903B;&#x8F91;
err = sock.Send([]byte(d)) //&#x56E0;&#x4E3A;recv&#x8BB0;&#x5F55;&#x4E86;&#x6765;&#x7684;&#x8DEF;&#x5F84;&#x5230;&#x4E0A;&#x4E0B;&#x6587;, send&#x7684;reply&#x4F1A;&#x6839;&#x636E;&#x4E0A;&#x4E0B;&#x6587;&#x6CBF;&#x8DEF;&#x8FD4;&#x56DE;&#x5230;client
</code></pre>
<ul>
<li>&#x6240;&#x6709;&#x8FDE;&#x63A5;&#x80CC;&#x540E;&#x7684;receiver&#x6536;&#x5305;&#x540E;, &#x90FD;&#x4F1A;&#x5F80;<code>s.recvQ</code>&#x4E2D;&#x5199;&#x4E00;&#x4E2A;entry(&#x4E5F;&#x5C31;&#x662F;msg), &#x8FD9;&#x4E2A;recvQ&#x662F;unbuffered.&#x5373;&#x6240;&#x6709;&#x5199;&#x90FD;&#x4F1A;&#x963B;&#x585E;, &#x540C;&#x65F6;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x80FD;&#x5199;; &#x5728;&#x7528;&#x6237;&#x6CA1;&#x6709;&#x8C03;&#x7528;&#x6700;&#x9876;&#x5C42;&#x7684;recv&#x65F6;, &#x5168;&#x90E8;&#x8FDE;&#x63A5;&#x7684;&#x6536;&#x5305;&#x90FD;&#x4E0D;&#x80FD;&#x7EE7;&#x7EED;.</li>
<li>&#x5F53;&#x7528;&#x6237;&#x8C03;&#x7528;&#x4E86;&#x9876;&#x5C42;recv&#x5904;&#x7406;&#x4E86;&#x4E00;&#x4E2A;req&#x540E;, &#x4E0B;&#x4E00;&#x4E2A;req&#x7684;msg&#x4F1A;&#x88AB;&#x9001;&#x5165;<code>s.recvQ</code></li>
<li>receiver&#x6536;&#x5305;&#x540E;, &#x4F1A;&#x628A;msg&#x548C;&#x4EE3;&#x8868;&#x8FDE;&#x63A5;&#x4FE1;&#x606F;&#x7684;pipe&#x4E00;&#x8D77;, &#x53D1;&#x7ED9;<code>s.recvQ</code></li>
<li>&#x7528;&#x6237;recv&#x5E76;&#x8FDB;&#x884C;&#x4E86;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x7684;&#x5904;&#x7406;&#x540E;, &#x8C03;&#x7528;send, &#x628A;&#x76F8;&#x5E94;msg&#x6CBF;&#x8DEF;&#x8FD4;&#x56DE;&#x53D1;&#x9001;&#x56DE;client.</li>
<li>recv&#x548C;send&#x65F6;&#x4E25;&#x683C;&#x7684;lock step&#x6A21;&#x5F0F;. &#x5373;&#x4E00;&#x4E2A;context&#x540C;&#x65F6;&#x53EA;&#x80FD;&#x5904;&#x7406;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;; &#x6211;&#x8BA4;&#x4E3A;&#x5982;&#x679C;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x590D;&#x6742;, <ul>
<li>&#x8981;&#x4E48;&#x8C03;&#x7528;&#x9876;&#x5C42;API<code>OpenContext()</code>&#x521B;&#x5EFA;&#x5E76;&#x4F7F;&#x7528;&#x591A;context&#x6765;&#x5E76;&#x53D1;&#x5904;&#x7406; -- &#x53EF;&#x884C;.</li>
<li>&#x8981;&#x4E48;&#x5C31;&#x7528;&#x5F53;&#x524D;context, &#x4F46;&#x7528;go&#x7684;&#x65B9;&#x5F0F;&#x5904;&#x7406;&#x4E1A;&#x52A1;&#x903B;&#x8F91;? -- &#x4E0D;&#x884C;, &#x56E0;&#x4E3A;recv&#x548C;send&#x4E4B;&#x95F4;&#x7528;context&#x6765;&#x4F20;&#x9012;&#x4E0A;&#x4E0B;&#x6587;, &#x6BD4;&#x5982;recv&#x540E;, &#x7528;<code>c.backtrace</code>&#x4FDD;&#x5B58;req&#x7684;header; send&#x7684;&#x65F6;&#x5019;&#x53C8;&#x8981;&#x7528;&#x8FD9;&#x4E2A;header. &#x5982;&#x679C;&#x4EA7;&#x751F;&#x5E76;&#x53D1;, <code>c.backtrace</code>&#x4F1A;&#x88AB;&#x540E;&#x7EED;&#x7684;&#x65B0;&#x7684;recv&#x8986;&#x76D6;.</li>
</ul>
</li>
<li>rep&#x652F;&#x6301;&#x591A;&#x8DF3;(hops), hops&#x4FE1;&#x606F;&#x88AB;&#x4FDD;&#x5B58;&#x5728;msg.Body&#x91CC;&#x9762;; &#x5728;receiver&#x91CC;&#x9762;, hops&#x4FE1;&#x606F;&#x88AB;&#x642C;&#x5230;msg.Header&#x91CC;</li>
<li>&#x5728;socket&#x7EA7;&#x522B;&#x53EA;&#x6709;&#x4E00;&#x4E2A;unbuffered&#x7684;recvQ, &#x6CA1;&#x6709;sendQ; sendQ&#x662F;&#x4EE3;&#x8868;&#x8FDE;&#x63A5;&#x7684;pipe&#x7684;&#x5C5E;&#x6027;. &#x5728;&#x53D1;&#x9001;&#x7684;&#x65F6;&#x5019;, rep msg&#x4F1A;&#x88AB;&#x5148;&#x653E;&#x5230;&#x5BF9;&#x5E94;&#x8FDE;&#x63A5;&#x7684;sendQ&#x91CC;, &#x5728;sender routine&#x91CC;, &#x8C03;&#x7528;protocol pipe&#x6765;&#x771F;&#x6B63;&#x53D1;&#x9001;.<ul>
<li>&#x4E0D;&#x8981;&#x88AB;protocol pipe&#x7684;&#x540D;&#x5B57;&#x8FF7;&#x60D1;, &#x5B83;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x6838;&#x5FC3;&#x5C42;core&#x5BF9;transport&#x7684;pipe&#x7684;&#x5305;&#x88C5;.</li>
</ul>
</li>
<li>&#x4E0D;&#x8981;&#x4F7F;&#x7528;bestEffort&#x9009;&#x9879;, rep&#x4F1A;&#x968F;&#x673A;&quot;&#x4E0D;&#x53D1;&quot;&#x54CD;&#x5E94;.</li>
<li>&#x53D1;&#x9001; reply&#x5931;&#x8D25;&#x6CA1;&#x6709;&#x91CD;&#x4F20;, &#x8D85;&#x65F6;&#x4E86;&#x4F1A;&#x8FD4;&#x56DE;<code>protocol.ErrSendTimeout</code></li>
</ul>
<h3 id="req-rep&#x7591;&#x95EE;"><a name="req-rep&#x7591;&#x95EE;" class="anchor-navigation-ex-anchor" href="#req-rep&#x7591;&#x95EE;"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.3. req rep&#x7591;&#x95EE;</h3>
<ul>
<li>&#x4E3A;&#x4EC0;&#x4E48;req&#x7684;&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;&#x662F;sync.cond + softirq&#x5F0F;&#x7684;&#x5EF6;&#x8FDF;&#x6267;&#x884C;, &#x800C;rep&#x7684;&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;&#x662F;&#x7B80;&#x5355;&#x660E;&#x4E86;&#x7684;channel?</li>
<li>&#x5728;req&#x548C;rep&#x7684;receiver&#x5B9E;&#x73B0;&#x4E2D;, &#x90FD;&#x6709;&#x4E0B;&#x9762;&#x7684;&#x64CD;&#x4F5C;: &#x628A;body&#x79FB;&#x52A8;4&#x4E2A;&#x5B57;&#x8282;&#x7ED9;header, &#x5982;&#x679C;&#x8BF4;body&#x7684;&#x524D;&#x56DB;&#x4E2A;&#x5B57;&#x8282;&#x6709;&#x7279;&#x6B8A;&#x610F;&#x4E49;, &#x4F46;&#x4E3A;&#x4EC0;&#x4E48;&#x6CA1;&#x6709;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x53D1;&#x9001;&#x65F6;&#x5019;&#x586B;&#x5165;&#x7684;&#x8FD9;&#x56DB;&#x4E2A;&#x5B57;&#x8282;? &#x4ED6;&#x4EEC;&#x662F;&#x5728;&#x54EA;&#x91CC;&#x586B;&#x5165;&#x7684;?<pre><code class="lang-go">m.Header = append(m.Header, m.Body[:4]...)
m.Body = m.Body[4:]
</code></pre>
&#x7B54;: &#x4ED6;&#x4EEC;&#x662F;&#x5728;transport&#x5C42;&#x586B;&#x5165;&#x7684;. &#x5728;transport&#x5C42;&#x770B;&#x6765;, header&#x548C;body&#x662F;&#x4E00;&#x4F53;&#x7684;, transport&#x5148;&#x8BA1;&#x7B97;&#x603B;&#x7684;size(int64), &#x7136;&#x540E;&#x628A;(size, header, body)&#x5199;&#x5165;&#x901A;&#x9053;; &#x800C;&#x63A5;&#x6536;&#x7684;&#x65F6;&#x5019;, &#x5148;&#x7528;&#x4E00;&#x6B21;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5F97;&#x51FA;size, &#x518D;&#x628A;&#x5269;&#x4E0B;&#x7684;&#x5185;&#x5BB9;&#x5168;&#x90E8;&#x653E;&#x5230;body&#x4E2D;. &#x8FD9;&#x5C31;&#x89E3;&#x91CA;&#x4E86;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0A;&#x9762;&#x7684;protocol&#x5C42;&#x7684;&#x4EE3;&#x7801;&#x4E2D;, &#x8981;&#x4ECE;body&#x4E2D;&#x8FD8;&#x539F;header&#x4E86;...</li>
</ul>
<h3 id="xreq&#x548C;xrep"><a name="xreq&#x548C;xrep" class="anchor-navigation-ex-anchor" href="#xreq&#x548C;xrep"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.4. xreq&#x548C;xrep</h3>
<p>xreq&#x548C;xrep&#x662F;&#x7B80;&#x5316;&#x7248;&#x7684;req&#x548C;rep, &#x4ED6;&#x4EEC;&#x90FD;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#x534F;&#x8BAE;&#x65CF;.</p>
<ul>
<li>&#x4ED6;&#x4EEC;&#x90FD;&#x6CA1;&#x6709;context&#x7684;&#x6982;&#x5FF5;</li>
<li>&#x5B9E;&#x4F8B;&#x4EE3;&#x7801;&#x5728;examples/raw</li>
</ul>
<h4 id="xreq"><a name="xreq" class="anchor-navigation-ex-anchor" href="#xreq"><i class="fa fa-link" aria-hidden="true"></i></a>xreq</h4>
<p>xreq&#x4F3C;&#x4E4E;&#x6539;&#x7528;&#x4E86;channel, &#x66F4;&#x7B80;&#x5355;, &#x529F;&#x80FD;&#x4F3C;&#x4E4E;&#x4E5F;&#x5220;&#x51CF;&#x4E86;...</p>
<ul>
<li>xreq&#x7684;socket&#x6709;recvQ&#x548C;sendQ&#x7684;channel, &#x91CC;&#x9762;&#x662F;msg, &#x9ED8;&#x8BA4;&#x90FD;&#x662F;128&#x4E2A;&#x957F;&#x5EA6;</li>
<li>&#x5728;AddPipe()&#x9636;&#x6BB5;&#x6539;&#x6210;&#x4E86;&#x548C;&#x4E0A;&#x9762;rep&#x4E00;&#x6837;&#x7684;&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x90FD;&#x6709;&#x540E;&#x53F0;&#x7684;sender&#x548C;receiver</li>
<li>&#x5728;receiver&#x4E2D;, &#x8FD8;&#x662F;&#x4F1A;&#x628A;&#x5BF9;&#x7AEF;&#x53D1;&#x6765;&#x7684;body&#x7684;&#x5934;&#x56DB;&#x4E2A;&#x5B57;&#x8282;&#x5F53;&#x4F5C;header, &#x4F46;&#x8FD9;&#x6B21;&#x662F;&#x76F4;&#x63A5;&#x5F53;header, &#x800C;&#x4E0D;&#x662F;append<pre><code class="lang-go">m.Header = m.Body[:4]
m.Body = m.Body[4:]
</code></pre>
</li>
<li>&#x7ADF;&#x7136;&#x8FD8;&#x662F;&#x6709;timeQ&#x7684;bug????</li>
<li>xreq&#x6CA1;&#x6709;&#x5931;&#x8D25;&#x81EA;&#x52A8;&#x91CD;&#x4F20;</li>
</ul>
<h4 id="xrep"><a name="xrep" class="anchor-navigation-ex-anchor" href="#xrep"><i class="fa fa-link" aria-hidden="true"></i></a>xrep</h4>
<ul>
<li>&#x9ED8;&#x8BA4;&#x7684;recvQ&#x6709;128&#x7684;&#x957F;&#x5EA6;, &#x800C;rep&#x662F;unbuffered</li>
<li>AddPipe()&#x4F9D;&#x7136;&#x6709;receiver&#x548C;sender&#x540E;&#x53F0;routine</li>
<li>&#x53D6;&#x6D88;&#x4E86;context, &#x5728;&#x63A5;&#x6536;msg&#x7684;&#x65F6;&#x5019;, &#x628A;pipe&#x4FE1;&#x606F;&#x76F4;&#x63A5;&#x52A0;&#x5230;msg header&#x4E2D;.</li>
<li>&#x53D1;&#x9001;msg&#x7684;&#x65F6;&#x5019;, &#x770B;header&#x5C31;&#x77E5;&#x9053;pipe ID, &#x5C31;&#x80FD;&#x539F;&#x8DEF;&#x8FD4;&#x56DE;</li>
<li>&#x8FD9;&#x6837;&#x641E;&#x5C31;&#x5FC5;&#x987B;&#x8981;&#x6C42;&#x7528;&#x6237;&#x76F4;&#x63A5;&#x4F7F;&#x7528;RecvMsg&#x548C;SendMsg</li>
</ul>
<h3 id="&#x518D;&#x770B;&#x6838;&#x5FC3;&#x5C42;&#x7684;&#x6838;&#x5FC3;&#x4EF7;&#x503C;"><a name="&#x518D;&#x770B;&#x6838;&#x5FC3;&#x5C42;&#x7684;&#x6838;&#x5FC3;&#x4EF7;&#x503C;" class="anchor-navigation-ex-anchor" href="#&#x518D;&#x770B;&#x6838;&#x5FC3;&#x5C42;&#x7684;&#x6838;&#x5FC3;&#x4EF7;&#x503C;"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.5. &#x518D;&#x770B;&#x6838;&#x5FC3;&#x5C42;&#x7684;&#x6838;&#x5FC3;&#x4EF7;&#x503C;</h3>
<ul>
<li>&#x63D0;&#x4F9B;&#x4E86;socket&#x5BF9;&#x8C61;&#x7684;&#x5B9E;&#x73B0;, &#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x88AB;protocol&#x5C42;&#x4F20;&#x9012;&#x7ED9;&#x7528;&#x6237;, &#x5B83;&#x5C31;&#x662F;&#x7528;&#x6237;&#x770B;&#x5230;&#x7684;socket.<ul>
<li>&#x8FD9;&#x4E2A;socket&#x5BF9;&#x8C61;&#x6301;&#x6709;&#x7684;&#x6570;&#x636E;&#x90FD;&#x662F;&#x79C1;&#x6709;&#x7684;, &#x5BF9;&#x5916;&#x53EA;&#x63D0;&#x4F9B;&#x63A5;&#x53E3;</li>
<li>&#x8FD9;&#x4E2A;socket&#x662F;client&#x548C;server&#x7684;&#x7ED3;&#x5408;&#x4F53;, &#x65E2;&#x6709;listener&#x5217;&#x8868;, &#x53C8;&#x6709;dialer&#x5217;&#x8868;</li>
<li>&#x6301;&#x6709;&#x4EE3;&#x8868;&#x8FDE;&#x63A5;&#x7684;&#x6838;&#x5FC3;&#x5BF9;&#x8C61;pipes, &#x88AB;&#x7EC4;&#x7EC7;&#x6210;&#x6309;ID(unit32)&#x67E5;&#x8BE2;&#x7684;map</li>
<li>&#x6709;&#x4E00;&#x628A;&#x5168;&#x5C40;socket&#x9501;</li>
<li>&#x6709;&#x5176;&#x4ED6;&#x7684;&#x5C5E;&#x6027;&#x548C;&#x6807;&#x8BB0;, &#x6BD4;&#x5982;&#x662F;&#x5426;&#x5F02;&#x6B65;dial, &#x6700;&#x5927;&#x63A5;&#x6536;size&#x7B49;.</li>
</ul>
</li>
<li>protocol&#x5C42;&#x4F1A;&#x8C03;&#x7528;core&#x7684;MakeSocket()&#x6765;&#x521B;&#x5EFA;socket, &#x6838;&#x5FC3;&#x5C42;&#x53EA;&#x662F;&#x65B0;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;socket&#x7ED3;&#x6784;&#x4F53;&#x8FD4;&#x56DE;, &#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x5176;&#x4ED6;&#x7684;routine&#x7684;&#x521B;&#x5EFA;.</li>
<li>&#x6838;&#x5FC3;&#x52A8;&#x4F5C;Dial&#x548C;DialOptions&#x6700;&#x7EC8;&#x7531;&#x7528;&#x6237;&#x8C03;&#x7528;. &#x6CE8;&#x610F;, &#x6B64;&#x65F6;socket&#x5C31;&#x5DF2;&#x7ECF;&#x77E5;&#x9053;transport&#x7684;&#x5177;&#x4F53;&#x7C7B;&#x578B;&#x4E86;. &#x5B9E;&#x9645;&#x52A8;&#x4F5C;&#x5305;&#x62EC;&#x4E24;&#x6B65;:<ul>
<li>&#x5148;&#x8C03;&#x7528;&#x548C;transport&#x7EA6;&#x5B9A;&#x597D;&#x7684;&#x7684;NewDialer()&#x63A5;&#x53E3;<code>td, err := t.NewDialer(addr, s)</code>, &#x5E76;&#x5305;&#x88C5;&#x8FD9;&#x4E2A;<code>td</code>, &#x6784;&#x6210;&#x6838;&#x5FC3;&#x5C42;&#x7684;<code>dialer</code>&#x7ED3;&#x6784;&#x4F53;. &#x6700;&#x540E;&#x628A;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x653E;&#x5230;<code>s.dialers</code>&#x4E2D;.</li>
<li>&#x8C03;&#x7528;&#x540C;&#x662F;&#x6838;&#x5FC3;&#x5C42;&#x7684;dialer.go&#x4E2D;&#x7684;Dial<ul>
<li>&#x68C0;&#x67E5;&#x72B6;&#x6001;, &#x8C03;&#x7528;transport&#x5C42;&#x7684;Dial&#x65B9;&#x6CD5;; &#x8FDE;&#x63A5;&#x6210;&#x529F;&#x4F1A;&#x8C03;&#x7528;&#x6838;&#x5FC3;&#x5C42;&#x7684;addPipe()&#x65B9;&#x6CD5;, &#x540E;&#x9762;&#x4F1A;&#x8BB2;.</li>
<li>redial&#x6A21;&#x5F0F;&#x4E0B;&#x4F1A;&#x540E;&#x53F0;dial, &#x8FD9;&#x91CC;&#x63D0;&#x524D;&#x8FD4;&#x56DE;nil; &#x540E;&#x53F0;redial&#x6709;&#x91CD;&#x8BD5;&#x7684;&#x907F;&#x8BA9;&#x7B56;&#x7565;, &#x907F;&#x514D;&#x77ED;&#x65F6;&#x95F4;&#x5927;&#x91CF;&#x4E0D;&#x65AD;&#x91CD;&#x8BD5;</li>
<li>&#x975E;redial&#x6A21;&#x5F0F;&#x4E0B;, dial&#x4E0D;&#x6210;&#x529F;&#x9A6C;&#x4E0A;&#x8FD4;&#x56DE;err</li>
</ul>
</li>
</ul>
</li>
<li>&#x6838;&#x5FC3;&#x52A8;&#x4F5C;Listen&#x662F;server&#x7AEF;&#x7684;&#x7528;&#x6237;&#x52A8;&#x4F5C;<ul>
<li>&#x7B2C;&#x4E00;&#x6B65;&#x4E5F;&#x662F;&#x5904;&#x7406;&#x5B8C;option&#x540E;, &#x5305;&#x88C5;transport&#x5C42;&#x7684;<code>tl, err := t.NewListener(addr, s)</code>&#x5BF9;&#x8C61;<code>tl</code>, &#x505A;&#x4E3A;&#x6838;&#x5FC3;&#x5C42;&#x7684;listener&#x5B9E;&#x4F8B;.</li>
<li>&#x7B2C;&#x4E8C;&#x6B65;&#x662F;&#x8C03;&#x7528;transport&#x7684;listen, &#x8FD9;&#x4E2A;listen&#x5B9E;&#x9645;&#x4E0A;&#x662F;bind+listen&#x7684;&#x539F;&#x59CB;socket&#x7684;&#x52A8;&#x4F5C;</li>
<li>&#x7B2C;&#x4E09;&#x6B65;&#x662F;&#x8D77;&#x4E2A;&#x540E;&#x53F0;routine&#x6765;&#x505A;&#x5FAA;&#x73AF;<code>l.l.Accept()</code>, &#x5E76;&#x628A;&#x5EFA;&#x7ACB;&#x597D;&#x7684;pipe&#x52A0;&#x5230;socket: <code>l.s.addPipe(tp, nil, l)</code></li>
</ul>
</li>
<li>&#x6838;&#x5FC3;&#x52A8;&#x4F5C;&#x5728;Dial&#x6709;&#x91CD;&#x8BD5;, Listen&#x6709;&#x540E;&#x53F0;routine&#x505A;&#x5FAA;&#x73AF;accept, &#x8FD9;&#x4E9B;&quot;&#x9644;&#x52A0;&quot;&#x7684;&#x529F;&#x80FD;&#x662F;&#x6838;&#x5FC3;&#x5C42;&#x63D0;&#x4F9B;&#x7684;.</li>
<li>&#x6838;&#x5FC3;&#x5C42;&#x7684;Send/SendMsg, Recv/RecvMsg&#x90FD;&#x662F;&#x7528;&#x6237;&#x8C03;&#x7528;&#x89E6;&#x53D1;&#x7684;, &#x90FD;&#x662F;&#x76F4;&#x63A5;&#x8C03;&#x7528;protocol&#x5C42;&#x7684;SendMsg/RecvMsg</li>
<li>&#x6838;&#x5FC3;&#x5C42;&#x7684;&#x6838;&#x5FC3;&#x662F;pipe, &#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x90FD;&#x4F1A;addPipe(); &#x6838;&#x5FC3;&#x5C42;&#x7684;pipe&#x662F;&#x4E2A;&#x6DF7;&#x5408;&#x4F53;, &#x6709;dialer&#x548C;listener, &#x4F46;&#x4E00;&#x822C;&#x573A;&#x666F;&#x4E0B;, &#x4E0D;&#x662F;&#x540C;&#x65F6;&#x751F;&#x6548;.<ul>
<li>&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;, &#x4E0D;&#x7BA1;&#x662F;client dial&#x7684;&#x6765;&#x7684;, &#x8FD8;&#x662F;server listen&#x5F97;&#x6765;&#x7684;, &#x90FD;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;&#x6838;&#x5FC3;&#x5C42;&#x7684;pipe; &#x867D;&#x7136;&#x5B9E;&#x73B0;&#x5728;&#x6838;&#x5FC3;&#x5C42;, &#x4F46;&#x5BF9;&#x5916;&#x662F;&#x4EE5;protocol.Pipe&#x793A;&#x4EBA;&#x7684;, &#x5373;&#x6838;&#x5FC3;&#x5C42;&#x7684;pipe&#x5B9E;&#x73B0;&#x4E86;protocol&#x5C42;(&#x66F4;&#x786E;&#x5207;&#x7684;&#x8BF4;&#x6CD5;&#x662F;&#x5168;&#x5C40;&#x5C42;, &#x5BF9;&#x5916;&#x5C42;)Pipe&#x89C4;&#x5B9A;&#x7684;&#x65B9;&#x6CD5;.</li>
<li>addPipe()&#x4F1A;&#x65B0;&#x751F;&#x6210;&#x4E00;&#x4E2A;pipe&#x5B9E;&#x4F8B;, &#x5E76;&#x5206;&#x914D;&#x552F;&#x4E00;&#x7684;ID(unit32); &#x8FD9;&#x4E2A;pipe&#x5B9E;&#x4F8B;&#x88AB;socket&#x4FDD;&#x5B58;&#x5728;map&#x8868;&#x91CC;, &#x65B9;&#x4FBF;&#x540E;&#x9762;&#x6839;&#x636E;ID&#x67E5;&#x8BE2;</li>
<li>addPipe()&#x4F1A;&#x8C03;&#x7528;&#x4E0E;protocol&#x5C42;&#x7EA6;&#x5B9A;&#x597D;&#x7684;AddPipe()&#x65B9;&#x6CD5;<code>s.proto.AddPipe(p)</code>; &#x540E;&#x8005;&#x4F1A;&#x4FDD;&#x5B58;p&#x4EE5;&#x4FBF;&#x53D1;&#x9001;, &#x63A5;&#x6536;</li>
</ul>
</li>
<li><p>&#x6838;&#x5FC3;&#x5C42;&#x7684;pipe&#x7684;Send&#x548C;Recv&#x4EE5;&#x53CA;Close, &#x63D0;&#x4F9B;&#x5931;&#x8D25;&#x91CD;&#x8FDE;&#x7684;&#x529F;&#x80FD;.</p>
<ul>
<li>&#x56E0;&#x4E3A;&#x5728;addPipe&#x9636;&#x6BB5;, &#x4F1A;&#x628A;&#x6838;&#x5FC3;&#x5C42;&#x7684;pipe&#x5B9E;&#x4F8B;&#x4EE5;protocol.Pipe&#x63A5;&#x53E3;&#x7684;&#x5F62;&#x5F0F;&#x4F20;&#x9012;&#x7ED9;protocol, protocol&#x60F3;&#x771F;&#x6B63;&#x53D1;&#x9001; &#x63A5;&#x6536;msg&#x7684;&#x65F6;&#x5019;, &#x4F1A;&#x8C03;&#x7528;&#x5230;&#x6838;&#x5FC3;&#x5C42;pipe&#x63D0;&#x4F9B;&#x7684;SendMsg()&#x548C;RecvMsg()&#x65B9;&#x6CD5;, &#x8FD9;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#x90FD;&#x662F;&#x8C03;&#x7528;transport&#x5C42;&#x7684;&#x53D1;&#x9001;&#x63A5;&#x6536;&#x65B9;&#x6CD5;.</li>
<li>&#x7279;&#x522B;&#x7684;, &#x4ECE;&#x6838;&#x5FC3;&#x5C42;&#x6536;&#x5230;&#x7684;msg, &#x90FD;&#x4F1A;&#x8BB0;&#x5F55;pipe&#x4FE1;&#x606F;&#x5230;<code>msg.Pipe</code>&#x57DF;.</li>
<li>&#x4EFB;&#x4F55;transport&#x5C42;&#x7684;send recv&#x5931;&#x8D25;&#x53D1;&#x751F;&#x65F6;, &#x90FD;&#x4F1A;&#x8C03;&#x7528;p.Close(); &#x8FD9;&#x4E2A;close&#x7684;&#x52A8;&#x4F5C;&#x4F1A;&#x89E6;&#x53D1;&#x91CD;&#x5EFA;&#x8FDE;&#x63A5;(redial)&#x52A8;&#x4F5C;, &#x8BF4;&#x660E;&#x7CFB;&#x7EDF;&#x4EFB;&#x52A1;&#x8FD9;&#x4E2A;transport&#x901A;&#x9053;&#x5DF2;&#x7136;&#x4E0D;&#x884C;&#x4E86;, &#x8981;&#x91CD;&#x5EFA;. &#x540C;&#x65F6;, &#x4E5F;&#x4F1A;&#x8C03;&#x7528;protocol&#x5C42;&#x7684;RemovePipe()&#x63A5;&#x53E3;, &#x6765;&#x8BA9;protocol&#x5C42;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;pipe&#x5DF2;&#x7ECF;&#x5931;&#x6548;. &#x8FD9;&#x662F;&#x4E2A;&#x5F88;&#x597D;&#x7684;&#x7B56;&#x7565;, &#x5373;&#x53D1;&#x9001;&#x5931;&#x8D25;&#x4E0D;&#x8981;&#x7B80;&#x5355;&#x91CD;&#x8BD5;, &#x800C;&#x662F;&#x91CD;&#x65B0;&#x5EFA;&#x94FE;.</li>
</ul>
</li>
<li><p>&#x6838;&#x5FC3;&#x5C42;&#x7684;Send()&#x5B9E;&#x73B0;&#x662F;&#x62F7;&#x8D1D;&#x5F0F;send, &#x5373;&#x7528;&#x6237;&#x63D0;&#x4F9B;&#x7684;buffer&#x4F1A;&#x88AB;&#x62F7;&#x8D1D;&#x5230;&#x65B0;buffer&#x540E;&#x518D;send; Recv()&#x4E5F;&#x662F;&#x62F7;&#x8D1D;&#x5F0F;&#x7684;,&#x5373;&#x63A5;&#x6536;&#x7684;msg.Body&#x4F1A;&#x88AB;&#x62F7;&#x8D1D;&#x5230;&#x65B0;buffer&#x540E;&#x8FD4;&#x56DE;&#x65B0;buffer; &#x9898;&#x5916;: &#x4F5C;&#x8005;&#x7279;&#x522B;&#x559C;&#x6B22;&#x7528;append&#x6765;&#x62F7;&#x8D1D;buffer
<code>msg.Body = append(msg.Body, b...)</code></p>
<ul>
<li>&#x4F46;&#x5BF9;&#x5E94;&#x7684;SendMsg()&#x548C;RecvMsg()&#x5C31;&#x90FD;&#x4E0D;&#x4F1A;&#x6709;&#x65B0;buffer&#x4EA7;&#x751F;.</li>
</ul>
</li>
</ul>
<h4 id="&#x603B;&#x7ED3;_4"><a name="&#x603B;&#x7ED3;_4" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;_4"><i class="fa fa-link" aria-hidden="true"></i></a>&#x603B;&#x7ED3;</h4>
<p>&#x6838;&#x5FC3;&#x5C42;&#x5BF9;&#x4E0A;&#x76F4;&#x63A5;&#x627F;&#x63A5;&#x4E86;&#x7528;&#x6237;api&#x7684;&#x63A5;&#x53E3;, &#x5B83;&#x65E2;&#x89C4;&#x5B9A;&#x4E86;protocol&#x8981;&#x5B9E;&#x73B0;&#x7684;&#x63A5;&#x53E3;: AddPipe() SendMsg() RecvMsg(), &#x53C8;&#x89C4;&#x5B9A;&#x4E86;transport&#x5FC5;&#x987B;&#x5B9E;&#x73B0;&#x7684;&#x63A5;&#x53E3;: NewListener(), NewDialer(), Dial(), Listen(), Accept(). &#x901A;&#x8FC7;&#x8FD9;&#x4E9B;&#x89C4;&#x5B9A;&#x7684;&#x63A5;&#x53E3;, &#x6838;&#x5FC3;&#x5C42;&#x628A;protocol&#x5C42;&#x548C;transport&#x5C42;&#x89E3;&#x8026;&#x4E86;.<br>&#x6838;&#x5FC3;&#x5C42;&#x5BF9;&#x8FDE;&#x63A5;&#x7684;&#x62BD;&#x8C61;&#x662F;combine&#x7684;, &#x5373;&#x628A;client&#x548C;server&#x7684;dial&#x548C;listen&#x8FC7;&#x7A0B;&#x72EC;&#x7ACB;&#x62BD;&#x8C61;, &#x4F46;&#x4ED6;&#x4EEC;&#x7684;&#x7ED3;&#x679C;&#x90FD;&#x662F;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;pipe, &#x800C;&#x8FD9;&#x4E2A;pipe&#x5C31;&#x627F;&#x8F7D;&#x4E86;&#x540E;&#x9762;&#x7684;&#x53D1;&#x9001;, &#x63A5;&#x6536;&#x529F;&#x80FD;. &#x6838;&#x5FC3;&#x5C42;&#x5728;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x540E;, &#x4F1A;&#x628A;&#x81EA;&#x5DF1;&#x5BF9;protocol&#x7684;&#x627F;&#x8BFA;(&#x4E5F;&#x5C31;&#x662F;protocol.pipe)&#x7684;&#x5B9E;&#x4F8B;, &#x4F20;&#x9012;<code>addPipe(p)</code>&#x7ED9;protocol&#x5C42;, &#x8FD9;&#x4E2A;p&#x5C31;&#x4EE3;&#x8868;&#x4E86;transport&#x7684;&#x62BD;&#x8C61;.
&#x540C;&#x65F6;, &#x6838;&#x5FC3;&#x5C42;&#x8FD8;&#x63D0;&#x4F9B;&#x5982;&#x4E0B;&#x529F;&#x80FD;:</p>
<ul>
<li>&#x6838;&#x5FC3;&#x5C42;&#x4F1A;&#x5728;redial&#x6A21;&#x5F0F;&#x4E0B;&#x91CD;&#x8BD5;dial</li>
<li>&#x6838;&#x5FC3;&#x5C42;&#x4F1A;&#x542F;&#x52A8;&#x540E;&#x53F0;routine&#x5E2E;&#x52A9;server&#x6765;accept&#x8FDE;&#x63A5;</li>
<li>&#x6838;&#x5FC3;&#x5C42;&#x5728;&#x8C03;&#x7528;transport&#x5C42;&#x7684;&#x53D1;&#x9001;&#x63A5;&#x6536;api&#x5931;&#x8D25;&#x65F6;, &#x4F1A;&#x65AD;&#x5F00;&#x5F53;&#x524D;&#x8FDE;&#x63A5;, &#x81EA;&#x52A8;&#x91CD;&#x5EFA;&#x65B0;&#x8FDE;&#x63A5;.</li>
</ul>
<p>&#x6838;&#x5FC3;&#x5C42;&#x5E76;&#x6CA1;&#x6709;&#x63D0;&#x4F9B;&#x4EE5;&#x4E0B;&#x673A;&#x5236;:</p>
<ul>
<li>&#x961F;&#x5217;</li>
<li>&#x53CD;&#x538B;</li>
<li>&#x7EDF;&#x8BA1;</li>
<li>&#x8C03;&#x5EA6;</li>
</ul>
<p>&#x5373;&#x6838;&#x5FC3;&#x5C42;&#x8D1F;&#x8D23;&#x62BD;&#x8C61;&#x548C;&#x89E3;&#x8026;, &#x53EA;&#x63D0;&#x4F9B;&#x6700;&#x57FA;&#x672C;&#x7684;&#x529F;&#x80FD;.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="golang_zmq.html" class="navigation navigation-prev " aria-label="Previous page: 消息中间件基本概念和zero mq">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="golang_libp2p.html" class="navigation navigation-next " aria-label="Next page: Golang p2p网络">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"消息中间件mango","level":"1.7.13.2","depth":3,"next":{"title":"Golang p2p网络","level":"1.7.13.3","depth":3,"path":"notes/golang_libp2p.md","ref":"notes/golang_libp2p.md","articles":[]},"previous":{"title":"消息中间件基本概念和zero mq","level":"1.7.13.1","depth":3,"path":"notes/golang_zmq.md","ref":"notes/golang_zmq.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","-lunr","-search","search-plus","-highlight","theme-code","expandable-chapters-small","github","disqus","splitter","wide-page","hide-navigation-buttons","anchor-navigation-ex","sequence"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"disqus":{"useIdentifier":false,"shortName":"bai-yingjie-notes"},"sequence":{"theme":"simple"},"github":{"url":"https://github.com/Bai-Yingjie/Bai-Yingjie.github.io"},"splitter":{},"wide-page":{},"theme-code":{"showLevel":false,"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"styles/website.css"}},"fontsettings":{"theme":"white","family":"sans","size":2},"hide-navigation-buttons":{},"anchor-navigation-ex":{"mode":"float","pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"isRewritePageTitle":true,"showLevel":true,"tocLevel1Icon":"fa fa-hand-o-right","tocLevel2Icon":"fa fa-hand-o-right","tocLevel3Icon":"fa fa-hand-o-right","showGoTop":true,"isShowTocTitleIcon":true,"printLog":false,"multipleH1":true,"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false}},"expandable-chapters-small":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"theme":"default","author":"Bai Yingjie","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"My Notes","language":"zh-hans","gitbook":"*"},"file":{"path":"notes/golang_mango.md","mtime":"2022-10-11T15:10:42.534Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-10-11T15:11:40.551Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>


        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

        
    </body>
</html>

