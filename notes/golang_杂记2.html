
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>杂记2 · My Notes</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Bai Yingjie">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-coldark-cold.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-wide-page/wide.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hide-navigation-buttons/index.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="golang_杂记3.html" />
    
    
    <link rel="prev" href="golang_杂记1.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Golang
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    入门
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1" data-path="golang_语法基础.html">
            
                <a href="golang_语法基础.html">
            
                    
                    语法基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.2" data-path="golang_json性能.html">
            
                <a href="golang_json性能.html">
            
                    
                    json性能比较
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="golang_原理.html">
            
                <a href="golang_原理.html">
            
                    
                    原理相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.1" data-path="golang_内存分配.html">
            
                <a href="golang_内存分配.html">
            
                    
                    内存分配
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="golang_标准库.html">
            
                <a href="golang_标准库.html">
            
                    
                    标准库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="golang_问答.html">
            
                <a href="golang_问答.html">
            
                    
                    问答
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="golang_高效go.html">
            
                <a href="golang_高效go.html">
            
                    
                    高效go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="golang_进阶.html">
            
                <a href="golang_进阶.html">
            
                    
                    进阶
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    杂记
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.7.1" data-path="golang_杂记1.html">
            
                <a href="golang_杂记1.html">
            
                    
                    杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.7.2" data-path="golang_杂记2.html">
            
                <a href="golang_杂记2.html">
            
                    
                    杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7.3" data-path="golang_杂记3.html">
            
                <a href="golang_杂记3.html">
            
                    
                    杂记3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7.4" data-path="golang_lib选型.html">
            
                <a href="golang_lib选型.html">
            
                    
                    lib选型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7.5" data-path="golang_mod_proxy.html">
            
                <a href="golang_mod_proxy.html">
            
                    
                    go mod和go proxy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7.6" data-path="golang_汇编_arm64.html">
            
                <a href="golang_汇编_arm64.html">
            
                    
                    汇编语法和arm64小知识
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7.7" data-path="golang_cgo_swig.html">
            
                <a href="golang_cgo_swig.html">
            
                    
                    go调用c可以用swig
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    环境和工具链生成
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.8.1" data-path="golang_toolchain_ppc.html">
            
                <a href="golang_toolchain_ppc.html">
            
                    
                    go tools增加ppc32支持.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.2" data-path="golang_toolchain_compile_gccgo.html">
            
                <a href="golang_toolchain_compile_gccgo.html">
            
                    
                    编译gccgo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.3" data-path="golang_go_on_mips.html">
            
                <a href="golang_go_on_mips.html">
            
                    
                    go on mips boards(not so updated)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.8.3.1" data-path="golang_go_on_mips_part1.html">
            
                <a href="golang_go_on_mips_part1.html">
            
                    
                    part 1: cross compile go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.3.2" data-path="golang_go_on_mips_part2.html">
            
                <a href="golang_go_on_mips_part2.html">
            
                    
                    part 2: build native go compiler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.3.3" data-path="golang_go_on_mips_part3.html">
            
                <a href="golang_go_on_mips_part3.html">
            
                    
                    part 3: gccgo experiments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.3.4" data-path="golang_go_on_mips_part4.html">
            
                <a href="golang_go_on_mips_part4.html">
            
                    
                    part 4: json performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.3.5" data-path="golang_gentoo_on_mips_board_and_build_go.html">
            
                <a href="golang_gentoo_on_mips_board_and_build_go.html">
            
                    
                    Gentoo on mips board and build go
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    Rust
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="rust_入门_brief.html">
            
                <a href="rust_入门_brief.html">
            
                    
                    入门系列
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="rust_books.html">
            
                <a href="rust_books.html">
            
                    
                    reference books
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="rust_入门1.html">
            
                <a href="rust_入门1.html">
            
                    
                    安装和基础语法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.3" data-path="rust_入门2.html">
            
                <a href="rust_入门2.html">
            
                    
                    泛型和内存所有权
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.4" data-path="rust_入门3.html">
            
                <a href="rust_入门3.html">
            
                    
                    闭包 容器 迭代器 生成器 线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.5" data-path="rust_工程构建.html">
            
                <a href="rust_工程构建.html">
            
                    
                    工程构建
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="rust_vmm_brief.html">
            
                <a href="rust_vmm_brief.html">
            
                    
                    VMM(virtual machine monitor)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="rust_vmm_简介.html">
            
                <a href="rust_vmm_简介.html">
            
                    
                    rust-vmm简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2" data-path="rust_firecracker_代码.html">
            
                <a href="rust_firecracker_代码.html">
            
                    
                    firecracker代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3" data-path="rust_firecracker_使用.html">
            
                <a href="rust_firecracker_使用.html">
            
                    
                    firecracker使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.4" data-path="rust_cloud-hypervisor_代码.html">
            
                <a href="rust_cloud-hypervisor_代码.html">
            
                    
                    cloud hypervisor代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.5" data-path="rust_cloud-hypervisor_使用.html">
            
                <a href="rust_cloud-hypervisor_使用.html">
            
                    
                    cloud hypervisor使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6" data-path="rust_cloud-hypervisor_问题与解决.html">
            
                <a href="rust_cloud-hypervisor_问题与解决.html">
            
                    
                    cloud hypervisor问题与解决
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="rust_coding_brief.html">
            
                <a href="rust_coding_brief.html">
            
                    
                    代码积累
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="rust_序列化.html">
            
                <a href="rust_序列化.html">
            
                    
                    序列化原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2" data-path="rust_知识点积累.html">
            
                <a href="rust_知识点积累.html">
            
                    
                    知识点更新
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.3" data-path="rust_adaptiveservice.html">
            
                <a href="rust_adaptiveservice.html">
            
                    
                    rust版本的adaptiveservice探索
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.4" data-path="rust_常用设施.html">
            
                <a href="rust_常用设施.html">
            
                    
                    常用设施
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.5" data-path="rust_代码小段.html">
            
                <a href="rust_代码小段.html">
            
                    
                    代码小段
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="others.html">
            
                <a href="others.html">
            
                    
                    其他
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.4.1" data-path="rust_mdbook_使用.html">
            
                <a href="rust_mdbook_使用.html">
            
                    
                    使用mdbook
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    System
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="system_原理杂记.html">
            
                <a href="system_原理杂记.html">
            
                    
                    原理杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="system_alpine.html">
            
                <a href="system_alpine.html">
            
                    
                    Alpine Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="system_进程间通信.html">
            
                <a href="system_进程间通信.html">
            
                    
                    进程间通信
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="system_特殊功能fd.html">
            
                <a href="system_特殊功能fd.html">
            
                    
                    特殊功能fd
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="as_title.html">
            
                <a href="as_title.html">
            
                    
                    工程实践
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="gitlab_ci.html">
            
                <a href="gitlab_ci.html">
            
                    
                    gitlab CI
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >杂记2</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#&#x4F7F;&#x7528;reflect&#x7684;methodbyname&#x8C03;&#x7528;&#x65B9;&#x6CD5;"><b>1. </b>&#x4F7F;&#x7528;reflect&#x7684;MethodByName&#x8C03;&#x7528;&#x65B9;&#x6CD5;</a></li><li><span class="title-icon "></span><a href="#gob-decode&#x96F6;&#x503C;&#x4E0D;&#x8D4B;&#x503C;"><b>2. </b>gob decode&#x96F6;&#x503C;&#x4E0D;&#x8D4B;&#x503C;</a></li><ul><li><span class="title-icon "></span><a href="#&#x73B0;&#x8C61;"><b>2.1. </b>&#x73B0;&#x8C61;</a></li><ul><li><span class="title-icon "></span><a href="#&#x539F;&#x59CB;&#x6570;&#x636E;"><b>2.1.1. </b>&#x539F;&#x59CB;&#x6570;&#x636E;</a></li><li><span class="title-icon "></span><a href="#&#x4EE3;&#x7801;&#x903B;&#x8F91;"><b>2.1.2. </b>&#x4EE3;&#x7801;&#x903B;&#x8F91;</a></li><li><span class="title-icon "></span><a href="#&#x95EE;&#x9898;&#x73B0;&#x8C61;"><b>2.1.3. </b>&#x95EE;&#x9898;&#x73B0;&#x8C61;</a></li></ul><li><span class="title-icon "></span><a href="#&#x89E3;&#x91CA;"><b>2.2. </b>&#x89E3;&#x91CA;</a></li><li><span class="title-icon "></span><a href="#&#x9A8C;&#x8BC1;"><b>2.3. </b>&#x9A8C;&#x8BC1;</a></li><li><span class="title-icon "></span><a href="#&#x7ED3;&#x8BBA;"><b>2.4. </b>&#x7ED3;&#x8BBA;</a></li></ul><li><span class="title-icon "></span><a href="#setuid"><b>3. </b>setuid</a></li><li><span class="title-icon "></span><a href="#&#x8C03;&#x7528;&#x5C0F;&#x5199;&#x51FD;&#x6570;"><b>4. </b>&#x8C03;&#x7528;&#x5C0F;&#x5199;&#x51FD;&#x6570;</a></li><li><span class="title-icon "></span><a href="#&#x4F7F;&#x7528;&#x4E86;nohup&#x547D;&#x4EE4;&#x542F;&#x52A8;gshelld-&#x8FD8;&#x662F;&#x6536;&#x5230;signal&#x9000;&#x51FA;"><b>5. </b>&#x4F7F;&#x7528;&#x4E86;nohup&#x547D;&#x4EE4;&#x542F;&#x52A8;gshelld, &#x8FD8;&#x662F;&#x6536;&#x5230;signal&#x9000;&#x51FA;</a></li><ul><li><span class="title-icon "></span><a href="#sighup"><b>5.1. </b>SIGHUP</a></li><ul><li><span class="title-icon "></span><a href="#types-of-signals-&#xB6;"><b>5.1.1. </b>Types of signals &#xB6;</a></li></ul><li><span class="title-icon "></span><a href="#&#x63A8;&#x6D4B;"><b>5.2. </b>&#x63A8;&#x6D4B;</a></li><li><span class="title-icon "></span><a href="#&#x89E3;&#x51B3;"><b>5.3. </b>&#x89E3;&#x51B3;</a></li></ul><li><span class="title-icon "></span><a href="#gshell&#x7684;&#x5185;&#x5B58;&#x4F7F;&#x7528;"><b>6. </b>gshell&#x7684;&#x5185;&#x5B58;&#x4F7F;&#x7528;</a></li><li><span class="title-icon "></span><a href="#recover&#x4E0D;&#x80FD;&#x6355;&#x83B7;sigsegv&#x7C7B;&#x578B;&#x7684;panic"><b>7. </b>recover&#x4E0D;&#x80FD;&#x6355;&#x83B7;SIGSEGV&#x7C7B;&#x578B;&#x7684;panic</a></li><li><span class="title-icon "></span><a href="#sigint&#x4F1A;&#x53D1;&#x7ED9;&#x6240;&#x6709;&#x524D;&#x53F0;&#x8FDB;&#x7A0B;&#x7EC4;"><b>8. </b>sigint&#x4F1A;&#x53D1;&#x7ED9;&#x6240;&#x6709;&#x524D;&#x53F0;&#x8FDB;&#x7A0B;&#x7EC4;</a></li><li><span class="title-icon "></span><a href="#&#x5199;&#x5DF2;&#x7ECF;closed&#x7684;conn"><b>9. </b>&#x5199;&#x5DF2;&#x7ECF;closed&#x7684;conn</a></li><ul><li><span class="title-icon "></span><a href="#&#x573A;&#x666F;"><b>9.1. </b>&#x573A;&#x666F;</a></li><li><span class="title-icon "></span><a href="#&#x7B54;&#x6848;"><b>9.2. </b>&#x7B54;&#x6848;</a></li><li><span class="title-icon "></span><a href="#&#x7ED3;&#x8BBA;_1"><b>9.3. </b>&#x7ED3;&#x8BBA;</a></li></ul><li><span class="title-icon "></span><a href="#&#x8BFB;&#x5199;nil-channel&#x4F1A;&#x6C38;&#x8FDC;&#x963B;&#x585E;"><b>10. </b>&#x8BFB;&#x5199;nil channel&#x4F1A;&#x6C38;&#x8FDC;&#x963B;&#x585E;</a></li><li><span class="title-icon "></span><a href="#&#x6D41;&#x5F0F;&#x63A5;&#x53E3;&#x548C;go"><b>11. </b>&#x6D41;&#x5F0F;&#x63A5;&#x53E3;&#x548C;go</a></li><ul><li><span class="title-icon "></span><a href="#&#x6D41;&#x5F0F;&#x51FD;&#x6570;&#x94FE;&#x7684;go&#x6267;&#x884C;&#x987A;&#x5E8F;"><b>11.1. </b>&#x6D41;&#x5F0F;&#x51FD;&#x6570;&#x94FE;&#x7684;go&#x6267;&#x884C;&#x987A;&#x5E8F;</a></li><ul><li><span class="title-icon "></span><a href="#&#x89E3;&#x8BFB;"><b>11.1.1. </b>&#x89E3;&#x8BFB;</a></li><li><span class="title-icon "></span><a href="#&#x8FD0;&#x884C;&#x7ED3;&#x679C;&#x548C;&#x7ED3;&#x8BBA;"><b>11.1.2. </b>&#x8FD0;&#x884C;&#x7ED3;&#x679C;&#x548C;&#x7ED3;&#x8BBA;</a></li></ul></ul><li><span class="title-icon "></span><a href="#go-get&#x548C;go-mod"><b>12. </b>go get&#x548C;go mod</a></li><ul><li><span class="title-icon "></span><a href="#go-get"><b>12.1. </b>go get</a></li><li><span class="title-icon "></span><a href="#go-list"><b>12.2. </b>go list</a></li><li><span class="title-icon "></span><a href="#go-mod-tidy"><b>12.3. </b>go mod tidy</a></li><li><span class="title-icon "></span><a href="#&#x603B;&#x7ED3;"><b>12.4. </b>&#x603B;&#x7ED3;</a></li></ul><li><span class="title-icon "></span><a href="#go-clean-&#x6E05;&#x7406;&#x7F16;&#x8BD1;cache"><b>13. </b>go clean &#x6E05;&#x7406;&#x7F16;&#x8BD1;cache</a></li><li><span class="title-icon "></span><a href="#&#x53C8;&#x72AF;&#x4E86;&#x7ECF;&#x5178;&#x7684;goroutine&#x5F15;&#x7528;&#x95ED;&#x5305;&#x53D8;&#x91CF;&#x9519;&#x8BEF;"><b>14. </b>&#x53C8;&#x72AF;&#x4E86;&#x7ECF;&#x5178;&#x7684;goroutine&#x5F15;&#x7528;&#x95ED;&#x5305;&#x53D8;&#x91CF;&#x9519;&#x8BEF;!!!!!</a></li><ul><li><span class="title-icon "></span><a href="#&#x539F;&#x56E0;"><b>14.1. </b>&#x539F;&#x56E0;</a></li><li><span class="title-icon "></span><a href="#&#x89E3;&#x51B3;_1"><b>14.2. </b>&#x89E3;&#x51B3;</a></li><li><span class="title-icon "></span><a href="#&#x7406;&#x8BBA;&#x89E3;&#x91CA;"><b>14.3. </b>&#x7406;&#x8BBA;&#x89E3;&#x91CA;</a></li><li><span class="title-icon "></span><a href="#&#x603B;&#x7ED3;_1"><b>14.4. </b>&#x603B;&#x7ED3;</a></li></ul><li><span class="title-icon "></span><a href="#if-else-if-&#x5171;&#x4EAB;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;scope"><b>15. </b>if else if &#x5171;&#x4EAB;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;scope</a></li><li><span class="title-icon "></span><a href="#&#x7ECF;&#x5178;&#x7684;append&#x5730;&#x5740;&#x9519;&#x8BEF;"><b>16. </b>&#x7ECF;&#x5178;&#x7684;append&#x5730;&#x5740;&#x9519;&#x8BEF;</a></li><li><span class="title-icon "></span><a href="#&#x6253;&#x5370;&#x6307;&#x9488;slice"><b>17. </b>&#x6253;&#x5370;&#x6307;&#x9488;slice</a></li><ul><li><span class="title-icon "></span><a href="#&#x89E3;&#x51B3;-&#x7ED9;&#x7ED3;&#x6784;&#x4F53;&#x52A0;string&#x65B9;&#x6CD5;"><b>17.1. </b>&#x89E3;&#x51B3;: &#x7ED9;&#x7ED3;&#x6784;&#x4F53;&#x52A0;String&#x65B9;&#x6CD5;</a></li></ul><li><span class="title-icon "></span><a href="#&#x5173;&#x4E8E;wait-group"><b>18. </b>&#x5173;&#x4E8E;wait group</a></li><ul><li><span class="title-icon "></span><a href="#&#x53CD;&#x4F8B;"><b>18.1. </b>&#x53CD;&#x4F8B;</a></li></ul><li><span class="title-icon "></span><a href="#&#x4ECE;&#x6808;&#x4E0A;&#x83B7;&#x53D6;&#x53D8;&#x91CF;&#x5730;&#x5740;"><b>19. </b>&#x4ECE;&#x6808;&#x4E0A;&#x83B7;&#x53D6;&#x53D8;&#x91CF;&#x5730;&#x5740;</a></li><ul><li><span class="title-icon "></span><a href="#&#x53C2;&#x8003;&#x4EE3;&#x7801;"><b>19.1. </b>&#x53C2;&#x8003;&#x4EE3;&#x7801;</a></li></ul><li><span class="title-icon "></span><a href="#&#x8FD0;&#x884C;&#x65F6;&#x83B7;&#x53D6;&#x51FD;&#x6570;&#x540D;"><b>20. </b>&#x8FD0;&#x884C;&#x65F6;&#x83B7;&#x53D6;&#x51FD;&#x6570;&#x540D;</a></li><ul><li><span class="title-icon "></span><a href="#&#x65B9;&#x6CD5;1"><b>20.1. </b>&#x65B9;&#x6CD5;1</a></li><li><span class="title-icon "></span><a href="#&#x65B9;&#x6CD5;2"><b>20.2. </b>&#x65B9;&#x6CD5;2</a></li></ul><li><span class="title-icon "></span><a href="#continue&#x80FD;&#x8FD4;&#x56DE;n&#x5C42;for"><b>21. </b>continue&#x80FD;&#x8FD4;&#x56DE;N&#x5C42;for</a></li><li><span class="title-icon "></span><a href="#interface&#x7684;&#x7406;&#x89E3;"><b>22. </b>interface&#x7684;&#x7406;&#x89E3;</a></li><ul><li><span class="title-icon "></span><a href="#interface&#x662F;&#x9752;&#x51FA;&#x4E8E;&#x84DD;"><b>22.1. </b>interface{}&#x662F;&#x9752;&#x51FA;&#x4E8E;&#x84DD;</a></li><li><span class="title-icon "></span><a href="#interface&#x662F;&#x5E26;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;&#x96C6;&#x5408;"><b>22.2. </b>interface{}&#x662F;&#x5E26;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;&#x96C6;&#x5408;</a></li></ul><li><span class="title-icon "></span><a href="#runtimecaller&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x8FD0;&#x884C;&#x76EE;&#x5F55;"><b>23. </b>runtime.Caller&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x8FD0;&#x884C;&#x76EE;&#x5F55;</a></li><li><span class="title-icon "></span><a href="#an-interface-holding-nil-value-is-not-nil"><b>24. </b>An interface holding nil value is not nil</a></li><li><span class="title-icon "></span><a href="#nethttp&#x5BFC;&#x81F4;&#x5305;&#x53D8;&#x5927;"><b>25. </b>net/http&#x5BFC;&#x81F4;&#x5305;&#x53D8;&#x5927;</a></li><ul><li><span class="title-icon "></span><a href="#&#x73B0;&#x8C61;_1"><b>25.1. </b>&#x73B0;&#x8C61;</a></li><li><span class="title-icon "></span><a href="#&#x89E3;&#x51B3;_2"><b>25.2. </b>&#x89E3;&#x51B3;</a></li><li><span class="title-icon "></span><a href="#&#x539F;&#x56E0;_1"><b>25.3. </b>&#x539F;&#x56E0;</a></li><li><span class="title-icon "></span><a href="#&#x7ED3;&#x8BBA;_2"><b>25.4. </b>&#x7ED3;&#x8BBA;</a></li></ul><li><span class="title-icon "></span><a href="#options&#x521D;&#x59CB;&#x5316;"><b>26. </b>Options&#x521D;&#x59CB;&#x5316;</a></li><ul><li><span class="title-icon "></span><a href="#&#x603B;&#x7ED3;_2"><b>26.1. </b>&#x603B;&#x7ED3;</a></li></ul><li><span class="title-icon "></span><a href="#&#x7A7A;&#x767D;import&#x4E0D;&#x4F1A;&#x589E;&#x52A0;binary-size"><b>27. </b>&#x7A7A;&#x767D;import&#x4E0D;&#x4F1A;&#x589E;&#x52A0;binary size</a></li><li><span class="title-icon "></span><a href="#reflect&#x9AD8;&#x9636;&#x7528;&#x6CD5;"><b>28. </b>reflect&#x9AD8;&#x9636;&#x7528;&#x6CD5;</a></li><ul><li><span class="title-icon "></span><a href="#&#x52A8;&#x6001;&#x6784;&#x5EFA;&#x4E00;&#x4E2A;struct"><b>28.1. </b>&#x52A8;&#x6001;&#x6784;&#x5EFA;&#x4E00;&#x4E2A;struct</a></li><li><span class="title-icon "></span><a href="#byname-api----&#x795E;&#x5947;&#x7684;&#x91CD;&#x540D;api"><b>28.2. </b>byName API -- &#x795E;&#x5947;&#x7684;&#x91CD;&#x540D;API</a></li><ul><li><span class="title-icon "></span><a href="#reflectvalue&#x7684;methodbyname&#x65B9;&#x6CD5;"><b>28.2.1. </b>reflect.Value&#x7684;MethodByName&#x65B9;&#x6CD5;</a></li><li><span class="title-icon "></span><a href="#reflecttype&#x7684;methodbyname&#x65B9;&#x6CD5;"><b>28.2.2. </b>reflect.Type&#x7684;MethodByName&#x65B9;&#x6CD5;</a></li></ul></ul><li><span class="title-icon "></span><a href="#go&#x8C03;&#x7528;&#x5916;&#x90E8;&#x7A0B;&#x5E8F;"><b>29. </b>go&#x8C03;&#x7528;&#x5916;&#x90E8;&#x7A0B;&#x5E8F;</a></li><li><span class="title-icon "></span><a href="#texttemplate&#x4EE3;&#x7801;&#x751F;&#x6210;&#x4E3E;&#x4F8B;"><b>30. </b>text/template&#x4EE3;&#x7801;&#x751F;&#x6210;&#x4E3E;&#x4F8B;</a></li><li><span class="title-icon "></span><a href="#map&#x7684;&#x91CD;&#x8981;&#x5C5E;&#x6027;-unaddressable"><b>31. </b>map&#x7684;&#x91CD;&#x8981;&#x5C5E;&#x6027; unaddressable</a></li><ul><li><span class="title-icon "></span><a href="#&#x65B9;&#x6CD5;1-&#x6574;&#x4F53;&#x7ED9;map&#x8D4B;&#x503C;"><b>31.1. </b>&#x65B9;&#x6CD5;1 &#x6574;&#x4F53;&#x7ED9;map&#x8D4B;&#x503C;</a></li><li><span class="title-icon "></span><a href="#&#x65B9;&#x6CD5;2-&#x8BA9;value&#x7684;&#x7C7B;&#x578B;&#x4E3A;&#x6307;&#x9488;"><b>31.2. </b>&#x65B9;&#x6CD5;2 &#x8BA9;value&#x7684;&#x7C7B;&#x578B;&#x4E3A;&#x6307;&#x9488;</a></li><li><span class="title-icon "></span><a href="#&#x7ED3;&#x8BBA;_3"><b>31.3. </b>&#x7ED3;&#x8BBA;</a></li></ul><li><span class="title-icon "></span><a href="#go&#x7684;&#x6811;&#x72B6;&#x8868;&#x8FBE;"><b>32. </b>go&#x7684;&#x6811;&#x72B6;&#x8868;&#x8FBE;</a></li><ul><li><span class="title-icon "></span><a href="#&#x5B58;&#x50A8;data"><b>32.1. </b>&#x5B58;&#x50A8;data</a></li><ul><li><span class="title-icon "></span><a href="#&#x6539;&#x8FDB;&#x5B58;&#x50A8;"><b>32.1.1. </b>&#x6539;&#x8FDB;&#x5B58;&#x50A8;</a></li></ul><li><span class="title-icon "></span><a href="#&#x5982;&#x679C;&#x7528;key&#x6765;&#x5B58;&#x50A8;data&#x4F1A;&#x600E;&#x6837;"><b>32.2. </b>&#x5982;&#x679C;&#x7528;key&#x6765;&#x5B58;&#x50A8;data&#x4F1A;&#x600E;&#x6837;?</a></li></ul><li><span class="title-icon "></span><a href="#golang&#x7684;sigabrt"><b>33. </b>golang&#x7684;SIGABRT</a></li><li><span class="title-icon "></span><a href="#&#x5173;&#x4E8E;syscall"><b>34. </b>&#x5173;&#x4E8E;syscall</a></li><ul><li><span class="title-icon "></span><a href="#&#x6807;&#x51C6;syscall&#x5E93;&#x7684;&#x95EE;&#x9898;"><b>34.1. </b>&#x6807;&#x51C6;syscall&#x5E93;&#x7684;&#x95EE;&#x9898;</a></li><li><span class="title-icon "></span><a href="#&#x89E3;&#x51B3;_3"><b>34.2. </b>&#x89E3;&#x51B3;</a></li><li><span class="title-icon "></span><a href="#&#x66F4;&#x597D;&#x7684;syscall&#x5E93;"><b>34.3. </b>&#x66F4;&#x597D;&#x7684;syscall&#x5E93;</a></li><ul><li><span class="title-icon "></span><a href="#&#x4F7F;&#x7528;"><b>34.3.1. </b>&#x4F7F;&#x7528;</a></li><li><span class="title-icon "></span><a href="#ioctl"><b>34.3.2. </b>ioctl</a></li><li><span class="title-icon "></span><a href="#c&#x7684;ioctl&#x63A5;&#x53E3;"><b>34.3.3. </b>c&#x7684;ioctl&#x63A5;&#x53E3;</a></li><li><span class="title-icon "></span><a href="#go&#x7684;ioctl&#x63A5;&#x53E3;"><b>34.3.4. </b>go&#x7684;ioctl&#x63A5;&#x53E3;</a></li><li><span class="title-icon "></span><a href="#ioctl&#x7684;&#x5B8F;&#x5B9A;&#x4E49;&#x5728;&#x54EA;&#x91CC;"><b>34.3.5. </b>ioctl&#x7684;&#x5B8F;&#x5B9A;&#x4E49;&#x5728;&#x54EA;&#x91CC;?</a></li><li><span class="title-icon "></span><a href="#asm-files"><b>34.3.6. </b>asm files</a></li><li><span class="title-icon "></span><a href="#mmap"><b>34.3.7. </b>mmap</a></li><li><span class="title-icon "></span><a href="#mmap&#x8FD4;&#x56DE;&#x7684;byte&#x5207;&#x7247;&#x662F;&#x54EA;&#x91CC;&#x6765;&#x7684;"><b>34.3.8. </b>mmap&#x8FD4;&#x56DE;&#x7684;byte&#x5207;&#x7247;&#x662F;&#x54EA;&#x91CC;&#x6765;&#x7684;?</a></li></ul><li><span class="title-icon "></span><a href="#fnctl"><b>34.4. </b>fnctl</a></li></ul><li><span class="title-icon "></span><a href="#rwlock&#x6B7B;&#x9501;"><b>35. </b>RWLock&#x6B7B;&#x9501;</a></li><li><span class="title-icon "></span><a href="#float&#x5F3A;&#x8F6C;&#x4E3A;int"><b>36. </b>float&#x5F3A;&#x8F6C;&#x4E3A;int</a></li><li><span class="title-icon "></span><a href="#go-generate"><b>37. </b>go generate</a></li><ul><li><span class="title-icon "></span><a href="#go-generate&#x5E38;&#x4F7F;&#x7528;&#x7684;&#x4E00;&#x4E9B;&#x5DE5;&#x5177;"><b>37.1. </b>go generate&#x5E38;&#x4F7F;&#x7528;&#x7684;&#x4E00;&#x4E9B;&#x5DE5;&#x5177;</a></li></ul><li><span class="title-icon "></span><a href="#godoc&#x5B89;&#x88C5;"><b>38. </b>godoc&#x5B89;&#x88C5;</a></li><ul><li><span class="title-icon "></span><a href="#godoc&#x4F7F;&#x7528;"><b>38.1. </b>godoc&#x4F7F;&#x7528;</a></li></ul><li><span class="title-icon "></span><a href="#package&#x901A;&#x914D;&#x7B26;&#x548C;&#x5BFC;&#x5165;&#x8DEF;&#x5F84;"><b>39. </b>package&#x901A;&#x914D;&#x7B26;&#x548C;&#x5BFC;&#x5165;&#x8DEF;&#x5F84;</a></li><ul><li><span class="title-icon "></span><a href="#package&#x901A;&#x914D;&#x7B26;"><b>39.1. </b>package&#x901A;&#x914D;&#x7B26;...</a></li><li><span class="title-icon "></span><a href="#&#x5BFC;&#x5165;&#x8DEF;&#x5F84;"><b>39.2. </b>&#x5BFC;&#x5165;&#x8DEF;&#x5F84;</a></li></ul><li><span class="title-icon "></span><a href="#objfunction&#x4E2D;obj&#x53EF;&#x4EE5;&#x662F;nil"><b>40. </b>obj.function()&#x4E2D;obj&#x53EF;&#x4EE5;&#x662F;nil</a></li><ul><li><span class="title-icon "></span><a href="#&#x5982;&#x4F55;&#x5904;&#x7406;"><b>40.1. </b>&#x5982;&#x4F55;&#x5904;&#x7406;?</a></li></ul><li><span class="title-icon "></span><a href="#&#x5207;&#x7247;&#x7684;reslicing"><b>41. </b>&#x5207;&#x7247;&#x7684;reslicing</a></li><li><span class="title-icon "></span><a href="#&#x518D;&#x8BAE;&#x76EE;&#x5F55;&#x7ED3;&#x6784;"><b>42. </b>&#x518D;&#x8BAE;&#x76EE;&#x5F55;&#x7ED3;&#x6784;</a></li><li><span class="title-icon "></span><a href="#&#x5177;&#x4F53;error&#x5224;&#x65AD;"><b>43. </b>&#x5177;&#x4F53;error&#x5224;&#x65AD;</a></li><li><span class="title-icon "></span><a href="#&#x51FD;&#x6570;&#x8D4B;&#x503C;&#x7ED9;&#x53D8;&#x91CF;"><b>44. </b>&#x51FD;&#x6570;&#x8D4B;&#x503C;&#x7ED9;&#x53D8;&#x91CF;</a></li><li><span class="title-icon "></span><a href="#gob-encode&#x548C;&#x7F51;&#x7EDC;io&#x7684;&#x7ED3;&#x5408;"><b>45. </b>gob encode&#x548C;&#x7F51;&#x7EDC;io&#x7684;&#x7ED3;&#x5408;</a></li><ul><li><span class="title-icon "></span><a href="#&#x5355;&#x6B65;decoderdecodemsg"><b>45.1. </b>&#x5355;&#x6B65;decoder.Decode(&amp;msg)</a></li></ul><li><span class="title-icon "></span><a href="#protobuf&#x91CC;&#x9762;oneof&#x8F6C;&#x6210;go&#x7ED3;&#x6784;&#x4F53;"><b>46. </b>protobuf&#x91CC;&#x9762;oneof&#x8F6C;&#x6210;go&#x7ED3;&#x6784;&#x4F53;</a></li><ul><li><span class="title-icon "></span><a href="#proto&#x5B9A;&#x4E49;"><b>46.1. </b>proto&#x5B9A;&#x4E49;</a></li><li><span class="title-icon "></span><a href="#&#x8F6C;&#x6210;&#x7684;&#x7ED3;&#x6784;&#x4F53;"><b>46.2. </b>&#x8F6C;&#x6210;&#x7684;&#x7ED3;&#x6784;&#x4F53;</a></li></ul></ul></div><a href="#&#x4F7F;&#x7528;reflect&#x7684;methodbyname&#x8C03;&#x7528;&#x65B9;&#x6CD5;" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><ul>
<li><a href="#&#x4F7F;&#x7528;reflect&#x7684;methodbyname&#x8C03;&#x7528;&#x65B9;&#x6CD5;">&#x4F7F;&#x7528;reflect&#x7684;MethodByName&#x8C03;&#x7528;&#x65B9;&#x6CD5;</a></li>
<li><a href="#gob-decode&#x96F6;&#x503C;&#x4E0D;&#x8D4B;&#x503C;">gob decode&#x96F6;&#x503C;&#x4E0D;&#x8D4B;&#x503C;</a><ul>
<li><a href="#&#x73B0;&#x8C61;">&#x73B0;&#x8C61;</a><ul>
<li><a href="#&#x539F;&#x59CB;&#x6570;&#x636E;">&#x539F;&#x59CB;&#x6570;&#x636E;</a></li>
<li><a href="#&#x4EE3;&#x7801;&#x903B;&#x8F91;">&#x4EE3;&#x7801;&#x903B;&#x8F91;</a></li>
<li><a href="#&#x95EE;&#x9898;&#x73B0;&#x8C61;">&#x95EE;&#x9898;&#x73B0;&#x8C61;</a></li>
</ul>
</li>
<li><a href="#&#x89E3;&#x91CA;">&#x89E3;&#x91CA;</a></li>
<li><a href="#&#x9A8C;&#x8BC1;">&#x9A8C;&#x8BC1;</a></li>
<li><a href="#&#x7ED3;&#x8BBA;">&#x7ED3;&#x8BBA;</a></li>
</ul>
</li>
<li><a href="#setuid">setuid</a></li>
<li><a href="#&#x8C03;&#x7528;&#x5C0F;&#x5199;&#x51FD;&#x6570;">&#x8C03;&#x7528;&#x5C0F;&#x5199;&#x51FD;&#x6570;</a></li>
<li><a href="#&#x4F7F;&#x7528;&#x4E86;nohup&#x547D;&#x4EE4;&#x542F;&#x52A8;gshelld-&#x8FD8;&#x662F;&#x6536;&#x5230;signal&#x9000;&#x51FA;">&#x4F7F;&#x7528;&#x4E86;nohup&#x547D;&#x4EE4;&#x542F;&#x52A8;gshelld, &#x8FD8;&#x662F;&#x6536;&#x5230;signal&#x9000;&#x51FA;</a><ul>
<li><a href="#sighup">SIGHUP</a><ul>
<li><a href="#types-of-signals-">Types of signals &#xB6;</a></li>
</ul>
</li>
<li><a href="#&#x63A8;&#x6D4B;">&#x63A8;&#x6D4B;</a></li>
<li><a href="#&#x89E3;&#x51B3;">&#x89E3;&#x51B3;</a></li>
</ul>
</li>
<li><a href="#gshell&#x7684;&#x5185;&#x5B58;&#x4F7F;&#x7528;">gshell&#x7684;&#x5185;&#x5B58;&#x4F7F;&#x7528;</a></li>
<li><a href="#recover&#x4E0D;&#x80FD;&#x6355;&#x83B7;sigsegv&#x7C7B;&#x578B;&#x7684;panic">recover&#x4E0D;&#x80FD;&#x6355;&#x83B7;SIGSEGV&#x7C7B;&#x578B;&#x7684;panic</a></li>
<li><a href="#sigint&#x4F1A;&#x53D1;&#x7ED9;&#x6240;&#x6709;&#x524D;&#x53F0;&#x8FDB;&#x7A0B;&#x7EC4;">sigint&#x4F1A;&#x53D1;&#x7ED9;&#x6240;&#x6709;&#x524D;&#x53F0;&#x8FDB;&#x7A0B;&#x7EC4;</a></li>
<li><a href="#&#x5199;&#x5DF2;&#x7ECF;closed&#x7684;conn">&#x5199;&#x5DF2;&#x7ECF;closed&#x7684;conn</a><ul>
<li><a href="#&#x573A;&#x666F;">&#x573A;&#x666F;</a></li>
<li><a href="#&#x7B54;&#x6848;">&#x7B54;&#x6848;</a></li>
<li><a href="#&#x7ED3;&#x8BBA;-1">&#x7ED3;&#x8BBA;</a></li>
</ul>
</li>
<li><a href="#&#x8BFB;&#x5199;nil-channel&#x4F1A;&#x6C38;&#x8FDC;&#x963B;&#x585E;">&#x8BFB;&#x5199;nil channel&#x4F1A;&#x6C38;&#x8FDC;&#x963B;&#x585E;</a></li>
<li><a href="#&#x6D41;&#x5F0F;&#x63A5;&#x53E3;&#x548C;go">&#x6D41;&#x5F0F;&#x63A5;&#x53E3;&#x548C;go</a><ul>
<li><a href="#&#x6D41;&#x5F0F;&#x51FD;&#x6570;&#x94FE;&#x7684;go&#x6267;&#x884C;&#x987A;&#x5E8F;">&#x6D41;&#x5F0F;&#x51FD;&#x6570;&#x94FE;&#x7684;go&#x6267;&#x884C;&#x987A;&#x5E8F;</a><ul>
<li><a href="#&#x89E3;&#x8BFB;">&#x89E3;&#x8BFB;</a></li>
<li><a href="#&#x8FD0;&#x884C;&#x7ED3;&#x679C;&#x548C;&#x7ED3;&#x8BBA;">&#x8FD0;&#x884C;&#x7ED3;&#x679C;&#x548C;&#x7ED3;&#x8BBA;</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#go-get&#x548C;go-mod">go get&#x548C;go mod</a><ul>
<li><a href="#go-get">go get</a></li>
<li><a href="#go-list">go list</a></li>
<li><a href="#go-mod-tidy">go mod tidy</a></li>
<li><a href="#&#x603B;&#x7ED3;">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#go-clean-&#x6E05;&#x7406;&#x7F16;&#x8BD1;cache">go clean &#x6E05;&#x7406;&#x7F16;&#x8BD1;cache</a></li>
<li><a href="#&#x53C8;&#x72AF;&#x4E86;&#x7ECF;&#x5178;&#x7684;goroutine&#x5F15;&#x7528;&#x95ED;&#x5305;&#x53D8;&#x91CF;&#x9519;&#x8BEF;">&#x53C8;&#x72AF;&#x4E86;&#x7ECF;&#x5178;&#x7684;goroutine&#x5F15;&#x7528;&#x95ED;&#x5305;&#x53D8;&#x91CF;&#x9519;&#x8BEF;!!!!!</a><ul>
<li><a href="#&#x539F;&#x56E0;">&#x539F;&#x56E0;</a></li>
<li><a href="#&#x89E3;&#x51B3;-1">&#x89E3;&#x51B3;</a></li>
<li><a href="#&#x7406;&#x8BBA;&#x89E3;&#x91CA;">&#x7406;&#x8BBA;&#x89E3;&#x91CA;</a></li>
<li><a href="#&#x603B;&#x7ED3;-1">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#if-else-if-&#x5171;&#x4EAB;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;scope">if else if &#x5171;&#x4EAB;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;scope</a></li>
<li><a href="#&#x7ECF;&#x5178;&#x7684;append&#x5730;&#x5740;&#x9519;&#x8BEF;">&#x7ECF;&#x5178;&#x7684;append&#x5730;&#x5740;&#x9519;&#x8BEF;</a></li>
<li><a href="#&#x6253;&#x5370;&#x6307;&#x9488;slice">&#x6253;&#x5370;&#x6307;&#x9488;slice</a><ul>
<li><a href="#&#x89E3;&#x51B3;-&#x7ED9;&#x7ED3;&#x6784;&#x4F53;&#x52A0;string&#x65B9;&#x6CD5;">&#x89E3;&#x51B3;: &#x7ED9;&#x7ED3;&#x6784;&#x4F53;&#x52A0;String&#x65B9;&#x6CD5;</a></li>
</ul>
</li>
<li><a href="#&#x5173;&#x4E8E;wait-group">&#x5173;&#x4E8E;wait group</a><ul>
<li><a href="#&#x53CD;&#x4F8B;">&#x53CD;&#x4F8B;</a></li>
</ul>
</li>
<li><a href="#&#x4ECE;&#x6808;&#x4E0A;&#x83B7;&#x53D6;&#x53D8;&#x91CF;&#x5730;&#x5740;">&#x4ECE;&#x6808;&#x4E0A;&#x83B7;&#x53D6;&#x53D8;&#x91CF;&#x5730;&#x5740;</a><ul>
<li><a href="#&#x53C2;&#x8003;&#x4EE3;&#x7801;">&#x53C2;&#x8003;&#x4EE3;&#x7801;</a></li>
</ul>
</li>
<li><a href="#&#x8FD0;&#x884C;&#x65F6;&#x83B7;&#x53D6;&#x51FD;&#x6570;&#x540D;">&#x8FD0;&#x884C;&#x65F6;&#x83B7;&#x53D6;&#x51FD;&#x6570;&#x540D;</a><ul>
<li><a href="#&#x65B9;&#x6CD5;1">&#x65B9;&#x6CD5;1</a></li>
<li><a href="#&#x65B9;&#x6CD5;2">&#x65B9;&#x6CD5;2</a></li>
</ul>
</li>
<li><a href="#continue&#x80FD;&#x8FD4;&#x56DE;n&#x5C42;for">continue&#x80FD;&#x8FD4;&#x56DE;N&#x5C42;for</a></li>
<li><a href="#interface&#x7684;&#x7406;&#x89E3;">interface&#x7684;&#x7406;&#x89E3;</a><ul>
<li><a href="#interface&#x662F;&#x9752;&#x51FA;&#x4E8E;&#x84DD;">interface{}&#x662F;&#x9752;&#x51FA;&#x4E8E;&#x84DD;</a></li>
<li><a href="#interface&#x662F;&#x5E26;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;&#x96C6;&#x5408;">interface{}&#x662F;&#x5E26;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;&#x96C6;&#x5408;</a></li>
</ul>
</li>
<li><a href="#runtimecaller&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x8FD0;&#x884C;&#x76EE;&#x5F55;">runtime.Caller&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x8FD0;&#x884C;&#x76EE;&#x5F55;</a></li>
<li><a href="#an-interface-holding-nil-value-is-not-nil">An interface holding nil value is not nil</a></li>
<li><a href="#nethttp&#x5BFC;&#x81F4;&#x5305;&#x53D8;&#x5927;">net/http&#x5BFC;&#x81F4;&#x5305;&#x53D8;&#x5927;</a><ul>
<li><a href="#&#x73B0;&#x8C61;-1">&#x73B0;&#x8C61;</a></li>
<li><a href="#&#x89E3;&#x51B3;-2">&#x89E3;&#x51B3;</a></li>
<li><a href="#&#x539F;&#x56E0;-1">&#x539F;&#x56E0;</a></li>
<li><a href="#&#x7ED3;&#x8BBA;-2">&#x7ED3;&#x8BBA;</a></li>
</ul>
</li>
<li><a href="#options&#x521D;&#x59CB;&#x5316;">Options&#x521D;&#x59CB;&#x5316;</a><ul>
<li><a href="#&#x603B;&#x7ED3;-2">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#&#x7A7A;&#x767D;import&#x4E0D;&#x4F1A;&#x589E;&#x52A0;binary-size">&#x7A7A;&#x767D;import&#x4E0D;&#x4F1A;&#x589E;&#x52A0;binary size</a></li>
<li><a href="#reflect&#x9AD8;&#x9636;&#x7528;&#x6CD5;">reflect&#x9AD8;&#x9636;&#x7528;&#x6CD5;</a><ul>
<li><a href="#&#x52A8;&#x6001;&#x6784;&#x5EFA;&#x4E00;&#x4E2A;struct">&#x52A8;&#x6001;&#x6784;&#x5EFA;&#x4E00;&#x4E2A;struct</a></li>
<li><a href="#byname-api----&#x795E;&#x5947;&#x7684;&#x91CD;&#x540D;api">byName API -- &#x795E;&#x5947;&#x7684;&#x91CD;&#x540D;API</a><ul>
<li><a href="#reflectvalue&#x7684;methodbyname&#x65B9;&#x6CD5;">reflect.Value&#x7684;MethodByName&#x65B9;&#x6CD5;</a></li>
<li><a href="#reflecttype&#x7684;methodbyname&#x65B9;&#x6CD5;">reflect.Type&#x7684;MethodByName&#x65B9;&#x6CD5;</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#go&#x8C03;&#x7528;&#x5916;&#x90E8;&#x7A0B;&#x5E8F;">go&#x8C03;&#x7528;&#x5916;&#x90E8;&#x7A0B;&#x5E8F;</a></li>
<li><a href="#texttemplate&#x4EE3;&#x7801;&#x751F;&#x6210;&#x4E3E;&#x4F8B;">text/template&#x4EE3;&#x7801;&#x751F;&#x6210;&#x4E3E;&#x4F8B;</a></li>
<li><a href="#map&#x7684;&#x91CD;&#x8981;&#x5C5E;&#x6027;-unaddressable">map&#x7684;&#x91CD;&#x8981;&#x5C5E;&#x6027; unaddressable</a><ul>
<li><a href="#&#x65B9;&#x6CD5;1-&#x6574;&#x4F53;&#x7ED9;map&#x8D4B;&#x503C;">&#x65B9;&#x6CD5;1 &#x6574;&#x4F53;&#x7ED9;map&#x8D4B;&#x503C;</a></li>
<li><a href="#&#x65B9;&#x6CD5;2-&#x8BA9;value&#x7684;&#x7C7B;&#x578B;&#x4E3A;&#x6307;&#x9488;">&#x65B9;&#x6CD5;2 &#x8BA9;value&#x7684;&#x7C7B;&#x578B;&#x4E3A;&#x6307;&#x9488;</a></li>
<li><a href="#&#x7ED3;&#x8BBA;-3">&#x7ED3;&#x8BBA;</a></li>
</ul>
</li>
<li><a href="#go&#x7684;&#x6811;&#x72B6;&#x8868;&#x8FBE;">go&#x7684;&#x6811;&#x72B6;&#x8868;&#x8FBE;</a><ul>
<li><a href="#&#x5B58;&#x50A8;data">&#x5B58;&#x50A8;data</a><ul>
<li><a href="#&#x6539;&#x8FDB;&#x5B58;&#x50A8;">&#x6539;&#x8FDB;&#x5B58;&#x50A8;</a></li>
</ul>
</li>
<li><a href="#&#x5982;&#x679C;&#x7528;key&#x6765;&#x5B58;&#x50A8;data&#x4F1A;&#x600E;&#x6837;">&#x5982;&#x679C;&#x7528;key&#x6765;&#x5B58;&#x50A8;data&#x4F1A;&#x600E;&#x6837;?</a></li>
</ul>
</li>
<li><a href="#golang&#x7684;sigabrt">golang&#x7684;SIGABRT</a></li>
<li><a href="#&#x5173;&#x4E8E;syscall">&#x5173;&#x4E8E;syscall</a><ul>
<li><a href="#&#x6807;&#x51C6;syscall&#x5E93;&#x7684;&#x95EE;&#x9898;">&#x6807;&#x51C6;syscall&#x5E93;&#x7684;&#x95EE;&#x9898;</a></li>
<li><a href="#&#x89E3;&#x51B3;-3">&#x89E3;&#x51B3;</a></li>
<li><a href="#&#x66F4;&#x597D;&#x7684;syscall&#x5E93;">&#x66F4;&#x597D;&#x7684;syscall&#x5E93;</a><ul>
<li><a href="#&#x4F7F;&#x7528;">&#x4F7F;&#x7528;</a></li>
<li><a href="#ioctl">ioctl</a></li>
<li><a href="#c&#x7684;ioctl&#x63A5;&#x53E3;">c&#x7684;ioctl&#x63A5;&#x53E3;</a><ul>
<li><a href="#cmd">cmd</a></li>
<li><a href="#argp">argp</a></li>
</ul>
</li>
<li><a href="#go&#x7684;ioctl&#x63A5;&#x53E3;">go&#x7684;ioctl&#x63A5;&#x53E3;</a></li>
<li><a href="#ioctl&#x7684;&#x5B8F;&#x5B9A;&#x4E49;&#x5728;&#x54EA;&#x91CC;">ioctl&#x7684;&#x5B8F;&#x5B9A;&#x4E49;&#x5728;&#x54EA;&#x91CC;?</a></li>
<li><a href="#asm-files">asm files</a></li>
<li><a href="#mmap">mmap</a></li>
<li><a href="#mmap&#x8FD4;&#x56DE;&#x7684;byte&#x5207;&#x7247;&#x662F;&#x54EA;&#x91CC;&#x6765;&#x7684;">mmap&#x8FD4;&#x56DE;&#x7684;byte&#x5207;&#x7247;&#x662F;&#x54EA;&#x91CC;&#x6765;&#x7684;?</a></li>
</ul>
</li>
<li><a href="#fnctl">fnctl</a></li>
</ul>
</li>
<li><a href="#rwlock&#x6B7B;&#x9501;">RWLock&#x6B7B;&#x9501;</a></li>
<li><a href="#float&#x5F3A;&#x8F6C;&#x4E3A;int">float&#x5F3A;&#x8F6C;&#x4E3A;int</a></li>
<li><a href="#go-generate">go generate</a><ul>
<li><a href="#go-generate&#x5E38;&#x4F7F;&#x7528;&#x7684;&#x4E00;&#x4E9B;&#x5DE5;&#x5177;">go generate&#x5E38;&#x4F7F;&#x7528;&#x7684;&#x4E00;&#x4E9B;&#x5DE5;&#x5177;</a></li>
</ul>
</li>
<li><a href="#godoc&#x5B89;&#x88C5;">godoc&#x5B89;&#x88C5;</a><ul>
<li><a href="#godoc&#x4F7F;&#x7528;">godoc&#x4F7F;&#x7528;</a></li>
</ul>
</li>
<li><a href="#package&#x901A;&#x914D;&#x7B26;&#x548C;&#x5BFC;&#x5165;&#x8DEF;&#x5F84;">package&#x901A;&#x914D;&#x7B26;&#x548C;&#x5BFC;&#x5165;&#x8DEF;&#x5F84;</a><ul>
<li><a href="#package&#x901A;&#x914D;&#x7B26;">package&#x901A;&#x914D;&#x7B26;<code>...</code></a></li>
<li><a href="#&#x5BFC;&#x5165;&#x8DEF;&#x5F84;">&#x5BFC;&#x5165;&#x8DEF;&#x5F84;</a></li>
</ul>
</li>
<li><a href="#objfunction&#x4E2D;obj&#x53EF;&#x4EE5;&#x662F;nil">obj.function()&#x4E2D;obj&#x53EF;&#x4EE5;&#x662F;nil</a><ul>
<li><a href="#&#x5982;&#x4F55;&#x5904;&#x7406;">&#x5982;&#x4F55;&#x5904;&#x7406;?</a></li>
</ul>
</li>
<li><a href="#&#x5207;&#x7247;&#x7684;reslicing">&#x5207;&#x7247;&#x7684;reslicing</a></li>
<li><a href="#&#x518D;&#x8BAE;&#x76EE;&#x5F55;&#x7ED3;&#x6784;">&#x518D;&#x8BAE;&#x76EE;&#x5F55;&#x7ED3;&#x6784;</a></li>
<li><a href="#&#x5177;&#x4F53;error&#x5224;&#x65AD;">&#x5177;&#x4F53;error&#x5224;&#x65AD;</a></li>
<li><a href="#&#x51FD;&#x6570;&#x8D4B;&#x503C;&#x7ED9;&#x53D8;&#x91CF;">&#x51FD;&#x6570;&#x8D4B;&#x503C;&#x7ED9;&#x53D8;&#x91CF;</a></li>
<li><a href="#gob-encode&#x548C;&#x7F51;&#x7EDC;io&#x7684;&#x7ED3;&#x5408;">gob encode&#x548C;&#x7F51;&#x7EDC;io&#x7684;&#x7ED3;&#x5408;</a><ul>
<li><a href="#&#x5355;&#x6B65;decoderdecodemsg">&#x5355;&#x6B65;decoder.Decode(&amp;msg)</a></li>
</ul>
</li>
<li><a href="#protobuf&#x91CC;&#x9762;oneof&#x8F6C;&#x6210;go&#x7ED3;&#x6784;&#x4F53;">protobuf&#x91CC;&#x9762;oneof&#x8F6C;&#x6210;go&#x7ED3;&#x6784;&#x4F53;</a><ul>
<li><a href="#proto&#x5B9A;&#x4E49;">proto&#x5B9A;&#x4E49;</a></li>
<li><a href="#&#x8F6C;&#x6210;&#x7684;&#x7ED3;&#x6784;&#x4F53;">&#x8F6C;&#x6210;&#x7684;&#x7ED3;&#x6784;&#x4F53;</a></li>
</ul>
</li>
</ul>
<h1 id="&#x4F7F;&#x7528;reflect&#x7684;methodbyname&#x8C03;&#x7528;&#x65B9;&#x6CD5;"><a name="&#x4F7F;&#x7528;reflect&#x7684;methodbyname&#x8C03;&#x7528;&#x65B9;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#&#x4F7F;&#x7528;reflect&#x7684;methodbyname&#x8C03;&#x7528;&#x65B9;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>1. &#x4F7F;&#x7528;reflect&#x7684;MethodByName&#x8C03;&#x7528;&#x65B9;&#x6CD5;</h1>
<p>&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5728;<code>Handle()</code>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x91CC;&#x9762;, &#x8C03;&#x7528;&#x4E86;&#x540C;&#x5BF9;&#x8C61;&#x7684;<code>DoHandle()</code>&#x65B9;&#x6CD5;.</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Handle handles SessionRequest.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>msg <span class="token operator">*</span>SessionRequest<span class="token punctuation">)</span> <span class="token function">Handle</span><span class="token punctuation">(</span>stream as<span class="token punctuation">.</span>ContextStream<span class="token punctuation">)</span> <span class="token punctuation">(</span>reply <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ONLY use reflect when clients do not have full server functions built-in(aka lite build)</span>
    handle <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">MethodByName</span><span class="token punctuation">(</span><span class="token string">&quot;DoHandle&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> handle<span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>handle<span class="token punctuation">.</span><span class="token function">IsZero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">:=</span> handle<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Value<span class="token punctuation">{</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ret<span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>&#x88AB;&#x8C03;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x5FC5;&#x987B;&#x5927;&#x5199;&#x5F00;&#x5934;. &quot;DoHandle&quot;&#x53EF;&#x4EE5;, &#x4F46;&#x662F;&#x5982;&#x679C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x662F;&quot;handle&quot;, &#x5C31;&#x4E0D;&#x884C;</li>
<li>&#x8FD4;&#x56DE;&#x503C;&#x8981;&#x5148;&#x68C0;&#x67E5;&#x662F;&#x5426;valid, &#x518D;&#x68C0;&#x67E5;&#x662F;&#x5426;&#x662F;zero</li>
<li>&#x4F7F;&#x7528;<code>Call()</code>&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x51FD;&#x6570;, &#x4F20;&#x53C2;&#x8981;&#x81EA;&#x5DF1;&#x77E5;&#x9053;&#x8BE5;&#x4F20;&#x4EC0;&#x4E48;, &#x8FD4;&#x56DE;&#x503C;&#x4E5F;&#x8981;&#x77E5;&#x9053;.</li>
<li>&#x53C2;&#x6570;&#x548C;&#x8FD4;&#x56DE;&#x503C;&#x90FD;&#x662F;reflect.Value&#x7C7B;&#x578B;.</li>
</ul>
<h1 id="gob-decode&#x96F6;&#x503C;&#x4E0D;&#x8D4B;&#x503C;"><a name="gob-decode&#x96F6;&#x503C;&#x4E0D;&#x8D4B;&#x503C;" class="anchor-navigation-ex-anchor" href="#gob-decode&#x96F6;&#x503C;&#x4E0D;&#x8D4B;&#x503C;"><i class="fa fa-link" aria-hidden="true"></i></a>2. gob decode&#x96F6;&#x503C;&#x4E0D;&#x8D4B;&#x503C;</h1>
<h2 id="&#x73B0;&#x8C61;"><a name="&#x73B0;&#x8C61;" class="anchor-navigation-ex-anchor" href="#&#x73B0;&#x8C61;"><i class="fa fa-link" aria-hidden="true"></i></a>2.1. &#x73B0;&#x8C61;</h2>
<p>&#x6211;&#x6709;&#x4E00;&#x4E9B;cpu&#x4F7F;&#x7528;&#x7387;&#x7684;&#x7EDF;&#x8BA1;&#x6570;&#x636E;, &#x4F7F;&#x7528;gob&#x7F16;&#x7801;&#x4FDD;&#x5B58;&#x5728;&#x6587;&#x4EF6;&#x4E2D;. &#x4F46;decode&#x51FA;&#x6765;&#x7684;&#x6570;&#x636E;, &#x548C;&#x539F;&#x59CB;&#x6570;&#x636E;&#x4E0D;&#x4E00;&#x6837;. &#x6700;&#x5178;&#x578B;&#x7684;&#x7279;&#x5F81;&#x662F;, &#x4F3C;&#x4E4E;&#x539F;&#x503C;&#x4E3A;0&#x7684;&#x65F6;&#x5019;, decode&#x51FA;&#x6765;&#x7684;&#x6570;&#x636E;&#x7684;&#x503C;&#x53EF;&#x80FD;&quot;&#x5F88;&#x968F;&#x673A;&quot;</p>
<h3 id="&#x539F;&#x59CB;&#x6570;&#x636E;"><a name="&#x539F;&#x59CB;&#x6570;&#x636E;" class="anchor-navigation-ex-anchor" href="#&#x539F;&#x59CB;&#x6570;&#x636E;"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.1. &#x539F;&#x59CB;&#x6570;&#x636E;</h3>
<p>&#x539F;&#x59CB;&#x6570;&#x636E;&#x662F;&#x5982;&#x4E0B;&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5207;&#x7247;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> procStat <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Pid  <span class="token builtin">int</span>
    Name <span class="token builtin">string</span>
    Ucpu <span class="token builtin">float64</span>
    Scpu <span class="token builtin">float64</span>
    Mem  <span class="token builtin">uint64</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> record <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Time  <span class="token builtin">int64</span>
    Procs <span class="token punctuation">[</span><span class="token punctuation">]</span>procStat
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x4EE3;&#x7801;&#x903B;&#x8F91;"><a name="&#x4EE3;&#x7801;&#x903B;&#x8F91;" class="anchor-navigation-ex-anchor" href="#&#x4EE3;&#x7801;&#x903B;&#x8F91;"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.2. &#x4EE3;&#x7801;&#x903B;&#x8F91;</h3>
<p>&#x5728;&#x4E00;&#x4E2A;routine&#x91CC;, &#x968F;&#x673A;&#x751F;&#x6210;record&#x6570;&#x636E;, &#x4E0D;&#x65AD;&#x7684;&#x5199;&#x5165;&#x6587;&#x4EF6;;
&#x5728;&#x53E6;&#x4E00;&#x4E2A;routine&#x91CC;, &#x8BFB;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;decode.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    flt <span class="token operator">:=</span> <span class="token number">0.01</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>flt<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%x\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uint64</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    file <span class="token operator">:=</span> <span class="token string">&quot;gob.data&quot;</span>
    records <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>procStat<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>

    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        f<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
        <span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        enc <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>

        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            rcd <span class="token operator">:=</span> record<span class="token punctuation">{</span>Time<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
                ucpu<span class="token punctuation">,</span> scpu <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Float64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rand<span class="token punctuation">.</span><span class="token function">Float64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                ucpu <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>ucpu<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span>
                scpu <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>scpu<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span>
                <span class="token keyword">if</span> ucpu <span class="token operator">&lt;</span> <span class="token number">0.5</span> <span class="token punctuation">{</span>
                    ucpu <span class="token operator">=</span> <span class="token number">0</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> scpu <span class="token operator">&lt;</span> <span class="token number">0.5</span> <span class="token punctuation">{</span>
                    scpu <span class="token operator">=</span> <span class="token number">0</span>
                <span class="token punctuation">}</span>
                ps <span class="token operator">:=</span> procStat<span class="token punctuation">{</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">65535</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;worker&quot;</span><span class="token punctuation">,</span> ucpu<span class="token punctuation">,</span> scpu<span class="token punctuation">,</span> <span class="token number">11985</span><span class="token punctuation">}</span>
                rcd<span class="token punctuation">.</span>Procs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>rcd<span class="token punctuation">.</span>Procs<span class="token punctuation">,</span> ps<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            records<span class="token punctuation">[</span>rcd<span class="token punctuation">.</span>Time<span class="token punctuation">]</span> <span class="token operator">=</span> rcd<span class="token punctuation">.</span>Procs
            <span class="token keyword">if</span> err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>rcd<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span>rcd<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">//fmt.Println(&quot;++++&quot;, rcd)</span>
            time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;enc done&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">20</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            f<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
            <span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            dec <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>

            <span class="token keyword">var</span> rcd record <span class="token comment">// nok</span>
            <span class="token keyword">for</span> <span class="token punctuation">{</span>
                <span class="token comment">//var rcd record // ok</span>
                <span class="token keyword">if</span> err <span class="token operator">:=</span> dec<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rcd<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;----&quot;</span><span class="token punctuation">,</span> rcd<span class="token punctuation">)</span>
                should <span class="token operator">:=</span> records<span class="token punctuation">[</span>rcd<span class="token punctuation">.</span>Time<span class="token punctuation">]</span>
                got <span class="token operator">:=</span> rcd<span class="token punctuation">.</span>Procs
                <span class="token keyword">if</span> <span class="token operator">!</span>reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>should<span class="token punctuation">,</span> got<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span>rcd<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Should: \n&quot;</span><span class="token punctuation">,</span> should<span class="token punctuation">)</span>
                    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Got:    \n&quot;</span><span class="token punctuation">,</span> got<span class="token punctuation">)</span>
                    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>&#x5C0F;&#x77E5;&#x8BC6;: float&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x548C;&#x6574;&#x5F62;&#x7684;&#x5B58;&#x50A8;&#x65B9;&#x5F0F;&#x5F88;&#x4E0D;&#x4E00;&#x6837;, &#x6BD4;&#x5982;<code>0.01</code>&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x662F;<code>3f847ae147ae147b</code></li>
</ul>
<h3 id="&#x95EE;&#x9898;&#x73B0;&#x8C61;"><a name="&#x95EE;&#x9898;&#x73B0;&#x8C61;" class="anchor-navigation-ex-anchor" href="#&#x95EE;&#x9898;&#x73B0;&#x8C61;"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.3. &#x95EE;&#x9898;&#x73B0;&#x8C61;</h3>
<p>&#x8FD0;&#x884C;&#x8FD9;&#x6BB5;&#x7A0B;&#x5E8F;, &#x4F1A;&#x8D70;&#x5230;<code>reflect.DeepEqual</code>&#x4E3A;&#x5047;&#x7684;&#x5206;&#x652F;, &#x8BF4;&#x660E;encode&#x7684;&#x6570;&#x636E;&#x548C;decode&#x7684;&#x6570;&#x636E;&#x4E0D;&#x4E00;&#x6837;.
&#x4F46;&#x8FD8;&#x662F;&#x5F88;&#x6709;&#x89C4;&#x5F8B;&#x7684;:</p>
<pre class="language-"><code>$ go run gob.go
0.01
3f847ae147ae147b
2021-10-13 02:44:30 +0000 UTC
2021-10-13 02:44:32 +0000 UTC
2021-10-13 02:44:34 +0000 UTC
2021-10-13 02:44:36 +0000 UTC
2021-10-13 02:44:38 +0000 UTC
enc done
---- {1634093070 [{34730 worker 0 0.86 11985} {63668 worker 0.65 0 11985} {54333 worker 0.93 
0 11985} {45231 worker 0 0.76 11985} {19332 worker 0.82 0 11985} {51576 worker 0.59 0 11985} 
{16966 worker 0 0 11985} {17849 worker 0.84 0 11985} {18887 worker 0 0 11985} {36216 worker 0
 0.87 11985}]}
---- {1634093072 [{45159 worker 0.79 0.86 11985} {22705 worker 0.94 0 11985} {15938 worker 0.
93 0 11985} {45296 worker 0.71 0.63 11985} {8740 worker 0.82 0.93 11985} {36634 worker 0.94 0
.76 11985} {26329 worker 0 0.99 11985} {1891 worker 0.94 0 11985} {33214 worker 0.7 0 11985} 
{33629 worker 0.75 0.64 11985}]}
2021-10-13 02:44:32 +0000 UTC
Should:                  
 [{45159 worker 0.79 0 11985} {22705 worker 0.94 0 11985} {15938 worker 0 0 11985} {45296 wor
ker 0.71 0.63 11985} {8740 worker 0 0.93 11985} {36634 worker 0.94 0.76 11985} {26329 worker 
0 0.99 11985} {1891 worker 0.94 0 11985} {33214 worker 0.7 0 11985} {33629 worker 0.75 0.64 1
1985}]
Got:
 [{45159 worker 0.79 0.86 11985} {22705 worker 0.94 0 11985} {15938 worker 0.93 0 11985} {452
96 worker 0.71 0.63 11985} {8740 worker 0.82 0.93 11985} {36634 worker 0.94 0.76 11985} {2632
9 worker 0 0.99 11985} {1891 worker 0.94 0 11985} {33214 worker 0.7 0 11985} {33629 worker 0.
75 0.64 11985}]
---- {1634093074 [{1940 worker 0.87 0.62 11985} {59400 worker 0.94 0.57 11985} {10964 worker 
0.93 0 11985} {40707 worker 0.67 0.91 11985} {51810 worker 0.74 0.84 11985} {26919 worker 0.5
5 0.53 11985} {62442 worker 0 0.99 11985} {25 worker 0.97 0.78 11985} {4644 worker 0.79 0 119
85} {39752 worker 0.75 0.64 11985}]}
</code></pre><p>&#x89C4;&#x5F8B;:</p>
<ul>
<li>&#x7B2C;&#x4E00;&#x6B21;&#x65F6;&#x95F4;&#x6233;&#x65F6;, enc&#x548C;dec&#x7684;&#x6570;&#x636E;&#x662F;&#x4E00;&#x81F4;&#x7684;, &#x6B64;&#x65F6;&#x8FD8;&#x6CA1;&#x6709;&#x9519;&#x8BEF;.</li>
<li>&#x4ECE;&#x7B2C;&#x4E8C;&#x6B21;&#x65F6;&#x95F4;&#x6233;&#x5F00;&#x59CB;, dec&#x7684;&#x6570;&#x636E;&#x5C31;&#x5F00;&#x59CB;&#x53D1;&#x751F;&quot;&#x8DF3;&#x53D8;&quot;, &#x8868;&#x73B0;&#x662F;&#x7ED3;&#x6784;&#x4F53;&#x4E2D;<code>float64</code>&#x7C7B;&#x578B;&#x7684;&#x4E24;&#x4E2A;field(Ucpu&#x548C;Scpu), &#x5E94;&#x8BE5;&#x662F;0&#x503C;&#x7684;&#x5730;&#x65B9;, &#x4E0D;&#x662F;&#x96F6;&#x503C;, &#x6BD4;&#x5982;:<pre class="language-"><code>Should:
[{45159 worker 0.79 0 11985} {22705 worker 0.94 0 11985} ... ]
Got:
[{45159 worker 0.79 0.86 11985} {22705 worker 0.94 0 11985} ...]
</code></pre>&#x4E0A;&#x9762;&#x7B2C;&#x4E00;&#x4E2A;<code>procStat</code>&#x7ED3;&#x6784;&#x4F53;&#x7684;<code>Scpu</code>, &#x5E94;&#x8BE5;&#x662F;<code>0</code>, &#x5374;&#x53D8;&#x6210;&#x4E86;<code>0.86</code></li>
<li><code>0.86</code>&#x4F3C;&#x4E4E;&#x5E76;&#x4E0D;&#x662F;&quot;&#x968F;&#x673A;&quot;&#x7684;&#x503C;, &#x7ECF;&#x8FC7;&#x53D1;&#x73B0;, &#x6B63;&#x597D;&#x662F;<strong>&#x4E0A;&#x4E00;&#x6B21;</strong>recorde&#x7684;&#x540C;&#x4F4D;&#x7F6E;&#x7684;&#x503C;.</li>
</ul>
<h2 id="&#x89E3;&#x91CA;"><a name="&#x89E3;&#x91CA;" class="anchor-navigation-ex-anchor" href="#&#x89E3;&#x91CA;"><i class="fa fa-link" aria-hidden="true"></i></a>2.2. &#x89E3;&#x91CA;</h2>
<p>&#x5728;&#x7ED3;&#x8BBA;&#x4E4B;&#x524D;, &#x5148;&#x6392;&#x9664;&#x51E0;&#x70B9;:</p>
<ul>
<li>&#x548C;&#x540C;&#x65F6;&#x8BFB;&#x5199;&#x6587;&#x4EF6;&#x6CA1;&#x6709;&#x5173;&#x7CFB;. &#x5F00;&#x59CB;&#x6211;&#x4EEC;&#x6000;&#x7591;&#x662F;&#x6587;&#x4EF6;&#x5199;&#x7684;&#x540C;&#x65F6;, &#x53C8;&#x53BB;&#x6587;&#x4EF6;&#x8BFB;, &#x662F;&#x5426;&#x6587;&#x4EF6;&#x7684;&#x5185;&#x6838;&#x6001;buffer&#x6CA1;&#x6709;&quot;&#x53CA;&#x65F6;&quot;&#x5199;&#x8FDB;&#x53BB;, &#x9020;&#x6210;&#x8BFB;&#x6587;&#x4EF6;&#x7684;&#x65F6;&#x5019;&quot;&#x90E8;&#x5206;&quot;&#x8BFB;, &#x9020;&#x6210;&#x6570;&#x636E;&#x5F02;&#x5E38;. &#x4F46;&#x5176;&#x5B9E;&#x4E0D;&#x662F;, &#x5F00;&#x59CB;&#x7684;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x8BA9;&#x5199;&#x7684;routine&#x4E00;&#x76F4;&#x5199;, &#x540E;&#x9762;&#x6539;&#x6210;&#x5199;&#x5B8C;close, &#x7136;&#x540E;&#x518D;&#x8BFB;; &#x95EE;&#x9898;&#x4F9D;&#x65E7;</li>
<li>&#x548C;float64&#x7684;&#x7F16;&#x89E3;&#x7801;&#x6709;&#x5173;&#x5417;? &#x4F3C;&#x4E4E;&#x6709;&#x5173;, &#x4F46;&#x5982;&#x679C;&#x7F16;&#x89E3;&#x7801;&#x51FA;&#x9519;, &#x5E94;&#x8BE5;&#x662F;&#x5168;&#x90E8;float64&#x7684;&#x7F16;&#x89E3;&#x7801;&#x90FD;&#x6709;&#x95EE;&#x9898;. &#x4F46;&#x8FD9;&#x91CC;&#x7684;&#x73B0;&#x8C61;&#x662F;&quot;&#x4E2A;&#x522B;&quot;&#x6570;&#x636E;&quot;&#x8DF3;&#x53D8;&quot;</li>
</ul>
<p>&#x7ED3;&#x5408;&#x4EE5;&#x4E0A;&#x4E24;&#x70B9;, &#x7279;&#x522B;&#x662F;&#x7B2C;&#x4E8C;&#x70B9;, &#x6570;&#x636E;&#x8DF3;&#x53D8;&#x4F3C;&#x4E4E;&#x662F;<strong>&#x8DF3;&#x53D8;&#x6210;&#x4E86;&#x4EE5;&#x524D;&#x51FA;&#x73B0;&#x8FC7;&#x7684;&#x503C;</strong>.
&#x90A3;&#x4E48;&#x8FD9;&#x4E2A;<code>0.86</code>&#x662F;&#x54EA;&#x91CC;&#x6765;&#x7684;&#x5462;? &#x6B63;&#x597D;&#x662F;&#x4E0A;&#x4E00;&#x6B21;record&#x7684;&#x540C;&#x4F4D;&#x7F6E;&#x7684;&#x503C;:</p>
<pre class="language-"><code>{34730 worker 0 0.86 11985}
</code></pre><p>&#x90A3;&#x4E48;&#x73B0;&#x5728;&#x73B0;&#x8C61;&#x6BD4;&#x8F83;&#x660E;&#x786E;&#x4E86;: </p>
<ul>
<li>&#x96F6;&#x503C;&#x53EF;&#x80FD;&#x8DF3;&#x53D8;</li>
<li>&#x8DF3;&#x53D8;&#x7684;&#x503C;&#x662F;&#x4E0A;&#x4E00;&#x6B21;&#x540C;&#x4F4D;&#x7F6E;&#x7684;&#x503C;.</li>
</ul>
<p>&#x7B2C;49&#x884C;, &#x5728;for&#x4E4B;&#x524D;&#x5B9A;&#x4E49;&#x4E86;<code>var rcd record</code>, for&#x91CC;&#x9762;&#x7684;<code>dec.Decode(&amp;rcd)</code>&#x90FD;&#x662F;&#x4E00;&#x76F4;&#x5F80;&#x8FD9;&#x4E2A;&#x5730;&#x5740;decode.
&#x7B2C;&#x4E00;&#x6B21;<code>rcd</code>&#x5168;&#x90E8;&#x662F;&#x96F6;&#x503C;&#x7684;&#x65F6;&#x5019;, decode&#x6CA1;&#x95EE;&#x9898;; &#x4F46;&#x7B2C;&#x4E8C;&#x6B21;<code>rcd</code>&#x5DF2;&#x7ECF;&#x6709;&#x4E86;&#x7B2C;&#x4E00;&#x6B21;&#x7684;&#x503C;&#x4E86;, &#x53C8;&#x5982;&#x679C;gob&#x5728;decode&#x65F6;&#x5019;&#x9047;&#x5230;&#x96F6;&#x503C;, &#x6BD4;&#x5982;&#x4E0B;&#x9762;Ucpu&#x548C;Scpu&#x662F;0, gob&#x5E76;&#x4E0D;&#x4F1A;&#x7ED9;rcd&#x7684;&#x5BF9;&#x5E94;field&#x8D4B;&#x503C;, &#x5BFC;&#x81F4;rcd&#x7684;&#x8FD9;&#x90E8;&#x5206;&#x503C;&#x8FD8;&#x662F;&#x96F6;&#x503C;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> procStat <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Pid  <span class="token builtin">int</span>
    Name <span class="token builtin">string</span>
    Ucpu <span class="token builtin">float64</span>
    Scpu <span class="token builtin">float64</span>
    Mem  <span class="token builtin">uint64</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x9A8C;&#x8BC1;"><a name="&#x9A8C;&#x8BC1;" class="anchor-navigation-ex-anchor" href="#&#x9A8C;&#x8BC1;"><i class="fa fa-link" aria-hidden="true"></i></a>2.3. &#x9A8C;&#x8BC1;</h2>
<p>&#x628A;49&#x884C;&#x6362;&#x6210;51&#x884C;, &#x5373;&#x5728;for&#x5185;&#x90E8;&#x5B9A;&#x4E49;rcd, &#x7ED3;&#x679C;&#x5C31;ok&#x4E86;. &#x6211;&#x731C;&#x60F3;&#x662F;&#x56E0;&#x4E3A;<code>dec.Decode(&amp;rcd)</code>&#x56E0;&#x4E3A;&#x5165;&#x53C2;&#x662F;<code>interface{}</code>, &#x5BFC;&#x81F4;rcd&#x9003;&#x9038;&#x5230;&#x5806;. &#x56E0;&#x4E3A;&#x662F;for&#x5185;&#x90E8;&#x5B9A;&#x4E49;&#x7684;, &#x6BCF;&#x6B21;&#x8FD0;&#x884C;&#x5230;<code>var rcd record</code>, &#x90FD;&#x4F1A;&#x5728;&#x5806;&#x91CC;<strong>&#x65B0;&#x5206;&#x914D;</strong>rcd, &#x8FD9;&#x6837;&#x5C31;&#x4E0D;&#x53D7;&#x524D;&#x503C;&#x5F71;&#x54CD;.</p>
<p>&#x628A;float64&#x6539;&#x6210;int, &#x6309;&#x7167;&#x4E0A;&#x9762;&#x7684;&#x7406;&#x8BBA;, 0&#x503C;&#x4E5F;&#x4F1A;&quot;&#x8DF3;&#x53D8;&quot;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> procStat <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Pid  <span class="token builtin">int</span>
    Name <span class="token builtin">string</span>
    Ucpu <span class="token builtin">int</span>
    Scpu <span class="token builtin">int</span>
    Mem  <span class="token builtin">uint64</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x7ECF;&#x8FC7;&#x9A8C;&#x8BC1;, &#x786E;&#x5B9E;&#x96F6;&#x503C;&#x4E5F;&#x4F1A;&#x8DF3;&#x53D8;. &#x8BF4;&#x660E;&#x548C;float64&#x7F16;&#x7801;&#x6CA1;&#x6709;&#x5173;&#x7CFB;.</p>
<h2 id="&#x7ED3;&#x8BBA;"><a name="&#x7ED3;&#x8BBA;" class="anchor-navigation-ex-anchor" href="#&#x7ED3;&#x8BBA;"><i class="fa fa-link" aria-hidden="true"></i></a>2.4. &#x7ED3;&#x8BBA;</h2>
<ul>
<li><code>dec.Decode(&amp;rcd)</code>gob&#x9047;&#x5230;&#x96F6;&#x503C;, &#x4E0D;&#x4F1A;&#x7ED9;<code>rcd</code>&#x76F8;&#x5E94;&#x7684;field&#x8D4B;&#x503C;</li>
<li>&#x6240;&#x4EE5;, &#x9700;&#x8981;<strong>&#x6BCF;&#x4E00;&#x6B21;</strong>&#x5728;&#x4F7F;&#x7528;rcd&#x4E4B;&#x524D;, &#x90FD;&#x8981;&#x4FDD;&#x8BC1;&#x5B83;&#x4E3A;&#x96F6;&#x503C;<ul>
<li>&#x8981;&#x4E48;&#x5728;for&#x91CC;&#x9762;&#x5B9A;&#x4E49;rcd, &#x8FD8;&#x8981;&#x89C2;&#x5BDF;rcd&#x662F;&#x5426;&#x771F;&#x7684;&#x9003;&#x9038;&#x5230;&#x5806;</li>
<li>&#x8981;&#x4E48;&#x624B;&#x52A8;&#x7ED9;rcd&#x8D4B;&#x503C;&#x4E3A;0</li>
</ul>
</li>
<li>&#x6240;&#x4EE5;, &#x5728;go&#x91CC;&#x9762;, &#x6D89;&#x53CA;&#x5230;&#x89E3;&#x7801;, &#x6216;&#x8005;&#x5BF9;&#x53D8;&#x91CF;&#x6307;&#x9488;&#x64CD;&#x505A;, &#x8981;&#x7279;&#x522B;&#x6CE8;&#x610F;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;&#x5728;&#x5185;&#x5B58;&#x91CC;&#x7684;&#x8868;&#x8FBE;:<ul>
<li>&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#x5185;&#x5B58;&#x5730;&#x5740;&#x65F6;, &#x901A;&#x5E38;&#x90FD;&#x6709;bug</li>
<li>&#x8865;&#x5145;: &#x5192;&#x53F7;&#x5B9A;&#x4E49;&#x53D8;&#x91CF;<code>var v := ...</code>&#x548C;new&#x53D8;&#x91CF;&#x90FD;&#x4E0D;&#x80FD;&#x4FDD;&#x8BC1;&#x5206;&#x914D;&#x65B0;&#x7684;&#x53D8;&#x91CF;&#x5730;&#x5740;</li>
</ul>
</li>
<li>&#x8865;&#x5145;, &#x6539;&#x6210;json&#x7F16;&#x89E3;&#x7801;&#x4E0D;&#x4F1A;&#x6709;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;, &#x4F30;&#x8BA1;json&#x5728;&#x9047;&#x5230;&#x96F6;&#x503C;&#x4F9D;&#x7136;&#x6709;&#x8D4B;&#x503C;&#x52A8;&#x4F5C;.</li>
</ul>
<h1 id="setuid"><a name="setuid" class="anchor-navigation-ex-anchor" href="#setuid"><i class="fa fa-link" aria-hidden="true"></i></a>3. setuid</h1>
<p><a href="https://dustinspecker.com/posts/setuid-elevating-privileges/" target="_blank">https://dustinspecker.com/posts/setuid-elevating-privileges/</a></p>
<p>&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x53EF;&#x4EE5;&#x6709;setuid&#x5C5E;&#x6027;:</p>
<blockquote>
<p>Setuid, which stands for set user ID on execution, is a special type of file permission in Unix and Unix-like operating systems such as Linux and BSD. It is a security tool that permits users to run certain programs with escalated privileges.</p>
<p>When an executable file&apos;s setuid permission is set, users may execute that program with a level of access that matches the user who owns the file. For instance, when a user wants to change their password, they run the passwd command. The passwd program is owned by the root account and marked as setuid, so the user is temporarily granted root access for that limited purpose.</p>
</blockquote>
<p>&#x547D;&#x4EE4;:</p>
<pre class="language-"><code>chmod u+s myfile
chmod u+x myfile
chmod g+s myfile2
</code></pre><p>&#x4E00;&#x822C;&#x90FD;&#x662F;&#x8C01;&#x6267;&#x884C;myfile, &#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x7B97;&#x8C01;&#x7684;. &#x4F46;&#x5982;&#x679C;&#x7531;setuid&#x5C5E;&#x6027;&#x7684;&#x6587;&#x4EF6;, &#x6267;&#x884C;&#x7B97;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x7684;owner&#x7684;. &#x6BD4;&#x5982;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x7684;owner&#x662F;root, &#x90A3;&#x666E;&#x901A;&#x7528;&#x6237;&#x6267;&#x884C;&#x8FD9;&#x4E2A;&#x5E26;<code>s</code>&#x5C5E;&#x6027;&#x7684;&#x6587;&#x4EF6;, &#x4E5F;&#x6709;root&#x6743;&#x9650;.</p>
<h1 id="&#x8C03;&#x7528;&#x5C0F;&#x5199;&#x51FD;&#x6570;"><a name="&#x8C03;&#x7528;&#x5C0F;&#x5199;&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#&#x8C03;&#x7528;&#x5C0F;&#x5199;&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>4. &#x8C03;&#x7528;&#x5C0F;&#x5199;&#x51FD;&#x6570;</h1>
<p>&#x4E00;&#x822C;&#x7684;, package&#x7684;&#x5C0F;&#x5199;&#x51FD;&#x6570;&#x662F;&#x6CA1;&#x6CD5;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x7684;, &#x4F46;&#x6709;&#x4E2A;&#x529E;&#x6CD5;&#x53EF;&#x4EE5;&#x7ED5;&#x8FC7;&#x8FD9;&#x4E2A;&#x9650;&#x5236;.
&#x7528;<code>go:linkname</code>
&#x6BD4;&#x5982;&#x6807;&#x51C6;&#x5E93;&#x91CC;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">package</span> reflect

<span class="token comment">//go:linkname call runtime.reflectcall</span>
<span class="token keyword">func</span> <span class="token function">call</span><span class="token punctuation">(</span>argtype <span class="token operator">*</span>rtype<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> arg unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> n <span class="token builtin">uint32</span><span class="token punctuation">,</span> retoffset <span class="token builtin">uint32</span><span class="token punctuation">)</span>
</code></pre>
<p>reflect&#x7684;call&#x88AB;link&#x6210;&#x4E86;<code>runtime.reflectcall</code>, &#x4E5F;&#x5C31;&#x662F;&#x8BF4;, &#x8C03;&#x7528;<code>reflect.call</code>&#x5C31;&#x662F;&#x8C03;&#x7528;&#x5C0F;&#x5199;&#x7684;<code>runtime.reflectcall</code>.</p>
<h1 id="&#x4F7F;&#x7528;&#x4E86;nohup&#x547D;&#x4EE4;&#x542F;&#x52A8;gshelld-&#x8FD8;&#x662F;&#x6536;&#x5230;signal&#x9000;&#x51FA;"><a name="&#x4F7F;&#x7528;&#x4E86;nohup&#x547D;&#x4EE4;&#x542F;&#x52A8;gshelld-&#x8FD8;&#x662F;&#x6536;&#x5230;signal&#x9000;&#x51FA;" class="anchor-navigation-ex-anchor" href="#&#x4F7F;&#x7528;&#x4E86;nohup&#x547D;&#x4EE4;&#x542F;&#x52A8;gshelld-&#x8FD8;&#x662F;&#x6536;&#x5230;signal&#x9000;&#x51FA;"><i class="fa fa-link" aria-hidden="true"></i></a>5. &#x4F7F;&#x7528;&#x4E86;nohup&#x547D;&#x4EE4;&#x542F;&#x52A8;gshelld, &#x8FD8;&#x662F;&#x6536;&#x5230;signal&#x9000;&#x51FA;</h1>
<pre class="language-"><code>nohup bin/gshell -wd rootregistry -loglevel debug daemon -registry 10.182.105.179:11985 -bcast 9923 -root -repo gitlabe1.ext.net.nokia.com/godevsig/grepo/master &amp;
</code></pre><p>&#x4F46;gshell&#x8FD8;&#x662F;&#x4F1A;&#x9000;&#x51FA;</p>
<pre class="language-"><code>[2021/09/09 12:23:16.705595][daemon][WARN](adaptiveservice.go:215) signal: hangup
[2021/09/09 12:23:16.705762][daemon][INFO](server.go:350) server closing
[2021/09/09 12:23:16.705827][daemon][DEBUG](scalamsgq.go:49) msgq closed
</code></pre><h2 id="sighup"><a name="sighup" class="anchor-navigation-ex-anchor" href="#sighup"><i class="fa fa-link" aria-hidden="true"></i></a>5.1. SIGHUP</h2>
<h3 id="types-of-signals-&#xB6;"><a name="types-of-signals-&#xB6;" class="anchor-navigation-ex-anchor" href="#types-of-signals-&#xB6;"><i class="fa fa-link" aria-hidden="true"></i></a>5.1.1. Types of signals &#xB6;</h3>
<p>The signals SIGKILL and SIGSTOP may not be caught by a program, and therefore cannot be affected by this package.</p>
<p>Synchronous signals are signals triggered by errors in program execution: SIGBUS, SIGFPE, and SIGSEGV. These are only considered synchronous when caused by program execution, not when sent using os.Process.Kill or the kill program or some similar mechanism. In general, except as discussed below, Go programs will convert a synchronous signal into a run-time panic.</p>
<p>The remaining signals are asynchronous signals. They are not triggered by program errors, but are instead sent from the kernel or from some other program.</p>
<p>Of the asynchronous signals, the SIGHUP signal is sent when a program loses its controlling terminal. The SIGINT signal is sent when the user at the controlling terminal presses the interrupt character, which by default is ^C (Control-C). The SIGQUIT signal is sent when the user at the controlling terminal presses the quit character, which by default is ^\ (Control-Backslash). In general you can cause a program to simply exit by pressing ^C, and you can cause it to exit with a stack dump by pressing ^.</p>
<p>&#x6CE8;&#x610F;&#x4E0A;&#x9762;&#x7684;&#x89E3;&#x91CA;, &#x5F53;&#x4E3B;&#x63A7;&#x5236;&#x53F0;&#x4E22;&#x5931;&#x7684;&#x65F6;&#x5019;, &#x4F1A;&#x53D1;SIGHUP&#x7ED9;&#x7A0B;&#x5E8F;.
SIGHUP&#x7684;&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;&#x662F;&#x7A0B;&#x5E8F;&#x9000;&#x51FA;: <code>man 7 signal</code> &#x641C;&#x7D22;SIGHUP</p>
<h2 id="&#x63A8;&#x6D4B;"><a name="&#x63A8;&#x6D4B;" class="anchor-navigation-ex-anchor" href="#&#x63A8;&#x6D4B;"><i class="fa fa-link" aria-hidden="true"></i></a>5.2. &#x63A8;&#x6D4B;</h2>
<p>nohup&#x547D;&#x4EE4;ignore&#x4E86;SIGHUP, &#x4ECE;&#x800C;&#x5176;&#x5B50;&#x8FDB;&#x7A0B;&#x4E5F;&#x9ED8;&#x8BA4;&#x7EE7;&#x627F;&#x4E86;&#x8FD9;&#x4E2A;irgnore&#x7684;&#x884C;&#x4E3A;.
&#x800C;gshell&#x4EE3;&#x7801;&#x91CC;, &#x663E;&#x5F0F;&#x6355;&#x6349;&#x4E86;<code>syscall.SIGHUP</code>:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">initSigCleaner</span><span class="token punctuation">(</span>lg Logger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sigOnce<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// handle signal</span>
        sigChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>sigChan<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGHUP<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sig <span class="token operator">:=</span> <span class="token operator">&lt;-</span>sigChan
            lg<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;signal: %s&quot;</span><span class="token punctuation">,</span> sig<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            sigCleaner<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> sigCleaner<span class="token punctuation">.</span>closers <span class="token punctuation">{</span>
                c<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            sigCleaner<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6240;&#x4EE5;&#x660E;&#x660E;&#x5E94;&#x8BE5;ignore&#x7684;SIGHUP, &#x53C8;&#x53D1;&#x6325;&#x4E86;&#x4F5C;&#x7528;...</p>
<h2 id="&#x89E3;&#x51B3;"><a name="&#x89E3;&#x51B3;" class="anchor-navigation-ex-anchor" href="#&#x89E3;&#x51B3;"><i class="fa fa-link" aria-hidden="true"></i></a>5.3. &#x89E3;&#x51B3;</h2>
<p>&#x5E94;&#x8BE5;&#x53BB;&#x6389;&#x8FD9;&#x4E2A;syscall.SIGHUP&#x7684;&#x6355;&#x6349;&#x5C31;&#x597D;&#x4E86;, &#x8FD8;&#x662F;&#x7528;nohup&#x542F;&#x52A8;.
&#x66F4;&#x597D;&#x7684;&#x529E;&#x6CD5;, &#x662F;&#x7528;Ignore API:</p>
<pre class="language-"><code class="lang-go">signal<span class="token punctuation">.</span><span class="token function">Ignore</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>SIGHUP<span class="token punctuation">)</span>
</code></pre>
<h1 id="gshell&#x7684;&#x5185;&#x5B58;&#x4F7F;&#x7528;"><a name="gshell&#x7684;&#x5185;&#x5B58;&#x4F7F;&#x7528;" class="anchor-navigation-ex-anchor" href="#gshell&#x7684;&#x5185;&#x5B58;&#x4F7F;&#x7528;"><i class="fa fa-link" aria-hidden="true"></i></a>6. gshell&#x7684;&#x5185;&#x5B58;&#x4F7F;&#x7528;</h1>
<p>&#x7528;&#x5230;&#x7684;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x662F;<code>bin/gshell</code>, &#x547D;&#x4EE4;: </p>
<pre class="language-"><code>cat /proc/29961/smaps
readelf -a
</code></pre><p>&#x6CE8;: </p>
<table>
<thead>
<tr>
<th>&#x5185;&#x5B58;\&#x573A;&#x666F;</th>
<th>&#x5355;daemon KB</th>
<th>daemon + master gre</th>
</tr>
</thead>
<tbody>
<tr>
<td>.text RSS</td>
<td>2388</td>
<td>2388 + 2516</td>
</tr>
<tr>
<td>.text <strong>PSS</strong></td>
<td>2388</td>
<td>1194 + 1322</td>
</tr>
<tr>
<td>.rodata RSS</td>
<td>2024</td>
<td>2088 + 2152</td>
</tr>
<tr>
<td>.rodata <strong>PSS</strong></td>
<td>2024</td>
<td>1044 + 1108</td>
</tr>
<tr>
<td>.go.buildinfo RSS</td>
<td>144</td>
<td>144 + 144</td>
</tr>
<tr>
<td>.go.buildinfo PSS</td>
<td>144</td>
<td>96 + 96</td>
</tr>
<tr>
<td>.bss RSS</td>
<td>84</td>
<td>84 + 72</td>
</tr>
<tr>
<td>.bss PSS</td>
<td>84</td>
<td>84 + 72</td>
</tr>
<tr>
<td>&#x6808;? RSS</td>
<td>2244</td>
<td>2352 + 2772</td>
</tr>
<tr>
<td>&#x6808;? PSS</td>
<td>2244</td>
<td>2352 + 2772</td>
</tr>
<tr>
<td>&#x5806;? RSS</td>
<td>1504</td>
<td>1576 + 320</td>
</tr>
<tr>
<td>&#x5806;? PSS</td>
<td>1504</td>
<td>1576 + 320</td>
</tr>
<tr>
<td>n&#x4E2A;routine&#x6808; RSS</td>
<td>0/4</td>
<td>0/4 + 0/4</td>
</tr>
<tr>
<td>n&#x4E2A;routine&#x6808; PSS</td>
<td>0/4</td>
<td>0/4 + 0/4</td>
</tr>
<tr>
<td>&#x7CFB;&#x7EDF;&#x6808;1? RSS</td>
<td>68</td>
<td>68 + 68</td>
</tr>
<tr>
<td>&#x7CFB;&#x7EDF;&#x6808;1? PSS</td>
<td>68</td>
<td>68 + 68</td>
</tr>
<tr>
<td>&#x7CFB;&#x7EDF;&#x6808;2? RSS</td>
<td>12</td>
<td>12 + 12</td>
</tr>
<tr>
<td>&#x7CFB;&#x7EDF;&#x6808;2? PSS</td>
<td>12</td>
<td>12 + 12</td>
</tr>
<tr>
<td>vdso RSS</td>
<td>4</td>
<td>4 + 4</td>
</tr>
<tr>
<td>vdso <strong>PSS</strong></td>
<td>0</td>
<td>0 + 0</td>
</tr>
</tbody>
</table>
<p>&#x7ED3;&#x8BBA;: &#x540C;&#x4E00;&#x4E2A;go&#x7684;binary, &#x591A;&#x6B21;&#x5355;&#x72EC;&#x542F;&#x52A8;&#x7684;&#x60C5;&#x51B5;&#x4E0B;: </p>
<ul>
<li>&#x4EE3;&#x7801;&#x6BB5;.text&#x662F;&#x5171;&#x4EAB;&#x7684;</li>
<li>&#x53EA;&#x8BFB;&#x6570;&#x636E;&#x6BB5;.rodata&#x662F;&#x5171;&#x4EAB;&#x7684;</li>
<li>vdso&#x7B49;kernel so&#x662F;&#x5171;&#x4EAB;&#x7684;</li>
<li>&#x5176;&#x4ED6;&#x597D;&#x50CF;&#x90FD;&#x4E0D;&#x5171;&#x4EAB;</li>
</ul>
<h1 id="recover&#x4E0D;&#x80FD;&#x6355;&#x83B7;sigsegv&#x7C7B;&#x578B;&#x7684;panic"><a name="recover&#x4E0D;&#x80FD;&#x6355;&#x83B7;sigsegv&#x7C7B;&#x578B;&#x7684;panic" class="anchor-navigation-ex-anchor" href="#recover&#x4E0D;&#x80FD;&#x6355;&#x83B7;sigsegv&#x7C7B;&#x578B;&#x7684;panic"><i class="fa fa-link" aria-hidden="true"></i></a>7. recover&#x4E0D;&#x80FD;&#x6355;&#x83B7;SIGSEGV&#x7C7B;&#x578B;&#x7684;panic</h1>
<p>&#x6BD4;&#x5982;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            lg<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;broken stream chan: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    streamChan <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">chan</span> <span class="token operator">*</span>streamTransportMsg<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>tm<span class="token punctuation">.</span>dstChan<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// swap src and dst</span>
    streamChan <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>streamTransportMsg<span class="token punctuation">{</span>srcChan<span class="token punctuation">:</span> tm<span class="token punctuation">.</span>dstChan<span class="token punctuation">,</span> dstChan<span class="token punctuation">:</span> tm<span class="token punctuation">.</span>srcChan<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> tm<span class="token punctuation">.</span>msg<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>defer&#x7684;&#x51FD;&#x6570;&#x4E2D;, recover&#x5E76;&#x4E0D;&#x80FD;&#x6355;&#x83B7;&#x4E0B;&#x9762;&#x7684;panic:</p>
<pre class="language-"><code>fatal error: unexpected signal during runtime execution
[signal SIGSEGV: segmentation violation code=0x80 addr=0x0 pc=0x40bbee]

...
</code></pre><h1 id="sigint&#x4F1A;&#x53D1;&#x7ED9;&#x6240;&#x6709;&#x524D;&#x53F0;&#x8FDB;&#x7A0B;&#x7EC4;"><a name="sigint&#x4F1A;&#x53D1;&#x7ED9;&#x6240;&#x6709;&#x524D;&#x53F0;&#x8FDB;&#x7A0B;&#x7EC4;" class="anchor-navigation-ex-anchor" href="#sigint&#x4F1A;&#x53D1;&#x7ED9;&#x6240;&#x6709;&#x524D;&#x53F0;&#x8FDB;&#x7A0B;&#x7EC4;"><i class="fa fa-link" aria-hidden="true"></i></a>8. sigint&#x4F1A;&#x53D1;&#x7ED9;&#x6240;&#x6709;&#x524D;&#x53F0;&#x8FDB;&#x7A0B;&#x7EC4;</h1>
<p>gshell daemon&#x8D77;&#x4E86;&#x5B50;&#x8FDB;&#x7A0B;gre-master, &#x5728;&#x524D;&#x53F0;ctrl+c daemon, gre-master&#x4E5F;&#x4F1A;&#x6536;&#x5230;sigint, &#x4E24;&#x4E2A;&#x8FDB;&#x7A0B;&#x90FD;&#x4F1A;&#x6D88;&#x5931;.
&#x4F46;&#x5982;&#x679C;daemon&#x8FDB;&#x7A0B;&#x81EA;&#x5DF1;panic&#x6302;&#x6389;, gre-master&#x8FD8;&#x4F1A;&#x7EE7;&#x7EED;&#x8FD0;&#x884C;.</p>
<p>&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;, &#x5982;&#x679C;&#x7528;kill&#x547D;&#x4EE4;&#x6307;&#x5B9A;&#x5411;daemon&#x8FDB;&#x7A0B;&#x53D1;&#x9001;signit, &#x90A3;&#x5C31;&#x6307;&#x5B9A;pid&#x624D;&#x4F1A;&#x6536;&#x5230;&#x4FE1;&#x53F7;, &#x4E5F;&#x4E0D;&#x4F1A;&#x5BFC;&#x81F4;gre-master&#x6302;&#x6389;.
&#x89C1;<a href="notes/system_&#x539F;&#x7406;&#x6742;&#x8BB0;.md">system &#x539F;&#x7406;&#x6742;&#x8BB0;</a></p>
<h1 id="&#x5199;&#x5DF2;&#x7ECF;closed&#x7684;conn"><a name="&#x5199;&#x5DF2;&#x7ECF;closed&#x7684;conn" class="anchor-navigation-ex-anchor" href="#&#x5199;&#x5DF2;&#x7ECF;closed&#x7684;conn"><i class="fa fa-link" aria-hidden="true"></i></a>9. &#x5199;&#x5DF2;&#x7ECF;closed&#x7684;conn</h1>
<h2 id="&#x573A;&#x666F;"><a name="&#x573A;&#x666F;" class="anchor-navigation-ex-anchor" href="#&#x573A;&#x666F;"><i class="fa fa-link" aria-hidden="true"></i></a>9.1. &#x573A;&#x666F;</h2>
<p>&#x673A;&#x5668;A&#x7684;&#x8FDB;&#x7A0B;a&#x548C;&#x673A;&#x5668;B&#x7684;&#x8FDB;&#x7A0B;b&#x5EFA;&#x7ACB;&#x4E86;TCP&#x7684;conn
a&#x4E00;&#x76F4;&#x8BFB;, b&#x4E00;&#x76F4;&#x5199;.
a&#x88AB;&#x6740;&#x6389;, b&#x4F1A;&#x600E;&#x4E48;&#x6837;? &#x4F1A;&#x5199;&#x5931;&#x8D25;&#x5417;? &#x5199;&#x4F1A;&#x4E00;&#x76F4;&#x963B;&#x585E;&#x5417;?</p>
<h2 id="&#x7B54;&#x6848;"><a name="&#x7B54;&#x6848;" class="anchor-navigation-ex-anchor" href="#&#x7B54;&#x6848;"><i class="fa fa-link" aria-hidden="true"></i></a>9.2. &#x7B54;&#x6848;</h2>
<p>b&#x4F1A;&#x5199;&#x5931;&#x8D25;, error&#x4FE1;&#x606F;&#x4E3A;:
<code>writev tcp 172.17.0.1:40757-&gt;172.17.0.4:34458: use of closed network connection</code></p>
<h2 id="&#x7ED3;&#x8BBA;_1"><a name="&#x7ED3;&#x8BBA;_1" class="anchor-navigation-ex-anchor" href="#&#x7ED3;&#x8BBA;_1"><i class="fa fa-link" aria-hidden="true"></i></a>9.3. &#x7ED3;&#x8BBA;</h2>
<p>&#x4E0D;&#x7BA1;&#x662F;socket&#x8BFB;, &#x8FD8;&#x662F;socket&#x5199;, &#x90FD;&#x80FD;&#x611F;&#x77E5;&#x5230;connection&#x5DF2;&#x7ECF;&#x5173;&#x95ED;.
&#x4F46;&#x524D;&#x63D0;&#x662F;&#x673A;&#x5668;A&#x4E0D;&#x662F;&#x7A81;&#x7136;&#x65AD;&#x7535;. &#x5728;&#x673A;&#x5668;A&#x8FD8;&#x5728;&#x4F46;&#x8FDB;&#x7A0B;a&#x88AB;&#x6740;&#x6389;&#x7684;&#x60C5;&#x51B5;&#x4E0B;, A&#x7684;kernel&#x4F1A;&#x5173;&#x95ED;&#x548C;B&#x7684;&#x8FDE;&#x63A5;, B&#x7684;kernel&#x548C;&#x8FDB;&#x7A0B;b&#x90FD;&#x662F;&#x77E5;&#x9053;&#x5BF9;&#x65B9;(&#x4E5F;&#x5C31;&#x662F;A)&#x8FDE;&#x63A5;&#x4E2D;&#x65AD;&#x4E86;.</p>
<h1 id="&#x8BFB;&#x5199;nil-channel&#x4F1A;&#x6C38;&#x8FDC;&#x963B;&#x585E;"><a name="&#x8BFB;&#x5199;nil-channel&#x4F1A;&#x6C38;&#x8FDC;&#x963B;&#x585E;" class="anchor-navigation-ex-anchor" href="#&#x8BFB;&#x5199;nil-channel&#x4F1A;&#x6C38;&#x8FDC;&#x963B;&#x585E;"><i class="fa fa-link" aria-hidden="true"></i></a>10. &#x8BFB;&#x5199;nil channel&#x4F1A;&#x6C38;&#x8FDC;&#x963B;&#x585E;</h1>
<p>&#x5E76;&#x4E14;&#x8C03;&#x7528;&#x6808;&#x91CC;&#x9762;, &#x4F1A;&#x660E;&#x663E;&#x7684;&#x6807;&#x8BC6;: <code>[chan send (nil chan)]</code>
&#x6BD4;&#x5982;:</p>
<pre class="language-"><code>goroutine 34 [chan send (nil chan)]:
github.com/godevsig/adaptiveservice.(*streamTransport).receiver.func1(0x5e7c48, 0xc0000c2ba0, 0xc0000a7140)
        /repo/yingjieb/github/godevsig/adaptiveservice/streamtransport.go:213 +0x49
created by github.com/godevsig/adaptiveservice.(*streamTransport).receiver
        /repo/yingjieb/github/godevsig/adaptiveservice/streamtransport.go:206 +0x8a
</code></pre><p>&#x53C2;&#x8003;go&#x89C4;&#x8303;:</p>
<blockquote>
<p>Receiving from a <code>nil</code> channel blocks forever
A send on a <code>nil</code> channel blocks forever.</p>
</blockquote>
<h1 id="&#x6D41;&#x5F0F;&#x63A5;&#x53E3;&#x548C;go"><a name="&#x6D41;&#x5F0F;&#x63A5;&#x53E3;&#x548C;go" class="anchor-navigation-ex-anchor" href="#&#x6D41;&#x5F0F;&#x63A5;&#x53E3;&#x548C;go"><i class="fa fa-link" aria-hidden="true"></i></a>11. &#x6D41;&#x5F0F;&#x63A5;&#x53E3;&#x548C;go</h1>
<p>&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x6D41;&#x5F0F;&#x63A5;&#x53E3;&#x5C31;&#x662F;&#x8BF4;&#x8FD4;&#x56DE;&#x5176;&#x81EA;&#x8EAB;&#x7684;&#x65B9;&#x6CD5;.
&#x6BD4;&#x5982;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// NewClient creates a client which discovers services.</span>
<span class="token keyword">func</span> <span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Client <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Client<span class="token punctuation">{</span>
        base<span class="token punctuation">:</span>            <span class="token function">newBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        discoverTimeout<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// WithinScopeOS sets the discover scope in same OS.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">WithinScopeOS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Client <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span><span class="token function">withinScopeOS</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> c
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&quot;&#x6D41;&#x5F0F;&quot;&#x7684;&#x521D;&#x59CB;&#x5316;:</p>
<pre class="language-"><code class="lang-go">c <span class="token operator">:=</span> <span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithinScopeOS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithDiscoverTimeout</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x90A3;&#x4E48;&#x5982;&#x679C;&#x6211;&#x5411;go&#x8FD9;&#x4E2A;&#x6D41;&#x5F0F;&#x51FD;&#x6570;&#x94FE;&#x5462;? &#x6BD4;&#x5982;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">go</span> <span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithinScopeOS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithDiscoverTimeout</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x5176;&#x6267;&#x884C;&#x987A;&#x5E8F;&#x662F;&#x600E;&#x4E48;&#x6837;&#x7684;?</p>
<h2 id="&#x6D41;&#x5F0F;&#x51FD;&#x6570;&#x94FE;&#x7684;go&#x6267;&#x884C;&#x987A;&#x5E8F;"><a name="&#x6D41;&#x5F0F;&#x51FD;&#x6570;&#x94FE;&#x7684;go&#x6267;&#x884C;&#x987A;&#x5E8F;" class="anchor-navigation-ex-anchor" href="#&#x6D41;&#x5F0F;&#x51FD;&#x6570;&#x94FE;&#x7684;go&#x6267;&#x884C;&#x987A;&#x5E8F;"><i class="fa fa-link" aria-hidden="true"></i></a>11.1. &#x6D41;&#x5F0F;&#x51FD;&#x6570;&#x94FE;&#x7684;go&#x6267;&#x884C;&#x987A;&#x5E8F;</h2>
<p>&#x5148;&#x770B;&#x4EE3;&#x7801;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> test <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewTest</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>test <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;in NewTest&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>test<span class="token punctuation">{</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>test<span class="token punctuation">)</span> <span class="token function">fa</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>test <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">&quot;in fa&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> t
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>test<span class="token punctuation">)</span> <span class="token function">fb</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>test <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;fb&quot;</span><span class="token punctuation">)</span>
    <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> t
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, playground&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">go</span> <span class="token function">NewTest</span><span class="token punctuation">(</span>
        <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;before go? -- YES&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">&quot;San&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">fa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">fb</span><span class="token punctuation">(</span>
            <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;before go? -- NO&quot;</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;in go? -- YES&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x89E3;&#x8BFB;"><a name="&#x89E3;&#x8BFB;" class="anchor-navigation-ex-anchor" href="#&#x89E3;&#x8BFB;"><i class="fa fa-link" aria-hidden="true"></i></a>11.1.1. &#x89E3;&#x8BFB;</h3>
<ul>
<li>NewTest&#x51FD;&#x6570;&#x5165;&#x53C2;&#x662F;&#x4E2A;&#x51FD;&#x6570;, &#x4F20;&#x5165;&#x7684;&#x65F6;&#x5019;&#x8FD4;&#x56DE;&#x95ED;&#x5305;&#x51FD;&#x6570;&#x4F20;&#x7ED9;&#x5B83;</li>
<li>fa&#x51FD;&#x6570;&#x662F;&#x666E;&#x901A;&#x7684;&#x51FD;&#x6570;&#x94FE;&#x4E0A;&#x7684;&#x4E00;&#x4E2A;</li>
<li>fb&#x51FD;&#x6570;&#x4E5F;&#x662F;&#x51FD;&#x6570;&#x94FE;&#x4E0A;&#x7684;, &#x4F46;&#x4F20;&#x5165;&#x4E00;&#x4E2A;&#x95ED;&#x5305;&#x51FD;&#x6570;&#x7ED9;&#x5B83;.</li>
<li>&#x5927;&#x7684;&#x8C03;&#x7528;&#x5173;&#x7CFB;&#x662F;<code>go NewTest(&#x5165;&#x53C2;).fa().fb(&#x5165;&#x53C2;)</code></li>
</ul>
<h3 id="&#x8FD0;&#x884C;&#x7ED3;&#x679C;&#x548C;&#x7ED3;&#x8BBA;"><a name="&#x8FD0;&#x884C;&#x7ED3;&#x679C;&#x548C;&#x7ED3;&#x8BBA;" class="anchor-navigation-ex-anchor" href="#&#x8FD0;&#x884C;&#x7ED3;&#x679C;&#x548C;&#x7ED3;&#x8BBA;"><i class="fa fa-link" aria-hidden="true"></i></a>11.1.2. &#x8FD0;&#x884C;&#x7ED3;&#x679C;&#x548C;&#x7ED3;&#x8BBA;</h3>
<p>&#x7ED3;&#x679C;:</p>
<pre class="language-"><code>Hello, playground
before go? -- YES
in NewTest
San in fa
before go? -- NO
fb
in go? -- YES
</code></pre><p>&#x7ED3;&#x8BBA;&#x662F;: &#x53EA;&#x6709;&#x7B2C;&#x4E00;&#x7EA7;&#x51FD;&#x6570;, &#x5373;NewTest()&#x7684;&#x5165;&#x53C2;, &#x5728;&#x8FD9;&#x91CC;&#x662F;&#x4E2A;&#x51FD;&#x6570;, &#x662F;&#x5728;go&#x4E4B;&#x524D;&#x6267;&#x884C;, &#x5BF9;&#x5E94;&#x6253;&#x5370;<code>before go? -- YES</code>
&#x8981;&#x6CE8;&#x610F;, fb&#x7684;&#x5165;&#x53C2;&#x51FD;&#x6570;, &#x662F;&#x5728;go&#x91CC;&#x9762;&#x6267;&#x884C;&#x7684;. &#x6240;&#x4EE5;&#x8BF4;&#x53EA;&#x6709;&#x7B2C;&#x4E00;&#x7EA7;&#x7684;&#x51FD;&#x6570;&#x7684;&#x5165;&#x53C2;&#x624D;&#x4F1A;&#x5728;go&#x4E4B;&#x524D;&#x88AB;&#x8BA1;&#x7B97;</p>
<h1 id="go-get&#x548C;go-mod"><a name="go-get&#x548C;go-mod" class="anchor-navigation-ex-anchor" href="#go-get&#x548C;go-mod"><i class="fa fa-link" aria-hidden="true"></i></a>12. go get&#x548C;go mod</h1>
<p>&#x6D4B;&#x8BD5;&#x73AF;&#x5883; go1.16, go mod&#x6A21;&#x5F0F;</p>
<h2 id="go-get"><a name="go-get" class="anchor-navigation-ex-anchor" href="#go-get"><i class="fa fa-link" aria-hidden="true"></i></a>12.1. go get</h2>
<ul>
<li><code>go get -u</code>: &#x5347;&#x7EA7;&#x6240;&#x6709;&#x4F9D;&#x8D56;, &#x9012;&#x5F52;&#x5305;&#x62EC;&#x4F9D;&#x8D56;&#x7684;&#x4F9D;&#x8D56;</li>
<li><code>go get -u all</code>: &#x9996;&#x5148;<code>all</code>&#x4F1A;&#x88AB;&#x6269;&#x5C55;&#x6210;main&#x7684;&#x6240;&#x6709;&#x4F9D;&#x8D56;, &#x7136;&#x540E;&#x5347;&#x7EA7;&#x6240;&#x6709;&#x4F9D;&#x8D56;. <code>all</code>&#x662F;&#x5173;&#x952E;&#x8BCD;, &#x8BE6;&#x89C1;<code>go help packages</code></li>
</ul>
<h2 id="go-list"><a name="go-list" class="anchor-navigation-ex-anchor" href="#go-list"><i class="fa fa-link" aria-hidden="true"></i></a>12.2. go list</h2>
<p><code>go list -m all</code>&#x80FD;&#x5217;&#x51FA;&#x5F53;&#x524D;&#x7528;&#x7684;&#x6240;&#x6709;&#x7684;module(&#x5305;&#x62EC;&#x7248;&#x672C;&#x53F7;)
<code>go list all</code>&#x80FD;&#x5217;&#x51FA;&#x5F53;&#x524D;&#x7528;&#x7684;&#x6240;&#x6709;&#x7684;package(import&#x8DEF;&#x5F84;)</p>
<h2 id="go-mod-tidy"><a name="go-mod-tidy" class="anchor-navigation-ex-anchor" href="#go-mod-tidy"><i class="fa fa-link" aria-hidden="true"></i></a>12.3. go mod tidy</h2>
<p>&#x6E05;&#x7406;go.mod&#x7528;&#x7684;, &#x4F46;&#x4F3C;&#x4E4E;go.sum&#x8FD8;&#x662F;&#x6709;&#x5F88;&#x591A;&quot;&#x5386;&#x53F2;&quot;&#x7248;&#x672C;, &#x8FD9;&#x4E9B;&#x7248;&#x672C;&#x5E76;&#x6CA1;&#x6709;&#x4F7F;&#x7528;.</p>
<h2 id="&#x603B;&#x7ED3;"><a name="&#x603B;&#x7ED3;" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;"><i class="fa fa-link" aria-hidden="true"></i></a>12.4. &#x603B;&#x7ED3;</h2>
<ul>
<li><code>go list -m all</code>&#x67E5;&#x770B;main&#x7684;&#x6240;&#x6709;&#x9012;&#x5F52;&#x4F9D;&#x8D56;&#x7248;&#x672C;</li>
<li>go&#x7684;&#x7F16;&#x8BD1;&#x7CFB;&#x7EDF;&#x4E00;&#x822C;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x7248;&#x672C;&#x53F7;. &#x5F53;&#x51FA;&#x73B0;&#x4E0D;&#x540C;&#x7248;&#x672C;&#x4F9D;&#x8D56;&#x65F6;, &#x6BD4;&#x5982;A&#x4F9D;&#x8D56;(X@v0.0.2), &#x4F46;&#x67D0;&#x4E2A;&#x4F9D;&#x8D56;&#x6307;&#x5B9A;&#x4E86;&#x4E0D;&#x540C;&#x7684;&#x7248;&#x672C;&#x53F7;(&#x6BD4;&#x5982;X@v0.0.1), &#x6211;&#x731C;&#x6D4B;&#x6839;&#x636E;&#x517C;&#x5BB9;&#x6027;&#x516C;&#x7EA6;, go&#x7684;&#x7F16;&#x8BD1;&#x7CFB;&#x7EDF;&#x4F1A;&#x9009;&#x62E9;&#x65B0;&#x7684;&#x7248;&#x672C;&#x53F7;(v0.0.1)&#x6765;&#x7F16;&#x8BD1;.</li>
</ul>
<h1 id="go-clean-&#x6E05;&#x7406;&#x7F16;&#x8BD1;cache"><a name="go-clean-&#x6E05;&#x7406;&#x7F16;&#x8BD1;cache" class="anchor-navigation-ex-anchor" href="#go-clean-&#x6E05;&#x7406;&#x7F16;&#x8BD1;cache"><i class="fa fa-link" aria-hidden="true"></i></a>13. go clean &#x6E05;&#x7406;&#x7F16;&#x8BD1;cache</h1>
<pre class="language-"><code>go clean -cache -i -r

The -cache flag causes clean to remove the entire go build cache.
The -i flag causes clean to remove the corresponding installed archive or binary (what &apos;go install&apos; would create).

The -r flag causes clean to be applied recursively to all the dependencies of the packages named by the import paths.

The -n flag causes clean to print the remove commands it would execute, but not run them.

The -modcache flag causes clean to remove the entire module download cache, including unpacked source code of versioned dependencies.
</code></pre><h1 id="&#x53C8;&#x72AF;&#x4E86;&#x7ECF;&#x5178;&#x7684;goroutine&#x5F15;&#x7528;&#x95ED;&#x5305;&#x53D8;&#x91CF;&#x9519;&#x8BEF;"><a name="&#x53C8;&#x72AF;&#x4E86;&#x7ECF;&#x5178;&#x7684;goroutine&#x5F15;&#x7528;&#x95ED;&#x5305;&#x53D8;&#x91CF;&#x9519;&#x8BEF;" class="anchor-navigation-ex-anchor" href="#&#x53C8;&#x72AF;&#x4E86;&#x7ECF;&#x5178;&#x7684;goroutine&#x5F15;&#x7528;&#x95ED;&#x5305;&#x53D8;&#x91CF;&#x9519;&#x8BEF;"><i class="fa fa-link" aria-hidden="true"></i></a>14. &#x53C8;&#x72AF;&#x4E86;&#x7ECF;&#x5178;&#x7684;goroutine&#x5F15;&#x7528;&#x95ED;&#x5305;&#x53D8;&#x91CF;&#x9519;&#x8BEF;!!!!!</h1>
<p>&#x8FD9;&#x662F;&#x4E2A;&#x6BD4;&#x8F83;&#x9690;&#x853D;&#x7684;&#x5148;for&#x5728;switch&#x7684;&#x7ED3;&#x6784;, &#x5F88;&#x5BB9;&#x6613;&#x5FD8;&#x8BB0;go&#x5F15;&#x7528;&#x7684;&#x95ED;&#x5305;&#x53D8;&#x91CF;&#x4F1A;&#x5F02;&#x6B65;&#x7684;&#x53D8;&#x5316;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> vc <span class="token operator">:=</span> <span class="token keyword">range</span> vcs <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> cmd<span class="token punctuation">.</span>Cmd <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;restart&quot;</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> vc<span class="token punctuation">.</span>stat <span class="token operator">==</span> vmStatExited <span class="token punctuation">{</span>
            vm <span class="token operator">:=</span> vc<span class="token punctuation">.</span>VM
            vm<span class="token punctuation">.</span>In <span class="token operator">=</span> null<span class="token punctuation">{</span><span class="token punctuation">}</span>
            logFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>vc<span class="token punctuation">.</span>outputFile<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                greLogger<span class="token punctuation">.</span><span class="token function">Errorln</span><span class="token punctuation">(</span><span class="token function">errorHere</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
            vm<span class="token punctuation">.</span>Out <span class="token operator">=</span> logFile
            <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">defer</span> logFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                vc<span class="token punctuation">.</span>RestartedNum<span class="token operator">++</span>
                vc<span class="token punctuation">.</span><span class="token function">runVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            ids <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ids<span class="token punctuation">,</span> vc<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x73B0;&#x8C61;&#x662F;&#x7B2C;15&#x548C;16&#x884C;, &#x5728;10&#x6B21;for&#x5FAA;&#x73AF;&#x91CC;, &#x6BCF;&#x6B21;&#x90FD;&#x662F;&#x5BF9;&#x540C;&#x4E00;&#x4E2A;vc&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x64CD;&#x505A;.</p>
<h2 id="&#x539F;&#x56E0;"><a name="&#x539F;&#x56E0;" class="anchor-navigation-ex-anchor" href="#&#x539F;&#x56E0;"><i class="fa fa-link" aria-hidden="true"></i></a>14.1. &#x539F;&#x56E0;</h2>
<p>&#x8FD9;&#x91CC;&#x7B2C;15&#x548C;16&#x884C;&#x5F15;&#x7528;&#x7684;&#x662F;for&#x7684;&#x5FAA;&#x73AF;&#x53D8;&#x91CF;vc, &#x4F1A;&#x88AB;for&#x5FAA;&#x73AF;&#x66F4;&#x6539;.</p>
<h2 id="&#x89E3;&#x51B3;_1"><a name="&#x89E3;&#x51B3;_1" class="anchor-navigation-ex-anchor" href="#&#x89E3;&#x51B3;_1"><i class="fa fa-link" aria-hidden="true"></i></a>14.2. &#x89E3;&#x51B3;</h2>
<p>&#x53EA;&#x5728;&#x8FDB;&#x5165;goroutine&#x4E4B;&#x524D;, &#x91CD;&#x65B0;&#x5B9A;&#x4E49;&#x5C40;&#x90E8;&#x53D8;&#x91CF;<code>vc := vc</code>, &#x8FD9;&#x6837;goroutine&#x91CC;&#x9762;&#x7684;vc&#x5C31;&#x5F15;&#x7528;&#x7684;&#x662F;&#x5C40;&#x90E8;&#x53D8;&#x91CF;vc.&#x7B2C;13&#x884C;&#x5B9A;&#x4E49;&#x7684;vc&#x6BCF;&#x6B21;for&#x5FAA;&#x73AF;&#x90FD;&#x662F;&#x4E2A;&#x65B0;&#x7684;vc.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> vc <span class="token operator">:=</span> <span class="token keyword">range</span> vcs <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> cmd<span class="token punctuation">.</span>Cmd <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;restart&quot;</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> vc<span class="token punctuation">.</span>stat <span class="token operator">==</span> vmStatExited <span class="token punctuation">{</span>
            vm <span class="token operator">:=</span> vc<span class="token punctuation">.</span>VM
            vm<span class="token punctuation">.</span>In <span class="token operator">=</span> null<span class="token punctuation">{</span><span class="token punctuation">}</span>
            logFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>vc<span class="token punctuation">.</span>outputFile<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                greLogger<span class="token punctuation">.</span><span class="token function">Errorln</span><span class="token punctuation">(</span><span class="token function">errorHere</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
            vm<span class="token punctuation">.</span>Out <span class="token operator">=</span> logFile
            vc <span class="token operator">:=</span> vc
            <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">defer</span> logFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                vc<span class="token punctuation">.</span>RestartedNum<span class="token operator">++</span>
                vc<span class="token punctuation">.</span><span class="token function">runVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            ids <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ids<span class="token punctuation">,</span> vc<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x7406;&#x8BBA;&#x89E3;&#x91CA;"><a name="&#x7406;&#x8BBA;&#x89E3;&#x91CA;" class="anchor-navigation-ex-anchor" href="#&#x7406;&#x8BBA;&#x89E3;&#x91CA;"><i class="fa fa-link" aria-hidden="true"></i></a>14.3. &#x7406;&#x8BBA;&#x89E3;&#x91CA;</h2>
<p>&#x53C2;&#x8003;<a href="https://stackoverflow.com/questions/39208162/why-i-can-redefine-the-same-variable-multiple-times-in-a-for-loop-but-cant-outs" target="_blank">https://stackoverflow.com/questions/39208162/why-i-can-redefine-the-same-variable-multiple-times-in-a-for-loop-but-cant-outs</a>
&#x6709;&#x4EBA;&#x95EE;&#x4E3A;&#x4EC0;&#x4E48;&#x5728;&#x5FAA;&#x73AF;&#x91CC;&#x53EF;&#x4EE5;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        x <span class="token operator">:=</span> <span class="token number">77</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4F46;&#x81EA;&#x5DF1;&#x624B;&#x52A8;&#x5199;&#x5C31;&#x7F16;&#x8BD1;&#x4E0D;&#x8FC7;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a <span class="token operator">:=</span> <span class="token number">77</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    a <span class="token operator">:=</span> <span class="token number">77</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4E3A;&#x5565;?</p>
<p>&#x4E13;&#x5BB6;&#x7684;&#x89E3;&#x7B54;&#x662F;:
for&#x5FAA;&#x73AF;&#x6BCF;&#x6B21;&#x8FDB;&#x5165;&#x5FAA;&#x73AF;&#x4F53;&#x5927;&#x62EC;&#x53F7;&#x5757;<code>{}</code>, &#x90FD;&#x662F;&#x4E00;&#x4E2A;&#x65B0;&#x7684;scope</p>
<blockquote>
<p>The reason is each time you enter a block of curly braces <code>{}</code> you&apos;re creating a new nested scope. When you declare the variable <code>x</code> at the top of the loop it is a new variable and it goes out of scope at the end of the loop. When the program comes back around to the top of the loop again it&apos;s another new scope.</p>
</blockquote>
<p>&#x6709;&#x4EBA;&#x7ED9;&#x51FA;&#x4E86;&#x8BC1;&#x636E;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        x <span class="token operator">:=</span> <span class="token number">77</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>x<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>output</p>
<pre class="language-"><code>0x1040e0f8
0x1040e0fc
</code></pre><p>&#x53EF;&#x4EE5;&#x624B;&#x52A8;&#x52A0;<code>{}</code>&#x6765;&#x6DFB;&#x52A0;scope:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a <span class="token operator">:=</span> <span class="token number">77</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        a <span class="token operator">:=</span> <span class="token number">77</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>output</p>
<pre class="language-"><code>0x1040e0f8
0x1040e0fc
</code></pre><p>&#x4E0A;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x5C31;&#x53EF;&#x4EE5;&quot;&#x8FDE;&#x7EED;&quot;&#x5B9A;&#x4E49;<code>a</code>&#x4E24;&#x6B21;, &#x4F46;&#x7B2C;&#x4E8C;&#x6B21;&#x662F;&#x4E2A;&#x65B0;&#x7684;&#x53D8;&#x91CF;&#x5730;&#x5740;</p>
<h2 id="&#x603B;&#x7ED3;_1"><a name="&#x603B;&#x7ED3;_1" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;_1"><i class="fa fa-link" aria-hidden="true"></i></a>14.4. &#x603B;&#x7ED3;</h2>
<ul>
<li>for&#x5FAA;&#x73AF;&#x540C;&#x4E00;&#x884C;&#x7684;&#x53D8;&#x91CF;&#x4F5C;&#x7528;&#x57DF;&#x5728;for&#x91CC;&#x9762;&#x6CA1;&#x9519;, &#x4F46;&#x66F4;&#x50CF;&#x662F;&#x5728;&#x8FDB;&#x5165;&#x5FAA;&#x73AF;&#x524D;&#x5B9A;&#x4E49;&#x7684;&#x4E00;&#x6837;: for&#x5FAA;&#x73AF;&#x91CC;&#x9762;&#x5BF9;&#x5FAA;&#x73AF;&#x53D8;&#x91CF;&#x7684;&#x5F15;&#x7528;&#x90FD;&#x662F;&#x6307;&#x5411;&#x540C;&#x4E00;&#x4E2A;&#x4E1C;&#x897F;</li>
<li>for&#x5FAA;&#x73AF;&#x91CC;&#x9762;&#x7528;<code>var v int</code>&#x6216;<code>vc := vc</code>&#x5B9A;&#x4E49;&#x7684;&#x53D8;&#x91CF;, &#x5E76;&#x975E;&#x540C;&#x4E00;&#x4E2A;&#x5730;&#x5740;, &#x6BCF;&#x6B21;&#x5FAA;&#x73AF;&#x90FD;&#x662F;&quot;&#x4E34;&#x65F6;&quot;&#x751F;&#x6210;&#x7684;. &#x6240;&#x4EE5;&#x4E0A;&#x9762;&#x5728;&#x7B2C;13&#x884C;&#x7684;&#x4FEE;&#x6539;&#x53EF;&#x4EE5;&#x89E3;&#x51B3;&#x95EE;&#x9898;.</li>
<li>&#x4EE5;&#x540E;&#x68C0;&#x67E5;go&#x51FA;&#x53BB;&#x7684;&#x51FD;&#x6570;&#x662F;&#x5426;&#x6709;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;, <strong>&#x53EA;&#x68C0;&#x67E5;&#x5FAA;&#x73AF;&#x53D8;&#x91CF;</strong>&#x5C31;&#x884C;&#x4E86;</li>
</ul>
<h1 id="if-else-if-&#x5171;&#x4EAB;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;scope"><a name="if-else-if-&#x5171;&#x4EAB;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;scope" class="anchor-navigation-ex-anchor" href="#if-else-if-&#x5171;&#x4EAB;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;scope"><i class="fa fa-link" aria-hidden="true"></i></a>15. if else if &#x5171;&#x4EAB;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;scope</h1>
<p>&#x6BD4;&#x5982;</p>
<pre class="language-"><code>var msg interface{}
if ... {
} else if msg, ok := msg.(ExclusiveMessage); ok {
} else if msg, ok := msg.(Message); ok {
}
</code></pre><p>&#x7B2C;&#x4E8C;&#x4E2A;<code>else if</code>&#x4E2D;&#x7684;<code>msg.(Message)</code>&#x5B9E;&#x9645;&#x4E0A;&#x5F15;&#x7528;&#x7684;&#x662F;&#x7B2C;&#x4E00;&#x4E2A;<code>else if</code>&#x4E2D;&#x7684;<code>msg, ok</code>&#x53D8;&#x91CF;.</p>
<p>&#x89E3;&#x51B3;: &#x7ED9;if&#x7684;&#x53D8;&#x91CF;&#x53D6;&#x4E2A;&#x4E0D;&#x540C;&#x7684;&#x540D;&#x5B57;, &#x4E0D;&#x8981;&#x603B;&#x53EB;msg</p>
<h1 id="&#x7ECF;&#x5178;&#x7684;append&#x5730;&#x5740;&#x9519;&#x8BEF;"><a name="&#x7ECF;&#x5178;&#x7684;append&#x5730;&#x5740;&#x9519;&#x8BEF;" class="anchor-navigation-ex-anchor" href="#&#x7ECF;&#x5178;&#x7684;append&#x5730;&#x5740;&#x9519;&#x8BEF;"><i class="fa fa-link" aria-hidden="true"></i></a>16. &#x7ECF;&#x5178;&#x7684;append&#x5730;&#x5740;&#x9519;&#x8BEF;</h1>
<p>&#x80CC;&#x666F;&#x662F;&#x5728;vm&#x8FD0;&#x884C;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;, &#x8C03;&#x7528;<code>callers()</code>&#x4FDD;&#x5B58;&#x5F53;&#x4E0B;&#x7684;&#x8C03;&#x7528;&#x6808;&#x6240;&#x6709;&#x6808;&#x5E27;.</p>
<p>&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x6709;&#x9519;&#x8BEF;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">callers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>frames <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>frame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    curFrame <span class="token operator">:=</span> <span class="token operator">*</span>v<span class="token punctuation">.</span>curFrame
    curFrame<span class="token punctuation">.</span>ip <span class="token operator">=</span> v<span class="token punctuation">.</span>ip <span class="token operator">-</span> <span class="token number">1</span>
    frames <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>frames<span class="token punctuation">,</span> <span class="token operator">&amp;</span>curFrame<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> v<span class="token punctuation">.</span>framesIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>
        <span class="token comment">//&#x503C;&#x590D;&#x5236;, &#x907F;&#x514D;v.frames&#x53D8;&#x52A8;&#x9020;&#x6210;curFrame&#x53D8;&#x52A8;</span>
        <span class="token comment">//v.frames&#x662F;&#x4E2A;&#x6570;&#x7EC4;</span>
        curFrame <span class="token operator">=</span> v<span class="token punctuation">.</span>frames<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment">//&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x641E;&#x9519;&#x4E86;, &#x6BCF;&#x6B21;&#x90FD;append&#x540C;&#x4E00;&#x4E2A;&#x5730;&#x5740;!!! &#x8FD9;&#x4E2A;&#x56E0;&#x4E3A;curFrame&#x53D8;&#x91CF;&#x53EA;&#x6709;&#x4E00;&#x4E2A;.</span>
        frames <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>frames<span class="token punctuation">,</span> <span class="token operator">&amp;</span>curFrame<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> frames
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6539;&#x6B63;: &#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;, &#x8FD4;&#x56DE;&#x503C;&#x7684;slice, &#x800C;&#x4E0D;&#x662F;&#x6307;&#x9488;slice.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">callers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>frames <span class="token punctuation">[</span><span class="token punctuation">]</span>frame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    curFrame <span class="token operator">:=</span> <span class="token operator">*</span>v<span class="token punctuation">.</span>curFrame
    curFrame<span class="token punctuation">.</span>ip <span class="token operator">=</span> v<span class="token punctuation">.</span>ip <span class="token operator">-</span> <span class="token number">1</span>
    frames <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>frames<span class="token punctuation">,</span> curFrame<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> v<span class="token punctuation">.</span>framesIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>
        curFrame <span class="token operator">=</span> v<span class="token punctuation">.</span>frames<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        frames <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>frames<span class="token punctuation">,</span> curFrame<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> frames
<span class="token punctuation">}</span>
</code></pre>
<h1 id="&#x6253;&#x5370;&#x6307;&#x9488;slice"><a name="&#x6253;&#x5370;&#x6307;&#x9488;slice" class="anchor-navigation-ex-anchor" href="#&#x6253;&#x5370;&#x6307;&#x9488;slice"><i class="fa fa-link" aria-hidden="true"></i></a>17. &#x6253;&#x5370;&#x6307;&#x9488;slice</h1>
<p>&#x6211;&#x6709;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;, &#x73B0;&#x5728;&#x60F3;&#x6253;&#x5370;&#x4E00;&#x4E2A;<code>var wants []*want</code>&#x7684;slice</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> want <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    content   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    unordered <span class="token builtin">bool</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x76F4;&#x63A5;<code>fmt.Printf(&quot;%v&quot;, wants)</code>&#x4F1A;&#x8F93;&#x51FA;&#x4E00;&#x4E2A;slice, &#x4F46;&#x5143;&#x7D20;&#x90FD;&#x662F;&#x6307;&#x9488;. &#x600E;&#x4E48;&#x624D;&#x80FD;&#x6253;&#x5370;&#x8FD9;&#x4E9B;&#x6307;&#x9488;&#x7684;&#x503C;&#x5462;? 
&#x7528;<code>fmt.Printf(&quot;%+v&quot;, wants)</code>&#x548C;<code>fmt.Printf(&quot;%#v&quot;, wants)</code>&#x90FD;&#x4E0D;&#x884C;.</p>
<h2 id="&#x89E3;&#x51B3;-&#x7ED9;&#x7ED3;&#x6784;&#x4F53;&#x52A0;string&#x65B9;&#x6CD5;"><a name="&#x89E3;&#x51B3;-&#x7ED9;&#x7ED3;&#x6784;&#x4F53;&#x52A0;string&#x65B9;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#&#x89E3;&#x51B3;-&#x7ED9;&#x7ED3;&#x6784;&#x4F53;&#x52A0;string&#x65B9;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>17.1. &#x89E3;&#x51B3;: &#x7ED9;&#x7ED3;&#x6784;&#x4F53;&#x52A0;String&#x65B9;&#x6CD5;</h2>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>wt <span class="token operator">*</span>want<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> sb strings<span class="token punctuation">.</span>Builder
    <span class="token keyword">if</span> wt<span class="token punctuation">.</span>unordered <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot;//unordered output:\n&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot;//output:\n&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> str <span class="token operator">:=</span> <span class="token keyword">range</span> wt<span class="token punctuation">.</span>content <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>str <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x6837;<code>fmt.Printf(&quot;%v&quot;, wants)</code>&#x5C31;&#x53EF;&#x4EE5;&#x8F93;&#x51FA;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x7684;&#x5185;&#x5BB9;&#x4E86;. &#x5176;&#x539F;&#x7406;&#x662F;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x7C7B;&#x578B;&#x6709;&#x81EA;&#x5B9A;&#x4E49;<code>String()</code>&#x65B9;&#x6CD5;, Printf&#x4F1A;&#x8C03;&#x7528;&#x8FD9;&#x4E2A;&#x81EA;&#x5B9A;&#x4E49;<code>String()</code>&#x65B9;&#x6CD5;.
&#x6CE8;&#x610F;, &#x8FD9;&#x91CC;&#x8981;&#x7528;&#x5F15;&#x7528;&#x7684;receiver&#x65B9;&#x5F0F;, &#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x8981;&#x6253;&#x5370;&#x6307;&#x9488;.</p>
<h1 id="&#x5173;&#x4E8E;wait-group"><a name="&#x5173;&#x4E8E;wait-group" class="anchor-navigation-ex-anchor" href="#&#x5173;&#x4E8E;wait-group"><i class="fa fa-link" aria-hidden="true"></i></a>18. &#x5173;&#x4E8E;wait group</h1>
<p>sync&#x5305;&#x7684;wait group&#x7528;&#x4E8E;&#x4E3B;routine&#x7B49;&#x5F85;&#x6240;&#x6709;&#x5B50;routine&#x9000;&#x51FA;. &#x5728;&#x4F7F;&#x7528;&#x4E0A;&#x9700;&#x8981;&#x6CE8;&#x610F;:</p>
<ul>
<li><code>wg.Add(1)</code>&#x9700;&#x8981;&#x5728;go&#x4E4B;&#x524D;.</li>
<li><code>wg.Done()</code>&#x9700;&#x8981;&#x5728;go&#x91CC;&#x9762;.</li>
</ul>
<p>&#x5373;&#x8981;&#x4E25;&#x683C;&#x6309;&#x7167;&#x5B98;&#x7F51;&#x7684;&#x4F8B;&#x5B50;&#x6765;&#x5199;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
<span class="token keyword">var</span> urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
    <span class="token string">&quot;http://www.golang.org/&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;http://www.google.com/&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;http://www.somestupidname.com/&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
    <span class="token comment">// Increment the WaitGroup counter.</span>
    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">//&#x6CE8;&#x610F;&#x8FD9;&#x91CC;, &#x5728;go&#x4E4B;&#x524D;Add()</span>
    <span class="token comment">// Launch a goroutine to fetch the URL.</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Decrement the counter when the goroutine completes.</span>
        <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x6CE8;&#x610F;&#x8FD9;&#x91CC;, &#x5728;go&#x91CC;&#x9762;Done()</span>
        <span class="token comment">// Fetch the URL.</span>
        http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// Wait for all HTTP fetches to complete.</span>
wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x4E0B;&#x9762;&#x89E3;&#x91CA;&#x4E00;&#x4E0B;: </p>
<ul>
<li>&#x5728;go&#x4E4B;&#x524D;Add(), &#x662F;&#x8981;&#x8FD9;&#x4E2A;<code>wg.Add(1)</code> <strong>&#x4E00;&#x5B9A;</strong> &#x80FD;&#x88AB;&#x4E3B;routine&#x8C03;&#x7528;&#x5230;.</li>
<li>&#x5728;go&#x91CC;&#x9762;&#x8C03;<code>wg.Done()</code>&#x5F88;&#x597D;&#x7406;&#x89E3;, &#x8868;&#x793A;&#x4E8B;&#x60C5;&#x5728;&#x8FD9;&#x4E2A;&#x5F02;&#x6B65;&#x7684;goroutine&#x91CC;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;.</li>
</ul>
<h2 id="&#x53CD;&#x4F8B;"><a name="&#x53CD;&#x4F8B;" class="anchor-navigation-ex-anchor" href="#&#x53CD;&#x4F8B;"><i class="fa fa-link" aria-hidden="true"></i></a>18.1. &#x53CD;&#x4F8B;</h2>
<p>&#x901A;&#x5E38;&#x5927;&#x5BB6;&#x5BB9;&#x6613;&#x72AF;&#x7684;&#x9519;&#x8BEF;&#x662F;&#x628A;<code>wg.Add(1)</code>&#x653E;&#x5230;go&#x7684;&#x91CC;&#x9762;&#x53BB;&#x505A;. &#x6BD4;&#x5982;&#x4E0B;&#x9762;&#x4EE3;&#x7801;:
clone&#x4E00;&#x4E2A;VM, &#x7136;&#x540E;&#x5728;&#x65B0;&#x7684;goroutine&#x4E2D;run&#x8FD9;&#x4E2A;&#x65B0;&#x7684;VM. &#x7236;VM&#x9700;&#x8981;&#x8BB0;&#x5F55;&#x8FD9;&#x4E2A;&#x65B0;VM&#x5230;&#x5176;childVM map&#x91CC;&#x9762;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">govm</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newVM <span class="token operator">:=</span> vm<span class="token punctuation">.</span><span class="token function">ShallowClone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    gvm <span class="token operator">:=</span> <span class="token operator">&amp;</span>goroutineVM<span class="token punctuation">{</span>
        VM<span class="token punctuation">:</span>       newVM<span class="token punctuation">,</span>
        waitChan<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> ret<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    vm<span class="token punctuation">.</span><span class="token function">addChildVM</span><span class="token punctuation">(</span>gvm<span class="token punctuation">.</span>VM<span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//vm.addChildVM(gvm.VM) //&#x4E0D;&#x80FD;&#x5728;&#x91CC;&#x9762;Add()</span>
        val<span class="token punctuation">,</span> err <span class="token operator">:=</span> gvm<span class="token punctuation">.</span><span class="token function">RunCompiled</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
        gvm<span class="token punctuation">.</span>waitChan <span class="token operator">&lt;-</span> ret<span class="token punctuation">{</span>val<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
        vm<span class="token punctuation">.</span><span class="token function">delChildVM</span><span class="token punctuation">(</span>gvm<span class="token punctuation">.</span>VM<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">addChildVM</span><span class="token punctuation">(</span>cvm <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v<span class="token punctuation">.</span>childCtl<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    v<span class="token punctuation">.</span>childCtl<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    v<span class="token punctuation">.</span>childCtl<span class="token punctuation">.</span>vmMap<span class="token punctuation">[</span>cvm<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    v<span class="token punctuation">.</span>childCtl<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">delChildVM</span><span class="token punctuation">(</span>cvm <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v<span class="token punctuation">.</span>childCtl<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">delete</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>childCtl<span class="token punctuation">.</span>vmMap<span class="token punctuation">,</span> cvm<span class="token punctuation">)</span>
    v<span class="token punctuation">.</span>childCtl<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    v<span class="token punctuation">.</span>childCtl<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5982;&#x679C;&#x7B2C;8&#x884C;&#x653E;&#x5230;&#x7B2C;10&#x884C;&#x505A;, &#x597D;&#x50CF;&#x4E5F;&#x5728;&#x5E72;&#x6D3B;&#x4E4B;&#x524D;&#x52A0;&#x4E86;1, &#x5E72;&#x5B8C;&#x6D3B;&#x51CF;1.</p>
<p>&#x4F46;&#x5B9E;&#x9645;&#x60C5;&#x51B5;&#x662F;, &#x6BD4;&#x5982;:
&#x5728;&#x7236;VM Abort&#x65F6;, &#x9700;&#x8981;abort&#x5176;&#x6240;&#x6709;&#x7684;&#x5B50;VM.</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Abort aborts the execution of current VM and all its descendant VMs.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    atomic<span class="token punctuation">.</span><span class="token function">StoreInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v<span class="token punctuation">.</span>aborting<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">close</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>abortChan<span class="token punctuation">)</span> <span class="token comment">// broadcast to all receivers</span>
    v<span class="token punctuation">.</span>childCtl<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> cvm <span class="token operator">:=</span> <span class="token keyword">range</span> v<span class="token punctuation">.</span>childCtl<span class="token punctuation">.</span>vmMap <span class="token punctuation">{</span>
        cvm<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    v<span class="token punctuation">.</span>childCtl<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    v<span class="token punctuation">.</span>childCtl<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// waits for all child VMs to exit</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x73B0;&#x5728;&#x5047;&#x8BBE;&#x7236;&#x8FD9;&#x6837;&#x7684;&#x64CD;&#x505A;&#x5E8F;&#x5217;: &#x65B0;&#x8D77;3&#x4E2A;VM&#x7136;&#x540E;&#x9A6C;&#x4E0A;abort</p>
<pre class="language-"><code>govm(fn1)
govm(fn2)
govm(fn3)
abort()
</code></pre><p>3&#x4E2A;govm&#x662F;&#x5F02;&#x6B65;&#x5728;&#x8DD1;&#x7684;, &#x5F53;&#x7236;VM routine&#x8FD0;&#x884C;&#x5230;&#x7B2C;4&#x884C;<code>abort()</code>&#x7684;&#x65F6;&#x5019;, &#x5728;<code>abort()</code>&#x8DD1;&#x5230;&#x7B2C;10&#x884C;<code>v.childCtl.Wait()</code>&#x7B49;&#x5F85;&#x8FD9;&#x4E2A;wait group&#x7684;&#x65F6;&#x5019;, &#x4E0D;&#x80FD;&#x4FDD;&#x8BC1;&#x5B83;&#x7684;3&#x4E2A;&#x5B50;VM&#x90FD;&#x8DD1;&#x5230;&#x4E86;<code>Add(1)</code>, &#x56E0;&#x4E3A;&#x5B50;VM&#x7684;Add()&#x53EF;&#x80FD;&#x8FD8;&#x6CA1;&#x6709;&#x8FD0;&#x884C;.
&#x8FD9;&#x6837;&#x4F1A;&#x5BFC;&#x81F4;&#x5728;&#x7236;routine&#x7684;<code>Wait()</code>&#x5F97;&#x5230;wait&#x7684;&#x4E2A;&#x6570;&#x5C0F;&#x4E8E;&#x5B9E;&#x9645;&#x7684;VM routine&#x4E2A;&#x6570;, &#x867D;&#x7136;VM&#x8D77;&#x6765;&#x4EE5;&#x540E;&#x8FD9;&#x4E2A;wait&#x4E2A;&#x6570;&#x662F;&#x80FD;&#x591F;&#x52A0;&#x5230;3&#x7684;, &#x4F46;&#x5DF2;&#x7ECF;&#x8FC7;&#x4E86;&#x7236;VM routine &#x7684;wait&#x70B9;(<code>Abort()</code>&#x51FD;&#x6570;&#x7B2C;10&#x884C;), &#x6700;&#x540E;&#x7684;&#x7ED3;&#x679C;&#x5C31;&#x662F;&#x7236;VM routine&#x4E0D;&#x80FD;&#x628A;&#x8FD9;3&#x4E2A;VM routine&#x90FD;<code>abort()</code>&#x6389;.</p>
<h1 id="&#x4ECE;&#x6808;&#x4E0A;&#x83B7;&#x53D6;&#x53D8;&#x91CF;&#x5730;&#x5740;"><a name="&#x4ECE;&#x6808;&#x4E0A;&#x83B7;&#x53D6;&#x53D8;&#x91CF;&#x5730;&#x5740;" class="anchor-navigation-ex-anchor" href="#&#x4ECE;&#x6808;&#x4E0A;&#x83B7;&#x53D6;&#x53D8;&#x91CF;&#x5730;&#x5740;"><i class="fa fa-link" aria-hidden="true"></i></a>19. &#x4ECE;&#x6808;&#x4E0A;&#x83B7;&#x53D6;&#x53D8;&#x91CF;&#x5730;&#x5740;</h1>
<p>&#x6BD4;&#x5982;&#x6211;&#x8981;&#x4ECE;&#x4E0B;&#x9762;&#x7684;&#x6808;&#x4E2D;, &#x53D6;&#x4F20;&#x9012;&#x7ED9;<code>github.com/d5/tengo/v2.(*VM).run</code>&#x7684;&#x5730;&#x5740;</p>
<pre class="language-"><code class="lang-go">goroutine <span class="token number">1</span> <span class="token punctuation">[</span>running<span class="token punctuation">]</span><span class="token punctuation">:</span>
github<span class="token punctuation">.</span>com<span class="token operator">/</span>d5<span class="token operator">/</span>tengo<span class="token operator">/</span>v2<span class="token punctuation">.</span><span class="token function">builtinGo</span><span class="token punctuation">(</span><span class="token number">0xc0001360b0</span><span class="token punctuation">,</span> <span class="token number">0x1</span><span class="token punctuation">,</span> <span class="token number">0x1</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0xc0001360b0</span><span class="token punctuation">,</span> <span class="token number">0x1</span><span class="token punctuation">)</span>
        <span class="token operator">/</span>repo<span class="token operator">/</span>yingjieb<span class="token operator">/</span>github<span class="token operator">/</span>godevsig<span class="token operator">/</span>tengo<span class="token operator">/</span>builtins<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">409</span> <span class="token operator">+</span><span class="token number">0x69</span>
github<span class="token punctuation">.</span>com<span class="token operator">/</span>d5<span class="token operator">/</span>tengo<span class="token operator">/</span>v2<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>BuiltinFunction<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token number">0x7993b0</span><span class="token punctuation">,</span> <span class="token number">0xc0001360b0</span><span class="token punctuation">,</span> <span class="token number">0x1</span><span class="token punctuation">,</span> <span class="token number">0x1</span><span class="token punctuation">,</span> <span class="token number">0xc000178010</span><span class="token punctuation">,</span> <span class="token number">0x1</span><span class="token punctuation">,</span> <span class="token number">0x7ff</span><span class="token punctuation">,</span> <span class="token number">0x1</span><span class="token punctuation">)</span>
        <span class="token operator">/</span>repo<span class="token operator">/</span>yingjieb<span class="token operator">/</span>github<span class="token operator">/</span>godevsig<span class="token operator">/</span>tengo<span class="token operator">/</span>objects<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">349</span> <span class="token operator">+</span><span class="token number">0x48</span>
github<span class="token punctuation">.</span>com<span class="token operator">/</span>d5<span class="token operator">/</span>tengo<span class="token operator">/</span>v2<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>VM<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token number">0xc00013e0d0</span><span class="token punctuation">)</span>
        <span class="token operator">/</span>repo<span class="token operator">/</span>yingjieb<span class="token operator">/</span>github<span class="token operator">/</span>godevsig<span class="token operator">/</span>tengo<span class="token operator">/</span>vm<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">652</span> <span class="token operator">+</span><span class="token number">0x3323</span>
github<span class="token punctuation">.</span>com<span class="token operator">/</span>d5<span class="token operator">/</span>tengo<span class="token operator">/</span>v2<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>VM<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token number">0xc00013e0d0</span><span class="token punctuation">,</span> <span class="token number">0xc00013e0d0</span><span class="token punctuation">,</span> <span class="token number">0x400</span><span class="token punctuation">)</span>
        <span class="token operator">/</span>repo<span class="token operator">/</span>yingjieb<span class="token operator">/</span>github<span class="token operator">/</span>godevsig<span class="token operator">/</span>tengo<span class="token operator">/</span>vm<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">96</span> <span class="token operator">+</span><span class="token number">0xc7</span>
github<span class="token punctuation">.</span>com<span class="token operator">/</span>godevsig<span class="token operator">/</span>gshellos<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>shell<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runREPL</span><span class="token punctuation">(</span><span class="token number">0xc000099ec8</span><span class="token punctuation">)</span>
        <span class="token operator">/</span>repo<span class="token operator">/</span>yingjieb<span class="token operator">/</span>github<span class="token operator">/</span>godevsig<span class="token operator">/</span>gshellos<span class="token operator">/</span>gshellbuilder<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">101</span> <span class="token operator">+</span><span class="token number">0x825</span>
github<span class="token punctuation">.</span>com<span class="token operator">/</span>godevsig<span class="token operator">/</span>gshellos<span class="token punctuation">.</span><span class="token function">ShellMain</span><span class="token punctuation">(</span><span class="token number">0x786a60</span><span class="token punctuation">,</span> <span class="token number">0xc00005e750</span><span class="token punctuation">)</span>
        <span class="token operator">/</span>repo<span class="token operator">/</span>yingjieb<span class="token operator">/</span>github<span class="token operator">/</span>godevsig<span class="token operator">/</span>gshellos<span class="token operator">/</span>gshellbuilder<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">197</span> <span class="token operator">+</span><span class="token number">0x660</span>
main<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">/</span>repo<span class="token operator">/</span>yingjieb<span class="token operator">/</span>github<span class="token operator">/</span>godevsig<span class="token operator">/</span>gshellos<span class="token operator">/</span>cmd<span class="token operator">/</span>gshell<span class="token operator">/</span>gshell<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">12</span> <span class="token operator">+</span><span class="token number">0x26</span>
</code></pre>
<p>&#x4E0B;&#x9762;&#x662F;&#x65B9;&#x6CD5;
&#x9996;&#x5148;&#x5728;<code>vm.go</code>&#x91CC;&#x9762;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">var</span> stackIdentifierVM <span class="token builtin">string</span> <span class="token comment">//&#x5E94;&#x8BE5;&#x662F;github.com/d5/tengo/v2.(*VM).run</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stackIdentifierVM <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">FuncForPC</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>VM<span class="token punctuation">)</span><span class="token punctuation">.</span>run<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x7136;&#x540E;&#x5728;&#x9700;&#x8981;&#x7528;&#x5230;VM&#x5730;&#x5740;&#x7684;&#x51FD;&#x6570;&#x91CC;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">builtinGo</span><span class="token punctuation">(</span>args <span class="token operator">...</span>Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">var</span> buf <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    n <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">Stack</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">//&#x53D6;stack, &#x770B;&#x4ECE;&#x54EA;&#x91CC;&#x8C03;&#x7684;. &#x672C;&#x51FD;&#x6570;&#x79BB;(*VM).Run&#x4E0D;&#x8FDC;, 1024&#x7684;buf&#x591F;&#x4E86;</span>
    stk <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
    idx <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>stk<span class="token punctuation">,</span> stackIdentifierVM<span class="token punctuation">)</span> <span class="token comment">//&#x627E;&#x5230;stackIdentifierVM&#x5B57;&#x7B26;&#x4E32;, &#x4E5F;&#x5C31;&#x662F;&#x4E0A;&#x9762;&#x7684;&quot;github.com/d5/tengo/v2.(*VM).run&quot;</span>
    stk2 <span class="token operator">:=</span> stk<span class="token punctuation">[</span>idx<span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>stackIdentifierVM<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    idx <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>stk2<span class="token punctuation">,</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span>

    addr<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseUint</span><span class="token punctuation">(</span>stk2<span class="token punctuation">[</span><span class="token punctuation">:</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token comment">//&#x8F6C;&#x4E3A;int64</span>
    vm <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>VM<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//&#x7528;unsafe&#x5F3A;&#x5236;&#x8F6C;&#x4E3A;*VM</span>

    newVM <span class="token operator">:=</span> vm<span class="token punctuation">.</span><span class="token function">ShallowClone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x7136;&#x540E;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;vm&#x7684;&#x65B9;&#x6CD5;&#x4E86;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x53C2;&#x8003;&#x4EE3;&#x7801;"><a name="&#x53C2;&#x8003;&#x4EE3;&#x7801;" class="anchor-navigation-ex-anchor" href="#&#x53C2;&#x8003;&#x4EE3;&#x7801;"><i class="fa fa-link" aria-hidden="true"></i></a>19.1. &#x53C2;&#x8003;&#x4EE3;&#x7801;</h2>
<pre class="language-"><code class="lang-go"># in vm<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token keyword">var</span> stackIdentifierVM <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">FuncForPC</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>VM<span class="token punctuation">)</span><span class="token punctuation">.</span>run<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

# in group<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token keyword">func</span> <span class="token function">getVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>VM<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> buf <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    n <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">Stack</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    stk <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">// find &quot;github.com/d5/tengo/v2.(*VM).run&quot;</span>
    idx <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>stk<span class="token punctuation">,</span> stackIdentifierVM<span class="token punctuation">)</span>
    stk2 <span class="token operator">:=</span> stk<span class="token punctuation">[</span>idx<span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>stackIdentifierVM<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    idx <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>stk2<span class="token punctuation">,</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span>

    addr<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseUint</span><span class="token punctuation">(</span>stk2<span class="token punctuation">[</span><span class="token punctuation">:</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to get current VM from %s: %w\n&quot;</span><span class="token punctuation">,</span> stk<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    vm <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>VM<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> vm<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="&#x8FD0;&#x884C;&#x65F6;&#x83B7;&#x53D6;&#x51FD;&#x6570;&#x540D;"><a name="&#x8FD0;&#x884C;&#x65F6;&#x83B7;&#x53D6;&#x51FD;&#x6570;&#x540D;" class="anchor-navigation-ex-anchor" href="#&#x8FD0;&#x884C;&#x65F6;&#x83B7;&#x53D6;&#x51FD;&#x6570;&#x540D;"><i class="fa fa-link" aria-hidden="true"></i></a>20. &#x8FD0;&#x884C;&#x65F6;&#x83B7;&#x53D6;&#x51FD;&#x6570;&#x540D;</h1>
<p>&#x6BD4;&#x5982;&#x6211;&#x6709;&#x4E2A;&#x65B9;&#x6CD5;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x73B0;&#x5728;&#x60F3;&#x5728;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x91CC;, &#x6253;&#x5370;&#x8FD9;&#x4E2A;&#x4E0A;&#x9762;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x540D;&#x5B57;:</p>
<h2 id="&#x65B9;&#x6CD5;1"><a name="&#x65B9;&#x6CD5;1" class="anchor-navigation-ex-anchor" href="#&#x65B9;&#x6CD5;1"><i class="fa fa-link" aria-hidden="true"></i></a>20.1. &#x65B9;&#x6CD5;1</h2>
<pre class="language-"><code class="lang-go">fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">FuncForPC</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>VM<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//&#x7ED3;&#x679C;</span>
github<span class="token punctuation">.</span>com<span class="token operator">/</span>d5<span class="token operator">/</span>tengo<span class="token operator">/</span>v2<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>VM<span class="token punctuation">)</span><span class="token punctuation">.</span>run<span class="token operator">-</span>fm
</code></pre>
<h2 id="&#x65B9;&#x6CD5;2"><a name="&#x65B9;&#x6CD5;2" class="anchor-navigation-ex-anchor" href="#&#x65B9;&#x6CD5;2"><i class="fa fa-link" aria-hidden="true"></i></a>20.2. &#x65B9;&#x6CD5;2</h2>
<pre class="language-"><code class="lang-go">fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">FuncForPC</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>VM<span class="token punctuation">)</span><span class="token punctuation">.</span>run<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//&#x7ED3;&#x679C;</span>
github<span class="token punctuation">.</span>com<span class="token operator">/</span>d5<span class="token operator">/</span>tengo<span class="token operator">/</span>v2<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>VM<span class="token punctuation">)</span><span class="token punctuation">.</span>run
</code></pre>
<p>&#x6CE8;&#x610F;&#x65B9;&#x6CD5;2&#x548C;&#x65B9;&#x6CD5;1&#x7684;&#x533A;&#x522B;&#x53EA;&#x662F;&#x4F20;&#x5165;reflect.ValueOf&#x7684;&#x503C;&#x4E0D;&#x4E00;&#x6837;:</p>
<ul>
<li><code>(*VM)(nil).run</code>&#x7684;&#x610F;&#x601D;&#x662F;&#x5148;&#x628A;nil&#x5F3A;&#x8F6C;&#x6210;<code>(*VM)</code>, &#x7136;&#x540E;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x7684;run&#x65B9;&#x6CD5;&#x505A;&#x4E3A;&#x5165;&#x53C2;</li>
<li><code>(*VM).run</code>&#x76F4;&#x63A5;&#x5C31;&#x662F;&#x65B9;&#x6CD5;, &#x8BF4;&#x660E;&#x672C;&#x8D28;&#x4E0A;go&#x628A;(receiver).method&#x5F53;&#x6210;&#x4E00;&#x4E2A;func&#x5B9A;&#x4E49;.</li>
</ul>
<h1 id="continue&#x80FD;&#x8FD4;&#x56DE;n&#x5C42;for"><a name="continue&#x80FD;&#x8FD4;&#x56DE;n&#x5C42;for" class="anchor-navigation-ex-anchor" href="#continue&#x80FD;&#x8FD4;&#x56DE;n&#x5C42;for"><i class="fa fa-link" aria-hidden="true"></i></a>21. continue&#x80FD;&#x8FD4;&#x56DE;N&#x5C42;for</h1>
<p>continue&#x80FD;&#x591F;&#x6307;&#x5B9A;&#x8DF3;&#x8F6C;lable(&#x53EA;&#x80FD;&#x662F;for&#x7684;lable)</p>
<pre class="language-"><code class="lang-go">RowLoop<span class="token punctuation">:</span>
    <span class="token keyword">for</span> y<span class="token punctuation">,</span> row <span class="token operator">:=</span> <span class="token keyword">range</span> rows <span class="token punctuation">{</span>
        <span class="token keyword">for</span> x<span class="token punctuation">,</span> data <span class="token operator">:=</span> <span class="token keyword">range</span> row <span class="token punctuation">{</span>
            <span class="token keyword">if</span> data <span class="token operator">==</span> endOfRow <span class="token punctuation">{</span>
                <span class="token keyword">continue</span> RowLoop
            <span class="token punctuation">}</span>
            row<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> data <span class="token operator">+</span> <span class="token function">bias</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h1 id="interface&#x7684;&#x7406;&#x89E3;"><a name="interface&#x7684;&#x7406;&#x89E3;" class="anchor-navigation-ex-anchor" href="#interface&#x7684;&#x7406;&#x89E3;"><i class="fa fa-link" aria-hidden="true"></i></a>22. interface&#x7684;&#x7406;&#x89E3;</h1>
<h2 id="interface&#x662F;&#x9752;&#x51FA;&#x4E8E;&#x84DD;"><a name="interface&#x662F;&#x9752;&#x51FA;&#x4E8E;&#x84DD;" class="anchor-navigation-ex-anchor" href="#interface&#x662F;&#x9752;&#x51FA;&#x4E8E;&#x84DD;"><i class="fa fa-link" aria-hidden="true"></i></a>22.1. interface{}&#x662F;&#x9752;&#x51FA;&#x4E8E;&#x84DD;</h2>
<p>&#x4E00;&#x4E2A;&#x5178;&#x578B;&#x60C5;&#x51B5;&#x662F;, &#x5E95;&#x5C42;&#x5BF9;&#x8C61;&#x5B9E;&#x73B0;&#x4E86;&#x67D0;&#x4E9B;&#x65B9;&#x6CD5;&#x96C6;&#x5408;(&#x84DD;&#x65B9;&#x6CD5;&#x96C6;&#x5408;), &#x901A;&#x8FC7;wrapper&#x5C42;, &#x63D0;&#x4F9B;&#x7ED9;&#x7528;&#x6237;&quot;&#x6269;&#x5C55;&quot;&#x7248;&#x672C;&#x7684;&#x65B9;&#x6CD5;&#x96C6;&#x5408;(&#x9752;&#x65B9;&#x6CD5;&#x96C6;&#x5408;).
&#x4E3E;&#x4F8B;&#x5982;&#x4E0B;:
mangos&#x4EE3;&#x7801;&#x4E2D;, &#x5E95;&#x5C42;&#x901A;&#x9053;&#x7684;pipe&#x62BD;&#x8C61;&#x662F;transport.Pipe(TranPipe&#x7684;&#x522B;&#x540D;),&#x63D0;&#x4F9B;&#x5982;&#x4E0B;&#x65B9;&#x6CD5;(&#x84DD;&#x8272;&#x63A5;&#x53E3;): </p>
<pre class="language-"><code class="lang-go"><span class="token comment">// TranPipe behaves like a full-duplex message-oriented connection between two</span>
<span class="token comment">// peers.  Callers may call operations on a Pipe simultaneously from</span>
<span class="token comment">// different goroutines.  (These are different from net.Conn because they</span>
<span class="token comment">// provide message oriented semantics.)</span>
<span class="token comment">//</span>
<span class="token comment">// Pipe is only intended for use by transport implementors, and should</span>
<span class="token comment">// not be directly used in applications.</span>
<span class="token keyword">type</span> TranPipe <span class="token keyword">interface</span> <span class="token punctuation">{</span>

    <span class="token comment">// Send sends a complete message.  In the event of a partial send,</span>
    <span class="token comment">// the Pipe will be closed, and an error is returned.  For reasons</span>
    <span class="token comment">// of efficiency, we allow the message to be sent in a scatter/gather</span>
    <span class="token comment">// list.</span>
    <span class="token function">Send</span><span class="token punctuation">(</span><span class="token operator">*</span>Message<span class="token punctuation">)</span> <span class="token builtin">error</span>

    <span class="token comment">// Recv receives a complete message.  In the event that either a</span>
    <span class="token comment">// complete message could not be received, an error is returned</span>
    <span class="token comment">// to the caller and the Pipe is closed.</span>
    <span class="token comment">//</span>
    <span class="token comment">// To mitigate Denial-of-Service attacks, we limit the max message</span>
    <span class="token comment">// size to 1M.</span>
    <span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Message<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

    <span class="token comment">// Close closes the underlying transport.  Further operations on</span>
    <span class="token comment">// the Pipe will result in errors.  Note that messages that are</span>
    <span class="token comment">// queued in transport buffers may still be received by the remote</span>
    <span class="token comment">// peer.</span>
    <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

    <span class="token comment">// GetOption returns an arbitrary transport specific option on a</span>
    <span class="token comment">// pipe.  Options for pipes are read-only and specific to that</span>
    <span class="token comment">// particular connection. If the property doesn&apos;t exist, then</span>
    <span class="token comment">// ErrBadOption should be returned.</span>
    <span class="token function">GetOption</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5728;internal/core/socket.go&#x4E2D;, &#x7528;&#x4E00;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&quot;&#x5305;&#x88C5;&quot;&#x4E86;&#x5E95;&#x5C42;&#x7684;transport.Pipe</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// pipe wraps the Pipe data structure with the stuff we need to keep</span>
<span class="token comment">// for the core.  It implements the Pipe interface.</span>
<span class="token keyword">type</span> pipe <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    id        <span class="token builtin">uint32</span>
    p         transport<span class="token punctuation">.</span>Pipe <span class="token comment">//&#x8FD9;&#x4E2A;&#x5C31;&#x662F;transport.Pipe&#x7684;&#x63A5;&#x53E3;&#x5B9E;&#x4F8B;</span>
    l         <span class="token operator">*</span>listener
    d         <span class="token operator">*</span>dialer
    s         <span class="token operator">*</span>socket
    closeOnce sync<span class="token punctuation">.</span>Once
    data      <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// Protocol private</span>
    added     <span class="token builtin">bool</span>
    closing   <span class="token builtin">bool</span>
    lock      sync<span class="token punctuation">.</span>Mutex <span class="token comment">// held across calls to remPipe and addPipe</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;pipe&#x5B9E;&#x73B0;&#x4E86;protocol.ProtocolPipe&#x63A5;&#x53E3;(&#x9752;&#x8272;&#x63A5;&#x53E3;):</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// ProtocolPipe represents the handle that a Protocol implementation has</span>
<span class="token comment">// to the underlying stream transport.  It can be thought of as one side</span>
<span class="token comment">// of a TCP, IPC, or other type of connection.</span>
<span class="token keyword">type</span> ProtocolPipe <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment">// ID returns a unique 31-bit value associated with this.</span>
    <span class="token comment">// The value is unique for a given socket, at a given time.</span>
    <span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">uint32</span>

    <span class="token comment">// Close does what you think.</span>
    <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

    <span class="token comment">// SendMsg sends a message.  On success it returns nil. This is a</span>
    <span class="token comment">// blocking call.</span>
    <span class="token function">SendMsg</span><span class="token punctuation">(</span><span class="token operator">*</span>Message<span class="token punctuation">)</span> <span class="token builtin">error</span>

    <span class="token comment">// RecvMsg receives a message.  It blocks until the message is</span>
    <span class="token comment">// received.  On error, the pipe is closed and nil is returned.</span>
    <span class="token function">RecvMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Message

    <span class="token comment">// SetPrivate is used to set protocol private data.</span>
    <span class="token function">SetPrivate</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// GetPrivate returns the previously stored protocol private data.</span>
    <span class="token function">GetPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x901A;&#x8FC7;&quot;&#x9752;&#x51FA;&#x4E8E;&#x84DD;&quot;&#x7684;&#x64CD;&#x4F5C;, <code>pipe struct</code>&#x5BF9;&#x5916;&#x5C4F;&#x853D;&#x4E86;<code>transport.Pipe</code>&#x5B9E;&#x4F8B;, &#x4F46;&#x5BF9;&#x5916;&#x63D0;&#x4F9B;&#x4E86;&#x8BE5;&#x6709;&#x7684;&#x51FD;&#x6570;. &#x5373;&quot;&#x9752;&#x51FA;&#x4E8E;&#x84DD;&quot;&#x7684;&#x6838;&#x5FC3;&#x4E0D;&#x5728;&#x4E8E;&#x66B4;&#x9732;&#x84DD;&#x7684;&#x5B9E;&#x4F8B;, &#x800C;&#x662F;&#x63D0;&#x4F9B;&#x9752;&#x7684;&#x529F;&#x80FD;&#x51FD;&#x6570;.
&#x6240;&#x4EE5;interface{}&#x7684;&#x672C;&#x8D28;&#x662F;&#x63D0;&#x4F9B;&#x65B9;&#x6CD5;&#x89C4;&#x7EA6;, &#x540C;&#x65F6;&#x9690;&#x85CF;&#x4E86;&#x5B9E;&#x4F8B;&#x7EC6;&#x8282;. &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x9AD8;&#x5EA6;&#x63A5;&#x53E3;&#x5316;(&#x6216;&#x8005;&#x8BF4;&#x662F;&#x6807;&#x51C6;&#x5316;)&#x7684;&#x4E16;&#x754C;, &#x6BD4;&#x5982;&#x5728;&#x7EBA;&#x7EC7;&#x5382;&#x8BED;&#x5883;&#x4E0B;, &#x4F60;&#x63D0;&#x4F9B;&#x7684;&#x53EA;&#x6709;&#x7EBA;&#x7EC7;&#x5DE5;&#x7684;&#x64CD;&#x4F5C;&#x7684;&#x53CC;&#x624B;, &#x4F60;&#x7684;&#x4E2A;&#x6027;, &#x6BD4;&#x5982;&#x559C;&#x6B22;&#x738B;&#x83F2;&#x7684;&#x6B4C;, &#x6839;&#x672C;&#x6CA1;&#x5FC5;&#x8981;&#x4E5F;&#x4E0D;&#x503C;&#x5F97;&#x88AB;&#x5916;&#x4EBA;&#x77E5;&#x9053;.</p>
<p>&#x76F8;&#x5BF9;C++, go&#x7684;interface&#x6982;&#x5FF5;&#x6452;&#x5F03;&#x4E86;&#x5BF9;&#x8C61;&#x7684;&quot;&#x6570;&#x636E;&quot;&#x5C5E;&#x6027;, &#x53EA;&#x4FDD;&#x7559;&quot;&#x65B9;&#x6CD5;&quot;&#x89C4;&#x7EA6;. &#x5BF9;&#x8C61;&#x7684;&quot;&#x6570;&#x636E;&quot;&#x81EA;&#x5DF1;&#x6765;cook, &#x5916;&#x4EBA;&#x4E0D;&#x5173;&#x5FC3;; &#x5916;&#x4EBA;&#x53EA;&#x8981;&#x4F60;&#x63D0;&#x4F9B;&#x65B9;&#x6CD5;&quot;&#x670D;&#x52A1;&quot;&#x5C31;&#x884C;&#x4E86;.</p>
<p>&#x6CE8;: &#x8FD9;&#x91CC;&#x7684;<code>pipe struct</code>&#x662F;&#x5C0F;&#x5199;, &#x5176;&#x5185;&#x90E8;&#x6240;&#x6709;&#x7684;field&#x90FD;&#x662F;&#x5C0F;&#x5199;, &#x8FD9;&#x4E2A;pipe&#x4E0D;&#x80FD;&#x88AB;&#x5916;&#x90E8;&quot;&#x76F4;&#x63A5;&quot;&#x4F7F;&#x7528;. &#x4F46;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8C03;&#x7528;&#x6838;&#x5FC3;&#x5C42;&#x7684;&#x51FD;&#x6570;, <code>s.proto.AddPipe(p)</code>, &quot;&#x6CE8;&#x518C;&quot;&#x81EA;&#x5DF1;:
AddPipe&#x662F;protocol&#x5B9E;&#x4F8B;&#x7684;&#x89C4;&#x5B9A;&#x51FD;&#x6570;, &#x539F;&#x578B;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code class="lang-go"><span class="token function">AddPipe</span><span class="token punctuation">(</span>ProtocolPipe<span class="token punctuation">)</span> <span class="token builtin">error</span>
</code></pre>
<p>&#x4E0A;&#x9762;&#x7684;<code>p</code>&#x4EE3;&#x8868;&#x4E00;&#x4E2A;ProtocolPipe&#x5B9E;&#x4F8B;, &#x867D;&#x7136;&#x5168;&#x90E8;&#x90FD;&#x662F;&#x5C0F;&#x5199;, &#x4F46;&#x4E5F;&#x4E0D;&#x59A8;&#x788D;&#x80FD;&#x88AB;&#x5F53;&#x4F5C;ProtocolPipe&#x7684;interface&#x6765;&#x8D4B;&#x503C;. &#x5373;&#x8FD9;&#x91CC;&#x5C31;&#x628A;&#x4E00;&#x4E2A;&#x5B8C;&#x5168;&quot;&#x79C1;&#x6709;&quot;&#x7684;&#x5B9E;&#x4F8B;, &#x901A;&#x8FC7;&#x6EE1;&#x8DB3;ProtocolPipe&#x89C4;&#x5B9A;&#x7684;&#x65B9;&#x6CD5;, &#x5F53;&#x4F5C;ProtocolPipe&#x7684;&#x5B9E;&#x4F8B;&#x88AB;&quot;&#x5BFC;&#x51FA;&quot;&#x5230;&#x5916;&#x90E8;&#x4F7F;&#x7528;.</p>
<h2 id="interface&#x662F;&#x5E26;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;&#x96C6;&#x5408;"><a name="interface&#x662F;&#x5E26;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;&#x96C6;&#x5408;" class="anchor-navigation-ex-anchor" href="#interface&#x662F;&#x5E26;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;&#x96C6;&#x5408;"><i class="fa fa-link" aria-hidden="true"></i></a>22.2. interface{}&#x662F;&#x5E26;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;&#x96C6;&#x5408;</h2>
<p>&#x5E26;&#x65B9;&#x6CD5;&#x7684;interface{}&#x7684;&#x5178;&#x578B;&#x7684;&#x4F7F;&#x7528;&#x573A;&#x666F;&#x662F;: &#x8BE5;interface{}&#x53D8;&#x91CF;&#x662F;&#x5E26;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x51FD;&#x6570;&#x96C6;&#x5408;.
&#x6BD4;&#x5982;mangos&#x91CC;&#x9762;&#x521B;&#x5EFA;REQ&#x7684;socket:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">NewSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>protocol<span class="token punctuation">.</span>Socket<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">MakeSocket</span><span class="token punctuation">(</span><span class="token function">NewProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5176;&#x4E2D;<code>protocol.MakeSocket(proto Protocol) Socket</code>&#x7684;&#x5165;&#x53C2;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x89C4;&#x5B9A;&#x65B9;&#x6CD5;&#x7684;interface{}</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> ProtocolBase <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    ProtocolContext

    <span class="token comment">// Info returns the information describing this protocol.</span>
    <span class="token function">Info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> ProtocolInfo

    <span class="token comment">// XXX: Revisit these when we can use Pipe natively.</span>

    <span class="token comment">// AddPipe is called when a new Pipe is added to the socket.</span>
    <span class="token comment">// Typically this is as a result of connect or accept completing.</span>
    <span class="token comment">// The pipe ID will be unique for the socket at this time.</span>
    <span class="token comment">// The implementation must not call back into the socket, but it</span>
    <span class="token comment">// may reject the pipe by returning a non-nil result.</span>
    <span class="token function">AddPipe</span><span class="token punctuation">(</span>ProtocolPipe<span class="token punctuation">)</span> <span class="token builtin">error</span>

    <span class="token comment">// RemovePipe is called when a Pipe is removed from the socket.</span>
    <span class="token comment">// Typically this indicates a disconnected or closed connection.</span>
    <span class="token comment">// This is called exactly once, after the underlying transport pipe</span>
    <span class="token comment">// is closed.  The Pipe ID will still be valid.</span>
    <span class="token function">RemovePipe</span><span class="token punctuation">(</span>ProtocolPipe<span class="token punctuation">)</span>

    <span class="token comment">// OpenContext is a request to create a unique instance of the</span>
    <span class="token comment">// protocol state machine, allowing concurrent use of states on</span>
    <span class="token comment">// a given protocol socket.  Protocols that don&apos;t support this</span>
    <span class="token comment">// should return ErrProtoOp.</span>
    <span class="token function">OpenContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ProtocolContext<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6240;&#x4EE5;:</p>
<ul>
<li>&#x6838;&#x5FC3;&#x5C42;(&#x6BD4;&#x5982;&#x8FD9;&#x91CC;&#x7684;<code>protocol</code>&#x5C42;), &#x7ED9;&#x5176;&#x4E0B;&#x8F96;&#x7684;&#x6A21;&#x5757;&#x89C4;&#x5B9A;&#x65B9;&#x6CD5;&#x96C6;, &#x6EE1;&#x8DB3;&#x8FD9;&#x4E9B;&#x65B9;&#x6CD5;&#x96C6;&#x7684;&#x5B9E;&#x73B0;&#x5C31;&#x80FD;&#x4EAB;&#x53D7;&#x6838;&#x5FC3;&#x5C42;&#x63D0;&#x4F9B;&#x7684;&#x597D;&#x5904;(&#x6BD4;&#x5982;&#x5B50;&#x6A21;&#x5757;&#x4EAB;&#x53D7;&#x6838;&#x5FC3;&#x5C42;&#x7684;<code>MakeSocket()</code>&#x65B9;&#x6CD5;)</li>
<li>&#x6838;&#x5FC3;&#x5C42;&#x662F;&#x6846;&#x67B6;, &#x6846;&#x67B6;&#x5B9A;&#x597D;&#x89C4;&#x77E9;(&#x65B9;&#x6CD5;&#x96C6;)</li>
<li>&#x5B50;&#x6A21;&#x5757;&#x662F;&#x5B9E;&#x73B0;, &#x5B9E;&#x73B0;&#x4E86;&#x89C4;&#x5B9A;&#x7684;&#x65B9;&#x6CD5;&#x96C6;, &#x5C31;&#x80FD;&#x878D;&#x5165;&#x6846;&#x67B6;, &#x4EAB;&#x53D7;&#x6846;&#x67B6;.</li>
<li>&#x8FD9;&#x91CC;&#x7684;&#x4F8B;&#x5B50;&#x662F;, &#x5B50;&#x6A21;&#x5757;&#x8C03;&#x7528;&#x6838;&#x5FC3;&#x5C42;&#x7684;&#x51FD;&#x6570;<code>protocol.MakeSocket(&#x81EA;&#x5DF1;&#x7684;&#x63A5;&#x53E3;&#x5B9E;&#x4F8B;)</code>, &#x4F20;&#x5165;&#x81EA;&#x5DF1;&#x7684;interface{}&#x5B9E;&#x73B0;.</li>
</ul>
<p>&#x603B;&#x7ED3;:</p>
<ul>
<li>&#x6838;&#x5FC3;&#x5C42;&#x5B9A;&#x4E49;&#x63A5;&#x53E3;, &#x9488;&#x5BF9;&#x63A5;&#x53E3;&#x505A;&#x6846;&#x67B6;</li>
<li>&#x5B50;&#x6A21;&#x5757;&#x5B9E;&#x73B0;&#x63A5;&#x53E3;, &#x8C03;&#x7528;&#x6838;&#x5FC3;&#x5C42;&#x7684;&#x51FD;&#x6570;&#x6765;&#x5B8C;&#x6210;&#x4EFB;&#x52A1;.</li>
</ul>
<h1 id="runtimecaller&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x8FD0;&#x884C;&#x76EE;&#x5F55;"><a name="runtimecaller&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x8FD0;&#x884C;&#x76EE;&#x5F55;" class="anchor-navigation-ex-anchor" href="#runtimecaller&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x8FD0;&#x884C;&#x76EE;&#x5F55;"><i class="fa fa-link" aria-hidden="true"></i></a>23. runtime.Caller&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x8FD0;&#x884C;&#x76EE;&#x5F55;</h1>
<p><code>runtime.Caller(0)</code>&#x7684;&#x7B2C;&#x4E8C;&#x4E2A;&#x8FD4;&#x56DE;&#x503C;&#x662F;&#x6587;&#x4EF6;&#x540D;, &#x5BF9;&#x6587;&#x4EF6;&#x540D;&#x7684;&#x8DEF;&#x5F84;&#x64CD;&#x4F5C;&#x5F97;&#x5230;&#x5F53;&#x524D;&#x76EE;&#x5F55;, &#x5B9A;&#x4F4D;&#x6587;&#x4EF6;&#x7B49;&#x7B49;.</p>
<pre class="language-"><code class="lang-go"><span class="token boolean">_</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">Caller</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
topDir <span class="token operator">:=</span> f<span class="token punctuation">[</span><span class="token punctuation">:</span>strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">&quot;extension&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
covFile <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Base</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">TrimSuffix</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> filepath<span class="token punctuation">.</span><span class="token function">Ext</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
covFileArg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;-test.coverprofile=%sl2_%s.cov&quot;</span><span class="token punctuation">,</span> topDir<span class="token punctuation">,</span> covFile<span class="token punctuation">)</span>
</code></pre>
<h1 id="an-interface-holding-nil-value-is-not-nil"><a name="an-interface-holding-nil-value-is-not-nil" class="anchor-navigation-ex-anchor" href="#an-interface-holding-nil-value-is-not-nil"><i class="fa fa-link" aria-hidden="true"></i></a>24. An interface holding nil value is not nil</h1>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;a == nil is %t\n&quot;</span><span class="token punctuation">,</span> a <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> b <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">var</span> p <span class="token operator">*</span><span class="token builtin">int</span> <span class="token operator">=</span> <span class="token boolean">nil</span>
    b <span class="token operator">=</span> p
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;b == nil is %t\n&quot;</span><span class="token punctuation">,</span> b <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x7ED3;&#x679C;:</p>
<pre class="language-"><code>a == nil is true
b == nil is false
</code></pre><p>b&#x88AB;&#x8D4B;&#x503C;&#x4E3A;p, p&#x662F;nil. &#x4F46;b&#x4E0D;&#x662F;nil
&#x56E0;&#x4E3A;interface&#x4E3A;nil&#x7684;&#x6761;&#x4EF6;&#x662F;2&#x4E2A;: &#x503C;&#x548C;&#x7C7B;&#x578B;&#x90FD;&#x5FC5;&#x987B;&#x662F;nil
&quot;An interface equals nil only if both type and value are nil.&quot;</p>
<p>&#x8FD9;&#x91CC;b&#x7684;&#x503C;&#x662F;nil, &#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x662F;nil.</p>
<ul>
<li>&#x53EA;&#x58F0;&#x660E;&#x6CA1;&#x8D4B;&#x503C;&#x7684;&#x63A5;&#x53E3;&#x53D8;&#x91CF;&#x662F;nil</li>
<li>&#x663E;&#x5F0F;&#x8D4B;&#x503C;&#x4E3A;nil&#x7684;&#x63A5;&#x53E3;&#x53D8;&#x91CF;&#x662F;nil. &#x6CE8;&#x610F;&#x5FC5;&#x987B;&#x662F;<code>b = nil</code>&#x8FD9;&#x6837;&#x7684;&#x8D4B;&#x503C;&#x624D;&#x884C;.</li>
</ul>
<p>&#x8865;&#x5145;: nil&#x65E2;&#x662F;&#x503C;, &#x4E5F;&#x662F;&#x4E00;&#x79CD;&#x7C7B;&#x578B;.
&#x53E6;&#x5916;, &#x53EF;&#x4EE5;&#x5BF9;&#x63A5;&#x53E3;&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x65AD;&#x8A00;&#x6765;&#x67E5;&#x770B;&#x5176;&quot;&#x503C;&quot;&#x662F;&#x5426;&#x4E3A;nil</p>
<pre class="language-"><code class="lang-go">    <span class="token keyword">var</span> v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">var</span> a <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span>
    v <span class="token operator">=</span> a
    <span class="token comment">//&#x6B64;&#x65F6;v&#x5DF2;&#x7ECF;&#x4E0D;&#x662F;nil&#x4E86;, &#x56E0;&#x4E3A;v&#x7684;&#x7C7B;&#x578B;&#x53D8;&#x6210;&#x4E86;map[string]int</span>
    <span class="token comment">//&#x5BF9;v&#x65AD;&#x8A00;&#x6210;mv, &#x90A3;&#x4E48;mv&#x5C31;&#x53C8;&#x662F;nil&#x4E86;</span>
    mv <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> mv <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
</code></pre>
<h1 id="nethttp&#x5BFC;&#x81F4;&#x5305;&#x53D8;&#x5927;"><a name="nethttp&#x5BFC;&#x81F4;&#x5305;&#x53D8;&#x5927;" class="anchor-navigation-ex-anchor" href="#nethttp&#x5BFC;&#x81F4;&#x5305;&#x53D8;&#x5927;"><i class="fa fa-link" aria-hidden="true"></i></a>25. net/http&#x5BFC;&#x81F4;&#x5305;&#x53D8;&#x5927;</h1>
<h2 id="&#x73B0;&#x8C61;_1"><a name="&#x73B0;&#x8C61;_1" class="anchor-navigation-ex-anchor" href="#&#x73B0;&#x8C61;_1"><i class="fa fa-link" aria-hidden="true"></i></a>25.1. &#x73B0;&#x8C61;</h2>
<p>&#x6211;import&#x4E86;&#x7F51;&#x4E0A;&#x7684;&#x5E93;, abs. &#x7F16;&#x8BD1;&#x540E;&#x53D1;&#x73B0;&#x6709;8.2M. &#x7528;<code>nm</code>&#x547D;&#x4EE4;&#x67E5;&#x770B;&#x4E8C;&#x8FDB;&#x5236;, &#x53D1;&#x73B0;&#x6709;&#x5F88;&#x591A;net/http&#x7684;&#x7B26;&#x53F7;.
&#x4F46;&#x5B9E;&#x9645;&#x4E0A;, &#x6211;&#x5E76;&#x6CA1;&#x6709;<strong>&#x663E;&#x5F0F;</strong>&#x5F15;&#x7528;&#x4EFB;&#x4F55;&#x7F51;&#x7EDC;&#x76F8;&#x5173;&#x7684;&#x51FD;&#x6570;. </p>
<h2 id="&#x89E3;&#x51B3;_2"><a name="&#x89E3;&#x51B3;_2" class="anchor-navigation-ex-anchor" href="#&#x89E3;&#x51B3;_2"><i class="fa fa-link" aria-hidden="true"></i></a>25.2. &#x89E3;&#x51B3;</h2>
<p>&#x8C03;&#x67E5;&#x53D1;&#x73B0;, abs&#x5185;&#x90E8;&#x7684;&#x4E00;&#x4E2A;package <code>util</code>&#x4E2D;, &#x6709;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x5F15;&#x7528;&#x4E86;<code>&quot;net/http&quot;</code>&#x5305;, &#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x4ECE;http<code>Download()</code>.
&#x5220;&#x9664;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;, &#x4E8C;&#x8FDB;&#x5236;&#x7684;size&#x76F4;&#x63A5;&#x51CF;&#x5C0F;&#x4E86;<strong>4M</strong>! &#x7F16;&#x8BD1;&#x65F6;&#x95F4;&#x4E5F;&#x7F29;&#x77ED;&#x4E86;&#x5F88;&#x591A;. &#x800C;&#x4E14;&#x8FD8;&#x4E0D;&#x5F71;&#x54CD;&#x529F;&#x80FD;</p>
<h2 id="&#x539F;&#x56E0;_1"><a name="&#x539F;&#x56E0;_1" class="anchor-navigation-ex-anchor" href="#&#x539F;&#x56E0;_1"><i class="fa fa-link" aria-hidden="true"></i></a>25.3. &#x539F;&#x56E0;</h2>
<p>&#x90A3;&#x4E3A;&#x4EC0;&#x4E48;&#x4EE3;&#x7801;&#x91CC;&#x6CA1;&#x6709;&#x5B9E;&#x9645;&#x5F15;&#x7528;<code>Download()</code>&#x51FD;&#x6570;, <code>net/http</code>&#x8FD8;&#x662F;&#x88AB;&#x7F16;&#x8BD1;&#x8FDB;&#x53BB;&#x4E86;&#x5462;? &#x662F;go&#x7684;&#x7F16;&#x8BD1;&#x5668;&#x4E0D;&#x591F;&#x806A;&#x660E;, &#x4E0D;&#x80FD;&#x628A;&quot;dead code&quot;&#x5220;&#x6389;&#x5417;?</p>
<p>-- &#x4E0D;&#x662F;. &#x867D;&#x7136;&#x5728;&#x7F16;&#x8BD1;&#x9636;&#x6BB5;, &#x662F;&#x6309;&#x7167;packge&#x6765;&#x7F16;&#x8BD1;&#x6210;.a&#x7684;, &#x4F46;&#x8FD9;&#x4E2A;&#x9636;&#x6BB5;&#x4E00;&#x822C;&#x90FD;&#x4F1A;&#x7F13;&#x5B58;&#x5230;&#x4E00;&#x4E2A;cache&#x76EE;&#x5F55;&#x4E0B;. &#x5728;&#x94FE;&#x63A5;&#x9636;&#x6BB5;, go&#x7684;&#x94FE;&#x63A5;&#x5668;&#x80FD;&#x505A;&#x5230;<strong>&#x53EA;&#x94FE;&#x63A5;</strong>&#x7528;&#x5F97;&#x5230;&#x7684;&#x7B26;&#x53F7;.</p>
<p>&#x4F46;&#x5373;&#x4F7F;&#x53EA;&#x662F;&#x7A7A;&#x5F15;&#x7528;<code>import _ &quot;net/http&quot;</code>, &#x4E8C;&#x8FDB;&#x5236;&#x7684;size&#x5C31;&#x4F1A;&#x589E;&#x52A0;4M, &#x8BF4;&#x660E;<code>net/http</code>&#x5185;&#x90E8;&#x4E00;&#x5B9A;&#x662F;&#x6709;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x6216;&#x8005;init()&#x51FD;&#x6570;, &#x5F15;&#x7528;&#x4E86;&#x81EA;&#x8EAB;&#x7684;&#x7B26;&#x53F7;. &#x8FD9;&#x4E2A;&#x5F15;&#x7528;&#x8FDB;&#x4E00;&#x6B65;&#x628A;&#x5168;&#x90E8;&#x7B26;&#x53F7;&#x90FD;&#x62D6;&#x5165;&#x6CE5;&#x6F6D;.</p>
<h2 id="&#x7ED3;&#x8BBA;_2"><a name="&#x7ED3;&#x8BBA;_2" class="anchor-navigation-ex-anchor" href="#&#x7ED3;&#x8BBA;_2"><i class="fa fa-link" aria-hidden="true"></i></a>25.4. &#x7ED3;&#x8BBA;</h2>
<ul>
<li>&#x4E0D;&#x8981;&#x5F15;&#x7528;<code>net/http</code>, &#x521D;&#x975E;&#x5FC5;&#x987B;&#x8981;http&#x529F;&#x80FD;.</li>
<li>&#x7528;nm&#x67E5;&#x770B;&#x4E8C;&#x8FDB;&#x5236;, &#x6392;&#x67E5;&#x662F;&#x5426;&#x6709;<code>net/http</code>&#x51FA;&#x73B0;.</li>
</ul>
<h1 id="options&#x521D;&#x59CB;&#x5316;"><a name="options&#x521D;&#x59CB;&#x5316;" class="anchor-navigation-ex-anchor" href="#options&#x521D;&#x59CB;&#x5316;"><i class="fa fa-link" aria-hidden="true"></i></a>26. Options&#x521D;&#x59CB;&#x5316;</h1>
<p><code>readlineutil.go</code>&#x662F;<code>github.com/chzyer/readline</code>&#x7684;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x5C01;&#x88C5;, &#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C;bufio.Scaner&#x7684;&#x8FED;&#x4EE3;&#x5668;.
&#x5B83;&#x7684;&#x521D;&#x59CB;&#x5316;&#x5F88;&#x6709;&#x8BBE;&#x8BA1;&#x611F;.
&#x8981;&#x70B9;&#x662F;</p>
<ul>
<li>&#x5165;&#x53C2;&#x662F;&#x53D8;&#x957F;&#x7684;</li>
<li>&#x5165;&#x53C2;&#x7684;&#x5F62;&#x5F0F;&#x662F;&#x51FD;&#x6570;</li>
<li>&#x53C2;&#x6570;&#x5728;&#x51FD;&#x6570;&#x91CC;&#x9762;&#x6267;&#x884C;</li>
</ul>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> Term <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    inst <span class="token operator">*</span>readline<span class="token punctuation">.</span>Instance
    io<span class="token punctuation">.</span>Writer
    line       <span class="token builtin">string</span>
    err        <span class="token builtin">error</span>
    prevPrompt <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Option <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>conf<span class="token punctuation">)</span>

<span class="token keyword">type</span> conf <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    rc <span class="token operator">*</span>readline<span class="token punctuation">.</span>Config
<span class="token punctuation">}</span>

<span class="token comment">//options&#x662F;&#x4E2A;&#x53D8;&#x957F;&#x7684;&#x5165;&#x53C2;, &#x683C;&#x5F0F;&#x662F;Option, &#x540E;&#x8005;&#x662F;&#x4E2A;&#x51FD;&#x6570;.</span>
<span class="token keyword">func</span> <span class="token function">NewTerm</span><span class="token punctuation">(</span>options <span class="token operator">...</span>Option<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Term<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> c conf
    c<span class="token punctuation">.</span>rc <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>readline<span class="token punctuation">.</span>Config<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>DisableAutoSaveHistory <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">//&#x6267;&#x884C;&#x5165;&#x53C2;&#x51FD;&#x6570;</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> o <span class="token operator">:=</span> <span class="token keyword">range</span> options <span class="token punctuation">{</span>
        <span class="token function">o</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    inst<span class="token punctuation">,</span> err <span class="token operator">:=</span> readline<span class="token punctuation">.</span><span class="token function">NewEx</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>rc<span class="token punctuation">)</span>
    t <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Term<span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>inst <span class="token operator">=</span> inst
    t<span class="token punctuation">.</span>Writer <span class="token operator">=</span> inst<span class="token punctuation">.</span><span class="token function">Stdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> t<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">//&#x8FD4;&#x56DE;&#x95ED;&#x5305;&#x51FD;&#x6570;</span>
<span class="token keyword">func</span> <span class="token function">WithHistoryFile</span><span class="token punctuation">(</span>filename <span class="token builtin">string</span><span class="token punctuation">)</span> Option <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>HistoryFile <span class="token operator">=</span> filename
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//&#x4F7F;&#x7528;:</span>
t <span class="token operator">:=</span> <span class="token function">NewTerm</span><span class="token punctuation">(</span><span class="token function">WithHistoryFile</span><span class="token punctuation">(</span><span class="token string">&quot;history&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x76F8;&#x5BF9;&#x4E8E;&#x666E;&#x901A;&#x7684;&#x8BBE;&#x8BA1;:</p>
<ol>
<li>&#x591A;&#x4E2A;&#x5165;&#x53C2;, &#x7C7B;&#x578B;&#x4E0D;&#x540C;, &#x663E;&#x5F0F;&#x6307;&#x5B9A;. &#x6BD4;&#x5982;<code>func NewTerm(history string, prompt string, search bool, &#x7B49;&#x7B49;) (*Term, error)</code> &#x8FD9;&#x6837;&#x505A;&#x7684;&#x7F3A;&#x70B9;&#x5F88;&#x591A;:<ul>
<li>&#x5982;&#x679C;&#x662F;&#x5BF9;&#x5916;&#x7684;API, &#x90A3;&#x8FD9;&#x4E2A;API&#x53EF;&#x80FD;&#x4F1A;&#x7ECF;&#x5E38;&#x53D8;&#x5316;; &#x6BD4;&#x5982;&#x589E;&#x52A0;&#x4E2A;&#x5C5E;&#x6027;, &#x8C03;&#x7528;&#x8005;&#x8981;&#x6539;&#x4EE3;&#x7801;&#x624D;&#x80FD;&#x7F16;&#x8FC7; -- &#x5373;&#x4F7F;&#x8001;&#x7528;&#x6237;&#x5E76;&#x4E0D;&#x5173;&#x5FC3;&#x8FD9;&#x4E2A;&#x65B0;&#x589E;&#x7684;&#x5C5E;&#x6027;, &#x4E5F;&#x4E0D;&#x51C6;&#x5907;&#x7528;&#x8FD9;&#x4E2A;&#x65B0;&#x529F;&#x80FD;.</li>
<li>&#x53C2;&#x6570;&#x901A;&#x8FC7;&#x4F4D;&#x7F6E;&#x4F20;&#x9012;, &#x591A;&#x4E86;&#x4E0D;&#x597D;&#x770B;</li>
</ul>
</li>
<li>&#x5165;&#x53C2;&#x662F;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;, &#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5B57;&#x6BB5;&#x8868;&#x8FF0;&#x4E0D;&#x540C;&#x7684;&#x5C5E;&#x6027;; &#x8FD9;&#x6837;&#x5165;&#x53C2;&#x4E0D;&#x9700;&#x8981;&#x53D8;&#x957F;, &#x9760;&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5B9A;&#x4E49;, &#x4EE5;&#x53CA;&#x4E0D;&#x540C;field&#x7684;&#x8D4B;&#x503C;&#x6765;&#x4F20;&#x5165;&quot;&#x53D8;&#x5316;&quot;<ul>
<li>&#x89E3;&#x51B3;&#x4E86;&#x4E0A;&#x9762;&#x65B9;&#x6848;&#x7684;&#x53D8;&#x5316;&#x95EE;&#x9898;, &#x90E8;&#x5206;&#x89E3;&#x51B3;&#x4E86;API&#x66F4;&#x6539;&#x7684;&#x95EE;&#x9898;. -- &#x6B64;&#x65F6;API&#x7684;&#x66F4;&#x6539;&#x53D8;&#x66F4;&#x4E3A;struct{}&#x7684;&#x66F4;&#x6539;, &#x90E8;&#x5206;&#x89E3;&#x51B3;&#x4E86;&#x8001;&#x7528;&#x6237;&#x5E0C;&#x671B;&#x4EE3;&#x7801;&#x4E0D;&#x53D8;&#x7684;&#x95EE;&#x9898; -- &#x90E8;&#x5206;&#x8D4B;&#x503C;&#x7684;struct&#x662F;&#x5141;&#x8BB8;&#x7684;. &#x4F46;&#x8C03;&#x7528;&#x8005;&#x8FD8;&#x662F;&#x8981;&#x5173;&#x5FC3;&#x8FD9;&#x4E2A;&#x5165;&#x53C2;&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5B9A;&#x4E49;</li>
<li>&#x7ED3;&#x6784;&#x4F53;&#x5B57;&#x6BB5;&#x7684;&#x8D4B;&#x503C;&#x6CA1;&#x6709;&#x660E;&#x663E;&#x7684;&#x4F4D;&#x7F6E;&#x611F;, key: value&#x7684;&#x5F62;&#x5F0F;&#x53EF;&#x8BFB;&#x6027;&#x597D;&#x70B9;</li>
</ul>
</li>
<li>&#x5165;&#x53C2;&#x53D8;&#x957F;, &#x5168;&#x90E8;&#x662F;interface{}<ul>
<li>&#x8DB3;&#x591F;&#x7075;&#x6D3B;, &#x5982;&#x679C;&#x5B9E;&#x5728;&#x662F;&#x5916;&#x90E8;&#x9700;&#x6C42;&#x53D8;&#x5316;&#x5927;, &#x9700;&#x8981;&#x9002;&#x5E94;&#x53D8;&#x5316;</li>
<li>&#x7E41;&#x7410;: &#x9700;&#x8981;&#x5728;&#x5B9E;&#x73B0;&#x91CC;&#x4E0D;&#x65AD;&#x7684;&#x641E;&#x7C7B;&#x578B;&#x65AD;&#x8A00;</li>
<li>&#x5BF9;&#x4E8E;&#x672C;&#x4F8B;&#x7684;&#x573A;&#x666F;, &#x5E76;&#x4E0D;&#x9002;&#x5408;. &#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x9700;&#x8981;&#x8868;&#x660E;&#x76EE;&#x7684;.</li>
</ul>
</li>
<li>&#x672C;&#x4F8B;&#x8303;&#x5F0F;: <code>func NewTerm(options ...Option)</code><ul>
<li>&#x662F;&#x5BF9;&quot;&#x7ED3;&#x6784;&#x4F53;&quot;&#x5165;&#x53C2;&#x7684;&#x4E00;&#x79CD;&#x6269;&#x5C55;, Option&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x4E00;&#x4E2A;&#x51FD;&#x6570;, &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5BF9;&quot;cfg&#x5165;&#x53C2;&#x7ED3;&#x6784;&#x4F53;&quot;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x5B57;&#x6BB5;&#x8FDB;&#x884C;&#x914D;&#x7F6E;</li>
<li>&#x8FD9;&#x6837;&#x5B9A;&#x4E49;&#x7684;&#x5BF9;&#x5916;API&#x6709;&#x826F;&#x597D;&#x7684;&#x6269;&#x5C55;&#x6027;: &#x7528;&#x6237;&#x4E0D;&#x5FC5;&#x4FEE;&#x6539;&#x4EE3;&#x7801;; cfg&#x7ED3;&#x6784;&#x4F53;&#x5BF9;&#x7528;&#x6237;&#x4E0D;&#x53EF;&#x89C1;.</li>
</ul>
</li>
</ol>
<p>go-micro&#x4E2D;, &#x5C31;&#x5927;&#x91CF;&#x4F7F;&#x7528;&#x4E86;<code>Options</code>&#x8303;&#x5F0F;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Service is an interface for a micro service</span>
<span class="token keyword">type</span> Service <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token comment">// Init initialises options</span>
    <span class="token function">Init</span><span class="token punctuation">(</span><span class="token operator">...</span>Option<span class="token punctuation">)</span>
    <span class="token comment">// Options returns the current options</span>
    <span class="token function">Options</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Options
    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Option <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>Options<span class="token punctuation">)</span>
<span class="token keyword">type</span> Options <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    A <span class="token builtin">string</span>
    B <span class="token builtin">int</span>
    C <span class="token builtin">bool</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x603B;&#x7ED3;_2"><a name="&#x603B;&#x7ED3;_2" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;_2"><i class="fa fa-link" aria-hidden="true"></i></a>26.1. &#x603B;&#x7ED3;</h2>
<p>&#x8BBE;&#x8BA1;&#x4E00;&#x4E2A;&#x5BF9;&#x5916;&#x7684;API&#x65F6;, &#x6BD4;&#x8F83;&#x5178;&#x578B;&#x7684;&#x662F;NewXxx&#x7684;API, &#x6216;&#x8005;Init()&#x7684;API, &#x6700;&#x597D;&#x4E0D;&#x7528;<code>1</code>, &#x7B80;&#x5355;&#x70B9;&#x7684;&#x573A;&#x666F;&#x7528;<code>2</code>, &#x590D;&#x6742;&#x70B9;&#x7684;&#x6846;&#x67B6;&#x7528;<code>4</code>; &#x7279;&#x6B8A;&#x60C5;&#x51B5;&#x7528;<code>3</code></p>
<h1 id="&#x7A7A;&#x767D;import&#x4E0D;&#x4F1A;&#x589E;&#x52A0;binary-size"><a name="&#x7A7A;&#x767D;import&#x4E0D;&#x4F1A;&#x589E;&#x52A0;binary-size" class="anchor-navigation-ex-anchor" href="#&#x7A7A;&#x767D;import&#x4E0D;&#x4F1A;&#x589E;&#x52A0;binary-size"><i class="fa fa-link" aria-hidden="true"></i></a>27. &#x7A7A;&#x767D;import&#x4E0D;&#x4F1A;&#x589E;&#x52A0;binary size</h1>
<p>&#x6BD4;&#x5982;&#x4E00;&#x4E2A;empty.go, &#x672C;&#x6765;&#x4E0D;&#x9700;&#x8981;pidinfo&#x5305;.
&#x4F46;&#x8FD8;&#x662F;&#x5F15;&#x5165;&#x4E86;&#x8FD9;&#x4E2A;&#x5305;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">import</span> <span class="token boolean">_</span> <span class="token string">&quot;pidinfo&quot;</span>
</code></pre>
<p>&#x53EF;&#x4EE5;&#x7F16;&#x8BD1;, &#x7F16;&#x8BD1;&#x540E;&#x7684;binary&#x53EA;&#x5305;&#x62EC;&#x4E00;&#x70B9;&#x70B9;pidinfo&#x7684;&#x4EE3;&#x7801;. &#x6574;&#x4E2A;size&#x5E76;&#x6CA1;&#x6709;&#x53D8;&#x5316;. &#x8FD8;&#x662F;2M.
&#x5982;&#x679C;&#x8C03;&#x7528;&#x4E86;&#x6709;&#x9650;&#x51E0;&#x4E2A;pidinfo&#x91CC;&#x9762;&#x7684;&#x51FD;&#x6570;, &#x611F;&#x89C9;go&#x7684;&#x7F16;&#x8BD1;&#x5668;&#x4F1A;&#x81EA;&#x52A8;remove dead code.</p>
<h1 id="reflect&#x9AD8;&#x9636;&#x7528;&#x6CD5;"><a name="reflect&#x9AD8;&#x9636;&#x7528;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#reflect&#x9AD8;&#x9636;&#x7528;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>28. reflect&#x9AD8;&#x9636;&#x7528;&#x6CD5;</h1>
<h2 id="&#x52A8;&#x6001;&#x6784;&#x5EFA;&#x4E00;&#x4E2A;struct"><a name="&#x52A8;&#x6001;&#x6784;&#x5EFA;&#x4E00;&#x4E2A;struct" class="anchor-navigation-ex-anchor" href="#&#x52A8;&#x6001;&#x6784;&#x5EFA;&#x4E00;&#x4E2A;struct"><i class="fa fa-link" aria-hidden="true"></i></a>28.1. &#x52A8;&#x6001;&#x6784;&#x5EFA;&#x4E00;&#x4E2A;struct</h2>
<p>&#x7528;reflect&#x53EF;&#x4EE5;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&quot;&#x4EFB;&#x610F;&#x6CA1;&#x6709;&#x5B9A;&#x4E49;&#x8FC7;&quot;&#x7684;&#x7ED3;&#x6784;&#x4F53;
&#x6838;&#x5FC3;&#x662F;<code>func StructOf(fields []StructField) Type</code> API</p>
<pre class="language-"><code class="lang-go">typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">StructOf</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>StructField<span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span> <span class="token string">&quot;Height&quot;</span><span class="token punctuation">,</span>
        Type<span class="token punctuation">:</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Tag<span class="token punctuation">:</span>  <span class="token string">`json:&quot;height&quot;`</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span> <span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span>
        Type<span class="token punctuation">:</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Tag<span class="token punctuation">:</span>  <span class="token string">`json:&quot;age&quot;`</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>typ<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
v<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">)</span>
v<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetInt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
s <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">Addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

w <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;value: %+v\n&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;json:  %s&quot;</span><span class="token punctuation">,</span> w<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

r <span class="token operator">:=</span> bytes<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`{&quot;height&quot;:1.5,&quot;age&quot;:10}`</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;value: %+v\n&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
</code></pre>
<p>&#x7ED3;&#x679C;:</p>
<pre class="language-"><code>value: &amp;{Height:0.4 Age:2}
json:  {&quot;height&quot;:0.4,&quot;age&quot;:2}
value: &amp;{Height:1.5 Age:10}
</code></pre><h2 id="byname-api----&#x795E;&#x5947;&#x7684;&#x91CD;&#x540D;api"><a name="byname-api----&#x795E;&#x5947;&#x7684;&#x91CD;&#x540D;api" class="anchor-navigation-ex-anchor" href="#byname-api----&#x795E;&#x5947;&#x7684;&#x91CD;&#x540D;api"><i class="fa fa-link" aria-hidden="true"></i></a>28.2. byName API -- &#x795E;&#x5947;&#x7684;&#x91CD;&#x540D;API</h2>
<h3 id="reflectvalue&#x7684;methodbyname&#x65B9;&#x6CD5;"><a name="reflectvalue&#x7684;methodbyname&#x65B9;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#reflectvalue&#x7684;methodbyname&#x65B9;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>28.2.1. reflect.Value&#x7684;MethodByName&#x65B9;&#x6CD5;</h3>
<p>&#x4ECE;&#x4E00;&#x4E2A;&#x53CD;&#x5C04;&#x5BF9;&#x8C61;<code>reflect.Value</code>&#x53EF;&#x4EE5;&#x7528;&#x65B9;&#x6CD5;&#x540D;&#x67E5;&#x5230;&#x5B83;&#x7684;&#x65B9;&#x6CD5;&#x5BF9;&#x8C61;:
<code>func (v Value) MethodByName(name string) Value</code>
&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&quot;function value&quot;. &#x4F20;&#x53C2;&#x7ED9;&#x8FD4;&#x56DE;&#x7684;function&#x4E0D;&#x80FD;&#x5E26;receiver, &#x56E0;&#x4E3A;&#x5B83;&#x628A;Value v&#x5F53;&#x4F5C;&#x9ED8;&#x8BA4;&#x7684;receiver</p>
<blockquote>
<p>MethodByName returns a function value corresponding to the method of v with the given name. The arguments to a Call on the returned function should not include a receiver; the returned function will always use v as the receiver. It returns the zero Value if no method was found.</p>
</blockquote>
<p><a href="https://stackoverflow.com/questions/33006628/how-to-call-method-of-another-package-from-string-method-name-in-go" target="_blank">stack over flow</a>&#x6709;&#x4E2A;&#x8BA8;&#x8BBA;, &#x91CC;&#x9762;&#x7531;&#x793A;&#x4F8B;&#x4EE3;&#x7801;.</p>
<p>&#x8FD8;&#x6709;&#x4E2A;<a href="https://stackoverflow.com/questions/8103617/call-a-struct-and-its-method-by-name-in-go" target="_blank">&#x66F4;&#x7B80;&#x5355;&#x7684;</a></p>
<pre class="language-"><code class="lang-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;reflect&quot;</span>

<span class="token keyword">type</span> T <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>T<span class="token punctuation">)</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> t T
    reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">MethodByName</span><span class="token punctuation">(</span><span class="token string">&quot;Foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Value<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="reflecttype&#x7684;methodbyname&#x65B9;&#x6CD5;"><a name="reflecttype&#x7684;methodbyname&#x65B9;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#reflecttype&#x7684;methodbyname&#x65B9;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>28.2.2. reflect.Type&#x7684;MethodByName&#x65B9;&#x6CD5;</h3>
<p>reflect.Type&#x7684;&#x53CD;&#x5C04;&#x5BF9;&#x8C61;&#x4E5F;&#x6709;&#x4E2A;&#x540C;&#x540D;&#x7684;&#x65B9;&#x6CD5;
reflect.Type&#x662F;&#x4E2A;&#x63A5;&#x53E3;, &#x5B83;&#x5E95;&#x5C42;&#x7684;&#x5177;&#x4F53;&#x7C7B;&#x578B;&#x5FC5;&#x987B;&#x5B9E;&#x73B0;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x51FD;&#x6570;</p>
<pre class="language-"><code class="lang-go">    <span class="token comment">// MethodByName returns the method with that name in the type&apos;s</span>
    <span class="token comment">// method set and a boolean indicating if the method was found.</span>
    <span class="token comment">//</span>
    <span class="token comment">// For a non-interface type T or *T, the returned Method&apos;s Type and Func</span>
    <span class="token comment">// fields describe a function whose first argument is the receiver.</span>
    <span class="token comment">//</span>
    <span class="token comment">// For an interface type, the returned Method&apos;s Type field gives the</span>
    <span class="token comment">// method signature, without a receiver, and the Func field is nil.</span>
    <span class="token function">MethodByName</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Method<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x8FD4;&#x56DE;&#x7684;Method&#x662F;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> Method <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// Name is the method name.</span>
    <span class="token comment">// PkgPath is the package path that qualifies a lower case (unexported)</span>
    <span class="token comment">// method name. It is empty for upper case (exported) method names.</span>
    <span class="token comment">// The combination of PkgPath and Name uniquely identifies a method</span>
    <span class="token comment">// in a method set.</span>
    <span class="token comment">// See https://golang.org/ref/spec#Uniqueness_of_identifiers</span>
    Name    <span class="token builtin">string</span>
    PkgPath <span class="token builtin">string</span>

    Type  Type  <span class="token comment">// method type</span>
    Func  Value <span class="token comment">// func with receiver as first argument</span>
    Index <span class="token builtin">int</span>   <span class="token comment">// index for Type.Method</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x7528;&#x8FD4;&#x56DE;&#x7684;Method&#x600E;&#x4E48;&#x8C03;&#x7528;&#x51FD;&#x6570;???</p>
<h1 id="go&#x8C03;&#x7528;&#x5916;&#x90E8;&#x7A0B;&#x5E8F;"><a name="go&#x8C03;&#x7528;&#x5916;&#x90E8;&#x7A0B;&#x5E8F;" class="anchor-navigation-ex-anchor" href="#go&#x8C03;&#x7528;&#x5916;&#x90E8;&#x7A0B;&#x5E8F;"><i class="fa fa-link" aria-hidden="true"></i></a>29. go&#x8C03;&#x7528;&#x5916;&#x90E8;&#x7A0B;&#x5E8F;</h1>
<p>&#x8FD9;&#x91CC;&#x4EE5;go&#x89E3;&#x91CA;&#x5668;yaegi&#x4E3A;&#x4F8B;.
dotCmd&#x662F;<code>dot -Tdot -o ast.dot</code></p>
<pre class="language-"><code class="lang-go"><span class="token comment">// dotWriter returns an output stream to a dot(1) co-process where to write data in .dot format.</span>
<span class="token keyword">func</span> <span class="token function">dotWriter</span><span class="token punctuation">(</span>dotCmd <span class="token builtin">string</span><span class="token punctuation">)</span> io<span class="token punctuation">.</span>WriteCloser <span class="token punctuation">{</span>
    <span class="token keyword">if</span> dotCmd <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> nopCloser<span class="token punctuation">{</span>ioutil<span class="token punctuation">.</span>Discard<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    fields <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Fields</span><span class="token punctuation">(</span>dotCmd<span class="token punctuation">)</span>
    <span class="token comment">//&#x6784;&#x5EFA;cmd</span>
    cmd <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token comment">//cmd&#x6709;StdinPipe&#x51FD;&#x6570;, &#x8FD4;&#x56DE;</span>
    dotin<span class="token punctuation">,</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">StdinPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//&#x5F00;&#x59CB;&#x8FD9;&#x4E2A;cmd, &#x4F46;&#x8FD8;&#x6CA1;&#x6709;&#x8F93;&#x5165;</span>
    <span class="token keyword">if</span> err <span class="token operator">=</span> cmd<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//&#x8FD4;&#x56DE;&#x8F93;&#x5165;&#x7684;&#x53E5;&#x67C4;</span>
    <span class="token keyword">return</span> dotin
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5916;&#x90E8;&#x5BF9;<code>dotWriter</code>&#x8FD4;&#x56DE;&#x7684;<code>io.WriteCloser</code>&#x5199;&#x5C31;&#x53EF;&#x4EE5;pipe&#x5230;cmd&#x7684;&#x8F93;&#x5165;.</p>
<h1 id="texttemplate&#x4EE3;&#x7801;&#x751F;&#x6210;&#x4E3E;&#x4F8B;"><a name="texttemplate&#x4EE3;&#x7801;&#x751F;&#x6210;&#x4E3E;&#x4F8B;" class="anchor-navigation-ex-anchor" href="#texttemplate&#x4EE3;&#x7801;&#x751F;&#x6210;&#x4E3E;&#x4F8B;"><i class="fa fa-link" aria-hidden="true"></i></a>30. text/template&#x4EE3;&#x7801;&#x751F;&#x6210;&#x4E3E;&#x4F8B;</h1>
<pre class="language-"><code class="lang-go"><span class="token keyword">const</span> model <span class="token operator">=</span> <span class="token string">`// Code generated by &apos;yaegi extract {{.PkgName}}&apos;. DO NOT EDIT.

{{.License}}

{{if .BuildTags}}// +build {{.BuildTags}}{{end}}

package {{.Dest}}

import (
{{- range $key, $value := .Imports }}
    {{- if $value}}
    &quot;{{$key}}&quot;
    {{- end}}
{{- end}}
    &quot;{{.PkgName}}&quot;
    &quot;reflect&quot;
)

func init() {
    Symbols[&quot;{{.PkgName}}&quot;] = map[string]reflect.Value{
        {{- if .Val}}
        // function, constant and variable definitions
        {{range $key, $value := .Val -}}
            {{- if $value.Addr -}}
                &quot;{{$key}}&quot;: reflect.ValueOf(&amp;{{$value.Name}}).Elem(),
            {{else -}}
                &quot;{{$key}}&quot;: reflect.ValueOf({{$value.Name}}),
            {{end -}}
        {{end}}

        {{- end}}
        {{- if .Typ}}
        // type definitions
        {{range $key, $value := .Typ -}}
            &quot;{{$key}}&quot;: reflect.ValueOf((*{{$value}})(nil)),
        {{end}}

        {{- end}}
        {{- if .Wrap}}
        // interface wrapper definitions
        {{range $key, $value := .Wrap -}}
            &quot;_{{$key}}&quot;: reflect.ValueOf((*{{$value.Name}})(nil)),
        {{end}}
        {{- end}}
    }
}
{{range $key, $value := .Wrap -}}
    // {{$value.Name}} is an interface wrapper for {{$key}} type
    type {{$value.Name}} struct {
        {{range $m := $value.Method -}}
        W{{$m.Name}} func{{$m.Param}} {{$m.Result}}
        {{end}}
    }
    {{range $m := $value.Method -}}
        func (W {{$value.Name}}) {{$m.Name}}{{$m.Param}} {{$m.Result}} { {{$m.Ret}} W.W{{$m.Name}}{{$m.Arg}} }
    {{end}}
{{end}}
`</span>
</code></pre>
<p>&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019;</p>
<pre class="language-"><code class="lang-go">    base <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;extract&quot;</span><span class="token punctuation">)</span>
    parse<span class="token punctuation">,</span> err <span class="token operator">:=</span> base<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>

    b <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
    data <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token string">&quot;Dest&quot;</span><span class="token punctuation">:</span>      e<span class="token punctuation">.</span>Dest<span class="token punctuation">,</span>
        <span class="token string">&quot;Imports&quot;</span><span class="token punctuation">:</span>   imports<span class="token punctuation">,</span> <span class="token comment">//&#x8FD9;&#x91CC;&#x7684;imports&#x662F;&#x4E2A;map</span>
        <span class="token string">&quot;PkgName&quot;</span><span class="token punctuation">:</span>   importPath<span class="token punctuation">,</span>
        <span class="token string">&quot;Val&quot;</span><span class="token punctuation">:</span>       val<span class="token punctuation">,</span>
        <span class="token string">&quot;Typ&quot;</span><span class="token punctuation">:</span>       typ<span class="token punctuation">,</span>
        <span class="token string">&quot;Wrap&quot;</span><span class="token punctuation">:</span>      wrap<span class="token punctuation">,</span>
        <span class="token string">&quot;BuildTags&quot;</span><span class="token punctuation">:</span> buildTags<span class="token punctuation">,</span>
        <span class="token string">&quot;License&quot;</span><span class="token punctuation">:</span>   e<span class="token punctuation">.</span>License<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    err <span class="token operator">=</span> parse<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> data<span class="token punctuation">)</span>

    <span class="token comment">// gofmt</span>
    source<span class="token punctuation">,</span> err <span class="token operator">:=</span> format<span class="token punctuation">.</span><span class="token function">Source</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">//&#x6B64;&#x65F6;source&#x91CC;&#x9762;&#x5C31;&#x662F;&#x66FF;&#x6362;&#x540E;&#x7684;&#x4EE3;&#x7801;</span>
</code></pre>
<p>&#x6CE8;:</p>
<ul>
<li>&#x66FF;&#x6362;&#x7684;&#x53D8;&#x91CF;&#x662F;&#x901A;&#x8FC7;<code>map[string]interface{}</code>&#x4F20;&#x5165;&#x7684;, &#x5176;&#x503C;&#x4E3A;&#x4E07;&#x80FD;interface</li>
<li>&#x503C;&#x53EF;&#x4EE5;&#x662F;map, &#x6BD4;&#x5982;&#x4E0A;&#x9762;&#x7684;imports; &#x5BF9;&#x5E94;&#x6A21;&#x677F;&#x91CC;&#x9762;&#x7528;range&#x6765;&#x904D;&#x5386;.</li>
</ul>
<h1 id="map&#x7684;&#x91CD;&#x8981;&#x5C5E;&#x6027;-unaddressable"><a name="map&#x7684;&#x91CD;&#x8981;&#x5C5E;&#x6027;-unaddressable" class="anchor-navigation-ex-anchor" href="#map&#x7684;&#x91CD;&#x8981;&#x5C5E;&#x6027;-unaddressable"><i class="fa fa-link" aria-hidden="true"></i></a>31. map&#x7684;&#x91CD;&#x8981;&#x5C5E;&#x6027; unaddressable</h1>
<p>&#x8FD9;&#x6837;&#x64CD;&#x4F5C;map&#x662F;&#x53EF;&#x4EE5;&#x7684;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

users <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span>User<span class="token punctuation">)</span>

users<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> User<span class="token punctuation">{</span><span class="token string">&quot;Steve&quot;</span><span class="token punctuation">}</span>
</code></pre>
<p>&#x4F46;&#x4E0B;&#x9762;&#x8FD9;&#x6837;&#x4E0D;&#x884C;:</p>
<pre class="language-"><code class="lang-go">users<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Mark&quot;</span>
<span class="token comment">//cannot assign to struct field users[5].name in map</span>
</code></pre>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x5462;? <a href="https://stackoverflow.com/questions/17438253/accessing-struct-fields-inside-a-map-value-without-copying" target="_blank">&#x95EE;&#x7B54;&#x5728;&#x8FD9;&#x91CC;</a>
&#x7B54;: map&#x7684;value&#x662F;&#x4E0D;&#x80FD;&#x88AB;&#x5BFB;&#x5740;&#x7684;(by&#x8BED;&#x8A00;&#x8BBE;&#x8BA1;), &#x867D;&#x7136;<code>users[5]</code>&#x770B;&#x8D77;&#x6765;&#x50CF;&#x662F;&#x5BFB;&#x627E;&#x5230;&#x4E86;&#x4E00;&#x4E2A;<code>User</code>, &#x4F46;&#x5728;go&#x91CC;&#x9762;&#x6240;&#x6709;&#x7684;&#x4F20;&#x9012;&#x90FD;&#x662F;&#x503C;&#x4F20;&#x9012;, <code>users[5].name = &quot;Mark&quot;</code>&#x4E5F;&#x9690;&#x542B;&#x53D1;&#x751F;&#x4E86;&#x503C;&#x62F7;&#x8D1D;: &#x4ECE;&#x539F;User&#x62F7;&#x5230;&#x4E86;&#x4E34;&#x65F6;&#x7684;&#x4E0D;&#x53EF;&#x89C1;&#x7684;User. &#x5BF9;&#x540E;&#x8005;&#x7684;&#x8D4B;&#x503C;<code>= Mmark&quot;</code>&#x662F;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x610F;&#x4E49;&#x7684;, &#x5373;&#x4F7F;&#x53EF;&#x4EE5;, &#x4E5F;&#x4E0D;&#x4F1A;&#x6539;&#x53D8;&#x539F;User&#x7684;name. &#x6240;&#x4EE5;&#x5728;&#x7F16;&#x8BD1;&#x9636;&#x6BB5;, &#x5C31;&#x4F1A;&#x63D0;&#x793A;&#x9519;&#x8BEF;.
&#x540C;&#x6837;&#x7684;, &#x8FD9;&#x6837;&#x4E5F;&#x4F1A;&#x62A5;&#x9519;:</p>
<pre class="language-"><code class="lang-go"><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Mark&quot;</span>

<span class="token comment">//cannot take the address of users[5]</span>
</code></pre>
<p>&#x90A3;&#x5982;&#x4F55;&#x66F4;&#x6539;value&#x5462;?</p>
<h2 id="&#x65B9;&#x6CD5;1-&#x6574;&#x4F53;&#x7ED9;map&#x8D4B;&#x503C;"><a name="&#x65B9;&#x6CD5;1-&#x6574;&#x4F53;&#x7ED9;map&#x8D4B;&#x503C;" class="anchor-navigation-ex-anchor" href="#&#x65B9;&#x6CD5;1-&#x6574;&#x4F53;&#x7ED9;map&#x8D4B;&#x503C;"><i class="fa fa-link" aria-hidden="true"></i></a>31.1. &#x65B9;&#x6CD5;1 &#x6574;&#x4F53;&#x7ED9;map&#x8D4B;&#x503C;</h2>
<pre class="language-"><code class="lang-go">t <span class="token operator">:=</span> users<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
t<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Mark&quot;</span>
users<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> t
</code></pre>
<p>&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x4E2D;, &#x9996;&#x5148;&#x663E;&#x5F0F;&#x7684;&#x503C;&#x62F7;&#x8D1D;&#x5230;t, &#x66F4;&#x6539;t, &#x518D;&#x628A;t&#x62F7;&#x8D1D;&#x8FDB;users&#x8FD9;&#x4E2A;map. &#x8FD9;&#x91CC;User&#x7C7B;&#x578B;&#x7684;&#x5B9E;&#x4F8B;&#x7684;&#x62F7;&#x8D1D;&#x90FD;&#x53D1;&#x751F;&#x4E86;2&#x6B21;.</p>
<h2 id="&#x65B9;&#x6CD5;2-&#x8BA9;value&#x7684;&#x7C7B;&#x578B;&#x4E3A;&#x6307;&#x9488;"><a name="&#x65B9;&#x6CD5;2-&#x8BA9;value&#x7684;&#x7C7B;&#x578B;&#x4E3A;&#x6307;&#x9488;" class="anchor-navigation-ex-anchor" href="#&#x65B9;&#x6CD5;2-&#x8BA9;value&#x7684;&#x7C7B;&#x578B;&#x4E3A;&#x6307;&#x9488;"><i class="fa fa-link" aria-hidden="true"></i></a>31.2. &#x65B9;&#x6CD5;2 &#x8BA9;value&#x7684;&#x7C7B;&#x578B;&#x4E3A;&#x6307;&#x9488;</h2>
<p><code>users := make(map[int]*User)</code>
&#x6B64;&#x65F6;<code>users[5]</code>&#x867D;&#x7136;&#x4E5F;&#x662F;&#x503C;&#x62F7;&#x8D1D;, &#x4F46;&#x62F7;&#x8D1D;&#x51FA;&#x6765;&#x7684;&#x6307;&#x9488;&#x8FD8;&#x662F;&#x6307;&#x5411;&#x5E95;&#x5C42;&#x6570;&#x636E;, &#x5C31;&#x53EF;&#x4EE5;&#x66F4;&#x6539;&#x4E86;.</p>
<h2 id="&#x7ED3;&#x8BBA;_3"><a name="&#x7ED3;&#x8BBA;_3" class="anchor-navigation-ex-anchor" href="#&#x7ED3;&#x8BBA;_3"><i class="fa fa-link" aria-hidden="true"></i></a>31.3. &#x7ED3;&#x8BBA;</h2>
<ul>
<li>map&#x7684;value&#x4E3A;&#x503C;&#x7C7B;&#x578B;&#x65F6;, &#x4E0D;&#x80FD;&#x88AB;&#x5BFB;&#x5740;; &#x6240;&#x4EE5;&#x4E0D;&#x80FD;&quot;&#x539F;&#x5730;&quot;&#x4FEE;&#x6539;</li>
<li>&#x53EF;&#x4EE5;&#x628A;map&#x7684;value&#x8BBE;&#x8BA1;&#x4E3A;&#x6307;&#x9488;&#x7C7B;&#x578B;, &#x652F;&#x6301;&quot;&#x539F;&#x5730;&quot;&#x4FEE;&#x6539;. &#x4F46;&#x8FD9;&#x6837;&#x4F1A;&#x7ED9;gc&#x5E26;&#x6765;&#x538B;&#x529B;</li>
<li>&#x4E5F;&#x53EF;&#x4EE5;&#x7528;copy-&#x6539;-copy&#x8FDB;map&#x7684;&#x65B9;&#x5F0F;&#x4FEE;&#x6539;</li>
</ul>
<h1 id="go&#x7684;&#x6811;&#x72B6;&#x8868;&#x8FBE;"><a name="go&#x7684;&#x6811;&#x72B6;&#x8868;&#x8FBE;" class="anchor-navigation-ex-anchor" href="#go&#x7684;&#x6811;&#x72B6;&#x8868;&#x8FBE;"><i class="fa fa-link" aria-hidden="true"></i></a>32. go&#x7684;&#x6811;&#x72B6;&#x8868;&#x8FBE;</h1>
<p>&#x5728;C&#x91CC;&#x9762;, &#x5B9A;&#x4E49;&#x4E00;&#x4E2A;node&#x65F6;, next&#x57DF;&#x5FC5;&#x987B;&#x662F;ListNode&#x7684;&#x6307;&#x9488;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">struct</span> ListNode<span class="token punctuation">{</span>
    <span class="token builtin">int</span> val<span class="token punctuation">;</span>
    ListNode<span class="token operator">*</span> next<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x5728;go&#x91CC;&#x9762;, &#x4E00;&#x4E2A;tree&#x7684;&#x6700;&#x7B80;&#x5355;, &#x6700;&#x5929;&#x7136;&#x7684;&#x8868;&#x8FBE;&#x662F;map: map&#x7684;value&#x8FD8;&#x662F;&#x4E2A;tree
<code>type astTree map[string]astTree</code>
&#x6CE8;&#x610F;&#x5230;&#x8FD9;&#x91CC;, value&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x5B83;&#x5BF9;&#x81EA;&#x5DF1;&#x7684;&#x8868;&#x8FBE;: &#x81EA;&#x5DF1;&#x5305;&#x62EC;&#x81EA;&#x5DF1;(&#x800C;&#x4E0D;&#x662F;&#x6307;&#x9488;), &#x80FD;&#x884C;&#x5417;?
--&#x53EF;&#x4EE5;. &#x4E0B;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x8BF4;&#x660E;&#x8FD9;&#x4E48;&#x5199;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x95EE;&#x9898;</p>
<pre class="language-"><code class="lang-go">    <span class="token keyword">var</span> ast astTree <span class="token operator">=</span> <span class="token boolean">nil</span>
    ast <span class="token operator">=</span> astTree<span class="token punctuation">{</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">:</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">&quot;wolrd&quot;</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">&quot;111&quot;</span><span class="token punctuation">:</span><span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span>
</code></pre>
<p>&#x7ED3;&#x679C;&#x662F;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">map</span><span class="token punctuation">[</span>hello<span class="token punctuation">:</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token punctuation">]</span> wolrd<span class="token punctuation">:</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token number">111</span><span class="token punctuation">:</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<p>&#x89E3;&#x91CA;:
&#x5B9E;&#x9645;&#x4E0A;, map&#x662F;&#x4E2A;<strong>&#x56FA;&#x5B9A;</strong>size&#x7684;&#x7ED3;&#x6784;&#x4F53;, &#x6709;&#x7740;&#x7C7B;&#x4F3C;&#x6307;&#x9488;&#x7684;&#x6027;&#x8D28;, &#x6BD4;&#x5982;&#x4E0A;&#x9762;&#x4EE3;&#x7801;&#x4E2D;, <code>var ast astTree =  nil</code>, map&#x53EF;&#x4EE5;&#x8D4B;&#x503C;&#x4E3A;nil. &#x65E2;&#x7136;&#x662F;&#x56FA;&#x5B9A;size, &#x90A3;<code>astTree</code>&#x7684;value&#x5C31;&#x53EF;&#x4EE5;&#x662F;&#x81EA;&#x8EAB;<code>astTree</code></p>
<p>&#x4F46;&#x662F;, <code>type astTree map[string]astTree</code>&#x8FD9;&#x6837;&#x6811;&#x7684;&#x8868;&#x8FBE;, &#x8BED;&#x6CD5;&#x4E0A;&#x53EF;&#x4EE5;, &#x4F46;&#x6CA1;&#x6709;&#x5B9E;&#x9645;&#x610F;&#x4E49;: &#x8FD9;&#x4E2A;&#x6811;&#x7684;&#x8282;&#x70B9;&#x4E0A;, &#x53EA;&#x6709;&#x505A;&#x4E3A;string&#x7684;key&#x80FD;&#x5B58;&#x50A8;&#x6709;&#x610F;&#x4E49;&#x7684;&#x6570;&#x636E; -- &#x4E00;&#x4E2A;&#x6811;, &#x9664;&#x4E86;&#x7ED3;&#x6784;&#x8868;&#x8FBE;, &#x8FD8;&#x9700;&#x8981;&#x5B58;&#x50A8;data&#x624D;&#x80FD;&#x53D1;&#x6325;&#x5B9E;&#x9645;&#x7684;&#x4F5C;&#x7528;.</p>
<h2 id="&#x5B58;&#x50A8;data"><a name="&#x5B58;&#x50A8;data" class="anchor-navigation-ex-anchor" href="#&#x5B58;&#x50A8;data"><i class="fa fa-link" aria-hidden="true"></i></a>32.1. &#x5B58;&#x50A8;data</h2>
<p>&#x628A;ast&#x5B9A;&#x4E49;&#x6210;&#x4E00;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> astTree <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    data <span class="token builtin">int</span>
    ast <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>astTree
<span class="token punctuation">}</span>
</code></pre>
<p>&#x521D;&#x59CB;&#x5316;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, playground&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//var ast astTree = nil</span>
    ast <span class="token operator">:=</span> astTree<span class="token punctuation">{</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>astTree<span class="token punctuation">{</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">:</span>astTree<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;nihao&quot;</span><span class="token punctuation">:</span>astTree<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    ast<span class="token punctuation">.</span>ast<span class="token punctuation">[</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> astTree<span class="token punctuation">{</span><span class="token punctuation">}</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//&#x8F93;&#x51FA;</span>
Hello<span class="token punctuation">,</span> playground
<span class="token punctuation">{</span><span class="token number">23</span> <span class="token keyword">map</span><span class="token punctuation">[</span>hello<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token number">0</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span> nihao<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token number">0</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span> world<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token number">0</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre>
<p>&#x4F46;&#x8FD9;&#x6837;&#x6709;&#x70B9;&#x592A;&#x4E11;&#x4E86;. &#x800C;&#x4E14;&#x56E0;&#x4E3A;map&#x7684;value&#x5143;&#x7D20;&#x4E3A;&#x503C;&#x7C7B;&#x578B;&#x7684;undressable&#x56E0;&#x7D20;, &#x4E0D;&#x80FD;&#x7528;<code>ast.ast[&quot;world&quot;].data =100</code>&#x8FD9;&#x6837;&#x7684;&#x539F;&#x5730;&#x4FEE;&#x6539;&#x65B9;&#x6CD5;.</p>
<h3 id="&#x6539;&#x8FDB;&#x5B58;&#x50A8;"><a name="&#x6539;&#x8FDB;&#x5B58;&#x50A8;" class="anchor-navigation-ex-anchor" href="#&#x6539;&#x8FDB;&#x5B58;&#x50A8;"><i class="fa fa-link" aria-hidden="true"></i></a>32.1.1. &#x6539;&#x8FDB;&#x5B58;&#x50A8;</h3>
<p>&#x6309;&#x7167;map&#x7684;value&#x4E3A;&#x6307;&#x9488;&#x7C7B;&#x578B;&#x53EF;&#x4EE5;&#x5BFB;&#x5740;&#x7684;&#x7279;&#x70B9;, &#x6539;&#x8FDB;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> asTree <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    data <span class="token builtin">int</span>
    subTrees <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>asTree
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, playground&quot;</span><span class="token punctuation">)</span>
    ast <span class="token operator">:=</span> asTree<span class="token punctuation">{</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>asTree<span class="token punctuation">{</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">:</span><span class="token operator">&amp;</span>asTree<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;nihao&quot;</span><span class="token punctuation">:</span><span class="token operator">&amp;</span>asTree<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    ast<span class="token punctuation">.</span>subTrees<span class="token punctuation">[</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>asTree<span class="token punctuation">{</span><span class="token punctuation">}</span>
    ast<span class="token punctuation">.</span>subTrees<span class="token punctuation">[</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data <span class="token operator">=</span><span class="token number">100</span>
    ast<span class="token punctuation">.</span>subTrees<span class="token punctuation">[</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>subTrees <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>asTree<span class="token punctuation">{</span><span class="token string">&quot;shanghai&quot;</span><span class="token punctuation">:</span><span class="token operator">&amp;</span>asTree<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    ast<span class="token punctuation">.</span>subTrees<span class="token punctuation">[</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>subTrees<span class="token punctuation">[</span><span class="token string">&quot;shanghai&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>subTrees <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>asTree<span class="token punctuation">{</span><span class="token string">&quot;pudong&quot;</span><span class="token punctuation">:</span><span class="token operator">&amp;</span>asTree<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>subTrees<span class="token punctuation">[</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    ast<span class="token punctuation">.</span>subTrees<span class="token punctuation">[</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>subTrees<span class="token punctuation">[</span><span class="token string">&quot;shanghai&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token number">2013</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>subTrees<span class="token punctuation">[</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>subTrees<span class="token punctuation">[</span><span class="token string">&quot;shanghai&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//&#x8F93;&#x51FA;</span>
Hello<span class="token punctuation">,</span> playground
<span class="token punctuation">{</span><span class="token number">23</span> <span class="token keyword">map</span><span class="token punctuation">[</span>hello<span class="token punctuation">:</span><span class="token number">0xc000010200</span> nihao<span class="token punctuation">:</span><span class="token number">0xc000010210</span> world<span class="token punctuation">:</span><span class="token number">0xc000010220</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token operator">&amp;</span><span class="token punctuation">{</span><span class="token number">100</span> <span class="token keyword">map</span><span class="token punctuation">[</span>shanghai<span class="token punctuation">:</span><span class="token number">0xc000010230</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token operator">&amp;</span><span class="token punctuation">{</span><span class="token number">2013</span> <span class="token keyword">map</span><span class="token punctuation">[</span>pudong<span class="token punctuation">:</span><span class="token number">0xc000010240</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x5982;&#x679C;&#x7528;key&#x6765;&#x5B58;&#x50A8;data&#x4F1A;&#x600E;&#x6837;"><a name="&#x5982;&#x679C;&#x7528;key&#x6765;&#x5B58;&#x50A8;data&#x4F1A;&#x600E;&#x6837;" class="anchor-navigation-ex-anchor" href="#&#x5982;&#x679C;&#x7528;key&#x6765;&#x5B58;&#x50A8;data&#x4F1A;&#x600E;&#x6837;"><i class="fa fa-link" aria-hidden="true"></i></a>32.2. &#x5982;&#x679C;&#x7528;key&#x6765;&#x5B58;&#x50A8;data&#x4F1A;&#x600E;&#x6837;?</h2>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> useFullData <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    data1 <span class="token builtin">int</span>
    data2 <span class="token builtin">string</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> asTree <span class="token keyword">map</span><span class="token punctuation">[</span>useFullData<span class="token punctuation">]</span>asTree
</code></pre>
<p>&#x8FD9;&#x6837;&#x904D;&#x5386;&#x662F;&#x53EF;&#x4EE5;&#x7528;<code>k, v := range(asTree)</code>&#x6765;&#x904D;&#x5386;&#x7684;
&#x4F46;key&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x79CD;&#x7D22;&#x5F15;, key&#x5E94;&#x8BE5;&#x662F;&#x67D0;&#x79CD;&#x4E0D;&#x53D8;&#x7684;&#x4E1C;&#x897F;. key&#x7528;&#x6765;&#x67E5;&#x8BE2;&#x5E76;&#x5F97;&#x5230;&#x6570;&#x636E;. &#x7528;key&#x6765;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;&#x95EE;&#x9898;&#x662F;, &#x5982;&#x679C;&#x8981;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x4F1A;&#x53D8;&#x5316;, &#x90A3;key&#x5C31;&#x53D8;&#x4E86;.</p>
<h1 id="golang&#x7684;sigabrt"><a name="golang&#x7684;sigabrt" class="anchor-navigation-ex-anchor" href="#golang&#x7684;sigabrt"><i class="fa fa-link" aria-hidden="true"></i></a>33. golang&#x7684;SIGABRT</h1>
<p>&#x5728;&#x914D;&#x7F6E;&#x4E86;<code>GOTRACEBACK=crash</code>&#x7684;&#x60C5;&#x51B5;&#x4E0B;, go&#x7A0B;&#x5E8F;&#x4F1A;&#x5728;panic&#x7684;&#x65F6;&#x5019;, &#x6253;&#x5370;&#x6240;&#x6709;goroutine&#x7684;&#x8C03;&#x7528;&#x6808;(&#x8FD9;&#x4E2A;&#x548C;<code>GOTRACEBACK=system</code>&#x6548;&#x679C;&#x4E00;&#x6837;), &#x800C;&#x4E14;&#x8FD8;&#x4F1A;&#x53D1;SIGABRT(6&#x53F7;signal)&#x89E6;&#x53D1;core dump.
<code>man 7 signal</code>&#x8BF4;&#x7684;&#x5F88;&#x6E05;&#x695A;, &#x6BCF;&#x4E2A;signal&#x90FD;&#x6709;&#x9ED8;&#x8BA4;&#x7684;&#x6027;&#x60C5;(disposition):</p>
<pre class="language-"><code>       Signal     Value     Action   Comment
       &#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;
       SIGHUP        1       Term    Hangup detected on controlling terminal
                                     or death of controlling process
       SIGINT        2       Term    Interrupt from keyboard
       SIGQUIT       3       Core    Quit from keyboard
       SIGILL        4       Core    Illegal Instruction
       SIGABRT       6       Core    Abort signal from abort(3)
       SIGFPE        8       Core    Floating-point exception
       SIGKILL       9       Term    Kill signal
       SIGSEGV      11       Core    Invalid memory reference
       SIGPIPE      13       Term    Broken pipe: write to pipe with no
                                     readers; see pipe(7)
       SIGALRM      14       Term    Timer signal from alarm(2)
       SIGTERM      15       Term    Termination signal
       SIGUSR1   30,10,16    Term    User-defined signal 1
       SIGUSR2   31,12,17    Term    User-defined signal 2
       SIGCHLD   20,17,18    Ign     Child stopped or terminated
       SIGCONT   19,18,25    Cont    Continue if stopped
       SIGSTOP   17,19,23    Stop    Stop process
       SIGTSTP   18,20,24    Stop    Stop typed at terminal
       SIGTTIN   21,21,26    Stop    Terminal input for background process
       SIGTTOU   22,22,27    Stop    Terminal output for background process
</code></pre><p>SIGABRT&#x7684;&#x6027;&#x60C5;&#x5C31;&#x662F;&#x89E6;&#x53D1;core dump&#x673A;&#x5236;. &#x5185;&#x6838;&#x4F1A;&#x8D70;core dump&#x6D41;&#x7A0B;.</p>
<p>&#x6240;&#x4EE5;, &#x5728;<code>GOTRACEBACK=crash</code>&#x60C5;&#x51B5;&#x4E0B;</p>
<ul>
<li>go&#x7A0B;&#x5E8F;&#x4F1A;&#x5148;&#x6253;&#x5370;panic&#x8C03;&#x7528;&#x6808;(&#x6240;&#x6709;go routine)</li>
<li>&#x7136;&#x540E;&#x4E3B;&#x52A8;&#x8C03;&#x7528;&#x7C7B;&#x4F3C;c&#x7684;abort()&#x51FD;&#x6570;&#x89E6;&#x53D1;SIGABRT&#x7ED9;&#x81EA;&#x5DF1;</li>
<li>&#x7136;&#x540E;kernel&#x4F1A;&#x8D70;core dump&#x6D41;&#x7A0B;.</li>
</ul>
<h1 id="&#x5173;&#x4E8E;syscall"><a name="&#x5173;&#x4E8E;syscall" class="anchor-navigation-ex-anchor" href="#&#x5173;&#x4E8E;syscall"><i class="fa fa-link" aria-hidden="true"></i></a>34. &#x5173;&#x4E8E;syscall</h1>
<p>syscall&#x63D0;&#x4F9B;&#x4E86;&#x5BF9;&#x5E95;&#x5C42;os&#x7684;&#x539F;&#x59CB;&#x5C01;&#x88C5;.
&#x4ECE;go1.4&#x5F00;&#x59CB; &#x5B98;&#x65B9;&#x63A8;&#x8350;&#x4F7F;&#x7528;<code>golang.org/x/sys</code>&#x6765;&#x4EE3;&#x66FF;syscall.</p>
<p>&#x6807;&#x51C6;&#x5E93;&#x7684;syscall&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E9B;&#x57FA;&#x672C;&#x7684;const&#x5E38;&#x91CF;.
&#x6BD4;&#x5982;</p>
<pre class="language-"><code>    EPOLLERR                         = 0x8
    EPOLLET                          = -0x80000000
    EPOLLHUP                         = 0x10
    EPOLLIN                          = 0x1
    EPOLLMSG                         = 0x400
    EPOLLONESHOT                     = 0x40000000
    EPOLLOUT                         = 0x4
    EPOLLPRI                         = 0x2
    EPOLLRDBAND                      = 0x80
    EPOLLRDHUP                       = 0x2000
    EPOLLRDNORM                      = 0x40
    EPOLLWRBAND                      = 0x200
    EPOLLWRNORM                      = 0x100
    EPOLL_CLOEXEC                    = 0x80000
    EPOLL_CTL_ADD                    = 0x1
    EPOLL_CTL_DEL                    = 0x2
    EPOLL_CTL_MOD                    = 0x3
</code></pre><p>syscall&#x548C;CPU arch&#x5F3A;&#x76F8;&#x5173;, &#x9ED8;&#x8BA4;&#x663E;&#x793A;GOARCH&#x7684;&#x5BF9;&#x5E94;&#x7684;&#x5305;. &#x4E00;&#x822C;&#x662F;amd64
&#x7528; <code>$GOOS</code> and <code>$GOARCH</code>&#x6765;&#x5207;&#x6362;&#x5176;&#x4ED6;&#x7684;&#x7EC4;&#x5408;.
&#x5B9E;&#x9645;&#x7684;&#x4EE3;&#x7801;&#x5728;&#x5BF9;&#x5E94;&#x7684;&#x7EC4;&#x5408;, &#x6BD4;&#x5982;<code>/usr/local/go/src/syscall/zerrors_linux_arm64.go</code></p>
<h2 id="&#x6807;&#x51C6;syscall&#x5E93;&#x7684;&#x95EE;&#x9898;"><a name="&#x6807;&#x51C6;syscall&#x5E93;&#x7684;&#x95EE;&#x9898;" class="anchor-navigation-ex-anchor" href="#&#x6807;&#x51C6;syscall&#x5E93;&#x7684;&#x95EE;&#x9898;"><i class="fa fa-link" aria-hidden="true"></i></a>34.1. &#x6807;&#x51C6;syscall&#x5E93;&#x7684;&#x95EE;&#x9898;</h2>
<ul>
<li>&#x590D;&#x6742;, &#x7EF4;&#x62A4;&#x7684;&#x5F88;&#x5DEE;, &#x8868;&#x73B0;&#x5728;&#x96BE;&#x4E8E;&#x6D4B;&#x8BD5;, &#x5FC5;&#x987B;&#x8DDF;&#x968F;OS&#x7684;ARCH&#x7684;&#x6539;&#x52A8;</li>
<li>&#x7F3A;&#x5C11;&#x6587;&#x6863;, &#x517C;&#x5BB9;&#x6027;&#x96BE;&#x4EE5;&#x4FDD;&#x8BC1;</li>
</ul>
<h2 id="&#x89E3;&#x51B3;_3"><a name="&#x89E3;&#x51B3;_3" class="anchor-navigation-ex-anchor" href="#&#x89E3;&#x51B3;_3"><i class="fa fa-link" aria-hidden="true"></i></a>34.2. &#x89E3;&#x51B3;</h2>
<ul>
<li>syscall&#x5728;go1.3code freeze</li>
<li>&#x4ECE;go1.4&#x5F00;&#x59CB;, &#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x65B0;&#x5E93;, &#x65B0;&#x5E93;&#x5206;&#x4E3A;plan9, unix, windows&#x4E09;&#x4E2A;&#x5B50;&#x7C7B;</li>
<li>&#x5728;2014&#x5E74;&#x5DE6;&#x53F3;&#x5C31;&#x5B8C;&#x6210;&#x4E86;</li>
</ul>
<blockquote>
<p>Note that we cannot clean up the existing syscall package to any meaningful extent because of the compatibility guarantee. We can freeze and, in effect, deprecate it, however.</p>
</blockquote>
<h2 id="&#x66F4;&#x597D;&#x7684;syscall&#x5E93;"><a name="&#x66F4;&#x597D;&#x7684;syscall&#x5E93;" class="anchor-navigation-ex-anchor" href="#&#x66F4;&#x597D;&#x7684;syscall&#x5E93;"><i class="fa fa-link" aria-hidden="true"></i></a>34.3. &#x66F4;&#x597D;&#x7684;syscall&#x5E93;</h2>
<p><a href="https://docs.google.com/document/d/1QXzI9I1pOfZPujQzxhyRy6EeHYTQitKKjHfpq0zpxZs/edit" target="_blank">&#x7B80;&#x4ECB;&#x5728;&#x6B64;, &#x8FD9;&#x4E2A;&#x7B80;&#x4ECB;&#x5728;2014&#x5E74;&#x5DE6;&#x53F3;</a></p>
<p>&#x5E93;&#x5730;&#x5740;: <a href="https://github.com/golang/sys" target="_blank">https://github.com/golang/sys</a></p>
<h3 id="&#x4F7F;&#x7528;"><a name="&#x4F7F;&#x7528;" class="anchor-navigation-ex-anchor" href="#&#x4F7F;&#x7528;"><i class="fa fa-link" aria-hidden="true"></i></a>34.3.1. &#x4F7F;&#x7528;</h3>
<p><code>go get -u golang.org/x/sys</code></p>
<h3 id="ioctl"><a name="ioctl" class="anchor-navigation-ex-anchor" href="#ioctl"><i class="fa fa-link" aria-hidden="true"></i></a>34.3.2. ioctl</h3>
<p><code>unix/zsyscall_linux.go</code>&#x4E2D;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> req <span class="token builtin">uint</span><span class="token punctuation">,</span> arg <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> e1 <span class="token operator">:=</span> <span class="token function">Syscall</span><span class="token punctuation">(</span>SYS_IOCTL<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> e1 <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token function">errnoErr</span><span class="token punctuation">(</span>e1<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6CE8;&#x610F;&#x5230;&#x8FD9;&#x91CC;&#x7684;ioctl&#x662F;&#x5C0F;&#x5199;&#x7684;, &#x5916;&#x9762;&#x4E0D;&#x80FD;&#x5F15;&#x7528;.</p>
<h3 id="c&#x7684;ioctl&#x63A5;&#x53E3;"><a name="c&#x7684;ioctl&#x63A5;&#x53E3;" class="anchor-navigation-ex-anchor" href="#c&#x7684;ioctl&#x63A5;&#x53E3;"><i class="fa fa-link" aria-hidden="true"></i></a>34.3.3. c&#x7684;ioctl&#x63A5;&#x53E3;</h3>
<pre class="language-"><code class="lang-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">ioctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> request<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>ioctl&#x662F;&#x5BF9;&#x8BBE;&#x5907;&#x6587;&#x4EF6;&#x7528;&#x7684;. &#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x8BBE;&#x5907;&#x76F8;&#x5173;&#x7684;request code, &#x7B2C;&#x4E09;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x4E2A;&#x6307;&#x9488;(<code>char *argp</code>).
&#x8FD9;&#x4E2A;request&#x662F;&#x4E2A;&#x7F16;&#x7801;, &#x6307;&#x793A;argp&#x662F;&#x5165;&#x53C2;&#x8FD8;&#x662F;&#x51FA;&#x53C2;, argp&#x7684;&#x5B57;&#x8282;&#x6570;</p>
<p>ioctl&#x5BF9;&#x5E94;&#x9A71;&#x52A8;&#x7684;&#x5B9E;&#x73B0;:
<code>int (*ioctl) (struct inode * node, struct file *filp, unsigned int cmd, unsigned long arg);</code>
<a href="https://blog.csdn.net/coolwriter/article/details/78242256" target="_blank">&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;</a>&#x8BB2;&#x7684;&#x6BD4;&#x8F83;&#x6E05;&#x695A;.</p>
<h4 id="cmd"><a name="cmd" class="anchor-navigation-ex-anchor" href="#cmd"><i class="fa fa-link" aria-hidden="true"></i></a>cmd</h4>
<p>cmd&#x4E3A;32bit, &#x662F;&#x4E2A;&#x7EC4;&#x5408;, &#x5305;&#x62EC;&#x51E0;&#x4E2A;&#x90E8;&#x5206;</p>
<ul>
<li>&#x5206;&#x7C7B;:8bit</li>
<li>&#x7C7B;&#x5185;&#x5E8F;&#x53F7;: 8bit</li>
<li>&#x6570;&#x636E;&#x4F20;&#x8F93;&#x65B9;&#x5411;: 2bit<pre class="language-"><code class="lang-c">_IOC_NONE
_IOC_READ
_IOC_WRITE
_IOC_READ<span class="token operator">|</span>_IOC_WRITE
</code></pre>
</li>
<li>&#x6570;&#x636E;&#x5927;&#x5C0F;: &#x5269;&#x4E0B;&#x7684;14bit</li>
</ul>
<h4 id="argp"><a name="argp" class="anchor-navigation-ex-anchor" href="#argp"><i class="fa fa-link" aria-hidden="true"></i></a>argp</h4>
<p>&#x5E94;&#x7528;&#x5C42;&#x7684;ioctl&#x7684;&#x7B2C;&#x4E09;&#x4E2A;&#x53C2;&#x6570;&#x662F;&quot;...&quot;&#xFF0C;&#x8FD9;&#x4E2A;&#x8DDF;printf&#x7684;&quot;...&quot;&#x53EF;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;printf&#x4E2D;&#x662F;&#x610F;&#x5473;&#x8FD9;&#x4F60;&#x53EF;&#x4EE5;&#x4F20;&#x4EFB;&#x610F;&#x4E2A;&#x6570;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x800C;ioctl&#x6700;&#x591A;&#x4E5F;&#x53EA;&#x80FD;&#x4F20;&#x4E00;&#x4E2A;&#xFF0C;&quot;...&quot;&#x7684;&#x610F;&#x601D;&#x662F;&#x8BA9;&#x5185;&#x6838;&#x4E0D;&#x8981;&#x68C0;&#x67E5;&#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#x7684;&#x7C7B;&#x578B;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x4ECE;&#x7528;&#x6237;&#x5C42;&#x53EF;&#x4EE5;&#x4F20;&#x5165;&#x4EFB;&#x4F55;&#x53C2;&#x6570;&#xFF0C;&#x53EA;&#x8981;&#x4F60;&#x4F20;&#x5165;&#x7684;&#x4E2A;&#x6570;&#x662F;1.</p>
<p>&#x4E00;&#x822C;&#x4F1A;&#x6709;&#x4E24;&#x79CD;&#x7684;&#x4F20;&#x53C2;&#x65B9;&#x6CD5;&#xFF1A;</p>
<ol>
<li>&#x6574;&#x6570;&#xFF0C;&#x90A3;&#x53EF;&#x662F;&#x7701;&#x529B;&#x53C8;&#x7701;&#x5FC3;&#xFF0C;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#x3002;</li>
<li>&#x6307;&#x9488;&#xFF0C;&#x901A;&#x8FC7;&#x6307;&#x9488;&#x7684;&#x5C31;&#x4F20;&#x4EC0;&#x4E48;&#x7C7B;&#x578B;&#x90FD;&#x53EF;&#x4EE5;&#x4E86;&#xFF0C;&#x5F53;&#x7136;&#x7528;&#x8D77;&#x6765;&#x5C31;&#x6BD4;&#x8F83;&#x70E6;&#x3002;&#x5728;&#x9A71;&#x52A8;&#x91CC;&#x4F7F;&#x7528;copy_xx_user&#x51FD;&#x6570;&#x4ECE;&#x7528;&#x6237;&#x6001;&#x4F20;&#x8F93;&#x6570;&#x636E;</li>
</ol>
<h3 id="go&#x7684;ioctl&#x63A5;&#x53E3;"><a name="go&#x7684;ioctl&#x63A5;&#x53E3;" class="anchor-navigation-ex-anchor" href="#go&#x7684;ioctl&#x63A5;&#x53E3;"><i class="fa fa-link" aria-hidden="true"></i></a>34.3.4. go&#x7684;ioctl&#x63A5;&#x53E3;</h3>
<p>&#x524D;&#x9762;&#x8BF4;&#x8FC7;, go&#x7684;ioctl&#x662F;&#x5C0F;&#x5199;&#x7684;, &quot;&#x5185;&#x90E8;&#x4E13;&#x4F9B;&quot;
&#x4F46;&#x5728;<code>unix/ioctl.go</code>&#x4E2D;, &#x5C01;&#x88C5;&#x4E86;&#x51E0;&#x4E2A;&#x5BF9;&#x5916;&#x5F00;&#x653E;&#x7684;&#x63A5;&#x53E3;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// ioctl itself should not be exposed directly, but additional get/set</span>
<span class="token comment">// functions for specific types are permissible.</span>

<span class="token comment">// IoctlSetInt performs an ioctl operation which sets an integer value</span>
<span class="token comment">// on fd, using the specified request number.</span>
<span class="token keyword">func</span> <span class="token function">IoctlSetInt</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> req <span class="token builtin">uint</span><span class="token punctuation">,</span> value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

<span class="token comment">// IoctlSetPointerInt performs an ioctl operation which sets an</span>
<span class="token comment">// integer value on fd, using the specified request number. The ioctl</span>
<span class="token comment">// argument is called with a pointer to the integer value, rather than</span>
<span class="token comment">// passing the integer value directly.</span>
<span class="token keyword">func</span> <span class="token function">IoctlSetPointerInt</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> req <span class="token builtin">uint</span><span class="token punctuation">,</span> value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

<span class="token comment">// IoctlSetWinsize performs an ioctl on fd with a *Winsize argument.</span>
<span class="token comment">//</span>
<span class="token comment">// To change fd&apos;s window size, the req argument should be TIOCSWINSZ.</span>
<span class="token keyword">func</span> <span class="token function">IoctlSetWinsize</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> req <span class="token builtin">uint</span><span class="token punctuation">,</span> value <span class="token operator">*</span>Winsize<span class="token punctuation">)</span> <span class="token builtin">error</span>

<span class="token comment">// IoctlSetTermios performs an ioctl on fd with a *Termios.</span>
<span class="token comment">//</span>
<span class="token comment">// The req value will usually be TCSETA or TIOCSETA.</span>
<span class="token keyword">func</span> <span class="token function">IoctlSetTermios</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> req <span class="token builtin">uint</span><span class="token punctuation">,</span> value <span class="token operator">*</span>Termios<span class="token punctuation">)</span> <span class="token builtin">error</span>

<span class="token comment">// IoctlGetInt performs an ioctl operation which gets an integer value</span>
<span class="token comment">// from fd, using the specified request number.</span>
<span class="token comment">//</span>
<span class="token comment">// A few ioctl requests use the return value as an output parameter;</span>
<span class="token comment">// for those, IoctlRetInt should be used instead of this function.</span>
<span class="token keyword">func</span> <span class="token function">IoctlGetInt</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> req <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">IoctlGetWinsize</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> req <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Winsize<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">IoctlGetTermios</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> req <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Termios<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x7ED3;&#x5408;C&#x7248;&#x672C;&#x7684;ioctl&#x5206;&#x6790;, &#x8FD9;&#x51E0;&#x4E2A;API&#x6015;&#x662F;&#x4E0D;&#x591F;.
<code>IoctlSetInt</code>&#x548C;<code>IoctlSetPointerInt</code>&#x80FD;cover&#x7B80;&#x5355;&#x7684;int&#x4F20;&#x8F93;&#x7684;&#x9700;&#x6C42;
<code>IoctlGetWinsize</code>&#x548C;<code>IoctlGetTermios</code>&#x90FD;&#x662F;&#x4F20;&#x9012;&#x7279;&#x6B8A;&#x529F;&#x80FD;&#x7ED3;&#x6784;&#x4F53;&#x7684;.
<code>unix/syscall_linux.go</code>&#x4E2D;, &#x8FD8;&#x6709;&#x51E0;&#x4E2A;API:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">IoctlRetInt</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> req <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">IoctlSetRTCTime</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> value <span class="token operator">*</span>RTCTime<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token function">IoctlGetUint32</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> req <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">IoctlGetRTCTime</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>RTCTime<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="ioctl&#x7684;&#x5B8F;&#x5B9A;&#x4E49;&#x5728;&#x54EA;&#x91CC;"><a name="ioctl&#x7684;&#x5B8F;&#x5B9A;&#x4E49;&#x5728;&#x54EA;&#x91CC;" class="anchor-navigation-ex-anchor" href="#ioctl&#x7684;&#x5B8F;&#x5B9A;&#x4E49;&#x5728;&#x54EA;&#x91CC;"><i class="fa fa-link" aria-hidden="true"></i></a>34.3.5. ioctl&#x7684;&#x5B8F;&#x5B9A;&#x4E49;&#x5728;&#x54EA;&#x91CC;?</h3>
<p>&#x5728;<code>unix/zerrors_linux.go</code>&#x548C;<code>unix/zerrors_linux_amd64.go</code>
&#x4E0D;&#x7528;&#x7684;OS&#x548C;ARCH&#x5BF9;&#x5E94;&#x4E0D;&#x540C;&#x7684;&#x6587;&#x4EF6;
&#x6BD4;&#x5982;</p>
<pre class="language-"><code>//unix/zerrors_linux.go
EPOLLIN                                     = 0x1

//unix/zerrors_linux_amd64.go
RTC_RD_TIME                      = 0x80247009
</code></pre><h3 id="asm-files"><a name="asm-files" class="anchor-navigation-ex-anchor" href="#asm-files"><i class="fa fa-link" aria-hidden="true"></i></a>34.3.6. asm files</h3>
<p>ioctl&#x8C03;&#x7528;&#x7684;Syscall&#x662F;&#x5728;asm&#x91CC;&#x9762;&#x624B;&#x5199;&#x7684;
&#x89C1;<code>https://github.com/golang/sys/tree/master/unix</code></p>
<p>The hand-written assembly file at <code>asm_${GOOS}_${GOARCH}.s</code> implements system call dispatch. There are three entry points:</p>
<pre class="language-"><code class="lang-go">  <span class="token keyword">func</span> <span class="token function">Syscall</span><span class="token punctuation">(</span>trap<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3 <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> err <span class="token builtin">uintptr</span><span class="token punctuation">)</span>
  <span class="token keyword">func</span> <span class="token function">Syscall6</span><span class="token punctuation">(</span>trap<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> a4<span class="token punctuation">,</span> a5<span class="token punctuation">,</span> a6 <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> err <span class="token builtin">uintptr</span><span class="token punctuation">)</span>
  <span class="token keyword">func</span> <span class="token function">RawSyscall</span><span class="token punctuation">(</span>trap<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3 <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> err <span class="token builtin">uintptr</span><span class="token punctuation">)</span>
</code></pre>
<p>The first and second are the standard ones; they differ only in how many arguments can be passed to the kernel. The third is for low-level use by the ForkExec wrapper. Unlike the first two, it does not call into the scheduler to let it know that a system call is running.</p>
<p>When porting Go to an new architecture/OS, this file must be implemented for each GOOS/GOARCH pair.</p>
<h3 id="mmap"><a name="mmap" class="anchor-navigation-ex-anchor" href="#mmap"><i class="fa fa-link" aria-hidden="true"></i></a>34.3.7. mmap</h3>
<p><code>unix/syscall_linux.go</code></p>
<pre class="language-"><code class="lang-go"><span class="token comment">//&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;byte&#x5207;&#x7247;</span>
<span class="token keyword">func</span> <span class="token function">Mmap</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> offset <span class="token builtin">int64</span><span class="token punctuation">,</span> length <span class="token builtin">int</span><span class="token punctuation">,</span> prot <span class="token builtin">int</span><span class="token punctuation">,</span> flags <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">Mmap</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">,</span> prot<span class="token punctuation">,</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4F7F;&#x7528;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// +build aix darwin dragonfly freebsd linux netbsd openbsd solaris</span>

<span class="token keyword">package</span> unix_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;runtime&quot;</span>
    <span class="token string">&quot;testing&quot;</span>

    <span class="token string">&quot;golang.org/x/sys/unix&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestMmap</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    b<span class="token punctuation">,</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Mmap</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span><span class="token function">Getpagesize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>PROT_NONE<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MAP_ANON<span class="token operator">|</span>unix<span class="token punctuation">.</span>MAP_PRIVATE<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Mmap: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Mprotect</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>PROT_READ<span class="token operator">|</span>unix<span class="token punctuation">.</span>PROT_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Mprotect: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;byte&#x5207;&#x7247;&#x6765;&#x4FEE;&#x6539;&#x5185;&#x5BB9;</span>
    b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">42</span>

    <span class="token keyword">if</span> runtime<span class="token punctuation">.</span>GOOS <span class="token operator">==</span> <span class="token string">&quot;aix&quot;</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Skip</span><span class="token punctuation">(</span><span class="token string">&quot;msync returns invalid argument for AIX, skipping msync test&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//msync&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x662F;&#x7528;&#x6765;flush&#x5185;&#x5BB9;copy&#x5230;&#x771F;&#x6B63;&#x7684;&#x6587;&#x4EF6;, mumap&#x4E5F;&#x6709;&#x8FD9;&#x4E2A;&#x529F;&#x80FD;.</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Msync</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SYNC<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Msync: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//msync&#x4EE5;&#x540E;, &#x8FD9;&#x5757;&#x5185;&#x5B58;&#x5C31;&#x53EF;&#x4EE5;&quot;&#x5EFA;&#x8BAE;&quot;&#x5185;&#x6838;, &#x4E0D;&#x9700;&#x8981;&#x4E86;</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Madvise</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MADV_DONTNEED<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Madvise: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//&#x6700;&#x540E;&#x4F7F;&#x7528;munmap&#x89E3;&#x9664;&#x6620;&#x5C04;</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Munmap</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Munmap: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x767E;&#x5EA6;&#x4E0A;&#x7684;&#x7ED3;&#x8BBA;&#x5199;&#x7684;&#x4E0D;&#x9519;:</p>
<ol>
<li>&#x6700;&#x7EC8;&#x88AB;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x7684;&#x5185;&#x5BB9;&#x7684;&#x957F;&#x5EA6;&#x4E0D;&#x4F1A;&#x8D85;&#x8FC7;&#x6587;&#x4EF6;&#x672C;&#x8EAB;&#x7684;&#x521D;&#x59CB;&#x5927;&#x5C0F;&#xFF0C;&#x5373;&#x6620;&#x5C04;&#x4E0D;&#x80FD;&#x6539;&#x53D8;&#x6587;&#x4EF6;&#x7684;&#x5927;&#x5C0F;&#xFF1B;</li>
<li>&#x53EF;&#x4EE5;&#x7528;&#x4E8E;&#x8FDB;&#x7A0B;&#x901A;&#x4FE1;&#x7684;&#x6709;&#x6548;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#x5927;&#x4F53;&#x4E0A;&#x53D7;&#x9650;&#x4E8E;&#x88AB;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x4F46;&#x4E0D;&#x5B8C;&#x5168;&#x53D7;&#x9650;&#x4E8E;&#x6587;&#x4EF6;&#x5927;&#x5C0F;&#x3002;&#x6253;&#x5F00;&#x6587;&#x4EF6;&#x88AB;&#x622A;&#x77ED;&#x4E3A;5&#x4E2A;people&#x7ED3;&#x6784;&#x5927;&#x5C0F;&#xFF0C;&#x800C;&#x5728; map_normalfile1&#x4E2D;&#x521D;&#x59CB;&#x5316;&#x4E86;10&#x4E2A;people&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x5728;&#x6070;&#x5F53;&#x65F6;&#x5019;&#xFF08;map_normalfile1&#x8F93;&#x51FA;initialize over &#x4E4B;&#x540E;&#xFF0C;&#x8F93;&#x51FA;umap ok&#x4E4B;&#x524D;&#xFF09;&#x8C03;&#x7528;map_normalfile2&#x4F1A;&#x53D1;&#x73B0;map_normalfile2&#x5C06;&#x8F93;&#x51FA;&#x5168;&#x90E8;10&#x4E2A;people&#x7ED3;&#x6784;&#x7684;&#x503C;&#xFF0C;&#x540E;&#x9762;&#x5C06;&#x7ED9;&#x51FA;&#x8BE6;&#x7EC6;&#x8BA8;&#x8BBA;&#x3002;
&#x3000;&#x3000;&#x6CE8;&#xFF1A;&#x5728;linux&#x4E2D;&#xFF0C;&#x5185;&#x5B58;&#x7684;&#x4FDD;&#x62A4;&#x662F;&#x4EE5;&#x9875;&#x4E3A;&#x57FA;&#x672C;&#x5355;&#x4F4D;&#x7684;&#xFF0C;&#x5373;&#x4F7F;&#x88AB;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x5927;&#x5C0F;&#xFF0C;&#x5185;&#x6838;&#x4E5F;&#x4F1A;&#x4E3A;&#x6620;&#x5C04;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x9875;&#x9762;&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x3002;&#x5F53;&#x88AB;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x5C0F;&#x4E8E;&#x4E00;&#x4E2A;&#x9875;&#x9762;&#x5927;&#x5C0F;&#x65F6;&#xFF0C;&#x8FDB;&#x7A0B;&#x53EF;&#x4EE5;&#x5BF9;&#x4ECE;mmap()&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x5F00;&#x59CB;&#x7684;&#x4E00;&#x4E2A;&#x9875;&#x9762;&#x5927;&#x5C0F;&#x8FDB;&#x884C;&#x8BBF;&#x95EE;&#xFF0C;&#x800C;&#x4E0D;&#x4F1A;&#x51FA;&#x9519;&#xFF1B;&#x4F46;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x5BF9;&#x4E00;&#x4E2A;&#x9875;&#x9762;&#x4EE5;&#x5916;&#x7684;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x8FDB;&#x884C;&#x8BBF;&#x95EE;&#xFF0C;&#x5219;&#x5BFC;&#x81F4;&#x9519;&#x8BEF;&#x53D1;&#x751F;&#xFF0C;&#x540E;&#x9762;&#x5C06;&#x8FDB;&#x4E00;&#x6B65;&#x63CF;&#x8FF0;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x53EF;&#x7528;&#x4E8E;&#x8FDB;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x7684;&#x6709;&#x6548;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#x4E0D;&#x4F1A;&#x8D85;&#x8FC7;&#x6587;&#x4EF6;&#x5927;&#x5C0F;&#x53CA;&#x4E00;&#x4E2A;&#x9875;&#x9762;&#x5927;&#x5C0F;&#x7684;&#x548C;&#x3002;</li>
<li>&#x6587;&#x4EF6;&#x4E00;&#x65E6;&#x88AB;&#x6620;&#x5C04;&#x540E;&#xFF0C;&#x8C03;&#x7528;mmap()&#x7684;&#x8FDB;&#x7A0B;&#x5BF9;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x7684;&#x8BBF;&#x95EE;&#x662F;&#x5BF9;&#x67D0;&#x4E00;&#x5185;&#x5B58;&#x533A;&#x57DF;&#x7684;&#x8BBF;&#x95EE;&#xFF0C;&#x6682;&#x65F6;&#x8131;&#x79BB;&#x4E86;&#x78C1;&#x76D8;&#x4E0A;&#x6587;&#x4EF6;&#x7684;&#x5F71;&#x54CD;&#x3002;&#x6240;&#x6709;&#x5BF9;mmap()&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x7684;&#x64CD;&#x4F5C;&#x53EA;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x6709;&#x610F;&#x4E49;&#xFF0C;&#x53EA;&#x6709;&#x5728;&#x8C03;&#x7528;&#x4E86;munmap()&#x540E;&#x6216;&#x8005;msync()&#x65F6;&#xFF0C;&#x624D;&#x628A;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#x76F8;&#x5E94;&#x5185;&#x5BB9;&#x5199;&#x56DE;&#x78C1;&#x76D8;&#x6587;&#x4EF6;&#xFF0C;&#x6240;&#x5199;&#x5185;&#x5BB9;&#x4ECD;&#x7136;&#x4E0D;&#x80FD;&#x8D85;&#x8FC7;&#x6587;&#x4EF6;&#x7684;&#x5927;&#x5C0F;&#x3002;</li>
</ol>
<h3 id="mmap&#x8FD4;&#x56DE;&#x7684;byte&#x5207;&#x7247;&#x662F;&#x54EA;&#x91CC;&#x6765;&#x7684;"><a name="mmap&#x8FD4;&#x56DE;&#x7684;byte&#x5207;&#x7247;&#x662F;&#x54EA;&#x91CC;&#x6765;&#x7684;" class="anchor-navigation-ex-anchor" href="#mmap&#x8FD4;&#x56DE;&#x7684;byte&#x5207;&#x7247;&#x662F;&#x54EA;&#x91CC;&#x6765;&#x7684;"><i class="fa fa-link" aria-hidden="true"></i></a>34.3.8. mmap&#x8FD4;&#x56DE;&#x7684;byte&#x5207;&#x7247;&#x662F;&#x54EA;&#x91CC;&#x6765;&#x7684;?</h3>
<p><code>unix/syscall_linux.go</code>&#x4E2D;, Mmap&#x7684;&#x5B9E;&#x73B0;&#x662F;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">Mmap</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> offset <span class="token builtin">int64</span><span class="token punctuation">,</span> length <span class="token builtin">int</span><span class="token punctuation">,</span> prot <span class="token builtin">int</span><span class="token punctuation">,</span> flags <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">Mmap</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">,</span> prot<span class="token punctuation">,</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x800C;&#x8FD9;&#x4E2A;mapper&#x7684;&#x5B9E;&#x73B0;&#x5728;<code>unix/syscall_unix.go</code></p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>mmapper<span class="token punctuation">)</span> <span class="token function">Mmap</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> offset <span class="token builtin">int64</span><span class="token punctuation">,</span> length <span class="token builtin">int</span><span class="token punctuation">,</span> prot <span class="token builtin">int</span><span class="token punctuation">,</span> flags <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> length <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> EINVAL
    <span class="token punctuation">}</span>

    <span class="token comment">// Map the requested memory.</span>
    <span class="token comment">//&#x8FD9;&#x91CC;&#x7684;mmap&#x662F;&#x5728;unix/zsyscall_linux_amd64.go, &#x8C03;&#x7528;&#x7684;&#x662F;Syscall6</span>
    <span class="token comment">//&#x6CE8;&#x610F;&#x5230;Syscall&#x7684;&#x53C2;&#x6570;&#x548C;&#x8FD4;&#x56DE;&#x503C;&#x90FD;&#x662F;uintptr&#x7C7B;&#x578B;&#x7684;</span>
    <span class="token comment">//&#x8FD4;&#x56DE;&#x7684;&#x5730;&#x5740;&#x5C31;&#x662F;addr</span>
    addr<span class="token punctuation">,</span> errno <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span> prot<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> offset<span class="token punctuation">)</span>
    <span class="token keyword">if</span> errno <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errno
    <span class="token punctuation">}</span>

    <span class="token comment">// Use unsafe to convert addr into a []byte.</span>
    <span class="token keyword">var</span> b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    <span class="token comment">//&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x9ED1;&#x79D1;&#x6280;&#x4E86;. unsafeheader.Slice&#x662F;&#x5207;&#x7247;&#x7684;&#x5185;&#x90E8;&#x8868;&#x8FBE;</span>
    <span class="token comment">//unsafe.Pointer&#x53EF;&#x4EE5;&#x5728;&#x6307;&#x9488;&#x4E4B;&#x95F4;&#x4E92;&#x8F6C;</span>
    <span class="token comment">//&#x8FD9;&#x91CC;&#x5229;&#x7528;&#x5DF2;&#x6709;&#x7684;addr, &#x6784;&#x9020;&#x4E86;&#x4E00;&#x4E2A;slice&#x51FA;&#x6765;: hdr&#x5C31;&#x662F;b</span>
    hdr <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>unsafeheader<span class="token punctuation">.</span>Slice<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//addr&#x662F;uintptr, &#x53EF;&#x4EE5;&#x8F6C;&#x6210;unsafe.Pointer</span>
    hdr<span class="token punctuation">.</span>Data <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
    hdr<span class="token punctuation">.</span>Cap <span class="token operator">=</span> length
    hdr<span class="token punctuation">.</span>Len <span class="token operator">=</span> length

    <span class="token comment">// Register mapping in m and return it.</span>
    <span class="token comment">//p&#x662F;*byte, &#x6307;&#x5411;b&#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x5143;&#x7D20;</span>
    p <span class="token operator">:=</span> <span class="token operator">&amp;</span>b<span class="token punctuation">[</span><span class="token function">cap</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    m<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> m<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    m<span class="token punctuation">.</span>active<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> b
    <span class="token keyword">return</span> b<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;</p>
<ul>
<li>Syscall&#x4EA4;&#x4E92;&#x7684;&#x6570;&#x636E;&#x90FD;&#x662F;uintptr&#x7C7B;&#x578B;</li>
<li>Mmap&#x8FD4;&#x56DE;&#x7684;<code>data []byte</code>, &#x5E76;&#x4E0D;&#x662F;&#x901A;&#x5E38;&#x52A8;&#x6001;&#x7533;&#x8BF7;&#x7684;buffer, &#x800C;&#x662F;&#x7528;Syscall&#x8FD4;&#x56DE;&#x7684;&#x5730;&#x5740;, &#x7ECF;&#x8FC7;&#x9ED1;&#x79D1;&#x6280;&#x6784;&#x9020;&#x6210;&#x7684;&#x5207;&#x7247;.</li>
</ul>
<p>&#x6CE8;: &#x590D;&#x4E60;&#x4E00;&#x4E0B;&#x6307;&#x9488;&#x8F6C;&#x6362;&#x7684;&#x77E5;&#x8BC6;
unsafe.Pointer&#x6709;&#x5982;&#x4E0B;&#x6027;&#x8D28;:</p>
<ul>
<li>unsafe.Pointer&#x548C;&#x4EFB;&#x610F;&#x7684;&#x6307;&#x9488;&#x7C7B;&#x578B;&#x80FD;&#x4E92;&#x76F8;&#x8F6C;&#x6362;</li>
<li>unsafe.Pointer&#x548C;uintptr&#x80FD;&#x4E92;&#x76F8;&#x8F6C;&#x6362;</li>
<li>&#x6307;&#x9488;&#x548C;uintptr&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x4E92;&#x8F6C;</li>
</ul>
<h2 id="fnctl"><a name="fnctl" class="anchor-navigation-ex-anchor" href="#fnctl"><i class="fa fa-link" aria-hidden="true"></i></a>34.4. fnctl</h2>
<p><code>unix/fcntl.go</code>&#x4E2D;, &#x5BF9;fnctl&#x4E5F;&#x6709;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x5C01;&#x88C5;</p>
<h1 id="rwlock&#x6B7B;&#x9501;"><a name="rwlock&#x6B7B;&#x9501;" class="anchor-navigation-ex-anchor" href="#rwlock&#x6B7B;&#x9501;"><i class="fa fa-link" aria-hidden="true"></i></a>35. RWLock&#x6B7B;&#x9501;</h1>
<p>&#x5728;&#x6301;&#x6709;mtx.Lock()&#x7684;&#x65F6;&#x5019;, &#x5728;&#x91CC;&#x9762;&#x518D;&#x6B21;&#x83B7;&#x53D6;RLock&#x4F1A;&#x6B7B;&#x9501;
&#x6BD4;&#x5982;&#x4E0B;&#x9762;&#x7684;&#x7ED3;&#x6784;&#x4F1A;&#x6B7B;&#x9501;.</p>
<pre class="language-"><code class="lang-go">mtx<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
&#x8C03;&#x7528;&#x4E00;&#x4E2A;&#x51FD;&#x6570;<span class="token punctuation">(</span><span class="token punctuation">)</span>
    &#x51FD;&#x6570;&#x91CC;&#x9762;&#x518D;&#x6B21;&#x83B7;&#x53D6;&#x8BFB;&#x9501;
    mtx<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
    mtx<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
mtx<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x6B7B;&#x9501;&#x53D1;&#x751F;&#x65F6;, goroutine&#x4F1A;&#x663E;&#x793A;semacquire&#x72B6;&#x6001;</p>
<pre class="language-"><code>goroutine 1 [semacquire]:
&#x5176;&#x8C03;&#x7528;&#x6808;&#x8DEF;&#x5F84;&#x4E0A;&#x80FD;&#x770B;&#x5230;&#x662F;&#x91CD;&#x590D;&#x83B7;&#x53D6;&#x9501;
</code></pre><p><a href="https://golang.org/pkg/sync/#RWMutex.RLock" target="_blank">&#x5B98;&#x65B9;&#x6587;&#x6863;</a>&#x8BF4;&#x7684;&#x5F88;&#x6E05;&#x695A;, RLock()&#x4E0D;&#x652F;&#x6301;&#x91CD;&#x590D;&#x83B7;&#x53D6;(recursive lock)</p>
<h1 id="float&#x5F3A;&#x8F6C;&#x4E3A;int"><a name="float&#x5F3A;&#x8F6C;&#x4E3A;int" class="anchor-navigation-ex-anchor" href="#float&#x5F3A;&#x8F6C;&#x4E3A;int"><i class="fa fa-link" aria-hidden="true"></i></a>36. float&#x5F3A;&#x8F6C;&#x4E3A;int</h1>
<p>go&#x7684;&#x5F3A;&#x8F6C;&#x548C;C&#x7684;&#x8868;&#x73B0;&#x662F;&#x4E00;&#x81F4;&#x7684;, &#x6BD4;&#x5982;&#x628A;<code>3.1415926</code>&#x5F3A;&#x8F6C;&#x4E3A;int, C&#x548C;go&#x90FD;&#x662F;&#x5F97;&#x5230;<code>3</code>, &#x5373;&#x6D6E;&#x70B9;&#x7684;&#x6574;&#x6570;&#x90E8;&#x5206;.</p>
<h1 id="go-generate"><a name="go-generate" class="anchor-navigation-ex-anchor" href="#go-generate"><i class="fa fa-link" aria-hidden="true"></i></a>37. go generate</h1>
<p>go generate&#x7528;&#x4E8E;&#x6267;&#x884C;go&#x4EE3;&#x7801;&#x6CE8;&#x91CA;&#x4E2D;&#x7684;&#x52A8;&#x4F5C;
<a href="https://studygolang.com/articles/22984?fr=sidebar" target="_blank">&#x4E2D;&#x6587;&#x8BF4;&#x660E;</a>
<a href="https://blog.golang.org/generate" target="_blank">&#x5B98;&#x65B9;&#x8BF4;&#x660E;</a></p>
<p>&#x6267;&#x884C;go generate&#x65F6;&#xFF0C;&#x6709;&#x4E00;&#x4E9B;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;:</p>
<pre class="language-"><code>$GOARCH
    &#x4F53;&#x7CFB;&#x67B6;&#x6784; (arm&#x3001;amd64&#x7B49;&#x5F85;)
$GOOS
    OS&#x73AF;&#x5883;(linux&#x3001;windows&#x7B49;)
$GOFILE
    &#x5F53;&#x524D;&#x5904;&#x7406;&#x4E2D;&#x7684;&#x6587;&#x4EF6;&#x540D;
$GOLINE
    &#x5F53;&#x524D;&#x547D;&#x4EE4;&#x5728;&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x884C;&#x53F7;
$GOPACKAGE
    &#x5F53;&#x524D;&#x5904;&#x7406;&#x6587;&#x4EF6;&#x7684;&#x5305;&#x540D;
$DOLLAR
    &#x56FA;&#x5B9A;&#x7684;&quot;$&quot;,&#x4E0D;&#x6E05;&#x695A;&#x7528;&#x9014;
</code></pre><p>&#x5047;&#x8BBE;&#x6211;&#x4EEC;&#x6709;&#x4E2A;main.go&#x6587;&#x4EF6;&#xFF0C;&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token comment">//go:generate echo hello</span>
<span class="token comment">//go:generate go run main.go</span>
<span class="token comment">//go:generate  echo file=$GOFILE pkg=$GOPACKAGE</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;main func&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6267;&#x884C;&#x201C;go generate&#x201D;&#x540E;&#xFF0C;&#x8F93;&#x51FA;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre class="language-"><code class="lang-sh">$ go generate
hello
main func
<span class="token assign-left variable">file</span><span class="token operator">=</span>main.go <span class="token assign-left variable">pkg</span><span class="token operator">=</span>main
</code></pre>
<p>&#x6700;&#x540E;&#x7684;build&#x6B65;&#x9AA4;&#x5C31;&#x4E24;&#x6B65;</p>
<pre class="language-"><code>all:
    go generate &amp;&amp; go build .
</code></pre><h2 id="go-generate&#x5E38;&#x4F7F;&#x7528;&#x7684;&#x4E00;&#x4E9B;&#x5DE5;&#x5177;"><a name="go-generate&#x5E38;&#x4F7F;&#x7528;&#x7684;&#x4E00;&#x4E9B;&#x5DE5;&#x5177;" class="anchor-navigation-ex-anchor" href="#go-generate&#x5E38;&#x4F7F;&#x7528;&#x7684;&#x4E00;&#x4E9B;&#x5DE5;&#x5177;"><i class="fa fa-link" aria-hidden="true"></i></a>37.1. go generate&#x5E38;&#x4F7F;&#x7528;&#x7684;&#x4E00;&#x4E9B;&#x5DE5;&#x5177;</h2>
<p>&#x5728;&#x5B66;&#x4E60;go generate&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6211;&#x8FD8;&#x770B;&#x5230;&#x4E86;&#x4E00;&#x7BC7;generate&#x7684;&#x5E38;&#x7528;&#x5DE5;&#x5177;&#x7684;wiki&#xFF0C;&#x6211;&#x5E76;&#x6CA1;&#x6709;&#x5168;&#x90E8;&#x4F7F;&#x7528;&#x8FC7;&#xFF0C;&#x5728;&#x6B64;&#x4E0E;&#x5927;&#x5BB6;&#x5206;&#x4EAB;&#xFF0C;&#x5E0C;&#x671B;&#x80FD;&#x63D0;&#x5347;&#x5F00;&#x53D1;&#x6548;&#x7387;&#xFF0C;<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fgolang%2Fgo%2Fwiki%2FGoGenerateTools" target="_blank">https://github.com/golang/go/wiki/GoGenerateTools</a>&#x3002;</p>
<p><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fblog.golang.org%2Fgenerate" target="_blank"><code>go generate</code></a>&#x4EC5;&#x5728;&#x60A8;&#x6709;&#x4F7F;&#x7528;&#x5B83;&#x7684;&#x5DE5;&#x5177;&#x65F6;&#x624D;&#x6709;&#x7528;&#xFF01;&#x8FD9;&#x662F;&#x751F;&#x6210;&#x4EE3;&#x7801;&#x7684;&#x6709;&#x7528;&#x5DE5;&#x5177;&#x7684;&#x4E0D;&#x5B8C;&#x6574;&#x5217;&#x8868;&#x3002;</p>
<ul>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgodoc.org%2Fgolang.org%2Fx%2Ftools%2Fcmd%2Fgoyacc" target="_blank">goyacc</a> &#x2013; Go&#x7684;Yacc&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgodoc.org%2Fgolang.org%2Fx%2Ftools%2Fcmd%2Fstringer" target="_blank">stringer</a> &#x2013; &#x5B9E;&#x73B0;<code>fmt.Stringer</code>&#x679A;&#x4E3E;&#x7684;&#x63A5;&#x53E3;&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgodoc.org%2Fgithub.com%2Fsourcegraph%2Fgostringer" target="_blank">gostringer</a> &#x2013; <code>fmt.GoStringer</code>&#x4E3A;&#x679A;&#x4E3E;&#x5B9E;&#x73B0;&#x63A5;&#x53E3;&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fcampoy%2Fjsonenums" target="_blank">jsonenums</a> &#x2013; &#x679A;&#x4E3E;&#x7684;&#x5B9E;&#x73B0;<code>json.Marshaler</code>&#x548C;<code>json.Unmarshaler</code>&#x63A5;&#x53E3;&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgodoc.org%2Fgithub.com%2FsearKing%2Fgolang%2Ftools%2Fcmd%2Fgo-syncmap" target="_blank">go-syncmap</a> &#x2013; &#x4F7F;&#x7528;&#x8F6F;&#x4EF6;&#x5305;&#x4F5C;&#x4E3A;&#x7684;&#x901A;&#x7528;&#x6A21;&#x677F;&#x751F;&#x6210;Go&#x4EE3;&#x7801;<code>sync.Map</code>&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgodoc.org%2Fgithub.com%2FsearKing%2Fgolang%2Ftools%2Fcmd%2Fgo-syncpool" target="_blank">go-syncpool</a> &#x2013; &#x4F7F;&#x7528;&#x8F6F;&#x4EF6;&#x5305;&#x4F5C;&#x4E3A;&#x7684;&#x901A;&#x7528;&#x6A21;&#x677F;&#x751F;&#x6210;Go&#x4EE3;&#x7801;<code>sync.Pool</code>&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgodoc.org%2Fgithub.com%2FsearKing%2Fgolang%2Ftools%2Fcmd%2Fgo-atomicvalue" target="_blank">go-atomicvalue</a> &#x2013; &#x4F7F;&#x7528;&#x8F6F;&#x4EF6;&#x5305;&#x4F5C;&#x4E3A;&#x7684;&#x901A;&#x7528;&#x6A21;&#x677F;&#x751F;&#x6210;Go&#x4EE3;&#x7801;<code>atomic.Value</code>&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgodoc.org%2Fgithub.com%2FsearKing%2Fgolang%2Ftools%2Fcmd%2Fgo-nulljson" target="_blank">go-nulljson</a> &#x2013; &#x4F7F;&#x7528;&#x5305;&#x4F5C;&#x4E3A;&#x5B9E;&#x73B0;<code>database/sql.Scanner</code>&#x548C;&#x7684;&#x901A;&#x7528;&#x6A21;&#x677F;&#x751F;&#x6210;Go&#x4EE3;&#x7801;<code>database/sql/driver.Valuer</code>&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgodoc.org%2Fgithub.com%2FsearKing%2Fgolang%2Ftools%2Fcmd%2Fgo-enum" target="_blank">go-enum</a> &#x2013; &#x4F7F;&#x7528;&#x5305;&#x4F5C;&#x4E3A;&#x5B9E;&#x73B0;&#x63A5;&#x53E3;&#x7684;&#x901A;&#x7528;&#x6A21;&#x677F;&#x751F;&#x6210;Go&#x4EE3;&#x7801;<code>fmt.Stringer</code>| <code>binary</code>| <code>json</code>| <code>text</code>| <code>sql</code>| <code>yaml</code>&#x679A;&#x4E3E;&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgodoc.org%2Fgithub.com%2FsearKing%2Fgolang%2Ftools%2Fcmd%2Fgo-import" target="_blank">go-import</a> &#x2013; &#x6267;&#x884C;&#x975E;go&#x6587;&#x4EF6;&#x7684;&#x81EA;&#x52A8;&#x5BFC;&#x5165;&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2FChimeraCoder%2Fgojson" target="_blank">gojson</a> &#x2013; &#x4ECE;&#x793A;&#x4F8B;json&#x6587;&#x6863;&#x751F;&#x6210;go&#x7ED3;&#x6784;&#x5B9A;&#x4E49;&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2FshurcooL%2Fvfsgen" target="_blank">vfsgen</a> &#x2013; &#x751F;&#x6210;&#x9759;&#x6001;&#x5B9E;&#x73B0;&#x7ED9;&#x5B9A;&#x865A;&#x62DF;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;vfsdata.go&#x6587;&#x4EF6;&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fdc0d%2Fgoreuse" target="_blank">goreuse</a> &#x2013; &#x4F7F;&#x7528;&#x5305;&#x4F5C;&#x4E3A;&#x901A;&#x7528;&#x6A21;&#x677F;&#x901A;&#x8FC7;&#x66FF;&#x6362;&#x5B9A;&#x4E49;&#x6765;&#x751F;&#x6210;Go&#x4EE3;&#x7801;&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2F4d63.com%2Fembedfiles" target="_blank">embedfiles</a> &#x2013; &#x5C06;&#x6587;&#x4EF6;&#x5D4C;&#x5165;Go&#x4EE3;&#x7801;&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fwww.colm.net%2Fopen-source%2Fragel%2F" target="_blank">ragel</a> &#x2013; &#x72B6;&#x6001;&#x673A;&#x7F16;&#x8BD1;&#x5668;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2FMaratyszcza%2FPeachPy" target="_blank">peachpy</a> &#x2013; &#x5D4C;&#x5165;&#x5728;Python&#x4E2D;&#x7684;x86-64&#x6C47;&#x7F16;&#x5668;&#xFF0C;&#x751F;&#x6210;Go&#x6C47;&#x7F16;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgodoc.org%2Fgolang.org%2Fx%2Ftools%2Fcmd%2Fbundle" target="_blank">bundle</a> &#x2013; Bundle&#x521B;&#x5EFA;&#x9002;&#x7528;&#x4E8E;&#x5305;&#x542B;&#x5728;&#x7279;&#x5B9A;&#x76EE;&#x6807;&#x8F6F;&#x4EF6;&#x5305;&#x4E2D;&#x7684;&#x6E90;&#x8F6F;&#x4EF6;&#x5305;&#x7684;&#x5355;&#x4E00;&#x6E90;&#x6587;&#x4EF6;&#x7248;&#x672C;&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Ftinylib%2Fmsgp" target="_blank">msgp</a> &#x2013; MessagePack&#x7684;Go&#x4EE3;&#x7801;&#x751F;&#x6210;&#x5668;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fgolang%2Fprotobuf" target="_blank">protobuf</a> &#x2013; protobuf</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fthriftrw%2Fthriftrw-go" target="_blank">thriftrw</a> &#x2013; thrift</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Factgardner%2Fgogen-avro" target="_blank">gogen-avro</a> &#x2013; avro</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fdnephin%2Fswagger-gen-types" target="_blank">swagger-gen-types</a> &#x2013; &#x4ECE;swagger&#x5B9A;&#x4E49;&#x4E2D;&#x53BB;&#x751F;&#x6210;&#x4EE3;&#x7801;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fmmcloughlin%2Favo" target="_blank">avo</a> &#x2013; &#x4F7F;&#x7528;Go&#x751F;&#x6210;&#x6C47;&#x7F16;&#x4EE3;&#x7801;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fgoogle%2Fwire" target="_blank">Wire</a> &#x2013; Go&#x7684;&#x7F16;&#x8BD1;&#x65F6;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fsmasher164%2Fsumgen" target="_blank">sumgen</a> &#x2013; &#x4ECE;sum-type&#x58F0;&#x660E;&#x751F;&#x6210;&#x63A5;&#x53E3;&#x65B9;&#x6CD5;&#x5B9E;&#x73B0;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Furandom%2Finterface-extractor" target="_blank">interface-extractor</a> &#x2013; &#x751F;&#x6210;&#x6240;&#x9700;&#x7C7B;&#x578B;&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x4EC5;&#x5728;&#x5305;&#x5185;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x3002;</li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fglobusdigital%2Fdeep-copy" target="_blank">deep-copy</a> &#x2013; &#x4E3A;&#x7ED9;&#x5B9A;&#x7C7B;&#x578B;&#x521B;&#x5EFA;&#x6DF1;&#x5EA6;&#x590D;&#x5236;&#x65B9;&#x6CD5;&#x3002;</li>
</ul>
<h1 id="godoc&#x5B89;&#x88C5;"><a name="godoc&#x5B89;&#x88C5;" class="anchor-navigation-ex-anchor" href="#godoc&#x5B89;&#x88C5;"><i class="fa fa-link" aria-hidden="true"></i></a>38. godoc&#x5B89;&#x88C5;</h1>
<p>godoc&#x5C5E;&#x4E8E;<code>golang.org/x/tools/</code>
&#x6839;&#x636E;<code>https://github.com/golang/tools</code>&#x7684;&#x8BF4;&#x6CD5;, &#x6700;&#x7B80;&#x5355;&#x7684;&#x5B89;&#x88C5;:
<code>go get -u golang.org/x/tools/...</code>
&#x6CE8;&#x610F;&#x540E;&#x9762;&#x7684;&#x4E09;&#x4E2A;&#x70B9;&#x4E5F;&#x662F;&#x8981;&#x7684;.
&#x5B89;&#x88C5;&#x5B8C;&#x6BD5;&#x540E;, &#x5728;GOPATH&#x7684;bin&#x4E0B;&#x9762;, &#x4F1A;&#x6709;&#x5F88;&#x591A;tools</p>
<pre class="language-"><code>$ ls /repo/yingjieb/go/bin/
authtest  callgraph     cover    findcall    gitauth          godoc      gopackages  gotype  helper        lostcancel  present     shadow      stress         toolstash
benchcmp  compilebench  digraph  fiximports  go-contrib-init  goimports  gorename    goyacc  html2article  netrcauth   present2md  splitdwarf  stringer       unmarshal
bundle    cookieauth    eg       getgo       godex            gomvpkg    gostacks    guru    ifaceassert   nilness     server      ssadump     stringintconv
</code></pre><p>&#x6CE8;: go get&#x662F;&#x5148;&#x4E0B;&#x8F7D;&#x540E;&#x5B89;&#x88C5;packages, &#x5305;&#x62EC;&#x4F9D;&#x8D56;&#x7684;&#x5305;</p>
<h2 id="godoc&#x4F7F;&#x7528;"><a name="godoc&#x4F7F;&#x7528;" class="anchor-navigation-ex-anchor" href="#godoc&#x4F7F;&#x7528;"><i class="fa fa-link" aria-hidden="true"></i></a>38.1. godoc&#x4F7F;&#x7528;</h2>
<p>&#x5728;&#x81EA;&#x5DF1;&#x7684;repo&#x4E0B;&#x9762;&#x6572;</p>
<pre class="language-"><code>yingjieb@godev-server /repo/yingjieb/godevsig/compatible
$ /repo/yingjieb/go/bin/godoc -http 0.0.0.0:6060
using module mode; GOMOD=/repo/yingjieb/godevsig/compatible/go.mod

# &#x6211;&#x7684;repo&#x4E0B;&#x9762;&#x6709;go.mod, godoc&#x652F;&#x6301;gomod
yingjieb@godev-server /repo/yingjieb/godevsig/compatible
$ ls
go.mod  LICENSE  log  msgdriven  README.md
</code></pre><h1 id="package&#x901A;&#x914D;&#x7B26;&#x548C;&#x5BFC;&#x5165;&#x8DEF;&#x5F84;"><a name="package&#x901A;&#x914D;&#x7B26;&#x548C;&#x5BFC;&#x5165;&#x8DEF;&#x5F84;" class="anchor-navigation-ex-anchor" href="#package&#x901A;&#x914D;&#x7B26;&#x548C;&#x5BFC;&#x5165;&#x8DEF;&#x5F84;"><i class="fa fa-link" aria-hidden="true"></i></a>39. package&#x901A;&#x914D;&#x7B26;&#x548C;&#x5BFC;&#x5165;&#x8DEF;&#x5F84;</h1>
<h2 id="package&#x901A;&#x914D;&#x7B26;"><a name="package&#x901A;&#x914D;&#x7B26;" class="anchor-navigation-ex-anchor" href="#package&#x901A;&#x914D;&#x7B26;"><i class="fa fa-link" aria-hidden="true"></i></a>39.1. package&#x901A;&#x914D;&#x7B26;...</h2>
<p>&#x6BD4;&#x5982;go get, go install&#x547D;&#x4EE4;&#x6700;&#x540E;&#x7684;packages, &#x662F;&#x4E2A;import&#x8DEF;&#x5F84;. &#x5982;&#x679C;&#x5305;&#x542B;&#x7279;&#x6B8A;&#x7684;&#x901A;&#x914D;&#x683C;&#x5F0F;<code>...</code>, &#x8FD9;&#x4E2A;&#x8DEF;&#x5F84;&#x5C31;&#x662F;pattern&#x5339;&#x914D;&#x6A21;&#x5F0F;.
<code>...</code>&#x5339;&#x914D;&#x4EFB;&#x4F55;&#x5B57;&#x7B26;&#x4E32;, &#x5305;&#x62EC;&#x7A7A;&#x4E32;.
&#x6709;&#x4E24;&#x4E2A;&#x7279;&#x4F8B;:</p>
<ul>
<li>&#x7ED3;&#x5C3E;&#x7684;<code>/...</code>&#x5339;&#x914D;&#x4EFB;&#x4F55;&#x4E1C;&#x897F;. &#x6BD4;&#x5982;<code>net/...</code>&#x5339;&#x914D;<code>net</code> <code>net/http</code></li>
<li><code>...</code>&#x4E0D;&#x5339;&#x914D;vendor. &#x6BD4;&#x5982;<code>./...</code>&#x4E0D;&#x5339;&#x914D; <code>./vendor</code> <code>./mycode/vendor</code>. &#x60F3;&#x5339;&#x914D;vendor&#x8981;&#x663E;&#x5F0F;&#x5199;. &#x6BD4;&#x5982;<code>./vendor/...</code></li>
</ul>
<h2 id="&#x5BFC;&#x5165;&#x8DEF;&#x5F84;"><a name="&#x5BFC;&#x5165;&#x8DEF;&#x5F84;" class="anchor-navigation-ex-anchor" href="#&#x5BFC;&#x5165;&#x8DEF;&#x5F84;"><i class="fa fa-link" aria-hidden="true"></i></a>39.2. &#x5BFC;&#x5165;&#x8DEF;&#x5F84;</h2>
<p>&#x652F;&#x6301;&#x672C;&#x5730;&#x5BFC;&#x5165;&#x8DEF;&#x5F84;&#x548C;&#x8FDC;&#x7A0B;&#x5BFC;&#x5165;&#x8DEF;&#x5F84;
&#x5BFC;&#x5165;&#x8DEF;&#x5F84;&#x53EF;&#x4EE5;&#x91CD;&#x547D;&#x540D;
&#x6BD4;&#x5982;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">import</span> <span class="token string">&quot;example.org/pkg/foo&quot;</span>
</code></pre>
<p>go get&#x4F1A;&#x8BF7;&#x6C42;&#x5982;&#x4E0B;&#x7684;page</p>
<pre class="language-"><code>https://example.org/pkg/foo?go-get=1 (preferred)
http://example.org/pkg/foo?go-get=1  (fallback, only with -insecure)
</code></pre><p>&#x5982;&#x679C;&#x53D6;&#x4E0B;&#x6765;&#x7684;page&#x6709;&#x5982;&#x4E0B;&#x7684;&#x5143;&#x6570;&#x636E;</p>
<pre class="language-"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>go-import<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>example.org git https://code.org/r/p/exproj<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><p>&#x6307;&#x793A;<code>example.org</code>&#x5B9E;&#x9645;&#x4E0A;&#x662F;<code>code.org/r/p/exproj</code>, go tool&#x4F1A;clone&#x540E;&#x9762;&#x8FD9;&#x4E2A;&#x5E93;, &#x4F46;&#x8DEF;&#x5F84;&#x662F;example.org</p>
<blockquote>
<p>the go tool will verify that <a href="https://example.org/?go-get=1" target="_blank">https://example.org/?go-get=1</a> contains the
same meta tag and then git clone <a href="https://code.org/r/p/exproj" target="_blank">https://code.org/r/p/exproj</a> into
GOPATH/src/example.org.</p>
</blockquote>
<p>go mod&#x6A21;&#x5F0F;&#x4E0B;, &#x652F;&#x6301;&#x7C7B;&#x4F3C;&#x7684;&#x673A;&#x5236;: &#x5143;&#x6570;&#x636E;&#x683C;&#x5F0F;&#x4E3A;</p>
<pre class="language-"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>go-import<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>example.org mod https://code.org/moduleproxy<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><h1 id="objfunction&#x4E2D;obj&#x53EF;&#x4EE5;&#x662F;nil"><a name="objfunction&#x4E2D;obj&#x53EF;&#x4EE5;&#x662F;nil" class="anchor-navigation-ex-anchor" href="#objfunction&#x4E2D;obj&#x53EF;&#x4EE5;&#x662F;nil"><i class="fa fa-link" aria-hidden="true"></i></a>40. obj.function()&#x4E2D;obj&#x53EF;&#x4EE5;&#x662F;nil</h1>
<p>&#x901A;&#x5E38;&#x6211;&#x4EEC;&#x4F1A;&#x8BA4;&#x4E3A;&#x5982;&#x679C;obj&#x662F;&#x7A7A;&#x6307;&#x9488;, &#x90A3;&#x4E48;&#x8FD9;&#x4E2A;&#x8C03;&#x7528;&#x4F1A;&#x4EA7;&#x751F;&#x7A7A;&#x6307;&#x9488;&#x5F15;&#x7528;, &#x8FDB;&#x800C;panic.
&#x5B9E;&#x9645;&#x4E0A;&#x4E0D;&#x662F;&#x7684;, obj&#x662F;nil, &#x4E0D;&#x5F71;&#x54CD;&#x5806;function()&#x7684;&#x8C03;&#x7528;.
&#x4EE3;&#x7801;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> people <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>people<span class="token punctuation">)</span> <span class="token function">who</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//&#x6CE8;&#x610F;&#x8FD9;&#x4E00;&#x884C;, &#x5373;&#x4F7F;p&#x662F;nil, &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E5F;&#x662F;&#x4F1A;&#x88AB;&#x8C03;&#x7528;.</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;me&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//&#x8BBF;&#x95EE;p.name&#x4F1A;panic, &#x4F46;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4E0B;&#x9762;&#x8FD9;&#x4E00;&#x884C;, &#x6574;&#x4E2A;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x6B63;&#x5E38;&#x6267;&#x884C;.</span>
    <span class="token comment">//fmt.Println(p.name)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> team <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>people <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>people<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    team<span class="token punctuation">[</span><span class="token string">&quot;wang&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">who</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    san <span class="token operator">:=</span> people<span class="token punctuation">{</span><span class="token string">&quot;zhang san&quot;</span><span class="token punctuation">}</span>

    san<span class="token punctuation">.</span><span class="token function">who</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x5982;&#x4F55;&#x5904;&#x7406;"><a name="&#x5982;&#x4F55;&#x5904;&#x7406;" class="anchor-navigation-ex-anchor" href="#&#x5982;&#x4F55;&#x5904;&#x7406;"><i class="fa fa-link" aria-hidden="true"></i></a>40.1. &#x5982;&#x4F55;&#x5904;&#x7406;?</h2>
<p>&#x5728;C&#x91CC;&#x9762;, &#x4EE3;&#x7801;&#x91CC;&#x7ECF;&#x5E38;&#x8981;&#x5224;&#x65AD;&#x6307;&#x9488;&#x662F;&#x5426;&#x4E3A;&#x7A7A;. &#x90A3;&#x4E48;&#x662F;&#x4E0D;&#x662F;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4E5F;&#x8981;&#x5224;&#x65AD;? <strong>&#x7B54;&#x6848;&#x662F;&#x4E0D;&#x9700;&#x8981;</strong>.
&#x9996;&#x5148;, &#x5982;&#x679C;&#x5BF9;&#x8C61;&#x90FD;&#x5DF2;&#x7ECF;&#x662F;&#x7A7A;&#x4E86;, &#x8BF4;&#x660E;&#x54EA;&#x91CC;&#x80AF;&#x5B9A;&#x51FA;&#x4E86;&#x95EE;&#x9898;. &#x90A3;&#x4E0D;&#x5982;&#x5C31;&#x8BA9;&#x5B83;panic, go&#x4F1A;&#x6253;&#x5370;&#x8C03;&#x7528;&#x6808;&#x6765;&#x5E2E;&#x52A9;&#x5206;&#x6790;&#x95EE;&#x9898;.
&#x800C;&#x4E3A;&#x4EC0;&#x4E48;&#x5728;C&#x91CC;&#x9762;, &#x6211;&#x4EEC;&#x8981;&#x5224;&#x65AD;? &#x56E0;&#x4E3A;C&#x7A0B;&#x5E8F;&#x53EA;&#x80FD;segmentation fault, &#x9664;&#x4E86;coredump&#x6CA1;&#x6709;&#x66F4;&#x591A;&#x7684;&#x4FE1;&#x606F;. &#x800C;&#x5206;&#x6790;coredump&#x6210;&#x672C;&#x6BD4;&#x8F83;&#x5927;. &#x6240;&#x4EE5;C&#x7A0B;&#x5E8F;&#x5458;&#x4E60;&#x60EF;&#x81EA;&#x5DF1;&#x6765;&#x5904;&#x7406;&#x7A7A;&#x6307;&#x9488;&#x9519;&#x8BEF;, &#x901A;&#x5E38;&#x4E5F;&#x662F;&#x6253;&#x5370;&#x9519;&#x8BEF;.
&#x5BF9;&#x4E8E;GO&#x7A0B;&#x5E8F;&#x5458;, runtime&#x4F1A;&#x63A5;&#x7BA1;SIGSEGV, &#x5728;&#x7A7A;&#x6307;&#x9488;&#x8BBF;&#x95EE;&#x7684;&#x65F6;&#x5019;, &#x81EA;&#x52A8;&#x6253;&#x5370;&#x8C03;&#x7528;&#x6808;.</p>
<p>&#x6240;&#x4EE5;, go&#x7684;&#x7406;&#x5FF5;&#x662F;: <strong>&#x5982;&#x679C;&#x786E;&#x5B9E;&#x6709;&#x95EE;&#x9898;, &#x7A0B;&#x5E8F;&#x8981;&#x5D29;&#x8981;&#x8D81;&#x65E9;; &#x5D29;&#x5728;&#x7B2C;&#x4E00;&#x73B0;&#x573A;</strong></p>
<h1 id="&#x5207;&#x7247;&#x7684;reslicing"><a name="&#x5207;&#x7247;&#x7684;reslicing" class="anchor-navigation-ex-anchor" href="#&#x5207;&#x7247;&#x7684;reslicing"><i class="fa fa-link" aria-hidden="true"></i></a>41. &#x5207;&#x7247;&#x7684;reslicing</h1>
<p>&#x5BF9;&#x4E8E;&#x4E00;&#x4E2A;&#x5207;&#x7247;, &#x6BD4;&#x5982;<code>ss = [&quot;stdout&quot;]</code>, &#x5176;len&#x4E3A;1.
&#x5BF9;&#x5B83;&#x8FDB;&#x884C;re slicing&#x7684;&#x64CD;&#x4F5C;<code>ss[1:]</code>&#x662F;&#x5408;&#x6CD5;&#x7684;.</p>
<p>&#x5373;<code>slice[len():len()]</code>&#x662F;&#x5408;&#x6CD5;&#x7684;, &#x6BD4;&#x5982;<code>ss[1:1:1]</code>, &#x672C;&#x8EAB;&#x8FD9;&#x6837;&#x5199;, &#x5C31;&#x662F;&#x77DB;&#x76FE;&#x7684;: &#x6700;&#x5DE6;&#x8FB9;&#x7684;1&#x8981;&#x6C42;&#x4ECE;1&#x5F00;&#x59CB;, &#x5305;&#x62EC;1; &#x4F46;&#x662F;&#x4E2D;&#x95F4;&#x7684;1&#x8981;&#x6C42;&#x5230;1&#x7ED3;&#x675F;, &#x4E0D;&#x5305;&#x62EC;1; &#x6700;&#x540E;&#x7684;1&#x8868;&#x793A;&#x53EA;&#x6709;1&#x4E2A;&#x5BB9;&#x91CF;.
go&#x8BED;&#x6CD5;&#x652F;&#x6301;&#x8FD9;&#x79CD;re slicing, &#x7ED3;&#x679C;&#x5C31;&#x662F;len()&#x4E3A;0&#x7684;&#x5207;&#x7247;.</p>
<h1 id="&#x518D;&#x8BAE;&#x76EE;&#x5F55;&#x7ED3;&#x6784;"><a name="&#x518D;&#x8BAE;&#x76EE;&#x5F55;&#x7ED3;&#x6784;" class="anchor-navigation-ex-anchor" href="#&#x518D;&#x8BAE;&#x76EE;&#x5F55;&#x7ED3;&#x6784;"><i class="fa fa-link" aria-hidden="true"></i></a>42. &#x518D;&#x8BAE;&#x76EE;&#x5F55;&#x7ED3;&#x6784;</h1>
<blockquote>
<p>Go &#x8BED;&#x8A00;&#x9879;&#x76EE;&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x76EE;&#x5F55;&#x90FD;&#x4EE3;&#x8868;&#x7740;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x7684;&#x547D;&#x540D;&#x7A7A;&#x95F4;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x5305;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x5F15;&#x7528;&#x5176;&#x4ED6;&#x6587;&#x4EF6;&#x5939;&#x7684;&#x76EE;&#x5F55;&#x65F6;&#xFF0C;&#x9996;&#x5148;&#x9700;&#x8981;&#x4F7F;&#x7528; import &#x5173;&#x952E;&#x5B57;&#x5F15;&#x5165;&#x76F8;&#x5E94;&#x7684;&#x6587;&#x4EF6;&#x76EE;&#x5F55;&#xFF0C;&#x518D;&#x901A;&#x8FC7; pkg.xxx &#x7684;&#x5F62;&#x5F0F;&#x5F15;&#x7528;&#x5176;&#x4ED6;&#x76EE;&#x5F55;&#x5B9A;&#x4E49;&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x3001;&#x51FD;&#x6570;&#x6216;&#x8005;&#x5E38;&#x91CF;</p>
</blockquote>
<ul>
<li>&#x4E0D;&#x8981;&#x4F7F;&#x7528;src&#x76EE;&#x5F55;</li>
<li>&#x547D;&#x4EE4;&#x884C;&#x6267;&#x884C;&#x7A0B;&#x5E8F;&#x653E;&#x5728;/cmd&#x91CC;: /cmd/server/main.go&#x76F4;&#x63A5;&#x7F16;&#x8BD1;&#x51FA;&#x6765;&#x7684;&#x6587;&#x4EF6;&#x5C31;&#x662F;server</li>
<li>api&#x5B9A;&#x4E49;&#x7ED9;&#x5916;&#x90E8;&#x7684;&#x63A5;&#x53E3;<pre class="language-"><code>api
&#x2514;&#x2500;&#x2500; protobuf-spec
  &#x2514;&#x2500;&#x2500; oceanbookpb
      &#x251C;&#x2500;&#x2500; oceanbook.pb.go
      &#x2514;&#x2500;&#x2500; oceanbook.proto
</code></pre></li>
</ul>
<p>&#x53C2;&#x8003;: <a href="https://draveness.me/golang-101/" target="_blank">&#x5982;&#x4F55;&#x5199;&#x51FA;&#x4F18;&#x96C5;&#x7684; Go &#x8BED;&#x8A00;&#x4EE3;&#x7801;</a></p>
<h1 id="&#x5177;&#x4F53;error&#x5224;&#x65AD;"><a name="&#x5177;&#x4F53;error&#x5224;&#x65AD;" class="anchor-navigation-ex-anchor" href="#&#x5177;&#x4F53;error&#x5224;&#x65AD;"><i class="fa fa-link" aria-hidden="true"></i></a>43. &#x5177;&#x4F53;error&#x5224;&#x65AD;</h1>
<p>&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x91CC;, &#x8FD4;&#x56DE;&#x7684;err&#x4E0D;&#x4E3A;nil, &#x4F46;&#x4E5F;&#x4E0D;&#x597D;&#x7528;&#x7C7B;&#x578B;&#x65AD;&#x8A00;&#x6765;&#x5224;&#x65AD;err&#x5177;&#x4F53;&#x7C7B;&#x578B;(&#x53EF;&#x80FD;&#x51FA;&#x9519;&#x51FD;&#x6570;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x7684;&#x662F;errors.New())
&#x90A3;&#x4E48;&#x8FD8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5224;&#x65AD;&#x5B57;&#x7B26;&#x4E32;&#x6765;&#x5F97;&#x5230;&#x5177;&#x4F53;&#x7684;&#x9519;&#x8BEF;, &#x4E0B;&#x9762;&#x7B2C;6&#x884C;.</p>
<pre class="language-"><code class="lang-go">    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    e<span class="token punctuation">.</span>epollFd<span class="token punctuation">,</span> err <span class="token operator">=</span> syscall<span class="token punctuation">.</span><span class="token function">EpollCreate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">switch</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> err <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>
    <span class="token keyword">case</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;function not implemented&quot;</span><span class="token punctuation">:</span>
        <span class="token comment">// Some arch (arm64) do not implement EpollCreate().</span>
        <span class="token keyword">if</span> e<span class="token punctuation">.</span>epollFd<span class="token punctuation">,</span> err <span class="token operator">=</span> syscall<span class="token punctuation">.</span><span class="token function">EpollCreate1</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        e<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
</code></pre>
<h1 id="&#x51FD;&#x6570;&#x8D4B;&#x503C;&#x7ED9;&#x53D8;&#x91CF;"><a name="&#x51FD;&#x6570;&#x8D4B;&#x503C;&#x7ED9;&#x53D8;&#x91CF;" class="anchor-navigation-ex-anchor" href="#&#x51FD;&#x6570;&#x8D4B;&#x503C;&#x7ED9;&#x53D8;&#x91CF;"><i class="fa fa-link" aria-hidden="true"></i></a>44. &#x51FD;&#x6570;&#x8D4B;&#x503C;&#x7ED9;&#x53D8;&#x91CF;</h1>
<p><code>openFileOrig</code>&#x662F;&#x4E2A;&#x51FD;&#x6570;, &#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8D4B;&#x503C;&#x7ED9;&#x53D8;&#x91CF;<code>openFile</code>, &#x76F8;&#x5F53;&#x4E8E;C&#x91CC;&#x9762;&#x7684;&#x51FD;&#x6570;&#x6307;&#x9488;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">var</span> <span class="token punctuation">(</span>
    mu       sync<span class="token punctuation">.</span>Mutex
    maxSpeed <span class="token builtin">int64</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    openFile       <span class="token operator">=</span> openFileOrig
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">openFileOrig</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> flag <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>io<span class="token punctuation">.</span>ReadCloser<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    f<span class="token punctuation">,</span> err <span class="token operator">:=</span> fs<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> flag<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> f<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="gob-encode&#x548C;&#x7F51;&#x7EDC;io&#x7684;&#x7ED3;&#x5408;"><a name="gob-encode&#x548C;&#x7F51;&#x7EDC;io&#x7684;&#x7ED3;&#x5408;" class="anchor-navigation-ex-anchor" href="#gob-encode&#x548C;&#x7F51;&#x7EDC;io&#x7684;&#x7ED3;&#x5408;"><i class="fa fa-link" aria-hidden="true"></i></a>45. gob encode&#x548C;&#x7F51;&#x7EDC;io&#x7684;&#x7ED3;&#x5408;</h1>
<pre class="language-"><code>goroutine 5 [IO wait]:
internal/poll.runtime_pollWait(0x7f1c3dbe3ec8, 0x72, 0xffffffffffffffff)
        /usr/local/go/src/runtime/netpoll.go:184 +0x55
internal/poll.(*pollDesc).wait(0xc000104218, 0x72, 0x1000, 0x1000, 0xffffffffffffffff)
        /usr/local/go/src/internal/poll/fd_poll_runtime.go:87 +0x45
internal/poll.(*pollDesc).waitRead(...)
        /usr/local/go/src/internal/poll/fd_poll_runtime.go:92
internal/poll.(*FD).Read(0xc000104200, 0xc000149000, 0x1000, 0x1000, 0x0, 0x0, 0x0)
        /usr/local/go/src/internal/poll/fd_unix.go:169 +0x1cf
net.(*netFD).Read(0xc000104200, 0xc000149000, 0x1000, 0x1000, 0xc0001c9c50, 0x42e031, 0x5a4478)
        /usr/local/go/src/net/fd_unix.go:202 +0x4f
net.(*conn).Read(0xc000010018, 0xc000149000, 0x1000, 0x1000, 0x0, 0x0, 0x0)
        /usr/local/go/src/net/net.go:184 +0x68
bufio.(*Reader).Read(0xc0000c86c0, 0xc0000c47d0, 0x1, 0x9, 0x4ad2d8, 0x0, 0x0)
        /usr/local/go/src/bufio/bufio.go:226 +0x26a
io.ReadAtLeast(0x5cb4e0, 0xc0000c86c0, 0xc0000c47d0, 0x1, 0x9, 0x1, 0x6bfea0, 0xc0000fc000, 0x0)
        /usr/local/go/src/io/io.go:310 +0x87
io.ReadFull(...)
        /usr/local/go/src/io/io.go:329
encoding/gob.decodeUintReader(0x5cb4e0, 0xc0000c86c0, 0xc0000c47d0, 0x9, 0x9, 0x30, 0x27, 0x0, 0x0)
        /usr/local/go/src/encoding/gob/decode.go:120 +0x6f
encoding/gob.(*Decoder).recvMessage(0xc000104380, 0x0)
        /usr/local/go/src/encoding/gob/decoder.go:81 +0x57
encoding/gob.(*Decoder).decodeTypeSequence(0xc000104380, 0xc0000c6000, 0x59b95d)
        /usr/local/go/src/encoding/gob/decoder.go:143 +0x10c
encoding/gob.(*Decoder).DecodeValue(0xc000104380, 0x54f1c0, 0xc0000ad900, 0x16, 0x0, 0x0)
        /usr/local/go/src/encoding/gob/decoder.go:211 +0x10b
encoding/gob.(*Decoder).Decode(0xc000104380, 0x54f1c0, 0xc0000ad900, 0x0, 0x0)
        /usr/local/go/src/encoding/gob/decoder.go:188 +0x16d
main.inputDispacher(0x5cdb60, 0xc0000d7840, 0x5cec80, 0xc000010018)
        /repo/yingjieb/godev/practice/src/tools/topid.go:334 +0x12d
created by main.main
        /repo/yingjieb/godev/practice/src/tools/topid.go:558 +0xe22
</code></pre><h2 id="&#x5355;&#x6B65;decoderdecodemsg"><a name="&#x5355;&#x6B65;decoderdecodemsg" class="anchor-navigation-ex-anchor" href="#&#x5355;&#x6B65;decoderdecodemsg"><i class="fa fa-link" aria-hidden="true"></i></a>45.1. &#x5355;&#x6B65;decoder.Decode(&amp;msg)</h2>
<ul>
<li>gob decode&#x4F7F;&#x7528;&#x4E86;&#x53CD;&#x5C04;</li>
<li>gob&#x662F;&#x4E8C;&#x8FDB;&#x5236;&#x7F16;&#x7801;, &#x5728;&#x89E3;&#x7801;&#x65F6;, &#x5148;&#x4ECE;io stream&#x8BFB;&#x51FA;count, &#x518D;&#x6839;&#x636E;count&#x8BFB;&#x51FA;&#x5BF9;&#x5E94;&#x7684;&#x5B57;&#x8282;&#x6570;&#x6765;&#x89E3;&#x7801;.</li>
</ul>
<pre class="language-"><code class="lang-go"><span class="token keyword">var</span> msg messageIn
dec<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token comment">// &#x5165;&#x53C2;e interface{}&#x88AB;&#x8D4B;&#x503C;&#x4E3A;&amp;msg</span>
    value <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token comment">//value.Type().Kind() &#x5FC5;&#x987B;&#x662F;reflect.Ptr</span>
    dec<span class="token punctuation">.</span><span class="token function">DecodeValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">//&#x5165;&#x53C2;v reflect.Value&#x88AB;&#x8D4B;&#x503C;&#x4E3A;value</span>
        dec<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">defer</span> dec<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        dec<span class="token punctuation">.</span>buf<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        dec<span class="token punctuation">.</span>err <span class="token operator">=</span> <span class="token boolean">nil</span>
        id <span class="token operator">:=</span> dec<span class="token punctuation">.</span><span class="token function">decodeTypeSequence</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> dec<span class="token punctuation">.</span>err <span class="token operator">==</span> <span class="token boolean">nil</span>
                <span class="token keyword">if</span> dec<span class="token punctuation">.</span>buf<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                    <span class="token keyword">if</span> <span class="token operator">!</span>dec<span class="token punctuation">.</span><span class="token function">recvMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x5148;&#x4ECE;&#x5E95;&#x5C42;io.Reader&#x8BFB;count, &#x518D;&#x6309;&#x7167;count&#x8BFB;&#x5177;&#x4F53;&#x7684;&#x5B57;&#x8282;&#x6570;</span>
                            &#x6BD4;&#x5982;&#x5178;&#x578B;&#x7684;<span class="token punctuation">:</span>n<span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                            b <span class="token operator">:=</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// gob&#x7F16;&#x7801;&#x4E2D;, &#x5C0F;&#x4E8E;128&#x7684;&#x7528;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x8868;&#x793A;</span>
                            <span class="token keyword">if</span> b <span class="token operator">&lt;=</span> <span class="token number">0x7f</span>
                                <span class="token keyword">return</span> <span class="token function">uint64</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
                            <span class="token keyword">else</span>
                                <span class="token comment">//&#x8BFB;&#x53D6;&#x66F4;&#x591A;&#x7684;&#x5B57;&#x8282;&#x6765;&#x786E;&#x5B9A;count</span>
                                n <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token function">int8</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                width<span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
                                <span class="token operator">...</span>
                            <span class="token comment">//&#x786E;&#x5B9A;count&#x540E;,&#x8BFB;&#x51FA;&#x76F8;&#x5E94;&#x7684;nbytes</span>
                            dec<span class="token punctuation">.</span><span class="token function">readMessage</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>nbytes<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment">//&#x4E3E;&#x4F8B;&#x6765;&#x8BF4;, &#x5230;&#x8FD9;&#x91CC;&#x65F6;, dec.buf&#x91CC;&#x9762;&#x5C31;&#x6709;64&#x5B57;&#x8282;&#x7684;&#x6570;&#x636E;&#x4E86;</span>
                        <span class="token keyword">break</span>
                <span class="token operator">...</span>
                <span class="token comment">// &#x89E3;&#x7801;TypeSequence</span>
        <span class="token keyword">if</span> dec<span class="token punctuation">.</span>err <span class="token operator">==</span> <span class="token boolean">nil</span>
            dec<span class="token punctuation">.</span><span class="token function">decodeValue</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
                &#x6839;&#x636E;&#x60C5;&#x51B5;<span class="token punctuation">,</span> &#x53EF;&#x4EE5;&#x662F;&#x7ED3;&#x6784;&#x4F53;
                dec<span class="token punctuation">.</span><span class="token function">decodeStruct</span><span class="token punctuation">(</span>engine<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
                &#x4E5F;&#x53EF;&#x4EE5;&#x662F;&#x6807;&#x51C6;<span class="token keyword">type</span>
                dec<span class="token punctuation">.</span><span class="token function">decodeSingle</span><span class="token punctuation">(</span>engine<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token keyword">return</span> dec<span class="token punctuation">.</span>err
</code></pre>
<h1 id="protobuf&#x91CC;&#x9762;oneof&#x8F6C;&#x6210;go&#x7ED3;&#x6784;&#x4F53;"><a name="protobuf&#x91CC;&#x9762;oneof&#x8F6C;&#x6210;go&#x7ED3;&#x6784;&#x4F53;" class="anchor-navigation-ex-anchor" href="#protobuf&#x91CC;&#x9762;oneof&#x8F6C;&#x6210;go&#x7ED3;&#x6784;&#x4F53;"><i class="fa fa-link" aria-hidden="true"></i></a>46. protobuf&#x91CC;&#x9762;oneof&#x8F6C;&#x6210;go&#x7ED3;&#x6784;&#x4F53;</h1>
<ul>
<li>oneof&#x5BF9;&#x5E94;go&#x7ED3;&#x6784;&#x91CC;&#x7684;interface, &#x5E76;&#x4E14;&#x81EA;&#x52A8;&#x751F;&#x6210;isMessageName_MyField&#x7684;interface, &#x548C;&#x54CD;&#x5E94;&#x683C;&#x5F0F;&#x7684;&#x7B7E;&#x540D;&#x65B9;&#x6CD5;</li>
<li>&#x81EA;&#x52A8;&#x751F;&#x6210;GetXxx&#x65B9;&#x6CD5;</li>
<li>&#x751F;&#x6210;&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x91CC;&#x9762;&#x8FD8;&#x6709;&#x4E9B;&#x9690;&#x85CF;&#x7684;&#x5B57;&#x6BB5;:XXX_&#x5F00;&#x5934;&#x7684;, &#x53EF;&#x80FD;&#x662F;protobuf&#x81EA;&#x5DF1;&#x7528;&#x7684;.</li>
</ul>
<p>&#x53C2;&#x8003;: <a href="https://developers.google.com/protocol-buffers/docs/reference/go-generated" target="_blank">https://developers.google.com/protocol-buffers/docs/reference/go-generated</a></p>
<h2 id="proto&#x5B9A;&#x4E49;"><a name="proto&#x5B9A;&#x4E49;" class="anchor-navigation-ex-anchor" href="#proto&#x5B9A;&#x4E49;"><i class="fa fa-link" aria-hidden="true"></i></a>46.1. proto&#x5B9A;&#x4E49;</h2>
<pre class="language-"><code class="lang-go"><span class="token comment">// Messages specifically used to retrieve and configure BIP PM counters for GPON</span>
message GPONBIPWrapper
<span class="token punctuation">{</span>
    <span class="token builtin">string</span> onu_name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token comment">// vOnuMgmt -&gt; vProxy</span>
    <span class="token builtin">uint32</span> chnl_term_id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token comment">// vProxy -&gt; Device (to be changed later to chnl_term_name)</span>
    <span class="token builtin">uint32</span> onu_id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>              <span class="token comment">// vProxy -&gt; Device</span>
    oneof msg
    <span class="token punctuation">{</span>
        ConfigureBERInterval            config_ber_interval <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>                  <span class="token comment">// vOnuMgmt -&gt; vProxy -&gt; Device</span>
        ConfigureBERIntervalResponse    config_ber_interval_response <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>         <span class="token comment">// Device -&gt; vProxy -&gt; vOnuMgmt</span>
        GetBIPCounters                  get_bip_counters <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>                     <span class="token comment">// vOnuMgmt -&gt; vProxy -&gt; Device</span>
        GetBIPCountersResponse          get_bip_counters_response <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>            <span class="token comment">// Device -&gt; vProxy -&gt; vOnuMgmt</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x8F6C;&#x6210;&#x7684;&#x7ED3;&#x6784;&#x4F53;"><a name="&#x8F6C;&#x6210;&#x7684;&#x7ED3;&#x6784;&#x4F53;" class="anchor-navigation-ex-anchor" href="#&#x8F6C;&#x6210;&#x7684;&#x7ED3;&#x6784;&#x4F53;"><i class="fa fa-link" aria-hidden="true"></i></a>46.2. &#x8F6C;&#x6210;&#x7684;&#x7ED3;&#x6784;&#x4F53;</h2>
<pre class="language-"><code class="lang-go"><span class="token comment">// Messages specifically used to retrieve and configure BIP PM counters for GPON</span>
<span class="token keyword">type</span> GPONBIPWrapper <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    OnuName    <span class="token builtin">string</span> <span class="token string">`protobuf:&quot;bytes,1,opt,name=onu_name,json=onuName,proto3&quot; json:&quot;onu_name,omitempty&quot;`</span>
    ChnlTermId <span class="token builtin">uint32</span> <span class="token string">`protobuf:&quot;varint,2,opt,name=chnl_term_id,json=chnlTermId,proto3&quot; json:&quot;chnl_term_id,omitempty&quot;`</span>
    OnuId      <span class="token builtin">uint32</span> <span class="token string">`protobuf:&quot;varint,3,opt,name=onu_id,json=onuId,proto3&quot; json:&quot;onu_id,omitempty&quot;`</span>
    <span class="token comment">// Types that are valid to be assigned to Msg:</span>
    <span class="token comment">//  *GPONBIPWrapper_ConfigBerInterval</span>
    <span class="token comment">//  *GPONBIPWrapper_ConfigBerIntervalResponse</span>
    <span class="token comment">//  *GPONBIPWrapper_GetBipCounters</span>
    <span class="token comment">//  *GPONBIPWrapper_GetBipCountersResponse</span>
    Msg                  isGPONBIPWrapper_Msg <span class="token string">`protobuf_oneof:&quot;msg&quot;`</span>
    XXX_NoUnkeyedLiteral <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>             <span class="token string">`json:&quot;-&quot;`</span>
    XXX_unrecognized     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>               <span class="token string">`json:&quot;-&quot;`</span>
    XXX_sizecache        <span class="token builtin">int32</span>                <span class="token string">`json:&quot;-&quot;`</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> isGPONBIPWrapper_Msg <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">isGPONBIPWrapper_Msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>GPONBIPWrapper_ConfigBerInterval<span class="token punctuation">)</span> <span class="token function">isGPONBIPWrapper_Msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>GPONBIPWrapper_ConfigBerIntervalResponse<span class="token punctuation">)</span> <span class="token function">isGPONBIPWrapper_Msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>GPONBIPWrapper_GetBipCounters<span class="token punctuation">)</span> <span class="token function">isGPONBIPWrapper_Msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>GPONBIPWrapper_GetBipCountersResponse<span class="token punctuation">)</span> <span class="token function">isGPONBIPWrapper_Msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>GPONBIPWrapper<span class="token punctuation">)</span> <span class="token function">GetMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> isGPONBIPWrapper_Msg <span class="token punctuation">{</span>
    <span class="token keyword">if</span> m <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> m<span class="token punctuation">.</span>Msg
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="golang_杂记1.html" class="navigation navigation-prev " aria-label="Previous page: 杂记1">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="golang_杂记3.html" class="navigation navigation-next " aria-label="Next page: 杂记3">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"杂记2","level":"1.2.7.2","depth":3,"next":{"title":"杂记3","level":"1.2.7.3","depth":3,"path":"notes/golang_杂记3.md","ref":"notes/golang_杂记3.md","articles":[]},"previous":{"title":"杂记1","level":"1.2.7.1","depth":3,"path":"notes/golang_杂记1.md","ref":"notes/golang_杂记1.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","-lunr","-search","search-plus","-highlight","prism","prism-themes","expandable-chapters-small","github","disqus","splitter","wide-page","hide-navigation-buttons","anchor-navigation-ex"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"prism":{"css":["prism-themes/themes/prism-coldark-cold.css"]},"disqus":{"useIdentifier":false,"shortName":"bai-yingjie-notes"},"github":{"url":"https://github.com/Bai-Yingjie/Bai-Yingjie.github.io"},"splitter":{},"wide-page":{},"fontsettings":{"theme":"white","family":"sans","size":2},"hide-navigation-buttons":{},"anchor-navigation-ex":{"mode":"float","pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"isRewritePageTitle":true,"showLevel":true,"tocLevel1Icon":"fa fa-hand-o-right","tocLevel2Icon":"fa fa-hand-o-right","tocLevel3Icon":"fa fa-hand-o-right","showGoTop":true,"isShowTocTitleIcon":true,"printLog":false,"multipleH1":true,"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false}},"prism-themes":{},"expandable-chapters-small":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"theme":"default","author":"Bai Yingjie","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"My Notes","language":"zh-hans","gitbook":"*"},"file":{"path":"notes/golang_杂记2.md","mtime":"2022-09-08T15:37:30.295Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-09-08T15:38:26.251Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

