
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>解释器tengo · My Notes</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Bai Yingjie">
        
        
    
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-wide-page/wide.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hide-navigation-buttons/index.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-theme-comscore/test.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    


    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="golang_govaluate.html" />
    
    
    <link rel="prev" href="golang_yeagi.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="as_title_kaiyuan.html">
            
                <a href="as_title_kaiyuan.html">
            
                    
                    开源
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="my_opensource.html">
            
                <a href="my_opensource.html">
            
                    
                    我的开源项目
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="my_upstream.html">
            
                <a href="my_upstream.html">
            
                    
                    我的upstream commit
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="as_title_system.html">
            
                <a href="as_title_system.html">
            
                    
                    系统分析和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="as_title_perf_misc.html">
            
                <a href="as_title_perf_misc.html">
            
                    
                    调试和分析记录系列
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="profiling_调试和分析记录5.html">
            
                <a href="profiling_调试和分析记录5.html">
            
                    
                    调试和分析记录5
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="profiling_调试和分析记录4.html">
            
                <a href="profiling_调试和分析记录4.html">
            
                    
                    调试和分析记录4
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.3" data-path="profiling_调试和分析记录3.html">
            
                <a href="profiling_调试和分析记录3.html">
            
                    
                    调试和分析记录3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.4" data-path="profiling_调试和分析记录2.html">
            
                <a href="profiling_调试和分析记录2.html">
            
                    
                    调试和分析记录2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.5" data-path="profiling_调试和分析记录1.html">
            
                <a href="profiling_调试和分析记录1.html">
            
                    
                    调试和分析记录1
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="调试和分析工具概览.html">
            
                <a href="调试和分析工具概览.html">
            
                    
                    profiling和debugging工具相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="debugging_gdb备忘录.html">
            
                <a href="debugging_gdb备忘录.html">
            
                    
                    gdb备忘录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2" data-path="profiling_perf命令备忘录.html">
            
                <a href="profiling_perf命令备忘录.html">
            
                    
                    perf命令备忘录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3" data-path="profiling_perf命令备忘录2.html">
            
                <a href="profiling_perf命令备忘录2.html">
            
                    
                    perf命令备忘录2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.4" data-path="profiling_perf学习笔记之实战篇.html">
            
                <a href="profiling_perf学习笔记之实战篇.html">
            
                    
                    perf学习笔记之实战篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.5" data-path="profiling_perf学习笔记之入门篇.html">
            
                <a href="profiling_perf学习笔记之入门篇.html">
            
                    
                    perf学习笔记之入门篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6" data-path="profiling_ftrace和trace-cmd记录.html">
            
                <a href="profiling_ftrace和trace-cmd记录.html">
            
                    
                    ftrace和trace-cmd记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.7" data-path="profiling_ftrace使用实例.html">
            
                <a href="profiling_ftrace使用实例.html">
            
                    
                    ftrace使用实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.8" data-path="profiling_systemtap实例.html">
            
                <a href="profiling_systemtap实例.html">
            
                    
                    systemtap实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.9" data-path="profiling_Comparing_SystemTap_and_bpftrace.html">
            
                <a href="profiling_Comparing_SystemTap_and_bpftrace.html">
            
                    
                    Comparing SystemTap and bpftrace(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.10" data-path="system_analysis_bcc和ebpf.html">
            
                <a href="system_analysis_bcc和ebpf.html">
            
                    
                    bcc和ebpf(starting)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="as_title_os_perf.html">
            
                <a href="as_title_os_perf.html">
            
                    
                    profiling和debugging实例
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="performance_ovs进程调查.html">
            
                <a href="performance_ovs进程调查.html">
            
                    
                    OVS进程调查
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2" data-path="performance_ping流程和函数调用解析.html">
            
                <a href="performance_ping流程和函数调用解析.html">
            
                    
                    ping流程和函数调用解析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.3" data-path="profiling_VM互相ping场景下的延迟分析.html">
            
                <a href="profiling_VM互相ping场景下的延迟分析.html">
            
                    
                    VM互相ping场景下的延迟分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.4" data-path="debugging_ftrace_谁创建了bond0设备.html">
            
                <a href="debugging_ftrace_谁创建了bond0设备.html">
            
                    
                    谁创建了bond0设备: ftrace kprobe uprobe perf综合使用
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="as_title_arch_perf.html">
            
                <a href="as_title_arch_perf.html">
            
                    
                    CPU ARCH相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.4.1" data-path="performance_CPU_microarchiteture_pmu.html">
            
                <a href="performance_CPU_microarchiteture_pmu.html">
            
                    
                    Top-down Microarchitecture Analysis Method(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="as_title_cloud.html">
            
                <a href="as_title_cloud.html">
            
                    
                    Cloud和容器相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="cloud_杂记.html">
            
                <a href="cloud_杂记.html">
            
                    
                    云杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="container_当代容器读书笔记.html">
            
                <a href="container_当代容器读书笔记.html">
            
                    
                    当代容器读书笔记
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="as_title_vdevice.html">
            
                <a href="as_title_vdevice.html">
            
                    
                    CPU和device虚拟化
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="as_title_gvisor.html">
            
                <a href="as_title_gvisor.html">
            
                    
                    gvisor
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1.1" data-path="golang_gvisor代码_KVM.html">
            
                <a href="golang_gvisor代码_KVM.html">
            
                    
                    gvisor KVM模式代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.2" data-path="golang_gvisor调试.html">
            
                <a href="golang_gvisor调试.html">
            
                    
                    gvisor调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.3" data-path="golang_gvisor_ptrace.html">
            
                <a href="golang_gvisor_ptrace.html">
            
                    
                    gvisor ptrace模式介绍(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="rust_vmm_brief.html">
            
                <a href="rust_vmm_brief.html">
            
                    
                    rust VMM(virtual machine monitor)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.1" data-path="rust_vmm_简介.html">
            
                <a href="rust_vmm_简介.html">
            
                    
                    rust-vmm简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.2" data-path="rust_firecracker_代码.html">
            
                <a href="rust_firecracker_代码.html">
            
                    
                    firecracker代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.3" data-path="rust_firecracker_使用.html">
            
                <a href="rust_firecracker_使用.html">
            
                    
                    firecracker使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.4" data-path="rust_cloud-hypervisor_代码.html">
            
                <a href="rust_cloud-hypervisor_代码.html">
            
                    
                    cloud hypervisor代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.5" data-path="rust_cloud-hypervisor_使用.html">
            
                <a href="rust_cloud-hypervisor_使用.html">
            
                    
                    cloud hypervisor使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.6" data-path="rust_cloud-hypervisor_问题与解决.html">
            
                <a href="rust_cloud-hypervisor_问题与解决.html">
            
                    
                    cloud hypervisor问题与解决
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="virtualization_virtio规范阅读笔记.html">
            
                <a href="virtualization_virtio规范阅读笔记.html">
            
                    
                    virtio规范阅读笔记.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="qemu_ovs_虚拟化环境.html">
            
                <a href="qemu_ovs_虚拟化环境.html">
            
                    
                    qemu OVS 虚拟化环境准备
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="qemu使用.html">
            
                <a href="qemu使用.html">
            
                    
                    Qemu使用(old)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="as_title_networking.html">
            
                <a href="as_title_networking.html">
            
                    
                    计算机网络相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="networking_杂记1.html">
            
                <a href="networking_杂记1.html">
            
                    
                    networking杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="as_title_qemu_ovs.html">
            
                <a href="as_title_qemu_ovs.html">
            
                    
                    Qemu OVS和DPDK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.2.1" data-path="OVS_DPDK_编译运行.html">
            
                <a href="OVS_DPDK_编译运行.html">
            
                    
                    OVS-DPDK编译运行
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.2" data-path="OVS_架构和代码.html">
            
                <a href="OVS_架构和代码.html">
            
                    
                    OVS架构和代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.3" data-path="OVS_DPDK_performance_HXT_ARM_server.html">
            
                <a href="OVS_DPDK_performance_HXT_ARM_server.html">
            
                    
                    OVS-DPDK for ARM server 性能测试环境
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.4" data-path="DPDK_Mellanox.html">
            
                <a href="DPDK_Mellanox.html">
            
                    
                    DPDK Mellanox
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.5" data-path="OVS_phy-vm-phy.html">
            
                <a href="OVS_phy-vm-phy.html">
            
                    
                    OVS PHY-VM-PHY
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.6" data-path="networking_网络虚拟化用例记录.html">
            
                <a href="networking_网络虚拟化用例记录.html">
            
                    
                    网络虚拟化用例记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.7" data-path="networking_网络虚拟化操作记录.html">
            
                <a href="networking_网络虚拟化操作记录.html">
            
                    
                    网络虚拟化操作记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="as_title_virtnet.html">
            
                <a href="as_title_virtnet.html">
            
                    
                    虚拟化网络
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.3.1" data-path="networking_tc_filter_连接veth和tap.html">
            
                <a href="networking_tc_filter_连接veth和tap.html">
            
                    
                    Connecting a veth device to tap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.2" data-path="networking_multicast_vxlan_flannel.html">
            
                <a href="networking_multicast_vxlan_flannel.html">
            
                    
                    multicast vxlan和flannel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.3" data-path="networking_virtio网络介绍.html">
            
                <a href="networking_virtio网络介绍.html">
            
                    
                    virtio网络介绍(网摘): vhost-net virtio-net vhost-user SRIOV
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.4" data-path="networking_virtualization_杂记.html">
            
                <a href="networking_virtualization_杂记.html">
            
                    
                    虚拟化网络杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.5" data-path="networking_linux虚拟网络接口.html">
            
                <a href="networking_linux虚拟网络接口.html">
            
                    
                    linux虚拟网络接口(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="as_title_arm_server.html">
            
                <a href="as_title_arm_server.html">
            
                    
                    ARM server
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="arm_server_杂记.html">
            
                <a href="arm_server_杂记.html">
            
                    
                    Arm server 杂记
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="as_title_embedded.html">
            
                <a href="as_title_embedded.html">
            
                    
                    嵌入式系统开发调试
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="embedded_debugging.html">
            
                <a href="embedded_debugging.html">
            
                    
                    嵌入式调试杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="uboot_杂记.html">
            
                <a href="uboot_杂记.html">
            
                    
                    uboot杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="buildroot_杂记.html">
            
                <a href="buildroot_杂记.html">
            
                    
                    buildroot杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="toolchain_升级gcc问题解决.html">
            
                <a href="toolchain_升级gcc问题解决.html">
            
                    
                    升级GCC7.3问题解决
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="kernel_异常打印分析实例.html">
            
                <a href="kernel_异常打印分析实例.html">
            
                    
                    kernel bug异常打印分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="as_title_linuxdaily.html">
            
                <a href="as_title_linuxdaily.html">
            
                    
                    Linux工程实践
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="linux_日常使用.html">
            
                <a href="linux_日常使用.html">
            
                    
                    日常linux使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="git_日常使用.html">
            
                <a href="git_日常使用.html">
            
                    
                    日常git使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="向kernel提交补丁.html">
            
                <a href="向kernel提交补丁.html">
            
                    
                    向kernel提交补丁
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="linux_ssh_relay.html">
            
                <a href="linux_ssh_relay.html">
            
                    
                    ssh relay
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5" data-path="gitlab_ci.html">
            
                <a href="gitlab_ci.html">
            
                    
                    gitlab CI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.6" data-path="docker_操作记录.html">
            
                <a href="docker_操作记录.html">
            
                    
                    docker操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.7" data-path="centos_操作记录.html">
            
                <a href="centos_操作记录.html">
            
                    
                    centos操作记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="as_title_golang.html">
            
                <a href="as_title_golang.html">
            
                    
                    Golang
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="as_title_golang1.html">
            
                <a href="as_title_golang1.html">
            
                    
                    入门
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1.1" data-path="golang_语法基础.html">
            
                <a href="golang_语法基础.html">
            
                    
                    Golang 语法基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.1.2" data-path="golang_json性能.html">
            
                <a href="golang_json性能.html">
            
                    
                    Golang json性能比较
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="golang_原理.html">
            
                <a href="golang_原理.html">
            
                    
                    Golang 原理相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.2.1" data-path="golang_interface原理.html">
            
                <a href="golang_interface原理.html">
            
                    
                    Golang interface原理(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2.2" data-path="golang_内存分配.html">
            
                <a href="golang_内存分配.html">
            
                    
                    Golang 内存分配(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="golang_标准库.html">
            
                <a href="golang_标准库.html">
            
                    
                    Golang 标准库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="golang_我的反射代码.html">
            
                <a href="golang_我的反射代码.html">
            
                    
                    Golang 我的反射代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="golang_问答.html">
            
                <a href="golang_问答.html">
            
                    
                    Golang 问答
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6" data-path="golang_高效go.html">
            
                <a href="golang_高效go.html">
            
                    
                    Golang 高效go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.7" data-path="golang_进阶.html">
            
                <a href="golang_进阶.html">
            
                    
                    Golang 进阶
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8" data-path="as_title_golang2.html">
            
                <a href="as_title_golang2.html">
            
                    
                    Golang 杂记
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.8.1" data-path="golang_杂记1.html">
            
                <a href="golang_杂记1.html">
            
                    
                    Golang 杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8.2" data-path="golang_杂记2.html">
            
                <a href="golang_杂记2.html">
            
                    
                    Golang 杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8.3" data-path="golang_杂记3.html">
            
                <a href="golang_杂记3.html">
            
                    
                    Golang 杂记3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8.4" data-path="golang_lib选型.html">
            
                <a href="golang_lib选型.html">
            
                    
                    Golang lib选型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8.5" data-path="golang_mod_proxy.html">
            
                <a href="golang_mod_proxy.html">
            
                    
                    go mod和go proxy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8.6" data-path="golang_汇编_arm64.html">
            
                <a href="golang_汇编_arm64.html">
            
                    
                    Golang 汇编语法和arm64小知识
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8.7" data-path="golang_cgo_swig.html">
            
                <a href="golang_cgo_swig.html">
            
                    
                    go调用c可以用swig
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.9" data-path="as_title_golang3.html">
            
                <a href="as_title_golang3.html">
            
                    
                    Golang 环境和工具链生成
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.9.1" data-path="golang_toolchain_ppc.html">
            
                <a href="golang_toolchain_ppc.html">
            
                    
                    go tools增加ppc32支持.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9.2" data-path="golang_toolchain_compile_gccgo.html">
            
                <a href="golang_toolchain_compile_gccgo.html">
            
                    
                    编译gccgo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9.3" data-path="golang_go_on_mips.html">
            
                <a href="golang_go_on_mips.html">
            
                    
                    go on mips boards(not so updated)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.9.3.1" data-path="golang_go_on_mips_part1.html">
            
                <a href="golang_go_on_mips_part1.html">
            
                    
                    part 1: cross compile go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9.3.2" data-path="golang_go_on_mips_part2.html">
            
                <a href="golang_go_on_mips_part2.html">
            
                    
                    part 2: build native go compiler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9.3.3" data-path="golang_go_on_mips_part3.html">
            
                <a href="golang_go_on_mips_part3.html">
            
                    
                    part 3: gccgo experiments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9.3.4" data-path="golang_go_on_mips_part4.html">
            
                <a href="golang_go_on_mips_part4.html">
            
                    
                    part 4: Golang json performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9.3.5" data-path="golang_gentoo_on_mips_board_and_build_go.html">
            
                <a href="golang_gentoo_on_mips_board_and_build_go.html">
            
                    
                    Gentoo on mips board and build go
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.10" data-path="as_title_golang4.html">
            
                <a href="as_title_golang4.html">
            
                    
                    微服务
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.10.1" data-path="golang_micro.html">
            
                <a href="golang_micro.html">
            
                    
                    go-micro和micro
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.2" data-path="golang_微服务概念.html">
            
                <a href="golang_微服务概念.html">
            
                    
                    微服务概念
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.11" data-path="as_title_golang5.html">
            
                <a href="as_title_golang5.html">
            
                    
                    解释器和编解码
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.11.1" data-path="golang_yeagi.html">
            
                <a href="golang_yeagi.html">
            
                    
                    解释器yeagi
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.10.11.2" data-path="golang_tengo.html">
            
                <a href="golang_tengo.html">
            
                    
                    解释器tengo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.3" data-path="golang_govaluate.html">
            
                <a href="golang_govaluate.html">
            
                    
                    解释器govaluate
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.4" data-path="golang_encoding_gotiny.html">
            
                <a href="golang_encoding_gotiny.html">
            
                    
                    gotiny编解码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.5" data-path="golang_abs.html">
            
                <a href="golang_abs.html">
            
                    
                    解释器abs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.12" data-path="as_title_golang6.html">
            
                <a href="as_title_golang6.html">
            
                    
                    调试和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.12.1" data-path="golang_调试记录.html">
            
                <a href="golang_调试记录.html">
            
                    
                    Golang 调试记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.2" data-path="golang_topid性能优化.html">
            
                <a href="golang_topid性能优化.html">
            
                    
                    Golang topid性能优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.3" data-path="golang_gshell性能调试.html">
            
                <a href="golang_gshell性能调试.html">
            
                    
                    Golang gshell性能调试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.13" data-path="as_title_golang7.html">
            
                <a href="as_title_golang7.html">
            
                    
                    网络和消息中间件
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.13.1" data-path="golang_zmq.html">
            
                <a href="golang_zmq.html">
            
                    
                    消息中间件基本概念和zero mq
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.2" data-path="golang_mango.html">
            
                <a href="golang_mango.html">
            
                    
                    消息中间件mango
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.3" data-path="golang_libp2p.html">
            
                <a href="golang_libp2p.html">
            
                    
                    Golang p2p网络
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="as_title_rust.html">
            
                <a href="as_title_rust.html">
            
                    
                    Rust
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="rust_入门_brief.html">
            
                <a href="rust_入门_brief.html">
            
                    
                    Rust 入门系列
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1.1" data-path="rust_books.html">
            
                <a href="rust_books.html">
            
                    
                    Rust reference books
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.2" data-path="rust_入门1.html">
            
                <a href="rust_入门1.html">
            
                    
                    Rust 安装和基础语法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.3" data-path="rust_入门2.html">
            
                <a href="rust_入门2.html">
            
                    
                    Rust 泛型和内存所有权
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.4" data-path="rust_入门3.html">
            
                <a href="rust_入门3.html">
            
                    
                    Rust 闭包 容器 迭代器 生成器 线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.5" data-path="rust_工程构建.html">
            
                <a href="rust_工程构建.html">
            
                    
                    Rust 工程构建
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="rust_coding_brief.html">
            
                <a href="rust_coding_brief.html">
            
                    
                    Rust 代码积累
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.2.1" data-path="rust_序列化.html">
            
                <a href="rust_序列化.html">
            
                    
                    Rust 序列化原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.2" data-path="rust_知识点积累.html">
            
                <a href="rust_知识点积累.html">
            
                    
                    Rust 知识点更新
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.3" data-path="rust_adaptiveservice.html">
            
                <a href="rust_adaptiveservice.html">
            
                    
                    rust版本的adaptiveservice探索
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.4" data-path="rust_常用设施.html">
            
                <a href="rust_常用设施.html">
            
                    
                    Rust 常用设施
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.5" data-path="rust_代码小段.html">
            
                <a href="rust_代码小段.html">
            
                    
                    Rust 代码小段
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="others.html">
            
                <a href="others.html">
            
                    
                    其他
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.3.1" data-path="rust_mdbook_使用.html">
            
                <a href="rust_mdbook_使用.html">
            
                    
                    Rust 使用mdbook
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="as_title_scripts.html">
            
                <a href="as_title_scripts.html">
            
                    
                    脚本
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="shell_变量.html">
            
                <a href="shell_变量.html">
            
                    
                    shell变量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="shell_基础篇.html">
            
                <a href="shell_基础篇.html">
            
                    
                    shell命令和脚本记录-基础篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="shell_高级篇.html">
            
                <a href="shell_高级篇.html">
            
                    
                    shell命令和脚本记录-高级篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.4" data-path="shell_脚本片段.html">
            
                <a href="shell_脚本片段.html">
            
                    
                    shell脚本片段
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.5" data-path="python_记录.html">
            
                <a href="python_记录.html">
            
                    
                    python记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.6" data-path="lua_记录.html">
            
                <a href="lua_记录.html">
            
                    
                    lua记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.7" data-path="shell_rds脚本阅读.html">
            
                <a href="shell_rds脚本阅读.html">
            
                    
                    RDS脚本阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.8" data-path="Project_Euler.html">
            
                <a href="Project_Euler.html">
            
                    
                    Project Euler
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="as_title_app.html">
            
                <a href="as_title_app.html">
            
                    
                    应用相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="app_sysbench代码分析.html">
            
                <a href="app_sysbench代码分析.html">
            
                    
                    sysbench代码分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="as_title_cos.html">
            
                <a href="as_title_cos.html">
            
                    
                    C和Operating System
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" data-path="system_libc_part1.html">
            
                <a href="system_libc_part1.html">
            
                    
                    libc概览1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2" data-path="system_libc_part2.html">
            
                <a href="system_libc_part2.html">
            
                    
                    libc概览2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.3" data-path="system_libc_part3.html">
            
                <a href="system_libc_part3.html">
            
                    
                    libc概览3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.4" data-path="system_原理杂记.html">
            
                <a href="system_原理杂记.html">
            
                    
                    系统原理杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.5" data-path="system_alpine.html">
            
                <a href="system_alpine.html">
            
                    
                    Alpine Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.6" data-path="system_进程间通信.html">
            
                <a href="system_进程间通信.html">
            
                    
                    进程间通信
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.7" data-path="system_特殊功能fd.html">
            
                <a href="system_特殊功能fd.html">
            
                    
                    eventfd timerfd signalfd和fd共享
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.8" data-path="c_automake_autoconf.html">
            
                <a href="c_automake_autoconf.html">
            
                    
                    automake autoconf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.9" data-path="makefile_原理和实践.html">
            
                <a href="makefile_原理和实践.html">
            
                    
                    makefile
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.10" data-path="c_编程杂记高级篇.html">
            
                <a href="c_编程杂记高级篇.html">
            
                    
                    C编程杂记高级篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.11" data-path="c_编程杂记基础篇.html">
            
                <a href="c_编程杂记基础篇.html">
            
                    
                    C编程杂记基础篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.12" data-path="c_networking_socket高阶用法.html">
            
                <a href="c_networking_socket高阶用法.html">
            
                    
                    网络编程: Advanced Socket Topics(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.13" data-path="c_protobuf介绍.html">
            
                <a href="c_protobuf介绍.html">
            
                    
                    序列化: protobuf介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.14" data-path="c_进程间通信_共享文件和共享内存.html">
            
                <a href="c_进程间通信_共享文件和共享内存.html">
            
                    
                    进程间通信: 共享文件和共享内存(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.15" data-path="c_pthread_condition和mutex.html">
            
                <a href="c_pthread_condition和mutex.html">
            
                    
                    并发 任务 事件 和锁.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.16" data-path="kernel_user_space_howto.html">
            
                <a href="kernel_user_space_howto.html">
            
                    
                    kernel space和user space交互(网摘, linux2.6)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.17" data-path="CentOS_系统性能优化配置.html">
            
                <a href="CentOS_系统性能优化配置.html">
            
                    
                    CentOS 性能优化系统配置
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="as_title_driver.html">
            
                <a href="as_title_driver.html">
            
                    
                    内核 设备和驱动相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.1" data-path="platform_device_driver.html">
            
                <a href="platform_device_driver.html">
            
                    
                    平台驱动杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="device_driver_杂记.html">
            
                <a href="device_driver_杂记.html">
            
                    
                    驱动调试杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.3" data-path="device_localbus_16bit读写.html">
            
                <a href="device_localbus_16bit读写.html">
            
                    
                    CPLD做8bit到16bit转换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.4" data-path="as_title_driver1.html">
            
                <a href="as_title_driver1.html">
            
                    
                    nand
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.4.1" data-path="device_driver_octeon_nand.html">
            
                <a href="device_driver_octeon_nand.html">
            
                    
                    octeon nand flash驱动
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.4.2" data-path="device_driver_nand概率写失败问题分析.html">
            
                <a href="device_driver_nand概率写失败问题分析.html">
            
                    
                    Nand flash概率写失败问题分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15.5" data-path="octeon_remote_pci.html">
            
                <a href="octeon_remote_pci.html">
            
                    
                    octeon remote-pci.c阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.6" data-path="Device_VFIO_notes.html">
            
                <a href="Device_VFIO_notes.html">
            
                    
                    VFIO简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.7" data-path="as_title_driver2.html">
            
                <a href="as_title_driver2.html">
            
                    
                    智能网卡和DPDK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.7.1" data-path="smartNIC_智能网卡对比.html">
            
                <a href="smartNIC_智能网卡对比.html">
            
                    
                    智能网卡对比
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.7.2" data-path="octeon_pci_NIC.html">
            
                <a href="octeon_pci_NIC.html">
            
                    
                    octeon PCI NIC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.7.3" data-path="as_title_driver3.html">
            
                <a href="as_title_driver3.html">
            
                    
                    octeon liquidIO
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.7.3.1" data-path="smartNIC_liquidIO_代码阅读app篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读app篇.html">
            
                    
                    PCI-NIC 代码阅读 --app篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.7.3.2" data-path="smartNIC_liquidIO_代码阅读api篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读api篇.html">
            
                    
                    PCI-NIC 代码阅读 --api篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.7.3.3" data-path="smartNIC_liquidIO_代码阅读driver篇之结构体.html">
            
                <a href="smartNIC_liquidIO_代码阅读driver篇之结构体.html">
            
                    
                    PCI-NIC 代码阅读 --driver篇之结构体
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.7.3.4" data-path="smartNIC_liquidIO_代码阅读driver篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读driver篇.html">
            
                    
                    PCI-NIC 代码阅读 --driver篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.7.3.5" data-path="smartNIC_liquidIO_代码阅读真NIC篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读真NIC篇.html">
            
                    
                    PCI-NIC 代码阅读 --真NIC篇
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15.7.4" data-path="networking_dpdk使用_2014.html">
            
                <a href="networking_dpdk使用_2014.html">
            
                    
                    DPDK使用(2014)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15.8" data-path="device_nvme要点介绍.html">
            
                <a href="device_nvme要点介绍.html">
            
                    
                    nvme要点介绍
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="as_title_cpu.html">
            
                <a href="as_title_cpu.html">
            
                    
                    CPU Arch相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1" data-path="cache_CPU和cache一致性原理.html">
            
                <a href="cache_CPU和cache一致性原理.html">
            
                    
                    CPU和cache一致性原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.2" data-path="as_title_cpu1.html">
            
                <a href="as_title_cpu1.html">
            
                    
                    ARM64
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.2.1" data-path="CPU_ARM64_thunder_overview.html">
            
                <a href="CPU_ARM64_thunder_overview.html">
            
                    
                    thunder 概览
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.2.2" data-path="CPU_ARM64_thunder_开发板操作记录.html">
            
                <a href="CPU_ARM64_thunder_开发板操作记录.html">
            
                    
                    thunder 开发板操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.2.3" data-path="CPU_ARM64_thunder_bdk.html">
            
                <a href="CPU_ARM64_thunder_bdk.html">
            
                    
                    thunder BDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.2.4" data-path="CPU_ARM64_thunder_efi_rtc.html">
            
                <a href="CPU_ARM64_thunder_efi_rtc.html">
            
                    
                    thunder RTC时间和efi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.2.5" data-path="CPU_ARM64_thunder_uefi_fdt.html">
            
                <a href="CPU_ARM64_thunder_uefi_fdt.html">
            
                    
                    thunder uefi和fdt
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.2.6" data-path="CPU_ARM64_thunder_atf.html">
            
                <a href="CPU_ARM64_thunder_atf.html">
            
                    
                    thunder atf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.2.7" data-path="CPU_ARM64_thunder_kernel_boot.html">
            
                <a href="CPU_ARM64_thunder_kernel_boot.html">
            
                    
                    thunder kernel启动打印流程
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.3" data-path="as_title_cpu2.html">
            
                <a href="as_title_cpu2.html">
            
                    
                    PPC
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.3.1" data-path="CPU_PPC启动多核Linux_流程和内存映射.html">
            
                <a href="CPU_PPC启动多核Linux_流程和内存映射.html">
            
                    
                    PPC启动多核linux: 流程和内存映射
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3.2" data-path="CPU_PPC_kernel升级记录.html">
            
                <a href="CPU_PPC_kernel升级记录.html">
            
                    
                    PPC kernel升级记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.4" data-path="as_title_cpu3.html">
            
                <a href="as_title_cpu3.html">
            
                    
                    MIPS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.4.1" data-path="CPU_MIPS_octeon地址空间和寄存器访问.html">
            
                <a href="CPU_MIPS_octeon地址空间和寄存器访问.html">
            
                    
                    octeon 地址空间和寄存器访问
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.4.2" data-path="CPU_MIPS_octeon操作记录.html">
            
                <a href="CPU_MIPS_octeon操作记录.html">
            
                    
                    octeon 操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.4.3" data-path="CPU_MIPS_octeon_包处理性能.html">
            
                <a href="CPU_MIPS_octeon_包处理性能.html">
            
                    
                    octeon 系列处理器包处理性能
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.4.4" data-path="CPU_MIPS_octeon_ddr调试记录.html">
            
                <a href="CPU_MIPS_octeon_ddr调试记录.html">
            
                    
                    octeon DDR调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.4.5" data-path="CPU_MIPS_octeon_BDK.html">
            
                <a href="CPU_MIPS_octeon_BDK.html">
            
                    
                    octeon CN78xx BDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.4.6" data-path="kernel_增加ECC中断.html">
            
                <a href="kernel_增加ECC中断.html">
            
                    
                    octeon 增加ECC中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.4.7" data-path="CPU_MIPS_octeon_hw-ddr2代码走读.html">
            
                <a href="CPU_MIPS_octeon_hw-ddr2代码走读.html">
            
                    
                    octeon hw-ddr2代码走读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.4.8" data-path="CPU_MIPS_octeon_reboot调试和ddr中断.html">
            
                <a href="CPU_MIPS_octeon_reboot调试和ddr中断.html">
            
                    
                    octeon reboot调试和DDR中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.4.9" data-path="CPU_MIPS_octeon中断.html">
            
                <a href="CPU_MIPS_octeon中断.html">
            
                    
                    octeon 中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.4.10" data-path="CPU_MIPS_octeon原子操作.html">
            
                <a href="CPU_MIPS_octeon原子操作.html">
            
                    
                    octeon 原子操作
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.4.11" data-path="CPU_MIPS_octeon网口代码分析.html">
            
                <a href="CPU_MIPS_octeon网口代码分析.html">
            
                    
                    octeon 网口代码分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >解释器tengo</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#&#x589E;&#x52A0;vm&#x7684;&#x5E76;&#x53D1;run"><b>1. </b>&#x589E;&#x52A0;VM&#x7684;&#x5E76;&#x53D1;run</a></li><ul><li><span class="title-icon "></span><a href="#&#x7F16;&#x8BD1;&#x51FD;&#x6570;"><b>1.1. </b>&#x7F16;&#x8BD1;&#x51FD;&#x6570;</a></li><li><span class="title-icon "></span><a href="#vm&#x6267;&#x884C;&#x51FD;&#x6570;"><b>1.2. </b>VM&#x6267;&#x884C;&#x51FD;&#x6570;</a></li><li><span class="title-icon "></span><a href="#&#x51FD;&#x6570;&#x600E;&#x4E48;&#x8C03;&#x7528;&#x7684;"><b>1.3. </b>&#x51FD;&#x6570;&#x600E;&#x4E48;&#x8C03;&#x7528;&#x7684;?</a></li><ul><li><span class="title-icon "></span><a href="#&#x7F16;&#x8BD1;&#x9636;&#x6BB5;"><b>1.3.1. </b>&#x7F16;&#x8BD1;&#x9636;&#x6BB5;</a></li><li><span class="title-icon "></span><a href="#&#x6267;&#x884C;&#x9636;&#x6BB5;"><b>1.3.2. </b>&#x6267;&#x884C;&#x9636;&#x6BB5;</a></li></ul><li><span class="title-icon "></span><a href="#&#x51FD;&#x6570;&#x600E;&#x4E48;&#x9000;&#x51FA;&#x7684;"><b>1.4. </b>&#x51FD;&#x6570;&#x600E;&#x4E48;&#x9000;&#x51FA;&#x7684;?</a></li><li><span class="title-icon "></span><a href="#&#x5982;&#x4F55;&#x7406;&#x89E3;&#x5B57;&#x8282;&#x7801;"><b>1.5. </b>&#x5982;&#x4F55;&#x7406;&#x89E3;&#x5B57;&#x8282;&#x7801;?</a></li><li><span class="title-icon "></span><a href="#&#x8FD0;&#x884C;&#x65F6;&#x4F1A;&#x6539;&#x53D8;&#x589E;&#x52A0;&#x5220;&#x9664;-global&#x6216;constant&#x6570;&#x7EC4;&#x5417;"><b>1.6. </b>&#x8FD0;&#x884C;&#x65F6;&#x4F1A;&#x6539;&#x53D8;/&#x589E;&#x52A0;/&#x5220;&#x9664; global&#x6216;constant&#x6570;&#x7EC4;&#x5417;?</a></li><li><span class="title-icon "></span><a href="#compiledfunction&#x7684;free&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x6570;&#x7EC4;&#x662F;&#x5E72;&#x4EC0;&#x4E48;&#x7684;"><b>1.7. </b>CompiledFunction&#x7684;Free&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x6570;&#x7EC4;&#x662F;&#x5E72;&#x4EC0;&#x4E48;&#x7684;?</a></li><ul><li><span class="title-icon "></span><a href="#&#x8FD0;&#x884C;&#x9636;&#x6BB5;"><b>1.7.1. </b>&#x8FD0;&#x884C;&#x9636;&#x6BB5;</a></li><li><span class="title-icon "></span><a href="#&#x7ED3;&#x8BBA;"><b>1.7.2. </b>&#x7ED3;&#x8BBA;</a></li></ul><li><span class="title-icon "></span><a href="#&#x4F8B;&#x5B50;"><b>1.8. </b>&#x4F8B;&#x5B50;</a></li></ul><li><span class="title-icon "></span><a href="#tengo&#x6307;&#x4EE4;&#x96C6;&#x548C;go&#x7684;&#x64CD;&#x4F5C;&#x7801;"><b>2. </b>tengo&#x6307;&#x4EE4;&#x96C6;&#x548C;go&#x7684;&#x64CD;&#x4F5C;&#x7801;</a></li><li><span class="title-icon "></span><a href="#tengo&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;"><b>3. </b>tengo&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;</a></li><ul><li><span class="title-icon "></span><a href="#&#x521D;&#x59CB;&#x72B6;&#x6001;"><b>3.1. </b>&#x521D;&#x59CB;&#x72B6;&#x6001;</a></li><li><span class="title-icon "></span><a href="#a--1-&#x540E;"><b>3.2. </b>a := 1 &#x540E;</a></li><li><span class="title-icon "></span><a href="#b--2-&#x540E;"><b>3.3. </b>b := 2 &#x540E;</a></li><li><span class="title-icon "></span><a href="#c--ab-&#x540E;"><b>3.4. </b>c := a+b &#x540E;</a></li><li><span class="title-icon "></span><a href="#f--funca-b--return-a--b--&#x540E;"><b>3.5. </b>f := func(a, b) { return a + b } &#x540E;</a></li><li><span class="title-icon "></span><a href="#formatconstants&#x51FD;&#x6570;"><b>3.6. </b>FormatConstants&#x51FD;&#x6570;</a></li><li><span class="title-icon "></span><a href="#&#x90A3;&#x4E48;&#x4EC0;&#x4E48;&#x662F;constant"><b>3.7. </b>&#x90A3;&#x4E48;&#x4EC0;&#x4E48;&#x662F;constant?</a></li><ul><li><span class="title-icon "></span><a href="#constants&#x5728;&#x4F55;&#x5904;&#x4F7F;&#x7528;-&#x5728;&#x4F55;&#x5904;&#x5B9A;&#x4E49;"><b>3.7.1. </b>constants&#x5728;&#x4F55;&#x5904;&#x4F7F;&#x7528;, &#x5728;&#x4F55;&#x5904;&#x5B9A;&#x4E49;</a></li><li><span class="title-icon "></span><a href="#&#x4E3A;&#x4EC0;&#x4E48;constants&#x8981;&#x4F20;&#x9012;&#x7ED9;newcompiler"><b>3.7.2. </b>&#x4E3A;&#x4EC0;&#x4E48;constants&#x8981;&#x4F20;&#x9012;&#x7ED9;NewCompiler?</a></li></ul></ul><li><span class="title-icon "></span><a href="#extension"><b>4. </b>extension</a></li><ul><li><span class="title-icon "></span><a href="#&#x4E3A;&#x4EC0;&#x4E48;extensionuserfunction&#x4E0D;&#x751F;&#x6548;----&#x6CE8;&#x610F;copy&#x65B9;&#x6CD5;"><b>4.1. </b>&#x4E3A;&#x4EC0;&#x4E48;extension.UserFunction&#x4E0D;&#x751F;&#x6548;? -- &#x6CE8;&#x610F;Copy()&#x65B9;&#x6CD5;</a></li><ul><li><span class="title-icon "></span><a href="#&#x8C03;&#x67E5;"><b>4.1.1. </b>&#x8C03;&#x67E5;</a></li><li><span class="title-icon "></span><a href="#&#x7ED3;&#x8BBA;_1"><b>4.1.2. </b>&#x7ED3;&#x8BBA;</a></li></ul><li><span class="title-icon "></span><a href="#bash"><b>4.2. </b>bash</a></li><ul><li><span class="title-icon "></span><a href="#&#x80FD;&#x591F;&#x5728;bash&#x7684;&#x547D;&#x4EE4;&#x91CC;&#x5F15;&#x7528;&#x811A;&#x672C;&#x7684;&#x53D8;&#x91CF;&#x5417;"><b>4.2.1. </b>&#x80FD;&#x591F;&#x5728;bash&#x7684;&#x547D;&#x4EE4;&#x91CC;&#x5F15;&#x7528;&#x811A;&#x672C;&#x7684;&#x53D8;&#x91CF;&#x5417;?</a></li></ul><li><span class="title-icon "></span><a href="#&#x6DFB;&#x52A0;&#x65B0;&#x7684;builtin&#x51FD;&#x6570;ex"><b>4.3. </b>&#x6DFB;&#x52A0;&#x65B0;&#x7684;builtin&#x51FD;&#x6570;ex()</a></li><ul><li><span class="title-icon "></span><a href="#&#x80FD;&#x5426;&#x6DFB;&#x52A0;&#x5230;builtinfuncs&#x8868;"><b>4.3.1. </b>&#x80FD;&#x5426;&#x6DFB;&#x52A0;&#x5230;builtinFuncs&#x8868;</a></li><li><span class="title-icon "></span><a href="#&#x6DFB;&#x52A0;&#x5230;global&#x8868;"><b>4.3.2. </b>&#x6DFB;&#x52A0;&#x5230;global&#x8868;</a></li></ul></ul><li><span class="title-icon "></span><a href="#tengo&#x4EE3;&#x7801;"><b>5. </b>tengo&#x4EE3;&#x7801;</a></li><ul><li><span class="title-icon "></span><a href="#examplesinteroperabilitymaingo"><b>5.1. </b>examples/interoperability/main.go</a></li><ul><li><span class="title-icon "></span><a href="#&#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;-native-go"><b>5.1.1. </b>&#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;: native go</a></li><li><span class="title-icon "></span><a href="#&#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;-tengo&#x811A;&#x672C;"><b>5.1.2. </b>&#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;: tengo&#x811A;&#x672C;</a></li><li><span class="title-icon "></span><a href="#native-go&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x811A;&#x672C;&#x7684;&#x9ED1;&#x9B54;&#x6CD5;"><b>5.1.3. </b>native go&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x811A;&#x672C;&#x7684;&#x9ED1;&#x9B54;&#x6CD5;</a></li><li><span class="title-icon "></span><a href="#&#x603B;&#x7ED3;"><b>5.1.4. </b>&#x603B;&#x7ED3;</a></li></ul><li><span class="title-icon "></span><a href="#tengo&#x9501;"><b>5.2. </b>tengo&#x9501;</a></li><li><span class="title-icon "></span><a href="#tengo&#x5E76;&#x53D1;"><b>5.3. </b>tengo&#x5E76;&#x53D1;</a></li><li><span class="title-icon "></span><a href="#&#x4EE3;&#x7801;&#x7EC4;&#x7EC7;"><b>5.4. </b>&#x4EE3;&#x7801;&#x7EC4;&#x7EC7;:</a></li><ul><li><span class="title-icon "></span><a href="#&#x603B;&#x7ED3;_1"><b>5.4.1. </b>&#x603B;&#x7ED3;</a></li><li><span class="title-icon "></span><a href="#errorgo"><b>5.4.2. </b>error.go</a></li><li><span class="title-icon "></span><a href="#requirerequirego"><b>5.4.3. </b>require/require.go</a></li><li><span class="title-icon "></span><a href="#parseropcodesgo"><b>5.4.4. </b>parser/opcodes.go</a></li><li><span class="title-icon "></span><a href="#parsersourcefilego"><b>5.4.5. </b>parser/source_file.go</a></li><li><span class="title-icon "></span><a href="#parserparsergo"><b>5.4.6. </b>parser/parser.go</a></li><li><span class="title-icon "></span><a href="#formattergo"><b>5.4.7. </b>formatter.go</a></li><li><span class="title-icon "></span><a href="#tengogo"><b>5.4.8. </b>tengo.go</a></li><li><span class="title-icon "></span><a href="#scriptgo"><b>5.4.9. </b>script.go</a></li><li><span class="title-icon "></span><a href="#variablego"><b>5.4.10. </b>variable.go</a></li><li><span class="title-icon "></span><a href="#builtinsgo"><b>5.4.11. </b>builtins.go</a></li><li><span class="title-icon "></span><a href="#compilergo"><b>5.4.12. </b>compiler.go</a></li><li><span class="title-icon "></span><a href="#modulesgo"><b>5.4.13. </b>modules.go</a></li><li><span class="title-icon "></span><a href="#symboltablego"><b>5.4.14. </b>symbol_table.go</a></li><li><span class="title-icon "></span><a href="#vmgo"><b>5.4.15. </b>vm.go</a></li><li><span class="title-icon "></span><a href="#stdlibfunctypedefsgo"><b>5.4.16. </b>stdlib/func_typedefs.go</a></li></ul></ul><li><span class="title-icon "></span><a href="#tengo&#x7684;&#x540E;&#x7EE7;"><b>6. </b>tengo&#x7684;&#x540E;&#x7EE7;</a></li><li><span class="title-icon "></span><a href="#tengo"><b>7. </b>tengo</a></li><ul><li><span class="title-icon "></span><a href="#&#x5165;&#x95E8;"><b>7.1. </b>&#x5165;&#x95E8;</a></li><li><span class="title-icon "></span><a href="#&#x8BED;&#x6CD5;"><b>7.2. </b>&#x8BED;&#x6CD5;</a></li><ul><li><span class="title-icon "></span><a href="#token"><b>7.2.1. </b>token</a></li></ul><li><span class="title-icon "></span><a href="#&#x4E00;&#x4E2A;go&#x8C03;&#x811A;&#x672C;&#x7684;&#x4F8B;&#x5B50;"><b>7.3. </b>&#x4E00;&#x4E2A;go&#x8C03;&#x811A;&#x672C;&#x7684;&#x4F8B;&#x5B50;</a></li><ul><li><span class="title-icon "></span><a href="#&#x6240;&#x6709;&#x90FD;&#x662F;&#x503C;&#x7C7B;&#x578B;"><b>7.3.1. </b>&#x6240;&#x6709;&#x90FD;&#x662F;&#x503C;&#x7C7B;&#x578B;</a></li><li><span class="title-icon "></span><a href="#tengo&#x503C;&#x7C7B;&#x578B;&#x548C;go&#x7C7B;&#x578B;"><b>7.3.2. </b>tengo&#x503C;&#x7C7B;&#x578B;&#x548C;go&#x7C7B;&#x578B;</a></li><li><span class="title-icon "></span><a href="#error&#x5347;&#x7EA7;&#x4E3A;&#x4E00;&#x7B49;&#x7C7B;&#x578B;"><b>7.3.3. </b>error&#x5347;&#x7EA7;&#x4E3A;&#x4E00;&#x7B49;&#x7C7B;&#x578B;</a></li><li><span class="title-icon "></span><a href="#&#x503C;&#x4E0D;&#x53EF;&#x53D8;"><b>7.3.4. </b>&#x503C;&#x4E0D;&#x53EF;&#x53D8;</a></li><li><span class="title-icon "></span><a href="#&#x672A;&#x5B9A;&#x4E49;&#x4E5F;&#x662F;&#x4E00;&#x79CD;&#x7C7B;&#x578B;"><b>7.3.5. </b>&#x672A;&#x5B9A;&#x4E49;&#x4E5F;&#x662F;&#x4E00;&#x79CD;&#x7C7B;&#x578B;</a></li><li><span class="title-icon "></span><a href="#&#x5E7F;&#x4E49;&#x7684;array&#x548C;map"><b>7.3.6. </b>&#x5E7F;&#x4E49;&#x7684;array&#x548C;map</a></li><li><span class="title-icon "></span><a href="#&#x51FD;&#x6570;&#x4E5F;&#x662F;&#x503C;-&#x4E00;&#x7B49;&#x516C;&#x6C11;-&#x652F;&#x6301;&#x95ED;&#x5305;"><b>7.3.7. </b>&#x51FD;&#x6570;&#x4E5F;&#x662F;&#x503C;, &#x4E00;&#x7B49;&#x516C;&#x6C11;, &#x652F;&#x6301;&#x95ED;&#x5305;</a></li><li><span class="title-icon "></span><a href="#&#x53D8;&#x91CF;scope"><b>7.3.8. </b>&#x53D8;&#x91CF;scope</a></li><li><span class="title-icon "></span><a href="#&#x5185;&#x7F6E;&#x7C7B;&#x578B;&#x8F6C;&#x6362;"><b>7.3.9. </b>&#x5185;&#x7F6E;&#x7C7B;&#x578B;&#x8F6C;&#x6362;</a></li><li><span class="title-icon "></span><a href="#&#x652F;&#x6301;&#x4E09;&#x76EE;&#x64CD;&#x4F5C;"><b>7.3.10. </b>&#x652F;&#x6301;&#x4E09;&#x76EE;&#x64CD;&#x4F5C;</a></li><li><span class="title-icon "></span><a href="#&#x548C;&#x80FD;&#x4F5C;&#x7528;&#x4E8E;&#x590D;&#x5408;&#x7C7B;&#x578B;array-map-string&#x548C;bytes"><b>7.3.11. </b>[]&#x548C;.&#x80FD;&#x4F5C;&#x7528;&#x4E8E;&#x590D;&#x5408;&#x7C7B;&#x578B;:array map string&#x548C;bytes</a></li><li><span class="title-icon "></span><a href="#&#x518D;&#x5207;&#x7247;&#x548C;go&#x4E00;&#x6837;"><b>7.3.12. </b>&#x518D;&#x5207;&#x7247;&#x548C;go&#x4E00;&#x6837;</a></li><li><span class="title-icon "></span><a href="#if&#x652F;&#x6301;&#x524D;&#x7F6E;&#x6267;&#x884C;&#x8BED;&#x53E5;-&#x548C;go&#x4E00;&#x6837;-for&#x7684;&#x7ED3;&#x6784;&#x4E5F;&#x548C;go&#x4E00;&#x6837;&#x6837;&#x7684;-for&#x652F;&#x6301;-for-in"><b>7.3.13. </b>if&#x652F;&#x6301;&#x524D;&#x7F6E;&#x6267;&#x884C;&#x8BED;&#x53E5;, &#x548C;go&#x4E00;&#x6837;; for&#x7684;&#x7ED3;&#x6784;&#x4E5F;&#x548C;go&#x4E00;&#x6837;&#x6837;&#x7684;; for&#x652F;&#x6301; for in</a></li><li><span class="title-icon "></span><a href="#&#x5176;&#x4ED6;&#x548C;native-go&#x7684;&#x4E0D;&#x540C;&#x70B9;"><b>7.3.14. </b>&#x5176;&#x4ED6;&#x548C;native go&#x7684;&#x4E0D;&#x540C;&#x70B9;</a></li></ul><li><span class="title-icon "></span><a href="#&#x5185;&#x7F6E;&#x51FD;&#x6570;"><b>7.4. </b>&#x5185;&#x7F6E;&#x51FD;&#x6570;</a></li><li><span class="title-icon "></span><a href="#&#x88AB;&#x5D4C;&#x5165;&#x6267;&#x884C;"><b>7.5. </b>&#x88AB;&#x5D4C;&#x5165;&#x6267;&#x884C;</a></li><ul><li><span class="title-icon "></span><a href="#&#x76F4;&#x63A5;&#x4EE3;&#x7801;&#x6267;&#x884C;"><b>7.5.1. </b>&#x76F4;&#x63A5;&#x4EE3;&#x7801;&#x6267;&#x884C;</a></li><li><span class="title-icon "></span><a href="#&#x4EE3;&#x7801;&#x5B9E;&#x65F6;&#x7F16;&#x8BD1;&#x540E;&#x6267;&#x884C;"><b>7.5.2. </b>&#x4EE3;&#x7801;&#x5B9E;&#x65F6;&quot;&#x7F16;&#x8BD1;&quot;&#x540E;&#x6267;&#x884C;</a></li><li><span class="title-icon "></span><a href="#&#x5916;&#x90E8;&#x4EE3;&#x7801;&#x91CC;import"><b>7.5.3. </b>&#x5916;&#x90E8;&#x4EE3;&#x7801;&#x91CC;import</a></li></ul><li><span class="title-icon "></span><a href="#&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;"><b>7.6. </b>&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;</a></li><ul><li><span class="title-icon "></span><a href="#&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x4E3E;&#x4F8B;"><b>7.6.1. </b>&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x4E3E;&#x4F8B;</a></li><li><span class="title-icon "></span><a href="#&#x589E;&#x52A0;&#x66F4;&#x591A;&#x529F;&#x80FD;"><b>7.6.2. </b>&#x589E;&#x52A0;&#x66F4;&#x591A;&#x529F;&#x80FD;</a></li><li><span class="title-icon "></span><a href="#&#x603B;&#x7ED3;_3"><b>7.6.3. </b>&#x603B;&#x7ED3;</a></li></ul><li><span class="title-icon "></span><a href="#&#x6A21;&#x5757;&#x5316;&#x548C;&#x6807;&#x51C6;&#x5E93;"><b>7.7. </b>&#x6A21;&#x5757;&#x5316;&#x548C;&#x6807;&#x51C6;&#x5E93;</a></li><ul><li><span class="title-icon "></span><a href="#&#x6807;&#x51C6;&#x5E93;"><b>7.7.1. </b>&#x6807;&#x51C6;&#x5E93;</a></li></ul><li><span class="title-icon "></span><a href="#runtime&#x5BF9;&#x8C61;&#x7C7B;&#x578B;"><b>7.8. </b>runtime&#x5BF9;&#x8C61;&#x7C7B;&#x578B;</a></li><li><span class="title-icon "></span><a href="#&#x5B89;&#x5168;&#x6027;"><b>7.9. </b>&#x5B89;&#x5168;&#x6027;</a></li><li><span class="title-icon "></span><a href="#&#x5E76;&#x53D1;"><b>7.10. </b>&#x5E76;&#x53D1;</a></li><li><span class="title-icon "></span><a href="#&#x8FD9;&#x91CC;&#x8BF4;&#x7684;vm&#x611F;&#x89C9;&#x5C31;&#x662F;&#x7F16;&#x8BD1;&#x540E;&#x7684;&#x8868;&#x8FBE;&#x6811;"><b>7.11. </b>&#x8FD9;&#x91CC;&#x8BF4;&#x7684;VM&#x611F;&#x89C9;&#x5C31;&#x662F;&#x7F16;&#x8BD1;&#x540E;&#x7684;&quot;&#x8868;&#x8FBE;&#x6811;&quot;?</a></li><ul><li><span class="title-icon "></span><a href="#&#x5B98;&#x65B9;&#x4F8B;&#x5B50;"><b>7.11.1. </b>&#x5B98;&#x65B9;&#x4F8B;&#x5B50;</a></li></ul><li><span class="title-icon "></span><a href="#&#x66F4;&#x591A;&#x5B98;&#x65B9;&#x4F8B;&#x5B50;"><b>7.12. </b>&#x66F4;&#x591A;&#x5B98;&#x65B9;&#x4F8B;&#x5B50;</a></li><ul><li><span class="title-icon "></span><a href="#gento&#x4EE3;&#x7801;&#x8F6C;&#x6210;lua"><b>7.12.1. </b>gento&#x4EE3;&#x7801;&#x8F6C;&#x6210;lua</a></li><li><span class="title-icon "></span><a href="#&#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;"><b>7.12.2. </b>&#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;</a></li></ul></ul></ul></div><a href="#&#x589E;&#x52A0;vm&#x7684;&#x5E76;&#x53D1;run" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><ul>
<li><a href="#&#x589E;&#x52A0;vm&#x7684;&#x5E76;&#x53D1;run">&#x589E;&#x52A0;VM&#x7684;&#x5E76;&#x53D1;run</a><ul>
<li><a href="#&#x7F16;&#x8BD1;&#x51FD;&#x6570;">&#x7F16;&#x8BD1;&#x51FD;&#x6570;</a></li>
<li><a href="#vm&#x6267;&#x884C;&#x51FD;&#x6570;">VM&#x6267;&#x884C;&#x51FD;&#x6570;</a></li>
<li><a href="#&#x51FD;&#x6570;&#x600E;&#x4E48;&#x8C03;&#x7528;&#x7684;">&#x51FD;&#x6570;&#x600E;&#x4E48;&#x8C03;&#x7528;&#x7684;?</a><ul>
<li><a href="#&#x7F16;&#x8BD1;&#x9636;&#x6BB5;">&#x7F16;&#x8BD1;&#x9636;&#x6BB5;</a></li>
<li><a href="#&#x6267;&#x884C;&#x9636;&#x6BB5;">&#x6267;&#x884C;&#x9636;&#x6BB5;</a></li>
</ul>
</li>
<li><a href="#&#x51FD;&#x6570;&#x600E;&#x4E48;&#x9000;&#x51FA;&#x7684;">&#x51FD;&#x6570;&#x600E;&#x4E48;&#x9000;&#x51FA;&#x7684;?</a></li>
<li><a href="#&#x5982;&#x4F55;&#x7406;&#x89E3;&#x5B57;&#x8282;&#x7801;">&#x5982;&#x4F55;&#x7406;&#x89E3;&#x5B57;&#x8282;&#x7801;?</a></li>
<li><a href="#&#x8FD0;&#x884C;&#x65F6;&#x4F1A;&#x6539;&#x53D8;&#x589E;&#x52A0;&#x5220;&#x9664;-global&#x6216;constant&#x6570;&#x7EC4;&#x5417;">&#x8FD0;&#x884C;&#x65F6;&#x4F1A;&#x6539;&#x53D8;/&#x589E;&#x52A0;/&#x5220;&#x9664; global&#x6216;constant&#x6570;&#x7EC4;&#x5417;?</a></li>
<li><a href="#compiledfunction&#x7684;free&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x6570;&#x7EC4;&#x662F;&#x5E72;&#x4EC0;&#x4E48;&#x7684;">CompiledFunction&#x7684;Free&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x6570;&#x7EC4;&#x662F;&#x5E72;&#x4EC0;&#x4E48;&#x7684;?</a><ul>
<li><a href="#&#x8FD0;&#x884C;&#x9636;&#x6BB5;">&#x8FD0;&#x884C;&#x9636;&#x6BB5;</a></li>
<li><a href="#&#x7ED3;&#x8BBA;">&#x7ED3;&#x8BBA;</a></li>
</ul>
</li>
<li><a href="#&#x4F8B;&#x5B50;">&#x4F8B;&#x5B50;</a></li>
</ul>
</li>
<li><a href="#tengo&#x6307;&#x4EE4;&#x96C6;&#x548C;go&#x7684;&#x64CD;&#x4F5C;&#x7801;">tengo&#x6307;&#x4EE4;&#x96C6;&#x548C;go&#x7684;&#x64CD;&#x4F5C;&#x7801;</a></li>
<li><a href="#tengo&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;">tengo&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;</a><ul>
<li><a href="#&#x521D;&#x59CB;&#x72B6;&#x6001;">&#x521D;&#x59CB;&#x72B6;&#x6001;</a></li>
<li><a href="#a--1-&#x540E;"><code>a := 1</code> &#x540E;</a></li>
<li><a href="#b--2-&#x540E;"><code>b := 2</code> &#x540E;</a></li>
<li><a href="#c--ab-&#x540E;"><code>c := a+b</code> &#x540E;</a></li>
<li><a href="#f--funca-b--return-a--b--&#x540E;"><code>f := func(a, b) { return a + b }</code> &#x540E;</a></li>
<li><a href="#formatconstants&#x51FD;&#x6570;">FormatConstants&#x51FD;&#x6570;</a></li>
<li><a href="#&#x90A3;&#x4E48;&#x4EC0;&#x4E48;&#x662F;constant">&#x90A3;&#x4E48;&#x4EC0;&#x4E48;&#x662F;constant?</a><ul>
<li><a href="#constants&#x5728;&#x4F55;&#x5904;&#x4F7F;&#x7528;-&#x5728;&#x4F55;&#x5904;&#x5B9A;&#x4E49;">constants&#x5728;&#x4F55;&#x5904;&#x4F7F;&#x7528;, &#x5728;&#x4F55;&#x5904;&#x5B9A;&#x4E49;</a></li>
<li><a href="#&#x4E3A;&#x4EC0;&#x4E48;constants&#x8981;&#x4F20;&#x9012;&#x7ED9;newcompiler">&#x4E3A;&#x4EC0;&#x4E48;constants&#x8981;&#x4F20;&#x9012;&#x7ED9;NewCompiler?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#extension">extension</a><ul>
<li><a href="#&#x4E3A;&#x4EC0;&#x4E48;extensionuserfunction&#x4E0D;&#x751F;&#x6548;----&#x6CE8;&#x610F;copy&#x65B9;&#x6CD5;">&#x4E3A;&#x4EC0;&#x4E48;extension.UserFunction&#x4E0D;&#x751F;&#x6548;? -- &#x6CE8;&#x610F;Copy()&#x65B9;&#x6CD5;</a><ul>
<li><a href="#&#x8C03;&#x67E5;">&#x8C03;&#x67E5;</a></li>
<li><a href="#&#x7ED3;&#x8BBA;-1">&#x7ED3;&#x8BBA;</a></li>
</ul>
</li>
<li><a href="#bash">bash</a><ul>
<li><a href="#&#x80FD;&#x591F;&#x5728;bash&#x7684;&#x547D;&#x4EE4;&#x91CC;&#x5F15;&#x7528;&#x811A;&#x672C;&#x7684;&#x53D8;&#x91CF;&#x5417;">&#x80FD;&#x591F;&#x5728;bash&#x7684;&#x547D;&#x4EE4;&#x91CC;&#x5F15;&#x7528;&#x811A;&#x672C;&#x7684;&#x53D8;&#x91CF;&#x5417;?</a><ul>
<li><a href="#&#x89E3;&#x51B3;&#x65B9;&#x6CD5;">&#x89E3;&#x51B3;&#x65B9;&#x6CD5;</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#&#x6DFB;&#x52A0;&#x65B0;&#x7684;builtin&#x51FD;&#x6570;ex">&#x6DFB;&#x52A0;&#x65B0;&#x7684;builtin&#x51FD;&#x6570;ex()</a><ul>
<li><a href="#&#x80FD;&#x5426;&#x6DFB;&#x52A0;&#x5230;builtinfuncs&#x8868;">&#x80FD;&#x5426;&#x6DFB;&#x52A0;&#x5230;builtinFuncs&#x8868;</a></li>
<li><a href="#&#x6DFB;&#x52A0;&#x5230;global&#x8868;">&#x6DFB;&#x52A0;&#x5230;global&#x8868;</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#tengo&#x4EE3;&#x7801;">tengo&#x4EE3;&#x7801;</a><ul>
<li><a href="#examplesinteroperabilitymaingo">examples/interoperability/main.go</a><ul>
<li><a href="#&#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;-native-go">&#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;: native go</a></li>
<li><a href="#&#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;-tengo&#x811A;&#x672C;">&#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;: tengo&#x811A;&#x672C;</a></li>
<li><a href="#native-go&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x811A;&#x672C;&#x7684;&#x9ED1;&#x9B54;&#x6CD5;">native go&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x811A;&#x672C;&#x7684;&#x9ED1;&#x9B54;&#x6CD5;</a><ul>
<li><a href="#dlv&#x8C03;&#x67E5;">dlv&#x8C03;&#x67E5;</a></li>
<li><a href="#&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x9B54;&#x6CD5;&#x63ED;&#x79D8;">&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x9B54;&#x6CD5;&#x63ED;&#x79D8;</a></li>
<li><a href="#&#x4F7F;&#x7528;&#x6CE8;&#x610F;">&#x4F7F;&#x7528;&#x6CE8;&#x610F;</a></li>
</ul>
</li>
<li><a href="#&#x603B;&#x7ED3;">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#tengo&#x9501;">tengo&#x9501;</a></li>
<li><a href="#tengo&#x5E76;&#x53D1;">tengo&#x5E76;&#x53D1;</a></li>
<li><a href="#&#x4EE3;&#x7801;&#x7EC4;&#x7EC7;">&#x4EE3;&#x7801;&#x7EC4;&#x7EC7;:</a><ul>
<li><a href="#&#x603B;&#x7ED3;-1">&#x603B;&#x7ED3;</a></li>
<li><a href="#errorgo">error.go</a></li>
<li><a href="#requirerequirego">require/require.go</a></li>
<li><a href="#parseropcodesgo">parser/opcodes.go</a></li>
<li><a href="#parsersource_filego">parser/source_file.go</a></li>
<li><a href="#parserparsergo">parser/parser.go</a><ul>
<li><a href="#newparser&#x51FD;&#x6570;">NewParser()&#x51FD;&#x6570;</a></li>
<li><a href="#parsefile&#x51FD;&#x6570;">ParseFile()&#x51FD;&#x6570;</a></li>
</ul>
</li>
<li><a href="#formattergo">formatter.go</a><ul>
<li><a href="#pool&#x5BF9;&#x8C61;&#x6C60;&#x6280;&#x672F;">Pool&#x5BF9;&#x8C61;&#x6C60;&#x6280;&#x672F;</a></li>
</ul>
</li>
<li><a href="#tengogo">tengo.go</a><ul>
<li><a href="#frominterface&#x548C;tointerface&#x51FD;&#x6570;&#x662F;go&#x548C;&#x811A;&#x672C;&#x4EA4;&#x4E92;&#x7684;&#x6838;&#x5FC3;"><code>FromInterface()</code>&#x548C;<code>ToInterface()</code>&#x51FD;&#x6570;&#x662F;go&#x548C;&#x811A;&#x672C;&#x4EA4;&#x4E92;&#x7684;&#x6838;&#x5FC3;</a></li>
<li><a href="#&#x4EC0;&#x4E48;&#x662F;callable&#x5BF9;&#x8C61;">&#x4EC0;&#x4E48;&#x662F;callable&#x5BF9;&#x8C61;</a></li>
<li><a href="#countobjects&#x8FD9;&#x4E2A;&#x9012;&#x5F52;&#x51FD;&#x6570;&#x5199;&#x7684;&#x771F;&#x597D;"><code>CountObjects</code>&#x8FD9;&#x4E2A;&#x9012;&#x5F52;&#x51FD;&#x6570;&#x5199;&#x7684;&#x771F;&#x597D;</a></li>
</ul>
</li>
<li><a href="#scriptgo">script.go</a><ul>
<li><a href="#scriptadd&#x7528;&#x4E8E;&#x4ECE;native-go&#x6DFB;&#x52A0;&#x53D8;&#x91CF;&#x5230;tengo&#x811A;&#x672C;">Script.Add&#x7528;&#x4E8E;&#x4ECE;native go&#x6DFB;&#x52A0;&#x53D8;&#x91CF;&#x5230;tengo&#x811A;&#x672C;</a></li>
<li><a href="#newscript">NewScript</a></li>
<li><a href="#compile&#x51FD;&#x6570;">Compile&#x51FD;&#x6570;</a></li>
<li><a href="#precompile&#x51FD;&#x6570;">preCompile()&#x51FD;&#x6570;</a></li>
<li><a href="#removeduplicates&#x53BB;&#x6389;&#x91CD;&#x590D;&#x5E38;&#x91CF;">RemoveDuplicates()&#x53BB;&#x6389;&#x91CD;&#x590D;&#x5E38;&#x91CF;?</a></li>
<li><a href="#runcontext&#x51FD;&#x6570;">RunContext()&#x51FD;&#x6570;</a></li>
<li><a href="#run&#x51FD;&#x6570;">Run&#x51FD;&#x6570;</a></li>
</ul>
</li>
<li><a href="#variablego">variable.go</a></li>
<li><a href="#builtinsgo">builtins.go</a></li>
<li><a href="#compilergo">compiler.go</a><ul>
<li><a href="#compile&#x51FD;&#x6570;-1">Compile()&#x51FD;&#x6570;</a></li>
<li><a href="#emit&#x51FD;&#x6570;">emit()&#x51FD;&#x6570;</a></li>
<li><a href="#compile&#x4E4B;module">Compile&#x4E4B;module</a></li>
<li><a href="#compilemodule&#x51FD;&#x6570;">compileModule()&#x51FD;&#x6570;</a></li>
<li><a href="#module&#x9ED8;&#x8BA4;&#x8DEF;&#x5F84;">module&#x9ED8;&#x8BA4;&#x8DEF;&#x5F84;</a></li>
<li><a href="#bytecode&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x7F16;&#x8BD1;&#x597D;&#x7684;&#x5B57;&#x8282;&#x7801;">Bytecode()&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x7F16;&#x8BD1;&#x597D;&#x7684;&#x5B57;&#x8282;&#x7801;</a></li>
</ul>
</li>
<li><a href="#modulesgo">modules.go</a><ul>
<li><a href="#module&#x7C7B;&#x578B;-&#x652F;&#x6301;import-native-go&#x5BF9;&#x8C61;&#x548C;tengo&#x4EE3;&#x7801;">module&#x7C7B;&#x578B;: &#x652F;&#x6301;import native go&#x5BF9;&#x8C61;&#x548C;tengo&#x4EE3;&#x7801;</a></li>
</ul>
</li>
<li><a href="#symbol_tablego">symbol_table.go</a><ul>
<li><a href="#newsymboltable&#x51FD;&#x6570;">NewSymbolTable()&#x51FD;&#x6570;</a></li>
<li><a href="#define&#x51FD;&#x6570;">Define()&#x51FD;&#x6570;</a></li>
<li><a href="#builtin&#x7B26;&#x53F7;&#x9664;&#x4E86;&#x4FDD;&#x5B58;&#x5728;store&#x4E2D;-&#x8FD8;&#x4FDD;&#x5B58;&#x5728;&#x5355;&#x72EC;&#x7684;builtinsymbols&#x4E2D;">builtin&#x7B26;&#x53F7;&#x9664;&#x4E86;&#x4FDD;&#x5B58;&#x5728;store&#x4E2D;, &#x8FD8;&#x4FDD;&#x5B58;&#x5728;&#x5355;&#x72EC;&#x7684;builtinSymbols&#x4E2D;</a></li>
<li><a href="#fork&#x51FD;&#x6570;">Fork()&#x51FD;&#x6570;</a></li>
<li><a href="#resolve&#x51FD;&#x6570;">Resolve()&#x51FD;&#x6570;</a></li>
<li><a href="#&#x603B;&#x7ED3;-2">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#vmgo">vm.go</a><ul>
<li><a href="#vm-new&#x51FD;&#x6570;">VM New&#x51FD;&#x6570;</a></li>
<li><a href="#vm-run&#x51FD;&#x6570;">VM Run&#x51FD;&#x6570;</a></li>
<li><a href="#vmrun&#x603B;&#x7ED3;">vm.run&#x603B;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#stdlibfunc_typedefsgo">stdlib/func_typedefs.go</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#tengo&#x7684;&#x540E;&#x7EE7;">tengo&#x7684;&#x540E;&#x7EE7;</a></li>
<li><a href="#tengo">tengo</a><ul>
<li><a href="#&#x5165;&#x95E8;">&#x5165;&#x95E8;</a></li>
<li><a href="#&#x8BED;&#x6CD5;">&#x8BED;&#x6CD5;</a><ul>
<li><a href="#token">token</a></li>
</ul>
</li>
<li><a href="#&#x4E00;&#x4E2A;go&#x8C03;&#x811A;&#x672C;&#x7684;&#x4F8B;&#x5B50;">&#x4E00;&#x4E2A;go&#x8C03;&#x811A;&#x672C;&#x7684;&#x4F8B;&#x5B50;</a><ul>
<li><a href="#&#x6240;&#x6709;&#x90FD;&#x662F;&#x503C;&#x7C7B;&#x578B;">&#x6240;&#x6709;&#x90FD;&#x662F;&#x503C;&#x7C7B;&#x578B;</a></li>
<li><a href="#tengo&#x503C;&#x7C7B;&#x578B;&#x548C;go&#x7C7B;&#x578B;">tengo&#x503C;&#x7C7B;&#x578B;&#x548C;go&#x7C7B;&#x578B;</a></li>
<li><a href="#error&#x5347;&#x7EA7;&#x4E3A;&#x4E00;&#x7B49;&#x7C7B;&#x578B;">error&#x5347;&#x7EA7;&#x4E3A;&#x4E00;&#x7B49;&#x7C7B;&#x578B;</a></li>
<li><a href="#&#x503C;&#x4E0D;&#x53EF;&#x53D8;">&#x503C;&#x4E0D;&#x53EF;&#x53D8;</a></li>
<li><a href="#&#x672A;&#x5B9A;&#x4E49;&#x4E5F;&#x662F;&#x4E00;&#x79CD;&#x7C7B;&#x578B;">&#x672A;&#x5B9A;&#x4E49;&#x4E5F;&#x662F;&#x4E00;&#x79CD;&#x7C7B;&#x578B;</a></li>
<li><a href="#&#x5E7F;&#x4E49;&#x7684;array&#x548C;map">&#x5E7F;&#x4E49;&#x7684;array&#x548C;map</a></li>
<li><a href="#&#x51FD;&#x6570;&#x4E5F;&#x662F;&#x503C;-&#x4E00;&#x7B49;&#x516C;&#x6C11;-&#x652F;&#x6301;&#x95ED;&#x5305;">&#x51FD;&#x6570;&#x4E5F;&#x662F;&#x503C;, &#x4E00;&#x7B49;&#x516C;&#x6C11;, &#x652F;&#x6301;&#x95ED;&#x5305;</a></li>
<li><a href="#&#x53D8;&#x91CF;scope">&#x53D8;&#x91CF;scope</a></li>
<li><a href="#&#x5185;&#x7F6E;&#x7C7B;&#x578B;&#x8F6C;&#x6362;">&#x5185;&#x7F6E;&#x7C7B;&#x578B;&#x8F6C;&#x6362;</a></li>
<li><a href="#&#x652F;&#x6301;&#x4E09;&#x76EE;&#x64CD;&#x4F5C;">&#x652F;&#x6301;&#x4E09;&#x76EE;&#x64CD;&#x4F5C;</a></li>
<li><a href="#&#x548C;&#x80FD;&#x4F5C;&#x7528;&#x4E8E;&#x590D;&#x5408;&#x7C7B;&#x578B;array-map-string&#x548C;bytes"><code>[]</code>&#x548C;<code>.</code>&#x80FD;&#x4F5C;&#x7528;&#x4E8E;&#x590D;&#x5408;&#x7C7B;&#x578B;:array map string&#x548C;bytes</a></li>
<li><a href="#&#x518D;&#x5207;&#x7247;&#x548C;go&#x4E00;&#x6837;">&#x518D;&#x5207;&#x7247;&#x548C;go&#x4E00;&#x6837;</a></li>
<li><a href="#if&#x652F;&#x6301;&#x524D;&#x7F6E;&#x6267;&#x884C;&#x8BED;&#x53E5;-&#x548C;go&#x4E00;&#x6837;-for&#x7684;&#x7ED3;&#x6784;&#x4E5F;&#x548C;go&#x4E00;&#x6837;&#x6837;&#x7684;-for&#x652F;&#x6301;-for-in">if&#x652F;&#x6301;&#x524D;&#x7F6E;&#x6267;&#x884C;&#x8BED;&#x53E5;, &#x548C;go&#x4E00;&#x6837;; for&#x7684;&#x7ED3;&#x6784;&#x4E5F;&#x548C;go&#x4E00;&#x6837;&#x6837;&#x7684;; for&#x652F;&#x6301; for in</a></li>
<li><a href="#&#x5176;&#x4ED6;&#x548C;native-go&#x7684;&#x4E0D;&#x540C;&#x70B9;">&#x5176;&#x4ED6;&#x548C;native go&#x7684;&#x4E0D;&#x540C;&#x70B9;</a></li>
</ul>
</li>
<li><a href="#&#x5185;&#x7F6E;&#x51FD;&#x6570;">&#x5185;&#x7F6E;&#x51FD;&#x6570;</a></li>
<li><a href="#&#x88AB;&#x5D4C;&#x5165;&#x6267;&#x884C;">&#x88AB;&#x5D4C;&#x5165;&#x6267;&#x884C;</a><ul>
<li><a href="#&#x76F4;&#x63A5;&#x4EE3;&#x7801;&#x6267;&#x884C;">&#x76F4;&#x63A5;&#x4EE3;&#x7801;&#x6267;&#x884C;</a></li>
<li><a href="#&#x4EE3;&#x7801;&#x5B9E;&#x65F6;&#x7F16;&#x8BD1;&#x540E;&#x6267;&#x884C;">&#x4EE3;&#x7801;&#x5B9E;&#x65F6;&quot;&#x7F16;&#x8BD1;&quot;&#x540E;&#x6267;&#x884C;</a></li>
<li><a href="#&#x5916;&#x90E8;&#x4EE3;&#x7801;&#x91CC;import">&#x5916;&#x90E8;&#x4EE3;&#x7801;&#x91CC;import</a></li>
</ul>
</li>
<li><a href="#&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;">&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;</a><ul>
<li><a href="#&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x4E3E;&#x4F8B;">&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x4E3E;&#x4F8B;</a></li>
<li><a href="#&#x589E;&#x52A0;&#x66F4;&#x591A;&#x529F;&#x80FD;">&#x589E;&#x52A0;&#x66F4;&#x591A;&#x529F;&#x80FD;</a></li>
<li><a href="#&#x603B;&#x7ED3;-3">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#&#x6A21;&#x5757;&#x5316;&#x548C;&#x6807;&#x51C6;&#x5E93;">&#x6A21;&#x5757;&#x5316;&#x548C;&#x6807;&#x51C6;&#x5E93;</a><ul>
<li><a href="#&#x6807;&#x51C6;&#x5E93;">&#x6807;&#x51C6;&#x5E93;</a></li>
</ul>
</li>
<li><a href="#runtime&#x5BF9;&#x8C61;&#x7C7B;&#x578B;">runtime&#x5BF9;&#x8C61;&#x7C7B;&#x578B;</a></li>
<li><a href="#&#x5B89;&#x5168;&#x6027;">&#x5B89;&#x5168;&#x6027;</a></li>
<li><a href="#&#x5E76;&#x53D1;">&#x5E76;&#x53D1;</a></li>
<li><a href="#&#x8FD9;&#x91CC;&#x8BF4;&#x7684;vm&#x611F;&#x89C9;&#x5C31;&#x662F;&#x7F16;&#x8BD1;&#x540E;&#x7684;&#x8868;&#x8FBE;&#x6811;">&#x8FD9;&#x91CC;&#x8BF4;&#x7684;VM&#x611F;&#x89C9;&#x5C31;&#x662F;&#x7F16;&#x8BD1;&#x540E;&#x7684;&quot;&#x8868;&#x8FBE;&#x6811;&quot;?</a><ul>
<li><a href="#&#x5B98;&#x65B9;&#x4F8B;&#x5B50;">&#x5B98;&#x65B9;&#x4F8B;&#x5B50;</a></li>
</ul>
</li>
<li><a href="#&#x66F4;&#x591A;&#x5B98;&#x65B9;&#x4F8B;&#x5B50;">&#x66F4;&#x591A;&#x5B98;&#x65B9;&#x4F8B;&#x5B50;</a><ul>
<li><a href="#gento&#x4EE3;&#x7801;&#x8F6C;&#x6210;lua">gento&#x4EE3;&#x7801;&#x8F6C;&#x6210;lua</a></li>
<li><a href="#&#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;">&#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="&#x589E;&#x52A0;vm&#x7684;&#x5E76;&#x53D1;run"><a name="&#x589E;&#x52A0;vm&#x7684;&#x5E76;&#x53D1;run" class="anchor-navigation-ex-anchor" href="#&#x589E;&#x52A0;vm&#x7684;&#x5E76;&#x53D1;run"><i class="fa fa-link" aria-hidden="true"></i></a>1. &#x589E;&#x52A0;VM&#x7684;&#x5E76;&#x53D1;run</h1>
<p>&#x601D;&#x8DEF;&#x662F;&#x6D45;&#x62F7;&#x8D1D;&#x5F53;&#x524D;&#x7684;VM, &#x6765;run&#x4E00;&#x4E2A;compiledFunc</p>
<h2 id="&#x7F16;&#x8BD1;&#x51FD;&#x6570;"><a name="&#x7F16;&#x8BD1;&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#&#x7F16;&#x8BD1;&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>1.1. &#x7F16;&#x8BD1;&#x51FD;&#x6570;</h2>
<p>&#x5728;<code>compiler.go</code>&#x4E2D;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Compile compiles the AST node.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiler<span class="token punctuation">)</span> <span class="token function">Compile</span><span class="token punctuation">(</span>node parser<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>FuncLit<span class="token punctuation">:</span> <span class="token comment">//&#x51FD;&#x6570;&#x7F16;&#x8BD1;</span>
        c<span class="token punctuation">.</span><span class="token function">enterScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>Params<span class="token punctuation">.</span>List <span class="token punctuation">{</span>
            s <span class="token operator">:=</span> c<span class="token punctuation">.</span>symbolTable<span class="token punctuation">.</span><span class="token function">Define</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>

            <span class="token comment">// function arguments is not assigned directly.</span>
            s<span class="token punctuation">.</span>LocalAssigned <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>

        <span class="token comment">// code optimization</span>
        c<span class="token punctuation">.</span><span class="token function">optimizeFunc</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>

        freeSymbols <span class="token operator">:=</span> c<span class="token punctuation">.</span>symbolTable<span class="token punctuation">.</span><span class="token function">FreeSymbols</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//FreeSymbols&#x51FD;&#x6570;&#x8FD4;&#x56DE;&quot;&#x539F;&#x59CB;&quot;symbol, &#x5373;&#x88AB;&#x6355;&#x83B7;&#x7684;symbol, &#x6240;&#x4EE5;&#x624D;&#x5305;&#x542B;ScopeLocal&#x548C;ScopeFree&#x4E24;&#x4E2A;&#x7C7B;&#x578B;</span>
        numLocals <span class="token operator">:=</span> c<span class="token punctuation">.</span>symbolTable<span class="token punctuation">.</span><span class="token function">MaxSymbols</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        instructions<span class="token punctuation">,</span> sourceMap <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">leaveScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> s <span class="token operator">:=</span> <span class="token keyword">range</span> freeSymbols <span class="token punctuation">{</span> <span class="token comment">//&#x8FD9;&#x6BB5;&#x6CA1;&#x770B;&#x660E;&#x767D;, &#x8FD9;&#x91CC;&#x5DF2;&#x7ECF;&#x662F;&#x7236;&#x51FD;&#x6570;scope, OpGetFreePtr&#x5230;&#x6808;&#x4E0A;? -- &#x662F;&#x7684;. &#x5728;&#x5B9A;&#x4E49;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x628A;&#x5B50;&#x51FD;&#x6570;&#x7684;free&#x53D8;&#x91CF;&#x5168;&#x90E8;&#x653E;&#x5230;&#x6808;&#x4E0A;&#x5907;&#x7528;. &#x5BF9;&#x5E94;VM&#x7684;OpClosure&#x4F1A;&#x628A;&#x8FD9;&#x4E9B;free&#x53D8;&#x91CF;&#x653E;&#x5230;&#x5176;</span>
            <span class="token keyword">switch</span> s<span class="token punctuation">.</span>Scope <span class="token punctuation">{</span>
            <span class="token keyword">case</span> ScopeLocal<span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token operator">!</span>s<span class="token punctuation">.</span>LocalAssigned <span class="token punctuation">{</span>
                    c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpNull<span class="token punctuation">)</span>
                    c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpDefineLocal<span class="token punctuation">,</span> s<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
                    s<span class="token punctuation">.</span>LocalAssigned <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
                c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetLocalPtr<span class="token punctuation">,</span> s<span class="token punctuation">.</span>Index<span class="token punctuation">)</span> <span class="token comment">//&#x6355;&#x83B7;&#x4E86;&#x7236;&#x51FD;&#x6570;&#x7684;local&#x53D8;&#x91CF;, s.Index&#x662F;local&#x53D8;&#x91CF;&#x5728;&#x6808;&#x4E0A;&#x76F8;&#x5BF9;basePointer&#x7684;index</span>
            <span class="token keyword">case</span> ScopeFree<span class="token punctuation">:</span>
                c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetFreePtr<span class="token punctuation">,</span> s<span class="token punctuation">.</span>Index<span class="token punctuation">)</span> <span class="token comment">//&#x6355;&#x83B7;&#x4E86;&#x7236;&#x51FD;&#x6570;&#x7684;free&#x53D8;&#x91CF;, index&#x662F;&#x7236;&#x51FD;&#x6570;freeVar&#x6570;&#x7EC4;&#x4E2D;&#x7684;index</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        compiledFunction <span class="token operator">:=</span> <span class="token operator">&amp;</span>CompiledFunction<span class="token punctuation">{</span>
            Instructions<span class="token punctuation">:</span>  instructions<span class="token punctuation">,</span>
            NumLocals<span class="token punctuation">:</span>     numLocals<span class="token punctuation">,</span>
            NumParameters<span class="token punctuation">:</span> <span class="token function">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>Params<span class="token punctuation">.</span>List<span class="token punctuation">)</span><span class="token punctuation">,</span>
            VarArgs<span class="token punctuation">:</span>       node<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>Params<span class="token punctuation">.</span>VarArgs<span class="token punctuation">,</span>
            SourceMap<span class="token punctuation">:</span>     sourceMap<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>freeSymbols<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpClosure<span class="token punctuation">,</span>
                c<span class="token punctuation">.</span><span class="token function">addConstant</span><span class="token punctuation">(</span>compiledFunction<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>freeSymbols<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpConstant<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">addConstant</span><span class="token punctuation">(</span>compiledFunction<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>CallExpr<span class="token punctuation">:</span> <span class="token comment">//&#x51FD;&#x6570;&#x8C03;&#x7528;</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Func<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>Args <span class="token punctuation">{</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        ellipsis <span class="token operator">:=</span> <span class="token number">0</span>
        <span class="token keyword">if</span> node<span class="token punctuation">.</span>Ellipsis<span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ellipsis <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
        c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpCall<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Args<span class="token punctuation">)</span><span class="token punctuation">,</span> ellipsis<span class="token punctuation">)</span> <span class="token comment">//OpCall&#x64CD;&#x4F5C;&#x7801;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="vm&#x6267;&#x884C;&#x51FD;&#x6570;"><a name="vm&#x6267;&#x884C;&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#vm&#x6267;&#x884C;&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>1.2. VM&#x6267;&#x884C;&#x51FD;&#x6570;</h2>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpCall<span class="token punctuation">:</span>
            numArgs <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            spread <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            v<span class="token punctuation">.</span>ip <span class="token operator">+=</span> <span class="token number">2</span> <span class="token comment">//&#x5BF9;&#x5E94;&#x7F16;&#x8BD1;&#x9636;&#x6BB5;&#x7684;emit Opcall, &#x53C2;&#x6570;&#x4E2A;&#x6570;, &#x662F;&#x5426;&#x53D8;&#x957F;</span>

            <span class="token comment">//&#x6BD4;&#x5982;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#x7684;func, &#x6808;&#x662F;</span>
            <span class="token comment">//sp--&gt;|      |</span>
            <span class="token comment">//sp-1 | arg1 |</span>
            <span class="token comment">//sp-2 | arg0 |</span>
            <span class="token comment">//sp-3 | func |</span>
            value <span class="token operator">:=</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>numArgs<span class="token punctuation">]</span> <span class="token comment">//sp-3&#x7684;object&#x5C31;&#x662F;func</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>value<span class="token punctuation">.</span><span class="token function">CanCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                v<span class="token punctuation">.</span>err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not callable: %s&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> spread <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span> <span class="token comment">//&#x5982;&#x679C;&#x6700;&#x540E;&#x7684;&#x53C2;&#x6570;&#x662F;&#x53D8;&#x957F;&#x7684;, &#x5219;&#x90A3;&#x4E2A;object&#x5FC5;&#x7136;&#x662F;array; &#x628A;array&#x7684;&#x6210;&#x5458;&#x90FD;&#x5C55;&#x5F00;&#x5230;&#x6808;&#x4E0A;, &#x6808;&#x5411;&#x4E0A;&#x589E;&#x957F;. &#x66F4;&#x65B0;numArgs&#x7684;&#x503C;</span>
                v<span class="token punctuation">.</span>sp<span class="token operator">--</span>
                <span class="token keyword">switch</span> arr <span class="token operator">:=</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token operator">*</span>Array<span class="token punctuation">:</span>
                    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> arr<span class="token punctuation">.</span>Value <span class="token punctuation">{</span>
                        v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> item
                        v<span class="token punctuation">.</span>sp<span class="token operator">++</span>
                    <span class="token punctuation">}</span>
                    numArgs <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>Value<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
                <span class="token keyword">case</span> <span class="token operator">*</span>ImmutableArray<span class="token punctuation">:</span>
                    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> arr<span class="token punctuation">.</span>Value <span class="token punctuation">{</span>
                        v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> item
                        v<span class="token punctuation">.</span>sp<span class="token operator">++</span>
                    <span class="token punctuation">}</span>
                    numArgs <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>Value<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
                <span class="token keyword">default</span><span class="token punctuation">:</span>
                    v<span class="token punctuation">.</span>err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not an array: %s&quot;</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> callee<span class="token punctuation">,</span> ok <span class="token operator">:=</span> value<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>CompiledFunction<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
                <span class="token keyword">if</span> callee<span class="token punctuation">.</span>VarArgs <span class="token punctuation">{</span>
                    <span class="token comment">// if the closure is variadic,</span>
                    <span class="token comment">// roll up all variadic parameters into an array</span>
                    realArgs <span class="token operator">:=</span> callee<span class="token punctuation">.</span>NumParameters <span class="token operator">-</span> <span class="token number">1</span>
                    varArgs <span class="token operator">:=</span> numArgs <span class="token operator">-</span> realArgs
                    <span class="token keyword">if</span> varArgs <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                        numArgs <span class="token operator">=</span> realArgs <span class="token operator">+</span> <span class="token number">1</span>
                        args <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">,</span> varArgs<span class="token punctuation">)</span>
                        spStart <span class="token operator">:=</span> v<span class="token punctuation">.</span>sp <span class="token operator">-</span> varArgs
                        <span class="token keyword">for</span> i <span class="token operator">:=</span> spStart<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> v<span class="token punctuation">.</span>sp<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
                            args<span class="token punctuation">[</span>i<span class="token operator">-</span>spStart<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                        <span class="token punctuation">}</span>
                        v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>spStart<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>Array<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> args<span class="token punctuation">}</span> <span class="token comment">//&#x8FD9;&#x91CC;&#x7684;&#x64CD;&#x505A;&#x770B;&#x8D77;&#x6765;&#x548C;&#x4E0A;&#x9762;&#x5728;&#x6808;&#x4E0A;&#x5C55;&#x5F00;array&#x6B63;&#x597D;&#x76F8;&#x53CD;, &#x628A;&#x6808;&#x4E0A;&#x5C55;&#x5F00;&#x540E;&#x7684;&#x53D8;&#x957F;&#x53C2;&#x6570;&#x4EEC;&#x8FD8;&#x539F;&#x56DE;array, &#x518D;&#x653E;&#x5230;&#x6808;&#x4E0A;. -- &#x4E3A;&#x5565;&#x8FD9;&#x6837;&#x641E;? -- &#x56E0;&#x4E3A;&#x8981;&#x517C;&#x5BB9;&#x8C03;&#x7528;native go&#x4EE3;&#x7801;&#x7684;&#x5F62;&#x5F0F;, native go&#x91CC;&#x9762;, &#x53C2;&#x6570;&#x90FD;&#x662F;&#x53D8;&#x957F;&#x4F20;&#x5165;&#x7684;.</span>
                        v<span class="token punctuation">.</span>sp <span class="token operator">=</span> spStart <span class="token operator">+</span> <span class="token number">1</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> numArgs <span class="token operator">!=</span> callee<span class="token punctuation">.</span>NumParameters <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> callee<span class="token punctuation">.</span>VarArgs <span class="token punctuation">{</span>
                        v<span class="token punctuation">.</span>err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;wrong number of arguments: want&gt;=%d, got=%d&quot;</span><span class="token punctuation">,</span>
                            callee<span class="token punctuation">.</span>NumParameters<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> numArgs<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        v<span class="token punctuation">.</span>err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;wrong number of arguments: want=%d, got=%d&quot;</span><span class="token punctuation">,</span>
                            callee<span class="token punctuation">.</span>NumParameters<span class="token punctuation">,</span> numArgs<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// test if it&apos;s tail-call</span>
                <span class="token keyword">if</span> callee <span class="token operator">==</span> v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>fn <span class="token punctuation">{</span> <span class="token comment">// recursion</span>
                    nextOp <span class="token operator">:=</span> v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
                    <span class="token keyword">if</span> nextOp <span class="token operator">==</span> parser<span class="token punctuation">.</span>OpReturn <span class="token operator">||</span>
                        <span class="token punctuation">(</span>nextOp <span class="token operator">==</span> parser<span class="token punctuation">.</span>OpPop <span class="token operator">&amp;&amp;</span>
                            parser<span class="token punctuation">.</span>OpReturn <span class="token operator">==</span> v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">for</span> p <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> p <span class="token operator">&lt;</span> numArgs<span class="token punctuation">;</span> p<span class="token operator">++</span> <span class="token punctuation">{</span>
                            v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>basePointer<span class="token operator">+</span>p<span class="token punctuation">]</span> <span class="token operator">=</span>
                                v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span>numArgs<span class="token operator">+</span>p<span class="token punctuation">]</span>
                        <span class="token punctuation">}</span>
                        v<span class="token punctuation">.</span>sp <span class="token operator">-=</span> numArgs <span class="token operator">+</span> <span class="token number">1</span>
                        v<span class="token punctuation">.</span>ip <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">// reset IP to beginning of the frame</span>
                        <span class="token keyword">continue</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> v<span class="token punctuation">.</span>framesIndex <span class="token operator">&gt;=</span> MaxFrames <span class="token punctuation">{</span>
                    v<span class="token punctuation">.</span>err <span class="token operator">=</span> ErrStackOverflow
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// update call frame</span>
                v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>ip <span class="token operator">=</span> v<span class="token punctuation">.</span>ip <span class="token comment">// store current ip before call</span>
                v<span class="token punctuation">.</span>curFrame <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>frames<span class="token punctuation">[</span>v<span class="token punctuation">.</span>framesIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//framesIndex&#x662F;&#x63D0;&#x524D;++&#x7684;, &#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x4E0B;&#x4E00;&#x4E2A;frame</span>
                v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>fn <span class="token operator">=</span> callee
                v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>freeVars <span class="token operator">=</span> callee<span class="token punctuation">.</span>Free
                v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>basePointer <span class="token operator">=</span> v<span class="token punctuation">.</span>sp <span class="token operator">-</span> numArgs <span class="token comment">//&#x5E27;&#x6307;&#x9488;&#x7684;&#x521D;&#x503C;&#x662F;sp&#x7684;&#x5F53;&#x524D;&#x503C;&#x51CF;&#x53BB;&#x53C2;&#x6570;&#x4E2A;&#x6570;</span>
                v<span class="token punctuation">.</span>curInsts <span class="token operator">=</span> callee<span class="token punctuation">.</span>Instructions
                v<span class="token punctuation">.</span>ip <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
                v<span class="token punctuation">.</span>framesIndex<span class="token operator">++</span>
                v<span class="token punctuation">.</span>sp <span class="token operator">=</span> v<span class="token punctuation">.</span>sp <span class="token operator">-</span> numArgs <span class="token operator">+</span> callee<span class="token punctuation">.</span>NumLocals <span class="token comment">//&#x7ED9;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x7559;&#x597D;&#x7A7A;&#x95F4;, callee.NumLocals&#x5305;&#x62EC;&#x4E86;arg&#x7684;&#x4E2A;&#x6570;</span>
            <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4E3E;&#x4F8B;, &#x6BD4;&#x5982;2&#x4E2A;arg&#x548C;4&#x4E2A;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x7684;&#x6808;&#x7684;&#x521D;&#x59CB;&#x60C5;&#x51B5;</p>
<pre class="language-"><code>                    |             | <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>--</span> <span class="token attr-name">v.sp(frame</span> <span class="token attr-name">n)</span>
                    <span class="token attr-name">|</span> <span class="token attr-name">local</span> <span class="token attr-name">obj</span> <span class="token attr-name">3</span> <span class="token attr-name">|</span>
                    <span class="token attr-name">|</span> <span class="token attr-name">local</span> <span class="token attr-name">obj</span> <span class="token attr-name">2</span> <span class="token attr-name">|</span>
                    <span class="token attr-name">|</span> <span class="token attr-name">local</span> <span class="token attr-name">obj</span> <span class="token attr-name">1</span> <span class="token attr-name">|</span>
<span class="token attr-name">v.sp(frame</span> <span class="token attr-name">n-1)</span> <span class="token attr-name">--</span><span class="token punctuation">&gt;</span></span> | local obj 0 |
                    | arg obj 1   |
                    | arg obj 0   | &lt;-- v.curFrame.basePointer
</code></pre><h2 id="&#x51FD;&#x6570;&#x600E;&#x4E48;&#x8C03;&#x7528;&#x7684;"><a name="&#x51FD;&#x6570;&#x600E;&#x4E48;&#x8C03;&#x7528;&#x7684;" class="anchor-navigation-ex-anchor" href="#&#x51FD;&#x6570;&#x600E;&#x4E48;&#x8C03;&#x7528;&#x7684;"><i class="fa fa-link" aria-hidden="true"></i></a>1.3. &#x51FD;&#x6570;&#x600E;&#x4E48;&#x8C03;&#x7528;&#x7684;?</h2>
<p>&#x6BD4;&#x5982;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;</p>
<pre class="language-"><code class="lang-go">fn <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> i<span class="token operator">+</span><span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token operator">...</span>

res <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">//res=6</span>
</code></pre>
<p>&#x662F;&#x5982;&#x4F55;&#x7F16;&#x8BD1;&#x6267;&#x884C;&#x7684;?</p>
<h3 id="&#x7F16;&#x8BD1;&#x9636;&#x6BB5;"><a name="&#x7F16;&#x8BD1;&#x9636;&#x6BB5;" class="anchor-navigation-ex-anchor" href="#&#x7F16;&#x8BD1;&#x9636;&#x6BB5;"><i class="fa fa-link" aria-hidden="true"></i></a>1.3.1. &#x7F16;&#x8BD1;&#x9636;&#x6BB5;</h3>
<ol>
<li>&#x7F16;&#x8BD1;&#x5668;&#x53D1;&#x73B0;&#x662F;<code>case *parser.FuncLit:</code>, &#x5C31;&#x7F16;&#x8BD1;<code>func(i) { return i+1 }</code>, &#x751F;&#x6210;<code>compiledFunction</code>&#x5BF9;&#x8C61;, &#x5E76;&#x628A;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x653E;&#x5230;constant&#x6570;&#x7EC4;&#x91CC;, emit OpConstant&#x64CD;&#x4F5C;&#x7801;: <code>c.emit(node, parser.OpConstant, c.addConstant(compiledFunction))</code>; &#x5982;&#x679C;&#x662F;&#x95ED;&#x5305;&#x51FD;&#x6570;, emit <code>parser.OpClosure</code>&#x64CD;&#x505A;&#x7801;.</li>
<li>tengo&#x4E0D;&#x652F;&#x6301;&#x58F0;&#x660E;&#x51FD;&#x6570;, &#x800C;&#x662F;&#x7528;&#x8D4B;&#x503C;&#x6A21;&#x5F0F;. &#x90A3;&#x4E48;&#x4E0A;&#x9762;&#x4E00;&#x6B65;&#x628A;<code>func(i) { return i+1 }</code>&#x7F16;&#x8BD1;&#x5B8C;&#x6210;&#x540E;, &#x628A;compiledFunction&#x5BF9;&#x8C61;&#x4FDD;&#x5B58;&#x5230;constant&#x6570;&#x7EC4;, &#x5E76;&#x9A6C;&#x4E0A;&#x653E;&#x5230;&#x6808;&#x4E0A;. &#x56E0;&#x4E3A;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;&#x8D4B;&#x503C;&#x64CD;&#x505A;</li>
<li>&#x7F16;&#x8BD1;&#x5668;&#x53D1;&#x73B0;&#x63A5;&#x4E0B;&#x6765;&#x9A6C;&#x4E0A;&#x662F;<code>case *parser.AssignStmt:</code>&#x5BF9;<code>fn</code>&#x53D8;&#x91CF;&#x8D4B;&#x503C;: &#x5728;&#x786E;&#x5B9A;<code>fn</code>&#x7684;&#x7B26;&#x53F7;&#x4F4D;&#x7F6E;&#x540E;, &#x53D1;&#x9001;&#x64CD;&#x4F5C;&#x7801;&#x5230;&#x5B57;&#x8282;&#x7801;:<pre class="language-"><code class="lang-go">c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpSetGlobal<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
<span class="token comment">//&#x6216;</span>
c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpSetLocal<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
<span class="token comment">//&#x6216;</span>
c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpSetFree<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
</code></pre>
</li>
<li>&#x73B0;&#x5728;&#x5047;&#x8BBE;&#x4EE3;&#x7801;&#x8FD0;&#x884C;&#x5230;&#x67D0;&#x5904;, &#x9700;&#x8981;&#x8C03;&#x7528;fn:<code>res := fn(5)</code>. &#x7F16;&#x8BD1;&#x5668;&#x9700;&#x8981;&#x5148;&#x89E3;&#x6790;fn&#x8FD9;&#x4E2A;&#x7B26;&#x53F7;. &#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;fn&#x5C31;&#x662F;&#x7B26;&#x53F7;&#x5F15;&#x7528;, &#x4F46;&#x66F4;&#x590D;&#x6742;&#x7684;&#x60C5;&#x51B5;&#x53EF;&#x4EE5;&#x662F;<code>res := someMap.fn(5)</code>, &#x4E0B;&#x9762;<code>c.Compile(node.Func)</code>&#x5C31;&#x662F;&#x89E3;&#x6790;&#x8FD9;&#x4E2A;&#x8868;&#x8FBE;&#x5F0F;, &#x6700;&#x7EC8;get&#x5230;&#x8FD9;&#x4E2A;compiledFunction&#x5BF9;&#x8C61;fn:<br>&#x8FD9;&#x91CC;&#x9762;&#x5305;&#x62EC;&#x4E24;&#x4E2A;&#x8FC7;&#x7A0B;:  <ul>
<li>4.1. &#x5148;&#x628A;fn&#x653E;&#x5230;&#x6808;&#x4E0A;</li>
<li>4.2. &#x4F9D;&#x6B21;&#x7F16;&#x8BD1;args, &#x628A;&#x7ED3;&#x679C;args&#x5BF9;&#x8C61;&#x4F9D;&#x6B21;&#x653E;&#x5230;&#x6808;&#x4E0A;<pre class="language-"><code class="lang-go"><span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>CallExpr<span class="token punctuation">:</span>
   <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Func<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">//&#x6700;&#x7EC8;&#x5BF9;&#x5E94;*parser.Ident&#x6765;&#x786E;&#x5B9A;&#x7B26;&#x53F7;, &#x5BF9;&#x5E94;emit&#x7684;&#x64CD;&#x505A;&#x7801;&#x662F;OpGetGlobal&#x6216;OpGetLocal&#x6216;OpGetBuiltin&#x6216;OpGetFree, &#x6548;&#x679C;&#x662F;&#x628A;compiledFunction&#x5BF9;&#x8C61;fn&#x653E;&#x5230;&#x6808;&#x4E0A;</span>
       <span class="token keyword">return</span> err
   <span class="token punctuation">}</span>
   <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>Args <span class="token punctuation">{</span> <span class="token comment">//&#x6BD4;&#x5982;&#x8FD9;&#x91CC;&#x7684;arg&#x5C31;&#x662F;5, &#x5B83;&#x662F;&#x4E2A;*parser.IntLit, &#x5BF9;&#x5E94;emit&#x64CD;&#x4F5C;&#x7801;OpConstant, &#x628A;5&#x653E;&#x5230;&#x6808;&#x4E0A;</span>
       <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> err
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   ellipsis <span class="token operator">:=</span> <span class="token number">0</span>
   <span class="token keyword">if</span> node<span class="token punctuation">.</span>Ellipsis<span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       ellipsis <span class="token operator">=</span> <span class="token number">1</span>
   <span class="token punctuation">}</span>
   c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpCall<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Args<span class="token punctuation">)</span><span class="token punctuation">,</span> ellipsis<span class="token punctuation">)</span> <span class="token comment">//&#x6700;&#x540E;emit OpCall</span>
</code></pre>
&#x6BD4;&#x5982;<pre class="language-"><code>       //&#x6BD4;&#x5982;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#x7684;func, &#x6808;&#x662F;
       //sp--&gt;|      |
       //sp-1 | arg1 |
       //sp-2 | arg0 |
       //sp-3 | func |
</code></pre></li>
</ul>
</li>
</ol>
<h3 id="&#x6267;&#x884C;&#x9636;&#x6BB5;"><a name="&#x6267;&#x884C;&#x9636;&#x6BB5;" class="anchor-navigation-ex-anchor" href="#&#x6267;&#x884C;&#x9636;&#x6BB5;"><i class="fa fa-link" aria-hidden="true"></i></a>1.3.2. &#x6267;&#x884C;&#x9636;&#x6BB5;</h3>
<p>VM&#x8D1F;&#x8D23;&#x6267;&#x884C;</p>
<ol>
<li><p>&#x5BF9;&#x5E94;&#x7F16;&#x8BD1;&#x9636;&#x6BB5;&#x7684;&#x524D;&#x4E09;&#x6B65;, VM&#x6267;&#x884C;<code>fn := func(i) { return i+1 }</code>, &#x6548;&#x679C;&#x662F;&#x628A;fn&#x8FD9;&#x4E2A;compiledFunction&#x5BF9;&#x8C61;&#x5148;&#x4E34;&#x65F6;&#x4FDD;&#x5B58;&#x5728;<code>v.stack[v.sp-1]</code>&#x4E2D;, &#x518D;&#x6839;&#x636E;&#x53D8;&#x91CF;scope, &#x4FDD;&#x5B58;&#x5728;&#x4E0B;&#x9762;&#x4E09;&#x79CD;&#x53D8;&#x91CF;&#x533A;&#x7684;&#x4E00;&#x4E2A;</p>
<ul>
<li>&#x5168;&#x5C40;&#x5BF9;&#x8C61;&#x533A;, &#x5373;vm&#x7684;globals&#x6570;&#x7EC4;&#x4E2D;</li>
<li>&#x6808;&#x4E2D;: &#x56E0;&#x4E3A;&#x4E0A;&#x4E00;&#x6B65;&#x5DF2;&#x7ECF;&#x628A;fn&#x653E;&#x5728;&#x4E86;<code>v.stack[v.sp-1]</code>, &#x8FD9;&#x91CC;&#x505A;&#x7684;&#x5C31;&#x662F;&#x628A;<code>v.stack[v.sp-1]</code>&#x8D4B;&#x503C;&#x7ED9;<code>v.stack[v.curFrame.basePointer + localIndex]</code>. &#x8FD9;&#x4E2A;localIndex&#x662F;&#x64CD;&#x505A;&#x7801;&#x91CC;&#x6307;&#x5B9A;&#x7684;, &#x7F16;&#x8BD1;&#x9636;&#x6BB5;&#x5C31;&#x77E5;&#x9053;&#x4E86;</li>
<li>frame&#x7684;free&#x6570;&#x7EC4;&#x4E2D;: <code>*v.curFrame.freeVars[freeIndex].Value = v.stack[v.sp-1]</code></li>
</ul>
</li>
<li><p>VM&#x6267;&#x884C;&#x5230;&#x51FD;&#x6570;&#x6267;&#x884C;&#x9636;&#x6BB5;<code>res := fn(5)</code>&#x65F6;:
&#x5BF9;&#x5E94;<code>case parser.OpCall:</code></p>
<pre class="language-"><code>         //&#x6BD4;&#x5982;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#x7684;func, &#x6808;&#x662F;
         //sp--&gt;|      |
         //sp-1 | arg1 |
         //sp-2 | arg0 |
         //sp-3 | func |
</code></pre><p>&#x8FDB;&#x5165;&#x4E0B;&#x4E00;&#x4E2A;&#x6808;&#x5E27;&#x524D;, &#x505A;&#x51C6;&#x5907;:</p>
</li>
<li>&#x4FDD;&#x5B58;&#x5F53;&#x524D;ip&#x5230;&#x7236;&#x6808;&#x5E27;</li>
<li>&#x51C6;&#x5907;&#x7A7A;&#x7684;&#x6808;&#x5E27;, &#x6808;&#x5E27;&#x5207;&#x6362;&#x5230;&#x5B50;&#x51FD;&#x6570;</li>
<li>&#x5B50;&#x6808;&#x5E27;&#x7684;fn&#x4E3A;&#x5B50;&#x51FD;&#x6570;callee</li>
<li>&#x5B50;&#x6808;&#x5E27;&#x7684;freeVars&#x4E3A;callee.Free, &#x6B64;&#x65F6;callee.Free&#x91CC;&#x9762;&#x5DF2;&#x7ECF;&#x51C6;&#x5907;&#x597D;&#x4E86;</li>
<li>&#x56E0;&#x4E3A;&#x53C2;&#x6570;&#x662F;&#x7236;&#x6808;&#x5E27;&#x51C6;&#x5907;&#x7684;, &#x8FD9;&#x91CC;&#x5B50;&#x6808;&#x5E27;&#x7684;basePointer = v.sp - numArgs</li>
<li>&#x5B50;&#x6808;&#x5E27;&#x7684;&#x5B57;&#x8282;&#x7801;&#x4E3A;callee.Instructions</li>
<li>&#x5B50;&#x6808;&#x5E27;&#x7684;ip&#x4ECE;-1&#x5F00;&#x59CB;, &#x6B63;&#x597D;&#x4E0B;&#x4E00;&#x6B21;&#x4ECE;0&#x5F00;&#x59CB;&#x6267;&#x884C;</li>
<li>&#x628A;local&#x53D8;&#x91CF;&#x7684;&#x4F4D;&#x7F6E;&#x7559;&#x51FA;&#x6765;, &#x5B50;&#x6808;&#x5E27;&#x7684;sp&#x4ECE;local&#x53D8;&#x91CF;&#x533A;&#x9876;&#x90E8;&#x5F00;&#x59CB;.
&#x8FDB;&#x5165;&#x4E0B;&#x4E00;&#x4E2A;&#x6808;&#x5E27;, &#x4ECE;ip=0&#x5F00;&#x59CB;&#x6267;&#x884C;fn.Instructions</li>
</ol>
<pre class="language-"><code>                    |             | <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>--</span> <span class="token attr-name">v.sp(frame</span> <span class="token attr-name">n)</span>
                    <span class="token attr-name">|</span> <span class="token attr-name">local</span> <span class="token attr-name">obj</span> <span class="token attr-name">3</span> <span class="token attr-name">|</span>
                    <span class="token attr-name">|</span> <span class="token attr-name">local</span> <span class="token attr-name">obj</span> <span class="token attr-name">2</span> <span class="token attr-name">|</span>
                    <span class="token attr-name">|</span> <span class="token attr-name">local</span> <span class="token attr-name">obj</span> <span class="token attr-name">1</span> <span class="token attr-name">|</span>
<span class="token attr-name">v.sp(frame</span> <span class="token attr-name">n-1)</span> <span class="token attr-name">--</span><span class="token punctuation">&gt;</span></span> | local obj 0 |
                    | arg obj 1   |
                    | arg obj 0   | &lt;-- v.curFrame.basePointer
</code></pre><h2 id="&#x51FD;&#x6570;&#x600E;&#x4E48;&#x9000;&#x51FA;&#x7684;"><a name="&#x51FD;&#x6570;&#x600E;&#x4E48;&#x9000;&#x51FA;&#x7684;" class="anchor-navigation-ex-anchor" href="#&#x51FD;&#x6570;&#x600E;&#x4E48;&#x9000;&#x51FA;&#x7684;"><i class="fa fa-link" aria-hidden="true"></i></a>1.4. &#x51FD;&#x6570;&#x600E;&#x4E48;&#x9000;&#x51FA;&#x7684;?</h2>
<p>&#x5728;&#x7F16;&#x8BD1;&#x9636;&#x6BB5;, &#x7A7A;&#x7684;return&#x4F1A;<code>c.emit(node, parser.OpReturn, 0)</code>
return&#x4E00;&#x4E2A;&#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x60C5;&#x51B5;, &#x4F1A;&#x5148;&#x7F16;&#x8BD1;&#x8FD9;&#x4E2A;&#x8868;&#x8FBE;&#x5F0F;, &#x6700;&#x7EC8;&#x7684;&#x7ED3;&#x679C;&#x5BF9;&#x8C61;&#x653E;&#x5230;&#x6808;&#x9876;, &#x7136;&#x540E;<code>c.emit(node, parser.OpReturn, 1)</code></p>
<p>&#x6267;&#x884C;&#x9636;&#x6BB5;, &#x5982;&#x679C;&#x53D1;&#x73B0;OpReturn&#x7684;&#x7B2C;&#x4E8C;&#x4E2A;&#x64CD;&#x4F5C;&#x6570;&#x662F;1, &#x5C31;&#x4ECE;&#x6808;&#x4E0A;&#x62FF;&#x5230;&#x8FD4;&#x56DE;&#x503C;; &#x7136;&#x540E;&#x8FD8;&#x539F;&#x6808;&#x5E27;, &#x8FD8;&#x539F;sp, &#x5E76;&#x628A;&#x8FD4;&#x56DE;&#x503C;&#x653E;&#x5230;&#x6808;&#x9876;(&#x6B64;&#x65F6;&#x5DF2;&#x7ECF;&#x662F;&#x7236;&#x51FD;&#x6570;&#x7684;&#x6808;&#x4E86;).</p>
<h2 id="&#x5982;&#x4F55;&#x7406;&#x89E3;&#x5B57;&#x8282;&#x7801;"><a name="&#x5982;&#x4F55;&#x7406;&#x89E3;&#x5B57;&#x8282;&#x7801;" class="anchor-navigation-ex-anchor" href="#&#x5982;&#x4F55;&#x7406;&#x89E3;&#x5B57;&#x8282;&#x7801;"><i class="fa fa-link" aria-hidden="true"></i></a>1.5. &#x5982;&#x4F55;&#x7406;&#x89E3;&#x5B57;&#x8282;&#x7801;?</h2>
<p>&#x770B;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;<code>compiler_test.go</code></p>
<h2 id="&#x8FD0;&#x884C;&#x65F6;&#x4F1A;&#x6539;&#x53D8;&#x589E;&#x52A0;&#x5220;&#x9664;-global&#x6216;constant&#x6570;&#x7EC4;&#x5417;"><a name="&#x8FD0;&#x884C;&#x65F6;&#x4F1A;&#x6539;&#x53D8;&#x589E;&#x52A0;&#x5220;&#x9664;-global&#x6216;constant&#x6570;&#x7EC4;&#x5417;" class="anchor-navigation-ex-anchor" href="#&#x8FD0;&#x884C;&#x65F6;&#x4F1A;&#x6539;&#x53D8;&#x589E;&#x52A0;&#x5220;&#x9664;-global&#x6216;constant&#x6570;&#x7EC4;&#x5417;"><i class="fa fa-link" aria-hidden="true"></i></a>1.6. &#x8FD0;&#x884C;&#x65F6;&#x4F1A;&#x6539;&#x53D8;/&#x589E;&#x52A0;/&#x5220;&#x9664; global&#x6216;constant&#x6570;&#x7EC4;&#x5417;?</h2>
<p>&#x9996;&#x5148;, constant&#x6570;&#x7EC4;&#x662F;&#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x786E;&#x5B9A;&#x7684;, &#x5728;&#x8FD0;&#x884C;&#x65F6;&#x4E0D;&#x6539;&#x53D8;.
&#x5176;&#x6B21;, global&#x6570;&#x7EC4;&#x662F;&#x53EF;&#x4EE5;&#x66F4;&#x6539;&#x7684;, &#x4F46;&#x4E0D;&#x9700;&#x8981;&#x589E;&#x52A0;/&#x5220;&#x9664;, &#x56E0;&#x4E3A;&#x5BF9;global&#x7684;&#x64CD;&#x505A;&#x7684;index&#x662F;&#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x5C31;&#x786E;&#x5B9A;&#x7684;.</p>
<h2 id="compiledfunction&#x7684;free&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x6570;&#x7EC4;&#x662F;&#x5E72;&#x4EC0;&#x4E48;&#x7684;"><a name="compiledfunction&#x7684;free&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x6570;&#x7EC4;&#x662F;&#x5E72;&#x4EC0;&#x4E48;&#x7684;" class="anchor-navigation-ex-anchor" href="#compiledfunction&#x7684;free&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x6570;&#x7EC4;&#x662F;&#x5E72;&#x4EC0;&#x4E48;&#x7684;"><i class="fa fa-link" aria-hidden="true"></i></a>1.7. CompiledFunction&#x7684;Free&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x6570;&#x7EC4;&#x662F;&#x5E72;&#x4EC0;&#x4E48;&#x7684;?</h2>
<p>&#x5728;&#x7F16;&#x8BD1;&#x9636;&#x6BB5;, Resolve symbol&#x7684;&#x65F6;&#x5019;, &#x8FD9;&#x4E2A;symbol&#x53EF;&#x4EE5;&#x662F;global&#x7684;, &#x4E5F;&#x53EF;&#x4EE5;&#x662F;&#x81EA;&#x5DF1;&#x51FD;&#x6570;&#x5C40;&#x90E8;&#x7684;, &#x8FD8;&#x53EF;&#x4EE5;&#x662F;&#x7236;&#x7EA7;&#x51FD;&#x6570;&#x8DEF;&#x5F84;&#x4E0A;&#x7684;&#x5C40;&#x90E8;&#x51FD;&#x6570;. &#x6700;&#x540E;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x5C31;&#x662F;free&#x53D8;&#x91CF;.</p>
<blockquote>
<p>if symbol is defined in parent table and if it&apos;s not global/builtin then it&apos;s free variable.</p>
</blockquote>
<p>free&#x53D8;&#x91CF;&#x662F;&#x4E00;&#x8DEF;&#x7236;&#x51FD;&#x6570;&#x4E0A;&#x7684;&#x5C40;&#x90E8;&#x53D8;&#x91CF;, resolve&#x8981;&#x5316;&#x4E0D;&#x5C11;&#x4EE3;&#x4EF7;, &#x6240;&#x4EE5;&#x5728;&#x7F16;&#x8BD1;&#x751F;&#x6210;&#x51FD;&#x6570;&#x5BF9;&#x8C61;<code>CompiledFunction</code>&#x7684;&#x65F6;&#x5019;&#x5C31;&#x7528;<code>Free          []*ObjectPtr</code>&#x6765;&#x4FDD;&#x5B58;&#x5BF9;&quot;&#x6355;&#x83B7;&quot;&#x7684;&#x7236;&#x51FD;&#x6570;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x7684;&#x6307;&#x9488;. </p>
<h3 id="&#x8FD0;&#x884C;&#x9636;&#x6BB5;"><a name="&#x8FD0;&#x884C;&#x9636;&#x6BB5;" class="anchor-navigation-ex-anchor" href="#&#x8FD0;&#x884C;&#x9636;&#x6BB5;"><i class="fa fa-link" aria-hidden="true"></i></a>1.7.1. &#x8FD0;&#x884C;&#x9636;&#x6BB5;</h3>
<p>&#x53EA;&#x6709;&#x95ED;&#x5305;&#x51FD;&#x6570;&#x6709;free&#x53D8;&#x91CF;, &#x95ED;&#x5305;&#x5728;&#x7F16;&#x8BD1;&#x7684;&#x65F6;&#x5019;, emit&#x7684;&#x662F;OpClosure, &#x5728;&#x8FD9;&#x4E4B;&#x524D;free&#x53D8;&#x91CF;&#x5DF2;&#x7ECF;&#x4ECE;&#x7236;&#x51FD;&#x6570;&#x7684;local&#x533A;&#x548C;free&#x533A;&#x62F7;&#x8D1D;&#x5230;&#x6808;&#x4E0A;&#x4E86;.</p>
<pre class="language-"><code class="lang-go">        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>freeSymbols<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpClosure<span class="token punctuation">,</span>
                c<span class="token punctuation">.</span><span class="token function">addConstant</span><span class="token punctuation">(</span>compiledFunction<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>freeSymbols<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpConstant<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">addConstant</span><span class="token punctuation">(</span>compiledFunction<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>&#x90A3;&#x4E48;&#x8FD0;&#x884C;&#x65F6;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpClosure<span class="token punctuation">:</span>
    v<span class="token punctuation">.</span>ip <span class="token operator">+=</span> <span class="token number">3</span>
    constIndex <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span>
    numFree <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token punctuation">]</span><span class="token punctuation">)</span>
    fn<span class="token punctuation">,</span> ok <span class="token operator">:=</span> v<span class="token punctuation">.</span>constants<span class="token punctuation">[</span>constIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>CompiledFunction<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        v<span class="token punctuation">.</span>err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not function: %s&quot;</span><span class="token punctuation">,</span> fn<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    free <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>ObjectPtr<span class="token punctuation">,</span> numFree<span class="token punctuation">)</span> <span class="token comment">//&#x5206;&#x914D;free var&#x7684;&#x6570;&#x7EC4;</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numFree<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> freeVar <span class="token operator">:=</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span>numFree<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//&#x5DF2;&#x7ECF;&#x7531;&#x524D;&#x4E00;&#x4E2A;&#x64CD;&#x4F5C;&#x7801;(parser.FuncLit)&#x63D0;&#x524D;&#x628A;&#x6240;&#x6709;free&#x53D8;&#x91CF;&#x8FDE;&#x7EED;&#x7684;&#x653E;&#x5230;&#x6808;&#x4E0A;&#x4E86;. &#x8FD9;&#x91CC;&#x62F7;&#x8D1D;&#x5230;free&#x6570;&#x7EC4;</span>
        <span class="token keyword">case</span> <span class="token operator">*</span>ObjectPtr<span class="token punctuation">:</span>
            free<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> freeVar
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            free<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>ObjectPtr<span class="token punctuation">{</span>
                Value<span class="token punctuation">:</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span>numFree<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    v<span class="token punctuation">.</span>sp <span class="token operator">-=</span> numFree
    cl <span class="token operator">:=</span> <span class="token operator">&amp;</span>CompiledFunction<span class="token punctuation">{</span>
        Instructions<span class="token punctuation">:</span>  fn<span class="token punctuation">.</span>Instructions<span class="token punctuation">,</span>
        NumLocals<span class="token punctuation">:</span>     fn<span class="token punctuation">.</span>NumLocals<span class="token punctuation">,</span>
        NumParameters<span class="token punctuation">:</span> fn<span class="token punctuation">.</span>NumParameters<span class="token punctuation">,</span>
        VarArgs<span class="token punctuation">:</span>       fn<span class="token punctuation">.</span>VarArgs<span class="token punctuation">,</span>
        Free<span class="token punctuation">:</span>          free<span class="token punctuation">,</span> <span class="token comment">//&#x5230;&#x8FD9;&#x91CC;free&#x6570;&#x7EC4;&#x5DF2;&#x7ECF;ok</span>
    <span class="token punctuation">}</span>
    v<span class="token punctuation">.</span>allocs<span class="token operator">--</span>
    <span class="token keyword">if</span> v<span class="token punctuation">.</span>allocs <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        v<span class="token punctuation">.</span>err <span class="token operator">=</span> ErrObjectAllocLimit
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> cl
    v<span class="token punctuation">.</span>sp<span class="token operator">++</span>
</code></pre>
<p>OpClosure&#x64CD;&#x4F5C;&#x7801;&#x540E;&#x9762;&#x5E94;&#x8BE5;&#x662F;&#x63A5;&#x7740;&#x8D4B;&#x503C;&#x64CD;&#x505A;.</p>
<p>&#x8FD8;&#x6709;&#x51E0;&#x4E2A;case:</p>
<ul>
<li>OpGetFreePtr:&#x4ECE;freeVars&#x6570;&#x7EC4;&#x53D6;index&#x5BF9;&#x5E94;&#x7684;ptr&#x5230;&#x6808;&#x9876;</li>
<li>OpGetFree: &#x4ECE;freeVars&#x6570;&#x7EC4;&#x53D6;index&#x7684;ptr&#x7684;Value&#x5230;&#x6808;&#x9876;</li>
<li>OpSetFree: &#x6808;&#x9876;obj&#x8D4B;&#x503C;&#x7ED9;freeVars&#x6570;&#x7EC4;index&#x5BF9;&#x5E94;&#x7684;ptr, &#x6CE8;&#x610F;&#x662F;&#x8D4B;&#x503C;&#x7ED9;<code>*ptr</code></li>
<li>OpGetLocalPtr: &#x628A;&#x672C;frame&#x7684;&#x6307;&#x5B9A;local&#x53D8;&#x91CF;<code>v.stack[v.curFrame.basePointer + localIndex]</code>, &#x5C01;&#x88C5;&#x4E3A;<code>*ObjectPtr</code>, &#x653E;&#x5230;&#x6808;&#x9876;.</li>
<li>OpSetSelFree: &#x628A;selectors&#x5E8F;&#x5217;&#x5BF9;&#x5E94;&#x7684;&#x5BF9;&#x8C61;&#x4F9D;&#x6B21;&#x5199;&#x5165;v.curFrame.freeVars</li>
</ul>
<h3 id="&#x7ED3;&#x8BBA;"><a name="&#x7ED3;&#x8BBA;" class="anchor-navigation-ex-anchor" href="#&#x7ED3;&#x8BBA;"><i class="fa fa-link" aria-hidden="true"></i></a>1.7.2. &#x7ED3;&#x8BBA;</h3>
<ul>
<li>&#x5B50;&#x51FD;&#x6570;&#x53EF;&#x4EE5;&#x662F;&#x666E;&#x901A;&#x7684;&#x51FD;&#x6570;, &#x4E5F;&#x53EF;&#x4EE5;&#x662F;Closure, &#x4ED6;&#x4EEC;&#x90FD;&#x662F;compiledFunction. &#x533A;&#x522B;&#x5728;&#x4E8E;&#x51FD;&#x6570;&#x58F0;&#x660E;&#x540E;, &#x5FC5;&#x5B9A;&#x4F1A;&#x8D4B;&#x503C;&#x5230;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;. &#x5230;&#x53D8;&#x91CF;&#x8D4B;&#x503C;&#x8FD9;&#x91CC;&#x540E;, closure&#x7684;compiledFunction&#x7684;Free&#x57DF;&#x5C31;&#x6709;&#x503C;&#x4E86;, &#x8FD9;&#x4E9B;&#x503C;&#x662F;&#x6307;&#x9488;, &#x662F;&#x5BF9;free&#x53D8;&#x91CF;&#x7684;&#x6307;&#x9488;&#x8868;.</li>
<li>&#x95ED;&#x5305;&#x5BF9;free&#x53D8;&#x91CF;&#x7684;&#x8BBF;&#x95EE;&#x4E0D;&#x662F;&#x53BB;&#x7236;&#x51FD;&#x6570;&#x8DEF;&#x5F84;&#x4E0A;&#x7684;&#x6808;&#x91CC;&#x53BB;&#x627E;, &#x800C;&#x662F;&#x53BB;&#x81EA;&#x5DF1;&#x7684;free&#x53D8;&#x91CF;&#x7684;&#x6307;&#x9488;&#x8868;&#x91CC;&#x64CD;&#x505A;.</li>
</ul>
<h2 id="&#x4F8B;&#x5B50;"><a name="&#x4F8B;&#x5B50;" class="anchor-navigation-ex-anchor" href="#&#x4F8B;&#x5B50;"><i class="fa fa-link" aria-hidden="true"></i></a>1.8. &#x4F8B;&#x5B50;</h2>
<p>&#x6BD4;&#x5982;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;</p>
<pre class="language-"><code class="lang-go">f1 <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">func</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>args<span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span>f1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x4F1A;&#x88AB;&#x7F16;&#x8BD1;&#x6210;</p>
<pre class="language-"><code class="lang-go"><span class="token number">0000</span> CONST   <span class="token number">0</span>     <span class="token comment">//&#x5BF9;&#x5E94;&#x7B2C;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x4ECE;const 0&#x53D6;&#x5230;&#x6808;&#x9876;</span>
<span class="token number">0003</span> SETG    <span class="token number">0</span>     <span class="token comment">//&#x5BF9;&#x5E94;f1&#x7684;&#x8D4B;&#x503C;</span>
<span class="token number">0006</span> CONST   <span class="token number">1</span>     <span class="token comment">//&#x5BF9;&#x5E94;&#x7B2C;&#x4E8C;&#x4E2A;&#x51FD;&#x6570;&#x4ECE;const 1&#x53D6;&#x5230;&#x6808;&#x9876;</span>
<span class="token number">0009</span> GETG    <span class="token number">0</span>     <span class="token comment">//&#x5BF9;&#x5E94;f1&#x5165;&#x53C2;</span>
<span class="token number">0012</span> CONST   <span class="token number">2</span>     <span class="token comment">//&#x5BF9;&#x5E94;&#x5E38;&#x91CF;1&#x5165;&#x53C2;</span>
<span class="token number">0015</span> CONST   <span class="token number">3</span>     <span class="token comment">//&#x5BF9;&#x5E94;&#x5E38;&#x91CF;2&#x5165;&#x53C2;</span>
<span class="token number">0018</span> CALL    <span class="token number">3</span>     <span class="token number">0</span>     <span class="token comment">//&#x5BF9;&#x5E94;&#x51FD;&#x6570;&#x8C03;&#x7528;</span>
<span class="token number">0021</span> POP           <span class="token comment">//&#x5BF9;&#x5E94;&#x8FD9;&#x5757;&#x4EE3;&#x7801;&#x65E0;&#x8FD4;&#x56DE;&#x503C;</span>
<span class="token number">0022</span> SUSPEND       <span class="token comment">//&#x5BF9;&#x5E94;&#x8FD9;&#x5757;&#x4EE3;&#x7801;&#x7684;&#x7ED3;&#x675F;</span>
</code></pre>
<p>&#x5BF9;&#x5E94;&#x7684;const&#x6570;&#x7EC4;</p>
<pre class="language-"><code class="lang-go"><span class="token punctuation">[</span>  <span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>Compiled Function<span class="token operator">|</span><span class="token number">0xc0000946e8</span><span class="token punctuation">)</span>
     <span class="token number">0000</span> GETL    <span class="token number">0</span>    <span class="token comment">//&#x5BF9;&#x5E94;&#x5F97;&#x5230;&#x5165;&#x53C2;a</span>
     <span class="token number">0002</span> GETL    <span class="token number">1</span>    <span class="token comment">//&#x5BF9;&#x5E94;&#x5F97;&#x5230;&#x5165;&#x53C2;b</span>
     <span class="token number">0004</span> BINARYOP <span class="token number">11</span>  <span class="token comment">//a+b</span>
     <span class="token number">0006</span> RET     <span class="token number">1</span>    <span class="token comment">//return &#x503C;</span>
<span class="token punctuation">[</span>  <span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>Compiled Function<span class="token operator">|</span><span class="token number">0xc0000946f0</span><span class="token punctuation">)</span>
     <span class="token number">0000</span> GETL    <span class="token number">0</span>    <span class="token comment">//&#x5BF9;&#x5E94;&#x5F97;&#x5230;fn</span>
     <span class="token number">0002</span> GETL    <span class="token number">1</span>    <span class="token comment">//&#x5BF9;&#x5E94;&#x5E94;&#x8BE5;&#x4F20;&#x5165;&#x7684;args</span>
     <span class="token number">0004</span> CALL    <span class="token number">1</span>     <span class="token number">1</span>    <span class="token comment">//call&#x4E00;&#x4E2A;&#x53C2;&#x6570;, &#x6700;&#x540E;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x53D8;&#x957F;</span>
     <span class="token number">0007</span> RET     <span class="token number">1</span>    <span class="token comment">//return&#x6808;&#x4E0A;&#x7684;&#x503C;</span>
<span class="token punctuation">[</span>  <span class="token number">2</span><span class="token punctuation">]</span> <span class="token number">1</span> <span class="token punctuation">(</span>Int<span class="token operator">|</span><span class="token number">0xc0000fd1e0</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>  <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">2</span> <span class="token punctuation">(</span>Int<span class="token operator">|</span><span class="token number">0xc0000fd200</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="tengo&#x6307;&#x4EE4;&#x96C6;&#x548C;go&#x7684;&#x64CD;&#x4F5C;&#x7801;"><a name="tengo&#x6307;&#x4EE4;&#x96C6;&#x548C;go&#x7684;&#x64CD;&#x4F5C;&#x7801;" class="anchor-navigation-ex-anchor" href="#tengo&#x6307;&#x4EE4;&#x96C6;&#x548C;go&#x7684;&#x64CD;&#x4F5C;&#x7801;"><i class="fa fa-link" aria-hidden="true"></i></a>2. tengo&#x6307;&#x4EE4;&#x96C6;&#x548C;go&#x7684;&#x64CD;&#x4F5C;&#x7801;</h1>
<p>GO&#x7684;&#x7F16;&#x8BD1;&#x5668;&#x4E5F;&#x6709;&#x81EA;&#x5DF1;&#x4E00;&#x5957;&#x7684;&#x201D;&#x64CD;&#x4F5C;&#x7801;&#x201D;.  </p>
<p>&#x662F;&#x5BF9;&#x6240;&#x6709;CPU&#x6307;&#x4EE4;&#x96C6;&#x7684;common&#x62BD;&#x8C61;, &#x6BD4;&#x5982;&#x4E0B;&#x9762;&#x7684;CALL&#x5C31;&#x76F8;&#x5F53;&#x4E8E;MIPS&#x6307;&#x4EE4;&#x96C6;&#x7684;jal&#x6216;&#x8005;ARM&#x7684;blr</p>
<p>Tengo&#x7684;&#x6307;&#x4EE4;&#x7EA7;&#x6BD4;&#x8FD9;&#x4E2A;&#x201D;&#x9AD8;&#x9636;&#x201D;, &#x6BD4;&#x5982;&#x6570;&#x636E;&#x8BBF;&#x95EE;&#x6C38;&#x8FDC;&#x90FD;&#x662F;&#x4EE5;obj&#x4E3A;&#x5355;&#x4F4D;. &#x4F46;&#x57FA;&#x672C;&#x4E0A;&#x601D;&#x8DEF;&#x662F;&#x4E00;&#x6837;&#x7684;.</p>
<p><img src="img/golang_tengo_20220910230806.png" alt="">  </p>
<h1 id="tengo&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;"><a name="tengo&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;" class="anchor-navigation-ex-anchor" href="#tengo&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a>3. tengo&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;</h1>
<p>&#x5728;REPL&#x4E2D;&#x52A0;&#x6253;&#x5370;, &#x4E3B;&#x8981;&#x8003;&#x5BDF;&#x7B26;&#x53F7;&#x8868;, &#x5168;&#x5C40;&#x53D8;&#x91CF;, &#x548C;constants</p>
<h2 id="&#x521D;&#x59CB;&#x72B6;&#x6001;"><a name="&#x521D;&#x59CB;&#x72B6;&#x6001;" class="anchor-navigation-ex-anchor" href="#&#x521D;&#x59CB;&#x72B6;&#x6001;"><i class="fa fa-link" aria-hidden="true"></i></a>3.1. &#x521D;&#x59CB;&#x72B6;&#x6001;</h2>
<pre class="language-"><code class="lang-go">symbols<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>SymbolTable<span class="token punctuation">{</span>parent<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>SymbolTable<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span> block<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span> store<span class="token punctuation">:</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">{</span><span class="token string">&quot;ex&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000df980</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;show&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000df9e0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> numDe$
inition<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> maxDefinition<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> freeSymbols<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builtinSymbols<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre>
<p>&#x6CA1;&#x6709;&#x7236;table, &#x662F;&#x5168;&#x5C40;&#x7B26;&#x53F7;&#x8868;. &#x91CC;&#x9762;&#x6709;&#x5185;&#x5EFA;&#x7684;&#x4E24;&#x4E2A;&#x51FD;&#x6570;: ex&#x548C;show. &#x6CA1;&#x6BDB;&#x75C5;
constant&#x4E3A;&#x7A7A;
global&#x53EA;&#x6709;&#x4E24;&#x4E2A;, &#x5BF9;&#x5E94;ex&#x548C;show. &#x6CA1;&#x6BDB;&#x75C5;</p>
<pre class="language-"><code class="lang-go">globals<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000df9b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000dfa10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>&#x540E;&#x9762;&#x90FD;&#x662F;<span class="token boolean">nil</span>
</code></pre>
<h2 id="a--1-&#x540E;"><a name="a--1-&#x540E;" class="anchor-navigation-ex-anchor" href="#a--1-&#x540E;"><i class="fa fa-link" aria-hidden="true"></i></a>3.2. a := 1 &#x540E;</h2>
<p>symtable&#x7531;&#x4E8E;&#x7B2C;&#x4E00;&#x6B21;&#x6267;&#x884C;&#x540E;, &#x591A;&#x4E86;&#x5185;&#x7F6E;&#x7684;&#x5F88;&#x591A;&#x51FD;&#x6570;, &#x4E5F;&#x591A;&#x4E86;&#x53D8;&#x91CF;a</p>
<pre class="language-"><code class="lang-go">symbols<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>SymbolTable<span class="token punctuation">{</span>parent<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>SymbolTable<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
block<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span> store<span class="token punctuation">:</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">{</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e690</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;append&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e0f0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;bool&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e1e0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;bytes&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e270</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;char&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e240</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;copy&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e0c0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;delete&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e120</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;ex&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000df980</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;float&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e210</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;format&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e600</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;int&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e1b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_array&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e3f0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_bool&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e360</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_bytes&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e3c0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_callable&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e5a0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_char&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e390</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_error&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e510</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_float&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_function&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e570</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_immutable_array&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e420</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_immutable_map&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e480</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_int&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e2d0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_iterable&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e4b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_map&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e450</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_string&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e330</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_time&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e4e0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_undefined&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e540</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;len&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e090</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;show&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000df9e0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;splice&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e150</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e180</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;time&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e2a0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;type_name&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e5d0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
numDefinition<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span> 
maxDefinition<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span> 
freeSymbols<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
builtinSymbols<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e090</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e0c0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e0f0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e120</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e150</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e180</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e1b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e1e0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e210</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e240</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e270</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e2a0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e2d0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e330</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e360</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e390</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e3c0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e3f0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e420</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e450</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e480</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e4b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e4e0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e510</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e540</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e570</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e5a0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e5d0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e600</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre>
<p>constant&#x591A;&#x4E86;&#x4E00;&#x4E2A;</p>
<pre class="language-"><code class="lang-go">constants<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc000138028</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre>
<p>globals&#x591A;&#x4E86;&#x4E00;&#x4E2A;, &#x591A;&#x7684;&#x8FD9;&#x4E2A;&#x548C;constant&#x591A;&#x51FA;&#x6765;&#x7684;&#x662F;&#x4E00;&#x4E2A;&#x5730;&#x5740;.</p>
<pre class="language-"><code class="lang-go">globals<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000df9b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000dfa10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc000138028</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="b--2-&#x540E;"><a name="b--2-&#x540E;" class="anchor-navigation-ex-anchor" href="#b--2-&#x540E;"><i class="fa fa-link" aria-hidden="true"></i></a>3.3. b := 2 &#x540E;</h2>
<p>symbol&#x8868;&#x591A;&#x4E86;b, &#x4F46;&#x4F3C;&#x4E4E;&#x5176;&#x4ED6;&#x7684;&#x7B26;&#x53F7;&#x5730;&#x5740;&#x90FD;&#x53D8;&#x4E86;. -- &#x8FD9;&#x91CC;&#x597D;&#x50CF;&#x6709;bug</p>
<pre class="language-"><code class="lang-go">symbols<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>SymbolTable<span class="token punctuation">{</span>parent<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>SymbolTable<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span> block<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span> store<span class="token punctuation">:</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">{</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e690</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;append&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a0f0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a690</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;bool&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a1e0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;bytes&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a270</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;char&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a240</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;copy&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a0c0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;delete&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a120</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;ex&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000df980</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;float&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a210</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;format&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a600</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;int&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a1b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_array&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a3f0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_bool&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a360</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_bytes&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a3c0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_callable&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a5a0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_char&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a390</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_error&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a510</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_float&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_function&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a570</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_immutable_array&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a420</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_immutable_map&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a480</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_int&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a2d0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_iterable&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a4b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_map&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a450</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_string&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a330</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_time&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a4e0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;is_undefined&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a540</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;len&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a090</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;show&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000df9e0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;splice&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a150</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a180</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;time&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a2a0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;type_name&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a5d0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> numDefinition<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">,</span> maxDefinition<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">,</span> freeSymbols<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builtinSymbols<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e090</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e0c0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e0f0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e120</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e150</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e180</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e1b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e1e0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e210</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e240</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e270</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e2a0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e2d0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e330</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e360</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e390</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e3c0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e3f0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e420</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e450</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e480</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e4b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e4e0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e510</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e540</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e570</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e5a0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e5d0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00018e600</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a090</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a0c0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a0f0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a120</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a150</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a180</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a1b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a1e0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a210</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a240</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a270</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a2a0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a2d0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a330</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a360</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a390</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a3c0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a3f0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a420</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a450</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a480</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a4b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a4e0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a510</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a540</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a570</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a5a0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a5d0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00020a600</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre>
<p>constant&#x591A;&#x4E86;&#x4E00;&#x4E2A;, &#x5C31;&#x662F;b</p>
<pre class="language-"><code class="lang-go">constants<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc000138028</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00012a178</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre>
<p>globals&#x4E5F;&#x591A;&#x4E86;&#x8FD9;&#x4E00;&#x4E2A;</p>
<pre class="language-"><code class="lang-go">globals<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000df9b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000dfa10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc000138028</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00012a178</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="c--ab-&#x540E;"><a name="c--ab-&#x540E;" class="anchor-navigation-ex-anchor" href="#c--ab-&#x540E;"><i class="fa fa-link" aria-hidden="true"></i></a>3.4. c := a+b &#x540E;</h2>
<p>symbol table&#x591A;&#x4E86;c, &#x4F46;&#x8FD8;&#x662F;&#x4E4B;&#x524D;&#x7684;&#x95EE;&#x9898;: builtin&#x7684;&#x7B26;&#x53F7;&#x90FD;&#x88AB;&#x91CD;&#x65B0;&#x6CE8;&#x518C;&#x4E86;&#x4E00;&#x6B21;, &#x5730;&#x5740;&#x90FD;&#x53D8;&#x4E86;.<br>&#x4F46;constants&#x6CA1;&#x6709;&#x53D8;&#x5316;, &#x5373;c&#x4E0D;&#x662F;constant<br>globals&#x591A;&#x4E86;c, &#x5176;&#x4ED6;&#x90FD;&#x4E00;&#x6837;.</p>
<pre class="language-"><code class="lang-go">globals<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000df9b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000dfa10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc000138028</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00012a178</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0001e4228</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="f--funca-b--return-a--b--&#x540E;"><a name="f--funca-b--return-a--b--&#x540E;" class="anchor-navigation-ex-anchor" href="#f--funca-b--return-a--b--&#x540E;"><i class="fa fa-link" aria-hidden="true"></i></a>3.5. f := func(a, b) { return a + b } &#x540E;</h2>
<p>&#x9996;&#x5148;&#x7B26;&#x53F7;&#x8868;&#x591A;&#x4E86;f&#x8FD9;&#x4E2A;&#x6CA1;&#x6709;&#x7591;&#x95EE;.
constants&#x591A;&#x4E86;f, &#x7C7B;&#x578B;&#x662F;CompiledFunction</p>
<pre class="language-"><code class="lang-go">constants<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc000138028</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00012a178</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>CompiledFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000c86e0</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;f&#x4E5F;&#x51FA;&#x73B0;&#x5728;globals&#x91CC;&#x9762;</p>
<pre class="language-"><code class="lang-go">globals<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000df9b0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000dfa10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc000138028</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc00012a178</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0001e4228</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>ten
<span class="token keyword">go</span><span class="token punctuation">.</span>CompiledFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xc0000c86e0</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="formatconstants&#x51FD;&#x6570;"><a name="formatconstants&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#formatconstants&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>3.6. FormatConstants&#x51FD;&#x6570;</h2>
<p>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x53EF;&#x4EE5;&#x67E5;&#x770B;constant&#x7684;&#x503C;, &#x6BD4;&#x5982;:</p>
<pre class="language-"><code class="lang-go">fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">.</span><span class="token function">FormatConstants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x4F1A;&#x6253;&#x5370;:</p>
<pre class="language-"><code class="lang-go"><span class="token punctuation">[</span><span class="token punctuation">[</span>  <span class="token number">0</span><span class="token punctuation">]</span> <span class="token number">1</span> <span class="token punctuation">(</span>Int<span class="token operator">|</span><span class="token number">0xc0000f4920</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>  <span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">2</span> <span class="token punctuation">(</span>Int<span class="token operator">|</span><span class="token number">0xc0000f4950</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>  <span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>Compiled Function<span class="token operator">|</span><span class="token number">0xc0000c4730</span><span class="token punctuation">)</span>      <span class="token number">0000</span> GETL    <span class="token number">0</span>          <span class="token number">0002</span> GETL    <span class="token number">1</span>          <span class="token number">0004</span> BINARYOP <span class="token number">11</span>         <span class="token number">0006</span> RET     <span class="token number">1</span>    <span class="token punctuation">]</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;Compiled Function&#x548C;&#x6C47;&#x7F16;&#x7684;&#x98CE;&#x683C;&#x5F88;&#x50CF;. &#x540C;&#x65F6;&#x53EF;&#x4EE5;&#x770B;&#x5230;FormatConstants&#x51FD;&#x6570;&#x80FD;&#x591F;&#x628A;&#x7F16;&#x8BD1;&#x540E;&#x7684;&#x5B57;&#x8282;&#x7801;&#x6253;&#x5370;&#x51FA;&#x6765;.</p>
<h2 id="&#x90A3;&#x4E48;&#x4EC0;&#x4E48;&#x662F;constant"><a name="&#x90A3;&#x4E48;&#x4EC0;&#x4E48;&#x662F;constant" class="anchor-navigation-ex-anchor" href="#&#x90A3;&#x4E48;&#x4EC0;&#x4E48;&#x662F;constant"><i class="fa fa-link" aria-hidden="true"></i></a>3.7. &#x90A3;&#x4E48;&#x4EC0;&#x4E48;&#x662F;constant?</h2>
<p>&#x4E3A;&#x4EC0;&#x4E48;constants&#x6570;&#x7EC4;&#x5728;&#x7F16;&#x8BD1;&#x548C;&#x8FD0;&#x884C;&#x65F6;&#x6BB5;&#x90FD;&#x5B58;&#x5728;?<br>constants&#x662F;&#x4E2A;&#x5BF9;&#x8C61;&#x6570;&#x7EC4;, &#x4FDD;&#x5B58;&#x7684;&#x662F;<strong>&#x56FA;&#x5B9A;&#x503C;</strong>&#x7684;&#x53D8;&#x91CF;, &#x6BD4;&#x5982;&#x4E0A;&#x6587;&#x7684;</p>
<pre class="language-"><code class="lang-go">a <span class="token operator">:=</span> <span class="token number">1</span>
b <span class="token operator">:=</span> <span class="token number">2</span>
f <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
</code></pre>
<h3 id="constants&#x5728;&#x4F55;&#x5904;&#x4F7F;&#x7528;-&#x5728;&#x4F55;&#x5904;&#x5B9A;&#x4E49;"><a name="constants&#x5728;&#x4F55;&#x5904;&#x4F7F;&#x7528;-&#x5728;&#x4F55;&#x5904;&#x5B9A;&#x4E49;" class="anchor-navigation-ex-anchor" href="#constants&#x5728;&#x4F55;&#x5904;&#x4F7F;&#x7528;-&#x5728;&#x4F55;&#x5904;&#x5B9A;&#x4E49;"><i class="fa fa-link" aria-hidden="true"></i></a>3.7.1. constants&#x5728;&#x4F55;&#x5904;&#x4F7F;&#x7528;, &#x5728;&#x4F55;&#x5904;&#x5B9A;&#x4E49;</h3>
<p>&#x9996;&#x5148;, VM&#x5728;&#x8FD0;&#x884C;&#x7684;&#x65F6;&#x5019;, &#x5728;&#x5F53;&#x524D;&#x6307;&#x4EE4;&#x662F;<code>parser.OpConstant</code>&#x7684;&#x65F6;&#x5019;, &#x56DE;&#x53BB;constants&#x6570;&#x7EC4;&#x627E;&#x9700;&#x8981;&#x7684;&#x5BF9;&#x8C61;:
<code>v.stack[v.sp] = v.constants[cidx]</code></p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v<span class="token punctuation">.</span>aborting<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        v<span class="token punctuation">.</span>ip<span class="token operator">++</span>

        <span class="token keyword">switch</span> v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpConstant<span class="token punctuation">:</span>
            v<span class="token punctuation">.</span>ip <span class="token operator">+=</span> <span class="token number">2</span>
            cidx <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span>

            v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>constants<span class="token punctuation">[</span>cidx<span class="token punctuation">]</span>
            v<span class="token punctuation">.</span>sp<span class="token operator">++</span>
</code></pre>
<p>&#x6CE8;&#x610F;, constants&#x5BF9;&#x8C61;&#x6570;&#x7EC4;&#x662F;&#x9760;index&#x6765;&#x7D22;&#x5F15;&#x7684;.</p>
<p>&#x8FD9;&#x4E9B;constant&#x5BF9;&#x8C61;, &#x662F;&#x5728;&#x7F16;&#x8BD1;&#x7684;&#x65F6;&#x5019;, &#x7F16;&#x8BD1;&#x5668;&#x53D1;&#x73B0;<code>a := 1</code>&#x53D8;&#x91CF;&#x662F;&#x4E2A;&#x5E38;&#x91CF;, &#x5C31;&#x628A;&#x5B83;&#x653E;&#x5230;constants&#x6570;&#x7EC4;&#x91CC;, &#x5E76;emit <code>parser.OpConstant</code>&#x6307;&#x4EE4;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiler<span class="token punctuation">)</span> <span class="token function">addConstant</span><span class="token punctuation">(</span>o Object<span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>parent <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// module compilers will use their parent&apos;s constants array</span>
        <span class="token keyword">return</span> c<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">addConstant</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    c<span class="token punctuation">.</span>constants <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>constants<span class="token punctuation">,</span> o<span class="token punctuation">)</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>trace <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span><span class="token function">printTrace</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;CONST %04d %s&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>constants<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>constants<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token comment">// Compile compiles the AST node.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiler<span class="token punctuation">)</span> <span class="token function">Compile</span><span class="token punctuation">(</span>node parser<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>IntLit<span class="token punctuation">:</span>
        c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpConstant<span class="token punctuation">,</span>
            c<span class="token punctuation">.</span><span class="token function">addConstant</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Int<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> node<span class="token punctuation">.</span>Value<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>FloatLit<span class="token punctuation">:</span>
        c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpConstant<span class="token punctuation">,</span>
            c<span class="token punctuation">.</span><span class="token function">addConstant</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Float<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> node<span class="token punctuation">.</span>Value<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="&#x4E3A;&#x4EC0;&#x4E48;constants&#x8981;&#x4F20;&#x9012;&#x7ED9;newcompiler"><a name="&#x4E3A;&#x4EC0;&#x4E48;constants&#x8981;&#x4F20;&#x9012;&#x7ED9;newcompiler" class="anchor-navigation-ex-anchor" href="#&#x4E3A;&#x4EC0;&#x4E48;constants&#x8981;&#x4F20;&#x9012;&#x7ED9;newcompiler"><i class="fa fa-link" aria-hidden="true"></i></a>3.7.2. &#x4E3A;&#x4EC0;&#x4E48;constants&#x8981;&#x4F20;&#x9012;&#x7ED9;NewCompiler?</h3>
<p>&#x4E3B;&#x8981;&#x662F;&#x7528;&#x5728;REPL&#x573A;&#x666F;&#x4E0B;, &#x628A;&#x4E0A;&#x4E00;&#x6B21;&#x7684;constants&#x4F20;&#x9012;&#x7ED9;&#x8FD9;&#x4E00;&#x6B21;, &#x56E0;&#x4E3A;REPL&#x662F;&#x589E;&#x91CF;&#x5F0F;&#x7F16;&#x8BD1;&#x6267;&#x884C;&#x6A21;&#x5F0F;, &#x9700;&#x8981;&#x524D;&#x9762;&#x7684;&#x5E38;&#x91CF;&#x8868;&#x548C;&#x7B26;&#x53F7;&#x8868;, &#x800C;&#x589E;&#x91CF;&#x5F0F;&#x7684;run&#x4E5F;&#x9700;&#x8981;&#x4E0A;&#x4E00;&#x6B21;&#x7684;globals&#x8868;.</p>
<pre class="language-"><code class="lang-go">            srcFile <span class="token operator">:=</span> fileSet<span class="token punctuation">.</span><span class="token function">AddFile</span><span class="token punctuation">(</span><span class="token string">&quot;repl&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span>
            p <span class="token operator">:=</span> parser<span class="token punctuation">.</span><span class="token function">NewParser</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
            file<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">ParseFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>

            c <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewCompiler</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">,</span> sh<span class="token punctuation">.</span>symbolTable<span class="token punctuation">,</span> constants<span class="token punctuation">,</span> sh<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>

            bytecode <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Bytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            bytecode<span class="token punctuation">.</span><span class="token function">RemoveDuplicates</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            machine <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewVM</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">,</span> sh<span class="token punctuation">.</span>globals<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> machine<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            constants <span class="token operator">=</span> bytecode<span class="token punctuation">.</span>Constants
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">.</span><span class="token function">FormatConstants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="extension"><a name="extension" class="anchor-navigation-ex-anchor" href="#extension"><i class="fa fa-link" aria-hidden="true"></i></a>4. extension</h1>
<h2 id="&#x4E3A;&#x4EC0;&#x4E48;extensionuserfunction&#x4E0D;&#x751F;&#x6548;----&#x6CE8;&#x610F;copy&#x65B9;&#x6CD5;"><a name="&#x4E3A;&#x4EC0;&#x4E48;extensionuserfunction&#x4E0D;&#x751F;&#x6548;----&#x6CE8;&#x610F;copy&#x65B9;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#&#x4E3A;&#x4EC0;&#x4E48;extensionuserfunction&#x4E0D;&#x751F;&#x6548;----&#x6CE8;&#x610F;copy&#x65B9;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>4.1. &#x4E3A;&#x4EC0;&#x4E48;extension.UserFunction&#x4E0D;&#x751F;&#x6548;? -- &#x6CE8;&#x610F;Copy()&#x65B9;&#x6CD5;</h2>
<p>&#x6211;&#x5728;<code>eobjects.go</code>&#x91CC;&#x9762;, &#x7EE7;&#x627F;&#x4E86;<code>tengo.UserFunction</code></p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> UserFunction <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    tengo<span class="token punctuation">.</span>UserFunction
    Signature <span class="token builtin">string</span>
    Help <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6211;&#x662F;&#x60F3;&#x91CD;&#x8F7D;String&#x65B9;&#x6CD5;, &#x8FD9;&#x6837;fmt.println&#x4F1A;&#x8C03;&#x7528;&#x5230;&#x8FD9;&#x4E2A;String&#x65B9;&#x6CD5;, &#x663E;&#x793A;help&#x4FE1;&#x606F;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>UserFunction<span class="token punctuation">)</span> <span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;user-function(extended):&quot;</span> <span class="token operator">+</span> o<span class="token punctuation">.</span>Name
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>UserFunction<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> o<span class="token punctuation">.</span>Signature <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span> <span class="token operator">+</span> o<span class="token punctuation">.</span>Help
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5728;&#x6CE8;&#x518C;function&#x7684;&#x65F6;&#x5019;, &#x7C7B;&#x578B;&#x4E3A;<code>&amp;extension.UserFunction</code>
&#x7F16;&#x8BD1;&#x901A;&#x8FC7;, &#x4F3C;&#x4E4E;&#x6CA1;&#x95EE;&#x9898;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span>
    <span class="token string">&quot;newx&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>extension<span class="token punctuation">.</span>UserFunction<span class="token punctuation">{</span>
        UserFunction<span class="token punctuation">:</span> tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">{</span>
            Name<span class="token punctuation">:</span>  <span class="token string">&quot;new&quot;</span><span class="token punctuation">,</span>
            Value<span class="token punctuation">:</span> newStat<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        Signature<span class="token punctuation">:</span> <span class="token string">&quot;new({option1:true, option2:false}) =&gt; statCollector&quot;</span><span class="token punctuation">,</span>
        Help<span class="token punctuation">:</span> <span class="token string">&quot;option can be &quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// new({option1:true, option2:false}) =&gt; statCollector</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4F46;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD8;&#x662F;&#x8C03;&#x5230;&#x4E86;&#x539F;tengo.UserFunction? &#x5E94;&#x8BE5;&#x4F1A;&#x6253;&#x5370;&#x5E2E;&#x52A9;&#x6587;&#x672C;&#x554A;???</p>
<pre class="language-"><code class="lang-go">pidstat <span class="token operator">:=</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;pidstat&quot;</span><span class="token punctuation">)</span>
fmt <span class="token operator">:=</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;fmt&quot;</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pidstat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>newx<span class="token punctuation">:</span> <span class="token operator">&lt;</span>user<span class="token operator">-</span>function<span class="token operator">&gt;</span><span class="token punctuation">,</span> __module_name__<span class="token punctuation">:</span> <span class="token string">&quot;pidstat&quot;</span><span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x8C03;&#x67E5;"><a name="&#x8C03;&#x67E5;" class="anchor-navigation-ex-anchor" href="#&#x8C03;&#x67E5;"><i class="fa fa-link" aria-hidden="true"></i></a>4.1.1. &#x8C03;&#x67E5;</h3>
<p>&#x7528;vscode&#x548C;dlv&#x8C03;&#x67E5;, &#x53D1;&#x73B0;&#x5728;&#x6CE8;&#x518C;&#x7684;&#x65F6;&#x5019;&#x662F;&#x5BF9;&#x7684;, object&#x7C7B;&#x578B;&#x662F;<code>&amp;extension.UserFunction</code></p>
<pre class="language-"><code class="lang-go"><span class="token string">&quot;newx&quot;</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>d5<span class="token operator">/</span>tengo<span class="token operator">/</span>v2<span class="token punctuation">.</span><span class="token function">Object</span><span class="token punctuation">(</span><span class="token operator">*</span>bhgitlab<span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">.</span>net<span class="token punctuation">.</span>nokia<span class="token punctuation">.</span>com<span class="token operator">/</span>godev<span class="token operator">/</span>gshell<span class="token operator">/</span>extension<span class="token punctuation">.</span>UserFunction<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
    data<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token operator">*</span>bhgitlab<span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">.</span>net<span class="token punctuation">.</span>nokia<span class="token punctuation">.</span>com<span class="token operator">/</span>godev<span class="token operator">/</span>gshell<span class="token operator">/</span>extension<span class="token punctuation">.</span>UserFunction<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0xc0000f8050</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x4F46;&#x8C03;&#x7528;&#x5230;<code>fmt.println</code>&#x7684;&#x65F6;&#x5019;, &#x4F20;&#x5165;&#x7684;object&#x7C7B;&#x578B;&#x5C31;&#x53D8;&#x6210;&#x4E86;</p>
<pre class="language-"><code class="lang-go"><span class="token operator">&lt;</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>d5<span class="token operator">/</span>tengo<span class="token operator">/</span>v2<span class="token punctuation">.</span><span class="token function">Object</span><span class="token punctuation">(</span><span class="token operator">*</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>d5<span class="token operator">/</span>tengo<span class="token operator">/</span>v2<span class="token punctuation">.</span>UserFunction<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x662F;go&#x7684;&quot;&#x7EE7;&#x627F;&quot;&#x7CFB;&#x7EDF;&#x51FA;&#x4E86;&#x95EE;&#x9898;&#x5417;? &#x770B;&#x8D77;&#x6765;&#x50CF;&#x662F;&#x5BF9;&#x8C61;&#x4ECE;&#x6D3E;&#x751F;&#x7C7B;&#x53D8;&#x6210;&#x57FA;&#x7C7B;&#x4E86;?
-- &#x4E0D;&#x662F;. go&#x7684;&#x7EE7;&#x627F;&#x6CA1;&#x95EE;&#x9898;.
&#x95EE;&#x9898;&#x5728;&#x6CE8;&#x518C;module&#x5BF9;&#x8C61;&#x7684;&#x65F6;&#x5019;, &#x8FD4;&#x56DE;&#x4E86;&#x539F;module&#x5BF9;&#x8C61;&#x7684;Copy()&#x65B9;&#x6CD5;, &#x76EE;&#x7684;&#x662F;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;ImmutableMap</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// BuiltinModule is an importable module that&apos;s written in Go.</span>
<span class="token keyword">type</span> BuiltinModule <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Attrs <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Object
<span class="token punctuation">}</span>

<span class="token comment">// Import returns an immutable map for the module.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>BuiltinModule<span class="token punctuation">)</span> <span class="token function">Import</span><span class="token punctuation">(</span>moduleName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token function">AsImmutableMap</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// AsImmutableMap converts builtin module into an immutable map.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>BuiltinModule<span class="token punctuation">)</span> <span class="token function">AsImmutableMap</span><span class="token punctuation">(</span>moduleName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>ImmutableMap <span class="token punctuation">{</span>
    attrs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Object<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Attrs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>Attrs <span class="token punctuation">{</span>
        attrs<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    attrs<span class="token punctuation">[</span><span class="token string">&quot;__module_name__&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>String<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> moduleName<span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>ImmutableMap<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> attrs<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6CE8;&#x610F;<code>AsImmutableMap()</code>&#x51FD;&#x6570;&#x91CC;&#x9762;, &#x8C03;&#x7528;&#x4E86;<code>attrs[k] = v.Copy()</code>
&#x95EE;&#x9898;&#x5C31;&#x51FA;&#x5728;&#x8FD9;&#x91CC;: &#x6211;&#x7EE7;&#x627F;&#x4E86;&#x57FA;&#x7C7B;&#x7684;Copy()&#x65B9;&#x6CD5;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Copy returns a copy of the type.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>UserFunction<span class="token punctuation">)</span> <span class="token function">Copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Object <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>UserFunction<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> o<span class="token punctuation">.</span>Value<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5B83;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;<code>tengo.UserFunction</code>&#x5BF9;&#x8C61;. &#x6240;&#x4EE5;&#x540E;&#x9762;<code>fmt.println()</code>&#x7684;&#x65F6;&#x5019;, &#x5B9E;&#x9645;&#x6253;&#x5370;&#x7684;&#x662F;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;.</p>
<h3 id="&#x7ED3;&#x8BBA;_1"><a name="&#x7ED3;&#x8BBA;_1" class="anchor-navigation-ex-anchor" href="#&#x7ED3;&#x8BBA;_1"><i class="fa fa-link" aria-hidden="true"></i></a>4.1.2. &#x7ED3;&#x8BBA;</h3>
<ul>
<li>tengo&#x5728;&#x6CE8;&#x518C;module&#x7684;&#x65F6;&#x5019;, &#x4E3A;&#x4E86;&#x4E0D;&#x6539;&#x53D8;&#x539F;&#x5BF9;&#x8C61;, &#x5BF9;&#x539F;&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x4E86;Copy(), &#x8FD4;&#x56DE;&#x4E86;immutable&#x5BF9;&#x8C61;.</li>
<li>immutable&#x5BF9;&#x8C61;&#x5B9E;&#x9645;&#x662F;&#x8C03;&#x7528;&#x539F;&#x5BF9;&#x8C61;&#x7684;Copy()&#x65B9;&#x6CD5;&#x6765;&#x7684;, &#x8981;extend&#x7684;&#x8BDD;, &#x9700;&#x8981;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;Copy()&#x65B9;&#x6CD5;.</li>
</ul>
<h2 id="bash"><a name="bash" class="anchor-navigation-ex-anchor" href="#bash"><i class="fa fa-link" aria-hidden="true"></i></a>4.2. bash</h2>
<h3 id="&#x80FD;&#x591F;&#x5728;bash&#x7684;&#x547D;&#x4EE4;&#x91CC;&#x5F15;&#x7528;&#x811A;&#x672C;&#x7684;&#x53D8;&#x91CF;&#x5417;"><a name="&#x80FD;&#x591F;&#x5728;bash&#x7684;&#x547D;&#x4EE4;&#x91CC;&#x5F15;&#x7528;&#x811A;&#x672C;&#x7684;&#x53D8;&#x91CF;&#x5417;" class="anchor-navigation-ex-anchor" href="#&#x80FD;&#x591F;&#x5728;bash&#x7684;&#x547D;&#x4EE4;&#x91CC;&#x5F15;&#x7528;&#x811A;&#x672C;&#x7684;&#x53D8;&#x91CF;&#x5417;"><i class="fa fa-link" aria-hidden="true"></i></a>4.2.1. &#x80FD;&#x591F;&#x5728;bash&#x7684;&#x547D;&#x4EE4;&#x91CC;&#x5F15;&#x7528;&#x811A;&#x672C;&#x7684;&#x53D8;&#x91CF;&#x5417;?</h3>
<pre class="language-"><code class="lang-go">file <span class="token operator">:=</span> <span class="token string">&quot;test&quot;</span>
fmt<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bash<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">`touch $file`</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x7B80;&#x5355;&#x56DE;&#x7B54;: &#x4E0D;&#x80FD;.
&#x56E0;&#x4E3A;<code>bash.run()</code>&#x5B9E;&#x9645;&#x662F;&#x8C03;&#x7528;&#x7684;native go&#x7684;&#x4EE3;&#x7801;, &#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#x5DF2;&#x7ECF;&#x662F;&#x5728;tengo&#x7684;VM&#x4E2D;&#x8FD0;&#x884C;&#x7684;&#x5B57;&#x8282;&#x7801;&#x8C03;&#x7528;&#x7684;. &#x5728;ast&#x9636;&#x6BB5;&#x662F;&#x6709;&#x7B26;&#x53F7;&#x6982;&#x5FF5;&#x7684;, &#x4F46;ast&#x7F16;&#x8BD1;&#x6210;&#x5B57;&#x8282;&#x7801;&#x4E4B;&#x540E;, &#x7B26;&#x53F7;&#x5DF2;&#x7ECF;&#x53D8;&#x6210;&#x4E86;&quot;&#x5730;&#x5740;&quot;&#x4E86;.<br>&#x6240;&#x4EE5;, &#x8C03;&#x7528;&#x5230;bash.run()&#x65F6;, &#x5DF2;&#x7ECF;&#x6CA1;&#x6709;&quot;file&quot;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x4E86;, &#x53EA;&#x6709;&#x5176;&#x5BF9;&#x5E94;&#x7684;&#x5730;&#x5740;.</p>
<p>&#x9664;&#x975E;&#x5728;ast&#x4E2D;&#x65B0;&#x589E;&#x5BF9;<code>$</code>&#x7684;&#x89E3;&#x6790;, &#x5728;ast&#x7F16;&#x8BD1;&#x6210;&#x5B57;&#x8282;&#x7801;&#x7684;&#x9636;&#x6BB5;, &#x628A;<code>touch $file</code>&#x5BF9;file&#x7684;&#x8BBF;&#x95EE;, emit&#x6210;&#x4E00;&#x4E2A;GetLocal&#x7684;op. &#x6BD4;&#x5982;<code>c.emit(node, parser.OpGetLocal, symbol.Index)</code></p>
<h4 id="&#x89E3;&#x51B3;&#x65B9;&#x6CD5;"><a name="&#x89E3;&#x51B3;&#x65B9;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#&#x89E3;&#x51B3;&#x65B9;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x89E3;&#x51B3;&#x65B9;&#x6CD5;</h4>
<p>&#x53EA;&#x6709;&#x5206;&#x4E24;&#x6B65;&#x8D70;:</p>
<pre class="language-"><code class="lang-go">file <span class="token operator">:=</span> <span class="token string">&quot;testfile&quot;</span>
cmd <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;touch %s&quot;</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bash<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x6CE8;: &#x4F7F;&#x7528;tengo&#x5185;&#x7F6E;&#x7684;format&#x51FD;&#x6570;&#x66F4;&#x7B80;&#x5355;&#x70B9;</p>
<pre class="language-"><code class="lang-go">pid <span class="token operator">:=</span> <span class="token number">10086</span>
fmt<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;hello %d&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="&#x6DFB;&#x52A0;&#x65B0;&#x7684;builtin&#x51FD;&#x6570;ex"><a name="&#x6DFB;&#x52A0;&#x65B0;&#x7684;builtin&#x51FD;&#x6570;ex" class="anchor-navigation-ex-anchor" href="#&#x6DFB;&#x52A0;&#x65B0;&#x7684;builtin&#x51FD;&#x6570;ex"><i class="fa fa-link" aria-hidden="true"></i></a>4.3. &#x6DFB;&#x52A0;&#x65B0;&#x7684;builtin&#x51FD;&#x6570;ex()</h2>
<h3 id="&#x80FD;&#x5426;&#x6DFB;&#x52A0;&#x5230;builtinfuncs&#x8868;"><a name="&#x80FD;&#x5426;&#x6DFB;&#x52A0;&#x5230;builtinfuncs&#x8868;" class="anchor-navigation-ex-anchor" href="#&#x80FD;&#x5426;&#x6DFB;&#x52A0;&#x5230;builtinfuncs&#x8868;"><i class="fa fa-link" aria-hidden="true"></i></a>4.3.1. &#x80FD;&#x5426;&#x6DFB;&#x52A0;&#x5230;builtinFuncs&#x8868;</h3>
<p>&#x5148;&#x8BF4;&#x7ED3;&#x8BBA;: tengo&#x7684;builtin&#x51FD;&#x6570;&#x8868;&#x662F;&#x56FA;&#x5B9A;&#x7684;, &#x5916;&#x9762;&#x65E0;&#x6CD5;&#x66F4;&#x6539;.</p>
<p><code>builtins.go</code>&#x4E2D;, &#x6709;&#x4E2A;&#x56FA;&#x5316;&#x7684;&#x8868;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">var</span> builtinFuncs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>BuiltinFunction<span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span>  <span class="token string">&quot;len&quot;</span><span class="token punctuation">,</span>
        Value<span class="token punctuation">:</span> builtinLen<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span>  <span class="token string">&quot;copy&quot;</span><span class="token punctuation">,</span>
        Value<span class="token punctuation">:</span> builtinCopy<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8C03;&#x7528;&#x8FD9;&#x4E2A;&#x8868;&#x91CC;&#x7684;&#x51FD;&#x6570;, &#x4E0D;&#x662F;&#x4EE5;&#x5B57;&#x7B26;&#x4E32;&#x65B9;&#x5F0F;&#x67E5;&#x627E;&#x51FD;&#x6570;&#x7684;, &#x800C;&#x662F;index:
<code>vm.go</code>&#x6267;&#x884C;&#x5B57;&#x8282;&#x7801;&#x9636;&#x6BB5;&#x7684;<code>run()</code>&#x51FD;&#x6570;:</p>
<pre class="language-"><code class="lang-go">        <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpGetBuiltin<span class="token punctuation">:</span>
            v<span class="token punctuation">.</span>ip<span class="token operator">++</span>
            builtinIndex <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token punctuation">]</span><span class="token punctuation">)</span>
            v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> builtinFuncs<span class="token punctuation">[</span>builtinIndex<span class="token punctuation">]</span>
            v<span class="token punctuation">.</span>sp<span class="token operator">++</span>
</code></pre>
<p>&#x4ECE;&#x5B57;&#x8282;&#x7801;&#x91CC;&#x9762;&#x53D6;&#x51FA;builtinIndex, &#x67E5;&#x627E;<code>builtinFuncs</code>, &#x5F97;&#x5230;&#x51FD;&#x6570;, &#x653E;&#x5230;stack&#x4E0A;.</p>
<p>&#x800C;&#x5B57;&#x8282;&#x7801;&#x7684;builtinIndex, &#x662F;&#x5728;&#x7F16;&#x8BD1;&#x9636;&#x6BB5;<code>compiler.go</code>&#x4E2D;<code>Compile()</code>&#x51FD;&#x6570;:</p>
<pre class="language-"><code class="lang-go">    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>Ident<span class="token punctuation">:</span>
        symbol<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> c<span class="token punctuation">.</span>symbolTable<span class="token punctuation">.</span><span class="token function">Resolve</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">errorf</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&quot;unresolved reference &apos;%s&apos;&quot;</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">switch</span> symbol<span class="token punctuation">.</span>Scope <span class="token punctuation">{</span>
        <span class="token keyword">case</span> ScopeGlobal<span class="token punctuation">:</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetGlobal<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
        <span class="token keyword">case</span> ScopeLocal<span class="token punctuation">:</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetLocal<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
        <span class="token keyword">case</span> ScopeBuiltin<span class="token punctuation">:</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetBuiltin<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
        <span class="token keyword">case</span> ScopeFree<span class="token punctuation">:</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetFree<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>&#x5BF9;&#x7B26;&#x53F7;&#x7684;&#x5904;&#x7406;, &#x7EDF;&#x4E00;&#x90FD;&#x662F;<code>Resolve()</code>&#x5F53;&#x524D;&#x7684;<code>symbolTable</code>, &#x5F97;&#x5230;<code>symbol</code>&#x7684;Index&#x4FE1;&#x606F;, emit&#x5230;&#x5B57;&#x8282;&#x7801;&#x4E2D;. &#x5B57;&#x8282;&#x7801;&#x91CC;&#x9762;&#x5DF2;&#x7ECF;&#x6CA1;&#x6709;&#x7B26;&#x53F7;, &#x90FD;&#x662F;&#x901A;&#x8FC7;index&#x6765;&#x64CD;&#x4F5C;&#x7684;. &#x8FD9;&#x6837;&#x6700;&#x9AD8;&#x6548;.</p>
<p>&#x800C;&#x6700;&#x5F00;&#x59CB;&#x7684;&#x7B26;&#x53F7;, &#x662F;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x52A0;&#x7684;: <code>gshell.go</code>&#x4E2D;<code>runREPL()</code>&#x51FD;&#x6570;</p>
<pre class="language-"><code class="lang-go">    symbolTable <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewSymbolTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> fn <span class="token operator">:=</span> <span class="token keyword">range</span> tengo<span class="token punctuation">.</span><span class="token function">GetAllBuiltinFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        symbolTable<span class="token punctuation">.</span><span class="token function">DefineBuiltin</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> fn<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x91CC;&#x53EA;&#x662F;&#x52A0;&#x4E86;&#x7B26;&#x53F7;&#x8868;&#x4FE1;&#x606F;, &#x628A;&#x7B26;&#x53F7;&#x7684;&#x540D;&#x5B57;&#x548C;index&#x5BF9;&#x4E0A;. &#x5B9E;&#x9645;&#x8FD0;&#x884C;&#x9636;&#x6BB5;, &#x6309;&#x524D;&#x6587;&#x6240;&#x8FF0;, vm&#x4F1A;&#x53BB;<code>builtinFuncs</code>&#x8868;&#x4E2D;&#x627E;.</p>
<h3 id="&#x6DFB;&#x52A0;&#x5230;global&#x8868;"><a name="&#x6DFB;&#x52A0;&#x5230;global&#x8868;" class="anchor-navigation-ex-anchor" href="#&#x6DFB;&#x52A0;&#x5230;global&#x8868;"><i class="fa fa-link" aria-hidden="true"></i></a>4.3.2. &#x6DFB;&#x52A0;&#x5230;global&#x8868;</h3>
<p>&#x51FD;&#x6570;&#x4E5F;&#x662F;&#x5BF9;&#x8C61;, &#x90A3;&#x5C31;&#x53EF;&#x4EE5;&#x5F53;&#x4F5C;&quot;&#x5168;&#x5C40;&#x53D8;&#x91CF;&quot;&#x6DFB;&#x52A0;&#x5230;global&#x8868;: &#x5728;symbolTable&#x91CC;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;<code>ex</code>&#x7684;&#x7B26;&#x53F7;, &#x7528;&#x8FD4;&#x56DE;&#x7684;<code>index</code>&#x548C;globals&#x91CC;&#x9762;&#x5B9E;&#x9645;&#x5B9A;&#x4E49;&#x7684;&#x51FD;&#x6570;&#x5BF9;&#x5E94;&#x8D77;&#x6765;.</p>
<pre class="language-"><code class="lang-go">    globals <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> tengo<span class="token punctuation">.</span>GlobalsSize<span class="token punctuation">)</span>
    symbolTable <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewSymbolTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    symbol <span class="token operator">:=</span> symbolTable<span class="token punctuation">.</span><span class="token function">Define</span><span class="token punctuation">(</span><span class="token string">&quot;ex&quot;</span><span class="token punctuation">)</span>
    globals<span class="token punctuation">[</span>symbol<span class="token punctuation">.</span>Index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span> <span class="token string">&quot;ex&quot;</span><span class="token punctuation">,</span>
        Value<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>args <span class="token operator">...</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>ret tengo<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> tengo<span class="token punctuation">.</span>ErrWrongNumArguments
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> extension<span class="token punctuation">.</span><span class="token function">ExtendObj</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x7136;&#x540E;&#x5728;<code>NewCompiler()</code>&#x7684;&#x65F6;&#x5019;&#x4F20;&#x5165;<code>symbolTable</code>; &#x5728;<code>NewVM()</code>&#x7684;&#x65F6;&#x5019;&#x4F20;&#x5165;<code>globals</code>
&#x56E0;&#x4E3A;&#x4E4B;&#x524D;&#x7B26;&#x53F7;&#x8868;&#x548C;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x5BF9;&#x7684;&#x4E0A;, &#x90A3;&#x4E48;&#x8FD0;&#x884C;&#x65F6;&#x5C31;&#x80FD;&#x627E;&#x5230;&#x6B63;&#x786E;&#x7684;&#x51FD;&#x6570;.</p>
<h1 id="tengo&#x4EE3;&#x7801;"><a name="tengo&#x4EE3;&#x7801;" class="anchor-navigation-ex-anchor" href="#tengo&#x4EE3;&#x7801;"><i class="fa fa-link" aria-hidden="true"></i></a>5. tengo&#x4EE3;&#x7801;</h1>
<p>&#x4ECE;&#x7B80;&#x5355;&#x7684;&#x4F8B;&#x5B50;&#x5F00;&#x59CB;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">import</span> <span class="token string">&quot;github.com/d5/tengo/v2&quot;</span>

<span class="token keyword">var</span> code <span class="token operator">=</span> <span class="token string">`
reduce := func(seq, fn) {
    s := 0
    for x in seq { fn(x, s) }
    return s
}

print(reduce([1, 2, 3], func(x, s) { s += x }))
`</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewScript</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4E0A;&#x9762;&#x662F;&#x76F4;&#x63A5;&#x8FD0;&#x884C;&#x7684;&#x4F8B;&#x5B50;.
&#x4E0B;&#x9762;&#x662F;&#x7F16;&#x8BD1;&#x6210;&#x5B57;&#x8282;&#x7801;&#x540E;&#x8FD0;&#x884C;&#x7684;&#x4F8B;&#x5B50;.</p>
<pre class="language-"><code class="lang-go">s <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewScript</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`a := b + 20`</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
c<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
a <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
c<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="examplesinteroperabilitymaingo"><a name="examplesinteroperabilitymaingo" class="anchor-navigation-ex-anchor" href="#examplesinteroperabilitymaingo"><i class="fa fa-link" aria-hidden="true"></i></a>5.1. examples/interoperability/main.go</h2>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    src <span class="token operator">:=</span> <span class="token string">`
     // goproxy and proxy must be imported.
     goproxy := import(&quot;goproxy&quot;)
     proxy := import(&quot;proxy&quot;)

     global := 0

     callbacks := {
         sum: func(a, b) {
             return a + b
         },
         multiply: func(a, b) {
             return a * b
         },
         increment: func() {
             global++
             return global
         }
     }

     // Register callbacks to call them in goproxy loop.
     goproxy.register(callbacks)

     // goproxy loop waits for new call requests and run them with the help of
     // &quot;proxy&quot; source module. Cancelling the context breaks the loop.
     for goproxy.next() {
         proxy(goproxy.args())
     }
`</span>
    <span class="token comment">// 5 seconds context timeout is enough for an example.</span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    script <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewScript</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span>
    moduleMap <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewModuleMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    goproxy <span class="token operator">:=</span> <span class="token function">NewGoProxy</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token comment">// register modules</span>
    moduleMap<span class="token punctuation">.</span><span class="token function">AddBuiltinModule</span><span class="token punctuation">(</span><span class="token string">&quot;goproxy&quot;</span><span class="token punctuation">,</span> goproxy<span class="token punctuation">.</span><span class="token function">ModuleMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    moduleMap<span class="token punctuation">.</span><span class="token function">AddSourceModule</span><span class="token punctuation">(</span><span class="token string">&quot;proxy&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>ProxySource<span class="token punctuation">)</span><span class="token punctuation">)</span>
    script<span class="token punctuation">.</span><span class="token function">SetImports</span><span class="token punctuation">(</span>moduleMap<span class="token punctuation">)</span>

    compiled<span class="token punctuation">,</span> err <span class="token operator">:=</span> script<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// call &quot;sum&quot;, &quot;multiply&quot;, &quot;increment&quot; functions from tengo in a new goroutine</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        callChan <span class="token operator">:=</span> goproxy<span class="token punctuation">.</span><span class="token function">CallChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> tengo<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment">// TODO: check tengo error from result channel.</span>
    loop<span class="token punctuation">:</span>
        <span class="token keyword">for</span> <span class="token punctuation">{</span>
            <span class="token keyword">select</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span> loop
            <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token punctuation">}</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Calling tengo sum function&quot;</span><span class="token punctuation">)</span>
            i1<span class="token punctuation">,</span> i2 <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Int63n</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rand<span class="token punctuation">.</span><span class="token function">Int63n</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
            callChan <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>CallArgs<span class="token punctuation">{</span>Func<span class="token punctuation">:</span> <span class="token string">&quot;sum&quot;</span><span class="token punctuation">,</span>
                Params<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span><span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> i1<span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> i2<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                Result<span class="token punctuation">:</span> result<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            v <span class="token operator">:=</span> <span class="token operator">&lt;-</span>result
            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d + %d = %v\n&quot;</span><span class="token punctuation">,</span> i1<span class="token punctuation">,</span> i2<span class="token punctuation">,</span> v<span class="token punctuation">)</span>

            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Calling tengo multiply function&quot;</span><span class="token punctuation">)</span>
            i1<span class="token punctuation">,</span> i2 <span class="token operator">=</span> rand<span class="token punctuation">.</span><span class="token function">Int63n</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rand<span class="token punctuation">.</span><span class="token function">Int63n</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
            callChan <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>CallArgs<span class="token punctuation">{</span>Func<span class="token punctuation">:</span> <span class="token string">&quot;multiply&quot;</span><span class="token punctuation">,</span>
                Params<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span><span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> i1<span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> i2<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                Result<span class="token punctuation">:</span> result<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            v <span class="token operator">=</span> <span class="token operator">&lt;-</span>result
            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d * %d = %v\n&quot;</span><span class="token punctuation">,</span> i1<span class="token punctuation">,</span> i2<span class="token punctuation">,</span> v<span class="token punctuation">)</span>

            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Calling tengo increment function&quot;</span><span class="token punctuation">)</span>
            callChan <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>CallArgs<span class="token punctuation">{</span>Func<span class="token punctuation">:</span> <span class="token string">&quot;increment&quot;</span><span class="token punctuation">,</span> Result<span class="token punctuation">:</span> result<span class="token punctuation">}</span>
            v <span class="token operator">=</span> <span class="token operator">&lt;-</span>result
            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;increment = %v\n&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
            time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> compiled<span class="token punctuation">.</span><span class="token function">RunContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;-native-go"><a name="&#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;-native-go" class="anchor-navigation-ex-anchor" href="#&#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;-native-go"><i class="fa fa-link" aria-hidden="true"></i></a>5.1.1. &#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;: native go</h3>
<pre class="language-"><code class="lang-go"><span class="token comment">// NewGoProxy creates GoProxy object.</span>
<span class="token keyword">func</span> <span class="token function">NewGoProxy</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token operator">*</span>GoProxy <span class="token punctuation">{</span>
    mod <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>GoProxy<span class="token punctuation">)</span>
    mod<span class="token punctuation">.</span>ctx <span class="token operator">=</span> ctx
    mod<span class="token punctuation">.</span>callbacks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
    mod<span class="token punctuation">.</span>callChan <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>CallArgs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    mod<span class="token punctuation">.</span>moduleMap <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span>
        <span class="token string">&quot;next&quot;</span><span class="token punctuation">:</span>     <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> mod<span class="token punctuation">.</span>next<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;register&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> mod<span class="token punctuation">.</span>register<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;args&quot;</span><span class="token punctuation">:</span>     <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> mod<span class="token punctuation">.</span>args<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    mod<span class="token punctuation">.</span>tasks <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> mod
<span class="token punctuation">}</span>

<span class="token comment">// GoProxy is a builtin tengo module to register tengo functions and run them.</span>
<span class="token keyword">type</span> GoProxy <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    tengo<span class="token punctuation">.</span>ObjectImpl <span class="token comment">//&#x533F;&#x540D;&#x5305;&#x542B;tengo.ObjectImpl&#x5C31;&#x662F;tengo&#x7684;Object</span>
    ctx       context<span class="token punctuation">.</span>Context
    moduleMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object
    callbacks <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object
    callChan  <span class="token keyword">chan</span> <span class="token operator">*</span>CallArgs
    tasks     <span class="token operator">*</span>list<span class="token punctuation">.</span>List
    mtx       sync<span class="token punctuation">.</span>Mutex
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4E0A;&#x9762;&#x7684;mod.next mod.args&#x7B49;&#x7B26;&#x53F7;, &#x662F;&#x51FD;&#x6570;:
&#x6BD4;&#x5982;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>mod <span class="token operator">*</span>GoProxy<span class="token punctuation">)</span> <span class="token function">register</span><span class="token punctuation">(</span>args <span class="token operator">...</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> tengo<span class="token punctuation">.</span>ErrWrongNumArguments
    <span class="token punctuation">}</span>
    mod<span class="token punctuation">.</span>mtx<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> mod<span class="token punctuation">.</span>mtx<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">switch</span> v <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>tengo<span class="token punctuation">.</span>Map<span class="token punctuation">:</span>
        mod<span class="token punctuation">.</span>callbacks <span class="token operator">=</span> v<span class="token punctuation">.</span>Value
    <span class="token keyword">case</span> <span class="token operator">*</span>tengo<span class="token punctuation">.</span>ImmutableMap<span class="token punctuation">:</span>
        mod<span class="token punctuation">.</span>callbacks <span class="token operator">=</span> v<span class="token punctuation">.</span>Value
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> tengo<span class="token punctuation">.</span>ErrInvalidArgumentType<span class="token punctuation">{</span>
            Name<span class="token punctuation">:</span>     <span class="token string">&quot;first&quot;</span><span class="token punctuation">,</span>
            Expected<span class="token punctuation">:</span> <span class="token string">&quot;map&quot;</span><span class="token punctuation">,</span>
            Found<span class="token punctuation">:</span>    args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> tengo<span class="token punctuation">.</span>UndefinedValue<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x4E9B;&#x51FD;&#x6570;&#x5FC5;&#x987B;&#x7B26;&#x5408;<code>CallableFunc</code>&#x7B7E;&#x540D;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// CallableFunc is a function signature for the callable functions.</span>
<span class="token keyword">type</span> CallableFunc <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>args <span class="token operator">...</span>Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>ret Object<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x6CE8;&#x610F;, &#x8FD9;&#x91CC;mod.register&#x7B49;&#x51FD;&#x6570;, &#x5728;&#x8BED;&#x6CD5;&#x4E0A;&#x662F;<code>*GoProxy</code>&#x7684;&#x65B9;&#x6CD5;, &#x4E3A;&#x4EC0;&#x4E48;&#x7B26;&#x5408;CallableFunc&#x7B7E;&#x540D;&#x5462;?<br>tengo&#x811A;&#x672C;&#x91CC;&#x9762;&#x7684;<br><code>goproxy.register(callbacks)</code> &#x53C8;&#x662F;&#x600E;&#x4E48;&#x8C03;&#x7528;&#x5230;<code>func (mod *GoProxy) register(args ...tengo.Object) (tengo.Object, error)</code>&#x7684;&#x5462;? &#x8FD9;&#x91CC;&#x7684;receiver&#x662F;&#x4ECE;&#x54EA;&#x91CC;&#x6765;&#x7684;&#x5462;?<br>&#x8FD8;&#x6709;, New&#x8FC7;&#x7684;goproxy, &#x600E;&#x4E48;&#x5728;&#x811A;&#x672C;&#x548C;native go&#x4E4B;&#x524D;&#x5171;&#x4EAB;&#x7684;&#x5462;?<br><code>goproxy := NewGoProxy(ctx)</code><br>&#x89C1;
<a href="#native-go&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x811A;&#x672C;&#x7684;&#x9ED1;&#x9B54;&#x6CD5;">native go&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x811A;&#x672C;&#x7684;&#x9ED1;&#x9B54;&#x6CD5;</a></p>
<p>&#x6CE8;:</p>
<ul>
<li><p>native go&#x4E5F;&#x53EF;&#x4EE5;&#x8C03;&#x7528;tengo&#x7684;&#x51FD;&#x6570;<br>&#x811A;&#x672C;&#x7684;<code>goproxy.register(callbacks)</code>&#x5176;&#x5B9E;&#x4F1A;&#x8C03;&#x7528;&#x5230;native go&#x7684;register&#x51FD;&#x6570;, &#x800C;&#x5B83;&#x7684;callbacks&#x662F;tengo&#x811A;&#x672C;&#x91CC;&#x7684;&#x51FD;&#x6570;</p>
<pre class="language-"><code class="lang-go">global <span class="token operator">:=</span> <span class="token number">0</span>

   callbacks <span class="token operator">:=</span> <span class="token punctuation">{</span>
       sum<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> a <span class="token operator">+</span> b
       <span class="token punctuation">}</span><span class="token punctuation">,</span>
       multiply<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> a <span class="token operator">*</span> b
       <span class="token punctuation">}</span><span class="token punctuation">,</span>
       increment<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           global<span class="token operator">++</span>
           <span class="token keyword">return</span> global
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
</code></pre>
<p>&#x4E0A;&#x9762;&#x7684;&#x811A;&#x672C;&#x51FD;&#x6570;&#x5BF9;&#x5E94;native go&#x7684;<code>*tengo.CompiledFunction</code>&#x5BF9;&#x8C61;. &#x5728;neitive go&#x91CC;&#x65AD;&#x8A00;&#x5F97;&#x5230;compiledFunc&#x5BF9;&#x8C61;.</p>
<pre class="language-"><code class="lang-go"><span class="token comment">//mod.callbacks&#x662F;&#x5728;register&#x7684;&#x65F6;&#x5019;&#x8D4B;&#x503C;&#x7684;</span>
<span class="token comment">//mod.callbacks = v.Value</span>
f<span class="token punctuation">,</span> ok <span class="token operator">:=</span> mod<span class="token punctuation">.</span>callbacks<span class="token punctuation">[</span>callArgs<span class="token punctuation">.</span>Func<span class="token punctuation">]</span>
compiledFunc<span class="token punctuation">,</span> ok <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>CompiledFunction<span class="token punctuation">)</span>
</code></pre>
<p>&#x7136;&#x540E;return&#x4E00;&#x4E2A;&#x4E0D;&#x53EF;&#x6539;&#x7684;tengo.Map</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">return</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>ImmutableMap<span class="token punctuation">{</span>

  Value<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span>
      <span class="token operator">...</span>
      <span class="token string">&quot;callable&quot;</span><span class="token punctuation">:</span>   compiledFunc<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;, &#x811A;&#x672C;&#x5C31;&#x53C8;&#x53EF;&#x4EE5;&#x8C03;&#x7528;&quot;callable&quot;&#x51FD;&#x6570;&#x4E86;, &#x5373;&#x6700;&#x7EC8;, &#x811A;&#x672C;&#x8C03;&#x7528;&quot;callable&quot;&#x662F;compiledFunc, &#x800C;&#x540E;&#x8005;&#x5C31;&#x662F;&#x4ECE;tengo&#x811A;&#x672C;compile&#x6765;&#x7684;.</p>
</li>
<li><p>&#x901A;&#x5E38;&#x4F7F;&#x7528;&#x7C7B;&#x578B;&#x65AD;&#x8A00;&#x6765;&#x89E3;&#x53C2;&#x6570;, &#x6BD4;&#x5982;</p>
<pre class="language-"><code class="lang-go">  <span class="token keyword">switch</span> v <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token operator">*</span>tengo<span class="token punctuation">.</span>Map<span class="token punctuation">:</span>
      mod<span class="token punctuation">.</span>callbacks <span class="token operator">=</span> v<span class="token punctuation">.</span>Value
  <span class="token keyword">case</span> <span class="token operator">*</span>tengo<span class="token punctuation">.</span>ImmutableMap<span class="token punctuation">:</span>
      mod<span class="token punctuation">.</span>callbacks <span class="token operator">=</span> v<span class="token punctuation">.</span>Value
</code></pre>
<p>&#x8FD9;&#x9700;&#x8981;&#x76F4;&#x5230;tengo&#x4E2D;Object&#x7684;&#x5177;&#x4F53;&#x7C7B;&#x578B;&#x7684;&#x5B9A;&#x4E49;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> Map <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ObjectImpl
  Value <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Object
<span class="token punctuation">}</span>
</code></pre>
</li>
<li><p>native go&#x91CC;&#x5B9E;&#x73B0;&#x7684;&#x51FD;&#x6570;, &#x53EF;&#x4EE5;&#x505A;&#x53C2;&#x6570;&#x68C0;&#x67E5;:
&#x5728;&#x8FD9;&#x91CC;&#x662F;&#x63D0;&#x793A;tengo&#x811A;&#x672C;&#x91CC;&#x7684;&#x5165;&#x53C2;&#x7C7B;&#x578B;&#x4E0D;&#x5BF9;</p>
<pre class="language-"><code class="lang-go">  <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> tengo<span class="token punctuation">.</span>ErrInvalidArgumentType<span class="token punctuation">{</span>
          Name<span class="token punctuation">:</span>     <span class="token string">&quot;first&quot;</span><span class="token punctuation">,</span>
          Expected<span class="token punctuation">:</span> <span class="token string">&quot;map&quot;</span><span class="token punctuation">,</span>
          Found<span class="token punctuation">:</span>    args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
</code></pre>
</li>
</ul>
<p>&#x4ECE;tengo&#x811A;&#x672C;&#x8C03;&#x7528;native go&#x7684;&#x8FC7;&#x7A0B;&#x5C31;&#x662F;&#x89E3;tengo.Object&#x5230;go&#x5BF9;&#x8C61;, &#x8FD0;&#x7B97;, &#x518D;&#x8FD4;&#x56DE;tengo.Object&#x7684;&#x8FC7;&#x7A0B;</p>
<p>&#x51FD;&#x6570;&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x7684;Object, &#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x662F;&#x4E00;&#x4E2A;BuiltinModule</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>mod <span class="token operator">*</span>GoProxy<span class="token punctuation">)</span> <span class="token function">args</span><span class="token punctuation">(</span>args <span class="token operator">...</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mod<span class="token punctuation">.</span>mtx<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> mod<span class="token punctuation">.</span>mtx<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> mod<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tengo<span class="token punctuation">.</span>UndefinedValue<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    el <span class="token operator">:=</span> mod<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">Front</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    callArgs<span class="token punctuation">,</span> ok <span class="token operator">:=</span> el<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>CallArgs<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> callArgs <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;invalid call arguments&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    mod<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
    f<span class="token punctuation">,</span> ok <span class="token operator">:=</span> mod<span class="token punctuation">.</span>callbacks<span class="token punctuation">[</span>callArgs<span class="token punctuation">.</span>Func<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tengo<span class="token punctuation">.</span>UndefinedValue<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    compiledFunc<span class="token punctuation">,</span> ok <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>CompiledFunction<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tengo<span class="token punctuation">.</span>UndefinedValue<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    params <span class="token operator">:=</span> callArgs<span class="token punctuation">.</span>Params
    <span class="token keyword">if</span> params <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        params <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// callable.VarArgs implementation is omitted.</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>ImmutableMap<span class="token punctuation">{</span>
        Value<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span>
            <span class="token string">&quot;result&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">{</span>
                Value<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>args <span class="token operator">...</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                        callArgs<span class="token punctuation">.</span>Result <span class="token operator">&lt;-</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                        <span class="token keyword">return</span> tengo<span class="token punctuation">.</span>UndefinedValue<span class="token punctuation">,</span> <span class="token boolean">nil</span>
                    <span class="token punctuation">}</span>
                    callArgs<span class="token punctuation">.</span>Result <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>Error<span class="token punctuation">{</span>
                        Value<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>String<span class="token punctuation">{</span>
                            Value<span class="token punctuation">:</span> tengo<span class="token punctuation">.</span>ErrWrongNumArguments<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> tengo<span class="token punctuation">.</span>UndefinedValue<span class="token punctuation">,</span> <span class="token boolean">nil</span>
                <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">&quot;num_params&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> <span class="token function">int64</span><span class="token punctuation">(</span>compiledFunc<span class="token punctuation">.</span>NumParameters<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">&quot;callable&quot;</span><span class="token punctuation">:</span>   compiledFunc<span class="token punctuation">,</span>
            <span class="token string">&quot;params&quot;</span><span class="token punctuation">:</span>     <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>Array<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> params<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6CE8;: </p>
<ul>
<li>native go<code>&amp;tengo.ImmutableMap</code>&#x4E2D;&#x7684;<code>&quot;params&quot;:     &amp;tengo.Array{Value: params},</code>&#x53EF;&#x4EE5;&#x88AB;tengo&#x811A;&#x672C;&#x4F7F;&#x7528;: <code>v = callable(args.params[0], args.params[1], args.params[2])</code></li>
</ul>
<h3 id="&#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;-tengo&#x811A;&#x672C;"><a name="&#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;-tengo&#x811A;&#x672C;" class="anchor-navigation-ex-anchor" href="#&#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;-tengo&#x811A;&#x672C;"><i class="fa fa-link" aria-hidden="true"></i></a>5.1.2. &#x53EF;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#x5BF9;&#x8C61;: tengo&#x811A;&#x672C;</h3>
<p>&#x5728;main()&#x4E2D;import&#x4E86;tengo&#x7684;&#x6E90;&#x7801;:</p>
<pre class="language-"><code class="lang-go">moduleMap<span class="token punctuation">.</span><span class="token function">AddSourceModule</span><span class="token punctuation">(</span><span class="token string">&quot;proxy&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>ProxySource<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x811A;&#x672C;&#x6E90;&#x7801;&#x5728;&#x6B64;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// ProxySource is a tengo script to handle bidirectional arguments flow between</span>
<span class="token comment">// go and pure tengo functions. Note: you should add more if conditions for</span>
<span class="token comment">// different number of parameters.</span>
<span class="token comment">// TODO: handle variadic functions.</span>
<span class="token keyword">var</span> ProxySource <span class="token operator">=</span> <span class="token string">`
 export func(args) {
     if is_undefined(args) {
         return
     }
     callable := args.callable
     if is_undefined(callable) {
         return
     }
     result := args.result
     num_params := args.num_params
     v := undefined
     // add more else if conditions for different number of parameters.
     if num_params == 0 {
         v = callable()
     } else if num_params == 1 {
         v = callable(args.params[0])
     } else if num_params == 2 {
         v = callable(args.params[0], args.params[1])
     } else if num_params == 3 {
         v = callable(args.params[0], args.params[1], args.params[2])
     }
     result(v)
 }
 `</span>
</code></pre>
<p>&#x6CE8;:</p>
<ul>
<li>&#x8981;&#x5728;&#x5916;&#x90E8;&#x811A;&#x672C;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;, &#x7528;export&#x5173;&#x952E;&#x8BCD;&#x5BFC;&#x51FA;</li>
</ul>
<h3 id="native-go&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x811A;&#x672C;&#x7684;&#x9ED1;&#x9B54;&#x6CD5;"><a name="native-go&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x811A;&#x672C;&#x7684;&#x9ED1;&#x9B54;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#native-go&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x811A;&#x672C;&#x7684;&#x9ED1;&#x9B54;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>5.1.3. native go&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x811A;&#x672C;&#x7684;&#x9ED1;&#x9B54;&#x6CD5;</h3>
<p>&#x5728;native go&#x4E2D;, New&#x4E86;&#x5BF9;&#x8C61;&#x540E;, &#x53EA;&#x662F;&#x628A;goproxy&#x7684;moduleMap&#x6CE8;&#x518C;&#x7ED9;script</p>
<pre class="language-"><code class="lang-go">goproxy <span class="token operator">:=</span> <span class="token function">NewGoProxy</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
moduleMap<span class="token punctuation">.</span><span class="token function">AddBuiltinModule</span><span class="token punctuation">(</span><span class="token string">&quot;goproxy&quot;</span><span class="token punctuation">,</span> goproxy<span class="token punctuation">.</span><span class="token function">ModuleMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x5176;&#x4E2D;, &#x8FD9;&#x4E2A;map&#x5305;&#x62EC;&#x4E86;&#x8FD9;&#x4E2A;&#x6A21;&#x5757;&#x652F;&#x6301;&#x7684;&#x65B9;&#x6CD5;</p>
<pre class="language-"><code class="lang-go">    mod<span class="token punctuation">.</span>moduleMap <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span>
        <span class="token string">&quot;next&quot;</span><span class="token punctuation">:</span>     <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> mod<span class="token punctuation">.</span>next<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;register&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> mod<span class="token punctuation">.</span>register<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;args&quot;</span><span class="token punctuation">:</span>     <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> mod<span class="token punctuation">.</span>args<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x6BD4;&#x5982;, register&#x51FD;&#x6570;&#x539F;&#x578B;&#x662F;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>mod <span class="token operator">*</span>GoProxy<span class="token punctuation">)</span> <span class="token function">register</span><span class="token punctuation">(</span>args <span class="token operator">...</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x88AB;&#x5305;&#x88C5;&#x6210;&#x4E86;<code>&amp;tengo.UserFunction{Value: mod.register}</code>&#x4FDD;&#x5B58;&#x5728;<code>goproxy.ModuleMap</code>&#x4E2D;</p>
<p>&#x800C;&#x5728;tengo&#x811A;&#x672C;&#x4E2D;, import&#x53EA;&#x662F;&#x5F97;&#x5230;&#x8FD9;&#x4E2A;map, &#x5C31;&#x76F4;&#x63A5;&#x8C03;&#x7528;native go&#x7684;register&#x65B9;&#x6CD5;&#x4E86;</p>
<pre class="language-"><code class="lang-go">goproxy <span class="token operator">:=</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;goproxy&quot;</span><span class="token punctuation">)</span>
<span class="token comment">//&#x8C03;&#x7528;native go&#x7684;&#x65B9;&#x6CD5;</span>
goproxy<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span>
</code></pre>
<p>&#x90A3;&#x4E48;&#x95EE;&#x9898;&#x662F;, receiver&#x54EA;&#x53BB;&#x4E86;? &#x6CA1;&#x6709;receiver&#x600E;&#x4E48;&#x8C03;&#x7528;</p>
<h4 id="dlv&#x8C03;&#x67E5;"><a name="dlv&#x8C03;&#x67E5;" class="anchor-navigation-ex-anchor" href="#dlv&#x8C03;&#x67E5;"><i class="fa fa-link" aria-hidden="true"></i></a>dlv&#x8C03;&#x67E5;</h4>
<p>tengo&#x811A;&#x672C;&#x7ECF;&#x8FC7;compile&#x540E;, Run&#x8FD9;&#x4E2A;&#x5B57;&#x8282;&#x7801;:</p>
<pre class="language-"><code class="lang-go">compiled<span class="token punctuation">.</span><span class="token function">RunContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    vm<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>&#x7684;&#x6267;&#x884C;&#x5FAA;&#x73AF;&#x4E2D;
        <span class="token keyword">for</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v<span class="token punctuation">.</span>aborting<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            v<span class="token punctuation">.</span>ip<span class="token operator">++</span>
            <span class="token keyword">switch</span> v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token punctuation">]</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpCall<span class="token punctuation">:</span>
                <span class="token comment">//&#x652F;&#x6301;CompiledFunction&#x7C7B;&#x578B;&#x7684;&#x6267;&#x884C;, &#x8FD9;&#x5757;&#x5BF9;&#x5E94;tengo&#x7F16;&#x8BD1;&#x540E;&#x7684;&#x51FD;&#x6570;</span>
                <span class="token comment">//&#x4F46;&#x8FD9;&#x91CC;&#x8D70;&#x7684;&#x662F;UserFunction&#x7684;&#x5206;&#x652F;</span>
                    <span class="token keyword">var</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span>Object
                    args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span>numArgs<span class="token punctuation">:</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
                    <span class="token comment">//&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x4E86;</span>
                    <span class="token comment">//value&#x7684;&#x9759;&#x6001;&#x7C7B;&#x578B;&#x662F;tengo.Object, &#x52A8;&#x6001;&#x7C7B;&#x578B;&#x662F;tengo.UserFunction</span>
                    <span class="token comment">//&#x5176;&#x503C;&#x662F;main.(*GoProxy).register-fm, &#x89C1;&#x4E0B;&#x56FE;&#x5F53;&#x65F6;value&#x7684;&#x503C;</span>
                    ret<span class="token punctuation">,</span> e <span class="token operator">:=</span> value<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>args<span class="token operator">...</span><span class="token punctuation">)</span>
                    v<span class="token punctuation">.</span>sp <span class="token operator">-=</span> numArgs <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token operator">...</span>
</code></pre>
<p>&#x5F53;&#x65F6;value&#x7684;&#x503C;<br><img src="img/golang_tengo_20220910234048.png" alt=""><br>&#x5230;&#x8FD9;&#x91CC;&#x6709;&#x70B9;&#x6709;&#x610F;&#x601D;&#x4E86;: native go&#x6CE8;&#x518C;&#x7684;&#x51FD;&#x6570;&#x662F;mod.register</p>
<pre class="language-"><code class="lang-go">    mod<span class="token punctuation">.</span>moduleMap <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span>
        <span class="token string">&quot;register&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> mod<span class="token punctuation">.</span>register<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x91CC;&#x770B;&#x5230;&#x5B9E;&#x9645;&#x662F;<code>main.(*GoProxy).register-fm</code>
&#x8FD9;&#x4E2A;&#x5E26;<code>fm</code>&#x5B57;&#x6837;&#x7684;&#x51FD;&#x6570;&#x5E94;&#x8BE5;&#x662F;&#x7F16;&#x8BD1;&#x5668;&#x751F;&#x6210;&#x7684;, &#x6216;&#x8005;&#x8BF4;&#x662F;&#x7F16;&#x8BD1;&#x5668;&#x5185;&#x90E8;&#x5BF9;&quot;&#x65B9;&#x6CD5;&quot;&#x5230;&quot;&#x51FD;&#x6570;&quot;&#x7684;&#x8F6C;&#x6362;&#x8868;&#x8FBE;: &#x5B83;&#x81EA;&#x5E26;<code>.this</code>&#x505A;&#x4E3A;receiver<br><img src="img/golang_tengo_20220910234142.png" alt=""><br>dlv&#x5BF9;<code>main.(*GoProxy).register-fm</code>&#x7684;&#x5904;&#x7406;&#x4E5F;&#x662F;&#x9690;&#x5F62;&#x7684;: &#x5B83;&#x76F4;&#x63A5;&#x5B9A;&#x4F4D;&#x5230;<code>func (mod *GoProxy) register(args ...tengo.Object) (tengo.Object, error)</code>&#x51FD;&#x6570;, &#x4F46;&#x8C03;&#x7528;&#x6808;&#x80FD;&#x770B;&#x5230;:<code>register-fm</code>&#x662F;<code>register</code>&#x7684;&#x4E0A;&#x7EA7;&#x51FD;&#x6570;:<br><img src="img/golang_tengo_20220910234238.png" alt=""><br>&#x6CE8;&#x610F;: <code>register-fm</code>&#x7684;<code>.this</code>&#x5C31;&#x662F;&#x6CE8;&#x518C;&#x65F6;&#x5019;&#x7684;<code>&quot;register&quot;: &amp;tengo.UserFunction{Value: mod.register},</code>&#x4E2D;&#x7684;mod, &#x662F;<strong>&#x540C;&#x4E00;&#x4E2A;</strong>&#x5BF9;&#x8C61;.</p>
<p>&#x5F85;&#x8C03;&#x7528;&#x5230;<code>register</code>&#x65F6;, <code>.this</code>&#x4ECE;<code>register-fm</code>&#x53D8;&#x4E3A;receiver.</p>
<h4 id="&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x9B54;&#x6CD5;&#x63ED;&#x79D8;"><a name="&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x9B54;&#x6CD5;&#x63ED;&#x79D8;" class="anchor-navigation-ex-anchor" href="#&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x9B54;&#x6CD5;&#x63ED;&#x79D8;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5BF9;&#x8C61;&#x7A7F;&#x8D8A;&#x9B54;&#x6CD5;&#x63ED;&#x79D8;</h4>
<p>&#x7F16;&#x8BD1;&#x7684;&#x65F6;&#x5019;, &#x7F16;&#x8BD1;&#x5668;&#x53D1;&#x73B0;&#x8FD9;&#x91CC;&#x628A;&quot;&#x65B9;&#x6CD5;&quot;&#x8D4B;&#x503C;&#x7ED9;&quot;&#x51FD;&#x6570;&quot;, &#x6BD4;&#x5982;:<br><code>func (mod *GoProxy) register(args ...tengo.Object) (tengo.Object, error)</code><br>&#x8D4B;&#x503C;&#x7ED9;CallableFunc, &#x5176;&#x5B9A;&#x4E49;&#x4E3A;<code>func(args ...Object) (ret Object, err error)</code><br>&#x5373;:<br><code>&quot;register&quot;: &amp;tengo.UserFunction{Value: mod.register}</code></p>
<p>&#x90A3;&#x4E48;&#x6B64;&#x65F6;&#x7F16;&#x8BD1;&#x5668;&#x4F1A;&#x7ED9;&#x6BCF;&#x4E2A;<code>obj.function</code>&#x81EA;&#x52A8;&#x751F;&#x6210;<code>functionName-fm()</code>&#x51FD;&#x6570;, obj&#x88AB;&#x4FDD;&#x5B58;&#x5230;<code>.this</code>. &#x8FD0;&#x884C;&#x7684;&#x65F6;&#x5019;<code>functionName-fm()</code>&#x4F1A;&#x8C03;&#x7528;<code>obj.function()</code>, &#x5E76;&#x628A;&#x4FDD;&#x5B58;&#x7684;<code>.this</code>&#x505A;&#x4E3A;receiver, &#x7C7B;&#x4F3C;&#x8C03;&#x7528;<code>(.this).fucntion()</code><br>&#x7F16;&#x8BD1;&#x540E;&#x7684;&#x7B26;&#x53F7;&#x8868;&#x6709;<code>functionName-fm()</code>&#x51FA;&#x73B0;:<br><img src="img/golang_tengo_20220910234332.png" alt="">  </p>
<p><code>go tool objdump -S interoperability</code>&#x770B;&#x7684;&#x975E;&#x5E38;&#x6E05;&#x695A;: &#x8D4B;&#x503C;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x662F;register-fm<br><img src="img/golang_tengo_20220910234352.png" alt=""><br>&#x8FD9;&#x6837;&#x8D4B;&#x503C;&#x7684;&#x7ED3;&#x679C;&#x662F;: <code>mod</code>&#x5BF9;&#x8C61;&#x4F1A;&#x88AB;&#x5E26;&#x8FDB;<code>UserFunction</code></p>
<p>&#x6240;&#x4EE5;, &#x8FD9;&#x91CC;&#x7684;&#x9B54;&#x6CD5;&#x662F;&#x7F16;&#x8BD1;&#x5668;&#x5728;&#x628A;&quot;&#x65B9;&#x6CD5;&quot;&#x8F6C;&#x6362;&#x4E3A;&quot;&#x51FD;&#x6570;&quot;&#x65F6;, &#x751F;&#x6210;&#x7684;<code>-fm</code>&#x5305;&#x88C5;&#x4EE3;&#x7801;.
&#x8BE6;&#x89C1;: <code>src/cmd/compile/internal/gc/closure.go</code>&#x7684;<code>makepartialcall()</code>&#x51FD;&#x6570;</p>
<p>-- &#x771F;&#x6B63;&#x7684;&#x9ED1;&#x79D1;&#x6280;&#x6C38;&#x8FDC;&#x662F;&#x82AF;&#x7247;&#x548C;&#x7F16;&#x8BD1;&#x5668;</p>
<h4 id="&#x4F7F;&#x7528;&#x6CE8;&#x610F;"><a name="&#x4F7F;&#x7528;&#x6CE8;&#x610F;" class="anchor-navigation-ex-anchor" href="#&#x4F7F;&#x7528;&#x6CE8;&#x610F;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4F7F;&#x7528;&#x6CE8;&#x610F;</h4>
<p>&#x6CE8;&#x610F;&#x8981;&#x7528;<strong>&#x5B9E;&#x9645;</strong>&#x5BF9;&#x8C61;&#x7684;&#x65B9;&#x6CD5;&#x6765;&#x6CE8;&#x518C;, &#x5373;&#x4E0B;&#x9762;&#x7684;<code>mod</code>&#x662F;&#x4E2A;&#x5B9E;&#x4F8B;&#x5316;&#x8FC7;&#x7684;&#x5BF9;&#x8C61;.</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// NewGoProxy creates GoProxy object.</span>
<span class="token keyword">func</span> <span class="token function">NewGoProxy</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token operator">*</span>GoProxy <span class="token punctuation">{</span>
    mod <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>GoProxy<span class="token punctuation">)</span>
    mod<span class="token punctuation">.</span>ctx <span class="token operator">=</span> ctx
    mod<span class="token punctuation">.</span>callbacks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
    mod<span class="token punctuation">.</span>callChan <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>CallArgs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    mod<span class="token punctuation">.</span>moduleMap <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">{</span>
        <span class="token string">&quot;next&quot;</span><span class="token punctuation">:</span>     <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> mod<span class="token punctuation">.</span>next<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;register&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> mod<span class="token punctuation">.</span>register<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;args&quot;</span><span class="token punctuation">:</span>     <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>UserFunction<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> mod<span class="token punctuation">.</span>args<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    mod<span class="token punctuation">.</span>tasks <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> mod
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5176;&#x5B9E;<code>(*GoProxy).next</code>&#x4E5F;&#x662F;&#x8BED;&#x6CD5;&#x5408;&#x6CD5;&#x7684;, &#x4F46;&#x5B83;&#x662F;<code>type func(*GoProxy, args ...v2.Object) (v2.Object, error)</code>, &#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x662F;<code>*GoProxy</code>; &#x5728;&#x8FD9;&#x91CC;&#x4E0D;&#x80FD;&#x8D4B;&#x503C;&#x7ED9;<code>func(args ...Object) (ret Object, err error)</code></p>
<h3 id="&#x603B;&#x7ED3;"><a name="&#x603B;&#x7ED3;" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;"><i class="fa fa-link" aria-hidden="true"></i></a>5.1.4. &#x603B;&#x7ED3;</h3>
<p>tengo&#x811A;&#x672C;&#x548C;&#x81EA;&#x5B9A;&#x4E49;native go&#x7684;&#x4EA4;&#x4E92;:</p>
<ul>
<li>native go&#x7684;&#x5165;&#x53C2;&#x548C;&#x8FD4;&#x56DE;&#x503C;&#x90FD;&#x662F;tengo.Object</li>
<li>native go&#x8FD4;&#x56DE;&#x7684;tengo.Object&#x7684;concrete&#x7C7B;&#x578B;&#x53EF;&#x4EE5;&#x662F;<ul>
<li>&amp;tengo.UserFunction: &#x811A;&#x672C;&#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x8C03;&#x51FD;&#x6570;</li>
<li>&amp;tengo.Int: &#x811A;&#x672C;&#x80FD;&#x76F4;&#x63A5;&#x7528;&#x505A;Int</li>
<li>&amp;tengo.Array: &#x811A;&#x672C;&#x80FD;&#x6309;[index]&#x6765;&#x8BBF;&#x95EE;</li>
<li>&#x5176;&#x4ED6;Object&#x7C7B;&#x578B;</li>
<li>&#x4F30;&#x8BA1;&#x4E5F;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;, &#x89C1;<a href="#&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;">&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;</a></li>
</ul>
</li>
<li>tengo&#x811A;&#x672C;&#x53EF;&#x4EE5;&#x8C03;&#x7528;native go&#x7684;&#x4EE3;&#x7801;</li>
<li>native go&#x4E5F;&#x53EF;&#x4EE5;&#x8C03;&#x7528;tengo&#x7684;&#x51FD;&#x6570;</li>
<li>native go&#x7684;&#x5BF9;&#x8C61;&#x65B9;&#x6CD5;&#x80FD;&#x591F;&#x8F6C;&#x6362;&#x4E3A;tengo&#x811A;&#x672C;&#x7684;&#x51FD;&#x6570;. </li>
<li>&#x8981;&#x5728;tengo&#x811A;&#x672C;&#x91CC;import(&quot;module_name&quot;), &#x8FD9;&#x4E2A;module&#x5FC5;&#x987B;&#x5148;&#x5728;native go&#x4EE3;&#x7801;&#x91CC;&#x6CE8;&#x518C;.
&#x53C2;&#x8003;<code>stdlib/stdlib.go</code>&#x4E2D;&#x7684;<code>GetModuleMap()</code>&#x51FD;&#x6570;</li>
</ul>
<h2 id="tengo&#x9501;"><a name="tengo&#x9501;" class="anchor-navigation-ex-anchor" href="#tengo&#x9501;"><i class="fa fa-link" aria-hidden="true"></i></a>5.2. tengo&#x9501;</h2>
<h2 id="tengo&#x5E76;&#x53D1;"><a name="tengo&#x5E76;&#x53D1;" class="anchor-navigation-ex-anchor" href="#tengo&#x5E76;&#x53D1;"><i class="fa fa-link" aria-hidden="true"></i></a>5.3. tengo&#x5E76;&#x53D1;</h2>
<p>script_test.go&#x4E2D;, &#x6709;&#x4E2A;&#x6D4B;&#x5E76;&#x53D1;&#x7684;&#x51FD;&#x6570;: &#x7528;&#x4E86;compiled.Clone()&#x590D;&#x5236;&#x4E00;&#x4E2A;compiled&#x5BF9;&#x8C61;, &#x6BCF;&#x4E2A;go routine&#x7528;&#x590D;&#x5236;&#x7684;compiled&#x5BF9;&#x8C61;&#x6765;&#x8FD0;&#x884C;.</p>
<pre class="language-"><code class="lang-go">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> concurrency<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>compiled <span class="token operator">*</span>tengo<span class="token punctuation">.</span>Compiled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">Int63n</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
            <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            a <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
            b <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
            c <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

            d<span class="token punctuation">,</span> e <span class="token operator">:=</span> <span class="token function">executeFn</span><span class="token punctuation">(</span>compiled<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
            expectedD<span class="token punctuation">,</span> expectedE <span class="token operator">:=</span> <span class="token function">solve</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>

            require<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> expectedD<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token string">&quot;input: %d, %d, %d&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
            require<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> expectedE<span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token string">&quot;input: %d, %d, %d&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span><span class="token function">Clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>Clone&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x662F;clone&#x4E86;golbals&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x96C6;, &#x8FD9;&#x6837;routine&#x4E4B;&#x524D;&#x7684;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x4E0D;&#x6253;&#x67B6;.<br>&#x5176;&#x4ED6;&#x7684;&#x51E0;&#x4E2A;filed, &#x90FD;&#x6CA1;&#x6709;&#x5B9E;&#x9645;&#x62F7;&#x8D1D;, &#x800C;&#x662F;&#x7528;&#x4E86;&#x5F15;&#x7528;.</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Clone creates a new copy of Compiled. Cloned copies are safe for concurrent</span>
<span class="token comment">// use by multiple goroutines.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiled<span class="token punctuation">)</span> <span class="token function">Clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Compiled <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    clone <span class="token operator">:=</span> <span class="token operator">&amp;</span>Compiled<span class="token punctuation">{</span>
        globalIndexes<span class="token punctuation">:</span> c<span class="token punctuation">.</span>globalIndexes<span class="token punctuation">,</span>
        bytecode<span class="token punctuation">:</span>      c<span class="token punctuation">.</span>bytecode<span class="token punctuation">,</span>
        globals<span class="token punctuation">:</span>       <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>globals<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        maxAllocs<span class="token punctuation">:</span>     c<span class="token punctuation">.</span>maxAllocs<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// copy global objects</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> g <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>globals <span class="token punctuation">{</span>
        <span class="token keyword">if</span> g <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            clone<span class="token punctuation">.</span>globals<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> g
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> clone
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8BF4;&#x660E;:</p>
<ul>
<li>&#x5728;vM&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;, bytecode&#x662F;&#x4E0D;&#x4F1A;&#x53D8;&#x7684;</li>
<li>global&#x7684;&#x5BF9;&#x7167;&#x8868;&#x4E5F;&#x4E0D;&#x53D8;</li>
</ul>
<h2 id="&#x4EE3;&#x7801;&#x7EC4;&#x7EC7;"><a name="&#x4EE3;&#x7801;&#x7EC4;&#x7EC7;" class="anchor-navigation-ex-anchor" href="#&#x4EE3;&#x7801;&#x7EC4;&#x7EC7;"><i class="fa fa-link" aria-hidden="true"></i></a>5.4. &#x4EE3;&#x7801;&#x7EC4;&#x7EC7;:</h2>
<p>tengo&#x5F88;&#x591A;&#x4EE3;&#x7801;&#x90FD;&#x662F;&#x76F4;&#x63A5;&#x5C5E;&#x4E8E;tengo&#x5305;&#x7684;.</p>
<h3 id="&#x603B;&#x7ED3;_1"><a name="&#x603B;&#x7ED3;_1" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;_1"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.1. &#x603B;&#x7ED3;</h3>
<ul>
<li><code>SourceFile</code>&#x548C;<code>symbolTable</code>&#x548C;<code>constants</code>&#x548C;<code>modules</code>&#x662F;Compiler(<code>*tengo.Compiler</code>)&#x7684;&#x5C5E;&#x6027;.</li>
<li>&#x800C;&#x7ECF;&#x8FC7;parser&#x89E3;&#x6790;&#x6587;&#x672C;&#x5185;&#x5BB9;&#x800C;&#x6765;&#x7684;&#x4EE3;&#x8868;ast&#x7684;<code>parser.File</code>&#x662F;Compiler&#x7684;&#x8F93;&#x5165;</li>
<li>&#x7F16;&#x8BD1;&#x540E;&#x7684;bytecode&#x548C;&#x5168;&#x5C40;&#x53D8;&#x91CF;array&#x662F;&#x8FD0;&#x884C;&#x65F6;VM&#x7684;&#x8F93;&#x5165;</li>
<li>constants&#x662F;&#x8FD0;&#x884C;&#x65F6;&quot;&#x4E0D;&#x53D8;&quot;&#x7684;Object&#x7684;&#x96C6;&#x5408;. &#x6BD4;&#x5982;:<code>a:=1</code>&#x548C;<code>b:=2</code>&#x4E2D;&#x7684;a&#x548C;b&#x662F;constant; &#x800C;<code>c=a+b</code>&#x7684;<code>c</code>&#x5C31;&#x4E0D;&#x662F;constant. &#x4E0D;&#x53D8;&#x7684;&#x51FD;&#x6570;&#x4E5F;&#x662F;constant. &#x968F;&#x7740;bytecode&#x4F20;&#x9012;, &#x6BCF;&#x6B21;&#x6267;&#x884C;&#x4F1A;&#x6539;&#x53D8;</li>
<li>tengo&#x7684;Script&#x7ECF;&#x8FC7;compile&#x540E;&#x7684;compiled&#x5BF9;&#x8C61;, &#x4EE3;&#x8868;&#x4E86;VM&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x6B65;&#x9AA4;.<ul>
<li>compiled&#x5305;&#x62EC;globals&#x548C;bytecode</li>
<li>&#x5728;&#x6CA1;&#x6709;compiled.Run&#x4E4B;&#x524D;, globals&#x662F;&#x53EF;&#x4EE5;&#x6539;&#x7684;. compiled.Set()&#x53EF;&#x4EE5;&#x6539;</li>
<li>compiled.Get()&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x7ED3;&#x679C;.</li>
<li>compiled&#x7684;Get()&#x548C;Set()&#x662F;go&#x8C03;&#x7528;tengo&#x811A;&#x672C;&#x7684;&#x65F6;&#x5019;, &#x548C;&#x811A;&#x672C;&#x4EA4;&#x4E92;&#x53D8;&#x91CF;&#x7528;&#x7684;.</li>
</ul>
</li>
</ul>
<h3 id="errorgo"><a name="errorgo" class="anchor-navigation-ex-anchor" href="#errorgo"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.2. error.go</h3>
<p>&#x5185;&#x90E8;&#x9884;&#x5B9A;&#x4E49;&#x9519;&#x8BEF;, &#x6BD4;&#x5982;<code>ErrStringLimit = errors.New(&quot;exceeding string size limit&quot;)</code></p>
<h3 id="requirerequirego"><a name="requirerequirego" class="anchor-navigation-ex-anchor" href="#requirerequirego"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.3. require/require.go</h3>
<p>require.go&#x4F9D;&#x8D56;&#x6807;&#x51C6;&#x5E93;testing, &#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E9B;type&#x65AD;&#x8A00;&#x7684;&#x529F;&#x80FD;. &#x4E3B;&#x8981;&#x662F;tengo&#x7684;&#x5185;&#x90E8;test&#x4EE3;&#x7801;&#x5728;&#x7528;.</p>
<h3 id="parseropcodesgo"><a name="parseropcodesgo" class="anchor-navigation-ex-anchor" href="#parseropcodesgo"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.4. parser/opcodes.go</h3>
<p>opcodes&#x5B9A;&#x4E49;&#x4E86;&#x652F;&#x6301;&#x7684;&#x6240;&#x6709;&#x64CD;&#x4F5C;:
&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x662F;&quot;&#x6307;&#x4EE4;&#x6D41;&quot;&#x7684;&#x64CD;&#x4F5C;, &#x6CA1;&#x6709;for, &#x56E0;&#x4E3A;for&#x5DF2;&#x7ECF;&#x88AB;&#x7F16;&#x8BD1;&#x6210;&#x7C7B;&#x4F3C;Jump&#x7684;&#x6307;&#x4EE4;&#x4E86;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// List of opcodes</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
    OpConstant      Opcode <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">// Load constant</span>
    OpBComplement                 <span class="token comment">// bitwise complement</span>
    OpPop                         <span class="token comment">// Pop</span>
    OpTrue                        <span class="token comment">// Push true</span>
    OpFalse                       <span class="token comment">// Push false</span>
    OpEqual                       <span class="token comment">// Equal ==</span>
    OpNotEqual                    <span class="token comment">// Not equal !=</span>
    OpMinus                       <span class="token comment">// Minus -</span>
    OpLNot                        <span class="token comment">// Logical not !</span>
    OpJumpFalsy                   <span class="token comment">// Jump if falsy</span>
    OpAndJump                     <span class="token comment">// Logical AND jump</span>
    OpOrJump                      <span class="token comment">// Logical OR jump</span>
    OpJump                        <span class="token comment">// Jump</span>
    OpNull                        <span class="token comment">// Push null</span>
    OpArray                       <span class="token comment">// Array object</span>
    OpMap                         <span class="token comment">// Map object</span>
    OpError                       <span class="token comment">// Error object</span>
    OpImmutable                   <span class="token comment">// Immutable object</span>
    OpIndex                       <span class="token comment">// Index operation</span>
    OpSliceIndex                  <span class="token comment">// Slice operation</span>
    OpCall                        <span class="token comment">// Call function</span>
    OpReturn                      <span class="token comment">// Return</span>
    OpGetGlobal                   <span class="token comment">// Get global variable</span>
    OpSetGlobal                   <span class="token comment">// Set global variable</span>
    OpSetSelGlobal                <span class="token comment">// Set global variable using selectors</span>
    OpGetLocal                    <span class="token comment">// Get local variable</span>
    OpSetLocal                    <span class="token comment">// Set local variable</span>
    OpDefineLocal                 <span class="token comment">// Define local variable</span>
    OpSetSelLocal                 <span class="token comment">// Set local variable using selectors</span>
    OpGetFreePtr                  <span class="token comment">// Get free variable pointer object</span>
    OpGetFree                     <span class="token comment">// Get free variables</span>
    OpSetFree                     <span class="token comment">// Set free variables</span>
    OpGetLocalPtr                 <span class="token comment">// Get local variable as a pointer</span>
    OpSetSelFree                  <span class="token comment">// Set free variables using selectors</span>
    OpGetBuiltin                  <span class="token comment">// Get builtin function</span>
    OpClosure                     <span class="token comment">// Push closure</span>
    OpIteratorInit                <span class="token comment">// Iterator init</span>
    OpIteratorNext                <span class="token comment">// Iterator next</span>
    OpIteratorKey                 <span class="token comment">// Iterator key</span>
    OpIteratorValue               <span class="token comment">// Iterator value</span>
    OpBinaryOp                    <span class="token comment">// Binary operation</span>
    OpSuspend                     <span class="token comment">// Suspend VM</span>
<span class="token punctuation">)</span>
</code></pre>
<h3 id="parsersourcefilego"><a name="parsersourcefilego" class="anchor-navigation-ex-anchor" href="#parsersourcefilego"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.5. parser/source_file.go</h3>
<p>&#x63D0;&#x4F9B;&#x4E86;&#x811A;&#x672C;file&#x7684;&#x8868;&#x8FBE;, &#x91CD;&#x70B9;&#x662F;file &#x96C6;&#x5408;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// SourceFileSet represents a set of source files.</span>
<span class="token keyword">type</span> SourceFileSet <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Base     <span class="token builtin">int</span>           <span class="token comment">// base offset for the next file</span>
    Files    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SourceFile <span class="token comment">// list of files in the order added to the set</span>
    LastFile <span class="token operator">*</span>SourceFile   <span class="token comment">// cache of last file looked up</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5176;&#x4E2D;SourceFile&#x8FD8;&#x53EF;&#x4EE5;&#x5305;&#x62EC;Files</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// SourceFile represents a source file.</span>
<span class="token keyword">type</span> SourceFile <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// SourceFile set for the file</span>
    set <span class="token operator">*</span>SourceFileSet
    <span class="token comment">// SourceFile name as provided to AddFile</span>
    Name <span class="token builtin">string</span>
    <span class="token comment">// SourcePos value range for this file is [base...base+size]</span>
    Base <span class="token builtin">int</span>
    <span class="token comment">// SourceFile size as provided to AddFile</span>
    Size <span class="token builtin">int</span>
    <span class="token comment">// Lines contains the offset of the first character for each line</span>
    <span class="token comment">// (the first entry is always 0)</span>
    Lines <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6240;&#x4EE5;&#x4E00;&#x4E2A;file&#x96C6;&#x5408;&#x662F;&#x4E2A;&#x6811;&#x72B6;&#x7684;.</p>
<h3 id="parserparsergo"><a name="parserparsergo" class="anchor-navigation-ex-anchor" href="#parserparsergo"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.6. parser/parser.go</h3>
<p>parser&#x7684;&#x5E95;&#x5C42;&#x662F;token, &#x5BF9;&#x4E0B;&#x8C03;&#x7528;token&#x7684;&#x65B9;&#x6CD5;, &#x5BF9;&#x4E0A;&#x63D0;&#x4F9B;&#x8BCD;&#x6CD5;&#x5206;&#x6790;
parser&#x6301;&#x6709;scanner&#x5B9E;&#x4F8B;, &#x63D0;&#x4F9B;next&#x65B9;&#x6CD5;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Parser parses the Tengo source files. It&apos;s based on Go&apos;s parser</span>
<span class="token comment">// implementation.</span>
<span class="token keyword">type</span> Parser <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    file      <span class="token operator">*</span>SourceFile
    errors    ErrorList
    scanner   <span class="token operator">*</span>Scanner
    pos       Pos
    token     token<span class="token punctuation">.</span>Token
    tokenLit  <span class="token builtin">string</span>
    exprLevel <span class="token builtin">int</span> <span class="token comment">// &lt; 0: in control clause, &gt;= 0: in expression</span>
    syncPos   Pos <span class="token comment">// last sync position</span>
    syncCount <span class="token builtin">int</span> <span class="token comment">// number of advance calls without progress</span>
    trace     <span class="token builtin">bool</span>
    indent    <span class="token builtin">int</span>
    traceOut  io<span class="token punctuation">.</span>Writer
<span class="token punctuation">}</span>
</code></pre>
<h4 id="newparser&#x51FD;&#x6570;"><a name="newparser&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#newparser&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>NewParser()&#x51FD;&#x6570;</h4>
<p>NewParser&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;parser&#x5BF9;&#x8C61;, &#x503C;&#x5F97;&#x4E00;&#x63D0;&#x7684;&#x662F;, &#x5982;&#x679C;trace&#x4E0D;&#x662F;nil, &#x4F1A;&#x8F93;&#x51FA;debug&#x4FE1;&#x606F;&#x5230;&#x6307;&#x5B9A;&#x7684;io.Writer</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// NewParser creates a Parser.</span>
<span class="token keyword">func</span> <span class="token function">NewParser</span><span class="token punctuation">(</span>file <span class="token operator">*</span>SourceFile<span class="token punctuation">,</span> src <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> trace io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token operator">*</span>Parser <span class="token punctuation">{</span>
    p <span class="token operator">:=</span> <span class="token operator">&amp;</span>Parser<span class="token punctuation">{</span>
        file<span class="token punctuation">:</span>     file<span class="token punctuation">,</span>
        trace<span class="token punctuation">:</span>    trace <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
        traceOut<span class="token punctuation">:</span> trace<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    p<span class="token punctuation">.</span>scanner <span class="token operator">=</span> <span class="token function">NewScanner</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>file<span class="token punctuation">,</span> src<span class="token punctuation">,</span>
        <span class="token keyword">func</span><span class="token punctuation">(</span>pos SourceFilePos<span class="token punctuation">,</span> msg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            p<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> p
<span class="token punctuation">}</span>
</code></pre>
<h4 id="parsefile&#x51FD;&#x6570;"><a name="parsefile&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#parsefile&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>ParseFile()&#x51FD;&#x6570;</h4>
<p>ParseFile&#x7684;&#x6838;&#x5FC3;&#x662F;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;[]Stmt, &#x5373;&#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x96C6;&#x5408;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// ParseFile parses the source and returns an AST file unit.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Parser<span class="token punctuation">)</span> <span class="token function">ParseFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>file <span class="token operator">*</span>File<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> e <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token punctuation">(</span>bailout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                <span class="token function">panic</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        p<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x8FD9;&#x91CC;&#x7528;defer&#x5728;&#x6700;&#x540E;&#x6765;&#x6392;&#x5E8F;erros</span>
        err <span class="token operator">=</span> p<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> p<span class="token punctuation">.</span>trace <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">untracep</span><span class="token punctuation">(</span><span class="token function">tracep</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">&quot;File&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//&#x4F7F;&#x7528;&#x4E86;defer&#x7684;trace&#x6280;&#x672F;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> p<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    stmts <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">parseStmtList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    file <span class="token operator">=</span> <span class="token operator">&amp;</span>File<span class="token punctuation">{</span>
        InputFile<span class="token punctuation">:</span> p<span class="token punctuation">.</span>file<span class="token punctuation">,</span>
        Stmts<span class="token punctuation">:</span>     stmts<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre>
<p>stmt&#x662F;&#x4E2A;&#x62BD;&#x8C61;&#x5316;&#x7684;&#x63A5;&#x53E3;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> Stmt <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    Node
    <span class="token function">stmtNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>parseStmtList()</code>&#x4E0D;&#x65AD;&#x8C03;&#x7528;<code>p.parseStmt()</code>, &#x5E76;&#x628A;&#x7ED3;&#x679C;&#x653E;&#x5230;<code>[]Stmt</code>&#x4E2D;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Parser<span class="token punctuation">)</span> <span class="token function">parseStmtList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>list <span class="token punctuation">[</span><span class="token punctuation">]</span>Stmt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>trace <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">untracep</span><span class="token punctuation">(</span><span class="token function">tracep</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">&quot;StatementList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> p<span class="token punctuation">.</span>token <span class="token operator">!=</span> token<span class="token punctuation">.</span>RBrace <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>token <span class="token operator">!=</span> token<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
        list <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">parseStmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>parseStmt()</code>&#x662F;&#x6838;&#x5FC3;&#x51FD;&#x6570;, &#x6839;&#x636E;&#x6BCF;&#x6B21;&#x6839;&#x636E;token&#x7684;&#x7C7B;&#x578B;&#x505A;&#x52A8;&#x4F5C;, &#x5E76;&#x4E14;&#x524D;&#x8FDB;(advance)</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Parser<span class="token punctuation">)</span> <span class="token function">parseStmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>stmt Stmt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>trace <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">untracep</span><span class="token punctuation">(</span><span class="token function">tracep</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">&quot;Statement&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span> p<span class="token punctuation">.</span>token <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token comment">// simple statements</span>
        token<span class="token punctuation">.</span>Func<span class="token punctuation">,</span> token<span class="token punctuation">.</span>Error<span class="token punctuation">,</span> token<span class="token punctuation">.</span>Immutable<span class="token punctuation">,</span> token<span class="token punctuation">.</span>Ident<span class="token punctuation">,</span> token<span class="token punctuation">.</span>Int<span class="token punctuation">,</span>
        token<span class="token punctuation">.</span>Float<span class="token punctuation">,</span> token<span class="token punctuation">.</span>Char<span class="token punctuation">,</span> token<span class="token punctuation">.</span>String<span class="token punctuation">,</span> token<span class="token punctuation">.</span>True<span class="token punctuation">,</span> token<span class="token punctuation">.</span>False<span class="token punctuation">,</span>
        token<span class="token punctuation">.</span>Undefined<span class="token punctuation">,</span> token<span class="token punctuation">.</span>Import<span class="token punctuation">,</span> token<span class="token punctuation">.</span>LParen<span class="token punctuation">,</span> token<span class="token punctuation">.</span>LBrace<span class="token punctuation">,</span>
        token<span class="token punctuation">.</span>LBrack<span class="token punctuation">,</span> token<span class="token punctuation">.</span>Add<span class="token punctuation">,</span> token<span class="token punctuation">.</span>Sub<span class="token punctuation">,</span> token<span class="token punctuation">.</span>Mul<span class="token punctuation">,</span> token<span class="token punctuation">.</span>And<span class="token punctuation">,</span> token<span class="token punctuation">.</span>Xor<span class="token punctuation">,</span>
        token<span class="token punctuation">.</span>Not<span class="token punctuation">:</span>
        s <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">parseSimpleStmt</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span><span class="token function">expectSemi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> s
    <span class="token keyword">case</span> token<span class="token punctuation">.</span>Return<span class="token punctuation">:</span>
        <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">parseReturnStmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> token<span class="token punctuation">.</span>Export<span class="token punctuation">:</span>
        <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">parseExportStmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> token<span class="token punctuation">.</span>If<span class="token punctuation">:</span>
        <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">parseIfStmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> token<span class="token punctuation">.</span>For<span class="token punctuation">:</span>
        <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">parseForStmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> token<span class="token punctuation">.</span>Break<span class="token punctuation">,</span> token<span class="token punctuation">.</span>Continue<span class="token punctuation">:</span>
        <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">parseBranchStmt</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>token<span class="token punctuation">)</span>
    <span class="token keyword">case</span> token<span class="token punctuation">.</span>Semicolon<span class="token punctuation">:</span>
        s <span class="token operator">:=</span> <span class="token operator">&amp;</span>EmptyStmt<span class="token punctuation">{</span>Semicolon<span class="token punctuation">:</span> p<span class="token punctuation">.</span>pos<span class="token punctuation">,</span> Implicit<span class="token punctuation">:</span> p<span class="token punctuation">.</span>tokenLit <span class="token operator">==</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">}</span>
        p<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> s
    <span class="token keyword">case</span> token<span class="token punctuation">.</span>RBrace<span class="token punctuation">:</span>
        <span class="token comment">// semicolon may be omitted before a closing &quot;}&quot;</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>EmptyStmt<span class="token punctuation">{</span>Semicolon<span class="token punctuation">:</span> p<span class="token punctuation">.</span>pos<span class="token punctuation">,</span> Implicit<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        pos <span class="token operator">:=</span> p<span class="token punctuation">.</span>pos
        p<span class="token punctuation">.</span><span class="token function">errorExpected</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> <span class="token string">&quot;statement&quot;</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span><span class="token function">advance</span><span class="token punctuation">(</span>stmtStart<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>BadStmt<span class="token punctuation">{</span>From<span class="token punctuation">:</span> pos<span class="token punctuation">,</span> To<span class="token punctuation">:</span> p<span class="token punctuation">.</span>pos<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6BD4;&#x5982;&#x5176;&#x4E2D;&#x7684;<code>token.If</code></p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Parser<span class="token punctuation">)</span> <span class="token function">parseIfStmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Stmt <span class="token punctuation">{</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>trace <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">untracep</span><span class="token punctuation">(</span><span class="token function">tracep</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">&quot;IfStmt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    pos <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>If<span class="token punctuation">)</span>
    init<span class="token punctuation">,</span> cond <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">parseIfHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    body <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">parseBlockStmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> elseStmt Stmt
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>token <span class="token operator">==</span> token<span class="token punctuation">.</span>Else <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">switch</span> p<span class="token punctuation">.</span>token <span class="token punctuation">{</span>
        <span class="token keyword">case</span> token<span class="token punctuation">.</span>If<span class="token punctuation">:</span>
            elseStmt <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">parseIfStmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> token<span class="token punctuation">.</span>LBrace<span class="token punctuation">:</span>
            elseStmt <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">parseBlockStmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            p<span class="token punctuation">.</span><span class="token function">expectSemi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            p<span class="token punctuation">.</span><span class="token function">errorExpected</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>pos<span class="token punctuation">,</span> <span class="token string">&quot;if or {&quot;</span><span class="token punctuation">)</span>
            elseStmt <span class="token operator">=</span> <span class="token operator">&amp;</span>BadStmt<span class="token punctuation">{</span>From<span class="token punctuation">:</span> p<span class="token punctuation">.</span>pos<span class="token punctuation">,</span> To<span class="token punctuation">:</span> p<span class="token punctuation">.</span>pos<span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span><span class="token function">expectSemi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>IfStmt<span class="token punctuation">{</span>
        IfPos<span class="token punctuation">:</span> pos<span class="token punctuation">,</span>
        Init<span class="token punctuation">:</span>  init<span class="token punctuation">,</span>
        Cond<span class="token punctuation">:</span>  cond<span class="token punctuation">,</span>
        Body<span class="token punctuation">:</span>  body<span class="token punctuation">,</span>
        Else<span class="token punctuation">:</span>  elseStmt<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x5B58;&#x5728;&#x4E0D;&#x5C11;&#x7684;&#x9012;&#x5F52;. &#x6BD4;&#x5982;if&#x7684;body&#x5C31;&#x662F;<code>body := p.parseBlockStmt()</code>, &#x800C;BlockStmt&#x91CC;&#x9762;&#x53C8;&#x53EF;&#x4EE5;&#x5305;&#x542B;&#x4EFB;&#x4F55;&#x7684;&#x8BED;&#x53E5;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Parser<span class="token punctuation">)</span> <span class="token function">parseBlockStmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>BlockStmt <span class="token punctuation">{</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>trace <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">untracep</span><span class="token punctuation">(</span><span class="token function">tracep</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">&quot;BlockStmt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    lbrace <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>LBrace<span class="token punctuation">)</span>
    list <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">parseStmtList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    rbrace <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>RBrace<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>BlockStmt<span class="token punctuation">{</span>
        LBrace<span class="token punctuation">:</span> lbrace<span class="token punctuation">,</span>
        RBrace<span class="token punctuation">:</span> rbrace<span class="token punctuation">,</span>
        Stmts<span class="token punctuation">:</span>  list<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="formattergo"><a name="formattergo" class="anchor-navigation-ex-anchor" href="#formattergo"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.7. formatter.go</h3>
<p>&#x63D0;&#x4F9B;&#x4E86;format tengo&#x5BF9;&#x8C61;Object&#x7684;&#x51FD;&#x6570;, &#x8FD9;&#x4E9B;&#x51FD;&#x6570;&#x662F;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;&#x7684;, &#x4E0D;&#x4F9D;&#x8D56;&#x6807;&#x51C6;&#x5E93;fmt.</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Format is like fmt.Sprintf but using Objects.</span>
<span class="token keyword">func</span> <span class="token function">Format</span><span class="token punctuation">(</span>format <span class="token builtin">string</span><span class="token punctuation">,</span> a <span class="token operator">...</span>Object<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="pool&#x5BF9;&#x8C61;&#x6C60;&#x6280;&#x672F;"><a name="pool&#x5BF9;&#x8C61;&#x6C60;&#x6280;&#x672F;" class="anchor-navigation-ex-anchor" href="#pool&#x5BF9;&#x8C61;&#x6C60;&#x6280;&#x672F;"><i class="fa fa-link" aria-hidden="true"></i></a>Pool&#x5BF9;&#x8C61;&#x6C60;&#x6280;&#x672F;</h4>
<p>&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E86;sync.Pool&#x6280;&#x672F;&#x6765;&#x907F;&#x514D;&#x91CD;&#x590D;&#x5206;&#x914D;&#x5185;&#x5B58;.</p>
<p>&#x6CE8;: sync.Pool&#x662F;&#x6807;&#x51C6;&#x5E93;&#x63D0;&#x4F9B;&#x7684;&#x5BF9;&#x8C61;&#x6C60;&#x5316;&#x6280;&#x672F;, &#x4E3B;&#x8981;&#x7528;&#x4E8E;cache&#x5BF9;&#x8C61;, &#x51CF;&#x8F7B;gc&#x538B;&#x529B;. &#x8981;&#x70B9;:</p>
<ul>
<li>&#x63D0;&#x4F9B;Put()&#x548C;Get()&#x63A5;&#x53E3;, &#x7528;&#x6765;&#x5B58;&#x53D6;pool&#x4E2D;&#x5BF9;&#x8C61;.<ul>
<li>Put()&#x548C;Get()&#x6CA1;&#x6709;&#x76F8;&#x5173;&#x6027;. &#x4E0D;&#x4FDD;&#x8BC1;Put&#x8FC7;&#x7684;&#x5BF9;&#x8C61;&#x5C31;&#x4E00;&#x5B9A;&#x80FD;Get()&#x5230;</li>
<li>&#x5B9E;&#x9645;&#x4E0A;, &#x8FD9;&#x91CC;&#x662F;&#x5BF9;&#x8C61;&#x6C60;. &#x4F7F;&#x7528;&#x8005;&#x4E0D;&#x5E94;&#x8BE5;&#x5173;&#x5FC3;&#x5BF9;&#x8C61;&#x643A;&#x5E26;&#x7684;&quot;&#x5386;&#x53F2;&quot;&#x4FE1;&#x606F;. Get()&#x4E00;&#x4E2A;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5BF9;&#x8C61;.</li>
<li>&#x53EF;&#x4EE5;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;<code>New func() interface{}</code>&#x51FD;&#x6570;, Get()&#x4E0D;&#x5230;&#x7684;&#x65F6;&#x5019;&#x4E5F;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x65B0;&#x7684;.</li>
</ul>
</li>
<li>&#x5E76;&#x53D1;&#x5B89;&#x5168;</li>
<li>&#x6807;&#x51C6;&#x5E93;fmt&#x4F7F;&#x7528;&#x4E86;Pool&#x6280;&#x672F;</li>
<li>pool&#x4E0D;&#x80FD;&#x88AB;&#x62F7;&#x8D1D;</li>
<li>&#x4F3C;&#x4E4E;&#x6BD4;&#x8F83;heavy. &#x8F7B;&#x91CF;&#x7684;free list&#x7684;&#x9700;&#x6C42;&#x573A;&#x666F;&#x5EFA;&#x8BAE;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;&#x5BF9;&#x8C61;free list</li>
</ul>
<p>&#x65B0;&#x5EFA;&#x5BF9;&#x8C61;&#x6C60;, &#x8FD9;&#x91CC;&#x63D0;&#x4F9B;&#x4E86;&#x9ED8;&#x8BA4;&#x7684;New&#x65B9;&#x6CD5;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">var</span> ppFree <span class="token operator">=</span> sync<span class="token punctuation">.</span>Pool<span class="token punctuation">{</span>
    New<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">new</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4ECE;&#x5BF9;&#x8C61;&#x6C60;get:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// newPrinter allocates a new pp struct or grabs a cached one.</span>
<span class="token keyword">func</span> <span class="token function">newPrinter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>pp <span class="token punctuation">{</span>
    p <span class="token operator">:=</span> ppFree<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>pp<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>erroring <span class="token operator">=</span> <span class="token boolean">false</span>
    p<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>buf<span class="token punctuation">)</span>
    <span class="token keyword">return</span> p
<span class="token punctuation">}</span>
</code></pre>
<p>free&#x5BF9;&#x8C61;, &#x653E;&#x5230;&#x5BF9;&#x8C61;&#x6C60;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// free saves used pp structs in ppFree; avoids an allocation per invocation.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>pp<span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Proper usage of a sync.Pool requires each entry to have approximately</span>
    <span class="token comment">// the same memory cost. To obtain this property when the stored type</span>
    <span class="token comment">// contains a variably-sized fmtbuf, we add a hard limit on the maximum</span>
    <span class="token comment">// fmtbuf to place back in the pool.</span>
    <span class="token comment">//</span>
    <span class="token comment">// See https://golang.org/issue/23199</span>
    <span class="token keyword">if</span> <span class="token function">cap</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>buf<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">64</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    p<span class="token punctuation">.</span>buf <span class="token operator">=</span> p<span class="token punctuation">.</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">//&#x6CE8;&#x610F;&#x8FD9;&#x91CC;, &#x770B;&#x8D77;&#x6765;&#x628A;slice&#x7F6E;&#x4E3A;0, &#x5E76;&#x4E0D;&#x80FD;&#x5BFC;&#x81F4;gc&#x56DE;&#x6536;&#x5176;underlying&#x7684;array. &#x5426;&#x8005;&#x5C31;&#x4E0D;&#x4F1A;&#x6709;&#x4E0A;&#x9762;&#x7684;&#x5927;&#x4E8E;64K&#x76F4;&#x63A5;return. &#x8FD8;&#x6709;&#x4E2A;&#x70B9;&#x53EF;&#x4EE5;&#x8BC1;&#x660E;: &#x5982;&#x679C;&#x8FD9;&#x91CC;&#x80FD;&#x771F;&#x6B63;&#x628A;underlying&#x7684;array&#x6E05;0, &#x90A3;&#x4E48;&#x8FD9;&#x4E2A;&#x6C60;&#x5316;&#x8FD8;&#x6709;&#x4EC0;&#x4E48;&#x610F;&#x4E49;&#x5462;? &#x5728;&#x6211;&#x770B;&#x6765;, &#x8FD9;&#x91CC;&#x8FD9;&#x4E2A;p.buf&#x6240;&#x4EE3;&#x8868;&#x7684;&#x771F;&#x6B63;&quot;buffer&quot;&#x662F;&#x8981;&#x88AB;&#x6C60;&#x5316;&#x7684;&#x6700;&#x4E3B;&#x8981;&#x7684;&#x76EE;&#x6807;.</span>
    p<span class="token punctuation">.</span>arg <span class="token operator">=</span> <span class="token boolean">nil</span>
    ppFree<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5728;&#x8FD9;&#x91CC;, &#x88AB;&#x6C60;&#x5316;&#x7684;&#x5BF9;&#x8C61;&#x662F;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// pp is used to store a printer&apos;s state and is reused with sync.Pool to avoid</span>
<span class="token comment">// allocations.</span>
<span class="token keyword">type</span> pp <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    buf fmtbuf

    <span class="token comment">// arg holds the current item.</span>
    arg Object

    <span class="token comment">// fmt is used to format basic items such as integers or strings.</span>
    fmt formatter

    <span class="token comment">// reordered records whether the format string used argument reordering.</span>
    reordered <span class="token builtin">bool</span>

    <span class="token comment">// goodArgNum records whether the most recent reordering directive was</span>
    <span class="token comment">// valid.</span>
    goodArgNum <span class="token builtin">bool</span>

    <span class="token comment">// erroring is set when printing an error string to guard against calling</span>
    <span class="token comment">// handleMethods.</span>
    erroring <span class="token builtin">bool</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="tengogo"><a name="tengogo" class="anchor-navigation-ex-anchor" href="#tengogo"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.8. tengo.go</h3>
<p>tengo.go&#x91CC;&#x9762;&#x7684;&#x51FD;&#x6570;, &#x5165;&#x53C2;&#x90FD;&#x662F;&#x7EDF;&#x4E00;&#x7684;Object, &#x5229;&#x7528;&#x7C7B;&#x578B;&#x65AD;&#x8A00;&#x6765;&#x641E;&#x4E8B;&#x60C5;, &#x63D0;&#x4F9B;&#x5165;&#x53C2;&#x662F;Object, &#x5BF9;&#x5916;&#x7EDF;&#x4E00;&#x7684;&#x51FD;&#x6570;.
&#x6BD4;&#x5982;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">ToInt</span><span class="token punctuation">(</span>o Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>v <span class="token builtin">int</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">CountObjects</span><span class="token punctuation">(</span>o Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>c <span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token operator">...</span>

<span class="token comment">//&#x6700;&#x540E;&#x8FD9;&#x5BF9;&#x65B9;&#x6CD5;&#x5F88;&#x7279;&#x522B;, &#x662F;native go&#x548C;tengo&#x7C7B;&#x578B;&#x4E92;&#x8F6C;&#x7684;&#x5173;&#x952E;</span>
<span class="token keyword">func</span> <span class="token function">ToInterface</span><span class="token punctuation">(</span>o Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>res <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">FromInterface</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x5BF9;&#x5916;&#x63D0;&#x4F9B;&#x7EDF;&#x4E00;&#x7684;API, &#x5373;&#x5165;&#x53C2;&#x662F;Object&#x7684;API, &#x6709;&#x4E24;&#x4E2A;&#x601D;&#x8DEF;</p>
<ul>
<li>&#x672C;&#x4F8B;&#x4E2D;, &#x4F20;&#x5165;Object&#x63A5;&#x53E3;, &#x5728;&#x51FD;&#x6570;&#x5B9E;&#x73B0;&#x91CC;&#x9762;&#x641E;&#x7C7B;&#x578B;&#x65AD;&#x8A00;, &#x6BD4;&#x5982;:<pre class="language-"><code class="lang-go"><span class="token comment">// ToTime will try to convert object o to time.Time value.</span>
<span class="token keyword">func</span> <span class="token function">ToTime</span><span class="token punctuation">(</span>o Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>v time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> o <span class="token operator">:=</span> o<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token operator">*</span>Time<span class="token punctuation">:</span>
      v <span class="token operator">=</span> o<span class="token punctuation">.</span>Value
      ok <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token keyword">case</span> <span class="token operator">*</span>Int<span class="token punctuation">:</span>
      v <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      ok <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
<li>&#x6240;&#x6709;&#x7684;&#x5BF9;&#x5916;API&#x90FD;&#x5B9A;&#x4E49;&#x6210;&#x63A5;&#x53E3;, &#x6BD4;&#x5982;&#x8981;&#x6C42;Object&#x5168;&#x90E8;&#x5B9E;&#x73B0;<code>func ToTime(o Object) (v time.Time, ok bool)</code>&#x65B9;&#x6CD5;</li>
</ul>
<p>&#x6BD4;&#x8F83;&#x800C;&#x8A00;, &#x7B2C;&#x4E00;&#x79CD;&#x597D;&#x70B9;:</p>
<ul>
<li>&#x5E76;&#x4E0D;&#x662F;&#x6240;&#x6709;Object&#x90FD;&#x9700;&#x8981;ToTime, &#x5BF9;&#x4E00;&#x4E2A;array&#x6765;&#x641E;ToTime&#x6709;&#x70B9;&#x602A;.</li>
<li>&#x800C;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x7EDF;&#x4E00;&#x51FD;&#x6570;, ToTime(Object)&#x7684;&#x65B9;&#x5F0F;, &#x4E0D;&#x602A;, &#x5982;&#x679C;&#x4F20;&#x5165;Array&#x7C7B;&#x578B;&#x7684;Object, &#x5C31;&#x8FD4;&#x56DE;0&#x503C;&#x5C31;&#x597D;&#x4E86;.</li>
</ul>
<h4 id="frominterface&#x548C;tointerface&#x51FD;&#x6570;&#x662F;go&#x548C;&#x811A;&#x672C;&#x4EA4;&#x4E92;&#x7684;&#x6838;&#x5FC3;"><a name="frominterface&#x548C;tointerface&#x51FD;&#x6570;&#x662F;go&#x548C;&#x811A;&#x672C;&#x4EA4;&#x4E92;&#x7684;&#x6838;&#x5FC3;" class="anchor-navigation-ex-anchor" href="#frominterface&#x548C;tointerface&#x51FD;&#x6570;&#x662F;go&#x548C;&#x811A;&#x672C;&#x4EA4;&#x4E92;&#x7684;&#x6838;&#x5FC3;"><i class="fa fa-link" aria-hidden="true"></i></a><code>FromInterface()</code>&#x548C;<code>ToInterface()</code>&#x51FD;&#x6570;&#x662F;go&#x548C;&#x811A;&#x672C;&#x4EA4;&#x4E92;&#x7684;&#x6838;&#x5FC3;</h4>
<p><code>FromInterface()</code>&#x4ECE;go&#x7684;interface{}&#x63A8;&#x65AD;&#x5F97;&#x5230;tengo&#x7684;Object;
&#x800C;<code>ToInterface()</code>&#x6B63;&#x597D;&#x76F8;&#x53CD;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// FromInterface will attempt to convert an interface{} v to a Tengo Object</span>
<span class="token keyword">func</span> <span class="token function">FromInterface</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> v <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> UndefinedValue<span class="token punctuation">,</span> <span class="token boolean">nil</span> <span class="token comment">//UndefinedValue Object = &amp;Undefined{} &#x5B9A;&#x4E49;&#x4E8E;objects.go</span>
    <span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">&gt;</span> MaxStringLen <span class="token punctuation">{</span>    <span class="token comment">//tengo&#x7684;String&#x4E0D;&#x80FD;&#x5927;&#x4E8E;MaxStringLen, 2G, &#x5DF2;&#x7ECF;&#x975E;&#x5E38;&#x5927;&#x4E86;</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrStringLimit
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>String<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> v<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token keyword">case</span> <span class="token builtin">int64</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Int<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> v<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token keyword">case</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Int<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> <span class="token function">int64</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token keyword">case</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> v <span class="token punctuation">{</span>
            <span class="token keyword">return</span> TrueValue<span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> FalseValue<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token keyword">case</span> <span class="token builtin">rune</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Char<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> v<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token keyword">case</span> <span class="token builtin">byte</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Char<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> <span class="token function">rune</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token keyword">case</span> <span class="token builtin">float64</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Float<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> v<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">&gt;</span> MaxBytesLen <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrBytesLimit
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Bytes<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> v<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span> <span class="token comment">//Bytes&#x5C31;&#x662F;[]byte&#x7684;tengo&#x8868;&#x8FBE;</span>
    <span class="token keyword">case</span> <span class="token builtin">error</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Error<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> <span class="token operator">&amp;</span>String<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> v<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span> <span class="token comment">//Error&#x9ED8;&#x8BA4;&#x662F;&#x503C;&#x4E3A;string</span>
    <span class="token keyword">case</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Object<span class="token punctuation">:</span> <span class="token comment">//&#x6CE8;&#x610F;&#x8FD9;&#x4E2A;case, &#x6BD4;&#x4E0B;&#x4E2A;case&#x66F4;&#x5177;&#x4F53;, &#x8981;&#x653E;&#x5728;&#x524D;&#x9762;; &#x4ECE;go&#x4EE3;&#x7801;&#x8C03;&#x7528;&#x4E0B;&#x6765;, &#x6709;&#x80FD;&#x529B;&#x65AD;&#x8A00;Object</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Map<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> v<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token keyword">case</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span>    <span class="token comment">//&#x5C42;&#x5C42;&#x5D4C;&#x5957;&#x7684;map</span>
        kv <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Object<span class="token punctuation">)</span>
        <span class="token keyword">for</span> vk<span class="token punctuation">,</span> vv <span class="token operator">:=</span> <span class="token keyword">range</span> v <span class="token punctuation">{</span>
            vo<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">FromInterface</span><span class="token punctuation">(</span>vv<span class="token punctuation">)</span> <span class="token comment">//&#x9012;&#x5F52;&#x8C03;&#x7528;</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            kv<span class="token punctuation">[</span>vk<span class="token punctuation">]</span> <span class="token operator">=</span> vo
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Map<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> kv<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">:</span> <span class="token comment">//array&#x7C7B;&#x578B;</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Array<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> v<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token comment">//&#x5C42;&#x5C42;&#x5D4C;&#x5957;&#x7684;arrary</span>
        arr <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> e <span class="token operator">:=</span> <span class="token keyword">range</span> v <span class="token punctuation">{</span>
            vo<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">FromInterface</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token comment">//&#x9012;&#x5F52;&#x8C03;&#x7528;</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> vo
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Array<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> arr<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token keyword">case</span> time<span class="token punctuation">.</span>Time<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Time<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> v<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span> <span class="token comment">//Time&#x5C31;&#x662F;time.Time&#x7684;&#x5305;&#x88C5;</span>
    <span class="token keyword">case</span> Object<span class="token punctuation">:</span>
        <span class="token keyword">return</span> v<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token keyword">case</span> CallableFunc<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>UserFunction<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> v<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot convert to object: %T&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="&#x4EC0;&#x4E48;&#x662F;callable&#x5BF9;&#x8C61;"><a name="&#x4EC0;&#x4E48;&#x662F;callable&#x5BF9;&#x8C61;" class="anchor-navigation-ex-anchor" href="#&#x4EC0;&#x4E48;&#x662F;callable&#x5BF9;&#x8C61;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4EC0;&#x4E48;&#x662F;callable&#x5BF9;&#x8C61;</h4>
<p>&#x7B26;&#x5408;&#x8FD9;&#x4E2A;&#x7B7E;&#x540D;&#x7684;&#x90FD;&#x662F;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// CallableFunc is a function signature for the callable functions.</span>
<span class="token keyword">type</span> CallableFunc <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>args <span class="token operator">...</span>Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>ret Object<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x7ECF;&#x8FC7;&#x6D4B;&#x8BD5;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> test <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    a <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x548C;&#x4E0B;&#x9762;&#x5E26;<code>=</code>&#x53F7;&#x7684;&#x7248;&#x672C;, &#x90FD;&#x80FD;&#x7F16;&#x8FC7;, &#x6548;&#x679C;&#x5DEE;&#x4E0D;&#x591A;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> test <span class="token operator">=</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    a <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4F46;&#x8FD8;&#x662F;&#x6709;&#x4E9B;&#x5DEE;&#x522B;:</p>
<ul>
<li><code>=</code>&#x7248;&#x672C;&#x7684;type, &#x53EA;&#x662F;&#x522B;&#x540D;, <code>an alternate spelling</code>; &#x522B;&#x540D;&#x62E5;&#x6709;&#x539F;&#x540D;&#x7684;&#x4E00;&#x5207;&#x5C5E;&#x6027;</li>
<li>&#x666E;&#x901A;&#x7248;&#x672C;&#x7684;type&#x5B9A;&#x4E49;, &#x662F;&#x4E00;&#x4E2A;&#x5168;&#x65B0;&#x7684;&#x7C7B;&#x578B;, &#x4E0D;&#x5177;&#x6709;&#x539F;&#x7C7B;&#x578B;&#x7684;&#x65B9;&#x6CD5;</li>
</ul>
<h4 id="countobjects&#x8FD9;&#x4E2A;&#x9012;&#x5F52;&#x51FD;&#x6570;&#x5199;&#x7684;&#x771F;&#x597D;"><a name="countobjects&#x8FD9;&#x4E2A;&#x9012;&#x5F52;&#x51FD;&#x6570;&#x5199;&#x7684;&#x771F;&#x597D;" class="anchor-navigation-ex-anchor" href="#countobjects&#x8FD9;&#x4E2A;&#x9012;&#x5F52;&#x51FD;&#x6570;&#x5199;&#x7684;&#x771F;&#x597D;"><i class="fa fa-link" aria-hidden="true"></i></a><code>CountObjects</code>&#x8FD9;&#x4E2A;&#x9012;&#x5F52;&#x51FD;&#x6570;&#x5199;&#x7684;&#x771F;&#x597D;</h4>
<p>&#x6700;&#x91CC;&#x5C42;&#x8FD4;&#x56DE;&#x9884;&#x8BBE;&#x503C;1, &#x5176;&#x4ED6;&#x60C5;&#x51B5;&#x9012;&#x5F52;&#x7684;&#x8BA1;&#x7B97;array/map&#x7684;&#x5143;&#x7D20;&#x4E2A;&#x6570;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// CountObjects returns the number of objects that a given object o contains.</span>
<span class="token comment">// For scalar value types, it will always be 1. For compound value types,</span>
<span class="token comment">// this will include its elements and all of their elements recursively.</span>
<span class="token keyword">func</span> <span class="token function">CountObjects</span><span class="token punctuation">(</span>o Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>c <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">switch</span> o <span class="token operator">:=</span> o<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>Array<span class="token punctuation">:</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> o<span class="token punctuation">.</span>Value <span class="token punctuation">{</span>
            c <span class="token operator">+=</span> <span class="token function">CountObjects</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>ImmutableArray<span class="token punctuation">:</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> o<span class="token punctuation">.</span>Value <span class="token punctuation">{</span>
            c <span class="token operator">+=</span> <span class="token function">CountObjects</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>Map<span class="token punctuation">:</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> o<span class="token punctuation">.</span>Value <span class="token punctuation">{</span>
            c <span class="token operator">+=</span> <span class="token function">CountObjects</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>ImmutableMap<span class="token punctuation">:</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> o<span class="token punctuation">.</span>Value <span class="token punctuation">{</span>
            c <span class="token operator">+=</span> <span class="token function">CountObjects</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>Error<span class="token punctuation">:</span>
        c <span class="token operator">+=</span> <span class="token function">CountObjects</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="scriptgo"><a name="scriptgo" class="anchor-navigation-ex-anchor" href="#scriptgo"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.9. script.go</h3>
<p>&#x4F9D;&#x8D56;parser, &#x7528;&#x4E8E;&#x5D4C;&#x5165;&#x4EE3;&#x7801;&#x548C;&#x8C03;&#x7528;go&#x4EE3;&#x7801;&#x7684;&#x4EA4;&#x4E92;. &#x65B0;&#x5EFA;script&#x5B9E;&#x4F8B;, &#x4ECE;go&#x4EE3;&#x7801;add&#x53D8;&#x91CF;&#x8FDB;script
&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E9B;API</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Script<span class="token punctuation">)</span> <span class="token function">EnableFileImport</span><span class="token punctuation">(</span>enable <span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="scriptadd&#x7528;&#x4E8E;&#x4ECE;native-go&#x6DFB;&#x52A0;&#x53D8;&#x91CF;&#x5230;tengo&#x811A;&#x672C;"><a name="scriptadd&#x7528;&#x4E8E;&#x4ECE;native-go&#x6DFB;&#x52A0;&#x53D8;&#x91CF;&#x5230;tengo&#x811A;&#x672C;" class="anchor-navigation-ex-anchor" href="#scriptadd&#x7528;&#x4E8E;&#x4ECE;native-go&#x6DFB;&#x52A0;&#x53D8;&#x91CF;&#x5230;tengo&#x811A;&#x672C;"><i class="fa fa-link" aria-hidden="true"></i></a>Script.Add&#x7528;&#x4E8E;&#x4ECE;native go&#x6DFB;&#x52A0;&#x53D8;&#x91CF;&#x5230;tengo&#x811A;&#x672C;</h4>
<p>&#x5373;&#x628A;interface{}&#x8F6C;&#x6362;&#x4E3A;{name, Object}, &#x52A0;&#x5230;script&#x7684;<code>variables</code>map&#x91CC;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Add adds a new variable or updates an existing variable to the script.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Script<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    obj<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">FromInterface</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">//&#x89C1;tengo.go&#x91CC;&#x7684;&#x51FD;&#x6570;&#x5B9E;&#x73B0;</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    s<span class="token punctuation">.</span>variables<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>Variable<span class="token punctuation">{</span>
        name<span class="token punctuation">:</span>  name<span class="token punctuation">,</span>
        value<span class="token punctuation">:</span> obj<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="newscript"><a name="newscript" class="anchor-navigation-ex-anchor" href="#newscript"><i class="fa fa-link" aria-hidden="true"></i></a>NewScript</h4>
<p>&#x5728;<code>script.go</code>&#x4E2D;, NewScript&#x7B80;&#x5355;&#x5230;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Variable is a user-defined variable for the script.</span>
<span class="token keyword">type</span> Variable <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    name  <span class="token builtin">string</span>
    value Object <span class="token comment">//Object&#x662F;tengo&#x7684;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x7684;&#x7EDF;&#x4E00;&#x8868;&#x8FF0;(&#x63A5;&#x53E3;)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Script can simplify compilation and execution of embedded scripts.</span>
<span class="token keyword">type</span> Script <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    variables        <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Variable <span class="token comment">//script&#x548C;&#x5916;&#x90E8;go&#x7684;&#x53D8;&#x91CF;&#x4EA4;&#x4E92;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;map</span>
    modules          <span class="token operator">*</span>ModuleMap
    input            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    maxAllocs        <span class="token builtin">int64</span>
    maxConstObjects  <span class="token builtin">int</span>
    enableFileImport <span class="token builtin">bool</span>
    importDir        <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// NewScript creates a Script instance with an input script.</span>
<span class="token keyword">func</span> <span class="token function">NewScript</span><span class="token punctuation">(</span>input <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token operator">*</span>Script <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Script<span class="token punctuation">{</span>
        variables<span class="token punctuation">:</span>       <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Variable<span class="token punctuation">)</span><span class="token punctuation">,</span>
        input<span class="token punctuation">:</span>           input<span class="token punctuation">,</span>
        maxAllocs<span class="token punctuation">:</span>       <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        maxConstObjects<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="compile&#x51FD;&#x6570;"><a name="compile&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#compile&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>Compile&#x51FD;&#x6570;</h4>
<p>Script&#x5BF9;&#x8C61;&#x7684;Compile&#x65B9;&#x6CD5;&#x628A;&#x4EE3;&#x7801;&#x7F16;&#x8BD1;&#x6210;Compiled&#x5BF9;&#x8C61;
Compiled&#x5BF9;&#x8C61;&#x5305;&#x62EC;&#x4E86;&#x5B57;&#x8282;&#x7801;&#x548C;&#x5168;&#x5C40;&#x53D8;&#x91CF;, &#x548C;&#x4E00;&#x4E2A;&#x9501;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Compiled is a compiled instance of the user script. Use Script.Compile() to</span>
<span class="token comment">// create Compiled object.</span>
<span class="token keyword">type</span> Compiled <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    globalIndexes <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token comment">// global symbol name to index</span>
    globals       <span class="token punctuation">[</span><span class="token punctuation">]</span>Object <span class="token comment">//&#x4EE5;&#x4E0A;&#x4E24;&#x4E2A;&#x57DF;&#x4E00;&#x8D77;, &#x5B9E;&#x9645;&#x5C31;&#x662F;map[string]Object; &#x8FD9;&#x91CC;&#x4F5C;&#x8005;&#x8FD9;&#x4E48;&#x641E;&#x6015;&#x4E0D;&#x662F;&#x6709;&#x4EC0;&#x4E48;&#x4F18;&#x5316;</span>
    bytecode      <span class="token operator">*</span>Bytecode
    maxAllocs     <span class="token builtin">int64</span>
    lock          sync<span class="token punctuation">.</span>RWMutex
<span class="token punctuation">}</span>
</code></pre>
<p>Compile&#x51FD;&#x6570;&#x6D41;&#x7A0B;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Script<span class="token punctuation">)</span> <span class="token function">Compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Compiled<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    symbolTable<span class="token punctuation">,</span> globals<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">prepCompile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x65B0;&#x5EFA;&#x7B26;&#x53F7;&#x8868;, &#x5EFA;&#x7ACB;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7D22;&#x5F15;</span>
    fileSet <span class="token operator">:=</span> parser<span class="token punctuation">.</span><span class="token function">NewFileSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;fileset, fileset&#x7C7B;&#x4F3C;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;, &#x672C;&#x8EAB;&#x4E0D;&#x5B58;&#x50A8;&#x6587;&#x4EF6;&#x5185;&#x5BB9;</span>
    srcFile <span class="token operator">:=</span> fileSet<span class="token punctuation">.</span><span class="token function">AddFile</span><span class="token punctuation">(</span><span class="token string">&quot;(main)&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//AddFile&#x52A0;&#x9ED8;&#x8BA4;&#x7684;main&#x6587;&#x4EF6;, &#x6B64;&#x65F6;&#x53EA;&#x662F;&#x4F20;&#x5165;len</span>
    p <span class="token operator">:=</span> parser<span class="token punctuation">.</span><span class="token function">NewParser</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">,</span> s<span class="token punctuation">.</span>input<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token comment">//&#x5230;NewParser&#x624D;&#x628A;&#x6587;&#x4EF6;&#x548C;s.input&#x5185;&#x5BB9;&#x8054;&#x7CFB;&#x8D77;&#x6765;.</span>
    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">ParseFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    c <span class="token operator">:=</span> <span class="token function">NewCompiler</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">,</span> symbolTable<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">EnableFileImport</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>enableFileImport<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">SetImportDir</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>importDir<span class="token punctuation">)</span>
    err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>

    <span class="token comment">//&#x4F18;&#x5316;&#x5168;&#x5C40;&#x53D8;&#x91CF;</span>
    <span class="token operator">...</span>
    <span class="token comment">// remove duplicates from constants</span>
    bytecode <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Bytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    bytecode<span class="token punctuation">.</span><span class="token function">RemoveDuplicates</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//&#x68C0;&#x67E5;&#x6700;&#x5927;object&#x6570;&#x76EE;&#x662F;&#x5426;&#x8D85;&#x9650;&#x5236;</span>

    <span class="token comment">//&#x8FD9;&#x91CC;&#x7684;&#x53D8;&#x91CF;&#x540D;&#x548C;&#x57DF;&#x540D;&#x4E00;&#x6837;, &#x662F;&#x5408;&#x6CD5;&#x7684;.</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Compiled<span class="token punctuation">{</span>
        globalIndexes<span class="token punctuation">:</span> globalIndexes<span class="token punctuation">,</span>
        bytecode<span class="token punctuation">:</span>      bytecode<span class="token punctuation">,</span>    <span class="token comment">//&#x770B;&#x8D77;&#x6765;&#x8FD9;&#x4E2A;bytecode&#x662F;&#x5173;&#x952E;</span>
        globals<span class="token punctuation">:</span>       globals<span class="token punctuation">,</span>
        maxAllocs<span class="token punctuation">:</span>     s<span class="token punctuation">.</span>maxAllocs<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="precompile&#x51FD;&#x6570;"><a name="precompile&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#precompile&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>preCompile()&#x51FD;&#x6570;</h4>
<p>preCompile&#x51FD;&#x6570;&#x8D1F;&#x8D23;&#x521B;&#x5EFA;&#x521D;&#x59CB;symbolTable, &#x5E76;&#x628A;Script.Add()&#x52A0;&#x5165;&#x7684;&#x53D8;&#x91CF;, Define&#x5230;symbolTable&#x4E2D;. &#x6CE8;&#x610F;Define&#x53EA;&#x662F;&#x589E;&#x52A0;&#x4E2A;&#x7B26;&#x53F7;, &#x800C;&#x4E0D;&#x662F;&#x4FDD;&#x5B58;&#x5B9E;&#x9645;&#x503C;. &#x5B9E;&#x9645;&#x503C;&#x4FDD;&#x5B58;&#x5728;&#x5355;&#x72EC;&#x7684;&#x53D8;&#x91CF;&#x8868;&#x4E2D;:
preCompile&#x8FD8;&#x589E;&#x52A0;builtin&#x7684;&#x7B26;&#x53F7;
preCompile&#x8FD4;&#x56DE;&#x7B26;&#x53F7;&#x8868;&#x548C;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x8868;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Script<span class="token punctuation">)</span> <span class="token function">prepCompile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>
    symbolTable <span class="token operator">*</span>SymbolTable<span class="token punctuation">,</span>
    globals <span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">,</span>
    err <span class="token builtin">error</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> names <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    <span class="token keyword">for</span> name <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>variables <span class="token punctuation">{</span>
        names <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    symbolTable <span class="token operator">=</span> <span class="token function">NewSymbolTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> fn <span class="token operator">:=</span> <span class="token keyword">range</span> builtinFuncs <span class="token punctuation">{</span>
        symbolTable<span class="token punctuation">.</span><span class="token function">DefineBuiltin</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> fn<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    globals <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">,</span> GlobalsSize<span class="token punctuation">)</span>

    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> name <span class="token operator">:=</span> <span class="token keyword">range</span> names <span class="token punctuation">{</span>
        symbol <span class="token operator">:=</span> symbolTable<span class="token punctuation">.</span><span class="token function">Define</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> symbol<span class="token punctuation">.</span>Index <span class="token operator">!=</span> idx <span class="token punctuation">{</span>
            <span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;wrong symbol index: %d != %d&quot;</span><span class="token punctuation">,</span>
                idx<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        globals<span class="token punctuation">[</span>symbol<span class="token punctuation">.</span>Index<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">.</span>variables<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token comment">//&#x5B9E;&#x9645;&#x7684;Object&#x4FDD;&#x5B58;&#x5728;global&#x4E2D;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="removeduplicates&#x53BB;&#x6389;&#x91CD;&#x590D;&#x5E38;&#x91CF;"><a name="removeduplicates&#x53BB;&#x6389;&#x91CD;&#x590D;&#x5E38;&#x91CF;" class="anchor-navigation-ex-anchor" href="#removeduplicates&#x53BB;&#x6389;&#x91CD;&#x590D;&#x5E38;&#x91CF;"><i class="fa fa-link" aria-hidden="true"></i></a>RemoveDuplicates()&#x53BB;&#x6389;&#x91CD;&#x590D;&#x5E38;&#x91CF;?</h4>
<p>&#x6CA1;&#x7EC6;&#x770B;</p>
<h4 id="runcontext&#x51FD;&#x6570;"><a name="runcontext&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#runcontext&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>RunContext()&#x51FD;&#x6570;</h4>
<p>&#x8FD9;&#x662F;&#x4E2A;&#x5E26;&#x8D85;&#x65F6;&#x7684;Run()&#x51FD;&#x6570;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// RunContext is like Run but includes a context.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiled<span class="token punctuation">)</span> <span class="token function">RunContext</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    v <span class="token operator">:=</span> <span class="token function">NewVM</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>bytecode<span class="token punctuation">,</span> c<span class="token punctuation">.</span>globals<span class="token punctuation">,</span> c<span class="token punctuation">.</span>maxAllocs<span class="token punctuation">)</span>
    ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ch <span class="token operator">&lt;-</span> v<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        v<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">&lt;-</span>ch
        err <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> err <span class="token operator">=</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="run&#x51FD;&#x6570;"><a name="run&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#run&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>Run&#x51FD;&#x6570;</h4>
<p>script&#x7684;Run</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Run compiles and runs the scripts. Use returned compiled object to access</span>
<span class="token comment">// global variables.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Script<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>compiled <span class="token operator">*</span>Compiled<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiled<span class="token punctuation">,</span> err <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    err <span class="token operator">=</span> compiled<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Compiled&#x7684;Run</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Run executes the compiled script in the virtual machine.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiled<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    v <span class="token operator">:=</span> <span class="token function">NewVM</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>bytecode<span class="token punctuation">,</span> c<span class="token punctuation">.</span>globals<span class="token punctuation">,</span> c<span class="token punctuation">.</span>maxAllocs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> v<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>VM&#x7684;Run&#x5728;vm.go&#x4E2D;</p>
<h3 id="variablego"><a name="variablego" class="anchor-navigation-ex-anchor" href="#variablego"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.10. variable.go</h3>
<p>variable.go&#x63D0;&#x4F9B;&#x4E86;&#x4ECE;Variable&#x7C7B;&#x578B;&#x5230;native go&#x7684;&#x8F6C;&#x6362;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> Variable <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    name  <span class="token builtin">string</span>
    value Object
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5178;&#x578B;&#x7684;&#x8F6C;&#x6362;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code class="lang-go">        <span class="token boolean">_</span> <span class="token operator">=</span> compiled<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
        <span class="token boolean">_</span> <span class="token operator">=</span> compiled<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
        <span class="token boolean">_</span> <span class="token operator">=</span> compiled<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>
        err <span class="token operator">:=</span> compiled<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        d <span class="token operator">=</span> compiled<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        e <span class="token operator">=</span> compiled<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;e&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="builtinsgo"><a name="builtinsgo" class="anchor-navigation-ex-anchor" href="#builtinsgo"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.11. builtins.go</h3>
<p>builtin&#x51FD;&#x6570;&#x7684;&#x5B9E;&#x73B0;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">var</span> builtinFuncs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>BuiltinFunction<span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span>  <span class="token string">&quot;len&quot;</span><span class="token punctuation">,</span>
        Value<span class="token punctuation">:</span> builtinLen<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span>  <span class="token string">&quot;copy&quot;</span><span class="token punctuation">,</span>
        Value<span class="token punctuation">:</span> builtinCopy<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    &#x7B49;&#x7B49;
</code></pre>
<p>&#x53C8;&#x5C11;&#x4E0D;&#x4E86;&#x7C7B;&#x578B;&#x65AD;&#x8A00;...</p>
<h3 id="compilergo"><a name="compilergo" class="anchor-navigation-ex-anchor" href="#compilergo"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.12. compiler.go</h3>
<p>compiler&#x7684;&#x4F5C;&#x7528;&#x662F;&#x628A;ast&#x8F6C;&#x5316;&#x4E3A;&#x5B57;&#x8282;&#x7801;
&#x5B83;&#x4F9D;&#x8D56;&#x4E0B;&#x5C42;&#x7684;token&#x548C;parser.
compiler&#x7BA1;&#x7B26;&#x53F7;&#x8868;, &#x6A21;&#x5757;, &#x5DF2;&#x7ECF;&#x88AB;&#x7F16;&#x8BD1;&#x8FC7;&#x7684;&#x51FD;&#x6570;, </p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Compiler compiles the AST into a bytecode.</span>
<span class="token keyword">type</span> Compiler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    file            <span class="token operator">*</span>parser<span class="token punctuation">.</span>SourceFile
    parent          <span class="token operator">*</span>Compiler
    modulePath      <span class="token builtin">string</span>
    importDir       <span class="token builtin">string</span>
    constants       <span class="token punctuation">[</span><span class="token punctuation">]</span>Object
    symbolTable     <span class="token operator">*</span>SymbolTable
    scopes          <span class="token punctuation">[</span><span class="token punctuation">]</span>compilationScope
    scopeIndex      <span class="token builtin">int</span>
    modules         <span class="token operator">*</span>ModuleMap
    compiledModules <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>CompiledFunction
    allowFileImport <span class="token builtin">bool</span>
    loops           <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>loop
    loopIndex       <span class="token builtin">int</span>
    trace           io<span class="token punctuation">.</span>Writer
    indent          <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre>
<p>new&#x4E00;&#x4E2A;compiler&#x5C31;&#x662F;</p>
<pre class="language-"><code class="lang-go">    <span class="token operator">&amp;</span>Compiler<span class="token punctuation">{</span>
        file<span class="token punctuation">:</span>            file<span class="token punctuation">,</span>
        symbolTable<span class="token punctuation">:</span>     symbolTable<span class="token punctuation">,</span>
        constants<span class="token punctuation">:</span>       constants<span class="token punctuation">,</span>
        scopes<span class="token punctuation">:</span>          <span class="token punctuation">[</span><span class="token punctuation">]</span>compilationScope<span class="token punctuation">{</span>mainScope<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//&#x6BCF;&#x4E2A;scope&#x90FD;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x5B57;&#x8282;&#x7801;</span>
        scopeIndex<span class="token punctuation">:</span>      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//scope&#x4ECE;0&#x5F00;&#x59CB;</span>
        loopIndex<span class="token punctuation">:</span>       <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        trace<span class="token punctuation">:</span>           trace<span class="token punctuation">,</span>
        modules<span class="token punctuation">:</span>         modules<span class="token punctuation">,</span>
        compiledModules<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>CompiledFunction<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x7279;&#x522B;&#x7684;, NewCompiler()&#x7684;&#x65F6;&#x5019;, &#x4E5F;&#x53EF;&#x4EE5;&#x4F20;&#x5165;&#x4E00;&#x4E2A;io.Writer&#x505A;&#x4E3A;trace, &#x65B9;&#x4FBF;debug. io.Writer&#x914D;&#x5408;defer&#x7684;trace&#x529F;&#x80FD;, &#x5C31;&#x80FD;&#x8BE6;&#x7EC6;&#x7684;log&#x8F6F;&#x4EF6;&#x903B;&#x8F91;.<br>compiler&#x7684;allowFileImport&#x548C;importDir&#x4E00;&#x822C;&#x548C;script&#x7684;&#x5BF9;&#x5E94;&#x5C5E;&#x6027;&#x4E00;&#x6837;.</p>
<h4 id="compile&#x51FD;&#x6570;_1"><a name="compile&#x51FD;&#x6570;_1" class="anchor-navigation-ex-anchor" href="#compile&#x51FD;&#x6570;_1"><i class="fa fa-link" aria-hidden="true"></i></a>Compile()&#x51FD;&#x6570;</h4>
<p>Compile()&#x7684;&#x5165;&#x53C2;&#x662F;parser.Node, &#x5B83;&#x662F;&#x4E2A;&#x63A5;&#x53E3;; <code>parser.ParseFile()</code>&#x8FD4;&#x56DE;&#x7684;<code>*parser.File</code>&#x5C31;&#x662F;&#x5176;&#x4E2D;&#x7684;&#x4E00;&#x79CD;&#x5B9E;&#x73B0;<br><code>func (c *Compiler) Compile(node parser.Node) error</code><br>Compile()&#x7684;&#x5B9E;&#x73B0;&#x53C8;&#x662F;&#x5178;&#x578B;&#x7684;&#x7C7B;&#x578B;&#x65AD;&#x8A00;+&#x9012;&#x5F52;&#x7684;&#x65B9;&#x5F0F;, &#x5B83;&#x652F;&#x6301;File&#x6811;, &#x652F;&#x6301;&#x8868;&#x8FBE;&#x5F0F;&#x6811;, &#x8FDB;&#x4E00;&#x6B65;&#x652F;&#x6301;&#x66F4;&#x52A0;&#x62C6;&#x5206;&#x7EC6;&#x5316;&#x7684;&#x57FA;&#x7840;&#x64CD;&#x4F5C;.<br>&#x7528;&#x9012;&#x5F52;&#x8C03;&#x7528;&#x6765;&#x5316;&#x6574;&#x4E3A;&#x96F6;, &#x5F88;&#x7ECF;&#x5178;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Compile compiles the AST node.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiler<span class="token punctuation">)</span> <span class="token function">Compile</span><span class="token punctuation">(</span>node parser<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> node <span class="token operator">:=</span> node<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>File<span class="token punctuation">:</span> <span class="token comment">//&#x5982;&#x679C;&#x662F;File&#x7C7B;&#x578B;, &#x53EA;&#x662F;&#x5BF9;&#x5176;&#x4E2D;&#x7684;&#x6BCF;&#x4E2A;&#x58F0;&#x660E;&#x505A;&#x9012;&#x5F52;&#x7684;Compile</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> stmt <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>Stmts <span class="token punctuation">{</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">//&#x518D;&#x6B21;&#x8C03;&#x7528;Compile&#x51FD;&#x6570;</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>ExprStmt<span class="token punctuation">:</span> <span class="token comment">//&#x5982;&#x679C;&#x662F;&#x8868;&#x8FBE;&#x5F0F;</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Expr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpPop<span class="token punctuation">)</span> <span class="token comment">//&#x8868;&#x8FBE;&#x5F0F;&#x662F;&#x6709;&#x5177;&#x4F53;&#x52A8;&#x4F5C;&#x7684;: emit POP(&#x51FA;&#x6808;)&#x5B57;&#x8282;&#x7801;&#x5230;c.scopes[c.scopeIndex].Instructions&#x7684;&#x6700;&#x540E;</span>
    &#x5176;&#x4ED6;&#x66F4;&#x52A0;&#x62C6;&#x5206;&#x7684;<span class="token keyword">case</span><span class="token punctuation">,</span> &#x6BD4;&#x5982;
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>BinaryExpr<span class="token punctuation">:</span> <span class="token comment">//&#x5904;&#x7406;&#x52A0;&#x51CF;&#x4E58;&#x9664;, emit OpBinaryOp</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>IntLit<span class="token punctuation">:</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>StringLit<span class="token punctuation">:</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>FloatLit<span class="token punctuation">:</span> <span class="token comment">//&#x4EE5;&#x4E0A;&#x5E26;Lit&#x540E;&#x7F00;&#x7684;&#x662F;literature, &#x5373;&#x5B57;&#x9762;&#x503C;. emit OpConstant</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>UnaryExpr<span class="token punctuation">:</span><span class="token punctuation">:</span> <span class="token comment">//&#x4E00;&#x5143;&#x64CD;&#x4F5C;</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>IncDecStmt<span class="token punctuation">:</span> <span class="token comment">//++ --</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>IfStmt<span class="token punctuation">:</span>
        <span class="token comment">// open new symbol table for the statement</span>
        c<span class="token punctuation">.</span>symbolTable <span class="token operator">=</span> c<span class="token punctuation">.</span>symbolTable<span class="token punctuation">.</span><span class="token function">Fork</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">//if&#x5757;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x7B26;&#x53F7;scope, &#x6240;&#x4EE5;&#x8FD9;&#x91CC;fork&#x51FA;&#x4E00;&#x4E2A;&#x5B50;&#x7684;scope</span>
        <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span>symbolTable <span class="token operator">=</span> c<span class="token punctuation">.</span>symbolTable<span class="token punctuation">.</span><span class="token function">Parent</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">//&#x9000;&#x51FA;if&#x5757;&#x7684;&#x65F6;&#x5019;, &#x8FD8;&#x539F;&#x7236;scope</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> node<span class="token punctuation">.</span>Init <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">//&#x548C;go&#x8BED;&#x6CD5;&#x4E00;&#x6837;, if&#x652F;&#x6301;&#x524D;&#x7F6E;&#x8868;&#x8FBE;&#x5F0F;</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Init<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Cond<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">//&#x6761;&#x4EF6;&#x90E8;&#x5206;</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token comment">// first jump placeholder</span>
        jumpPos1 <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpJumpFalsy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//&#x4E0D;&#x8981;&#x88AB;&#x8FD9;&#x91CC;&#x7684;0 offset&#x8FF7;&#x60D1; &#x540E;&#x9762;&#x4F1A;&#x4FEE;&#x6B63;</span>
        <span class="token comment">//&#x6CE8;&#x610F;, &#x8FD9;&#x91CC;&#x5BF9;&#x5E94; vm.run()&#x4E2D;&#x7684;&#x6267;&#x884C;&#x90E8;&#x5206;: &#x5F53;&#x524D;ip&#x662F;&#x64CD;&#x4F5C;&#x7801;OpJumpFalsy, &#x5224;&#x65AD;&#x5F53;&#x524D;sp&#x7684;&#x503C;&#x662F;&#x5426;&#x4E3A;&#x5047;, &#x662F;&#x7684;&#x8BDD;, ip&#x8DF3;&#x8F6C;&#x5230;pos-1, &#x8FD9;&#x4E2A;pos&#x5C31;&#x662F;&#x6307;&#x4EE4;&#x7801;&#x91CC;&#x7684;offset, &#x770B;&#x8D77;&#x6765;&#x662F;&#x7528;&#x4E24;&#x4E2A;&#x5B57;&#x8282;&#x8868;&#x793A;&#x7684;. &#x6700;&#x5927;&#x8DF3;&#x8F6C;65535&#x5B57;&#x8282;.</span>
        <span class="token comment">//case parser.OpJumpFalsy:</span>
        <span class="token comment">//    v.ip += 2</span>
        <span class="token comment">//    v.sp--</span>
        <span class="token comment">//    if v.stack[v.sp].IsFalsy() {</span>
        <span class="token comment">//        pos := int(v.curInsts[v.ip]) | int(v.curInsts[v.ip-1])&lt;&lt;8</span>
        <span class="token comment">//        v.ip = pos - 1</span>
        <span class="token comment">//    }</span>
        <span class="token keyword">if</span> node<span class="token punctuation">.</span>Else <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token comment">// second jump placeholder</span>
            jumpPos2 <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpJump<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

            <span class="token comment">// update first jump offset</span>
            curPos <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">currentInstructions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">changeOperand</span><span class="token punctuation">(</span>jumpPos1<span class="token punctuation">,</span> curPos<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Else<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>

            <span class="token comment">// update second jump offset</span>
            curPos <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">currentInstructions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">changeOperand</span><span class="token punctuation">(</span>jumpPos2<span class="token punctuation">,</span> curPos<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// update first jump offset</span>
            curPos <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">currentInstructions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">changeOperand</span><span class="token punctuation">(</span>jumpPos1<span class="token punctuation">,</span> curPos<span class="token punctuation">)</span> <span class="token comment">//&#x4FEE;&#x6B63;jump&#x7684;offset</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>ForStmt<span class="token punctuation">:</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>BlockStmt<span class="token punctuation">:</span> <span class="token comment">//&#x5757;&#x8BED;&#x53E5;, &#x6709;&#x5B57;&#x8282;&#x7684;scope</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>Ident<span class="token punctuation">:</span> <span class="token comment">//&#x8981;&#x627E;&#x7B26;&#x53F7;, &#x6CBF;&#x7740;&#x5F53;&#x524D;&#x7684;symbolTable&#x6765;&#x5BFB;&#x627E;&#x7B26;&#x53F7;&#x7684;&#x540D;&#x5B57;node.Name</span>
    <span class="token comment">//&#x6839;&#x636E;&#x7B26;&#x53F7;&#x7684;scope, emit&#x4E0D;&#x540C;&#x7684;&#x64CD;&#x4F5C;&#x7801;</span>
        symbol<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> c<span class="token punctuation">.</span>symbolTable<span class="token punctuation">.</span><span class="token function">Resolve</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">errorf</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&quot;unresolved reference &apos;%s&apos;&quot;</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">switch</span> symbol<span class="token punctuation">.</span>Scope <span class="token punctuation">{</span>
        <span class="token keyword">case</span> ScopeGlobal<span class="token punctuation">:</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetGlobal<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
        <span class="token keyword">case</span> ScopeLocal<span class="token punctuation">:</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetLocal<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
        <span class="token keyword">case</span> ScopeBuiltin<span class="token punctuation">:</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetBuiltin<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
        <span class="token keyword">case</span> ScopeFree<span class="token punctuation">:</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetFree<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>IndexExpr<span class="token punctuation">:</span> <span class="token comment">//&#x53EF;&#x4EE5;index&#x7684;&#x5BF9;&#x8C61;, emit OpIndex</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>FuncLit<span class="token punctuation">:</span> <span class="token comment">//&#x51FD;&#x6570;&#x5B57;&#x9762;</span>
        c<span class="token punctuation">.</span><span class="token function">enterScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x4E0D;&#x4EC5;&#x662F;fork&#x4E00;&#x4E2A;&#x5B50;symbolTable, &#x800C;&#x4E14;&#x8FD8;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;compilationScope, append&#x5230;c.scopes, &#x5E76;c.scopeIndex++</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>Params<span class="token punctuation">.</span>List <span class="token punctuation">{</span> <span class="token comment">//&#x5B9A;&#x4E49;&#x5165;&#x53C2;</span>
            s <span class="token operator">:=</span> c<span class="token punctuation">.</span>symbolTable<span class="token punctuation">.</span><span class="token function">Define</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>

            <span class="token comment">// function arguments is not assigned directly.</span>
            s<span class="token punctuation">.</span>LocalAssigned <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">//&#x7F16;&#x8BD1;&#x51FD;&#x6570;&#x4F53;, &#x8FD9;&#x91CC;&#x7684;c&#x5176;&#x5B9E;&#x5DF2;&#x7ECF;&#x8FDB;&#x5165;&#x5230;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;compilationScope</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>

        <span class="token comment">// code optimization</span>
        c<span class="token punctuation">.</span><span class="token function">optimizeFunc</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token comment">//&#x53BB;&#x9664;&#x6B7B;&#x4EE3;&#x7801;, &#x9700;&#x8981;&#x7684;&#x8BDD;&#x5728;&#x6700;&#x540E;&#x6DFB;&#x52A0;return&#x64CD;&#x4F5C;&#x7801;</span>

        freeSymbols <span class="token operator">:=</span> c<span class="token punctuation">.</span>symbolTable<span class="token punctuation">.</span><span class="token function">FreeSymbols</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        numLocals <span class="token operator">:=</span> c<span class="token punctuation">.</span>symbolTable<span class="token punctuation">.</span><span class="token function">MaxSymbols</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//leaveScope&#x5F88;&#x91CD;&#x8981;, &#x5B83;&#x8FD4;&#x56DE;&#x5F53;&#x524D;compilationScope&#x7684;&#x5B57;&#x8282;&#x7801;, &#x5373;&#x672C;&#x51FD;&#x6570;&#x7684;&#x5B57;&#x8282;&#x7801;, &#x5E76;&#x64A4;&#x9500;&#x5F53;&#x524D;scope&#x548C;symbolTable</span>
        <span class="token comment">//c.scopes = c.scopes[:len(c.scopes)-1]</span>
        <span class="token comment">//c.scopeIndex--</span>
        <span class="token comment">//c.symbolTable = c.symbolTable.Parent(true)</span>
        instructions<span class="token punctuation">,</span> sourceMap <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">leaveScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> s <span class="token operator">:=</span> <span class="token keyword">range</span> freeSymbols <span class="token punctuation">{</span> <span class="token comment">//emit OpGetLocalPtr &#x5F15;&#x7528;&#x5916;&#x90E8;free&#x53D8;&#x91CF;</span>
            <span class="token keyword">switch</span> s<span class="token punctuation">.</span>Scope <span class="token punctuation">{</span>
            <span class="token keyword">case</span> ScopeLocal<span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token operator">!</span>s<span class="token punctuation">.</span>LocalAssigned <span class="token punctuation">{</span>
                    c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpNull<span class="token punctuation">)</span>
                    c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpDefineLocal<span class="token punctuation">,</span> s<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
                    s<span class="token punctuation">.</span>LocalAssigned <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
                c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetLocalPtr<span class="token punctuation">,</span> s<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
            <span class="token keyword">case</span> ScopeFree<span class="token punctuation">:</span>
                c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetFreePtr<span class="token punctuation">,</span> s<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        compiledFunction <span class="token operator">:=</span> <span class="token operator">&amp;</span>CompiledFunction<span class="token punctuation">{</span>
            Instructions<span class="token punctuation">:</span>  instructions<span class="token punctuation">,</span>
            NumLocals<span class="token punctuation">:</span>     numLocals<span class="token punctuation">,</span>
            NumParameters<span class="token punctuation">:</span> <span class="token function">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>Params<span class="token punctuation">.</span>List<span class="token punctuation">)</span><span class="token punctuation">,</span>
            VarArgs<span class="token punctuation">:</span>       node<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>Params<span class="token punctuation">.</span>VarArgs<span class="token punctuation">,</span>
            SourceMap<span class="token punctuation">:</span>     sourceMap<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>freeSymbols<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span> <span class="token comment">//&#x5982;&#x679C;&#x5F15;&#x7528;&#x4E86;&#x7236;scope&#x7684;&#x5C40;&#x90E8;&#x53D8;&#x91CF;, &#x90A3;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5C31;&#x662F;&#x4E2A;&#x95ED;&#x5305;; emit OpClosure</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpClosure<span class="token punctuation">,</span>
                c<span class="token punctuation">.</span><span class="token function">addConstant</span><span class="token punctuation">(</span>compiledFunction<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>freeSymbols<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//&#x666E;&#x901A;&#x51FD;&#x6570;, emit OpConstant</span>
            <span class="token comment">//&#x5148;&#x628A;&#x4E0A;&#x9762;&#x7684;compiledFunction&#x52A0;&#x5230;constant&#x6570;&#x7EC4;&#x91CC;, &#x7136;&#x540E;&#x628A;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x653E;&#x5230;&#x6808;&#x4E2D;.</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpConstant<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">addConstant</span><span class="token punctuation">(</span>compiledFunction<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>ReturnStmt<span class="token punctuation">:</span> <span class="token comment">//&#x51FD;&#x6570;&#x8FD4;&#x56DE;</span>
        <span class="token keyword">if</span> c<span class="token punctuation">.</span>symbolTable<span class="token punctuation">.</span><span class="token function">Parent</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token comment">// outside the function</span>
            <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">errorf</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&quot;return not allowed outside function&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> node<span class="token punctuation">.</span>Result <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpReturn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//&#x7A7A;return</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpReturn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">//return&#x503C;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>CallExpr<span class="token punctuation">:</span> <span class="token comment">//&#x51FD;&#x6570;&#x8C03;&#x7528;</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Func<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>Args <span class="token punctuation">{</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        ellipsis <span class="token operator">:=</span> <span class="token number">0</span>
        <span class="token keyword">if</span> node<span class="token punctuation">.</span>Ellipsis<span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ellipsis <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
        c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpCall<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Args<span class="token punctuation">)</span><span class="token punctuation">,</span> ellipsis<span class="token punctuation">)</span>
    &#x7B49;&#x7B49;
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5728;&#x6CA1;&#x6709;&#x7C7B;&#x578B;&#x65AD;&#x8A00;&#x7684;&#x8BED;&#x8A00;&#x91CC;, &#x6050;&#x6015;&#x6700;&#x5E38;&#x89C4;&#x7684;&#x601D;&#x8DEF;&#x662F;&#x5199;&#x4E00;&#x5806;&#x7684;CompileXxx&#x51FD;&#x6570;, &#x6765;&#x4E92;&#x76F8;&#x8C03;&#x7528;, &#x6BD4;&#x5982;:</p>
<ul>
<li>CompileExprStmt()</li>
<li>CompileIfStmt()</li>
<li>CompileBinaryExpr()
&#x7B49;&#x7B49;
&#x6E90;&#x6587;&#x4EF6;&#x4F1A;&#x6BD4;&#x8F83;&#x4E71;.
&#x6CE8;: &#x5B9E;&#x9645;&#x4E0A;, &#x8FD9;&#x91CC;&#x8FD8;&#x771F;&#x6709;compileForStmt()&#x51FD;&#x6570;</li>
</ul>
<h4 id="emit&#x51FD;&#x6570;"><a name="emit&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#emit&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>emit()&#x51FD;&#x6570;</h4>
<p>&#x901A;&#x5E38;&#x7684;&#x8C03;&#x7528;&#x6BD4;&#x5982;:</p>
<pre class="language-"><code class="lang-go">c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpBinaryOp<span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>Add<span class="token punctuation">)</span><span class="token punctuation">)</span>
c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpMinus<span class="token punctuation">)</span>
pos <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpJump<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x90FD;&#x662F;OpCode, &#x6BCF;&#x4E2A;OpCode&#x53EA;&#x6709;1&#x4E2A;&#x5B57;&#x8282;, &#x88AB;&#x653E;&#x5230;&#x5B57;&#x8282;&#x7801;&#x4E2D;. &#x5168;&#x90E8;&#x7684;OpCode&#x4E0D;&#x591A;, &#x5728;<a href="#parser/opcodes.go">parser/opcodes.go</a>&#x4E2D;&#x5B9A;&#x4E49;<br>&#x6700;&#x7EC8;&#x8FD9;&#x4E2A;OpCode&#x88AB;&#x5199;&#x5165;<code>c.scopes[c.scopeIndex].Instructions</code>:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiler<span class="token punctuation">)</span> <span class="token function">emit</span><span class="token punctuation">(</span>
    node parser<span class="token punctuation">.</span>Node<span class="token punctuation">,</span>
    opcode parser<span class="token punctuation">.</span>Opcode<span class="token punctuation">,</span>
    operands <span class="token operator">...</span><span class="token builtin">int</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    filePos <span class="token operator">:=</span> parser<span class="token punctuation">.</span>NoPos
    <span class="token keyword">if</span> node <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        filePos <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">Pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    inst <span class="token operator">:=</span> <span class="token function">MakeInstruction</span><span class="token punctuation">(</span>opcode<span class="token punctuation">,</span> operands<span class="token operator">...</span><span class="token punctuation">)</span>
    pos <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">addInstruction</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>scopes<span class="token punctuation">[</span>c<span class="token punctuation">.</span>scopeIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>SourceMap<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">=</span> filePos
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>trace <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span><span class="token function">printTrace</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;EMIT  %s&quot;</span><span class="token punctuation">,</span>
            <span class="token function">FormatInstructions</span><span class="token punctuation">(</span>
                c<span class="token punctuation">.</span>scopes<span class="token punctuation">[</span>c<span class="token punctuation">.</span>scopeIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>Instructions<span class="token punctuation">[</span>pos<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pos
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiler<span class="token punctuation">)</span> <span class="token function">addInstruction</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    posNewIns <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">currentInstructions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>scopes<span class="token punctuation">[</span>c<span class="token punctuation">.</span>scopeIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>Instructions <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>
        c<span class="token punctuation">.</span><span class="token function">currentInstructions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> posNewIns
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiler<span class="token punctuation">)</span> <span class="token function">currentInstructions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> c<span class="token punctuation">.</span>scopes<span class="token punctuation">[</span>c<span class="token punctuation">.</span>scopeIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>Instructions
<span class="token punctuation">}</span>
</code></pre>
<h4 id="compile&#x4E4B;module"><a name="compile&#x4E4B;module" class="anchor-navigation-ex-anchor" href="#compile&#x4E4B;module"><i class="fa fa-link" aria-hidden="true"></i></a>Compile&#x4E4B;module</h4>
<p>Compile&#x9047;&#x5230;import&#x8BED;&#x53E5;&#x65F6;, import&#x5148;&#x4ECE;&#x6CE8;&#x518C;&#x8FC7;&#x7684;module&#x67E5;&#x627E;. &#x6CA1;&#x6709;&#x7684;&#x8BDD;, &#x4ECE;&#x6587;&#x4EF6;&#x67E5;&#x627E;</p>
<pre class="language-"><code class="lang-go">    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>ImportExpr<span class="token punctuation">:</span>
        <span class="token keyword">if</span> node<span class="token punctuation">.</span>ModuleName <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">errorf</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&quot;empty module name&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> mod <span class="token operator">:=</span> c<span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ModuleName<span class="token punctuation">)</span><span class="token punctuation">;</span> mod <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            v<span class="token punctuation">,</span> err <span class="token operator">:=</span> mod<span class="token punctuation">.</span><span class="token function">Import</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ModuleName<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>

            <span class="token keyword">switch</span> v <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">:</span> <span class="token comment">// module written in Tengo &#x6CE8;&#x518C;&#x8FC7;&#x7684;tengo&#x4EE3;&#x7801;, &#x8FD8;&#x662F;&#x539F;&#x59CB;&#x6587;&#x672C;&#x4EE3;&#x7801;</span>
                compiled<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">compileModule</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token comment">//&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x9700;&#x8981;compile</span>
                    node<span class="token punctuation">.</span>ModuleName<span class="token punctuation">,</span> v<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> err
                <span class="token punctuation">}</span>
                c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpConstant<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">addConstant</span><span class="token punctuation">(</span>compiled<span class="token punctuation">)</span><span class="token punctuation">)</span>
                c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpCall<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">case</span> Object<span class="token punctuation">:</span> <span class="token comment">// builtin module</span>
                c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpConstant<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">addConstant</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid import value type: %T&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> c<span class="token punctuation">.</span>allowFileImport <span class="token punctuation">{</span> <span class="token comment">//&#x5982;&#x679C;&#x4F7F;&#x80FD;&#x4E86;&#x6587;&#x4EF6;module</span>
            moduleName <span class="token operator">:=</span> node<span class="token punctuation">.</span>ModuleName
            <span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">,</span> <span class="token string">&quot;.tengo&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                moduleName <span class="token operator">+=</span> <span class="token string">&quot;.tengo&quot;</span> <span class="token comment">//module&#x5FC5;&#x987B;&#x4EE5;.tengo&#x7ED3;&#x5C3E;</span>
            <span class="token punctuation">}</span>

            modulePath<span class="token punctuation">,</span> err <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Abs</span><span class="token punctuation">(</span>
                filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>importDir<span class="token punctuation">,</span> moduleName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//module name&#x662F;&#x4E2A;&#x76F8;&#x5BF9;&#x8DEF;&#x5F84;, &#x8981;&#x548C;c.importDir&#x7ED3;&#x5408;&#x624D;&#x80FD;&#x627E;&#x5230;&#x6587;&#x4EF6;</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">errorf</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&quot;module file path error: %s&quot;</span><span class="token punctuation">,</span>
                    err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            moduleSrc<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">errorf</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&quot;module file read error: %s&quot;</span><span class="token punctuation">,</span>
                    err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            compiled<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">compileModule</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> modulePath<span class="token punctuation">,</span> moduleSrc<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpConstant<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">addConstant</span><span class="token punctuation">(</span>compiled<span class="token punctuation">)</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpCall<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">errorf</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&quot;module &apos;%s&apos; not found&quot;</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>ModuleName<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>ExportStmt<span class="token punctuation">:</span>
        <span class="token comment">// export statement must be in top-level scope</span>
        <span class="token keyword">if</span> c<span class="token punctuation">.</span>scopeIndex <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">errorf</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&quot;export not allowed inside function&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// export statement is simply ignore when compiling non-module code</span>
        <span class="token keyword">if</span> c<span class="token punctuation">.</span>parent <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpImmutable<span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpReturn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="compilemodule&#x51FD;&#x6570;"><a name="compilemodule&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#compilemodule&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>compileModule()&#x51FD;&#x6570;</h4>
<p>&#x4E00;&#x4E2A;module&#x88AB;&#x7F16;&#x8BD1;&#x540E;, &#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x4E2A;<code>*CompiledFunction</code>, &#x5B9A;&#x4E49;&#x4E8E;<code>objects.go</code></p>
<pre class="language-"><code class="lang-go"><span class="token comment">// CompiledFunction represents a compiled function.</span>
<span class="token keyword">type</span> CompiledFunction <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    ObjectImpl
    Instructions  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    NumLocals     <span class="token builtin">int</span> <span class="token comment">// number of local variables (including function parameters)</span>
    NumParameters <span class="token builtin">int</span>
    VarArgs       <span class="token builtin">bool</span>
    SourceMap     <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span>parser<span class="token punctuation">.</span>Pos
    Free          <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>ObjectPtr
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5B83;&#x5148;&#x68C0;&#x67E5;&#x662F;&#x5426;&#x6709;&#x5FAA;&#x73AF;&#x4F9D;&#x8D56;. &#x7136;&#x540E;&#x68C0;&#x67E5;&#x662F;&#x5426;&#x8BE5;&#x6A21;&#x5757;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x7F16;&#x8BD1;&#x8FC7;&#x4E86;, &#x7F16;&#x8BD1;&#x8FC7;&#x5C31;&#x4E0D;&#x9700;&#x8981;&#x518D;&#x7F16;&#x4E86;, &#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x4E4B;&#x524D;&#x7684;.<br>&#x7136;&#x540E;&#x624D;&#x662F;&#x7F16;&#x8BD1;.<br>&#x6A21;&#x5757;&#x7684;&#x7F16;&#x8BD1;&#x4F7F;&#x7528;&#x4E86;fork&#x7684;&#x6982;&#x5FF5;, &#x5373;fork&#x4E00;&#x4E2A;&#x4E0A;&#x7EA7;compiler&#x7684;&#x526F;&#x672C;, &#x518D;&#x586B;&#x5165;module&#x7684;&#x4FE1;&#x606F;&#x6765;&#x7F16;&#x8BD1;.<br>&#x7F16;&#x8BD1;&#x5B8C;&#x6210;&#x540E;&#x8FD8;&#x8981;&#x4ECE;&#x5B57;&#x8282;&#x7801;&#x7684;&#x89D2;&#x5EA6;&#x6765;&#x4F18;&#x5316;&#x4EE3;&#x7801;. &#x6700;&#x540E;&#x4FDD;&#x5B58;&#x8FD9;&#x4E2A;&#x7F16;&#x8BD1;&#x597D;&#x7684;module<br>&#x7B80;&#x5316;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code class="lang-go">    c<span class="token punctuation">.</span><span class="token function">checkCyclicImports</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">loadCompiledModule</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span>
    modFile <span class="token operator">:=</span> c<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddFile</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">:=</span> parser<span class="token punctuation">.</span><span class="token function">NewParser</span><span class="token punctuation">(</span>modFile<span class="token punctuation">,</span> src<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">ParseFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// inherit builtin functions</span>
    symbolTable <span class="token operator">:=</span> <span class="token function">NewSymbolTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// no global scope for the module</span>
    symbolTable <span class="token operator">=</span> symbolTable<span class="token punctuation">.</span><span class="token function">Fork</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token comment">// compile module</span>
    moduleCompiler <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>modFile<span class="token punctuation">,</span> modulePath<span class="token punctuation">,</span> symbolTable<span class="token punctuation">,</span> isFile<span class="token punctuation">)</span>
    moduleCompiler<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    <span class="token comment">// code optimization</span>
    moduleCompiler<span class="token punctuation">.</span><span class="token function">optimizeFunc</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
    compiledFunc <span class="token operator">:=</span> moduleCompiler<span class="token punctuation">.</span><span class="token function">Bytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>MainFunction
    c<span class="token punctuation">.</span><span class="token function">storeCompiledModule</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> compiledFunc<span class="token punctuation">)</span>
    <span class="token keyword">return</span> compiledFunc<span class="token punctuation">,</span> <span class="token boolean">nil</span>
</code></pre>
<p>&#x6CE8;: 
storeCompiledModule()&#x548C;loadCompiledModule()&#x90FD;&#x662F;&#x5BF9;&#x6700;&#x9876;&#x5C42;&#x7684;Compiler&#x64CD;&#x4F5C;&#x7684;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiler<span class="token punctuation">)</span> <span class="token function">loadCompiledModule</span><span class="token punctuation">(</span>
    modulePath <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span>mod <span class="token operator">*</span>CompiledFunction<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>parent <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> c<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">loadCompiledModule</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    mod<span class="token punctuation">,</span> ok <span class="token operator">=</span> c<span class="token punctuation">.</span>compiledModules<span class="token punctuation">[</span>modulePath<span class="token punctuation">]</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiler<span class="token punctuation">)</span> <span class="token function">storeCompiledModule</span><span class="token punctuation">(</span>
    modulePath <span class="token builtin">string</span><span class="token punctuation">,</span>
    module <span class="token operator">*</span>CompiledFunction<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>parent <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">storeCompiledModule</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> module<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    c<span class="token punctuation">.</span>compiledModules<span class="token punctuation">[</span>modulePath<span class="token punctuation">]</span> <span class="token operator">=</span> module
<span class="token punctuation">}</span>
</code></pre>
<h4 id="module&#x9ED8;&#x8BA4;&#x8DEF;&#x5F84;"><a name="module&#x9ED8;&#x8BA4;&#x8DEF;&#x5F84;" class="anchor-navigation-ex-anchor" href="#module&#x9ED8;&#x8BA4;&#x8DEF;&#x5F84;"><i class="fa fa-link" aria-hidden="true"></i></a>module&#x9ED8;&#x8BA4;&#x8DEF;&#x5F84;</h4>
<p><code>c.importDir</code>&#x9ED8;&#x8BA4;&#x4E3A;<code>&quot;&quot;</code>, &#x5373;&#x4ECE;&#x5F53;&#x524D;&#x76EE;&#x5F55;&#x627E;module<br>&#x4E5F;&#x53EF;&#x4EE5;&#x8C03;&#x7528;<br><code>c.SetImportDir(filepath.Dir(inputFile))</code><br>&#x628A;import&#x8DEF;&#x5F84;&#x8BBE;&#x4E3A;&#x6587;&#x4EF6;&#x540D;&#x7684;&#x8DEF;&#x5F84;. &#x8FD9;&#x4E2A;&#x4E3B;&#x610F;&#x4E0D;&#x9519;.</p>
<h4 id="bytecode&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x7F16;&#x8BD1;&#x597D;&#x7684;&#x5B57;&#x8282;&#x7801;"><a name="bytecode&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x7F16;&#x8BD1;&#x597D;&#x7684;&#x5B57;&#x8282;&#x7801;" class="anchor-navigation-ex-anchor" href="#bytecode&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x7F16;&#x8BD1;&#x597D;&#x7684;&#x5B57;&#x8282;&#x7801;"><i class="fa fa-link" aria-hidden="true"></i></a>Bytecode()&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x7F16;&#x8BD1;&#x597D;&#x7684;&#x5B57;&#x8282;&#x7801;</h4>
<p>&#x5B83;&#x8C03;&#x7528;&#x4E86;&#x4E0A;&#x9762;&#x7684;<code>c.currentInstructions()</code></p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Bytecode returns a compiled bytecode.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiler<span class="token punctuation">)</span> <span class="token function">Bytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Bytecode <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Bytecode<span class="token punctuation">{</span>
        FileSet<span class="token punctuation">:</span> c<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        MainFunction<span class="token punctuation">:</span> <span class="token operator">&amp;</span>CompiledFunction<span class="token punctuation">{</span>
            Instructions<span class="token punctuation">:</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">currentInstructions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpSuspend<span class="token punctuation">)</span><span class="token punctuation">,</span>
            SourceMap<span class="token punctuation">:</span>    c<span class="token punctuation">.</span><span class="token function">currentSourceMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        Constants<span class="token punctuation">:</span> c<span class="token punctuation">.</span>constants<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="modulesgo"><a name="modulesgo" class="anchor-navigation-ex-anchor" href="#modulesgo"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.13. modules.go</h3>
<p>tengo&#x7684;&#x6A21;&#x5757;&#x652F;&#x6301;<br>ModuleMap&#x662F;&#x4E2A;&#x7B80;&#x5355;&#x7684;map<br>Importable&#x662F;&#x4E2A;&#x53EF;&#x4EE5;&#x88AB;import&#x7684;&#x5BF9;&#x8C61;: Import()&#x7684;&#x7B7E;&#x540D;&#x8DB3;&#x591F;&#x7B80;&#x5355;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Importable interface represents importable module instance.</span>
<span class="token keyword">type</span> Importable <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment">// Import should return either an Object or module source code ([]byte).</span>
    <span class="token function">Import</span><span class="token punctuation">(</span>moduleName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// ModuleMap represents a set of named modules. Use NewModuleMap to create a</span>
<span class="token comment">// new module map.</span>
<span class="token keyword">type</span> ModuleMap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Importable
<span class="token punctuation">}</span>
</code></pre>
<p>NewModuleMap()&#x5C31;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x521D;&#x59CB;&#x7684;ModuleMap</p>
<h4 id="module&#x7C7B;&#x578B;-&#x652F;&#x6301;import-native-go&#x5BF9;&#x8C61;&#x548C;tengo&#x4EE3;&#x7801;"><a name="module&#x7C7B;&#x578B;-&#x652F;&#x6301;import-native-go&#x5BF9;&#x8C61;&#x548C;tengo&#x4EE3;&#x7801;" class="anchor-navigation-ex-anchor" href="#module&#x7C7B;&#x578B;-&#x652F;&#x6301;import-native-go&#x5BF9;&#x8C61;&#x548C;tengo&#x4EE3;&#x7801;"><i class="fa fa-link" aria-hidden="true"></i></a>module&#x7C7B;&#x578B;: &#x652F;&#x6301;import native go&#x5BF9;&#x8C61;&#x548C;tengo&#x4EE3;&#x7801;</h4>
<p>&#x4E0B;&#x9762;&#x4EE3;&#x7801;&#x4E2D;&#x6709;&#x4E09;&#x79CD;module&#x7C7B;&#x578B;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Add adds an import module.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>ModuleMap<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> module Importable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m<span class="token punctuation">.</span>m<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> module
<span class="token punctuation">}</span>

<span class="token comment">// AddBuiltinModule adds a builtin module.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>ModuleMap<span class="token punctuation">)</span> <span class="token function">AddBuiltinModule</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> attrs <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m<span class="token punctuation">.</span>m<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>BuiltinModule<span class="token punctuation">{</span>Attrs<span class="token punctuation">:</span> attrs<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// AddSourceModule adds a source module.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>ModuleMap<span class="token punctuation">)</span> <span class="token function">AddSourceModule</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> src <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m<span class="token punctuation">.</span>m<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>SourceModule<span class="token punctuation">{</span>Src<span class="token punctuation">:</span> src<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>&#x666E;&#x901A;&#x7684;&#x5B9E;&#x73B0;&#x4E86;Import()&#x65B9;&#x6CD5;&#x7684;&#x5BF9;&#x8C61;</li>
<li>Builtin&#x6A21;&#x5757;: &#x7528;&#x4E8E;import native go&#x5B9E;&#x73B0;&#x7684;&#x5BF9;&#x8C61;. &#x5C31;&#x662F;add&#x4E00;&#x4E2A;<code>map[string]Object</code>, import builtin&#x6A21;&#x5757;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;<code>ImmutableMap</code>&#x5BF9;&#x8C61;
&#x5B9A;&#x4E49;&#x4E8E;<code>objects.go</code></li>
</ul>
<pre class="language-"><code class="lang-go"><span class="token comment">// BuiltinModule is an importable module that&apos;s written in Go.</span>
<span class="token keyword">type</span> BuiltinModule <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Attrs <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Object
<span class="token punctuation">}</span>

<span class="token comment">// Import returns an immutable map for the module.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>BuiltinModule<span class="token punctuation">)</span> <span class="token function">Import</span><span class="token punctuation">(</span>moduleName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token function">AsImmutableMap</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// AsImmutableMap converts builtin module into an immutable map.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>BuiltinModule<span class="token punctuation">)</span> <span class="token function">AsImmutableMap</span><span class="token punctuation">(</span>moduleName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>ImmutableMap <span class="token punctuation">{</span>
    attrs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Object<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Attrs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>Attrs <span class="token punctuation">{</span>
        attrs<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    attrs<span class="token punctuation">[</span><span class="token string">&quot;__module_name__&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>String<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> moduleName<span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>ImmutableMap<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> attrs<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ImmutableMap represents an immutable map object.</span>
<span class="token keyword">type</span> ImmutableMap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    ObjectImpl
    Value <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Object
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>&#x6E90;&#x7801;&#x6A21;&#x5757;: &#x7528;&#x4E8E;import tengo&#x811A;&#x672C;&#x4EE3;&#x7801;</li>
</ul>
<pre class="language-"><code class="lang-go"><span class="token comment">// SourceModule is an importable module that&apos;s written in Tengo.</span>
<span class="token keyword">type</span> SourceModule <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Src <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token punctuation">}</span>

<span class="token comment">// Import returns a module source code.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>SourceModule<span class="token punctuation">)</span> <span class="token function">Import</span><span class="token punctuation">(</span><span class="token boolean">_</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> m<span class="token punctuation">.</span>Src<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6CE8;: &#x8FD9;&#x91CC;&#x7684;Import&#x7684;&#x6E90;&#x7801;&#x6A21;&#x5757;, &#x662F;&#x6CA1;&#x6709;&#x7ECF;&#x8FC7;&#x7F16;&#x8BD1;&#x7684;. &#x540D;&#x5B57;&#x88AB;&#x6545;&#x610F;&#x53BB;&#x6389;&#x4E86;, &#x53EF;&#x80FD;&#x662F;&#x540E;&#x9762;&#x548C;&quot;main&quot;&#x811A;&#x672C;&#x4E00;&#x8D77;&#x7F16;&#x8BD1;.</p>
<h3 id="symboltablego"><a name="symboltablego" class="anchor-navigation-ex-anchor" href="#symboltablego"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.14. symbol_table.go</h3>
<p>&#x63D0;&#x4F9B;symbol&#x7684;&#x5B9A;&#x4E49;&#x548C;&#x5B58;&#x50A8;, define&#x4E00;&#x4E2A;symbol&#x7684;&#x64CD;&#x4F5C;
symbol&#x5206;&#x4E3A;&#x56DB;&#x79CD;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// List of symbol scopes</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
    ScopeGlobal  SymbolScope <span class="token operator">=</span> <span class="token string">&quot;GLOBAL&quot;</span>
    ScopeLocal   SymbolScope <span class="token operator">=</span> <span class="token string">&quot;LOCAL&quot;</span>
    ScopeBuiltin SymbolScope <span class="token operator">=</span> <span class="token string">&quot;BUILTIN&quot;</span>
    ScopeFree    SymbolScope <span class="token operator">=</span> <span class="token string">&quot;FREE&quot;</span>
<span class="token punctuation">)</span>
</code></pre>
<p>SymbolTable&#x5E94;&#x8BE5;&#x662F;&#x4E2A;&#x6811;&#x7ED3;&#x6784;, &#x4F46;&#x53EA;&#x80FD;&#x5F80;&#x4E0A;&#x627E;parent; &#x8FD9;&#x5F88;&#x597D;&#x7406;&#x89E3;: &#x4E00;&#x822C;&#x7684;call stack&#x4E2D;, &#x90FD;&#x662F;&#x4E00;&#x8DEF;&#x5411;&#x4E0B;&#x7684;&#x8C03;&#x7528;, caller&#x51FD;&#x6570;&#x5176;&#x5B9E;&#x66F4;&#x5173;&#x5FC3;&#x600E;&#x4E48;return&#x5230;&#x7236;&#x7EA7;&#x51FD;&#x6570;, &#x800C;&#x4E0D;&#x600E;&#x4E48;&#x5173;&#x5FC3;callee&#x51FD;&#x6570;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Symbol represents a symbol in the symbol table.</span>
<span class="token keyword">type</span> Symbol <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name          <span class="token builtin">string</span>
    Scope         SymbolScope
    Index         <span class="token builtin">int</span>
    LocalAssigned <span class="token builtin">bool</span> <span class="token comment">// if the local symbol is assigned at least once</span>
<span class="token punctuation">}</span>

<span class="token comment">// SymbolTable represents a symbol table.</span>
<span class="token keyword">type</span> SymbolTable <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    parent         <span class="token operator">*</span>SymbolTable 
    block          <span class="token builtin">bool</span>
    store          <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Symbol
    numDefinition  <span class="token builtin">int</span>
    maxDefinition  <span class="token builtin">int</span>
    freeSymbols    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Symbol
    builtinSymbols <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Symbol
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6CE8;&#x610F;&#x8FD9;&#x91CC;symbolTable&#x53EA;&#x5173;&#x6CE8;(name, index), &#x5373;symbolTable&#x672C;&#x8EAB;&#x53EA;&#x4FDD;&#x5B58;&#x7B26;&#x53F7;&#x548C;index, &#x5E76;&#x4E0D;&#x4FDD;&#x5B58;Object.</p>
<h4 id="newsymboltable&#x51FD;&#x6570;"><a name="newsymboltable&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#newsymboltable&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>NewSymbolTable()&#x51FD;&#x6570;</h4>
<p>&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;SymbolTable&#x7ED3;&#x6784;&#x4F53;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// NewSymbolTable creates a SymbolTable.</span>
<span class="token keyword">func</span> <span class="token function">NewSymbolTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>SymbolTable <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>SymbolTable<span class="token punctuation">{</span>
        store<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="define&#x51FD;&#x6570;"><a name="define&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#define&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>Define()&#x51FD;&#x6570;</h4>
<p><code>func (t *SymbolTable) Define(name string) *Symbol</code>
&#x786E;&#x5B9A;&#x8FD9;&#x4E2A;Symbol&#x7684;scope:</p>
<ul>
<li>&#x5982;&#x679C;t&#x6709;parent, &#x5219;&#x8FD9;&#x4E2A;symbol&#x662F;local&#x7684;</li>
<li>&#x5426;&#x5219;&#x662F;global&#x7684;</li>
<li>&#x7136;&#x540E;&#x653E;&#x5728;&#x8FD9;&#x4E2A;t&#x7684;store&#x4E2D;: <code>t.store[name] = symbol</code></li>
</ul>
<h4 id="builtin&#x7B26;&#x53F7;&#x9664;&#x4E86;&#x4FDD;&#x5B58;&#x5728;store&#x4E2D;-&#x8FD8;&#x4FDD;&#x5B58;&#x5728;&#x5355;&#x72EC;&#x7684;builtinsymbols&#x4E2D;"><a name="builtin&#x7B26;&#x53F7;&#x9664;&#x4E86;&#x4FDD;&#x5B58;&#x5728;store&#x4E2D;-&#x8FD8;&#x4FDD;&#x5B58;&#x5728;&#x5355;&#x72EC;&#x7684;builtinsymbols&#x4E2D;" class="anchor-navigation-ex-anchor" href="#builtin&#x7B26;&#x53F7;&#x9664;&#x4E86;&#x4FDD;&#x5B58;&#x5728;store&#x4E2D;-&#x8FD8;&#x4FDD;&#x5B58;&#x5728;&#x5355;&#x72EC;&#x7684;builtinsymbols&#x4E2D;"><i class="fa fa-link" aria-hidden="true"></i></a>builtin&#x7B26;&#x53F7;&#x9664;&#x4E86;&#x4FDD;&#x5B58;&#x5728;store&#x4E2D;, &#x8FD8;&#x4FDD;&#x5B58;&#x5728;&#x5355;&#x72EC;&#x7684;builtinSymbols&#x4E2D;</h4>
<p>builtin&#x7B26;&#x53F7;&#x4FDD;&#x5B58;&#x5728;&#x6700;&#x9876;&#x5C42;&#x7684;&#x7B26;&#x53F7;&#x8868;&#x4E2D;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// DefineBuiltin adds a symbol for builtin function.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>SymbolTable<span class="token punctuation">)</span> <span class="token function">DefineBuiltin</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Symbol <span class="token punctuation">{</span>
    <span class="token keyword">if</span> t<span class="token punctuation">.</span>parent <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> t<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">DefineBuiltin</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    symbol <span class="token operator">:=</span> <span class="token operator">&amp;</span>Symbol<span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span>  name<span class="token punctuation">,</span>
        Index<span class="token punctuation">:</span> index<span class="token punctuation">,</span>
        Scope<span class="token punctuation">:</span> ScopeBuiltin<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    t<span class="token punctuation">.</span>store<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> symbol
    t<span class="token punctuation">.</span>builtinSymbols <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>builtinSymbols<span class="token punctuation">,</span> symbol<span class="token punctuation">)</span>
    <span class="token keyword">return</span> symbol
<span class="token punctuation">}</span>
</code></pre>
<h4 id="fork&#x51FD;&#x6570;"><a name="fork&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#fork&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>Fork()&#x51FD;&#x6570;</h4>
<p>&#x5F53;&#x626B;&#x63CF;ast&#x53D1;&#x73B0;&#x662F;&#x4E00;&#x4E2A;block statement&#x65F6;, &#x8C03;&#x7528;SymbolTable&#x7684;Fork&#x51FD;&#x6570;, &#x5728;&#x5F53;&#x524D;SymbolTable&#x4E0B;, &#x65B0;&#x5EFA;&#x4E00;&#x4E2A;SymbolTable.<br>&#x9000;&#x51FA;&#x8FD9;&#x4E2A;block statement&#x65F6;, &#x8FD8;&#x539F;SymbolTable&#x5230;&#x7236;symbolTable<br>compile&#x51FD;&#x6570;&#x7247;&#x6BB5;:</p>
<pre class="language-"><code class="lang-go">    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>BlockStmt<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Stmts<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//&#x6CE8;&#x610F;&#x8FD9;&#x91CC;, compile&#x5230;&#x8FD9;&#x91CC;&#x53D1;&#x73B0;&#x662F;&#x4E2A;&#x65B0;&#x7684;&#x8BED;&#x53E5;&#x5757;, &#x6BD4;&#x5982;if, for&#x7684;body&#x90E8;&#x5206;</span>
        <span class="token comment">//fork&#x4E00;&#x4E2A;&#x65B0;&#x7684;symbolTable, &#x5E76;&#x505A;&#x4E3A;&#x5F53;&#x524D;&#x7684;symbolTable: &#x6CE8;&#x610F;&#x4E0B;&#x9762;&#x8FD9;&#x53E5;</span>
        c<span class="token punctuation">.</span>symbolTable <span class="token operator">=</span> c<span class="token punctuation">.</span>symbolTable<span class="token punctuation">.</span><span class="token function">Fork</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> 
        <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//&#x9000;&#x51FA;&#x8FD9;&#x4E2A;block&#x7684;&#x65F6;&#x5019;, &#x8FD8;&#x539F;symbolTable&#x4E3A;&#x7236;symbolTable</span>
            c<span class="token punctuation">.</span>symbolTable <span class="token operator">=</span> c<span class="token punctuation">.</span>symbolTable<span class="token punctuation">.</span><span class="token function">Parent</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> stmt <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>Stmts <span class="token punctuation">{</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre>
<h4 id="resolve&#x51FD;&#x6570;"><a name="resolve&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#resolve&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>Resolve()&#x51FD;&#x6570;</h4>
<p>Resolve()&#x51FD;&#x6570;&#x4ECE;&#x672C;SymbolTable&#x5F00;&#x59CB;, &#x9012;&#x5F52;&#x7684;&#x6CBF;parent&#x8DEF;&#x5F84;&#x67E5;&#x627E;, &#x76F4;&#x5230;&#x5728;&#x8DEF;&#x5F84;&#x4E0A;&#x7684;t.store map&#x4E2D;&#x627E;&#x5230;&#x8BE5;name&#x7684;symbol.<br>&#x8FD9;&#x5C31;&#x50CF;&#x662F;&#x5728;&#x672C;&#x51FD;&#x6570;&#x4F5C;&#x7528;&#x57DF;&#x67E5;&#x627E;&#x53D8;&#x91CF;&#x4E00;&#x6837;: &#x5728;&#x672C;&#x51FD;&#x6570;&#x6CA1;&#x6709;, &#x5C31;&#x627E;&#x7236;&#x51FD;&#x6570;, &#x76F4;&#x5230;global&#x7684;&#x7B26;&#x53F7;&#x8868;.<br>&#x5982;&#x679C;&#x672C;&#x51FD;&#x6570;&#x6CA1;&#x6709;, &#x4F46;&#x5728;&#x67D0;&#x4E2A;&#x7236;&#x51FD;&#x6570;&#x627E;&#x5230;&#x4E86;&#x8FD9;&#x4E2A;&#x7B26;&#x53F7;, &#x8FD9;&#x4E2A;&#x7B26;&#x53F7;&#x5C31;&#x662F;free scope&#x7C7B;&#x578B;&#x7684;.<br>&#x627E;&#x5230;free scope&#x7C7B;&#x578B;&#x7684;&#x7B26;&#x53F7;&#x540E;, &#x6DFB;&#x52A0;&#x5230;&#x672C;&#x51FD;&#x6570;&#x7684;SymbolTable&#x4E2D;.</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// if symbol is defined in parent table and if it&apos;s not global/builtin</span>
    <span class="token comment">// then it&apos;s free variable.</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>t<span class="token punctuation">.</span>block <span class="token operator">&amp;&amp;</span> depth <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
        symbol<span class="token punctuation">.</span>Scope <span class="token operator">!=</span> ScopeGlobal <span class="token operator">&amp;&amp;</span>
        symbol<span class="token punctuation">.</span>Scope <span class="token operator">!=</span> ScopeBuiltin <span class="token punctuation">{</span>
        <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">defineFree</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span><span class="token punctuation">,</span> depth<span class="token punctuation">,</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>free scope&#x8FD9;&#x4E2A;&#x540D;&#x5B57;&#x5F88;&#x8D34;&#x5207;, &quot;&#x6E38;&#x79BB;&quot;&#x7684;&#x53D8;&#x91CF;: &#x5B9A;&#x4E49;&#x4E8E;&#x67D0;&#x4E2A;&#x51FD;&#x6570;, &#x4F46;&#x5728;&#x5176;&#x5B50;&#x51FD;&#x6570;&#x4E2D;&#x88AB;&#x5F15;&#x7528;&#x5230; -- &#x8FD9;&#x5C31;&#x662F;&#x95ED;&#x5305;&#x7684;&#x6982;&#x5FF5;.<br>&#x5BF9;&#x5B50;&#x51FD;&#x6570;&#x6765;&#x8BF4;, &#x5F15;&#x7528;&#x7236;&#x51FD;&#x6570;&#x7684;&#x53D8;&#x91CF;, &#x662F;free scope; &#x4F46;&#x5BF9;&#x88AB;&#x5F15;&#x7528;&#x7684;&#x8FD9;&#x4E2A;&#x7236;&#x51FD;&#x6570;&#x53D8;&#x91CF;&#x6765;&#x8BF4;, &#x5B83;&#x5728;&#x7236;&#x51FD;&#x6570;&#x4E2D;&#x662F;local&#x7684;.<br>&#x5728;compile&#x751F;&#x6210;&#x5B57;&#x8282;&#x7801;&#x9636;&#x6BB5;&#x5C31;&#x8C03;&#x7528;&#x4E86;Resolve()&#x51FD;&#x6570;</p>
<pre class="language-"><code class="lang-go">    <span class="token keyword">case</span> <span class="token operator">*</span>parser<span class="token punctuation">.</span>Ident<span class="token punctuation">:</span>
        <span class="token comment">// &#x5728;&#x5F53;&#x524D;symbolTable&#x67E5;&#x627E;name, symbolTable&#x6709;&#x7236;symbolTable&#x7684;&#x6307;&#x9488;</span>
        <span class="token comment">// &#x5F53;&#x524D;&#x627E;&#x4E0D;&#x5230;&#x4F1A;&#x4F9D;&#x6B21;&#x5F80;&#x4E0A;&#x67E5;&#x627E;</span>
        symbol<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> c<span class="token punctuation">.</span>symbolTable<span class="token punctuation">.</span><span class="token function">Resolve</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">errorf</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&quot;unresolved reference &apos;%s&apos;&quot;</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">switch</span> symbol<span class="token punctuation">.</span>Scope <span class="token punctuation">{</span>
        <span class="token keyword">case</span> ScopeGlobal<span class="token punctuation">:</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetGlobal<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
        <span class="token keyword">case</span> ScopeLocal<span class="token punctuation">:</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetLocal<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
        <span class="token keyword">case</span> ScopeBuiltin<span class="token punctuation">:</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetBuiltin<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
        <span class="token keyword">case</span> ScopeFree<span class="token punctuation">:</span>
            c<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>OpGetFree<span class="token punctuation">,</span> symbol<span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
</code></pre>
<h4 id="&#x603B;&#x7ED3;_2"><a name="&#x603B;&#x7ED3;_2" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;_2"><i class="fa fa-link" aria-hidden="true"></i></a>&#x603B;&#x7ED3;</h4>
<p>&#x57FA;&#x672C;&#x4E0A;&#x4E00;&#x4E2A;symbolTable&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;block&#x4F53;, &#x6BD4;&#x5982;for&#x7684;&#x7684;&#x4EE3;&#x7801;&#x5757;&#x4E3B;&#x4F53;&#x5C31;&#x662F;&#x4E00;&#x4E2A;symbolTable.<br>&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;&#x65B0;&#x7684;symbolTable, &#x51FD;&#x6570;return&#x8FD4;&#x56DE;&#x7684;&#x65F6;&#x5019;symbolTable&#x4E5F;&#x6062;&#x590D;&#x4E3A;&#x5176;&#x7236;symbolTable.</p>
<p>symbolTable&#x5728;&#x7F16;&#x8BD1;&#x9636;&#x6BB5;&#x53D1;&#x6325;&#x4F5C;&#x7528;, &#x5373;&#x4ECE;ast&#x5230;&#x5B57;&#x8282;&#x7801;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;, &#x6839;&#x636E;&#x8BED;&#x4E49;&#x5206;&#x6790;&#x7684;ast, &#x5982;&#x679C;&#x662F;&#x5BF9;&#x53D8;&#x91CF;&#x7684;&#x5F15;&#x7528;, &#x5C31;&#x5728;&#x5F53;&#x524D;symbolTable&#x4E2D;&#x67E5;&#x627E;&#x53D8;&#x91CF;&#x7684;&#x7B26;&#x53F7;, &#x5E76;&#x6700;&#x7EC8;emit&#x5230;&#x5B57;&#x8282;&#x7801;&#x4E2D;(&#x89C1;&#x4E0A;&#x9762;&#x4EE3;&#x7801;).<br>&#x5982;&#x679C;&#x662F;&#x5BF9;&#x53D8;&#x91CF;&#x7684;&#x8D4B;&#x503C;, &#x6BD4;&#x5982;&#x5BF9;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8D4B;&#x503C;, &#x4F1A;&#x8C03;&#x7528;<br><code>c.emit(node, parser.OpSetLocal, symbol.Index)</code>  </p>
<p>&#x770B;&#x5230;&#x8FD9;&#x91CC;&#x6211;&#x8BA4;&#x4E3A;&#x5B57;&#x8282;&#x7801;&#x4E2D;&#x5E76;&#x6CA1;&#x6709;&#x7B26;&#x53F7;&#x4FE1;&#x606F;, &#x5C31;&#x50CF;&#x6C47;&#x7F16;&#x91CC;&#x5DF2;&#x7ECF;&#x4E0D;&#x662F;&#x53D8;&#x91CF;&#x540D;&#x4E86;, &#x800C;&#x662F;&#x5730;&#x5740;.</p>
<h3 id="vmgo"><a name="vmgo" class="anchor-navigation-ex-anchor" href="#vmgo"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.15. vm.go</h3>
<p>&#x770B;&#x8D77;&#x6765;&#x5230;VM&#x9636;&#x6BB5;, &#x5B57;&#x8282;&#x7801;&#x5DF2;&#x7ECF;&#x662F;&#x89E3;&#x7ED3;&#x6784;&#x5316;&#x7684;, &#x7C7B;&#x4F3C;&#x6C47;&#x7F16;&#x5F0F;&#x7684;&#x6307;&#x4EE4;&#x6D41;&#x4E86;. &#x6240;&#x4EE5;&#x8FD9;&#x4E2A;run&#x51FD;&#x6570;&#x7684;&#x4E3B;&#x4F53;&#x662F;&#x4E2A;for, &#x901A;&#x8FC7;&#x63A7;&#x5236;ip&#x7684;&#x79FB;&#x52A8;&#x6765;&quot;&#x6267;&#x884C;&quot;&#x6307;&#x4EE4;&#x6D41;. &#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x4E0D;&#x662F;&#x89E3;&#x91CA;&#x5668;&#x90A3;&#x79CD;&#x7684;&#x9012;&#x5F52;&#x8C03;&#x7528;Eval&#x7684;&#x60C5;&#x51B5;.</p>
<p>VM&#x662F;&#x4E2A;&#x56FA;&#x5B9A;&#x6808;&#x5927;&#x5C0F;&#x7684;(&#x76EE;&#x524D;&#x662F;&#x56FA;&#x5B9A;2048&#x4E2A;Object&#x5BF9;&#x8C61;), &#x6709;global&#x7684;&#x5F15;&#x7528;, &#x6700;&#x5927;1024&#x4E2A;frame&#x7684;VM.<br>&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x7684;&#x6808;&#x5927;&#x5C0F;&#x662F;&#x6574;&#x4E2A;VM&#x7684;&#x6808;, &#x968F;&#x7740;fram&#x7684;&#x589E;&#x51CF;&#x800C;&#x4E0A;&#x4E0B;&#x6D6E;&#x52A8;. &#x5BF9;&#x5E94;C&#x91CC;&#x9762;<code>ulimit -s</code>&#x7684;&#x6808;&#x5927;&#x5C0F;, &#x4E00;&#x822C;&#x662F;8192K.</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// VM is a virtual machine that executes the bytecode compiled by Compiler.</span>
<span class="token keyword">type</span> VM <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    constants   <span class="token punctuation">[</span><span class="token punctuation">]</span>Object
    stack       <span class="token punctuation">[</span>StackSize<span class="token punctuation">]</span>Object
    sp          <span class="token builtin">int</span>
    globals     <span class="token punctuation">[</span><span class="token punctuation">]</span>Object
    fileSet     <span class="token operator">*</span>parser<span class="token punctuation">.</span>SourceFileSet
    frames      <span class="token punctuation">[</span>MaxFrames<span class="token punctuation">]</span>frame
    framesIndex <span class="token builtin">int</span>
    curFrame    <span class="token operator">*</span>frame
    curInsts    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    ip          <span class="token builtin">int</span>
    aborting    <span class="token builtin">int64</span>
    maxAllocs   <span class="token builtin">int64</span>
    allocs      <span class="token builtin">int64</span>
    err         <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token comment">//&#x4E3B;&#x8981;&#x9650;&#x5236;&#x5982;&#x4E0B;:</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
    <span class="token comment">// GlobalsSize is the maximum number of global variables for a VM.</span>
    GlobalsSize <span class="token operator">=</span> <span class="token number">1024</span>

    <span class="token comment">// StackSize is the maximum stack size for a VM.</span>
    StackSize <span class="token operator">=</span> <span class="token number">2048</span>

    <span class="token comment">// MaxFrames is the maximum number of function frames for a VM.</span>
    MaxFrames <span class="token operator">=</span> <span class="token number">1024</span>
<span class="token punctuation">)</span>
</code></pre>
<p>frame&#x7BA1;&#x72B6;&#x6001;&#x8BB0;&#x5F55;&#x7684;, &#x5B9A;&#x4E49;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// frame represents a function call frame.</span>
<span class="token keyword">type</span> frame <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    fn          <span class="token operator">*</span>CompiledFunction <span class="token comment">//CompiledFunction&#x4E5F;&#x662F;Object&#x5BF9;&#x8C61;, &#x4E3B;&#x8981;&#x5305;&#x62EC;&#x5BF9;&#x5E94;&#x7684;&#x5B57;&#x8282;&#x7801;</span>
    freeVars    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>ObjectPtr <span class="token comment">//ObjectPrt&#x662F;&#x6307;&#x5411;Object&#x7684;&#x7ED3;&#x6784;, &#x89C1;&#x4E0B;&#x9762;:</span>
    ip          <span class="token builtin">int</span>
    basePointer <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token comment">// CompiledFunction represents a compiled function.</span>
<span class="token keyword">type</span> CompiledFunction <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    ObjectImpl
    Instructions  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    NumLocals     <span class="token builtin">int</span> <span class="token comment">// number of local variables (including function parameters); &#x8FD9;&#x4E2A;&#x662F;&#x5728;&#x7F16;&#x8BD1;&#x9636;&#x6BB5;&#x5C31;&#x786E;&#x5B9A;&#x4E86;&#x7684;</span>
    NumParameters <span class="token builtin">int</span>
    VarArgs       <span class="token builtin">bool</span>
    SourceMap     <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span>parser<span class="token punctuation">.</span>Pos
    Free          <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>ObjectPtr <span class="token comment">//&#x6301;&#x6709;ObjectPtr&#x662F;&#x8981;&#x5E72;&#x4EC0;&#x4E48;&#x5462;? &#x53EF;&#x80FD;&#x662F;&quot;&#x5806;&quot;&#x53D8;&#x91CF;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ObjectPtr represents a free variable.</span>
<span class="token keyword">type</span> ObjectPtr <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    ObjectImpl
    Value <span class="token operator">*</span>Object
<span class="token punctuation">}</span>
</code></pre>
<h4 id="vm-new&#x51FD;&#x6570;"><a name="vm-new&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#vm-new&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>VM New&#x51FD;&#x6570;</h4>
<p>&#x4F20;&#x5165;&#x7684;globals&#x53EF;&#x4EE5;&#x5728;&#x591A;&#x4E2A;VM&#x4E2D;&#x5171;&#x4EAB;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// NewVM creates a VM.</span>
<span class="token keyword">func</span> <span class="token function">NewVM</span><span class="token punctuation">(</span>
    bytecode <span class="token operator">*</span>Bytecode<span class="token punctuation">,</span>
    globals <span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">,</span>
    maxAllocs <span class="token builtin">int64</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">*</span>VM <span class="token punctuation">{</span>
    <span class="token keyword">if</span> globals <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        globals <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">,</span> GlobalsSize<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    v <span class="token operator">:=</span> <span class="token operator">&amp;</span>VM<span class="token punctuation">{</span>
        constants<span class="token punctuation">:</span>   bytecode<span class="token punctuation">.</span>Constants<span class="token punctuation">,</span>
        sp<span class="token punctuation">:</span>          <span class="token number">0</span><span class="token punctuation">,</span>
        globals<span class="token punctuation">:</span>     globals<span class="token punctuation">,</span>
        fileSet<span class="token punctuation">:</span>     bytecode<span class="token punctuation">.</span>FileSet<span class="token punctuation">,</span>
        framesIndex<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        ip<span class="token punctuation">:</span>          <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        maxAllocs<span class="token punctuation">:</span>   maxAllocs<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    v<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fn <span class="token operator">=</span> bytecode<span class="token punctuation">.</span>MainFunction
    v<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ip <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    v<span class="token punctuation">.</span>curFrame <span class="token operator">=</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    v<span class="token punctuation">.</span>curInsts <span class="token operator">=</span> v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>Instructions
    <span class="token keyword">return</span> v
<span class="token punctuation">}</span>
</code></pre>
<p>VM&#x5728;run&#x9636;&#x6BB5;, &#x4F1A;&#x628A;&#x4EA7;&#x751F;&#x7684;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x653E;&#x5230;globals&#x4E2D;.</p>
<pre class="language-"><code class="lang-go">        <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpSetGlobal<span class="token punctuation">:</span>
            v<span class="token punctuation">.</span>ip <span class="token operator">+=</span> <span class="token number">2</span>
            v<span class="token punctuation">.</span>sp<span class="token operator">--</span>
            globalIndex <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span>
            v<span class="token punctuation">.</span>globals<span class="token punctuation">[</span>globalIndex<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span>
</code></pre>
<h4 id="vm-run&#x51FD;&#x6570;"><a name="vm-run&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#vm-run&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>VM Run&#x51FD;&#x6570;</h4>
<p>Script, Compiled&#x7684;Run, &#x6700;&#x540E;&#x90FD;&#x662F;&#x8C03;&#x7528;VM.Run();&#x5982;&#x679C;&#x53BB;&#x6389;&#x9519;&#x8BEF;&#x5904;&#x7406;, VM.Run()&#x662F;&#x4E0B;&#x9762;&#x7684;&#x6837;&#x5B50;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Run starts the execution.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// reset VM states</span>
    <span class="token comment">//VM&#x771F;&#x7684;&#x6709;sp, ip, frame&#x7B49;&#x64CD;&#x4F5C;</span>
    v<span class="token punctuation">.</span>sp <span class="token operator">=</span> <span class="token number">0</span>
    v<span class="token punctuation">.</span>curFrame <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    v<span class="token punctuation">.</span>curInsts <span class="token operator">=</span> v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>Instructions
    v<span class="token punctuation">.</span>framesIndex <span class="token operator">=</span> <span class="token number">1</span>
    v<span class="token punctuation">.</span>ip <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    v<span class="token punctuation">.</span>allocs <span class="token operator">=</span> v<span class="token punctuation">.</span>maxAllocs <span class="token operator">+</span> <span class="token number">1</span>

    <span class="token comment">//&#x91CD;&#x70B9;&#x662F;&#x8FD9;&#x4E2A;run&#x51FD;&#x6570;</span>
    v<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    atomic<span class="token punctuation">.</span><span class="token function">StoreInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v<span class="token punctuation">.</span>aborting<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    err <span class="token operator">=</span> v<span class="token punctuation">.</span>err
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
<p>VM.run()&#x662F;&#x771F;&#x6B63;&#x6267;&#x884C;&#x90E8;&#x5206;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v<span class="token punctuation">.</span>aborting<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span> <span class="token comment">//&#x5BF9;&#x5E94;VM Abort&#x6765;&#x505C;&#x6B62;</span>
        v<span class="token punctuation">.</span>ip<span class="token operator">++</span> <span class="token comment">//&#x5B57;&#x8282;&#x7801;&#x7684;&#x6267;&#x884C;&#x4F9D;&#x9760;ip&#x6307;&#x9488;&#x7684;&#x5411;&#x540E;&#x79FB;&#x52A8;</span>

        <span class="token keyword">switch</span> v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpConstant<span class="token punctuation">:</span>
            v<span class="token punctuation">.</span>ip <span class="token operator">+=</span> <span class="token number">2</span>
            cidx <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span>

            v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>constants<span class="token punctuation">[</span>cidx<span class="token punctuation">]</span>
            v<span class="token punctuation">.</span>sp<span class="token operator">++</span> <span class="token comment">//&#x6808;&#x5411;&#x4E0A;&#x589E;&#x957F;</span>
        <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpNull<span class="token punctuation">:</span>
            v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> UndefinedValue
            v<span class="token punctuation">.</span>sp<span class="token operator">++</span>
        <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpEqual<span class="token punctuation">:</span> 
            right <span class="token operator">:=</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">//&#x6240;&#x6709;&#x64CD;&#x4F5C;&#x6570;&#x90FD;&#x5728;&#x6808;&#x4E0A;</span>
            left <span class="token operator">:=</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>
            v<span class="token punctuation">.</span>sp <span class="token operator">-=</span> <span class="token number">2</span>
            <span class="token keyword">if</span> left<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> TrueValue
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> FalseValue
            <span class="token punctuation">}</span>
            v<span class="token punctuation">.</span>sp<span class="token operator">++</span>
        <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpPop<span class="token punctuation">:</span> <span class="token comment">//pop&#x64CD;&#x505A;&#x53EA;&#x662F;sp--</span>
            v<span class="token punctuation">.</span>sp<span class="token operator">--</span>

        <span class="token comment">//&#x91CD;&#x70B9;&#x770B;Call</span>
        <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpCall<span class="token punctuation">:</span>
            numArgs <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//&#x4E2A;&#x6570;&#x662F;ip+1&#x90A3;&#x4E2A;&#x5B57;&#x8282;</span>
            spread <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//spread&#x662F;&#x4E2A;&#x6807;&#x8BB0;</span>
            v<span class="token punctuation">.</span>ip <span class="token operator">+=</span> <span class="token number">2</span>

            value <span class="token operator">:=</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>numArgs<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>value<span class="token punctuation">.</span><span class="token function">CanCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//&#x770B;&#x8D77;&#x6765;&#x662F;callable&#x5BF9;&#x8C61;&#x5148;&#x4E8E;args&#x538B;&#x6808;; &#x6211;&#x611F;&#x89C9;&#x6808;&#x662F;&#x5411;&#x4E0A;&#x589E;&#x957F;&#x7684;.</span>
                v<span class="token punctuation">.</span>err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not callable: %s&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x53D8;&#x957F;</span>
            <span class="token keyword">if</span> spread <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
                v<span class="token punctuation">.</span>sp<span class="token operator">--</span>
                <span class="token keyword">switch</span> arr <span class="token operator">:=</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token operator">*</span>Array<span class="token punctuation">:</span>
                    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> arr<span class="token punctuation">.</span>Value <span class="token punctuation">{</span>
                        v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> item
                        v<span class="token punctuation">.</span>sp<span class="token operator">++</span>
                    <span class="token punctuation">}</span>
                    numArgs <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>Value<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
                <span class="token keyword">case</span> <span class="token operator">*</span>ImmutableArray<span class="token punctuation">:</span>
                    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> arr<span class="token punctuation">.</span>Value <span class="token punctuation">{</span>
                        v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> item
                        v<span class="token punctuation">.</span>sp<span class="token operator">++</span>
                    <span class="token punctuation">}</span>
                    numArgs <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>Value<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
                <span class="token keyword">default</span><span class="token punctuation">:</span>
                    v<span class="token punctuation">.</span>err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not an array: %s&quot;</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//CompiledFunction&#x7C7B;&#x578B;&#x7684;Object&#x5E76;&#x6CA1;&#x6709;&#x771F;&#x6B63;&#x7684;Call&#x5B9E;&#x73B0;</span>
            <span class="token keyword">if</span> callee<span class="token punctuation">,</span> ok <span class="token operator">:=</span> value<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>CompiledFunction<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
                <span class="token keyword">if</span> callee<span class="token punctuation">.</span>VarArgs <span class="token punctuation">{</span>
                    <span class="token comment">// if the closure is variadic,</span>
                    <span class="token comment">// roll up all variadic parameters into an array</span>
                    realArgs <span class="token operator">:=</span> callee<span class="token punctuation">.</span>NumParameters <span class="token operator">-</span> <span class="token number">1</span>
                    varArgs <span class="token operator">:=</span> numArgs <span class="token operator">-</span> realArgs
                    <span class="token keyword">if</span> varArgs <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                        numArgs <span class="token operator">=</span> realArgs <span class="token operator">+</span> <span class="token number">1</span>
                        args <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">,</span> varArgs<span class="token punctuation">)</span>
                        spStart <span class="token operator">:=</span> v<span class="token punctuation">.</span>sp <span class="token operator">-</span> varArgs
                        <span class="token keyword">for</span> i <span class="token operator">:=</span> spStart<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> v<span class="token punctuation">.</span>sp<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
                            args<span class="token punctuation">[</span>i<span class="token operator">-</span>spStart<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                        <span class="token punctuation">}</span>
                        v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>spStart<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>Array<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> args<span class="token punctuation">}</span>
                        v<span class="token punctuation">.</span>sp <span class="token operator">=</span> spStart <span class="token operator">+</span> <span class="token number">1</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> numArgs <span class="token operator">!=</span> callee<span class="token punctuation">.</span>NumParameters <span class="token punctuation">{</span> <span class="token comment">//&#x6709;&#x53C2;&#x6570;&#x4E2A;&#x6570;&#x5408;&#x6CD5;&#x6027;&#x68C0;&#x67E5;</span>
                    <span class="token keyword">if</span> callee<span class="token punctuation">.</span>VarArgs <span class="token punctuation">{</span>
                        v<span class="token punctuation">.</span>err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;wrong number of arguments: want&gt;=%d, got=%d&quot;</span><span class="token punctuation">,</span>
                            callee<span class="token punctuation">.</span>NumParameters<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> numArgs<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        v<span class="token punctuation">.</span>err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;wrong number of arguments: want=%d, got=%d&quot;</span><span class="token punctuation">,</span>
                            callee<span class="token punctuation">.</span>NumParameters<span class="token punctuation">,</span> numArgs<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// test if it&apos;s tail-call</span>
                <span class="token keyword">if</span> callee <span class="token operator">==</span> v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>fn <span class="token punctuation">{</span> <span class="token comment">// recursion</span>
                    nextOp <span class="token operator">:=</span> v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
                    <span class="token keyword">if</span> nextOp <span class="token operator">==</span> parser<span class="token punctuation">.</span>OpReturn <span class="token operator">||</span>
                        <span class="token punctuation">(</span>nextOp <span class="token operator">==</span> parser<span class="token punctuation">.</span>OpPop <span class="token operator">&amp;&amp;</span>
                            parser<span class="token punctuation">.</span>OpReturn <span class="token operator">==</span> v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">for</span> p <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> p <span class="token operator">&lt;</span> numArgs<span class="token punctuation">;</span> p<span class="token operator">++</span> <span class="token punctuation">{</span>
                            v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>basePointer<span class="token operator">+</span>p<span class="token punctuation">]</span> <span class="token operator">=</span>
                                v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span>numArgs<span class="token operator">+</span>p<span class="token punctuation">]</span>
                        <span class="token punctuation">}</span>
                        v<span class="token punctuation">.</span>sp <span class="token operator">-=</span> numArgs <span class="token operator">+</span> <span class="token number">1</span>
                        v<span class="token punctuation">.</span>ip <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">// reset IP to beginning of the frame</span>
                        <span class="token keyword">continue</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> v<span class="token punctuation">.</span>framesIndex <span class="token operator">&gt;=</span> MaxFrames <span class="token punctuation">{</span>
                    v<span class="token punctuation">.</span>err <span class="token operator">=</span> ErrStackOverflow
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//&#x4E0B;&#x9762;&#x975E;&#x5E38;&#x91CD;&#x8981;!!!!! &#x4E00;&#x4E2A;CompiledFunction&#x8FD0;&#x884C;&#x5728;&#x72EC;&#x7ACB;&#x7684;frame&#x91CC;, &#x5168;&#x90E8;&#x7684;frame&#x662F;&#x4E2A;1024&#x4E2A;&#x5927;&#x5C0F;&#x7684;frame&#x6570;&#x7EC4;.</span>
                <span class="token comment">// update call frame</span>
                <span class="token comment">//&#x8FDB;&#x5165;&#x4E0B;&#x4E00;&#x4E2A;&#x5FAA;&#x73AF;, switch v.curInsts[v.ip]</span>
                v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>ip <span class="token operator">=</span> v<span class="token punctuation">.</span>ip <span class="token comment">// store current ip before call</span>
                v<span class="token punctuation">.</span>curFrame <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>frames<span class="token punctuation">[</span>v<span class="token punctuation">.</span>framesIndex<span class="token punctuation">]</span><span class="token punctuation">)</span>
                v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>fn <span class="token operator">=</span> callee
                v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>freeVars <span class="token operator">=</span> callee<span class="token punctuation">.</span>Free
                v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>basePointer <span class="token operator">=</span> v<span class="token punctuation">.</span>sp <span class="token operator">-</span> numArgs
                v<span class="token punctuation">.</span>curInsts <span class="token operator">=</span> callee<span class="token punctuation">.</span>Instructions 
                v<span class="token punctuation">.</span>ip <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">//&#x4E0B;&#x4E2A;&#x5FAA;&#x73AF;&#x4E2D;, v.ip++&#x521A;&#x597D;&#x4E3A;0</span>
                v<span class="token punctuation">.</span>framesIndex<span class="token operator">++</span>
                v<span class="token punctuation">.</span>sp <span class="token operator">=</span> v<span class="token punctuation">.</span>sp <span class="token operator">-</span> numArgs <span class="token operator">+</span> callee<span class="token punctuation">.</span>NumLocals <span class="token comment">//&#x6CE8;&#x610F;&#x8FD9;&#x91CC;, sp&#x5E76;&#x6CA1;&#x6709;&#x72EC;&#x7ACB;&#x7684;&quot;frame&quot;. &#x8FD9;&#x91CC;&#x7684;NumLocals&#x662F;&#x5305;&#x62EC;&#x4E86;&#x53C2;&#x6570;&#x4E2A;&#x6570;&#x7684;:number of local variables (including function parameters)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//&#x96BE;&#x9053;else&#x5BF9;&#x5E94;&#x7528;&#x6237;&#x81EA;&#x5B9A;&#x4E49;&#x51FD;&#x6570;?</span>
                <span class="token keyword">var</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span>Object
                args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span>numArgs<span class="token punctuation">:</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
                ret<span class="token punctuation">,</span> e <span class="token operator">:=</span> value<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>args<span class="token operator">...</span><span class="token punctuation">)</span>
                v<span class="token punctuation">.</span>sp <span class="token operator">-=</span> numArgs <span class="token operator">+</span> <span class="token number">1</span>

                <span class="token comment">// runtime error</span>
                <span class="token keyword">if</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> e <span class="token operator">==</span> ErrWrongNumArguments <span class="token punctuation">{</span>
                        v<span class="token punctuation">.</span>err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;wrong number of arguments in call to &apos;%s&apos;&quot;</span><span class="token punctuation">,</span>
                            value<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> e<span class="token punctuation">,</span> ok <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token punctuation">(</span>ErrInvalidArgumentType<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
                        v<span class="token punctuation">.</span>err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;invalid type for argument &apos;%s&apos; in call to &apos;%s&apos;: &quot;</span><span class="token operator">+</span>
                                <span class="token string">&quot;expected %s, found %s&quot;</span><span class="token punctuation">,</span>
                            e<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Expected<span class="token punctuation">,</span> e<span class="token punctuation">.</span>Found<span class="token punctuation">)</span>
                        <span class="token keyword">return</span>
                    <span class="token punctuation">}</span>
                    v<span class="token punctuation">.</span>err <span class="token operator">=</span> e
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// nil return -&gt; undefined</span>
                <span class="token keyword">if</span> ret <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    ret <span class="token operator">=</span> UndefinedValue
                <span class="token punctuation">}</span>
                v<span class="token punctuation">.</span>allocs<span class="token operator">--</span>
                <span class="token keyword">if</span> v<span class="token punctuation">.</span>allocs <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                    v<span class="token punctuation">.</span>err <span class="token operator">=</span> ErrObjectAllocLimit
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
                v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> ret
                v<span class="token punctuation">.</span>sp<span class="token operator">++</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//&#x8FD9;&#x4E2A;frame return</span>
        <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpReturn<span class="token punctuation">:</span>
            v<span class="token punctuation">.</span>ip<span class="token operator">++</span>
            <span class="token keyword">var</span> retVal Object
            <span class="token keyword">if</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span> <span class="token comment">//&#x6709;return &#x503C;</span>
                retVal <span class="token operator">=</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                retVal <span class="token operator">=</span> UndefinedValue <span class="token comment">// &#x6CA1;&#x6709;return&#x9ED8;&#x8BA4;return UndefinedValue</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//v.sp--</span>
            v<span class="token punctuation">.</span>framesIndex<span class="token operator">--</span> <span class="token comment">//&#x64A4;&#x9500;&#x8FD9;&#x4E2A;frame, &#x4E0B;&#x9762;&#x51E0;&#x53E5;&#x8FD8;&#x539F;&#x4E0A;&#x4E00;&#x4E2A;frame&#x7684;&#x73B0;&#x573A;</span>
            v<span class="token punctuation">.</span>curFrame <span class="token operator">=</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>frames<span class="token punctuation">[</span>v<span class="token punctuation">.</span>framesIndex<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            v<span class="token punctuation">.</span>curInsts <span class="token operator">=</span> v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>Instructions
            v<span class="token punctuation">.</span>ip <span class="token operator">=</span> v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>ip
            <span class="token comment">//v.sp = lastFrame.basePointer - 1</span>
            v<span class="token punctuation">.</span>sp <span class="token operator">=</span> v<span class="token punctuation">.</span>frames<span class="token punctuation">[</span>v<span class="token punctuation">.</span>framesIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>basePointer
            <span class="token comment">// skip stack overflow check because (newSP) &lt;= (oldSP)</span>
            v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> retVal <span class="token comment">//&#x8FD4;&#x56DE;&#x503C;&#x4F7F;&#x7528;&#x6808;&#x8F6C;&#x9012;</span>
            <span class="token comment">//v.sp++</span>

        <span class="token comment">//Jump&#x6307;&#x4EE4;&#x7684;&#x5904;&#x7406;: &#x4ECE;curInsts&#x53D6;&#x51FA;pos, v.ip=pos-1</span>
        <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpOrJump<span class="token punctuation">:</span>
            v<span class="token punctuation">.</span>ip <span class="token operator">+=</span> <span class="token number">2</span>
            <span class="token keyword">if</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">IsFalsy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//&#x6BCF;&#x79CD;&#x5BF9;&#x8C61;&#x7C7B;&#x578B;&#x90FD;&#x6709;isFalsy()&#x65B9;&#x6CD5;</span>
                v<span class="token punctuation">.</span>sp<span class="token operator">--</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                pos <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span>
                v<span class="token punctuation">.</span>ip <span class="token operator">=</span> pos <span class="token operator">-</span> <span class="token number">1</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpJump<span class="token punctuation">:</span>
            pos <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span>
            v<span class="token punctuation">.</span>ip <span class="token operator">=</span> pos <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Abort&#x7528;atomic&#x5199;&#x5165;v.aborting</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Abort aborts the execution.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    atomic<span class="token punctuation">.</span><span class="token function">StoreInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v<span class="token punctuation">.</span>aborting<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4E0B;&#x9762;&#x7684;&#x51E0;&#x4E2A;&#x64CD;&#x4F5C;&#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B;? &#x4F7F;&#x7528;&#x573A;&#x666F;&#x662F;&#x4EC0;&#x4E48;? &#x6808;&#x53D8;&#x91CF;? &#x5806;&#x53D8;&#x91CF;? </p>
<pre class="language-"><code class="lang-go">    OpDefineLocal                 <span class="token comment">// Define local variable</span>
    OpSetSelLocal                 <span class="token comment">// Set local variable using selectors</span>
    OpGetFreePtr                  <span class="token comment">// Get free variable pointer object</span>
    OpGetFree                     <span class="token comment">// Get free variables</span>
    OpSetFree                     <span class="token comment">// Set free variables</span>
    OpGetLocalPtr                 <span class="token comment">// Get local variable as a pointer</span>
</code></pre>
<p>&#x7C97;&#x770B;&#x4E0B;&#x6765;, &#x6211;&#x611F;&#x89C9;&#x53D8;&#x91CF;&#x7684;&#x7B2C;&#x4E00;&#x4F7F;&#x7528;&#x73B0;&#x573A;&#x90FD;&#x662F;&#x5728;<code>stack       [StackSize]Object</code>, &#x867D;&#x7136;&#x8FD9;&#x91CC;&#x53EB;stack, &#x4F46;&#x5B9E;&#x9645;&#x662F;<code>Object</code>&#x7684;&#x8FD0;&#x52A8;&#x573A;, &quot;&#x5806;&quot;&#x53D8;&#x91CF;&#x4E5F;&#x4FDD;&#x5B58;&#x5728;&#x8FD9;&#x91CC;. &#x90A3;&#x6709;&#x4EBA;&#x8981;&#x95EE;&#x4E86;, &#x660E;&#x660E;&#x770B;&#x5230;&#x8FD9;&#x4E2A;stack&#x6709;sp, &#x800C;&#x4E14;sp&#x4F1A;&#x4E0A;&#x4E0B;&#x6D6E;&#x52A8;. &#x5982;&#x679C;&#x5F53;&#x7136;frame&#x7684;&#x5806;&#x53D8;&#x91CF;&#x4FDD;&#x5B58;&#x5728;&#x6B64;, &#x90A3;sp&quot;&#x56DE;&#x9000;&quot;&#x5230;&#x4E0A;&#x4E2A;frame&#x600E;&#x4E48;&#x529E;?
&#x611F;&#x89C9;<code>OpGetFree</code>&#x548C;<code>OpSetFree</code>&#x5C31;&#x662F;&#x6765;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x7684;</p>
<pre class="language-"><code class="lang-go">        <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpGetFree<span class="token punctuation">:</span>
            v<span class="token punctuation">.</span>ip<span class="token operator">++</span>
            freeIndex <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token punctuation">]</span><span class="token punctuation">)</span>
            val <span class="token operator">:=</span> <span class="token operator">*</span>v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>freeVars<span class="token punctuation">[</span>freeIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>Value
            v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> val
            v<span class="token punctuation">.</span>sp<span class="token operator">++</span>
        <span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpSetFree<span class="token punctuation">:</span>
            v<span class="token punctuation">.</span>ip<span class="token operator">++</span>
            freeIndex <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>curInsts<span class="token punctuation">[</span>v<span class="token punctuation">.</span>ip<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token operator">*</span>v<span class="token punctuation">.</span>curFrame<span class="token punctuation">.</span>freeVars<span class="token punctuation">[</span>freeIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>Value <span class="token operator">=</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            v<span class="token punctuation">.</span>sp<span class="token operator">--</span>
</code></pre>
<ul>
<li><code>OpGetFree</code>&#x4ECE;<code>v.curFrame.freeVars</code>&#x8FD9;&#x4E2A;map&#x91CC;&#x5F97;&#x5230;&#x503C;, &#x653E;&#x5230;<code>v.stack[v.sp]</code>&#x4E2D;</li>
<li><code>OpSetFree</code>&#x76F8;&#x53CD;, &#x628A;&#x6808;&#x53D8;&#x91CF;&#x653E;&#x5230;frame&#x7684;freeVars&#x4E2D;.</li>
<li>&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x90FD;&#x662F;&#x503C;&#x62F7;&#x8D1D;.</li>
</ul>
<p>&#x5373;: &#x53D8;&#x91CF;&#x90FD;&#x662F;&#x5728;stack&#x8FD0;&#x52A8;&#x573A;&#x4E0A;&#x53C2;&#x4E0E;&#x8FD0;&#x52A8;(CPU&#x8BA1;&#x7B97;), &#x53D8;&#x91CF;&#x9000;&#x573A;&#x7684;&#x65F6;&#x5019;, &#x5176;&#x503C;&#x88AB;&#x62F7;&#x8D1D;(<strong>&#x503C;&#x62F7;&#x8D1D;</strong>)&#x5230;&#x5F53;&#x524D;&#x4F11;&#x606F;&#x533A;<code>curFrame.freeVars</code>; &#x7B49;&#x4E0B;&#x6B21;&#x8F6E;&#x5230;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x4E0A;&#x573A;&#x7684;&#x65F6;&#x5019;, &#x518D;&#x6B21;&#x503C;&#x62F7;&#x8D1D;&#x5230;&#x8FD0;&#x52A8;&#x573A;(stack). 
&#x524D;&#x9762;&#x8BF4;&#x8FC7;, callee&#x51FD;&#x6570;&#x4E5F;&#x662F;&#x505A;&#x4E3A;&#x4E00;&#x4E2A;Object&#x88AB;&#x653E;&#x5230;stack&#x4E0A;&#x7684;, &#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x7684;stack&#x5E76;&#x4E0D;&#x662F;&#x5B8C;&#x5168;&#x7684;C&#x7684;&quot;&#x6808;&quot;&#x7684;&#x6982;&#x5FF5;. &#x5E94;&#x8BE5;&#x8BF4;&#x662F;&#x5BF9;&#x8C61;&#x7684;&#x8FD0;&#x52A8;&#x573A;/&#x8BAD;&#x7EC3;&#x573A;&#x66F4;&#x5408;&#x9002;.</p>
<h4 id="vmrun&#x603B;&#x7ED3;"><a name="vmrun&#x603B;&#x7ED3;" class="anchor-navigation-ex-anchor" href="#vmrun&#x603B;&#x7ED3;"><i class="fa fa-link" aria-hidden="true"></i></a>vm.run&#x603B;&#x7ED3;</h4>
<ul>
<li>ip&#x662F;&#x5B57;&#x8282;&#x7801;&#x7684;&quot;pc&quot;&#x6307;&#x9488;, op&#x548C;op&#x7684;&#x64CD;&#x4F5C;&#x6307;&#x4EE4;&#x653E;&#x5728;&#x5B57;&#x8282;&#x7801;&#x91CC;</li>
<li>sp&#x5411;&#x4E0A;&#x589E;&#x957F;, op&#x7684;&#x64CD;&#x4F5C;&#x6570;&#x653E;&#x5728;&#x6808;&#x4E0A;. 
&#x6BD4;&#x5982; &#x5224;&#x65AD;&#x5DE6;&#x53F3;&#x4E24;&#x4E2A;&#x64CD;&#x4F5C;&#x6570;&#x76F8;&#x7B49;, &#x5DE6;&#x53F3;&#x4E24;&#x4E2A;&#x64CD;&#x4F5C;&#x6570;&#x90FD;&#x5728;&#x6808;&#x4E0A;, &#x51FA;&#x6808;&#x540E;&#x5224;&#x65AD;&#x662F;&#x5426;&#x76F8;&#x7B49;, &#x5E76;&#x628A;&#x7ED3;&#x679C;&#x538B;&#x6808;.<pre class="language-"><code class="lang-go"><span class="token keyword">case</span> parser<span class="token punctuation">.</span>OpEqual<span class="token punctuation">:</span>
          right <span class="token operator">:=</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
          left <span class="token operator">:=</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>
          v<span class="token punctuation">.</span>sp <span class="token operator">-=</span> <span class="token number">2</span>
          <span class="token keyword">if</span> left<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> TrueValue
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>sp<span class="token punctuation">]</span> <span class="token operator">=</span> FalseValue
          <span class="token punctuation">}</span>
          v<span class="token punctuation">.</span>sp<span class="token operator">++</span>
</code></pre>
</li>
</ul>
<h3 id="stdlibfunctypedefsgo"><a name="stdlibfunctypedefsgo" class="anchor-navigation-ex-anchor" href="#stdlibfunctypedefsgo"><i class="fa fa-link" aria-hidden="true"></i></a>5.4.16. stdlib/func_typedefs.go</h3>
<p>&#x63D0;&#x4F9B;&#x4E86;go&#x7684;&#x51FD;&#x6570;&#x7B7E;&#x540D;&#x5230;tengo callable&#x5BF9;&#x8C61;&#x7684;&#x5305;&#x88C5;&#x51FD;&#x6570;:
&#x6BD4;&#x5982;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// FuncARI transform a function of &apos;func() int&apos; signature into CallableFunc</span>
<span class="token comment">// type.</span>
<span class="token keyword">func</span> <span class="token function">FuncARI</span><span class="token punctuation">(</span>fn <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span><span class="token punctuation">)</span> tengo<span class="token punctuation">.</span>CallableFunc <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>args <span class="token operator">...</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>ret tengo<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> tengo<span class="token punctuation">.</span>ErrWrongNumArguments
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="tengo&#x7684;&#x540E;&#x7EE7;"><a name="tengo&#x7684;&#x540E;&#x7EE7;" class="anchor-navigation-ex-anchor" href="#tengo&#x7684;&#x540E;&#x7EE7;"><i class="fa fa-link" aria-hidden="true"></i></a>6. tengo&#x7684;&#x540E;&#x7EE7;</h1>
<p><a href="https://github.com/ozanh/ugo" target="_blank">https://github.com/ozanh/ugo</a>
tengo&#x7684;v2&#x7248;&#x672C;&#x5904;&#x4E8E;&#x7EF4;&#x62A4;&#x72B6;&#x6001;. 
tengo&#x7684;&#x4E00;&#x4E2A;contributor&#x81EA;&#x5DF1;&#x4E5F;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C;&#x7684;&#x89E3;&#x91CA;&#x5668;: ugo</p>
<h1 id="tengo"><a name="tengo" class="anchor-navigation-ex-anchor" href="#tengo"><i class="fa fa-link" aria-hidden="true"></i></a>7. tengo</h1>
<p><a href="https://github.com/d5/tengo" target="_blank">https://github.com/d5/tengo</a>
<a href="https://www.reddit.com/r/golang/comments/ah53md/tengo_an_embeddable_script_language_for_go/" target="_blank">Reddit&#x8BA8;&#x8BBA;&#x5728;&#x6B64;</a></p>
<ul>
<li>tengo&#x4F3C;&#x4E4E;&#x662F;&#x4E2A;VM&#x6A21;&#x5F0F;&#x7684;&#x89E3;&#x91CA;&#x8BED;&#x8A00;.</li>
<li>&#x8BED;&#x6CD5;&#x548C;go&#x975E;&#x5E38;&#x76F8;&#x8FD1;, &#x6027;&#x80FD;&#x4F3C;&#x4E4E;&#x4E0D;&#x9519;:</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>fib(35)</th>
<th>fibt(35)</th>
<th>Language (Type)</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/d5/tengo" target="_blank"><strong>Tengo</strong></a></td>
<td><code>2,931ms</code></td>
<td><code>4ms</code></td>
<td>Tengo (VM)</td>
</tr>
<tr>
<td><a href="https://github.com/Shopify/go-lua" target="_blank">go-lua</a></td>
<td><code>4,824ms</code></td>
<td><code>4ms</code></td>
<td>Lua (VM)</td>
</tr>
<tr>
<td><a href="https://github.com/yuin/gopher-lua" target="_blank">GopherLua</a></td>
<td><code>5,365ms</code></td>
<td><code>4ms</code></td>
<td>Lua (VM)</td>
</tr>
<tr>
<td><a href="https://github.com/dop251/goja" target="_blank">goja</a></td>
<td><code>5,533ms</code></td>
<td><code>5ms</code></td>
<td>JavaScript (VM)</td>
</tr>
<tr>
<td><a href="https://github.com/google/starlark-go" target="_blank">starlark-go</a></td>
<td><code>11,495ms</code></td>
<td><code>5ms</code></td>
<td>Starlark (Interpreter)</td>
</tr>
<tr>
<td><a href="https://github.com/containous/yaegi" target="_blank">Yaegi</a></td>
<td><code>15,645ms</code></td>
<td><code>12ms</code></td>
<td>Yaegi (Interpreter)</td>
</tr>
<tr>
<td><a href="https://github.com/go-python/gpython" target="_blank">gpython</a></td>
<td><code>16,322ms</code></td>
<td><code>5ms</code></td>
<td>Python (Interpreter)</td>
</tr>
<tr>
<td><a href="https://github.com/robertkrimen/otto" target="_blank">otto</a></td>
<td><code>73,093ms</code></td>
<td><code>10ms</code></td>
<td>JavaScript (Interpreter)</td>
</tr>
<tr>
<td><a href="https://github.com/mattn/anko" target="_blank">Anko</a></td>
<td><code>79,809ms</code></td>
<td><code>8ms</code></td>
<td>Anko (Interpreter)</td>
</tr>
<tr>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Go</td>
<td><code>53ms</code></td>
<td><code>3ms</code></td>
<td>Go (Native)</td>
</tr>
<tr>
<td>Lua</td>
<td><code>1,612ms</code></td>
<td><code>3ms</code></td>
<td>Lua (Native)</td>
</tr>
<tr>
<td>Python</td>
<td><code>2,632ms</code></td>
<td><code>23ms</code></td>
<td>Python 2 (Native)</td>
</tr>
</tbody>
</table>
<ul>
<li>&#x7F16;&#x8BD1;&#x51FA;&#x6765;size&#x4E5F;&#x5F88;&#x5C0F;, 4.8M.</li>
<li>&#x6CA1;&#x6709;&#x5916;&#x90E8;package&#x5F15;&#x7528;, &#x6CA1;&#x6709;cgo</li>
<li>&#x88AB;&#x8BBE;&#x8BA1;&#x6210;&#x7C7B;&#x4F3C;lua&#x7684;&#x88AB;&#x5D4C;&#x5165;&#x7684;&#x8BED;&#x8A00;. -- &#x66F4;&#x5BB9;&#x6613;&#x96C6;&#x6210;</li>
<li>&#x4F3C;&#x4E4E;&#x6269;&#x5C55;&#x6027;&#x4E0D;&#x9519;. -- &#x6709;&#x5E93;&#x7684;&#x6982;&#x5FF5;. &#x5E93;&#x662F;go&#x8BED;&#x8A00;&#x5199;&#x7684;</li>
<li>github 2.1k&#x4E2A;&#x661F;</li>
</ul>
<h2 id="&#x5165;&#x95E8;"><a name="&#x5165;&#x95E8;" class="anchor-navigation-ex-anchor" href="#&#x5165;&#x95E8;"><i class="fa fa-link" aria-hidden="true"></i></a>7.1. &#x5165;&#x95E8;</h2>
<p>a b c d&#x56DB;&#x4E2A;&#x53D8;&#x91CF;&#x6C42;&#x548C;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;context&quot;</span>
    <span class="token string">&quot;fmt&quot;</span>

    <span class="token string">&quot;github.com/d5/tengo/v2&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Tengo script code</span>
    src <span class="token operator">:=</span> <span class="token string">`
each := func(seq, fn) {
    for x in seq { fn(x) }
}

sum := 0
mul := 1
each([a, b, c, d], func(x) {
    sum += x
    mul *= x
})`</span>

    <span class="token comment">// create a new Script instance</span>
    script <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewScript</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// set values</span>
    <span class="token boolean">_</span> <span class="token operator">=</span> script<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token boolean">_</span> <span class="token operator">=</span> script<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
    <span class="token boolean">_</span> <span class="token operator">=</span> script<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
    <span class="token boolean">_</span> <span class="token operator">=</span> script<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

    <span class="token comment">// run the script</span>
    compiled<span class="token punctuation">,</span> err <span class="token operator">:=</span> script<span class="token punctuation">.</span><span class="token function">RunContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// retrieve values</span>
    sum <span class="token operator">:=</span> compiled<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;sum&quot;</span><span class="token punctuation">)</span>
    mul <span class="token operator">:=</span> compiled<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;mul&quot;</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>sum<span class="token punctuation">,</span> mul<span class="token punctuation">)</span> <span class="token comment">// &quot;22 288&quot;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x8BED;&#x6CD5;"><a name="&#x8BED;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#&#x8BED;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>7.2. &#x8BED;&#x6CD5;</h2>
<h3 id="token"><a name="token" class="anchor-navigation-ex-anchor" href="#token"><i class="fa fa-link" aria-hidden="true"></i></a>7.2.1. token</h3>
<p>&#x6709;&#x51E0;&#x4E2A;token&#x503C;&#x5F97;&#x6CE8;&#x610F;:</p>
<pre class="language-"><code class="lang-go">    Ellipsis<span class="token punctuation">:</span>     <span class="token string">&quot;...&quot;</span><span class="token punctuation">,</span>
    Func<span class="token punctuation">:</span>         <span class="token string">&quot;func&quot;</span><span class="token punctuation">,</span>
    Error<span class="token punctuation">:</span>        <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span>
    Immutable<span class="token punctuation">:</span>    <span class="token string">&quot;immutable&quot;</span><span class="token punctuation">,</span>
    Export<span class="token punctuation">:</span>       <span class="token string">&quot;export&quot;</span><span class="token punctuation">,</span>
    True<span class="token punctuation">:</span>         <span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span>
    False<span class="token punctuation">:</span>        <span class="token string">&quot;false&quot;</span><span class="token punctuation">,</span>
    In<span class="token punctuation">:</span>           <span class="token string">&quot;in&quot;</span><span class="token punctuation">,</span>
    Undefined<span class="token punctuation">:</span>    <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">,</span>
    Import<span class="token punctuation">:</span>       <span class="token string">&quot;import&quot;</span><span class="token punctuation">,</span>
</code></pre>
<p>&#x6BD4;&#x5982;<code>... error immutable undefined export import</code>&#x90FD;&#x662F;&#x5173;&#x952E;&#x8BCD;</p>
<h2 id="&#x4E00;&#x4E2A;go&#x8C03;&#x811A;&#x672C;&#x7684;&#x4F8B;&#x5B50;"><a name="&#x4E00;&#x4E2A;go&#x8C03;&#x811A;&#x672C;&#x7684;&#x4F8B;&#x5B50;" class="anchor-navigation-ex-anchor" href="#&#x4E00;&#x4E2A;go&#x8C03;&#x811A;&#x672C;&#x7684;&#x4F8B;&#x5B50;"><i class="fa fa-link" aria-hidden="true"></i></a>7.3. &#x4E00;&#x4E2A;go&#x8C03;&#x811A;&#x672C;&#x7684;&#x4F8B;&#x5B50;</h2>
<pre class="language-"><code class="lang-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;log&quot;</span>

    <span class="token string">&quot;github.com/d5/tengo/v2&quot;</span>
    <span class="token string">&quot;github.com/d5/tengo/v2/stdlib&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    src <span class="token operator">:=</span> <span class="token string">`
text := import(&quot;text&quot;)

m := {
    contains: func(args) {
        return text.contains(args.str, args.substr)
    }
}
out := undefined
if f := m[argsMap.function]; !is_undefined(f) {
    out = f(argsMap)
} else {
    out = error(&quot;unknown function&quot;)
}
`</span>
    script <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewScript</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span>
    script<span class="token punctuation">.</span><span class="token function">SetImports</span><span class="token punctuation">(</span>stdlib<span class="token punctuation">.</span><span class="token function">GetModuleMap</span><span class="token punctuation">(</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    argsMap <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token string">&quot;function&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;contains&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;str&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;foo bar&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;substr&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> script<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;argsMap&quot;</span><span class="token punctuation">,</span> argsMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    c<span class="token punctuation">,</span> err <span class="token operator">:=</span> script<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    out <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;out&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> out<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// If it returns a dynamic type use type switch using out.Value()</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;result =&quot;</span><span class="token punctuation">,</span> out<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x6240;&#x6709;&#x90FD;&#x662F;&#x503C;&#x7C7B;&#x578B;"><a name="&#x6240;&#x6709;&#x90FD;&#x662F;&#x503C;&#x7C7B;&#x578B;" class="anchor-navigation-ex-anchor" href="#&#x6240;&#x6709;&#x90FD;&#x662F;&#x503C;&#x7C7B;&#x578B;"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.1. &#x6240;&#x6709;&#x90FD;&#x662F;&#x503C;&#x7C7B;&#x578B;</h3>
<pre class="language-"><code class="lang-go"><span class="token number">19</span> <span class="token operator">+</span> <span class="token number">84</span>               <span class="token comment">// int values</span>
<span class="token string">&quot;aomame&quot;</span> <span class="token operator">+</span> <span class="token string">`kawa`</span>     <span class="token comment">// string values</span>
<span class="token operator">-</span><span class="token number">9.22</span> <span class="token operator">+</span> <span class="token number">1e10</span>          <span class="token comment">// float values</span>
<span class="token boolean">true</span> <span class="token operator">||</span> <span class="token boolean">false</span>         <span class="token comment">// bool values</span>
<span class="token char">&apos;&#x4E5D;&apos;</span> <span class="token operator">&gt;</span> <span class="token char">&apos;9&apos;</span>            <span class="token comment">// char values</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">]</span>     <span class="token comment">// array value</span>
<span class="token punctuation">{</span>a<span class="token punctuation">:</span> <span class="token number">12.34</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">}</span>  <span class="token comment">// map value</span>
<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/*...*/</span> <span class="token punctuation">}</span>    <span class="token comment">// function value</span>
</code></pre>
<h3 id="tengo&#x503C;&#x7C7B;&#x578B;&#x548C;go&#x7C7B;&#x578B;"><a name="tengo&#x503C;&#x7C7B;&#x578B;&#x548C;go&#x7C7B;&#x578B;" class="anchor-navigation-ex-anchor" href="#tengo&#x503C;&#x7C7B;&#x578B;&#x548C;go&#x7C7B;&#x578B;"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.2. tengo&#x503C;&#x7C7B;&#x578B;&#x548C;go&#x7C7B;&#x578B;</h3>
<table>
<thead>
<tr>
<th style="text-align:center">Tengo Type</th>
<th style="text-align:center">Description</th>
<th style="text-align:center">Equivalent Type in Go</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">int</td>
<td style="text-align:center">signed 64-bit integer value</td>
<td style="text-align:center"><code>int64</code></td>
</tr>
<tr>
<td style="text-align:center">float</td>
<td style="text-align:center">64-bit floating point value</td>
<td style="text-align:center"><code>float64</code></td>
</tr>
<tr>
<td style="text-align:center">bool</td>
<td style="text-align:center">boolean value</td>
<td style="text-align:center"><code>bool</code></td>
</tr>
<tr>
<td style="text-align:center">char</td>
<td style="text-align:center">unicode character</td>
<td style="text-align:center"><code>rune</code></td>
</tr>
<tr>
<td style="text-align:center">string</td>
<td style="text-align:center">unicode string</td>
<td style="text-align:center"><code>string</code></td>
</tr>
<tr>
<td style="text-align:center">bytes</td>
<td style="text-align:center">byte array</td>
<td style="text-align:center"><code>[]byte</code></td>
</tr>
<tr>
<td style="text-align:center">error</td>
<td style="text-align:center"><a href="https://github.com/d5/tengo/blob/master/docs/tutorial.md#error-values" target="_blank">error</a> value</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">time</td>
<td style="text-align:center">time value</td>
<td style="text-align:center"><code>time.Time</code></td>
</tr>
<tr>
<td style="text-align:center">array</td>
<td style="text-align:center">value array <em>(mutable)</em></td>
<td style="text-align:center"><code>[]interface{}</code></td>
</tr>
<tr>
<td style="text-align:center">immutable array</td>
<td style="text-align:center"><a href="https://github.com/d5/tengo/blob/master/docs/tutorial.md#immutable-values" target="_blank">immutable</a> array</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">map</td>
<td style="text-align:center">value map with string keys <em>(mutable)</em></td>
<td style="text-align:center"><code>map[string]interface{}</code></td>
</tr>
<tr>
<td style="text-align:center">immutable map</td>
<td style="text-align:center"><a href="https://github.com/d5/tengo/blob/master/docs/tutorial.md#immutable-values" target="_blank">immutable</a> map</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">undefined</td>
<td style="text-align:center"><a href="https://github.com/d5/tengo/blob/master/docs/tutorial.md#undefined-values" target="_blank">undefined</a> value</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">function</td>
<td style="text-align:center"><a href="https://github.com/d5/tengo/blob/master/docs/tutorial.md#function-values" target="_blank">function</a> value</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center"><em>user-defined</em></td>
<td style="text-align:center">value of <a href="https://github.com/d5/tengo/blob/master/docs/objects.md" target="_blank">user-defined types</a></td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<h3 id="error&#x5347;&#x7EA7;&#x4E3A;&#x4E00;&#x7B49;&#x7C7B;&#x578B;"><a name="error&#x5347;&#x7EA7;&#x4E3A;&#x4E00;&#x7B49;&#x7C7B;&#x578B;" class="anchor-navigation-ex-anchor" href="#error&#x5347;&#x7EA7;&#x4E3A;&#x4E00;&#x7B49;&#x7C7B;&#x578B;"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.3. error&#x5347;&#x7EA7;&#x4E3A;&#x4E00;&#x7B49;&#x7C7B;&#x578B;</h3>
<pre class="language-"><code class="lang-go">err1 <span class="token operator">:=</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;oops&quot;</span><span class="token punctuation">)</span>    <span class="token comment">// error with string value</span>
err2 <span class="token operator">:=</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span>     <span class="token comment">// error with int value</span>
<span class="token keyword">if</span> <span class="token function">is_error</span><span class="token punctuation">(</span>err1<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// &apos;is_error&apos; builtin function</span>
  err_val <span class="token operator">:=</span> err1<span class="token punctuation">.</span>value  <span class="token comment">// get underlying value</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x503C;&#x4E0D;&#x53EF;&#x53D8;"><a name="&#x503C;&#x4E0D;&#x53EF;&#x53D8;" class="anchor-navigation-ex-anchor" href="#&#x503C;&#x4E0D;&#x53EF;&#x53D8;"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.4. &#x503C;&#x4E0D;&#x53EF;&#x53D8;</h3>
<p>&#x9664;&#x4E86;map&#x548C;array, &#x5176;&#x4ED6;&#x7C7B;&#x578B;&#x7684;&#x503C;&#x4E0D;&#x80FD;&#x6539;&#x53D8;</p>
<pre class="language-"><code class="lang-go">s <span class="token operator">:=</span> <span class="token string">&quot;12345&quot;</span>
s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">&apos;b&apos;</span>    <span class="token comment">// illegal: String is immutable</span>

a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;two&quot;</span>  <span class="token comment">// ok: a is now [1, &quot;two&quot;, 3]</span>
</code></pre>
<p>&#x7528;immutable&#x5173;&#x952E;&#x8BCD;&#x53EF;&#x4EE5;&#x628A;map&#x548C;array&#x4E5F;&#x8BBE;&#x6210;&#x4E0D;&#x53EF;&#x53D8;</p>
<pre class="language-"><code class="lang-go">b <span class="token operator">:=</span> <span class="token function">immutable</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;foo&quot;</span>  <span class="token comment">// illegal: &apos;b&apos; references to an immutable array.</span>
</code></pre>
<p>&#x6CE8;&#x610F;, &#x91CD;&#x65B0;&#x8D4B;&#x503C;&#x548C;immutabiltiy&#x6CA1;&#x6709;&#x5173;&#x7CFB;: &#x5BF9;&#x53D8;&#x91CF;&#x91CD;&#x65B0;&#x8D4B;&#x503C;&#x6C38;&#x8FDC;&#x90FD;&#x662F;&#x53EF;&#x4EE5;&#x7684;</p>
<pre class="language-"><code class="lang-go">s <span class="token operator">:=</span> <span class="token string">&quot;abc&quot;</span>
s <span class="token operator">=</span> <span class="token string">&quot;foo&quot;</span>                  <span class="token comment">// ok</span>
a <span class="token operator">:=</span> <span class="token function">immutable</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
a <span class="token operator">=</span> <span class="token boolean">false</span>                  <span class="token comment">// ok</span>
</code></pre>
<p>immutable&#x6539;&#x53D8;&#x53EA;&#x662F;&#x5F53;&#x524D;&#x53D8;&#x91CF;&#x5C5E;&#x6027;, &#x5BF9;map/array&#x91CC;&#x7684;&#x5143;&#x7D20;&#x6CA1;&#x6709;&#x7EA6;&#x675F;</p>
<pre class="language-"><code class="lang-go">a <span class="token operator">:=</span> <span class="token function">immutable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>b<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> c<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
a<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">5</span>        <span class="token comment">// illegal</span>
a<span class="token punctuation">.</span>c<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span>     <span class="token comment">// ok: because &apos;a.c&apos; is not immutable</span>

a <span class="token operator">=</span> <span class="token function">immutable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>b<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> c<span class="token punctuation">:</span> <span class="token function">immutable</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
a<span class="token punctuation">.</span>c<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span>     <span class="token comment">// illegal</span>
</code></pre>
<h3 id="&#x672A;&#x5B9A;&#x4E49;&#x4E5F;&#x662F;&#x4E00;&#x79CD;&#x7C7B;&#x578B;"><a name="&#x672A;&#x5B9A;&#x4E49;&#x4E5F;&#x662F;&#x4E00;&#x79CD;&#x7C7B;&#x578B;" class="anchor-navigation-ex-anchor" href="#&#x672A;&#x5B9A;&#x4E49;&#x4E5F;&#x662F;&#x4E00;&#x79CD;&#x7C7B;&#x578B;"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.5. &#x672A;&#x5B9A;&#x4E49;&#x4E5F;&#x662F;&#x4E00;&#x79CD;&#x7C7B;&#x578B;</h3>
<ul>
<li>&#x6CA1;&#x6709;return&#x7684;&#x51FD;&#x6570;&#x662F;undefined&#x7C7B;&#x578B;</li>
<li>&#x4E0D;&#x5B58;&#x5728;&#x7684;index/key&#x8FD4;&#x56DE;undefined&#x7C7B;&#x578B;</li>
<li>&#x5F3A;&#x8F6C;&#x5931;&#x8D25;&#x8FD4;&#x56DE;undefined&#x7C7B;&#x578B;</li>
</ul>
<pre class="language-"><code class="lang-go">a <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> b <span class="token operator">:=</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// a == undefined</span>
b <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>          <span class="token comment">// b == undefined</span>
c <span class="token operator">:=</span> <span class="token punctuation">{</span>a<span class="token punctuation">:</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">]</span>        <span class="token comment">// c == undefined</span>
d <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span>             <span class="token comment">// d == undefined</span>
</code></pre>
<p>&#x6CE8;: &#x8FD9;&#x91CC;&#x770B;&#x5230;, index&#x8D85;&#x8FC7;&#x8303;&#x56F4;&#x8FD4;&#x56DE;&#x7684;&#x662F;undefined&#x7C7B;&#x578B;, &#x800C;&#x4E0D;&#x662F;&#x76F4;&#x63A5;panic</p>
<h3 id="&#x5E7F;&#x4E49;&#x7684;array&#x548C;map"><a name="&#x5E7F;&#x4E49;&#x7684;array&#x548C;map" class="anchor-navigation-ex-anchor" href="#&#x5E7F;&#x4E49;&#x7684;array&#x548C;map"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.6. &#x5E7F;&#x4E49;&#x7684;array&#x548C;map</h3>
<p>array&#x548C;map&#x88AB;&#x8BBE;&#x8BA1;&#x6210;&#x89E3;&#x91CA;&#x5668;&#x8BE5;&#x6709;&#x7684;&#x6837;&#x5B50;:</p>
<ul>
<li>array&#x7684;&#x5143;&#x7D20;&#x53EF;&#x4EE5;&#x662F;&#x4EFB;&#x610F;&#x7C7B;&#x578B;, &#x652F;&#x6301;&#x5D4C;&#x5957;: </li>
</ul>
<pre class="language-"><code class="lang-go"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>       <span class="token comment">// == 1</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>       <span class="token comment">// == 3</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>       <span class="token comment">// == undefined</span>

<span class="token punctuation">[</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>   <span class="token comment">// ok: array with an array element</span>
</code></pre>
<ul>
<li>array&#x652F;&#x6301;&#x52A0;&#x6CD5;&#x64CD;&#x4F5C;: (array) + (array): return a concatenated array</li>
<li>map&#x7684;&#x5143;&#x7D20;&#x53EF;&#x4EE5;&#x7528;<code>[]</code>&#x4E5F;&#x53EF;&#x4EE5;&#x7528;<code>.</code>&#x6765;&#x8BBF;&#x95EE;</li>
</ul>
<pre class="language-"><code class="lang-go">m <span class="token operator">:=</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> c<span class="token punctuation">:</span> <span class="token string">&quot;foo&quot;</span> <span class="token punctuation">}</span>
m<span class="token punctuation">[</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">]</span>                                <span class="token comment">// == false</span>
m<span class="token punctuation">.</span>c                                   <span class="token comment">// == &quot;foo&quot;</span>
m<span class="token punctuation">.</span>x                                   <span class="token comment">// == undefined</span>

<span class="token punctuation">{</span>a<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token punctuation">{</span>c<span class="token punctuation">:</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> d<span class="token punctuation">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">// ok: map with an array element and a map element</span>
</code></pre>
<ul>
<li>array&#x548C;map&#x90FD;&#x652F;&#x6301;&#x6BD4;&#x8F83;&#x64CD;&#x4F5C;</li>
</ul>
<h3 id="&#x51FD;&#x6570;&#x4E5F;&#x662F;&#x503C;-&#x4E00;&#x7B49;&#x516C;&#x6C11;-&#x652F;&#x6301;&#x95ED;&#x5305;"><a name="&#x51FD;&#x6570;&#x4E5F;&#x662F;&#x503C;-&#x4E00;&#x7B49;&#x516C;&#x6C11;-&#x652F;&#x6301;&#x95ED;&#x5305;" class="anchor-navigation-ex-anchor" href="#&#x51FD;&#x6570;&#x4E5F;&#x662F;&#x503C;-&#x4E00;&#x7B49;&#x516C;&#x6C11;-&#x652F;&#x6301;&#x95ED;&#x5305;"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.7. &#x51FD;&#x6570;&#x4E5F;&#x662F;&#x503C;, &#x4E00;&#x7B49;&#x516C;&#x6C11;, &#x652F;&#x6301;&#x95ED;&#x5305;</h3>
<pre class="language-"><code class="lang-go">my_func <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> arg1 <span class="token operator">+</span> arg2
<span class="token punctuation">}</span>

adder <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> base <span class="token operator">+</span> x <span class="token punctuation">}</span>  <span class="token comment">// capturing &apos;base&apos;</span>
<span class="token punctuation">}</span>
add5 <span class="token operator">:=</span> <span class="token function">adder</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
nine <span class="token operator">:=</span> <span class="token function">add5</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>    <span class="token comment">// == 9</span>
</code></pre>
<p>&#x548C;go&#x7684;&#x533A;&#x522B;&#x662F;, tengo&#x91CC;&#x7684;&#x51FD;&#x6570;&#x5FC5;&#x987B;&#x662F;<strong>&#x503C;&#x58F0;&#x660E;</strong>&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x5B9A;&#x4E49;
&#x58F0;&#x660E;&#x51FD;&#x6570;&#x7684;&#x65B9;&#x5F0F;&#x4E0D;&#x652F;&#x6301;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">my_func</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// illegal</span>
  <span class="token keyword">return</span> arg1 <span class="token operator">+</span> arg2
<span class="token punctuation">}</span>
</code></pre>
<p>&#x652F;&#x6301;&#x53D8;&#x957F;&#x53C2;&#x6570;: &#x53D8;&#x957F;&#x90E8;&#x5206;&#x88AB;&#x7EC4;&#x6210;&#x4E00;&#x4E2A;array</p>
<pre class="language-"><code class="lang-go">variadic <span class="token operator">:=</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">...</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token function">variadic</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// [1, 2, [3, 4]]</span>

variadicClosure <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token operator">...</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">variadicClosure</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// [1, 2, [3, 4]]</span>
</code></pre>
<p>&#x53D8;&#x957F;&#x90E8;&#x5206;&#x53EA;&#x80FD;&#x5728;&#x6700;&#x540E;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// illegal, because a is variadic and is not the last parameter</span>
illegal <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token operator">...</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/*... */</span> <span class="token punctuation">}</span>
</code></pre>
<p>&#x652F;&#x6301;go&#x5F0F;&#x7684;<code>...</code>&#x89E3;array:</p>
<pre class="language-"><code class="lang-go">f1 <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c <span class="token punctuation">}</span>
<span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token comment">// =&gt; 6</span>
<span class="token function">f1</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token comment">// =&gt; 6</span>
<span class="token function">f1</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token comment">// =&gt; 6</span>
<span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>       <span class="token comment">// Runtime Error: wrong number of arguments: want=3, got=2</span>

f2 <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">...</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token function">f2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>               <span class="token comment">// valid; a = 1, b = []</span>
<span class="token function">f2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>            <span class="token comment">// valid; a = 1, b = [2]</span>
<span class="token function">f2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>         <span class="token comment">// valid; a = 1, b = [2, 3]</span>
<span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token comment">// valid; a = 1, b = [2, 3]</span>
</code></pre>
<h3 id="&#x53D8;&#x91CF;scope"><a name="&#x53D8;&#x91CF;scope" class="anchor-navigation-ex-anchor" href="#&#x53D8;&#x91CF;scope"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.8. &#x53D8;&#x91CF;scope</h3>
<p>&#x548C;abs&#x4E0D;&#x540C;, tengo&#x652F;&#x6301;&#x51FD;&#x6570;&#x7EA7;&#x7684;scope</p>
<ul>
<li><code>:=</code>&#x5728;&#x5F53;&#x524D;scope&#x5B9A;&#x4E49;&#x65B0;&#x53D8;&#x91CF;</li>
<li><code>=</code>&#x5728;&#x5F53;&#x524D;scope&#x91CD;&#x65B0;&#x8D4B;&#x503C;&#x53D8;&#x91CF;</li>
<li>&#x53D8;&#x91CF;&#x7684;&#x503C;&#x7C7B;&#x578B;&#x662F;&#x52A8;&#x6001;&#x7684;:<pre class="language-"><code class="lang-go">a <span class="token operator">:=</span> <span class="token number">123</span>        <span class="token comment">// assigned    &apos;int&apos;</span>
a <span class="token operator">=</span> <span class="token string">&quot;123&quot;</span>       <span class="token comment">// re-assigned &apos;string&apos;</span>
a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>   <span class="token comment">// re-assigned &apos;array&apos;</span>
</code></pre>
</li>
</ul>
<p>scope&#x4F8B;&#x5B50;:</p>
<pre class="language-"><code class="lang-go">a <span class="token operator">:=</span> <span class="token string">&quot;foo&quot;</span>      <span class="token comment">// define &apos;a&apos; in global scope</span>

<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// function scope A</span>
  b <span class="token operator">:=</span> <span class="token number">52</span>       <span class="token comment">// define &apos;b&apos; in function scope A</span>

  <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// function scope B</span>
    c <span class="token operator">:=</span> <span class="token number">19.84</span>  <span class="token comment">// define &apos;c&apos; in function scope B</span>

    a <span class="token operator">=</span> <span class="token string">&quot;bee&quot;</span>   <span class="token comment">// ok: assign new value to &apos;a&apos; from global scope</span>
    b <span class="token operator">=</span> <span class="token number">20</span>      <span class="token comment">// ok: assign new value to &apos;b&apos; from function scope A</span>

    b <span class="token operator">:=</span> <span class="token boolean">true</span>   <span class="token comment">// ok: define new &apos;b&apos; in function scope B</span>
                <span class="token comment">//     (shadowing &apos;b&apos; from function scope A)</span>
  <span class="token punctuation">}</span>

  a <span class="token operator">=</span> <span class="token string">&quot;bar&quot;</span>     <span class="token comment">// ok: assigne new value to &apos;a&apos; from global scope</span>
  b <span class="token operator">=</span> <span class="token number">10</span>        <span class="token comment">// ok: assigne new value to &apos;b&apos;</span>
  a <span class="token operator">:=</span> <span class="token operator">-</span><span class="token number">100</span>     <span class="token comment">// ok: define new &apos;a&apos; in function scope A</span>
                <span class="token comment">//     (shadowing &apos;a&apos; from global scope)</span>

  c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">9.1</span>      <span class="token comment">// illegal: &apos;c&apos; is not defined</span>
  b <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>   <span class="token comment">// illegal: &apos;b&apos; is already defined in the same scope</span>
<span class="token punctuation">}</span>

b <span class="token operator">=</span> <span class="token number">25</span>          <span class="token comment">// illegal: &apos;b&apos; is not defined</span>
a <span class="token operator">:=</span> <span class="token punctuation">{</span>d<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span>     <span class="token comment">// illegal: &apos;a&apos; is already defined in the same scope</span>
</code></pre>
<h3 id="&#x5185;&#x7F6E;&#x7C7B;&#x578B;&#x8F6C;&#x6362;"><a name="&#x5185;&#x7F6E;&#x7C7B;&#x578B;&#x8F6C;&#x6362;" class="anchor-navigation-ex-anchor" href="#&#x5185;&#x7F6E;&#x7C7B;&#x578B;&#x8F6C;&#x6362;"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.9. &#x5185;&#x7F6E;&#x7C7B;&#x578B;&#x8F6C;&#x6362;</h3>
<p>&#x6BD4;&#x5982;int&#x8F6C;&#x4E3A;string&#x662F;&#x53EF;&#x4EE5;&#x7684;: <code>string(x)</code>: tries to convert <code>x</code> into string; returns <code>undefined</code> if failed</p>
<pre class="language-"><code class="lang-go"><span class="token comment">//&#x5728;native go&#x91CC;, string(1984)&#x662F;&#x4E0D;&#x884C;&#x7684;; &#x4F46;&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;</span>
s1 <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token number">1984</span><span class="token punctuation">)</span>    <span class="token comment">// &quot;1984&quot;</span>
i2 <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token string">&quot;-999&quot;</span><span class="token punctuation">)</span>     <span class="token comment">// -999</span>
f3 <span class="token operator">:=</span> <span class="token function">float</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">51</span><span class="token punctuation">)</span>      <span class="token comment">// -51.0</span>
b4 <span class="token operator">:=</span> <span class="token function">bool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>         <span class="token comment">// true</span>
c5 <span class="token operator">:=</span> <span class="token function">char</span><span class="token punctuation">(</span><span class="token string">&quot;X&quot;</span><span class="token punctuation">)</span>       <span class="token comment">// &apos;X&apos;</span>
</code></pre>
<p>&#x6240;&#x6709;&#x7C7B;&#x578B;&#x90FD;&#x6709;false&#x7684;&#x6982;&#x5FF5;:</p>
<ul>
<li><strong>Int</strong>: <code>n == 0</code></li>
<li><strong>String</strong>: <code>len(s) == 0</code></li>
<li><strong>Float</strong>: <code>isNaN(f)</code></li>
<li><strong>Bool</strong>: <code>!b</code></li>
<li><strong>Char</strong>: <code>c == 0</code></li>
<li><strong>Bytes</strong>: <code>len(bytes) == 0</code></li>
<li><strong>Array</strong>: <code>len(arr) == 0</code></li>
<li><strong>Map</strong>: <code>len(map) == 0</code></li>
<li><strong>Time</strong>: <code>Time.IsZero()</code></li>
<li><strong>Error</strong>: <code>true</code> <em>(Error is always falsy)</em></li>
<li><strong>Undefined</strong>: <code>true</code> <em>(Undefined is always falsy)</em></li>
</ul>
<h3 id="&#x652F;&#x6301;&#x4E09;&#x76EE;&#x64CD;&#x4F5C;"><a name="&#x652F;&#x6301;&#x4E09;&#x76EE;&#x64CD;&#x4F5C;" class="anchor-navigation-ex-anchor" href="#&#x652F;&#x6301;&#x4E09;&#x76EE;&#x64CD;&#x4F5C;"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.10. &#x652F;&#x6301;&#x4E09;&#x76EE;&#x64CD;&#x4F5C;</h3>
<pre class="language-"><code class="lang-go">a <span class="token operator">:=</span> <span class="token boolean">true</span> ? <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span>    <span class="token comment">// a == 1</span>

min <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">&lt;</span> b ? a <span class="token punctuation">:</span> b
<span class="token punctuation">}</span>
b <span class="token operator">:=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>      <span class="token comment">// b == 5</span>
</code></pre>
<h3 id="&#x548C;&#x80FD;&#x4F5C;&#x7528;&#x4E8E;&#x590D;&#x5408;&#x7C7B;&#x578B;array-map-string&#x548C;bytes"><a name="&#x548C;&#x80FD;&#x4F5C;&#x7528;&#x4E8E;&#x590D;&#x5408;&#x7C7B;&#x578B;array-map-string&#x548C;bytes" class="anchor-navigation-ex-anchor" href="#&#x548C;&#x80FD;&#x4F5C;&#x7528;&#x4E8E;&#x590D;&#x5408;&#x7C7B;&#x578B;array-map-string&#x548C;bytes"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.11. []&#x548C;.&#x80FD;&#x4F5C;&#x7528;&#x4E8E;&#x590D;&#x5408;&#x7C7B;&#x578B;:array map string&#x548C;bytes</h3>
<p>&#x7279;&#x522B;&#x7684;&#x7528;<code>m.x = 5</code>&#x80FD;&#x65B0;&#x589E;&#x4E00;&#x4E2A;(key value)</p>
<pre class="language-"><code class="lang-go"><span class="token punctuation">[</span><span class="token string">&quot;one&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;two&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;three&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment">// == &quot;two&quot;</span>

m <span class="token operator">:=</span> <span class="token punctuation">{</span>
  a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  b<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  c<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">10</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
m<span class="token punctuation">.</span>a              <span class="token comment">// == 1</span>
m<span class="token punctuation">[</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>        <span class="token comment">// == 3</span>
m<span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment">// == 10</span>
m<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">5</span>          <span class="token comment">// add &apos;x&apos; to map &apos;m&apos;</span>
m<span class="token punctuation">[</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>        <span class="token comment">// == undefined</span>
m<span class="token punctuation">[</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>d      <span class="token comment">// == undefined</span>
m<span class="token punctuation">.</span>b<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>       <span class="token comment">// == undefined</span>
m<span class="token punctuation">.</span>x<span class="token punctuation">.</span>y<span class="token punctuation">.</span>z          <span class="token comment">// == undefined</span>
</code></pre>
<h3 id="&#x518D;&#x5207;&#x7247;&#x548C;go&#x4E00;&#x6837;"><a name="&#x518D;&#x5207;&#x7247;&#x548C;go&#x4E00;&#x6837;" class="anchor-navigation-ex-anchor" href="#&#x518D;&#x5207;&#x7247;&#x548C;go&#x4E00;&#x6837;"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.12. &#x518D;&#x5207;&#x7247;&#x548C;go&#x4E00;&#x6837;</h3>
<p>&#x53EF;&#x60DC;<code>-1</code>&#x4E0D;&#x662F;&#x5012;&#x6570;&#x7B2C;&#x4E00;&#x4E2A;&#x7684;&#x610F;&#x601D;, <code>[1, 2, 3, 4, 5][3:-1]</code>&#x662F;&#x975E;&#x6CD5;&#x7684;</p>
<pre class="language-"><code class="lang-go">a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>    <span class="token comment">// == [2, 3]</span>
b <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>     <span class="token comment">// == [4, 5]</span>
c <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>     <span class="token comment">// == [1, 2, 3]</span>
d <span class="token operator">:=</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>     <span class="token comment">// == &quot;llo worl&quot;</span>
c <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>  <span class="token comment">// == [1, 2, 3, 4, 5]</span>
</code></pre>
<h3 id="if&#x652F;&#x6301;&#x524D;&#x7F6E;&#x6267;&#x884C;&#x8BED;&#x53E5;-&#x548C;go&#x4E00;&#x6837;-for&#x7684;&#x7ED3;&#x6784;&#x4E5F;&#x548C;go&#x4E00;&#x6837;&#x6837;&#x7684;-for&#x652F;&#x6301;-for-in"><a name="if&#x652F;&#x6301;&#x524D;&#x7F6E;&#x6267;&#x884C;&#x8BED;&#x53E5;-&#x548C;go&#x4E00;&#x6837;-for&#x7684;&#x7ED3;&#x6784;&#x4E5F;&#x548C;go&#x4E00;&#x6837;&#x6837;&#x7684;-for&#x652F;&#x6301;-for-in" class="anchor-navigation-ex-anchor" href="#if&#x652F;&#x6301;&#x524D;&#x7F6E;&#x6267;&#x884C;&#x8BED;&#x53E5;-&#x548C;go&#x4E00;&#x6837;-for&#x7684;&#x7ED3;&#x6784;&#x4E5F;&#x548C;go&#x4E00;&#x6837;&#x6837;&#x7684;-for&#x652F;&#x6301;-for-in"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.13. if&#x652F;&#x6301;&#x524D;&#x7F6E;&#x6267;&#x884C;&#x8BED;&#x53E5;, &#x548C;go&#x4E00;&#x6837;; for&#x7684;&#x7ED3;&#x6784;&#x4E5F;&#x548C;go&#x4E00;&#x6837;&#x6837;&#x7684;; for&#x652F;&#x6301; for in</h3>
<pre class="language-"><code class="lang-go"><span class="token keyword">for</span> v in <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>          <span class="token comment">// array: element</span>
  <span class="token comment">// &apos;v&apos; is value</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> v in <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>       <span class="token comment">// array: index and element</span>
  <span class="token comment">// &apos;i&apos; is index</span>
  <span class="token comment">// &apos;v&apos; is value  </span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span> k<span class="token punctuation">,</span> v in <span class="token punctuation">{</span>k1<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> k2<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>  <span class="token comment">// map: key and value</span>
  <span class="token comment">// &apos;k&apos; is key</span>
  <span class="token comment">// &apos;v&apos; is value</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x5176;&#x4ED6;&#x548C;native-go&#x7684;&#x4E0D;&#x540C;&#x70B9;"><a name="&#x5176;&#x4ED6;&#x548C;native-go&#x7684;&#x4E0D;&#x540C;&#x70B9;" class="anchor-navigation-ex-anchor" href="#&#x5176;&#x4ED6;&#x548C;native-go&#x7684;&#x4E0D;&#x540C;&#x70B9;"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.14. &#x5176;&#x4ED6;&#x548C;native go&#x7684;&#x4E0D;&#x540C;&#x70B9;</h3>
<ul>
<li>&#x6CA1;&#x6709;struct -- &#x6709;map&#x4E86;, &#x4E0D;&#x9700;&#x8981;struct</li>
<li>&#x6CA1;&#x6709;go routine&#x548C;channel</li>
<li>&#x6CA1;&#x6709;defer</li>
<li>&#x6CA1;&#x6709;switch case</li>
<li>&#x6CA1;&#x6709;panic</li>
<li>&#x6CA1;&#x6709;&#x7C7B;&#x578B;&#x65AD;&#x8A00;</li>
</ul>
<h2 id="&#x5185;&#x7F6E;&#x51FD;&#x6570;"><a name="&#x5185;&#x7F6E;&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#&#x5185;&#x7F6E;&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>7.4. &#x5185;&#x7F6E;&#x51FD;&#x6570;</h2>
<p>&#x4E0D;&#x662F;&#x5F88;&#x591A;, format len copy append delete&#x7B49;&#x7B49;</p>
<pre class="language-"><code class="lang-go">a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
s <span class="token operator">:=</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Foo: %v&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token comment">// s == &quot;Foo: [1, 2, 3]&quot;</span>

v <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
l <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token comment">// l == 3</span>

v1 <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
v2 <span class="token operator">:=</span> v1
v3 <span class="token operator">:=</span> <span class="token function">copy</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span>
v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">print</span><span class="token punctuation">(</span>v2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// &quot;0&quot;; &apos;v1&apos; and &apos;v2&apos; referencing the same array</span>
<span class="token function">print</span><span class="token punctuation">(</span>v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// &quot;2&quot;; &apos;v3&apos; not affected by &apos;v1&apos;</span>

v <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
v <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// v == [1, 2, 3]</span>

v <span class="token operator">:=</span> <span class="token punctuation">{</span>key<span class="token punctuation">:</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">}</span>
<span class="token function">delete</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span> <span class="token comment">// v == {}</span>
<span class="token function">delete</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token string">&quot;missing&quot;</span><span class="token punctuation">)</span> <span class="token comment">// v == {&quot;key&quot;: &quot;value&quot;}</span>
</code></pre>
<p>&#x8FD8;&#x6709;&#x7C7B;&#x578B;&#x8F6C;&#x6362;&#x548C;&#x7C7B;&#x578B;&#x5224;&#x65AD;</p>
<pre class="language-"><code class="lang-go"><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">is_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

v <span class="token operator">:=</span> <span class="token function">bytes</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span> <span class="token comment">//  v == [102 111 111]</span>
<span class="token function">is_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
&#x7B49;&#x7B49;
</code></pre>
<h2 id="&#x88AB;&#x5D4C;&#x5165;&#x6267;&#x884C;"><a name="&#x88AB;&#x5D4C;&#x5165;&#x6267;&#x884C;" class="anchor-navigation-ex-anchor" href="#&#x88AB;&#x5D4C;&#x5165;&#x6267;&#x884C;"><i class="fa fa-link" aria-hidden="true"></i></a>7.5. &#x88AB;&#x5D4C;&#x5165;&#x6267;&#x884C;</h2>
<h3 id="&#x76F4;&#x63A5;&#x4EE3;&#x7801;&#x6267;&#x884C;"><a name="&#x76F4;&#x63A5;&#x4EE3;&#x7801;&#x6267;&#x884C;" class="anchor-navigation-ex-anchor" href="#&#x76F4;&#x63A5;&#x4EE3;&#x7801;&#x6267;&#x884C;"><i class="fa fa-link" aria-hidden="true"></i></a>7.5.1. &#x76F4;&#x63A5;&#x4EE3;&#x7801;&#x6267;&#x884C;</h3>
<pre class="language-"><code class="lang-go"><span class="token keyword">import</span> <span class="token string">&quot;github.com/d5/tengo/v2&quot;</span>

<span class="token keyword">var</span> code <span class="token operator">=</span> <span class="token string">`
reduce := func(seq, fn) {
    s := 0
    for x in seq { fn(x, s) }
    return s
}

print(reduce([1, 2, 3], func(x, s) { s += x }))
`</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewScript</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x4EE3;&#x7801;&#x5B9E;&#x65F6;&#x7F16;&#x8BD1;&#x540E;&#x6267;&#x884C;"><a name="&#x4EE3;&#x7801;&#x5B9E;&#x65F6;&#x7F16;&#x8BD1;&#x540E;&#x6267;&#x884C;" class="anchor-navigation-ex-anchor" href="#&#x4EE3;&#x7801;&#x5B9E;&#x65F6;&#x7F16;&#x8BD1;&#x540E;&#x6267;&#x884C;"><i class="fa fa-link" aria-hidden="true"></i></a>7.5.2. &#x4EE3;&#x7801;&#x5B9E;&#x65F6;&quot;&#x7F16;&#x8BD1;&quot;&#x540E;&#x6267;&#x884C;</h3>
<p>&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;, &#x4EE3;&#x7801;&#x88AB;&quot;&#x7F16;&#x8BD1;&quot;&#x4E86;&#x4E00;&#x6B21;, &#x4F46;&#x6267;&#x884C;&#x4E86;2&#x6B21;. &#x5168;&#x5C40;&#x53D8;&#x91CF;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>Compiled.Set</code>&#x548C;<code>Compiled.Get</code>&#x6765;&#x4ECE;&#x5916;&#x90E8;&#x8BBF;&#x95EE;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>

    <span class="token string">&quot;github.com/d5/tengo/v2&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewScript</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`a := b + 20`</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// define variable &apos;b&apos;</span>
    <span class="token boolean">_</span> <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

    <span class="token comment">// compile the source</span>
    c<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// run the compiled bytecode</span>
    <span class="token comment">// a compiled bytecode &apos;c&apos; can be executed multiple times without re-compiling it</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// retrieve value of &apos;a&apos;</span>
    a <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>           <span class="token comment">// prints &quot;30&quot;</span>

    <span class="token comment">// re-run after replacing value of &apos;b&apos;</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// prints &quot;40&quot;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x5916;&#x90E8;&#x4EE3;&#x7801;&#x91CC;import"><a name="&#x5916;&#x90E8;&#x4EE3;&#x7801;&#x91CC;import" class="anchor-navigation-ex-anchor" href="#&#x5916;&#x90E8;&#x4EE3;&#x7801;&#x91CC;import"><i class="fa fa-link" aria-hidden="true"></i></a>7.5.3. &#x5916;&#x90E8;&#x4EE3;&#x7801;&#x91CC;import</h3>
<p>&#x8FD9;&#x91CC;&#x7684;&#x5916;&#x90E8;&#x4EE3;&#x7801;&#x6307;&#x8C03;&#x7528;tengo&#x7684;go&#x4EE3;&#x7801;:</p>
<pre class="language-"><code class="lang-go">s <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewScript</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`math := import(&quot;math&quot;); a := math.abs(-19.84)`</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

s<span class="token punctuation">.</span><span class="token function">SetImports</span><span class="token punctuation">(</span>stdlib<span class="token punctuation">.</span><span class="token function">GetModuleMap</span><span class="token punctuation">(</span><span class="token string">&quot;math&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// or, to include all stdlib at once</span>
s<span class="token punctuation">.</span><span class="token function">SetImports</span><span class="token punctuation">(</span>stdlib<span class="token punctuation">.</span><span class="token function">GetModuleMap</span><span class="token punctuation">(</span>stdlib<span class="token punctuation">.</span><span class="token function">AllModuleNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x4E5F;&#x53EF;&#x4EE5;&#x5F15;&#x7528;&#x81EA;&#x5B9A;&#x4E49;module:</p>
<pre class="language-"><code class="lang-go">s <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewScript</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`double := import(&quot;double&quot;); a := double(20)`</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

mods <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewModuleMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
mods<span class="token punctuation">.</span><span class="token function">AddSourceModule</span><span class="token punctuation">(</span><span class="token string">&quot;double&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`export func(x) { return x * 2 }`</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span><span class="token function">SetImports</span><span class="token punctuation">(</span>mods<span class="token punctuation">)</span>
</code></pre>
<h2 id="&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;"><a name="&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;" class="anchor-navigation-ex-anchor" href="#&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;"><i class="fa fa-link" aria-hidden="true"></i></a>7.6. &#x7528;&#x6237;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;</h2>
<p>&#x7528;&#x6237;&#x5B9E;&#x73B0;&#x4E86;Object&#x63A5;&#x53E3;&#x5C31;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;. &#x7528;&#x6237;&#x7684;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x548C;&#x5185;&#x7F6E;&#x7C7B;&#x578B;&#x5F85;&#x9047;&#x4E00;&#x6837;.<br>&#x5373;&#x8981;&#x5B9E;&#x73B0;&#x4E0B;&#x9762;&#x7684;&#x63A5;&#x53E3;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">//&#x7C7B;&#x578B;&#x540D;&#x5B57;</span>
<span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token comment">//&#x503C;&#x7684;&#x5B57;&#x9762;&#x5B57;&#x7B26;&#x4E32;&#x8868;&#x8FBE;</span>
<span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token comment">//&#x91CD;&#x8F7D;&#x64CD;&#x4F5C;&#x7B26;: +, -, *, /, %, &amp;, |, ^, &amp;^, &gt;&gt;, &lt;&lt;, &gt;, &gt;=</span>
<span class="token comment">//&#x6709;&#x9519;&#x8BEF;&#x53D1;&#x751F;&#x65F6;, &#x53EF;&#x4EE5;&#x8FD4;&#x56DE;Error&#x503C;&#x5230;res(&#x4E0D;&#x4E2D;&#x65AD;&#x811A;&#x672C;&#x6267;&#x884C;)</span>
<span class="token comment">//&#x4E5F;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;err, &#x6BD4;&#x5982;ErrInvalidOperator, &#x4F46;&#x4F1A;&#x4E2D;&#x65AD;VM&#x7684;&#x6267;&#x884C;</span>
<span class="token function">BinaryOp</span><span class="token punctuation">(</span>op token<span class="token punctuation">.</span>Token<span class="token punctuation">,</span> rhs Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>res Object<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token function">IsFalsy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token function">Equals</span><span class="token punctuation">(</span>o Object<span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token comment">//&#x5185;&#x5EFA;&#x7684;&#x7C7B;&#x578B;&#x662F;&#x6DF1;&#x62F7;&#x8D1D;&#x6A21;&#x5F0F;, &#x4F46;&#x7528;&#x6237;&#x4E5F;&#x53EF;&#x4EE5;&#x5728;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x4E2D;&#x641E;&#x6D45;&#x62F7;&#x8D1D;</span>
<span class="token function">Copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Object
<span class="token comment">//If Object is not indexable, ErrNotIndexable should be returned as error. If nil is returned as value, it will be converted to Undefined value by the runtime.</span>
<span class="token function">IndexGet</span><span class="token punctuation">(</span>index Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>value Object<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token function">IndexSet</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value Object<span class="token punctuation">)</span> <span class="token builtin">error</span>

<span class="token comment">//&#x5BF9;&#x8C61;&#x53EF;&#x4EE5;&#x6709;call&#x65B9;&#x6CD5;</span>
<span class="token function">CanCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token comment">//Call&#x7684;&#x683C;&#x5F0F;&#x6BD4;native go&#x66F4;&#x6B7B;&#x677F;&#x4E00;&#x70B9;, &#x8FD4;&#x56DE;&#x503C;&#x5FC5;&#x987B;&#x662F;&#x4E24;&#x4E2A;</span>
<span class="token function">Call</span><span class="token punctuation">(</span>args <span class="token operator">...</span>Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>ret Object<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>

<span class="token comment">//&#x5BF9;&#x8C61;&#x53EF;&#x4EE5;&#x88AB;&#x8FED;&#x4EE3;</span>
<span class="token function">CanIterate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token comment">//Iterator&#x662F;&#x8FD4;&#x56DE;&#x7684;&#x5BF9;&#x8C61;, &#x5B9E;&#x73B0;&#x4E86;Iterator&#x63A5;&#x53E3;</span>
<span class="token function">Iterate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Iterator
<span class="token comment">//Iterator&#x63A5;&#x53E3;&#x5305;&#x62EC;:</span>
<span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token function">Key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Object
<span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Object
</code></pre>
<h3 id="&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x4E3E;&#x4F8B;"><a name="&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x4E3E;&#x4F8B;" class="anchor-navigation-ex-anchor" href="#&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x4E3E;&#x4F8B;"><i class="fa fa-link" aria-hidden="true"></i></a>7.6.1. &#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x4E3E;&#x4F8B;</h3>
<p>&#x548C;native go&#x7684;&#x6838;&#x5FC3;&#x7CBE;&#x795E;&#x4E00;&#x6837;, &#x4E0B;&#x9762;&#x7684;<code>*StringArray</code>&#x5B9E;&#x73B0;&#x4E86;tengo&#x7684;Object&#x8981;&#x6C42;:
&#x4E3B;&#x8981;&#x662F;&#x5B9E;&#x73B0;&#x4E86;string array&#x7684;<code>+</code>&#x64CD;&#x4F5C;
&#x6CE8;&#x610F;<code>StringArray</code>&#x533F;&#x540D;&#x5305;&#x542B;&#x4E86;<code>tengo.ObjectImpl</code>, &#x8FD9;&#x662F;&#x4E2A;&#x5178;&#x578B;&#x7684;&#x7EE7;&#x627F;&#x64CD;&#x4F5C;: &#x7EE7;&#x627F;&#x4E86;<code>tengo.ObjectImpl</code>&#x7684;&#x65B9;&#x6CD5;&#x96C6;, &#x540E;&#x8005;&#x662F;&#x4E2A;&#x7A7A;&#x7ED3;&#x6784;&#x4F53;<code>type ObjectImpl struct {}</code>, &#x4F46;&#x7531;<code>tengo/objects.go</code>&#x63D0;&#x4F9B;&#x7684;&#x9ED8;&#x8BA4;&#x7C7B;&#x578B;&#x65B9;&#x6CD5;&#x5B9E;&#x73B0;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> StringArray <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    tengo<span class="token punctuation">.</span>ObjectImpl
    Value <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>StringArray<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> <span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>StringArray<span class="token punctuation">)</span> <span class="token function">BinaryOp</span><span class="token punctuation">(</span>op token<span class="token punctuation">.</span>Token<span class="token punctuation">,</span> rhs tengo<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> rhs<span class="token punctuation">,</span> ok <span class="token operator">:=</span> rhs<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>StringArray<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> op <span class="token punctuation">{</span>
        <span class="token comment">//&#x8FD9;&#x91CC;&#x662F;&#x6838;&#x5FC3;&#x5B9E;&#x73B0;</span>
        <span class="token keyword">case</span> token<span class="token punctuation">.</span>Add<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>Value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> o<span class="token punctuation">,</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>StringArray<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> <span class="token function">append</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> rhs<span class="token punctuation">.</span>Value<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> tengo<span class="token punctuation">.</span>ErrInvalidOperator
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>StringArray<span class="token punctuation">)</span> <span class="token function">IsFalsy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>Value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>StringArray<span class="token punctuation">)</span> <span class="token function">Equals</span><span class="token punctuation">(</span>x tengo<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> x<span class="token punctuation">,</span> ok <span class="token operator">:=</span> x<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>StringArray<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>Value<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>Value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> o<span class="token punctuation">.</span>Value <span class="token punctuation">{</span>
            <span class="token keyword">if</span> v <span class="token operator">!=</span> x<span class="token punctuation">.</span>Value<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>StringArray<span class="token punctuation">)</span> <span class="token function">Copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> tengo<span class="token punctuation">.</span>Object <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>StringArray<span class="token punctuation">{</span>
        Value<span class="token punctuation">:</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>Value<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>StringArray<span class="token punctuation">)</span> <span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;string-array&quot;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x90A3;&#x4E48;&#x4E00;&#x4E2A;<code>*StringArray</code>&#x5BF9;&#x8C61;&#x53EF;&#x4EE5;&#x88AB;&#x76F4;&#x63A5;Add&#x8FDB;&#x811A;&#x672C;, &#x4E0D;&#x9700;&#x8981;&quot;&#x6CE8;&#x518C;&quot;&#x6B65;&#x9AA4;, tengo&#x5C31;&#x77E5;&#x9053;&#x81EA;&#x52A8;&#x8C03;&#x7528;<code>*StringArray</code>&#x91CD;&#x8F7D;&#x7684;<code>+</code>&#x65B9;&#x6CD5;:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// script that uses &apos;my_list&apos;</span>
s <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewScript</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`
    print(my_list + &quot;three&quot;)
`</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

myList <span class="token operator">:=</span> <span class="token operator">&amp;</span>StringArray<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;one&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;two&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
s<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;my_list&quot;</span><span class="token punctuation">,</span> myList<span class="token punctuation">)</span>  <span class="token comment">// add StringArray value &apos;my_list&apos;</span>
s<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                   <span class="token comment">// prints &quot;one, two, three&quot;</span>
</code></pre>
<h3 id="&#x589E;&#x52A0;&#x66F4;&#x591A;&#x529F;&#x80FD;"><a name="&#x589E;&#x52A0;&#x66F4;&#x591A;&#x529F;&#x80FD;" class="anchor-navigation-ex-anchor" href="#&#x589E;&#x52A0;&#x66F4;&#x591A;&#x529F;&#x80FD;"><i class="fa fa-link" aria-hidden="true"></i></a>7.6.2. &#x589E;&#x52A0;&#x66F4;&#x591A;&#x529F;&#x80FD;</h3>
<p>&#x5728;<code>StringArray</code>&#x7684;&#x5B9E;&#x73B0;&#x91CC;&#x53EF;&#x4EE5;&#x589E;&#x52A0;index&#x7684;&#x652F;&#x6301;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>StringArray<span class="token punctuation">)</span> <span class="token function">IndexGet</span><span class="token punctuation">(</span>index tengo<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    intIdx<span class="token punctuation">,</span> ok <span class="token operator">:=</span> index<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
        <span class="token keyword">if</span> intIdx<span class="token punctuation">.</span>Value <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> intIdx<span class="token punctuation">.</span>Value <span class="token operator">&lt;</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>String<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> o<span class="token punctuation">.</span>Value<span class="token punctuation">[</span>intIdx<span class="token punctuation">.</span>Value<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> tengo<span class="token punctuation">.</span>ErrIndexOutOfBounds
    <span class="token punctuation">}</span>

    strIdx<span class="token punctuation">,</span> ok <span class="token operator">:=</span> index<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>String<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
        <span class="token keyword">for</span> vidx<span class="token punctuation">,</span> str <span class="token operator">:=</span> <span class="token keyword">range</span> o<span class="token punctuation">.</span>Value <span class="token punctuation">{</span>
            <span class="token keyword">if</span> strIdx<span class="token punctuation">.</span>Value <span class="token operator">==</span> str <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> <span class="token function">int64</span><span class="token punctuation">(</span>vidx<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> tengo<span class="token punctuation">.</span>UndefinedValue<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> tengo<span class="token punctuation">.</span>ErrInvalidIndexType
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>StringArray<span class="token punctuation">)</span> <span class="token function">IndexSet</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value tengo<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    strVal<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tengo<span class="token punctuation">.</span>ErrInvalidIndexValueType
    <span class="token punctuation">}</span>

    intIdx<span class="token punctuation">,</span> ok <span class="token operator">:=</span> index<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
        <span class="token keyword">if</span> intIdx<span class="token punctuation">.</span>Value <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> intIdx<span class="token punctuation">.</span>Value <span class="token operator">&lt;</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            o<span class="token punctuation">.</span>Value<span class="token punctuation">[</span>intIdx<span class="token punctuation">.</span>Value<span class="token punctuation">]</span> <span class="token operator">=</span> strVal
            <span class="token keyword">return</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> tengo<span class="token punctuation">.</span>ErrIndexOutOfBounds
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> tengo<span class="token punctuation">.</span>ErrInvalidIndexType
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4E5F;&#x53EF;&#x4EE5;&#x589E;&#x52A0;call&#x7684;&#x652F;&#x6301;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>StringArray<span class="token punctuation">)</span> <span class="token function">CanCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>StringArray<span class="token punctuation">)</span> <span class="token function">Call</span><span class="token punctuation">(</span>args <span class="token operator">...</span>tengo<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">(</span>ret tengo<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> tengo<span class="token punctuation">.</span>ErrWrongNumArguments
    <span class="token punctuation">}</span>

    s1<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> tengo<span class="token punctuation">.</span>ErrInvalidArgumentType<span class="token punctuation">{</span>
            Name<span class="token punctuation">:</span>     <span class="token string">&quot;first&quot;</span><span class="token punctuation">,</span>
            Expected<span class="token punctuation">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
            Found<span class="token punctuation">:</span>    args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> o<span class="token punctuation">.</span>Value <span class="token punctuation">{</span>
        <span class="token keyword">if</span> v <span class="token operator">==</span> s1 <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> <span class="token function">int64</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> tengo<span class="token punctuation">.</span>UndefinedValue<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x6837;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x5C31;&#x53EF;&#x4EE5;&#x88AB;&#x51FD;&#x6570;&#x5F0F;&#x8C03;&#x7528;:</p>
<pre class="language-"><code class="lang-go">s <span class="token operator">:=</span> tengo<span class="token punctuation">.</span><span class="token function">NewScript</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`
    print(my_list(&quot;two&quot;))
`</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

myList <span class="token operator">:=</span> <span class="token operator">&amp;</span>StringArray<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;one&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;two&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;three&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
s<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;my_list&quot;</span><span class="token punctuation">,</span> myList<span class="token punctuation">)</span>  <span class="token comment">// add StringArray value &apos;my_list&apos;</span>
s<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                   <span class="token comment">// prints &quot;1&quot; (index of &quot;two&quot;)</span>
</code></pre>
<p>&#x4E5F;&#x53EF;&#x4EE5;&#x589E;&#x52A0;&#x8FED;&#x4EE3;&#x652F;&#x6301;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>StringArray<span class="token punctuation">)</span> <span class="token function">CanIterate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>StringArray<span class="token punctuation">)</span> <span class="token function">Iterate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> tengo<span class="token punctuation">.</span>Iterator <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>StringArrayIterator<span class="token punctuation">{</span>
        strArr<span class="token punctuation">:</span> o<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> StringArrayIterator <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    tengo<span class="token punctuation">.</span>ObjectImpl
    strArr <span class="token operator">*</span>StringArray
    idx    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>StringArrayIterator<span class="token punctuation">)</span> <span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;string-array-iterator&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>StringArrayIterator<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    i<span class="token punctuation">.</span>idx<span class="token operator">++</span>
    <span class="token keyword">return</span> i<span class="token punctuation">.</span>idx <span class="token operator">&lt;=</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>strArr<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>StringArrayIterator<span class="token punctuation">)</span> <span class="token function">Key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> tengo<span class="token punctuation">.</span>Object <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>Int<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> <span class="token function">int64</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>idx <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>StringArrayIterator<span class="token punctuation">)</span> <span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> tengo<span class="token punctuation">.</span>Object <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>tengo<span class="token punctuation">.</span>String<span class="token punctuation">{</span>Value<span class="token punctuation">:</span> i<span class="token punctuation">.</span>strArr<span class="token punctuation">.</span>Value<span class="token punctuation">[</span>i<span class="token punctuation">.</span>idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x603B;&#x7ED3;_3"><a name="&#x603B;&#x7ED3;_3" class="anchor-navigation-ex-anchor" href="#&#x603B;&#x7ED3;_3"><i class="fa fa-link" aria-hidden="true"></i></a>7.6.3. &#x603B;&#x7ED3;</h3>
<p>tengo&#x4F7F;&#x7528;&#x4E86;go&#x7684;&#x533F;&#x540D;&#x7EE7;&#x627F;, &quot;&#x65A7;&#x5934;&#x5E2E;&quot;&#x5F0F;&#x7684;&#x63A5;&#x53E3;&#x6982;&#x5FF5;, &#x53EF;&#x4EE5;&#x975E;&#x5E38;&#x5BB9;&#x6613;&#x7684;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;.
&#x81EA;&#x5DF1;&#x641E;&#x4E2A;&#x5DE5;&#x7A0B;, &#x5B9A;&#x4E49;&#x7C7B;&#x578B;, &#x548C;tengo&#x7F16;&#x8BD1;&#x5728;&#x4E00;&#x8D77;, &#x8FD9;&#x6837;&#x5176;&#x811A;&#x672C;&#x5C31;&#x652F;&#x6301;&#x975E;&#x5E38;&#x4E30;&#x5BCC;&#x7684;&#x81EA;&#x5B9A;&#x4E49;&#x64CD;&#x4F5C;.
&#x4F46;&#x4E0A;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x4E2D;, <code>my_list</code>&#x53D8;&#x91CF;&#x662F;&#x5728;go&#x4EE3;&#x7801;&#x91CC;&#x5B9A;&#x4E49;&#x7684;, &#x5728;&#x811A;&#x672C;&#x91CC;&#x4F7F;&#x7528;. 
&#x5982;&#x4F55;&#x5728;&#x811A;&#x672C;&#x91CC;&#x76F4;&#x63A5;&#x5B9A;&#x4E49;<code>StringArray</code>&#x7C7B;&#x578B;&#x7684;&#x53D8;&#x91CF;&#x5462;?</p>
<h2 id="&#x6A21;&#x5757;&#x5316;&#x548C;&#x6807;&#x51C6;&#x5E93;"><a name="&#x6A21;&#x5757;&#x5316;&#x548C;&#x6807;&#x51C6;&#x5E93;" class="anchor-navigation-ex-anchor" href="#&#x6A21;&#x5757;&#x5316;&#x548C;&#x6807;&#x51C6;&#x5E93;"><i class="fa fa-link" aria-hidden="true"></i></a>7.7. &#x6A21;&#x5757;&#x5316;&#x548C;&#x6807;&#x51C6;&#x5E93;</h2>
<p>tengo&#x652F;&#x6301;&#x6A21;&#x5757;&#x5316;, &#x6709;&#x4E24;&#x4E2A;&#x5C42;&#x6B21;&#x7684;:</p>
<ul>
<li>tengo&#x811A;&#x672C;</li>
</ul>
<pre class="language-"><code class="lang-go">sum <span class="token operator">:=</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;./sum&quot;</span><span class="token punctuation">)</span>  <span class="token comment">// load module from a local file</span>
fmt<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment">// module function</span>
</code></pre>
<p><code>sum.tengo</code>&#x7684;&#x5185;&#x5BB9;&#x5982;&#x4E0B;: &#x7528;export&#x6765;&#x58F0;&#x660E;&#x8981;&#x5BFC;&#x51FA;&#x7684;&#x5BF9;&#x8C61;, &#x53EF;&#x4EE5;&#x662F;&#x4EFB;&#x4F55;tengo&#x7C7B;&#x578B;, &#x6BD4;&#x5982;map</p>
<pre class="language-"><code class="lang-go">base <span class="token operator">:=</span> <span class="token number">5</span>

export <span class="token keyword">func</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">+</span> base
<span class="token punctuation">}</span>
</code></pre>
<p>export&#x5C31;&#x662F;&#x6587;&#x4EF6;&#x7EA7;&#x522B;&#x7684;return, export&#x8FD4;&#x56DE;&#x7684;&#x5BF9;&#x8C61;&#x90FD;&#x662F;immutable&#x7684;. &#x6CA1;&#x6709;export&#x58F0;&#x660E;&#x7684;module, &#x8FD4;&#x56DE;undefined&#x7C7B;&#x578B;.</p>
<ul>
<li>go&#x4EE3;&#x7801;&#x7684;&#x6A21;&#x5757;
&#x6807;&#x51C6;&#x5E93;&#x662F;go&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x7684;<pre class="language-"><code class="lang-go">math <span class="token operator">:=</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;math&quot;</span><span class="token punctuation">)</span>
a <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">19.84</span><span class="token punctuation">)</span>  <span class="token comment">// == 19.84</span>
</code></pre>
&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;?</li>
</ul>
<h3 id="&#x6807;&#x51C6;&#x5E93;"><a name="&#x6807;&#x51C6;&#x5E93;" class="anchor-navigation-ex-anchor" href="#&#x6807;&#x51C6;&#x5E93;"><i class="fa fa-link" aria-hidden="true"></i></a>7.7.1. &#x6807;&#x51C6;&#x5E93;</h3>
<p>&#x6807;&#x51C6;&#x5E93;&#x7531;:</p>
<ul>
<li><a href="https://github.com/d5/tengo/blob/master/docs/stdlib-os.md" target="_blank">os</a>: platform-independent interface to operating system functionality.</li>
<li><a href="https://github.com/d5/tengo/blob/master/docs/stdlib-text.md" target="_blank">text</a>: regular expressions, string conversion, and manipulation</li>
<li><a href="https://github.com/d5/tengo/blob/master/docs/stdlib-math.md" target="_blank">math</a>: mathematical constants and functions</li>
<li><a href="https://github.com/d5/tengo/blob/master/docs/stdlib-times.md" target="_blank">times</a>: time-related functions</li>
<li><a href="https://github.com/d5/tengo/blob/master/docs/stdlib-rand.md" target="_blank">rand</a>: random functions</li>
<li><a href="https://github.com/d5/tengo/blob/master/docs/stdlib-fmt.md" target="_blank">fmt</a>: formatting functions</li>
<li><a href="https://github.com/d5/tengo/blob/master/docs/stdlib-json.md" target="_blank">json</a>: JSON functions</li>
<li><a href="https://github.com/d5/tengo/blob/master/docs/stdlib-enum.md" target="_blank">enum</a>: Enumeration functions &#x6709;<code>each(x, fn)</code> <code>all(x, fn) =&gt; bool</code> <code>any(x, fn) =&gt; bool</code>&#x7B49;&#x9488;&#x5BF9;array&#x548C;map&#x8C03;&#x7528;fn&#x7684;&#x51FD;&#x6570;</li>
<li><a href="https://github.com/d5/tengo/blob/master/docs/stdlib-hex.md" target="_blank">hex</a>: hex encoding and decoding functions</li>
<li><a href="https://github.com/d5/tengo/blob/master/docs/stdlib-base64.md" target="_blank">base64</a>: base64 encoding and decoding functions</li>
</ul>
<h2 id="runtime&#x5BF9;&#x8C61;&#x7C7B;&#x578B;"><a name="runtime&#x5BF9;&#x8C61;&#x7C7B;&#x578B;" class="anchor-navigation-ex-anchor" href="#runtime&#x5BF9;&#x8C61;&#x7C7B;&#x578B;"><i class="fa fa-link" aria-hidden="true"></i></a>7.8. runtime&#x5BF9;&#x8C61;&#x7C7B;&#x578B;</h2>
<ul>
<li>Primitive value types: <a href="https://godoc.org/github.com/d5/tengo#Int" target="_blank">Int</a>, <a href="https://godoc.org/github.com/d5/tengo#String" target="_blank">String</a>, <a href="https://godoc.org/github.com/d5/tengo#Float" target="_blank">Float</a>, <a href="https://godoc.org/github.com/d5/tengo#ArrayIterator" target="_blank">Bool</a>, <a href="https://godoc.org/github.com/d5/tengo#Char" target="_blank">Char</a>, <a href="https://godoc.org/github.com/d5/tengo#Bytes" target="_blank">Bytes</a>, <a href="https://godoc.org/github.com/d5/tengo#Time" target="_blank">Time</a></li>
<li>Composite value types: <a href="https://godoc.org/github.com/d5/tengo#Array" target="_blank">Array</a>, <a href="https://godoc.org/github.com/d5/tengo#ImmutableArray" target="_blank">ImmutableArray</a>, <a href="https://godoc.org/github.com/d5/tengo#Map" target="_blank">Map</a>, <a href="https://godoc.org/github.com/d5/tengo#ImmutableMap" target="_blank">ImmutableMap</a></li>
<li>Functions: <a href="https://godoc.org/github.com/d5/tengo#CompiledFunction" target="_blank">CompiledFunction</a>, <a href="https://godoc.org/github.com/d5/tengo#BuiltinFunction" target="_blank">BuiltinFunction</a>, <a href="https://godoc.org/github.com/d5/tengo#UserFunction" target="_blank">UserFunction</a></li>
<li><a href="https://godoc.org/github.com/d5/tengo#Iterator" target="_blank">Iterators</a>: <a href="https://godoc.org/github.com/d5/tengo#StringIterator" target="_blank">StringIterator</a>, <a href="https://godoc.org/github.com/d5/tengo#ArrayIterator" target="_blank">ArrayIterator</a>, <a href="https://godoc.org/github.com/d5/tengo#MapIterator" target="_blank">MapIterator</a>, <a href="https://godoc.org/github.com/d5/tengo#ImmutableMapIterator" target="_blank">ImmutableMapIterator</a></li>
<li><a href="https://godoc.org/github.com/d5/tengo#Error" target="_blank">Error</a></li>
<li><a href="https://godoc.org/github.com/d5/tengo#Undefined" target="_blank">Undefined</a></li>
<li>Other internal objects: <a href="https://godoc.org/github.com/d5/tengo#Break" target="_blank">Break</a>, <a href="https://godoc.org/github.com/d5/tengo#Continue" target="_blank">Continue</a>, <a href="https://godoc.org/github.com/d5/tengo#ReturnValue" target="_blank">ReturnValue</a></li>
</ul>
<h2 id="&#x5B89;&#x5168;&#x6027;"><a name="&#x5B89;&#x5168;&#x6027;" class="anchor-navigation-ex-anchor" href="#&#x5B89;&#x5168;&#x6027;"><i class="fa fa-link" aria-hidden="true"></i></a>7.9. &#x5B89;&#x5168;&#x6027;</h2>
<p>&#x6709;&#x51E0;&#x4E2A;API&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x6700;&#x5927;&#x5BF9;&#x8C61;&#x4E2A;&#x6570;, &#x6700;&#x5927;code&#x957F;&#x5EA6;&#x7B49;&#x7B49;</p>
<pre class="language-"><code class="lang-go">Script<span class="token punctuation">.</span><span class="token function">SetMaxAllocs</span><span class="token punctuation">(</span>n <span class="token builtin">int64</span><span class="token punctuation">)</span>
<span class="token comment">//&#x9ED8;&#x8BA4;&#x5173;&#x95ED;&#x4ECE;&#x6587;&#x4EF6;load&#x6A21;&#x5757;</span>
Script<span class="token punctuation">.</span><span class="token function">EnableFileImport</span><span class="token punctuation">(</span>enable <span class="token builtin">bool</span><span class="token punctuation">)</span>
tengo<span class="token punctuation">.</span>MaxStringLen
tengo<span class="token punctuation">.</span>MaxBytesLen
</code></pre>
<h2 id="&#x5E76;&#x53D1;"><a name="&#x5E76;&#x53D1;" class="anchor-navigation-ex-anchor" href="#&#x5E76;&#x53D1;"><i class="fa fa-link" aria-hidden="true"></i></a>7.10. &#x5E76;&#x53D1;</h2>
<p>&#x7F16;&#x8BD1;&#x540E;&#x7684;tengo&#x4EE3;&#x7801;&#x88AB;<code>Compiled.Clone</code>&#x540E;, &#x53EF;&#x4EE5;&#x591A;&#x4E2A;goroutine&#x5E76;&#x53D1;&#x6267;&#x884C;.</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> concurrency<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>compiled <span class="token operator">*</span>tengo<span class="token punctuation">.</span>Compiled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// inputs</span>
        <span class="token boolean">_</span> <span class="token operator">=</span> compiled<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token boolean">_</span> <span class="token operator">=</span> compiled<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token boolean">_</span> <span class="token operator">=</span> compiled<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> err <span class="token operator">:=</span> compiled<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// outputs</span>
        d <span class="token operator">=</span> compiled<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        e <span class="token operator">=</span> compiled<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;e&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span><span class="token function">Clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Pass the cloned copy of Compiled</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x8FD9;&#x91CC;&#x8BF4;&#x7684;vm&#x611F;&#x89C9;&#x5C31;&#x662F;&#x7F16;&#x8BD1;&#x540E;&#x7684;&#x8868;&#x8FBE;&#x6811;"><a name="&#x8FD9;&#x91CC;&#x8BF4;&#x7684;vm&#x611F;&#x89C9;&#x5C31;&#x662F;&#x7F16;&#x8BD1;&#x540E;&#x7684;&#x8868;&#x8FBE;&#x6811;" class="anchor-navigation-ex-anchor" href="#&#x8FD9;&#x91CC;&#x8BF4;&#x7684;vm&#x611F;&#x89C9;&#x5C31;&#x662F;&#x7F16;&#x8BD1;&#x540E;&#x7684;&#x8868;&#x8FBE;&#x6811;"><i class="fa fa-link" aria-hidden="true"></i></a>7.11. &#x8FD9;&#x91CC;&#x8BF4;&#x7684;VM&#x611F;&#x89C9;&#x5C31;&#x662F;&#x7F16;&#x8BD1;&#x540E;&#x7684;&quot;&#x8868;&#x8FBE;&#x6811;&quot;?</h2>
<blockquote>
<p>Although it&apos;s not recommended, you can directly create and run the Tengo Compiler, and VM for yourself instead of using Scripts and Script Variables. It&apos;s a bit more involved as you have to manage the symbol tables and global variables between them, but, basically that&apos;s what Script and Script Variable is doing internally.</p>
</blockquote>
<p>&#x7528;tengo&#x9ED8;&#x8BA4;&#x7684;cli&#x547D;&#x4EE4;, &#x53EF;&#x4EE5;&#x770B;&#x5230;:</p>
<pre class="language-"><code class="lang-sh">$ <span class="token function">cat</span> test.tengo
<span class="token function">fmt</span> :<span class="token operator">=</span> import<span class="token punctuation">(</span><span class="token string">&quot;fmt&quot;</span><span class="token punctuation">)</span>
fmt.println<span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span>

<span class="token comment">#&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x6267;&#x884C;tengo&#x811A;&#x672C;</span>
$ ./tengo test.tengo
hello

<span class="token comment">#&#x4E5F;&#x53EF;&#x4EE5;&quot;&#x7F16;&#x8BD1;&quot;&#x6210;&#x5B57;&#x8282;&#x7801;, &#x7F16;&#x8BD1;&#x540E;&#x5927;&#x6982;1k</span>
$ ./tengo <span class="token parameter variable">-o</span> <span class="token builtin class-name">test</span> test.tengo
$ llh
total <span class="token number">4</span>.8M
-rwxr-xr-x <span class="token number">1</span> yingjieb platform <span class="token number">4</span>.8M Dec  <span class="token number">4</span> 08:53 tengo
-rwxr-xr-x <span class="token number">1</span> yingjieb platform <span class="token number">1019</span> Dec  <span class="token number">4</span> 08:53 <span class="token builtin class-name">test</span>
-rw-r--r-- <span class="token number">1</span> yingjieb platform   <span class="token number">42</span> Dec  <span class="token number">4</span> 08:53 test.tengo

<span class="token comment">#&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8FD0;&#x884C;&#x5B57;&#x8282;&#x7801;</span>
$ ./tengo <span class="token builtin class-name">test</span>
hello
</code></pre>
<p><code>vi test</code>&#x770B;&#x5230;&#x8FD9;&#x4E2A;&quot;&#x5B57;&#x8282;&#x7801;&quot;:<br><img src="img/golang_tengo_20220911000345.png" alt="">  </p>
<h3 id="&#x5B98;&#x65B9;&#x4F8B;&#x5B50;"><a name="&#x5B98;&#x65B9;&#x4F8B;&#x5B50;" class="anchor-navigation-ex-anchor" href="#&#x5B98;&#x65B9;&#x4F8B;&#x5B50;"><i class="fa fa-link" aria-hidden="true"></i></a>7.11.1. &#x5B98;&#x65B9;&#x4F8B;&#x5B50;</h3>
<p>&#x7F16;&#x8BD1;&#x6210;&#x5B57;&#x8282;&#x7801;&#x540E;&#x6267;&#x884C;</p>
<pre class="language-"><code class="lang-sh">tengo <span class="token parameter variable">-o</span> myapp myapp.tengo   <span class="token comment"># compile &apos;myapp.tengo&apos; into binary file &apos;myapp&apos;</span>
tengo myapp                  <span class="token comment"># execute the compiled binary `myapp`</span>
</code></pre>
<p>&#x52A0;<code>#!/usr/local/bin/tengo</code>&#x540E;&#x811A;&#x672C;&#x65B9;&#x5F0F;&#x6267;&#x884C;
&#x811A;&#x672C;&#x5FC5;&#x987B;&#x4EE5;<code>.tengo</code>&#x7ED3;&#x5C3E;. &#x4F3C;&#x4E4E;&#x662F;&#x8FD9;&#x4E2A;cli&#x7A0B;&#x5E8F;&#x7684;&#x9650;&#x5236;</p>
<pre class="language-"><code class="lang-sh"><span class="token comment"># copy tengo executable to a dir where PATH environment variable includes</span>
<span class="token function">cp</span> tengo /usr/local/bin/

<span class="token comment"># add shebang line to source file</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> myapp.tengo <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/usr/local/bin/tengo
fmt := import(&quot;fmt&quot;)
fmt.println(&quot;Hello World!&quot;)
EOF</span>

<span class="token comment"># make myapp.tengo file executable</span>
<span class="token function">chmod</span> +x myapp.tengo

<span class="token comment"># run your script</span>
./myapp.tengo
</code></pre>
<h2 id="&#x66F4;&#x591A;&#x5B98;&#x65B9;&#x4F8B;&#x5B50;"><a name="&#x66F4;&#x591A;&#x5B98;&#x65B9;&#x4F8B;&#x5B50;" class="anchor-navigation-ex-anchor" href="#&#x66F4;&#x591A;&#x5B98;&#x65B9;&#x4F8B;&#x5B50;"><i class="fa fa-link" aria-hidden="true"></i></a>7.12. &#x66F4;&#x591A;&#x5B98;&#x65B9;&#x4F8B;&#x5B50;</h2>
<h3 id="gento&#x4EE3;&#x7801;&#x8F6C;&#x6210;lua"><a name="gento&#x4EE3;&#x7801;&#x8F6C;&#x6210;lua" class="anchor-navigation-ex-anchor" href="#gento&#x4EE3;&#x7801;&#x8F6C;&#x6210;lua"><i class="fa fa-link" aria-hidden="true"></i></a>7.12.1. gento&#x4EE3;&#x7801;&#x8F6C;&#x6210;lua</h3>
<p>&#x4ECE;</p>
<pre class="language-"><code class="lang-go">each <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v in x <span class="token punctuation">{</span> <span class="token function">f</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
sum <span class="token operator">:=</span> <span class="token number">0</span>
<span class="token function">each</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span> sum <span class="token operator">+=</span> v <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x81EA;&#x52A8;&#x8F6C;&#x5230;:
&#x4F3C;&#x4E4E;&#x6709;&#x70B9;&#x4E11;...</p>
<pre class="language-"><code class="lang-go">function <span class="token function">__iter__</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
  <span class="token keyword">if</span> v<span class="token punctuation">.</span>__a then
    local idx <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">return</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> v<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> then
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
      end
      idx <span class="token operator">=</span> idx <span class="token operator">+</span> <span class="token number">1</span>
      <span class="token keyword">return</span> idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span>idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    end
  <span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token function">pairs</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
  end
end
<span class="token function">getmetatable</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__add<span class="token operator">=</span><span class="token function">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token keyword">return</span> a<span class="token punctuation">.</span><span class="token punctuation">.</span>b end
local each<span class="token operator">=</span><span class="token function">function</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>f<span class="token punctuation">)</span>
  <span class="token keyword">for</span> k<span class="token punctuation">,</span> v in <span class="token function">__iter__</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> do
    local __cont_1__ <span class="token operator">=</span> <span class="token boolean">false</span>
    repeat
      <span class="token function">f</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>v<span class="token punctuation">)</span>
      __cont_1__ <span class="token operator">=</span> <span class="token boolean">true</span>
    until <span class="token number">1</span>
    <span class="token keyword">if</span> not __cont_1__ then <span class="token keyword">break</span> end
  end
end

local sum<span class="token operator">=</span><span class="token number">0</span>
<span class="token function">each</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> __a<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token function">function</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>v<span class="token punctuation">)</span>
  sum<span class="token operator">=</span>sum<span class="token operator">+</span>v
end
<span class="token punctuation">)</span>
</code></pre>
<h3 id="&#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;"><a name="&#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;" class="anchor-navigation-ex-anchor" href="#&#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;"><i class="fa fa-link" aria-hidden="true"></i></a>7.12.2. &#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;</h3>
<p>&#x770B;&#x8D77;&#x6765;&#x633A;&#x7ED5;&#x7684;.
<a href="https://github.com/d5/go-fsm" target="_blank">https://github.com/d5/go-fsm</a> &#x5168;&#x662F;go&#x4EE3;&#x7801;, &#x4F46;&#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86;tengo, &#x5B9E;&#x73B0;&#x4E86;fsm&#x6846;&#x67B6;
main&#x51FD;&#x6570;&#x53EA;&#x4F9D;&#x8D56;<code>&quot;github.com/d5/go-fsm&quot;</code>&#x7684;API, &#x4F46;&#x72B6;&#x6001;&#x673A;&#x7684;&#x5B9A;&#x4E49;&#x662F;&quot;&#x6587;&#x672C;&quot;&#x7684;:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>

    <span class="token string">&quot;github.com/d5/go-fsm&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> decimalsScript <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`
fmt := import(&quot;fmt&quot;)

export {
    // test if the first character is a digit
    is_digit: func(src, dst, v) {
        return v[0] &gt;= &apos;0&apos; &amp;&amp; v[0] &lt;= &apos;9&apos;
    },
    // test if the first character is a period
    is_dot: func(src, dst, v) {
        return v[0] == &apos;.&apos;  
    },
    // test if there are no more characters left
    is_eol: func(src, dst, v) {
        return len(v) == 0  
    },
    // prints out transition info
    print_tx: func(src, dst, v) {
        fmt.printf(&quot;%s -&gt; %s: %q\n&quot;, src, dst, v)
    },
    // cut the first character
    enter: func(src, dst, v) {
        return v[1:]
    },
    enter_end: func(src, dst, v) {
        return &quot;valid number&quot;
    }, 
    enter_error: func(src, dst, v) {
        return &quot;invalid number: &quot; + v
    }
}`</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// build and compile state machine</span>
    <span class="token comment">//&#x8FD9;&#x4E2A;&#x8C03;&#x7528;&#x5F88;&#x540A;, &#x6CE8;&#x91CA;&#x548C;.&#x5939;&#x6742;</span>
    machine<span class="token punctuation">,</span> err <span class="token operator">:=</span> fsm<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>decimalsScript<span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">State</span><span class="token punctuation">(</span><span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;enter&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token comment">// start</span>
        <span class="token function">State</span><span class="token punctuation">(</span><span class="token string">&quot;N&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;enter&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token comment">// whole numbers</span>
        <span class="token function">State</span><span class="token punctuation">(</span><span class="token string">&quot;P&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;enter&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token comment">// decimal point</span>
        <span class="token function">State</span><span class="token punctuation">(</span><span class="token string">&quot;F&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;enter&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token comment">// fractional part</span>
        <span class="token function">State</span><span class="token punctuation">(</span><span class="token string">&quot;E&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;enter_end&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>   <span class="token comment">// end</span>
        <span class="token function">State</span><span class="token punctuation">(</span><span class="token string">&quot;X&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;enter_error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token comment">// error</span>
        <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;E&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;is_eol&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print_tx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;N&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;is_digit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print_tx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;X&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print_tx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token string">&quot;N&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;E&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;is_eol&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print_tx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token string">&quot;N&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;N&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;is_digit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print_tx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token string">&quot;N&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;P&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;is_dot&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print_tx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token string">&quot;N&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;X&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print_tx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token string">&quot;P&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;F&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;is_digit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print_tx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token string">&quot;P&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;X&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print_tx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token string">&quot;F&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;E&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;is_eol&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print_tx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token string">&quot;F&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;F&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;is_digit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print_tx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token string">&quot;F&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;X&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print_tx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// test case 1: &quot;123.456&quot;</span>
    res<span class="token punctuation">,</span> err <span class="token operator">:=</span> machine<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123.456&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>

    <span class="token comment">// test case 2: &quot;12.34.65&quot;</span>
    res<span class="token punctuation">,</span> err <span class="token operator">=</span> machine<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;12.34.56&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="golang_yeagi.html" class="navigation navigation-prev " aria-label="Previous page: 解释器yeagi">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="golang_govaluate.html" class="navigation navigation-next " aria-label="Next page: 解释器govaluate">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"解释器tengo","level":"1.10.11.2","depth":3,"next":{"title":"解释器govaluate","level":"1.10.11.3","depth":3,"path":"notes/golang_govaluate.md","ref":"notes/golang_govaluate.md","articles":[]},"previous":{"title":"解释器yeagi","level":"1.10.11.1","depth":3,"path":"notes/golang_yeagi.md","ref":"notes/golang_yeagi.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-livereload","-sharing","-lunr","-search","search-plus","-highlight","theme-comscore","prism","code","chapter-fold","github","splitter","wide-page","hide-navigation-buttons","anchor-navigation-ex","sequence","mermaid-gb3"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"chapter-fold":{},"prism":{"css":["prismjs/themes/prism.css"],"ignore":["mermaid","sequence"]},"sequence":{"theme":"simple"},"github":{"url":"https://github.com/Bai-Yingjie/Bai-Yingjie.github.io"},"splitter":{},"wide-page":{},"code":{"copyButtons":true},"fontsettings":{"theme":"white","family":"sans","size":2},"hide-navigation-buttons":{},"mermaid-gb3":{},"anchor-navigation-ex":{"mode":"float","pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"isRewritePageTitle":true,"showLevel":true,"tocLevel1Icon":"fa fa-hand-o-right","tocLevel2Icon":"fa fa-hand-o-right","tocLevel3Icon":"fa fa-hand-o-right","showGoTop":true,"isShowTocTitleIcon":true,"printLog":false,"multipleH1":true,"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false}},"theme-comscore":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"theme":"default","author":"Bai Yingjie","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"My Notes","language":"zh-hans","gitbook":"*"},"file":{"path":"notes/golang_tengo.md","mtime":"2022-10-19T03:46:48.831Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-10-19T03:48:03.199Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-mermaid-gb3/book/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-theme-comscore/test.js"></script>
        
    

    <script src="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.min.js"></script>

    </body>
</html>

