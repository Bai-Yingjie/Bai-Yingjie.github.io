
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>vpp的host-interface · My Notes</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Bai Yingjie">
        
        
    
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-wide-page/wide.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hide-navigation-buttons/index.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-theme-comscore/test.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    


    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="as_title_qemu_ovs.html" />
    
    
    <link rel="prev" href="vpp_compiling_on_alpine.md" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    简介
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="recent_topics.html">
            
                <a href="recent_topics.html">
            
                    
                    recent topics
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="as_title_kaiyuan.html">
            
                <a href="as_title_kaiyuan.html">
            
                    
                    开源
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="my_opensource.html">
            
                <a href="my_opensource.html">
            
                    
                    我的开源项目
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="my_upstream.html">
            
                <a href="my_upstream.html">
            
                    
                    我的upstream commit
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="as_title_system.html">
            
                <a href="as_title_system.html">
            
                    
                    系统分析和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="as_title_perf_misc.html">
            
                <a href="as_title_perf_misc.html">
            
                    
                    调试和分析记录系列
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="profiling_调试和分析记录5.html">
            
                <a href="profiling_调试和分析记录5.html">
            
                    
                    调试和分析记录5
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="profiling_调试和分析记录4.html">
            
                <a href="profiling_调试和分析记录4.html">
            
                    
                    调试和分析记录4
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.3" data-path="profiling_调试和分析记录3.html">
            
                <a href="profiling_调试和分析记录3.html">
            
                    
                    调试和分析记录3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.4" data-path="profiling_调试和分析记录2.html">
            
                <a href="profiling_调试和分析记录2.html">
            
                    
                    调试和分析记录2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.5" data-path="profiling_调试和分析记录1.html">
            
                <a href="profiling_调试和分析记录1.html">
            
                    
                    调试和分析记录1
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="调试和分析工具概览.html">
            
                <a href="调试和分析工具概览.html">
            
                    
                    profiling和debugging工具相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="profiling_Linux内核调试的方式以及工具集锦.html">
            
                <a href="profiling_Linux内核调试的方式以及工具集锦.html">
            
                    
                    Linux内核调试的方式以及工具集锦(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2" data-path="profiling_user_space_Ptrace_Utrace_Uprobes.html">
            
                <a href="profiling_user_space_Ptrace_Utrace_Uprobes.html">
            
                    
                    Ptrace, Utrace, Uprobes: Lightweight, Dynamic Tracing of User Apps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3" data-path="debugging_gdb备忘录.html">
            
                <a href="debugging_gdb备忘录.html">
            
                    
                    gdb备忘录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.4" data-path="profiling_perf命令备忘录.html">
            
                <a href="profiling_perf命令备忘录.html">
            
                    
                    perf命令备忘录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.5" data-path="profiling_perf命令备忘录2.html">
            
                <a href="profiling_perf命令备忘录2.html">
            
                    
                    perf命令备忘录2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6" data-path="profiling_perf学习笔记之实战篇.html">
            
                <a href="profiling_perf学习笔记之实战篇.html">
            
                    
                    perf学习笔记之实战篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.7" data-path="profiling_perf学习笔记之入门篇.html">
            
                <a href="profiling_perf学习笔记之入门篇.html">
            
                    
                    perf学习笔记之入门篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.8" data-path="profiling_用kprobe和perf_记录函数参数.html">
            
                <a href="profiling_用kprobe和perf_记录函数参数.html">
            
                    
                    使用kprobe和perf结合记录函数参数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.9" data-path="profiling_ftrace和trace-cmd记录.html">
            
                <a href="profiling_ftrace和trace-cmd记录.html">
            
                    
                    ftrace和trace-cmd记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.10" data-path="profiling_ftrace使用实例.html">
            
                <a href="profiling_ftrace使用实例.html">
            
                    
                    ftrace使用实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.11" data-path="profiling_systemtap实例.html">
            
                <a href="profiling_systemtap实例.html">
            
                    
                    systemtap实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.12" data-path="profiling_systemtap基础.html">
            
                <a href="profiling_systemtap基础.html">
            
                    
                    systemtap基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.13" data-path="profiling_perf-tools_example.html">
            
                <a href="profiling_perf-tools_example.html">
            
                    
                    perf-tools 系统tracing工具集
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.14" data-path="profiling_Comparing_SystemTap_and_bpftrace.html">
            
                <a href="profiling_Comparing_SystemTap_and_bpftrace.html">
            
                    
                    Comparing SystemTap and bpftrace(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.15" data-path="system_analysis_bcc和ebpf.html">
            
                <a href="system_analysis_bcc和ebpf.html">
            
                    
                    bcc和ebpf(starting)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.16" data-path="profiling_valgrind体验.html">
            
                <a href="profiling_valgrind体验.html">
            
                    
                    体验valgrind
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="as_title_os_perf.html">
            
                <a href="as_title_os_perf.html">
            
                    
                    profiling和debugging实例
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="debugging_gshellos_socket_leak.html">
            
                <a href="debugging_gshellos_socket_leak.html">
            
                    
                    gshell socket leak调查
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2" data-path="profiling_调查ftrace显示调用栈全0问题.html">
            
                <a href="profiling_调查ftrace显示调用栈全0问题.html">
            
                    
                    调查ftrace显示调用栈全0问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.3" data-path="profiling_eoe_filter写tap设备失败问题.html">
            
                <a href="profiling_eoe_filter写tap设备失败问题.html">
            
                    
                    eoe_filter写tap设备失败问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.4" data-path="performance_ovs进程调查.html">
            
                <a href="performance_ovs进程调查.html">
            
                    
                    OVS进程调查
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.5" data-path="performance_ping流程和函数调用解析.html">
            
                <a href="performance_ping流程和函数调用解析.html">
            
                    
                    ping流程和函数调用解析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.6" data-path="profiling_VM互相ping场景下的延迟分析.html">
            
                <a href="profiling_VM互相ping场景下的延迟分析.html">
            
                    
                    VM互相ping场景下的延迟分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.7" data-path="debugging_ftrace_谁创建了bond0设备.html">
            
                <a href="debugging_ftrace_谁创建了bond0设备.html">
            
                    
                    谁创建了bond0设备: ftrace kprobe uprobe perf综合使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.8" data-path="profiling_unixbench之filecopy分析.html">
            
                <a href="profiling_unixbench之filecopy分析.html">
            
                    
                    unixbench之file copy分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.9" data-path="profiling_lmbench之lat_tcp分析.html">
            
                <a href="profiling_lmbench之lat_tcp分析.html">
            
                    
                    lmbench之lat_tcp分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="as_title_arch_perf.html">
            
                <a href="as_title_arch_perf.html">
            
                    
                    CPU ARCH相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.4.1" data-path="performance_CPU_microarchiteture_pmu.html">
            
                <a href="performance_CPU_microarchiteture_pmu.html">
            
                    
                    Top-down Microarchitecture Analysis Method(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="as_title_cloud.html">
            
                <a href="as_title_cloud.html">
            
                    
                    Cloud和容器相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="container_linux_namespaces.html">
            
                <a href="container_linux_namespaces.html">
            
                    
                    linux名字空间
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="cloud_杂记.html">
            
                <a href="cloud_杂记.html">
            
                    
                    云杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="container_当代容器读书笔记.html">
            
                <a href="container_当代容器读书笔记.html">
            
                    
                    当代容器读书笔记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="multi-arch_docker_binfmt_misc.html">
            
                <a href="multi-arch_docker_binfmt_misc.html">
            
                    
                    multi-arch docker 和 binfmt_misc
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="as_title_vdevice.html">
            
                <a href="as_title_vdevice.html">
            
                    
                    CPU和device虚拟化
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="as_title_gvisor.html">
            
                <a href="as_title_gvisor.html">
            
                    
                    gvisor
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1.1" data-path="golang_gvisor代码_KVM.html">
            
                <a href="golang_gvisor代码_KVM.html">
            
                    
                    gvisor KVM模式代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.2" data-path="golang_gvisor调试.html">
            
                <a href="golang_gvisor调试.html">
            
                    
                    gvisor调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.3" data-path="golang_gvisor_ptrace.html">
            
                <a href="golang_gvisor_ptrace.html">
            
                    
                    gvisor ptrace模式介绍(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="rust_vmm_brief.html">
            
                <a href="rust_vmm_brief.html">
            
                    
                    rust VMM(virtual machine monitor)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.1" data-path="rust_vmm_简介.html">
            
                <a href="rust_vmm_简介.html">
            
                    
                    rust-vmm简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.2" data-path="rust_firecracker_代码.html">
            
                <a href="rust_firecracker_代码.html">
            
                    
                    firecracker代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.3" data-path="rust_firecracker_使用.html">
            
                <a href="rust_firecracker_使用.html">
            
                    
                    firecracker使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.4" data-path="rust_cloud-hypervisor_代码.html">
            
                <a href="rust_cloud-hypervisor_代码.html">
            
                    
                    cloud hypervisor代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.5" data-path="rust_cloud-hypervisor_使用.html">
            
                <a href="rust_cloud-hypervisor_使用.html">
            
                    
                    cloud hypervisor使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.6" data-path="rust_cloud-hypervisor_问题与解决.html">
            
                <a href="rust_cloud-hypervisor_问题与解决.html">
            
                    
                    cloud hypervisor问题与解决
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.7" data-path="rust_virtiofsd_代码.html">
            
                <a href="rust_virtiofsd_代码.html">
            
                    
                    virtiofsd代码阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.8" data-path="rust_virtio_vhost_libs.html">
            
                <a href="rust_virtio_vhost_libs.html">
            
                    
                    vhost virtio相关的rust库
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="virtualization_virtio规范阅读笔记.html">
            
                <a href="virtualization_virtio规范阅读笔记.html">
            
                    
                    virtio规范阅读笔记.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="qemu_ovs_虚拟化环境.html">
            
                <a href="qemu_ovs_虚拟化环境.html">
            
                    
                    qemu OVS 虚拟化环境准备
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="qemu使用.html">
            
                <a href="qemu使用.html">
            
                    
                    Qemu使用(old)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="qemu_binary_translation.html">
            
                <a href="qemu_binary_translation.html">
            
                    
                    QEMU 指令翻译
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="as_title_networking.html">
            
                <a href="as_title_networking.html">
            
                    
                    计算机网络相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="networking_杂记2.html">
            
                <a href="networking_杂记2.html">
            
                    
                    networking杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="networking_杂记1.html">
            
                <a href="networking_杂记1.html">
            
                    
                    networking杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="networking_优化linux网络栈_接收路径.html">
            
                <a href="networking_优化linux网络栈_接收路径.html">
            
                    
                    优化linux网络栈: 接收路径(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="networking_优化linux网络栈_发送路径.html">
            
                <a href="networking_优化linux网络栈_发送路径.html">
            
                    
                    优化linux网络栈: 发送路径(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="networking_Potential_Performance_Bottleneck_in_Linux_TCP.html">
            
                <a href="networking_Potential_Performance_Bottleneck_in_Linux_TCP.html">
            
                    
                    Potential Performance Bottleneck in Linux TCP(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="networking_xdp入门.html">
            
                <a href="networking_xdp入门.html">
            
                    
                    Get started with XDP(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="networking_linux收包路径图解.html">
            
                <a href="networking_linux收包路径图解.html">
            
                    
                    linux收包路径图解(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8" data-path="vpp_compiling_on_alpine.md">
            
                <span>
            
                    
                    alpine编译vpp
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.6.8.1" data-path="vpp_host_interace.html">
            
                <a href="vpp_host_interace.html">
            
                    
                    vpp的host-interface
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.9" data-path="as_title_qemu_ovs.html">
            
                <a href="as_title_qemu_ovs.html">
            
                    
                    Qemu OVS和DPDK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.9.1" data-path="OVS_DPDK_编译运行.html">
            
                <a href="OVS_DPDK_编译运行.html">
            
                    
                    OVS-DPDK编译运行
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.2" data-path="OVS_架构和代码.html">
            
                <a href="OVS_架构和代码.html">
            
                    
                    OVS架构和代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.3" data-path="OVS_DPDK_performance_HXT_ARM_server.html">
            
                <a href="OVS_DPDK_performance_HXT_ARM_server.html">
            
                    
                    OVS-DPDK for ARM server 性能测试环境
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.4" data-path="DPDK_Mellanox.html">
            
                <a href="DPDK_Mellanox.html">
            
                    
                    DPDK Mellanox
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.5" data-path="OVS_phy-vm-phy.html">
            
                <a href="OVS_phy-vm-phy.html">
            
                    
                    OVS PHY-VM-PHY
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.6" data-path="networking_网络虚拟化用例记录.html">
            
                <a href="networking_网络虚拟化用例记录.html">
            
                    
                    网络虚拟化用例记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.7" data-path="networking_网络虚拟化操作记录.html">
            
                <a href="networking_网络虚拟化操作记录.html">
            
                    
                    网络虚拟化操作记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.10" data-path="as_title_virtnet.html">
            
                <a href="as_title_virtnet.html">
            
                    
                    虚拟化网络
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.10.1" data-path="networking_tc_filter_连接veth和tap.html">
            
                <a href="networking_tc_filter_连接veth和tap.html">
            
                    
                    Connecting a veth device to tap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10.2" data-path="networking_multicast_vxlan_flannel.html">
            
                <a href="networking_multicast_vxlan_flannel.html">
            
                    
                    multicast vxlan和flannel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10.3" data-path="networking_virtio网络介绍.html">
            
                <a href="networking_virtio网络介绍.html">
            
                    
                    virtio网络介绍(网摘): vhost-net virtio-net vhost-user SRIOV
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10.4" data-path="networking_virtualization_杂记.html">
            
                <a href="networking_virtualization_杂记.html">
            
                    
                    虚拟化网络杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10.5" data-path="networking_linux虚拟网络接口.html">
            
                <a href="networking_linux虚拟网络接口.html">
            
                    
                    linux虚拟网络接口(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="as_title_arm_server.html">
            
                <a href="as_title_arm_server.html">
            
                    
                    ARM server
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="arm_server_杂记.html">
            
                <a href="arm_server_杂记.html">
            
                    
                    Arm server 杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="server_知识点.html">
            
                <a href="server_知识点.html">
            
                    
                    server知识点
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="as_title_embedded.html">
            
                <a href="as_title_embedded.html">
            
                    
                    嵌入式系统开发调试
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="embedded_debugging.html">
            
                <a href="embedded_debugging.html">
            
                    
                    嵌入式调试杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="uboot_杂记.html">
            
                <a href="uboot_杂记.html">
            
                    
                    uboot杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="buildroot_杂记.html">
            
                <a href="buildroot_杂记.html">
            
                    
                    buildroot杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="toolchain_升级gcc问题解决.html">
            
                <a href="toolchain_升级gcc问题解决.html">
            
                    
                    升级GCC7.3问题解决
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="kernel_异常打印分析实例.html">
            
                <a href="kernel_异常打印分析实例.html">
            
                    
                    kernel bug异常打印分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="as_title_linuxdaily.html">
            
                <a href="as_title_linuxdaily.html">
            
                    
                    Linux工程实践
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="linux_日常使用.html">
            
                <a href="linux_日常使用.html">
            
                    
                    日常linux使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="git_日常使用.html">
            
                <a href="git_日常使用.html">
            
                    
                    日常git使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="向kernel提交补丁.html">
            
                <a href="向kernel提交补丁.html">
            
                    
                    向kernel提交补丁
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="linux_ssh_relay.html">
            
                <a href="linux_ssh_relay.html">
            
                    
                    ssh relay
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5" data-path="gitlab_ci.html">
            
                <a href="gitlab_ci.html">
            
                    
                    gitlab CI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.6" data-path="docker_操作记录.html">
            
                <a href="docker_操作记录.html">
            
                    
                    docker操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.7" data-path="centos_操作记录.html">
            
                <a href="centos_操作记录.html">
            
                    
                    centos操作记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="as_title_golang.html">
            
                <a href="as_title_golang.html">
            
                    
                    Golang
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="as_title_golang1.html">
            
                <a href="as_title_golang1.html">
            
                    
                    入门
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1.1" data-path="golang_语法基础.html">
            
                <a href="golang_语法基础.html">
            
                    
                    Golang 语法基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.1.2" data-path="golang_json性能.html">
            
                <a href="golang_json性能.html">
            
                    
                    Golang json性能比较
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="golang_原理.html">
            
                <a href="golang_原理.html">
            
                    
                    Golang 原理相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.2.1" data-path="golang_interface原理.html">
            
                <a href="golang_interface原理.html">
            
                    
                    Golang interface原理(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2.2" data-path="golang_内存分配.html">
            
                <a href="golang_内存分配.html">
            
                    
                    Golang 内存分配(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="golang_标准库.html">
            
                <a href="golang_标准库.html">
            
                    
                    Golang 标准库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="golang_泛型.html">
            
                <a href="golang_泛型.html">
            
                    
                    Golang 泛型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="golang_我的反射代码.html">
            
                <a href="golang_我的反射代码.html">
            
                    
                    Golang 我的反射代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6" data-path="golang_问答.html">
            
                <a href="golang_问答.html">
            
                    
                    Golang 问答
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.7" data-path="golang_plugin.html">
            
                <a href="golang_plugin.html">
            
                    
                    Golang plugin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8" data-path="golang_高效go.html">
            
                <a href="golang_高效go.html">
            
                    
                    Golang 高效go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9" data-path="golang_进阶.html">
            
                <a href="golang_进阶.html">
            
                    
                    Golang 进阶
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10" data-path="as_title_golang2.html">
            
                <a href="as_title_golang2.html">
            
                    
                    Golang 杂记
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.10.1" data-path="golang_杂记1.html">
            
                <a href="golang_杂记1.html">
            
                    
                    Golang 杂记1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.2" data-path="golang_杂记2.html">
            
                <a href="golang_杂记2.html">
            
                    
                    Golang 杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.3" data-path="golang_杂记3.html">
            
                <a href="golang_杂记3.html">
            
                    
                    Golang 杂记3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.4" data-path="golang_lib选型.html">
            
                <a href="golang_lib选型.html">
            
                    
                    Golang lib选型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.5" data-path="golang_mod_proxy.html">
            
                <a href="golang_mod_proxy.html">
            
                    
                    go mod和go proxy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.6" data-path="golang_汇编_arm64.html">
            
                <a href="golang_汇编_arm64.html">
            
                    
                    Golang 汇编语法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10.7" data-path="golang_cgo_swig.html">
            
                <a href="golang_cgo_swig.html">
            
                    
                    go调用c可以用swig
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.11" data-path="as_title_golang3.html">
            
                <a href="as_title_golang3.html">
            
                    
                    Golang 环境和工具链生成
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.11.1" data-path="golang_toolchain_ppc.html">
            
                <a href="golang_toolchain_ppc.html">
            
                    
                    go tools增加ppc32支持
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.2" data-path="golang_toolchain_compile_gccgo.html">
            
                <a href="golang_toolchain_compile_gccgo.html">
            
                    
                    编译gccgo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.3" data-path="golang_go_on_mips.html">
            
                <a href="golang_go_on_mips.html">
            
                    
                    go on mips boards(not so updated)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.11.3.1" data-path="golang_go_on_mips_part1.html">
            
                <a href="golang_go_on_mips_part1.html">
            
                    
                    part 1: cross compile go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.3.2" data-path="golang_go_on_mips_part2.html">
            
                <a href="golang_go_on_mips_part2.html">
            
                    
                    part 2: build native go compiler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.3.3" data-path="golang_go_on_mips_part3.html">
            
                <a href="golang_go_on_mips_part3.html">
            
                    
                    part 3: gccgo experiments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.3.4" data-path="golang_go_on_mips_part4.html">
            
                <a href="golang_go_on_mips_part4.html">
            
                    
                    part 4: Golang json performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.3.5" data-path="golang_gentoo_on_mips_board_and_build_go.html">
            
                <a href="golang_gentoo_on_mips_board_and_build_go.html">
            
                    
                    Gentoo on mips board and build go
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.12" data-path="as_title_golang4.html">
            
                <a href="as_title_golang4.html">
            
                    
                    微服务
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.12.1" data-path="golang_micro.html">
            
                <a href="golang_micro.html">
            
                    
                    go-micro和micro
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.2" data-path="golang_微服务概念.html">
            
                <a href="golang_微服务概念.html">
            
                    
                    微服务概念
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.13" data-path="as_title_golang5.html">
            
                <a href="as_title_golang5.html">
            
                    
                    解释器和编解码
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.13.1" data-path="golang_yeagi.html">
            
                <a href="golang_yeagi.html">
            
                    
                    解释器yeagi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.2" data-path="golang_tengo.html">
            
                <a href="golang_tengo.html">
            
                    
                    解释器tengo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.3" data-path="golang_govaluate.html">
            
                <a href="golang_govaluate.html">
            
                    
                    解释器govaluate
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.4" data-path="golang_encoding_gotiny.html">
            
                <a href="golang_encoding_gotiny.html">
            
                    
                    gotiny编解码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.5" data-path="golang_abs.html">
            
                <a href="golang_abs.html">
            
                    
                    解释器abs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.14" data-path="as_title_golang6.html">
            
                <a href="as_title_golang6.html">
            
                    
                    调试和性能
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.14.1" data-path="golang_调试记录.html">
            
                <a href="golang_调试记录.html">
            
                    
                    Golang 调试记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.14.2" data-path="golang_topid性能优化.html">
            
                <a href="golang_topid性能优化.html">
            
                    
                    Golang topid性能优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.14.3" data-path="golang_gshell性能调试.html">
            
                <a href="golang_gshell性能调试.html">
            
                    
                    Golang gshell性能调试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.15" data-path="as_title_golang7.html">
            
                <a href="as_title_golang7.html">
            
                    
                    网络和消息中间件
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.15.1" data-path="golang_zmq.html">
            
                <a href="golang_zmq.html">
            
                    
                    消息中间件基本概念和zero mq
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.15.2" data-path="golang_mango.html">
            
                <a href="golang_mango.html">
            
                    
                    消息中间件mango
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.15.3" data-path="golang_libp2p.html">
            
                <a href="golang_libp2p.html">
            
                    
                    Golang p2p网络
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="as_title_rust.html">
            
                <a href="as_title_rust.html">
            
                    
                    Rust
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="rust_入门_brief.html">
            
                <a href="rust_入门_brief.html">
            
                    
                    Rust 入门系列
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1.1" data-path="rust_books.html">
            
                <a href="rust_books.html">
            
                    
                    Rust reference books
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.2" data-path="rust_入门1.html">
            
                <a href="rust_入门1.html">
            
                    
                    Rust 安装和基础语法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.3" data-path="rust_入门2.html">
            
                <a href="rust_入门2.html">
            
                    
                    Rust 泛型和内存所有权
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.4" data-path="rust_入门3.html">
            
                <a href="rust_入门3.html">
            
                    
                    Rust 闭包 容器 迭代器 生成器 线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.5" data-path="rust_工程构建.html">
            
                <a href="rust_工程构建.html">
            
                    
                    Rust 工程构建
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="rust_coding_brief.html">
            
                <a href="rust_coding_brief.html">
            
                    
                    Rust 代码积累
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.2.1" data-path="rust_by_example_misc.html">
            
                <a href="rust_by_example_misc.html">
            
                    
                    Rust by example杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.2" data-path="rust_序列化.html">
            
                <a href="rust_序列化.html">
            
                    
                    Rust 序列化原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.3" data-path="rust_知识点积累.html">
            
                <a href="rust_知识点积累.html">
            
                    
                    Rust 知识点更新
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.4" data-path="rust_adaptiveservice.html">
            
                <a href="rust_adaptiveservice.html">
            
                    
                    rust版本的adaptiveservice探索
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.5" data-path="rust_常用设施.html">
            
                <a href="rust_常用设施.html">
            
                    
                    Rust 常用设施
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.6" data-path="rust_代码小段.html">
            
                <a href="rust_代码小段.html">
            
                    
                    Rust 代码小段
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2.7" data-path="rust_错误处理.html">
            
                <a href="rust_错误处理.html">
            
                    
                    Rust 错误处理(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="others.html">
            
                <a href="others.html">
            
                    
                    其他
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.3.1" data-path="rust_mdbook_使用.html">
            
                <a href="rust_mdbook_使用.html">
            
                    
                    Rust 使用mdbook
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="as_title_scripts.html">
            
                <a href="as_title_scripts.html">
            
                    
                    脚本
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="shell_变量.html">
            
                <a href="shell_变量.html">
            
                    
                    shell变量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="shell_基础篇.html">
            
                <a href="shell_基础篇.html">
            
                    
                    shell命令和脚本记录-基础篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="shell_高级篇.html">
            
                <a href="shell_高级篇.html">
            
                    
                    shell命令和脚本记录-高级篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.4" data-path="shell_脚本片段.html">
            
                <a href="shell_脚本片段.html">
            
                    
                    shell脚本片段
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.5" data-path="python_记录.html">
            
                <a href="python_记录.html">
            
                    
                    python记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.6" data-path="lua_记录.html">
            
                <a href="lua_记录.html">
            
                    
                    lua记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.7" data-path="shell_rds脚本阅读.html">
            
                <a href="shell_rds脚本阅读.html">
            
                    
                    RDS脚本阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.8" data-path="Project_Euler.html">
            
                <a href="Project_Euler.html">
            
                    
                    Project Euler
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="as_title_app.html">
            
                <a href="as_title_app.html">
            
                    
                    应用相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="app_sysbench代码分析.html">
            
                <a href="app_sysbench代码分析.html">
            
                    
                    sysbench代码分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="as_title_algorithm.html">
            
                <a href="as_title_algorithm.html">
            
                    
                    算法相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" data-path="algorithm_radix_tree.html">
            
                <a href="algorithm_radix_tree.html">
            
                    
                    基数(radix)树(网摘)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="as_title_cos.html">
            
                <a href="as_title_cos.html">
            
                    
                    C和Operating System
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.1" data-path="system_libc_part1.html">
            
                <a href="system_libc_part1.html">
            
                    
                    libc概览1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="system_libc_part2.html">
            
                <a href="system_libc_part2.html">
            
                    
                    libc概览2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.3" data-path="system_libc_part3.html">
            
                <a href="system_libc_part3.html">
            
                    
                    libc概览3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.4" data-path="system_原理杂记.html">
            
                <a href="system_原理杂记.html">
            
                    
                    系统原理杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.5" data-path="system_alpine.html">
            
                <a href="system_alpine.html">
            
                    
                    Alpine Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.6" data-path="system_进程间通信.html">
            
                <a href="system_进程间通信.html">
            
                    
                    进程间通信
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.7" data-path="system_特殊功能fd.html">
            
                <a href="system_特殊功能fd.html">
            
                    
                    eventfd timerfd signalfd和fd共享
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.8" data-path="c_automake_autoconf.html">
            
                <a href="c_automake_autoconf.html">
            
                    
                    automake autoconf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.9" data-path="makefile_原理和实践.html">
            
                <a href="makefile_原理和实践.html">
            
                    
                    makefile
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.10" data-path="c_编程杂记高级篇.html">
            
                <a href="c_编程杂记高级篇.html">
            
                    
                    C编程杂记高级篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.11" data-path="c_编程杂记基础篇.html">
            
                <a href="c_编程杂记基础篇.html">
            
                    
                    C编程杂记基础篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.12" data-path="c_networking_socket高阶用法.html">
            
                <a href="c_networking_socket高阶用法.html">
            
                    
                    网络编程: Advanced Socket Topics(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.13" data-path="c_protobuf介绍.html">
            
                <a href="c_protobuf介绍.html">
            
                    
                    序列化: protobuf介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.14" data-path="c_进程间通信_共享文件和共享内存.html">
            
                <a href="c_进程间通信_共享文件和共享内存.html">
            
                    
                    进程间通信: 共享文件和共享内存(网摘)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.15" data-path="c_pthread_condition和mutex.html">
            
                <a href="c_pthread_condition和mutex.html">
            
                    
                    并发 任务 事件 和锁.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.16" data-path="kernel_user_space_howto.html">
            
                <a href="kernel_user_space_howto.html">
            
                    
                    kernel space和user space交互(网摘, linux2.6)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.17" data-path="CentOS_系统性能优化配置.html">
            
                <a href="CentOS_系统性能优化配置.html">
            
                    
                    CentOS 性能优化系统配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.18" data-path="OS_gentoo使用.html">
            
                <a href="OS_gentoo使用.html">
            
                    
                    gentoo使用记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="as_title_driver.html">
            
                <a href="as_title_driver.html">
            
                    
                    内核 设备和驱动相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1" data-path="device_driver_地址空间类型和DMA.html">
            
                <a href="device_driver_地址空间类型和DMA.html">
            
                    
                    地址空间类型和DMA
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.2" data-path="platform_device_driver.html">
            
                <a href="platform_device_driver.html">
            
                    
                    平台驱动杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.3" data-path="platform_device_driver2.html">
            
                <a href="platform_device_driver2.html">
            
                    
                    平台驱动杂记2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.4" data-path="device_driver_pci驱动概述.html">
            
                <a href="device_driver_pci驱动概述.html">
            
                    
                    pci驱动概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.5" data-path="device_driver_内核中的时间和延迟操作.html">
            
                <a href="device_driver_内核中的时间和延迟操作.html">
            
                    
                    内核中的时间和延迟操作
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.6" data-path="device_driver_杂记.html">
            
                <a href="device_driver_杂记.html">
            
                    
                    驱动调试杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.7" data-path="device_localbus_16bit读写.html">
            
                <a href="device_localbus_16bit读写.html">
            
                    
                    CPLD做8bit到16bit转换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.8" data-path="driver_位域和大小端.html">
            
                <a href="driver_位域和大小端.html">
            
                    
                    位域和大小端
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.9" data-path="as_title_driver1.html">
            
                <a href="as_title_driver1.html">
            
                    
                    nand
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.9.1" data-path="device_driver_octeon_nand.html">
            
                <a href="device_driver_octeon_nand.html">
            
                    
                    octeon nand flash驱动
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.9.2" data-path="device_driver_nand概率写失败问题分析.html">
            
                <a href="device_driver_nand概率写失败问题分析.html">
            
                    
                    Nand flash概率写失败问题分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.10" data-path="octeon_remote_pci.html">
            
                <a href="octeon_remote_pci.html">
            
                    
                    octeon remote-pci.c阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.11" data-path="Device_VFIO_notes.html">
            
                <a href="Device_VFIO_notes.html">
            
                    
                    VFIO简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12" data-path="as_title_driver2.html">
            
                <a href="as_title_driver2.html">
            
                    
                    智能网卡和DPDK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.12.1" data-path="smartNIC_智能网卡对比.html">
            
                <a href="smartNIC_智能网卡对比.html">
            
                    
                    智能网卡对比
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.2" data-path="octeon_pci_NIC.html">
            
                <a href="octeon_pci_NIC.html">
            
                    
                    octeon PCI NIC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.3" data-path="as_title_driver3.html">
            
                <a href="as_title_driver3.html">
            
                    
                    octeon liquidIO
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.12.3.1" data-path="smartNIC_liquidIO_代码阅读app篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读app篇.html">
            
                    
                    PCI-NIC 代码阅读 --app篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.3.2" data-path="smartNIC_liquidIO_代码阅读api篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读api篇.html">
            
                    
                    PCI-NIC 代码阅读 --api篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.3.3" data-path="smartNIC_liquidIO_代码阅读driver篇之结构体.html">
            
                <a href="smartNIC_liquidIO_代码阅读driver篇之结构体.html">
            
                    
                    PCI-NIC 代码阅读 --driver篇之结构体
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.3.4" data-path="smartNIC_liquidIO_代码阅读driver篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读driver篇.html">
            
                    
                    PCI-NIC 代码阅读 --driver篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.12.3.5" data-path="smartNIC_liquidIO_代码阅读真NIC篇.html">
            
                <a href="smartNIC_liquidIO_代码阅读真NIC篇.html">
            
                    
                    PCI-NIC 代码阅读 --真NIC篇
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.12.4" data-path="networking_dpdk使用_2014.html">
            
                <a href="networking_dpdk使用_2014.html">
            
                    
                    DPDK使用(2014)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16.13" data-path="device_nvme要点介绍.html">
            
                <a href="device_nvme要点介绍.html">
            
                    
                    nvme要点介绍
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="as_title_cpu.html">
            
                <a href="as_title_cpu.html">
            
                    
                    CPU Arch相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.1" data-path="CPU_interconnection_networks.html">
            
                <a href="CPU_interconnection_networks.html">
            
                    
                    CPU核互联模型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.2" data-path="cache_CPU和cache一致性原理.html">
            
                <a href="cache_CPU和cache一致性原理.html">
            
                    
                    CPU和cache一致性原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3" data-path="as_title_cpu1.html">
            
                <a href="as_title_cpu1.html">
            
                    
                    ARM64
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.3.1" data-path="CPU_ARM64_知识杂记.html">
            
                <a href="CPU_ARM64_知识杂记.html">
            
                    
                    aarch64架构知识杂记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.2" data-path="CPU_ARM64_thunder_overview.html">
            
                <a href="CPU_ARM64_thunder_overview.html">
            
                    
                    thunder 概览
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.3" data-path="CPU_ARM64_thunder_开发板操作记录.html">
            
                <a href="CPU_ARM64_thunder_开发板操作记录.html">
            
                    
                    thunder 开发板操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.4" data-path="CPU_ARM64_thunder_bdk.html">
            
                <a href="CPU_ARM64_thunder_bdk.html">
            
                    
                    thunder BDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.5" data-path="CPU_ARM64_thunder_efi_rtc.html">
            
                <a href="CPU_ARM64_thunder_efi_rtc.html">
            
                    
                    thunder RTC时间和efi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.6" data-path="CPU_ARM64_thunder_uefi_fdt.html">
            
                <a href="CPU_ARM64_thunder_uefi_fdt.html">
            
                    
                    thunder uefi和fdt
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.7" data-path="CPU_ARM64_thunder_atf.html">
            
                <a href="CPU_ARM64_thunder_atf.html">
            
                    
                    thunder atf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3.8" data-path="CPU_ARM64_thunder_kernel_boot.html">
            
                <a href="CPU_ARM64_thunder_kernel_boot.html">
            
                    
                    thunder kernel启动打印流程
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17.4" data-path="as_title_cpu2.html">
            
                <a href="as_title_cpu2.html">
            
                    
                    PPC
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.4.1" data-path="CPU_PPC启动多核Linux_流程和内存映射.html">
            
                <a href="CPU_PPC启动多核Linux_流程和内存映射.html">
            
                    
                    PPC启动多核linux: 流程和内存映射
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.4.2" data-path="CPU_PPC_kernel升级记录.html">
            
                <a href="CPU_PPC_kernel升级记录.html">
            
                    
                    PPC kernel升级记录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17.5" data-path="as_title_cpu3.html">
            
                <a href="as_title_cpu3.html">
            
                    
                    MIPS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.5.1" data-path="CPU_MIPS_octeon地址空间和寄存器访问.html">
            
                <a href="CPU_MIPS_octeon地址空间和寄存器访问.html">
            
                    
                    octeon 地址空间和寄存器访问
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.2" data-path="CPU_MIPS_octeon操作记录.html">
            
                <a href="CPU_MIPS_octeon操作记录.html">
            
                    
                    octeon 操作记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.3" data-path="CPU_MIPS_octeon_包处理性能.html">
            
                <a href="CPU_MIPS_octeon_包处理性能.html">
            
                    
                    octeon 系列处理器包处理性能
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.4" data-path="CPU_MIPS_octeon_ddr调试记录.html">
            
                <a href="CPU_MIPS_octeon_ddr调试记录.html">
            
                    
                    octeon DDR调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.5" data-path="CPU_MIPS_octeon_BDK.html">
            
                <a href="CPU_MIPS_octeon_BDK.html">
            
                    
                    octeon CN78xx BDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.6" data-path="kernel_增加ECC中断.html">
            
                <a href="kernel_增加ECC中断.html">
            
                    
                    octeon 增加ECC中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.7" data-path="CPU_MIPS_octeon_hw-ddr2代码走读.html">
            
                <a href="CPU_MIPS_octeon_hw-ddr2代码走读.html">
            
                    
                    octeon hw-ddr2代码走读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.8" data-path="CPU_MIPS_octeon_reboot调试和ddr中断.html">
            
                <a href="CPU_MIPS_octeon_reboot调试和ddr中断.html">
            
                    
                    octeon reboot调试和DDR中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.9" data-path="CPU_MIPS_octeon中断.html">
            
                <a href="CPU_MIPS_octeon中断.html">
            
                    
                    octeon 中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.10" data-path="CPU_MIPS_octeon原子操作.html">
            
                <a href="CPU_MIPS_octeon原子操作.html">
            
                    
                    octeon 原子操作
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5.11" data-path="CPU_MIPS_octeon网口代码分析.html">
            
                <a href="CPU_MIPS_octeon网口代码分析.html">
            
                    
                    octeon 网口代码分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >vpp的host-interface</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#&#x521B;&#x5EFA;host-interface"><b>1. </b>&#x521B;&#x5EFA;host interface</a></li><li><span class="title-icon "></span><a href="#&#x53D1;&#x9001;packet&#x5230;host-eth0"><b>2. </b>&#x53D1;&#x9001;packet&#x5230;host-eth0</a></li><li><span class="title-icon "></span><a href="#&#x4ECE;host-eth0&#x6536;packet"><b>3. </b>&#x4ECE;host-eth0&#x6536;packet</a></li><li><span class="title-icon "></span><a href="#rxtx-ring&#x7684;&#x72B6;&#x6001;"><b>4. </b>RX/Tx ring&#x7684;&#x72B6;&#x6001;</a></li><li><span class="title-icon "></span><a href="#trace-packet"><b>5. </b>trace packet</a></li><li><span class="title-icon "></span><a href="#&#x5C0F;&#x5B9E;&#x9A8C;"><b>6. </b>&#x5C0F;&#x5B9E;&#x9A8C;</a></li><ul><li><span class="title-icon "></span><a href="#&#x6846;&#x56FE;"><b>6.1. </b>&#x6846;&#x56FE;</a></li><li><span class="title-icon "></span><a href="#from-vpp2-ping-vpp3"><b>6.2. </b>from vpp2 ping vpp3</a></li><ul><li><span class="title-icon "></span><a href="#on-vpp3ping&#x7684;&#x5BF9;&#x8C61;"><b>6.2.1. </b>on vpp3(ping&#x7684;&#x5BF9;&#x8C61;)</a></li><li><span class="title-icon "></span><a href="#on-vpp2ping-&#x53D1;&#x9001;&#x65B9;"><b>6.2.2. </b>on VPP2(ping &#x53D1;&#x9001;&#x65B9;)</a></li><li><span class="title-icon "></span><a href="#&#x5206;&#x6790;"><b>6.2.3. </b>&#x5206;&#x6790;</a></li></ul><li><span class="title-icon "></span><a href="#&#x65F6;&#x95F4;&#x90FD;&#x82B1;&#x5728;&#x54EA;&#x4E86;"><b>6.3. </b>&#x65F6;&#x95F4;&#x90FD;&#x82B1;&#x5728;&#x54EA;&#x4E86;?</a></li><ul><li><span class="title-icon "></span><a href="#vpp&#x8FD0;&#x884C;&#x65F6;&#x72B6;&#x6001;"><b>6.3.1. </b>vpp&#x8FD0;&#x884C;&#x65F6;&#x72B6;&#x6001;</a></li><li><span class="title-icon "></span><a href="#&#x5173;&#x4E8E;&#x7B26;&#x53F7;"><b>6.3.2. </b>&#x5173;&#x4E8E;&#x7B26;&#x53F7;</a></li><li><span class="title-icon "></span><a href="#&#x627E;&#x5230;&#x5173;&#x952E;&#x51FD;&#x6570;"><b>6.3.3. </b>&#x627E;&#x5230;&#x5173;&#x952E;&#x51FD;&#x6570;</a></li><li><span class="title-icon "></span><a href="#&#x7B2C;&#x4E8C;&#x6B21;&#x5B9E;&#x9A8C;"><b>6.3.4. </b>&#x7B2C;&#x4E8C;&#x6B21;&#x5B9E;&#x9A8C;</a></li><li><span class="title-icon "></span><a href="#&#x6DF1;&#x5165;&#x5206;&#x6790;&#x65F6;&#x95F4;&#x6D88;&#x8017;"><b>6.3.5. </b>&#x6DF1;&#x5165;&#x5206;&#x6790;&#x65F6;&#x95F4;&#x6D88;&#x8017;</a></li></ul><li><span class="title-icon "></span><a href="#drop&#x6742;&#x5305;"><b>6.4. </b>drop&#x6742;&#x5305;</a></li></ul></ul></div><a href="#&#x521B;&#x5EFA;host-interface" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><p>&#x5728;container&#x91CC;&#x9762;&#x4F7F;&#x7528;<code>vpp -c /etc/vpp/startup.conf</code>&#x542F;&#x52A8;vpp.<br>container&#x7684;IP&#x662F;:<code>eth0 172.17.0.53/16</code></p>
<p>&#x4F7F;&#x7528;<code>vppctl create host-interface name eth0</code>&#x53EF;&#x4EE5;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;host interface <code>host-eth0</code></p>
<pre class="language-"><code>vpp# create host-interface ?
  create host-interface                    create host-interface [v2] name <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ifname</span><span class="token punctuation">&gt;</span></span> [num-rx-queues <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>n</span><span class="token punctuation">&gt;</span></span>] [num-tx-queues <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>n</span><span class="token punctuation">&gt;</span></span>] [hw-addr <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mac-addr</span><span class="token punctuation">&gt;</span></span>] [mode ip] [qdisc-bypass-disable] [cksum-gso-disable]
</code></pre><p>&#x6309;&#x7167;&#x8FD9;&#x4E2A;&#x547D;&#x4EE4;&#x7684;<a href="https://s3-docs.fd.io/vpp/24.10/cli-reference/interface/create_interface.html" target="_blank">&#x89E3;&#x91CA;</a>:</p>
<blockquote>
<p>Create a host interface that will attach to a linux AF_PACKET interface, one side of a veth pair. The veth pair must already exist. Once created, a new host interface will exist in VPP with the name &apos;host-<ifname>&apos;, where &apos;<ifname>&apos; is the name of the specified veth pair. Use the show interface command to display host interface details.</ifname></ifname></p>
</blockquote>
<p>&#x672C;&#x8D28;&#x4E0A;, host-interface host&#x662F;&#x5728;eth0&#x4E0A;&#x7684;&#x4E00;&#x4E2A;<code>AF_PACKET</code>&#x7684;<code>SOCK_RAW</code> socket.</p>
<p>&#x4E0B;&#x9762;&#x4ECE;&#x4EE3;&#x7801;&#x6D41;&#x7A0B;&#x4E0A;&#x89E3;&#x8BFB;&#x4E00;&#x4E0B;&#x8FD9;&#x4E2A;host interface.</p>
<ul>
<li><a href="#&#x521B;&#x5EFA;host-interface">&#x521B;&#x5EFA;host interface</a></li>
<li><a href="#&#x53D1;&#x9001;packet&#x5230;host-eth0">&#x53D1;&#x9001;packet&#x5230;host-eth0</a></li>
<li><a href="#&#x4ECE;host-eth0&#x6536;packet">&#x4ECE;host-eth0&#x6536;packet</a></li>
<li><a href="#rxtx-ring&#x7684;&#x72B6;&#x6001;">RX/Tx ring&#x7684;&#x72B6;&#x6001;</a></li>
<li><a href="#trace-packet">trace packet</a></li>
<li><a href="#&#x5C0F;&#x5B9E;&#x9A8C;">&#x5C0F;&#x5B9E;&#x9A8C;</a><ul>
<li><a href="#&#x6846;&#x56FE;">&#x6846;&#x56FE;</a></li>
<li><a href="#from-vpp2-ping-vpp3">from vpp2 ping vpp3</a><ul>
<li><a href="#on-vpp3ping&#x7684;&#x5BF9;&#x8C61;">on vpp3(ping&#x7684;&#x5BF9;&#x8C61;)</a></li>
<li><a href="#on-vpp2ping-&#x53D1;&#x9001;&#x65B9;">on VPP2(ping &#x53D1;&#x9001;&#x65B9;)</a></li>
<li><a href="#&#x5206;&#x6790;">&#x5206;&#x6790;</a></li>
</ul>
</li>
<li><a href="#&#x4E3A;&#x4EC0;&#x4E48;tcpdump&#x6293;&#x4E0D;&#x5230;outgoing&#x7684;&#x62A5;&#x6587;">&#x4E3A;&#x4EC0;&#x4E48;tcpdump&#x6293;&#x4E0D;&#x5230;outgoing&#x7684;&#x62A5;&#x6587;</a></li>
<li><a href="#&#x65F6;&#x95F4;&#x90FD;&#x82B1;&#x5728;&#x54EA;&#x4E86;">&#x65F6;&#x95F4;&#x90FD;&#x82B1;&#x5728;&#x54EA;&#x4E86;?</a><ul>
<li><a href="#vpp&#x8FD0;&#x884C;&#x65F6;&#x72B6;&#x6001;">vpp&#x8FD0;&#x884C;&#x65F6;&#x72B6;&#x6001;</a></li>
<li><a href="#&#x5173;&#x4E8E;&#x7B26;&#x53F7;">&#x5173;&#x4E8E;&#x7B26;&#x53F7;</a></li>
<li><a href="#&#x627E;&#x5230;&#x5173;&#x952E;&#x51FD;&#x6570;">&#x627E;&#x5230;&#x5173;&#x952E;&#x51FD;&#x6570;</a><ul>
<li><a href="#&#x7B2C;&#x4E00;&#x6B21;&#x5B9E;&#x9A8C;">&#x7B2C;&#x4E00;&#x6B21;&#x5B9E;&#x9A8C;</a></li>
</ul>
</li>
<li><a href="#&#x7B2C;&#x4E8C;&#x6B21;&#x5B9E;&#x9A8C;">&#x7B2C;&#x4E8C;&#x6B21;&#x5B9E;&#x9A8C;</a><ul>
<li><a href="#&#x5206;&#x6790;-1">&#x5206;&#x6790;</a></li>
<li><a href="#&#x7ED3;&#x8BBA;">&#x7ED3;&#x8BBA;</a></li>
</ul>
</li>
<li><a href="#&#x6DF1;&#x5165;&#x5206;&#x6790;&#x65F6;&#x95F4;&#x6D88;&#x8017;">&#x6DF1;&#x5165;&#x5206;&#x6790;&#x65F6;&#x95F4;&#x6D88;&#x8017;</a><ul>
<li><a href="#&#x7ED3;&#x8BBA;-1">&#x7ED3;&#x8BBA;</a></li>
<li><a href="#&#x4E3A;&#x4EC0;&#x4E48;epoll&#x8981;&#x8FD9;&#x4E48;&#x4E45;">&#x4E3A;&#x4EC0;&#x4E48;epoll&#x8981;&#x8FD9;&#x4E48;&#x4E45;?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#drop&#x6742;&#x5305;">drop&#x6742;&#x5305;</a></li>
</ul>
</li>
</ul>
<h1 id="&#x521B;&#x5EFA;host-interface"><a name="&#x521B;&#x5EFA;host-interface" class="anchor-navigation-ex-anchor" href="#&#x521B;&#x5EFA;host-interface"><i class="fa fa-link" aria-hidden="true"></i></a>1. &#x521B;&#x5EFA;host interface</h1>
<p>&#x5728;<code>src/plugins/af_packet/cli.c</code>&#x4E2D;, &#x6CE8;&#x518C;<code>create host-interface</code>&#x547D;&#x4EE4;:</p>
<pre class="language-"><code class="lang-c"><span class="token function">VLIB_CLI_COMMAND</span> <span class="token punctuation">(</span>af_packet_create_command<span class="token punctuation">,</span> <span class="token keyword">static</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token string">&quot;create host-interface&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span>short_help <span class="token operator">=</span> <span class="token string">&quot;create host-interface [v2] name &lt;ifname&gt; [num-rx-queues &lt;n&gt;] &quot;</span>
        <span class="token string">&quot;[num-tx-queues &lt;n&gt;] [hw-addr &lt;mac-addr&gt;] [mode ip] &quot;</span>
        <span class="token string">&quot;[qdisc-bypass-disable] [cksum-gso-disable]&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span>function <span class="token operator">=</span> af_packet_create_command_fn<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x547D;&#x4EE4;&#x652F;&#x6301;&#x4E00;&#x4E0B;&#x7684;&#x9009;&#x9879;:</p>
<ul>
<li><code>name %s</code></li>
<li><code>rx-size %u</code></li>
<li><code>tx-size %u</code></li>
<li><code>rx-per-block %u</code></li>
<li><code>tx-per-block %u</code></li>
<li><code>num-rx-queues %u</code>: &#x9ED8;&#x8BA4;1. &#x4E00;&#x4E2A;queue&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;socket</li>
<li><code>num-tx-queues %u</code>: &#x9ED8;&#x8BA4;1. &#x4E00;&#x4E2A;queue&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;socket</li>
<li><code>qdisc-bypass-disable</code>: &#x9ED8;&#x8BA4;enable qdiscipline bypass</li>
<li><code>cksum-gso-disable</code>: &#x9ED8;&#x8BA4;enable gso chksum</li>
<li><code>mode ip</code>: &#x9ED8;&#x8BA4;&#x662F;AF_PACKET_IF_MODE_ETHERNET, &#x5982;&#x679C;&#x662F;ip&#x6A21;&#x5F0F;&#x7684;&#x8BDD;, &#x770B;&#x4E0D;&#x5230;&#x4E8C;&#x5C42;&#x5934;</li>
<li><code>v2</code>: &#x9ED8;&#x8BA4;&#x662F;TPACKET_V3</li>
<li><code>hw-addr %U</code></li>
</ul>
<p>&#x7B80;&#x8981;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code class="lang-c">af_packet_create_if
<span class="token comment">//1. &#x5BF9;&#x5E94;&#x7684;host interface&#x5FC5;&#x987B;up</span>
<span class="token comment">//2. &#x6807;&#x8BB0;&#x662F;&#x5426;bridge</span>
<span class="token comment">//3. &#x4E3A;&#x6BCF;&#x4E2A;queue&#x90FD;&#x521B;&#x5EFA;</span>
    af_packet_device_init
        <span class="token keyword">for</span> each queue
            af_packet_queue_init
                create_packet_sock
                    <span class="token comment">//new a socket</span>
                    fd <span class="token operator">=</span> <span class="token function">socket</span> <span class="token punctuation">(</span>AF_PACKET<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> <span class="token function">htons</span> <span class="token punctuation">(</span>ETH_P_ALL<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment">//bind rx packet socket</span>
                    <span class="token function">bind</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>sll<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>sll<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment">//set rx packet interface version</span>
                    <span class="token function">setsockopt</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> SOL_PACKET<span class="token punctuation">,</span> PACKET_VERSION<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ver<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>ver<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment">//set packet tx ring</span>
                    <span class="token function">setsockopt</span> <span class="token punctuation">(</span>fd<span class="token punctuation">,</span> SOL_PACKET<span class="token punctuation">,</span> PACKET_LOSS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>opt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>opt<span class="token punctuation">)</span>
                    <span class="token comment">//set packet vnet hdr</span>
                    <span class="token function">setsockopt</span> <span class="token punctuation">(</span>fd<span class="token punctuation">,</span> SOL_PACKET<span class="token punctuation">,</span> PACKET_VNET_HDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>opt2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>opt2<span class="token punctuation">)</span>
                    <span class="token comment">//set qdisc bypass</span>
                    <span class="token function">setsockopt</span> <span class="token punctuation">(</span>fd<span class="token punctuation">,</span> SOL_PACKET<span class="token punctuation">,</span> PACKET_QDISC_BYPASS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>opt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>opt<span class="token punctuation">)</span>
                    <span class="token comment">//set fanout options</span>
                    <span class="token function">setsockopt</span> <span class="token punctuation">(</span><span class="token operator">*</span>fd<span class="token punctuation">,</span> SOL_PACKET<span class="token punctuation">,</span> PACKET_FANOUT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fanout<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>fanout<span class="token punctuation">)</span>
                    <span class="token comment">//set packet rx ring</span>
                    <span class="token function">setsockopt</span> <span class="token punctuation">(</span><span class="token operator">*</span>fd<span class="token punctuation">,</span> SOL_PACKET<span class="token punctuation">,</span> PACKET_RX_RING<span class="token punctuation">,</span> rx_req<span class="token punctuation">,</span> req_sz<span class="token punctuation">)</span>
                    <span class="token comment">//set packet tx ring options</span>
                    <span class="token function">setsockopt</span> <span class="token punctuation">(</span><span class="token operator">*</span>fd<span class="token punctuation">,</span> SOL_PACKET<span class="token punctuation">,</span> PACKET_TX_RING<span class="token punctuation">,</span> tx_req<span class="token punctuation">,</span> req_sz<span class="token punctuation">)</span>
                    <span class="token comment">//mmap fd &#x5230;tx/rx queue, &#x8FD9;&#x4E9B;queue&#x662F;vpp&#x7EF4;&#x62A4;&#x7684;</span>
                    ring<span class="token operator">-&gt;</span>ring_start_addr <span class="token operator">=</span> <span class="token function">mmap</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> ring_sz<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED <span class="token operator">|</span> MAP_LOCKED<span class="token punctuation">,</span> <span class="token operator">*</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">vec_add1</span> <span class="token punctuation">(</span>apif<span class="token operator">-&gt;</span>fds<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">vec_add1</span> <span class="token punctuation">(</span>apif<span class="token operator">-&gt;</span>rings<span class="token punctuation">,</span> ring<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h1 id="&#x53D1;&#x9001;packet&#x5230;host-eth0"><a name="&#x53D1;&#x9001;packet&#x5230;host-eth0" class="anchor-navigation-ex-anchor" href="#&#x53D1;&#x9001;packet&#x5230;host-eth0"><i class="fa fa-link" aria-hidden="true"></i></a>2. &#x53D1;&#x9001;packet&#x5230;host-eth0</h1>
<p>&#x5728;<code>src/plugins/af_packet/device.c</code>&#x91CC;&#x6CE8;&#x518C;&#x4E86;tx&#x76F8;&#x5173;&#x7684;&#x51FD;&#x6570;</p>
<pre class="language-"><code class="lang-c"><span class="token function">VNET_DEVICE_CLASS</span> <span class="token punctuation">(</span>af_packet_device_class<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;af-packet&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span>format_device_name <span class="token operator">=</span> format_af_packet_device_name<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>format_device <span class="token operator">=</span> format_af_packet_device<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>format_tx_trace <span class="token operator">=</span> format_af_packet_tx_trace<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>tx_function_n_errors <span class="token operator">=</span> AF_PACKET_TX_N_ERROR<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>tx_function_error_strings <span class="token operator">=</span> af_packet_tx_func_error_strings<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>rx_redirect_to_node <span class="token operator">=</span> af_packet_set_interface_next_node<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>clear_counters <span class="token operator">=</span> af_packet_clear_hw_interface_counters<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>admin_up_down_function <span class="token operator">=</span> af_packet_interface_admin_up_down<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>mac_addr_change_function <span class="token operator">=</span> af_packet_set_mac_address_function<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>rx_mode_change_function <span class="token operator">=</span> af_packet_interface_rx_mode_change<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;<code>af_packet_device_class</code>&#x7684;&#x7B80;&#x8981;&#x5B9A;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code class="lang-c"><span class="token function">VNET_DEVICE_CLASS_TX_FN</span> <span class="token punctuation">(</span>af_packet_device_class<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">vlib_main_t</span> <span class="token operator">*</span> vm<span class="token punctuation">,</span>
                          <span class="token class-name">vlib_node_runtime_t</span> <span class="token operator">*</span> node<span class="token punctuation">,</span>
                          <span class="token class-name">vlib_frame_t</span> <span class="token operator">*</span> frame<span class="token punctuation">)</span>
    <span class="token class-name">vnet_hw_if_tx_frame_t</span> <span class="token operator">*</span>tf <span class="token operator">=</span> <span class="token function">vlib_frame_scalar_args</span> <span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u16 queue_id <span class="token operator">=</span> tf<span class="token operator">-&gt;</span>queue_id<span class="token punctuation">;</span>
    <span class="token comment">//&#x627E;&#x5230;tx_queue</span>
    <span class="token class-name">af_packet_queue_t</span> <span class="token operator">*</span>tx_queue <span class="token operator">=</span> <span class="token function">vec_elt_at_index</span> <span class="token punctuation">(</span>apif<span class="token operator">-&gt;</span>tx_queues<span class="token punctuation">,</span> queue_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//&#x9700;&#x8981;&#x53D1;&#x9001;&#x7684;frame&#x7684;&#x5927;&#x5C0F;&#x548C;&#x4E2A;&#x6570;</span>
    frame_size <span class="token operator">=</span> tx_queue<span class="token operator">-&gt;</span>tx_req<span class="token operator">-&gt;</span>req<span class="token punctuation">.</span>tp_frame_size<span class="token punctuation">;</span>
    frame_num <span class="token operator">=</span> tx_queue<span class="token operator">-&gt;</span>tx_req<span class="token operator">-&gt;</span>req<span class="token punctuation">.</span>tp_frame_nr<span class="token punctuation">;</span>
    <span class="token comment">//tx ring&#x7684;&#x8D77;&#x59CB;&#x5730;&#x5740;&#x548C;&#x5F85;&#x53D1;&#x9001;&#x7684;frame</span>
    block_start <span class="token operator">=</span> tx_queue<span class="token operator">-&gt;</span>tx_ring<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    tx_frame <span class="token operator">=</span> tx_queue<span class="token operator">-&gt;</span>next_tx_frame<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>n_left<span class="token punctuation">)</span>
        <span class="token comment">//&#x627E;&#x5230;&#x5F85;&#x53D1;&#x9001;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;header</span>
        tph3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">tpacket3_hdr_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>block_start <span class="token operator">+</span> tx_frame <span class="token operator">*</span> frame_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x68C0;&#x67E5;&#x72B6;&#x6001;</span>
        <span class="token comment">//&#x5982;&#x679C;&#x662F;tph3-&gt;tp_status&#x662F;TP_STATUS_SEND_REQUEST | TP_STATUS_SENDING&#x5C31;break</span>

        <span class="token comment">//&#x8BA1;&#x7B97;&#x597D;&#x9700;&#x8981;memcpy&#x7684;&#x4F4D;&#x7F6E;&#x548C;&#x5927;&#x5C0F;&#x540E;, &#x505A;memcpy</span>
        <span class="token comment">//&#x6CE8;&#x610F;memcpy&#x662F;&#x5728;while&#x91CC;&#x8FDB;&#x884C;&#x7684;, &#x6BCF;&#x4E2A;frame&#x53EF;&#x80FD;&#x662F;&#x591A;&#x4E2A;&#x79BB;&#x6563;&#x7684;buffer, &#x8FD9;&#x4E9B;buffer&#x90FD;&#x6709;VLIB_BUFFER_NEXT_PRESENT&#x6807;&#x8BB0;</span>
        <span class="token function">clib_memcpy_fast</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span> tph3 <span class="token operator">+</span> tpacket_align <span class="token operator">+</span> offset<span class="token punctuation">,</span> <span class="token function">vlib_buffer_get_current</span> <span class="token punctuation">(</span>b0<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//&#x7F6E;TP_STATUS_SEND_REQUEST&#x6807;&#x8BB0;</span>
        tph2<span class="token operator">-&gt;</span>tp_len <span class="token operator">=</span> tph2<span class="token operator">-&gt;</span>tp_snaplen <span class="token operator">=</span> offset<span class="token punctuation">;</span>
        tph2<span class="token operator">-&gt;</span>tp_status <span class="token operator">=</span> TP_STATUS_SEND_REQUEST<span class="token punctuation">;</span>
    <span class="token comment">//&#x524D;&#x9762;&#x5728;&#x5FAA;&#x73AF;&#x91CC;memcpy&#x6BCF;&#x4E2A;frame&#x540E;, &#x5728;&#x5176;header&#x91CC;&#x9762;&#x7F6E;&#x4F4D;tph3-&gt;tp_status = TP_STATUS_SEND_REQUEST</span>
    <span class="token comment">//&#x9A6C;&#x4E0A;&#x8C03;&#x7528;sendto&#x901A;&#x77E5;kernel&#x53BB;&#x89E6;&#x53D1;&#x5E95;&#x5C42;driver&#x7684;&#x53D1;&#x9001;&#x51FD;&#x6570;&#x771F;&#x6B63;&#x53D1;&#x9001;packet</span>
    <span class="token function">sendto</span> <span class="token punctuation">(</span>tx_queue<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MSG_DONTWAIT<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x4E0B;&#x6765;</p>
<ul>
<li>mmap + memcpy&#x7684;&#x4F5C;&#x7528;&#x662F;&#x907F;&#x514D;&#x7B2C;&#x4E8C;&#x6B21;&#x5185;&#x5B58;&#x62F7;&#x8D1D;, &#x5373;&#x5982;&#x679C;&#x4F7F;&#x7528;send&#x7B49;&#x51FD;&#x6570;&#x5E26;&#x6765;&#x7684;&#x4ECE;&#x7528;&#x6237;&#x6001;&#x5230;&#x5185;&#x6838;&#x6001;&#x7684;&#x5185;&#x5B58;&#x62F7;&#x8D1D;.</li>
<li>&#x8FD8;&#x662F;&#x8981;&#x8C03;&#x7528;<code>sendto()</code>&#x6765;trigger&#x5185;&#x6838;&#x505A;&#x771F;&#x6B63;&#x7684;<code>dev_xmit()</code>.</li>
</ul>
<p><code>/usr/include/linux/if_packet.h</code>&#x91CC;&#x9762;&#x5B9A;&#x4E49;&#x4E86;<code>tpacket3_hdr</code></p>
<blockquote>
<p>The tpacket3_hdr structure is part of the Linux AF_PACKET socket family, specifically for version 3 (TPACKET_V3) of the packet mmap ring buffer. This structure provides the necessary metadata for each packet in the ring buffer, allowing user-space applications to interface efficiently with the kernel for high-speed packet capture and transmission.</p>
</blockquote>
<pre class="language-"><code class="lang-c"><span class="token keyword">struct</span> <span class="token class-name">tpacket3_hdr</span> <span class="token punctuation">{</span>
    __u32        tp_next_offset<span class="token punctuation">;</span>
    __u32        tp_sec<span class="token punctuation">;</span>
    __u32        tp_nsec<span class="token punctuation">;</span>
    __u32        tp_snaplen<span class="token punctuation">;</span>
    __u32        tp_len<span class="token punctuation">;</span>
    __u32        tp_status<span class="token punctuation">;</span>
    __u16        tp_mac<span class="token punctuation">;</span>
    __u16        tp_net<span class="token punctuation">;</span>
    <span class="token comment">/* pkt_hdr variants */</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">tpacket_hdr_variant1</span> hv1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    __u8        tp_padding<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h1 id="&#x4ECE;host-eth0&#x6536;packet"><a name="&#x4ECE;host-eth0&#x6536;packet" class="anchor-navigation-ex-anchor" href="#&#x4ECE;host-eth0&#x6536;packet"><i class="fa fa-link" aria-hidden="true"></i></a>3. &#x4ECE;host-eth0&#x6536;packet</h1>
<p>&#x5728;<code>src/plugins/af_packet/node.c</code></p>
<pre class="language-"><code class="lang-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
  u32 dev_instance<span class="token punctuation">;</span>
  u32 queue_id<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">vnet_hw_if_rxq_poll_vector_t</span><span class="token punctuation">;</span>

<span class="token function">VLIB_NODE_FN</span> <span class="token punctuation">(</span>af_packet_input_node<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">vlib_main_t</span> <span class="token operator">*</span> vm<span class="token punctuation">,</span>
                     <span class="token class-name">vlib_node_runtime_t</span> <span class="token operator">*</span> node<span class="token punctuation">,</span>
                     <span class="token class-name">vlib_frame_t</span> <span class="token operator">*</span> frame<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  u32 n_rx_packets <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token class-name">af_packet_main_t</span> <span class="token operator">*</span>apm <span class="token operator">=</span> <span class="token operator">&amp;</span>af_packet_main<span class="token punctuation">;</span>
  <span class="token class-name">vnet_hw_if_rxq_poll_vector_t</span> <span class="token operator">*</span>pv<span class="token punctuation">;</span>
  <span class="token comment">//&#x8FD9;&#x4E2A;pv&#x5E94;&#x8BE5;&#x662F;&#x4E2A;&#x53EF;&#x53D8;&#x6570;&#x7EC4;, &#x5143;&#x7D20;&#x662F;&#x4E0A;&#x9762;&#x7684;vnet_hw_if_rxq_poll_vector_t, &#x4EE3;&#x8868;&#x4E00;&#x4E2A;queue&#x6709;interrupt&#x5230;&#x6765;&#x4E86;</span>
  pv <span class="token operator">=</span> <span class="token function">vnet_hw_if_get_rxq_poll_vector</span> <span class="token punctuation">(</span>vm<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">vec_len</span> <span class="token punctuation">(</span>pv<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token class-name">af_packet_if_t</span> <span class="token operator">*</span>apif<span class="token punctuation">;</span>
      apif <span class="token operator">=</span> <span class="token function">vec_elt_at_index</span> <span class="token punctuation">(</span>apm<span class="token operator">-&gt;</span>interfaces<span class="token punctuation">,</span> pv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dev_instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>apif<span class="token operator">-&gt;</span>is_admin_up<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>apif<span class="token operator">-&gt;</span>is_cksum_gso_enabled<span class="token punctuation">)</span>
        n_rx_packets <span class="token operator">+=</span> <span class="token function">af_packet_device_input_fn</span> <span class="token punctuation">(</span>vm<span class="token punctuation">,</span> node<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> apif<span class="token punctuation">,</span>
                               pv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>queue_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span>
        n_rx_packets <span class="token operator">+=</span> <span class="token function">af_packet_device_input_fn</span> <span class="token punctuation">(</span>vm<span class="token punctuation">,</span> node<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> apif<span class="token punctuation">,</span>
                               pv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>queue_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">return</span> n_rx_packets<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">VLIB_REGISTER_NODE</span> <span class="token punctuation">(</span>af_packet_input_node<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;af-packet-input&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span>flags <span class="token operator">=</span> VLIB_NODE_FLAG_TRACE_SUPPORTED<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>sibling_of <span class="token operator">=</span> <span class="token string">&quot;device-input&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span>format_trace <span class="token operator">=</span> format_af_packet_input_trace<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>type <span class="token operator">=</span> VLIB_NODE_TYPE_INPUT<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>state <span class="token operator">=</span> VLIB_NODE_STATE_INTERRUPT<span class="token punctuation">,</span> <span class="token comment">//interrupt&#x6A21;&#x5F0F;, &#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x6A21;&#x5F0F;&#x662F;VLIB_NODE_FLAG_ADAPTIVE_MODE</span>
  <span class="token punctuation">.</span>n_errors <span class="token operator">=</span> AF_PACKET_INPUT_N_ERROR<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>error_strings <span class="token operator">=</span> af_packet_input_error_strings<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>vpp&#x6846;&#x67B6;&#x8C03;&#x7528;&#x5230;<code>af_packet_input_node</code>&#x7684;&#x65F6;&#x5019;, &#x8BF4;&#x660E;incoming&#x7684;packet&#x5DF2;&#x7ECF;&#x5230;&#x6765;&#x4E86;, &#x6211;&#x731C;&#x4E5F;&#x662F;&#x901A;&#x8FC7;epoll&#x7B49;&#x673A;&#x5236;kernel&#x901A;&#x77E5;vpp&#x6846;&#x67B6;&#x7684;. &#x56E0;&#x4E3A;&#x4E00;&#x4E2A;interface&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x4E2A;queue, &#x6240;&#x4EE5;&#x5728;&#x4E00;&#x4E2A;for&#x5FAA;&#x73AF;&#x91CC;&#x5BF9;&#x6BCF;&#x4E2A;queue&#x8C03;&#x7528;<code>af_packet_device_input_fn</code></p>
<p><code>af_packet_device_input_fn</code>&#x662F;&#x6838;&#x5FC3;&#x7684;&#x6536;&#x62A5;&#x6587;&#x51FD;&#x6570;, &#x6BD4;&#x8F83;&#x590D;&#x6742;, &#x5927;&#x81F4;&#x4E0A;&#x5C31;&#x662F;&#x4ECE;kernel&#x7684;socket buffer&#x91CC;&#x9762;, &#x62F7;&#x8D1D;&#x5230;vpp&#x7684;buffer&#x91CC;</p>
<pre class="language-"><code class="lang-c"><span class="token comment">//&#x5148;&#x7533;&#x8BF7;frame</span>
<span class="token function">vlib_get_next_frame</span> <span class="token punctuation">(</span>vm<span class="token punctuation">,</span> node<span class="token punctuation">,</span> next_index<span class="token punctuation">,</span> to_next<span class="token punctuation">,</span> n_left_to_next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//&#x62F7;&#x8D1D;packet</span>
<span class="token function">clib_memcpy_fast</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">vlib_buffer_get_current</span> <span class="token punctuation">(</span>b0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> bytes_copied <span class="token operator">+</span> vlan_len<span class="token punctuation">,</span>     <span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span> tph <span class="token operator">+</span> tph<span class="token operator">-&gt;</span>tp_mac <span class="token operator">+</span> offset <span class="token operator">+</span> bytes_copied<span class="token punctuation">,</span><span class="token punctuation">(</span>bytes_to_copy <span class="token operator">-</span> bytes_copied<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//&#x8FD9;&#x91CC;&#x5E94;&#x8BE5;&#x662F;&#x5F80;vpp&#x4E0A;&#x5C42;&#x7684;&#x534F;&#x8BAE;&#x6808;&#x8D70;&#x4E86;</span>
<span class="token function">vlib_put_next_frame</span> <span class="token punctuation">(</span>vm<span class="token punctuation">,</span> node<span class="token punctuation">,</span> next_index<span class="token punctuation">,</span> n_left_to_next<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h1 id="rxtx-ring&#x7684;&#x72B6;&#x6001;"><a name="rxtx-ring&#x7684;&#x72B6;&#x6001;" class="anchor-navigation-ex-anchor" href="#rxtx-ring&#x7684;&#x72B6;&#x6001;"><i class="fa fa-link" aria-hidden="true"></i></a>4. RX/Tx ring&#x7684;&#x72B6;&#x6001;</h1>
<p>&#x5728;<code>/usr/include/linux/if_packet.h</code>&#x6709;&#x5B9A;&#x4E49;:</p>
<pre class="language-"><code class="lang-c"><span class="token comment">/* Rx ring - header status */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_KERNEL</span>              <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_USER</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_COPY</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_LOSING</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_CSUMNOTREADY</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_VLAN_VALID</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> </span><span class="token comment">/* auxdata has valid tp_vlan_tci */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_BLK_TMO</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_VLAN_TPID_VALID</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> </span><span class="token comment">/* auxdata has valid tp_vlan_tpid */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_CSUM_VALID</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_GSO_TCP</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* Tx ring - header status */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_AVAILABLE</span>          <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_SEND_REQUEST</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_SENDING</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_WRONG_FORMAT</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* Rx and Tx ring - header status */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_TS_SOFTWARE</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">29</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_TS_SYS_HARDWARE</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span> </span><span class="token comment">/* deprecated, never set */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TP_STATUS_TS_RAW_HARDWARE</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token number">1U</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">)</span></span></span>
</code></pre>
<h1 id="trace-packet"><a name="trace-packet" class="anchor-navigation-ex-anchor" href="#trace-packet"><i class="fa fa-link" aria-hidden="true"></i></a>5. trace packet</h1>
<p><code>vppctl trace add</code>&#x547D;&#x4EE4;&#x53EF;&#x4EE5;&#x8FFD;&#x8E2A;&#x62A5;&#x6587;, &#x4F46;&#x548C;<code>tcpdump</code>&#x4E0D;&#x592A;&#x4E00;&#x6837;:</p>
<ul>
<li>trace&#x4E0D;&#x662F;&#x9488;&#x5BF9;interface&#x7684;, &#x800C;&#x662F;&#x9488;&#x5BF9;input node&#x7684;, &#x652F;&#x6301;&#x7684;node&#x6709;<ul>
<li>af-packet-input: &#x4E3B;&#x8981;&#x662F;veth, &#x4E5F;&#x53EF;&#x4EE5;&#x662F;&#x4EFB;&#x4F55;&#x57FA;&#x4E8E;AF_PACKET&#x7C7B;&#x578B;&#x7684;socket&#x7684;input</li>
<li>virtio-input: tap v2</li>
<li>tapcli-rx: tap v1</li>
<li>dpdk-input: dpdk, gbe, phys*</li>
</ul>
</li>
<li>&#x6B63;&#x5982;trace&#x8FD9;&#x4E2A;&#x540D;&#x5B57;&#x6240;&#x8BF4;, trace&#x4F1A;&quot;&#x8FFD;&#x8E2A;&quot;input packet&#x7684;&#x6574;&#x4E2A;&#x5904;&#x7406;&#x8DEF;&#x5F84;, &#x6BCF;&#x4E2A;&#x8DEF;&#x5F84;&#x4E0B;&#x7684;node&#x90FD;&#x6709;&#x65F6;&#x95F4;&#x6233;, &#x65B9;&#x4FBF;&#x5206;&#x6790;&#x6027;&#x80FD;.</li>
</ul>
<p>&#x5B8C;&#x6574;&#x7684;&#x652F;&#x6301;trace&#x7684;node&#x5217;&#x8868;:</p>
<ul>
<li>af-packet-input</li>
<li>avf-input</li>
<li>bond-process</li>
<li>dpdk-crypto-input</li>
<li>dpdk-input</li>
<li>handoff-trace</li>
<li>ixge-input</li>
<li>memif-input</li>
<li>mrvl-pp2-input</li>
<li>netmap-input</li>
<li>p2p-ethernet-input</li>
<li>pg-input</li>
<li>punt-socket-rx</li>
<li>rdma-input</li>
<li>session-queue</li>
<li>tuntap-rx</li>
<li>vhost-user-input</li>
<li>virtio-input</li>
<li>vmxnet3-input</li>
</ul>
<p>&#x8FD9;&#x91CC;&#x7684;<code>af-packet-input</code>&#x5C31;&#x662F;&#x4F7F;&#x7528;<code>AF_PACKET</code> raw socket over host interface&#x7684;node, &#x5728;&#x4E0A;&#x9762;&#x7684;node&#x58F0;&#x660E;&#x4E2D;, &#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6709;<code>VLIB_NODE_FLAG_TRACE_SUPPORTED</code>&#x6807;&#x8BB0;</p>
<pre class="language-"><code class="lang-c"><span class="token function">VLIB_REGISTER_NODE</span> <span class="token punctuation">(</span>af_packet_input_node<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;af-packet-input&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span>flags <span class="token operator">=</span> VLIB_NODE_FLAG_TRACE_SUPPORTED<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>sibling_of <span class="token operator">=</span> <span class="token string">&quot;device-input&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span>format_trace <span class="token operator">=</span> format_af_packet_input_trace<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>type <span class="token operator">=</span> VLIB_NODE_TYPE_INPUT<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>state <span class="token operator">=</span> VLIB_NODE_STATE_INTERRUPT<span class="token punctuation">,</span> <span class="token comment">//interrupt&#x6A21;&#x5F0F;, &#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x6A21;&#x5F0F;&#x662F;VLIB_NODE_FLAG_ADAPTIVE_MODE</span>
  <span class="token punctuation">.</span>n_errors <span class="token operator">=</span> AF_PACKET_INPUT_N_ERROR<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>error_strings <span class="token operator">=</span> af_packet_input_error_strings<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x5177;&#x4F53;&#x7528;&#x6CD5;&#x5728;<a href="https://s3-docs.fd.io/vpp/24.06/gettingstarted/progressivevpp/traces.html" target="_blank">&#x5B98;&#x65B9;&#x6587;&#x6863;</a></p>
<p>&#x53C2;&#x8003;contiv&#x7684;<a href="https://fdio-vpp.readthedocs.io/en/latest/usecases/contiv/VPPTRACE.html" target="_blank">&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;</a></p>
<p>&#x6211;&#x7684;&#x4F8B;&#x5B50;</p>
<pre class="language-"><code class="lang-shell">vpp<span class="token comment"># trace add af-packet-input 100</span>
vpp<span class="token comment"># ping 10.10.10.12</span>
vpp<span class="token comment"># show trace</span>
</code></pre>
<h1 id="&#x5C0F;&#x5B9E;&#x9A8C;"><a name="&#x5C0F;&#x5B9E;&#x9A8C;" class="anchor-navigation-ex-anchor" href="#&#x5C0F;&#x5B9E;&#x9A8C;"><i class="fa fa-link" aria-hidden="true"></i></a>6. &#x5C0F;&#x5B9E;&#x9A8C;</h1>
<p>&#x7528;&#x5230;&#x7684;&#x547D;&#x4EE4;</p>
<pre class="language-"><code class="lang-shell">vppctl create host-interface name eth0
vppctl <span class="token builtin class-name">set</span> interface state host-eth0 up
vppctl <span class="token builtin class-name">set</span> interface <span class="token function">ip</span> address host-eth0 <span class="token number">10.10</span>.10.11/24

vpp<span class="token comment"># trace add af-packet-input 100</span>

vpp<span class="token comment"># show int addr</span>
host-eth0 <span class="token punctuation">(</span>up<span class="token punctuation">)</span>:
  L3 <span class="token number">10.10</span>.10.11/24
local0 <span class="token punctuation">(</span>dn<span class="token punctuation">)</span>:

vpp<span class="token comment"># show hardware-interfaces</span>
              Name                Idx   Link  Hardware
host-eth0                          <span class="token number">1</span>     up   host-eth0
  Link speed: unknown
  RX Queues:
    queue thread         mode
    <span class="token number">0</span>     main <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>       interrupt
  TX Queues:
    TX Hash: <span class="token punctuation">[</span>name: hash-eth-l34 priority: <span class="token number">50</span> description: Hash ethernet L34 headers<span class="token punctuation">]</span>
    queue shared thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token number">0</span>     no     <span class="token number">0</span>
  Ethernet address 02:fe:12:85:26:b8
  Linux PACKET socket interface v3
  FEATURES:
    qdisc-bpass-enabled
    cksum-gso-enabled
  RX Queue <span class="token number">0</span>:
    block size:65536 nr:160  frame size:2048 nr:5120 next block:133
  TX Queue <span class="token number">0</span>:
    block size:69206016 nr:1  frame size:67584 nr:1024 next frame:312
    available:1024 request:0 sending:0 wrong:0 total:1024
local0                             <span class="token number">0</span>    down  local0
  Link speed: unknown
  <span class="token builtin class-name">local</span>
</code></pre>
<h2 id="&#x6846;&#x56FE;"><a name="&#x6846;&#x56FE;" class="anchor-navigation-ex-anchor" href="#&#x6846;&#x56FE;"><i class="fa fa-link" aria-hidden="true"></i></a>6.1. &#x6846;&#x56FE;</h2>
<pre class="language-"><code>

    &#x250C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2510;          &#x250C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2510;       
    &#x2502;  Container2(vpp2)                               &#x2502;          &#x2502;  Container3(vpp3)                               &#x2502;       
    &#x2502;                                                 &#x2502;          &#x2502;                                                 &#x2502;       
    &#x2502;                                                 &#x2502;          &#x2502;                                                 &#x2502;       
    &#x2502;        &#x250C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2510;      &#x2502;          &#x2502;        &#x250C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2510;      &#x2502;       
    &#x2502;        &#x2502;VPP                              &#x2502;      &#x2502;          &#x2502;        &#x2502;VPP                              &#x2502;      &#x2502;       
    &#x2502;        &#x2502;                                 &#x2502;      &#x2502;          &#x2502;        &#x2502;                                 &#x2502;      &#x2502;       
    &#x2502;        &#x2502;                                 &#x2502;      &#x2502;          &#x2502;        &#x2502;                                 &#x2502;      &#x2502;       
    &#x2502;        &#x2502;          host-eth0              &#x2502;      &#x2502;          &#x2502;        &#x2502;          host-eth0              &#x2502;      &#x2502;       
    &#x2502;        &#x2502;          10.10.10.11/24         &#x2502;      &#x2502;          &#x2502;        &#x2502;          10.10.10.12/24         &#x2502;      &#x2502;       
    &#x2502;        &#x2502;          02:fe:12:85:26:b8      &#x2502;      &#x2502;          &#x2502;        &#x2502;          02:fe:c6:ce:e3:7a      &#x2502;      &#x2502;       
    &#x2502;        &#x2514;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x252C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2518;      &#x2502;          &#x2502;        &#x2514;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x252C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2518;      &#x2502;       
    &#x2502;                       &#x2502;                         &#x2502;          &#x2502;                       &#x2502;                         &#x2502;       
    &#x2502;                       &#x2502;af_packet raw socket     &#x2502;          &#x2502;                       &#x2502;af_packet raw socket     &#x2502;       
    &#x2502;                       &#x2502;                         &#x2502;          &#x2502;                       &#x2502;                         &#x2502;       
    &#x2502;                       &#x2502;                         &#x2502;          &#x2502;                       &#x2502;                         &#x2502;       
    &#x2514;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;eth0&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2518;          &#x2514;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;eth0&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2518;       
                      172.17.0.53/16                                               172.17.0.54/16                          
                      02:42:ac:11:00:35                                            02:42:ac:11:00:36                       
                            &#x2502;                                                            &#x2502;                                 
                            &#x2502;                                                            &#x2502;                                 
                            &#x2502;                                                            &#x2502;                                 
                            &#x2502;                                                            &#x2502;                                 
                            &#x2502;                   &#x250C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2510;                 &#x2502;                                 
                            &#x2502;                   &#x2502;                      &#x2502;                 &#x2502;                                 
                            &#x2502;                   &#x2502;    docker0 bridge    &#x2502;                 &#x2502;                                 
                            &#x2514;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2524;                      &#x251C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2518;                                 
                                                &#x2502;                      &#x2502;                                                   
                                                &#x2514;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2518;
</code></pre><h2 id="from-vpp2-ping-vpp3"><a name="from-vpp2-ping-vpp3" class="anchor-navigation-ex-anchor" href="#from-vpp2-ping-vpp3"><i class="fa fa-link" aria-hidden="true"></i></a>6.2. from vpp2 ping vpp3</h2>
<p>on vpp2</p>
<pre class="language-"><code class="lang-shell">vpp<span class="token comment"># ping 10.10.10.12</span>
<span class="token number">116</span> bytes from <span class="token number">10.10</span>.10.12: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">25.8177</span> ms
<span class="token number">116</span> bytes from <span class="token number">10.10</span>.10.12: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">9.0134</span> ms
<span class="token number">116</span> bytes from <span class="token number">10.10</span>.10.12: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">16.9887</span> ms
<span class="token number">116</span> bytes from <span class="token number">10.10</span>.10.12: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">21.0252</span> ms
<span class="token number">116</span> bytes from <span class="token number">10.10</span>.10.12: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">5</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">12.9954</span> ms

Statistics: <span class="token number">5</span> sent, <span class="token number">5</span> received, <span class="token number">0</span>% packet loss
</code></pre>
<p><code>tcpdump -n</code>: &#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x6211;&#x4F7F;&#x7528;<code>-n</code>&#x9009;&#x9879;, &#x9632;&#x6B62;tcpdump&#x81EA;&#x8EAB;&#x89E3;&#x6790;DNS&#x5E26;&#x6765;&#x7684;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x62A5;&#x6587;&#x4EA4;&#x4E92;, &#x8FD9;&#x70B9;&#x5F88;&#x91CD;&#x8981;!<br><img src="img/vpp_host_interace_20240730164506.png" alt=""></p>
<p>&#x7528;&#x66F4;&#x9AD8;&#x7EA7;&#x7684;<code>termshark</code>&#x7684;&#x6548;&#x679C;&#x66F4;&#x597D;:<br><img src="img/vpp_host_interace_20240802170201.png" alt=""></p>
<h3 id="on-vpp3ping&#x7684;&#x5BF9;&#x8C61;"><a name="on-vpp3ping&#x7684;&#x5BF9;&#x8C61;" class="anchor-navigation-ex-anchor" href="#on-vpp3ping&#x7684;&#x5BF9;&#x8C61;"><i class="fa fa-link" aria-hidden="true"></i></a>6.2.1. on vpp3(ping&#x7684;&#x5BF9;&#x8C61;)</h3>
<pre class="language-"><code class="lang-shell">vpp<span class="token comment"># show trace</span>
------------------- Start of thread <span class="token number">0</span> vpp_main -------------------
Packet <span class="token number">1</span>

<span class="token number">23</span>:30:10:687985: af-packet-input
  af_packet: hw_if_index <span class="token number">1</span> rx-queue <span class="token number">0</span> next-index <span class="token number">4</span>
    block <span class="token number">56</span>:
      address 0x7fb98507b000 version <span class="token number">2</span> seq_num <span class="token number">6777</span> pkt_num <span class="token number">0</span>
    tpacket3_hdr:
      status 0x81 len <span class="token number">110</span> snaplen <span class="token number">110</span> mac <span class="token number">92</span> net <span class="token number">106</span>
      sec 0x66a8a1cf nsec 0x1c79c3d1 vlan <span class="token number">0</span> vlan_tpid <span class="token number">0</span>
    vnet-hdr:
      flags 0x00 gso_type 0x00 hdr_len <span class="token number">0</span>
      gso_size <span class="token number">0</span> csum_start <span class="token number">0</span> csum_offset <span class="token number">0</span>
<span class="token number">23</span>:30:10:688220: ethernet-input
  IP4: 02:fe:12:85:26:b8 -<span class="token operator">&gt;</span> 02:fe:c6:ce:e3:7a
<span class="token number">23</span>:30:10:688657: ip4-input
  ICMP: <span class="token number">10.10</span>.10.11 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.12
    tos 0x00, ttl <span class="token number">254</span>, length <span class="token number">96</span>, checksum 0x9472 dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x0000
  ICMP echo_request checksum 0x9b3d <span class="token function">id</span> <span class="token number">61761</span>
<span class="token number">23</span>:30:10:688760: ip4-lookup
  fib <span class="token number">0</span> dpo-idx <span class="token number">7</span> flow hash: 0x00000000
  ICMP: <span class="token number">10.10</span>.10.11 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.12
    tos 0x00, ttl <span class="token number">254</span>, length <span class="token number">96</span>, checksum 0x9472 dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x0000
  ICMP echo_request checksum 0x9b3d <span class="token function">id</span> <span class="token number">61761</span>
<span class="token number">23</span>:30:10:689398: ip4-receive
    fib:0 adj:7 flow:0x00000000
  ICMP: <span class="token number">10.10</span>.10.11 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.12
    tos 0x00, ttl <span class="token number">254</span>, length <span class="token number">96</span>, checksum 0x9472 dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x0000
  ICMP echo_request checksum 0x9b3d <span class="token function">id</span> <span class="token number">61761</span>
<span class="token number">23</span>:30:10:689471: ip4-icmp-input
  ICMP: <span class="token number">10.10</span>.10.11 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.12
    tos 0x00, ttl <span class="token number">254</span>, length <span class="token number">96</span>, checksum 0x9472 dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x0000
  ICMP echo_request checksum 0x9b3d <span class="token function">id</span> <span class="token number">61761</span>
<span class="token number">23</span>:30:10:689602: ip4-icmp-echo-request
  ICMP: <span class="token number">10.10</span>.10.11 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.12
    tos 0x00, ttl <span class="token number">254</span>, length <span class="token number">96</span>, checksum 0x9472 dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x0000
  ICMP echo_request checksum 0x9b3d <span class="token function">id</span> <span class="token number">61761</span>
<span class="token number">23</span>:30:10:689826: ip4-load-balance
  fib <span class="token number">0</span> dpo-idx <span class="token number">2</span> flow hash: 0x00000000
  ICMP: <span class="token number">10.10</span>.10.12 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.11
    tos 0x00, ttl <span class="token number">64</span>, length <span class="token number">96</span>, checksum 0x78bd dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0xd9b5
  ICMP echo_reply checksum 0xa33d <span class="token function">id</span> <span class="token number">61761</span>
<span class="token number">23</span>:30:10:689913: ip4-rewrite
  tx_sw_if_index <span class="token number">1</span> dpo-idx <span class="token number">2</span> <span class="token builtin class-name">:</span> ipv4 via <span class="token number">10.10</span>.10.11 host-eth0: mtu:9000 next:3 flags:<span class="token punctuation">[</span><span class="token punctuation">]</span> 02fe128526b802fec6cee37a0800 flow hash: 0x00000000
  00000000: 02fe128526b802fec6cee37a080045000060d9b50000400178bd0a0a0a0c0a0a
  00000020: 0a0b0000a33df14100012946a6e81ac8170100010203040506070809
<span class="token number">23</span>:30:10:690055: host-eth0-output
  host-eth0 flags 0x02180005
  IP4: 02:fe:c6:ce:e3:7a -<span class="token operator">&gt;</span> 02:fe:12:85:26:b8
  ICMP: <span class="token number">10.10</span>.10.12 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.11
    tos 0x00, ttl <span class="token number">64</span>, length <span class="token number">96</span>, checksum 0x78bd dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0xd9b5
  ICMP echo_reply checksum 0xa33d <span class="token function">id</span> <span class="token number">61761</span>
<span class="token number">23</span>:30:10:690444: host-eth0-tx
  af_packet: hw_if_index <span class="token number">1</span> tx-queue <span class="token number">0</span>
    tpacket3_hdr:
      status 0x1 len <span class="token number">120</span> snaplen <span class="token number">120</span> mac <span class="token number">0</span> net <span class="token number">0</span>
      sec 0x0 nsec 0x0 vlan <span class="token number">0</span> vlan_tpid <span class="token number">0</span>
    vnet-hdr:
      flags 0x00 gso_type 0x00 hdr_len <span class="token number">0</span>
      gso_size <span class="token number">0</span> csum_start <span class="token number">0</span> csum_offset <span class="token number">0</span>
    buffer 0x94832:
      current data <span class="token number">0</span>, length <span class="token number">110</span>, buffer-pool <span class="token number">0</span>, ref-count <span class="token number">1</span>, trace handle 0x0
      <span class="token builtin class-name">local</span> l2-hdr-offset <span class="token number">0</span> l3-hdr-offset <span class="token number">14</span>
    IP4: 02:fe:c6:ce:e3:7a -<span class="token operator">&gt;</span> 02:fe:12:85:26:b8
    ICMP: <span class="token number">10.10</span>.10.12 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.11
      tos 0x00, ttl <span class="token number">64</span>, length <span class="token number">96</span>, checksum 0x78bd dscp CS0 ecn NON_ECN
      fragment <span class="token function">id</span> 0xd9b5
    ICMP echo_reply checksum 0xa33d <span class="token function">id</span> <span class="token number">61761</span>

Packet <span class="token number">2</span>

<span class="token number">23</span>:30:11:671324: af-packet-input
  af_packet: hw_if_index <span class="token number">1</span> rx-queue <span class="token number">0</span> next-index <span class="token number">4</span>
    block <span class="token number">57</span>:
      address 0x7fb98508b000 version <span class="token number">2</span> seq_num <span class="token number">6778</span> pkt_num <span class="token number">0</span>
    tpacket3_hdr:
      status 0x81 len <span class="token number">110</span> snaplen <span class="token number">110</span> mac <span class="token number">92</span> net <span class="token number">106</span>
      sec 0x66a8a1d0 nsec 0x1bda7f1c vlan <span class="token number">0</span> vlan_tpid <span class="token number">0</span>
    vnet-hdr:
      flags 0x00 gso_type 0x00 hdr_len <span class="token number">0</span>
      gso_size <span class="token number">0</span> csum_start <span class="token number">0</span> csum_offset <span class="token number">0</span>
<span class="token number">23</span>:30:11:671337: ethernet-input
  IP4: 02:fe:12:85:26:b8 -<span class="token operator">&gt;</span> 02:fe:c6:ce:e3:7a
<span class="token number">23</span>:30:11:671343: ip4-input
  ICMP: <span class="token number">10.10</span>.10.11 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.12
    tos 0x00, ttl <span class="token number">254</span>, length <span class="token number">96</span>, checksum 0x9472 dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x0000
  ICMP echo_request checksum 0xe01b <span class="token function">id</span> <span class="token number">61761</span>
<span class="token number">23</span>:30:11:671373: ip4-lookup
  fib <span class="token number">0</span> dpo-idx <span class="token number">7</span> flow hash: 0x00000000
  ICMP: <span class="token number">10.10</span>.10.11 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.12
    tos 0x00, ttl <span class="token number">254</span>, length <span class="token number">96</span>, checksum 0x9472 dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x0000
  ICMP echo_request checksum 0xe01b <span class="token function">id</span> <span class="token number">61761</span>
<span class="token number">23</span>:30:11:671376: ip4-receive
    fib:0 adj:7 flow:0x00000000
  ICMP: <span class="token number">10.10</span>.10.11 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.12
    tos 0x00, ttl <span class="token number">254</span>, length <span class="token number">96</span>, checksum 0x9472 dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x0000
  ICMP echo_request checksum 0xe01b <span class="token function">id</span> <span class="token number">61761</span>
<span class="token number">23</span>:30:11:671377: ip4-icmp-input
  ICMP: <span class="token number">10.10</span>.10.11 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.12
    tos 0x00, ttl <span class="token number">254</span>, length <span class="token number">96</span>, checksum 0x9472 dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x0000
  ICMP echo_request checksum 0xe01b <span class="token function">id</span> <span class="token number">61761</span>
<span class="token number">23</span>:30:11:671378: ip4-icmp-echo-request
  ICMP: <span class="token number">10.10</span>.10.11 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.12
    tos 0x00, ttl <span class="token number">254</span>, length <span class="token number">96</span>, checksum 0x9472 dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x0000
  ICMP echo_request checksum 0xe01b <span class="token function">id</span> <span class="token number">61761</span>
<span class="token number">23</span>:30:11:671381: ip4-load-balance
  fib <span class="token number">0</span> dpo-idx <span class="token number">2</span> flow hash: 0x00000000
  ICMP: <span class="token number">10.10</span>.10.12 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.11
    tos 0x00, ttl <span class="token number">64</span>, length <span class="token number">96</span>, checksum 0x609e dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0xf1d4
  ICMP echo_reply checksum 0xe81b <span class="token function">id</span> <span class="token number">61761</span>
<span class="token number">23</span>:30:11:671383: ip4-rewrite
  tx_sw_if_index <span class="token number">1</span> dpo-idx <span class="token number">2</span> <span class="token builtin class-name">:</span> ipv4 via <span class="token number">10.10</span>.10.11 host-eth0: mtu:9000 next:3 flags:<span class="token punctuation">[</span><span class="token punctuation">]</span> 02fe128526b802fec6cee37a0800 flow hash: 0x00000000
  00000000: 02fe128526b802fec6cee37a080045000060f1d400004001609e0a0a0a0c0a0a
  00000020: 0a0b0000e81bf141000240d849771bc8170100010203040506070809
<span class="token number">23</span>:30:11:671385: host-eth0-output
  host-eth0 flags 0x02180005
  IP4: 02:fe:c6:ce:e3:7a -<span class="token operator">&gt;</span> 02:fe:12:85:26:b8
  ICMP: <span class="token number">10.10</span>.10.12 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.11
    tos 0x00, ttl <span class="token number">64</span>, length <span class="token number">96</span>, checksum 0x609e dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0xf1d4
  ICMP echo_reply checksum 0xe81b <span class="token function">id</span> <span class="token number">61761</span>
<span class="token number">23</span>:30:11:671389: host-eth0-tx
  af_packet: hw_if_index <span class="token number">1</span> tx-queue <span class="token number">0</span>
    tpacket3_hdr:
      status 0x1 len <span class="token number">120</span> snaplen <span class="token number">120</span> mac <span class="token number">0</span> net <span class="token number">0</span>
      sec 0x0 nsec 0x0 vlan <span class="token number">0</span> vlan_tpid <span class="token number">0</span>
    vnet-hdr:
      flags 0x00 gso_type 0x00 hdr_len <span class="token number">0</span>
      gso_size <span class="token number">0</span> csum_start <span class="token number">0</span> csum_offset <span class="token number">0</span>
    buffer 0x9480d:
      current data <span class="token number">0</span>, length <span class="token number">110</span>, buffer-pool <span class="token number">0</span>, ref-count <span class="token number">1</span>, trace handle 0x1
      <span class="token builtin class-name">local</span> l2-hdr-offset <span class="token number">0</span> l3-hdr-offset <span class="token number">14</span>
    IP4: 02:fe:c6:ce:e3:7a -<span class="token operator">&gt;</span> 02:fe:12:85:26:b8
    ICMP: <span class="token number">10.10</span>.10.12 -<span class="token operator">&gt;</span> <span class="token number">10.10</span>.10.11
      tos 0x00, ttl <span class="token number">64</span>, length <span class="token number">96</span>, checksum 0x609e dscp CS0 ecn NON_ECN
      fragment <span class="token function">id</span> 0xf1d4
    ICMP echo_reply checksum 0xe81b <span class="token function">id</span> <span class="token number">61761</span>

Packet <span class="token number">3</span>
<span class="token punctuation">..</span>.
Packet <span class="token number">4</span>
<span class="token punctuation">..</span>.
Packet <span class="token number">5</span>
<span class="token punctuation">..</span>.
</code></pre>
<p>&#x4E00;&#x4E2A;ICMP&#x7684;ping&#x62A5;&#x6587;&#x5728;VPP&#x7684;&#x5904;&#x7406;&#x6D41;&#x7A0B;</p>
<p>packet 1: &#x6574;&#x4E2A;&#x5904;&#x7406;&#x8FC7;&#x7A0B;&#x5927;&#x7EA6;2ms</p>
<ul>
<li>23:30:10:687985: af-packet-input</li>
<li>23:30:10:688220: ethernet-input</li>
<li>23:30:10:688760: ip4-lookup</li>
<li>23:30:10:689398: ip4-receive</li>
<li>23:30:10:689471: ip4-icmp-input</li>
<li>23:30:10:689602: ip4-icmp-echo-request</li>
<li>23:30:10:689826: ip4-load-balance</li>
<li>23:30:10:689913: ip4-rewrite</li>
<li>23:30:10:690055: host-eth0-output</li>
<li>23:30:10:690444: host-eth0-tx</li>
</ul>
<p>packet 2: &#x6574;&#x4E2A;&#x5904;&#x7406;&#x8FC7;&#x7A0B;&#x4E0D;&#x5230;1ms</p>
<ul>
<li>23:30:11:671324: af-packet-input</li>
<li>23:30:11:671337: ethernet-input</li>
<li>23:30:11:671343: ip4-input</li>
<li>23:30:11:671373: ip4-lookup</li>
<li>23:30:11:671376: ip4-receive</li>
<li>23:30:11:671377: ip4-icmp-input</li>
<li>23:30:11:671378: ip4-icmp-echo-request</li>
<li>23:30:11:671381: ip4-load-balance</li>
<li>23:30:11:671383: ip4-rewrite</li>
<li>23:30:11:671385: host-eth0-output</li>
<li>23:30:11:671389: host-eth0-tx</li>
</ul>
<h3 id="on-vpp2ping-&#x53D1;&#x9001;&#x65B9;"><a name="on-vpp2ping-&#x53D1;&#x9001;&#x65B9;" class="anchor-navigation-ex-anchor" href="#on-vpp2ping-&#x53D1;&#x9001;&#x65B9;"><i class="fa fa-link" aria-hidden="true"></i></a>6.2.2. on VPP2(ping &#x53D1;&#x9001;&#x65B9;)</h3>
<pre class="language-"><code>------------------- Start of thread 0 vpp_main -------------------
Packet 1

23:31:11:666212: af-packet-input
  af_packet: hw_if_index 1 rx-queue 0 next-index 4
    block 135:
      address 0x7f110a840000 version 2 seq_num 5576 pkt_num 0
    tpacket3_hdr:
      status 0x81 len 110 snaplen 110 mac 92 net 106
      sec 0x66a8a1cf nsec 0x1d12c6f5 vlan 0 vlan_tpid 0
    vnet-hdr:
      flags 0x00 gso_type 0x00 hdr_len 0
      gso_size 0 csum_start 0 csum_offset 0
23:31:11:666400: ethernet-input
  IP4: 02:fe:c6:ce:e3:7a -&gt; 02:fe:12:85:26:b8
23:31:11:666728: ip4-input
  ICMP: 10.10.10.12 -&gt; 10.10.10.11
    tos 0x00, ttl 64, length 96, checksum 0x78bd dscp CS0 ecn NON_ECN
    fragment id 0xd9b5
  ICMP echo_reply checksum 0xa33d id 61761
23:31:11:666923: ip4-lookup
  fib 0 dpo-idx 7 flow hash: 0x00000000
  ICMP: 10.10.10.12 -&gt; 10.10.10.11
    tos 0x00, ttl 64, length 96, checksum 0x78bd dscp CS0 ecn NON_ECN
    fragment id 0xd9b5
  ICMP echo_reply checksum 0xa33d id 61761
23:31:11:667032: ip4-receive
    fib:0 adj:7 flow:0x00000000
  ICMP: 10.10.10.12 -&gt; 10.10.10.11
    tos 0x00, ttl 64, length 96, checksum 0x78bd dscp CS0 ecn NON_ECN
    fragment id 0xd9b5
  ICMP echo_reply checksum 0xa33d id 61761
23:31:11:667234: ip4-icmp-input
  ICMP: 10.10.10.12 -&gt; 10.10.10.11
    tos 0x00, ttl 64, length 96, checksum 0x78bd dscp CS0 ecn NON_ECN
    fragment id 0xd9b5
  ICMP echo_reply checksum 0xa33d id 61761
23:31:11:667382: ip4-icmp-echo-reply
  ICMP4 echo id 61761 seq 1 send to cli node 712

Packet 2

23:31:12:650102: af-packet-input
  af_packet: hw_if_index 1 rx-queue 0 next-index 4
    block 136:
      address 0x7f110a850000 version 2 seq_num 5577 pkt_num 0
    tpacket3_hdr:
      status 0x81 len 110 snaplen 110 mac 92 net 106
      sec 0x66a8a1d0 nsec 0x1bea3b05 vlan 0 vlan_tpid 0
    vnet-hdr:
      flags 0x00 gso_type 0x00 hdr_len 0
      gso_size 0 csum_start 0 csum_offset 0
23:31:12:650121: ethernet-input
  IP4: 02:fe:c6:ce:e3:7a -&gt; 02:fe:12:85:26:b8
23:31:12:650129: ip4-input
  ICMP: 10.10.10.12 -&gt; 10.10.10.11
    tos 0x00, ttl 64, length 96, checksum 0x609e dscp CS0 ecn NON_ECN
    fragment id 0xf1d4
  ICMP echo_reply checksum 0xe81b id 61761
23:31:12:650132: ip4-lookup
  fib 0 dpo-idx 7 flow hash: 0x00000000
  ICMP: 10.10.10.12 -&gt; 10.10.10.11
    fragment id 0xf1d4
  ICMP echo_reply checksum 0xe81b id 61761
23:31:12:650135: ip4-receive
    fib:0 adj:7 flow:0x00000000
  ICMP: 10.10.10.12 -&gt; 10.10.10.11
    tos 0x00, ttl 64, length 96, checksum 0x609e dscp CS0 ecn NON_ECN
    fragment id 0xf1d4
  ICMP echo_reply checksum 0xe81b id 61761
23:31:12:650137: ip4-icmp-input
  ICMP: 10.10.10.12 -&gt; 10.10.10.11
    tos 0x00, ttl 64, length 96, checksum 0x609e dscp CS0 ecn NON_ECN
    fragment id 0xf1d4
  ICMP echo_reply checksum 0xe81b id 61761
    fragment id 0xf1d4
  ICMP echo_reply checksum 0xe81b id 61761
23:31:12:650138: ip4-icmp-echo-reply
  ICMP4 echo id 61761 seq 2 send to cli node 712

Packet 3

23:31:13:658086: af-packet-input
  af_packet: hw_if_index 1 rx-queue 0 next-index 4
    block 137:
      address 0x7f110a860000 version 2 seq_num 5578 pkt_num 0
    tpacket3_hdr:
      status 0x81 len 110 snaplen 110 mac 92 net 106
      sec 0x66a8a1d1 nsec 0x1c64823c vlan 0 vlan_tpid 0
    vnet-hdr:
      flags 0x00 gso_type 0x00 hdr_len 0
      gso_size 0 csum_start 0 csum_offset 0
23:31:13:658096: ethernet-input
  IP4: 02:fe:c6:ce:e3:7a -&gt; 02:fe:12:85:26:b8
23:31:13:658106: ip4-input
  ICMP: 10.10.10.12 -&gt; 10.10.10.11
    tos 0x00, ttl 64, length 96, checksum 0x2076 dscp CS0 ecn NON_ECN
    fragment id 0x31fd
  ICMP echo_reply checksum 0x5406 id 61761
23:31:13:658109: ip4-lookup
  fib 0 dpo-idx 7 flow hash: 0x00000000
  ICMP: 10.10.10.12 -&gt; 10.10.10.11
    tos 0x00, ttl 64, length 96, checksum 0x2076 dscp CS0 ecn NON_ECN
    fragment id 0x31fd
  ICMP echo_reply checksum 0x5406 id 61761
23:31:13:658112: ip4-receive
    fib:0 adj:7 flow:0x00000000
  ICMP: 10.10.10.12 -&gt; 10.10.10.11
    tos 0x00, ttl 64, length 96, checksum 0x2076 dscp CS0 ecn NON_ECN
    fragment id 0x31fd
  ICMP echo_reply checksum 0x5406 id 61761
23:31:13:658114: ip4-icmp-input
  ICMP: 10.10.10.12 -&gt; 10.10.10.11
    tos 0x00, ttl 64, length 96, checksum 0x2076 dscp CS0 ecn NON_ECN
    fragment id 0x31fd
  ICMP echo_reply checksum 0x5406 id 61761
23:31:13:658115: ip4-icmp-echo-reply
  ICMP4 echo id 61761 seq 3 send to cli node 712

Packet 4
...
Packet 5
...
</code></pre><p>&#x5904;&#x7406;&#x6D41;&#x7A0B;(ping &#x53D1;&#x9001;&#x65B9;)
packet 1:</p>
<ul>
<li>23:31:11:666212: af-packet-input</li>
<li>23:31:11:666400: ethernet-input</li>
<li>23:31:11:666728: ip4-input</li>
<li>23:31:11:666923: ip4-lookup</li>
<li>23:31:11:667032: ip4-receive</li>
<li>23:31:11:667234: ip4-icmp-input</li>
<li>23:31:11:667382: ip4-icmp-echo-reply</li>
</ul>
<p>packet 2:</p>
<ul>
<li>23:31:12:650102: af-packet-input</li>
<li>23:31:12:650121: ethernet-input</li>
<li>23:31:12:650129: ip4-input</li>
<li>23:31:12:650132: ip4-lookup</li>
<li>23:31:12:650135: ip4-receive</li>
<li>23:31:12:650137: ip4-icmp-input</li>
<li>23:31:12:650138: ip4-icmp-echo-reply</li>
</ul>
<h3 id="&#x5206;&#x6790;"><a name="&#x5206;&#x6790;" class="anchor-navigation-ex-anchor" href="#&#x5206;&#x6790;"><i class="fa fa-link" aria-hidden="true"></i></a>6.2.3. &#x5206;&#x6790;</h3>
<pre class="language-"><code>&#x5904;&#x7406;&#x6D41;&#x7A0B;(ping &#x53D1;&#x9001;&#x65B9;)
packet 1: &#x8FD9;&#x91CC;&#x53EA;&#x80FD;&#x663E;&#x793A;&#x5BF9;&#x65B9;&#x53D1;&#x8FC7;&#x6765;&#x7684;ICMP echo reply&#x62A5;&#x6587;&#x5230;&#x8FBE;&#x540E;&#x7684;&#x5904;&#x7406;&#x8FC7;&#x7A0B;. &#x5B9E;&#x9645;&#x4E0A;&#x4E5F;&#x4E0D;&#x7528;&#x600E;&#x4E48;&#x5904;&#x7406;, &#x53EA;&#x6536;&#x62A5;&#x5C31;&#x597D;&#x4E86;. &#x8FD9;&#x91CC;&#x5927;&#x6982;1ms
* 23:31:11:666212: af-packet-input
* 23:31:11:666400: ethernet-input
* 23:31:11:666728: ip4-input
* 23:31:11:666923: ip4-lookup
* 23:31:11:667032: ip4-receive
* 23:31:11:667234: ip4-icmp-input
* 23:31:11:667382: ip4-icmp-echo-reply

packet 2: &#x4E0D;&#x5230;1ms
* 23:31:12:650102: af-packet-input
* 23:31:12:650121: ethernet-input
* 23:31:12:650129: ip4-input
* 23:31:12:650132: ip4-lookup
* 23:31:12:650135: ip4-receive
* 23:31:12:650137: ip4-icmp-input
* 23:31:12:650138: ip4-icmp-echo-reply

&#x5904;&#x7406;&#x6D41;&#x7A0B;(ping&#x63A5;&#x6536;&#x65B9;)
packet 1: &#x6574;&#x4E2A;&#x5904;&#x7406;&#x8FC7;&#x7A0B;&#x5927;&#x7EA6;2ms
* 23:30:10:687985: af-packet-input
* 23:30:10:688220: ethernet-input
* 23:30:10:688760: ip4-lookup
* 23:30:10:689398: ip4-receive
* 23:30:10:689471: ip4-icmp-input
* 23:30:10:689602: ip4-icmp-echo-request
* 23:30:10:689826: ip4-load-balance
* 23:30:10:689913: ip4-rewrite
* 23:30:10:690055: host-eth0-output
* 23:30:10:690444: host-eth0-tx

packet 2: &#x6574;&#x4E2A;&#x5904;&#x7406;&#x8FC7;&#x7A0B;&#x4E0D;&#x5230;1ms
* 23:30:11:671324: af-packet-input
* 23:30:11:671337: ethernet-input
* 23:30:11:671343: ip4-input
* 23:30:11:671373: ip4-lookup
* 23:30:11:671376: ip4-receive
* 23:30:11:671377: ip4-icmp-input
* 23:30:11:671378: ip4-icmp-echo-request
* 23:30:11:671381: ip4-load-balance
* 23:30:11:671383: ip4-rewrite
* 23:30:11:671385: host-eth0-output
* 23:30:11:671389: host-eth0-tx
</code></pre><p>&#x6CE8;&#x610F;&#x5230;&#x51E0;&#x4E2A;&#x5F88;tricky&#x7684;&#x5730;&#x65B9;:</p>
<ul>
<li>tcpdump&#x4E0D;&#x80FD;&#x6293;&#x5230;eth0&#x7684;outgoing&#x7684;packet -- &#x5F88;&#x5947;&#x602A;, &#x56E0;&#x4E3A;&#x5728;container&#x91CC;&#x9762;&#x7684;normal ping&#x662F;&#x53EF;&#x4EE5;&#x6293;&#x5230;eth0&#x53D1;&#x51FA;&#x7684;&#x62A5;&#x6587;&#x7684;</li>
<li>vpp trace&#x7CFB;&#x7EDF;&#x5173;&#x6CE8;&#x7684;&#x662F;&#x4E00;&#x4E2A;packet&#x4ECE;&#x5165;&#x53E3;(input)&#x5F00;&#x59CB;&#x7684;&#x7684;&#x5904;&#x7406;&#x6D41;&#x7A0B;<ul>
<li>&#x5728;ping request&#x7684;&#x53D1;&#x9001;&#x65B9;(vpp2)&#x4E0A;, &#x53EA;&#x80FD;&#x770B;&#x5230;&#x4ECE;(vpp 3)&#x8FD4;&#x56DE;&#x7684;echo reply &#x62A5;&#x6587;</li>
<li>&#x5728;ping&#x7684;&#x5BF9;&#x8C61;(vpp3)&#x4E0A;, &#x53EF;&#x4EE5;&#x770B;&#x5230;&#x4ECE;<code>af-packet-input</code>&#x5F00;&#x59CB;, vpp&#x81EA;&#x5DF1;&#x7684;&#x534F;&#x8BAE;&#x6808;&#x5904;&#x7406;ICMP echo request&#x62A5;&#x6587;, &#x5230;&#x4ECE;<code>host-eth0-tx</code>&#x53D1;&#x51FA;ICMP echo reply&#x62A5;&#x6587;, &#x8FD9;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x5904;&#x7406;&#x6D41;&#x7A0B;</li>
</ul>
</li>
<li>vpp trace&#x663E;&#x793A;&#x7684;&#x65F6;&#x95F4;&#x548C;&#x7CFB;&#x7EDF;&#x65F6;&#x95F4;&#x5BF9;&#x4E0D;&#x4E0A;, &#x4E24;&#x4E2A;vpp&#x7CFB;&#x7EDF;&#x7684;&#x65F6;&#x95F4;&#x4E5F;&#x5BF9;&#x4E0D;&#x4E0A;... &#x8FD9;&#x70B9;&#x5F88;&#x4E0D;&#x53CB;&#x597D;, &#x5BF9;&#x62A5;&#x6587;&#x7684;&#x5904;&#x7406;&#x65F6;&#x95F4;&#x7684;&#x5206;&#x6790;&#x5E26;&#x6765;&#x5F88;&#x5927;&#x56F0;&#x6270;, &#x6240;&#x4EE5;&#x53EA;&#x80FD;&#x4ECE;&#x5404;&#x81EA;&#x7684;&#x5904;&#x7406;&#x65F6;&#x95F4;&#x6765;&#x5206;&#x6790;:<ul>
<li>&#x88AB;ping&#x7684;&#x4E00;&#x65B9;&#x7A0D;&#x5FAE;&#x5904;&#x7406;&#x65F6;&#x95F4;&#x957F;&#x70B9;, &#x5927;&#x6982;2ms</li>
<li>ping&#x7684;&#x53D1;&#x8D77;&#x65B9;&#x7684;&#x63A5;&#x6536;ICMP echo reply&#x7684;&#x5904;&#x7406;&#x65F6;&#x95F4;&#x4E00;&#x822C;&#x662F;1ms</li>
<li>ping&#x7684;&#x53D1;&#x8D77;&#x65B9;&#x7684;&#x53D1;&#x9001;&#x8DEF;&#x5F84;&#x4F30;&#x8BA1;&#x4E5F;&#x662F;&#x5C0F;&#x4E8E;1ms</li>
<li>&#x4EC5;&#x4ECE;&#x8FD9;&#x90E8;&#x5206;&#x770B;, vpp&#x5904;&#x7406;ICMP&#x7684;&#x6548;&#x7387;&#x8FDC;&#x8FDC;&#x6162;&#x4E8E;kernel</li>
</ul>
</li>
<li>&#x5B9E;&#x9645;&#x4E0A;, &#x4ECE;ping&#x7684;&#x7EDF;&#x8BA1;&#x6765;&#x770B;, &#x5176;&#x5904;&#x7406;&#x65F6;&#x95F4;&#x6709;&#x70B9;&#x592A;&#x5927;&#x4E86;:
```
vpp# ping 10.10.10.12
116 bytes from 10.10.10.12: icmp_seq=1 ttl=64 time=25.8177 ms
116 bytes from 10.10.10.12: icmp_seq=2 ttl=64 time=9.0134 ms
116 bytes from 10.10.10.12: icmp_seq=3 ttl=64 time=16.9887 ms
116 bytes from 10.10.10.12: icmp_seq=4 ttl=64 time=21.0252 ms
116 bytes from 10.10.10.12: icmp_seq=5 ttl=64 time=12.9954 ms</li>
</ul>
<p>Statistics: 5 sent, 5 received, 0% packet loss</p>
<pre class="language-"><code>
## &#x4E3A;&#x4EC0;&#x4E48;tcpdump&#x6293;&#x4E0D;&#x5230;outgoing&#x7684;&#x62A5;&#x6587;
&#x6700;&#x540E;&#x7684;packet&#x80AF;&#x5B9A;&#x662F;&#x4ECE;eth0&#x53D1;&#x51FA;&#x7684;, &#x4E5F;&#x5C31;&#x662F;&#x5FC5;&#x987B;&#x8D70;kernel, &#x90A3;&#x4E48;tcpdump&#x4E0D;&#x80FD;&#x6293;&#x5230;&#x5C31;&#x975E;&#x5E38;&#x5C11;&#x89C1;.

&#x6839;&#x636E;[&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;](https://chnhaoran.github.io/blog/how-is-tcpdump-working/)&#x7684;&#x4ECB;&#x7ECD;:
* RX side: XDP -&gt; Tcpdump -&gt; TC -&gt; network stack
* TX side: network stack -&gt; TC -&gt; Tcpdump

&#x6CE8;&#x610F;&#x5230;`host-interface qdisc-bypass`&#x6709;TC&#x76F8;&#x5173;&#x7684;&#x914D;&#x7F6E;. &#x8BD5;&#x8BD5;&#x770B;:

&#x5728;vpp2&#x548C;vpp3&#x4E0A;, &#x7528;vppctl&#x6267;&#x884C;:
```shell
#&#x5148;disable qdisc-bypass
set host-interface qdisc-bypass host-eth0 disable
#&#x518D;&#x91CD;&#x65B0;trace
clear trace
trace add af-packet-input 100
#&#x518D;ping
vpp# ping 10.10.10.12
116 bytes from 10.10.10.12: icmp_seq=1 ttl=64 time=16.6176 ms
116 bytes from 10.10.10.12: icmp_seq=2 ttl=64 time=15.5092 ms
116 bytes from 10.10.10.12: icmp_seq=3 ttl=64 time=23.3749 ms
116 bytes from 10.10.10.12: icmp_seq=4 ttl=64 time=15.4622 ms
116 bytes from 10.10.10.12: icmp_seq=5 ttl=64 time=15.5163 ms

Statistics: 5 sent, 5 received, 0% packet loss
</code></pre><p>&#x5728;vpp2&#x548C;vpp3&#x7684;container&#x5185;&#x90E8;&#x5206;&#x522B;<code>tcpdump -n</code>&#x5F97;&#x5230;:<br><img src="img/vpp_host_interace_20240801115608.png" alt=""></p>
<p>&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x6293;&#x5230;&#x4ECE;<code>host-eth0</code>&#x53D1;&#x9001;&#x7684;&#x62A5;&#x6587;, &#x8BE5;&#x62A5;&#x6587;&#x901A;&#x8FC7;<code>af_packet</code>&#x7684;raw socket&#x8D70;<code>eth0</code>&#x53D1;&#x9001;&#x51FA;&#x53BB;.</p>
<h2 id="&#x65F6;&#x95F4;&#x90FD;&#x82B1;&#x5728;&#x54EA;&#x4E86;"><a name="&#x65F6;&#x95F4;&#x90FD;&#x82B1;&#x5728;&#x54EA;&#x4E86;" class="anchor-navigation-ex-anchor" href="#&#x65F6;&#x95F4;&#x90FD;&#x82B1;&#x5728;&#x54EA;&#x4E86;"><i class="fa fa-link" aria-hidden="true"></i></a>6.3. &#x65F6;&#x95F4;&#x90FD;&#x82B1;&#x5728;&#x54EA;&#x4E86;?</h2>
<p>&#x4ECE;tcpdump&#x7684;&#x65F6;&#x95F4;&#x6233;&#x6765;&#x770B;, &#x5176;&#x5B9E;vpp&#x7684;ping&#x6CA1;&#x6709;&#x5B83;&#x81EA;&#x5DF1;&#x663E;&#x793A;&#x7684;&#x90A3;&#x4E48;&#x6162;:</p>
<pre class="language-"><code>//&#x5927;&#x6982;7ms
03:29:43.263620 IP 10.10.10.11 &gt; 10.10.10.12: ICMP echo request, id 60350, seq 1, length 76
03:29:43.270918 IP 10.10.10.12 &gt; 10.10.10.11: ICMP echo reply, id 60350, seq 1, length 76  
//&#x5927;&#x6982;4ms
03:29:44.264924 IP 10.10.10.11 &gt; 10.10.10.12: ICMP echo request, id 60350, seq 2, length 76
03:29:44.268348 IP 10.10.10.12 &gt; 10.10.10.11: ICMP echo reply, id 60350, seq 2, length 76  
//&#x5927;&#x6982;8ms
03:29:45.268100 IP 10.10.10.11 &gt; 10.10.10.12: ICMP echo request, id 60350, seq 3, length 76
03:29:45.276426 IP 10.10.10.12 &gt; 10.10.10.11: ICMP echo reply, id 60350, seq 3, length 76  
//&#x5927;&#x6982;4ms
03:29:46.260913 IP 10.10.10.11 &gt; 10.10.10.12: ICMP echo request, id 60350, seq 4, length 76
03:29:46.264400 IP 10.10.10.12 &gt; 10.10.10.11: ICMP echo reply, id 60350, seq 4, length 76  
//&#x5927;&#x6982;4ms
03:29:47.264976 IP 10.10.10.11 &gt; 10.10.10.12: ICMP echo request, id 60350, seq 5, length 76
03:29:47.268299 IP 10.10.10.12 &gt; 10.10.10.11: ICMP echo reply, id 60350, seq 5, length 76
</code></pre><p>&#x4F46;&#x56E0;&#x4E3A;tcpdump&#x7684;&#x65F6;&#x95F4;&#x4E0D;&#x5305;&#x62EC;ping&#x53D1;&#x9001;&#x65B9;&#x7684;&#x53D1;&#x5305;&#x65F6;&#x95F4;&#x548C;&#x7528;&#x6237;&#x6001;&#x6536;&#x62A5;&#x65F6;&#x95F4;, &#x4ECE;&#x56FE;&#x7247;&#x53F3;&#x8FB9;vpp3&#x7684;&#x65F6;&#x95F4;&#x6233;&#x6765;&#x770B;, &#x5927;&#x6982;&#x6BD4;&#x5DE6;&#x4FA7;&#x7684;&#x65F6;&#x95F4;&#x5DEE;&#x5C0F;&#x4E2A;1ms&#x5DE6;&#x53F3;, &#x90A3;&#x4E48;&#x8FD9;&#x4E2A;1ms&#x5C31;&#x662F;&#x62A5;&#x6587;&#x5728;vpp3&#x7684;eth0&#x548C;vpp2&#x7684;eth0&#x5F80;&#x8FD4;&#x7684;&#x65F6;&#x95F4;.</p>
<p>&#x90A3;&#x4E3A;&#x4EC0;&#x4E48;&#x5728;vpp2&#x7684;ping&#x770B;&#x6765;, &#x65F6;&#x95F4;&#x591A;&#x90A3;&#x4E48;&#x591A;&#x5462;?</p>
<h3 id="vpp&#x8FD0;&#x884C;&#x65F6;&#x72B6;&#x6001;"><a name="vpp&#x8FD0;&#x884C;&#x65F6;&#x72B6;&#x6001;" class="anchor-navigation-ex-anchor" href="#vpp&#x8FD0;&#x884C;&#x65F6;&#x72B6;&#x6001;"><i class="fa fa-link" aria-hidden="true"></i></a>6.3.1. vpp&#x8FD0;&#x884C;&#x65F6;&#x72B6;&#x6001;</h3>
<p>&#x5728;&#x8DDF;&#x8E2A;vpp&#x4E4B;&#x524D;, &#x6211;&#x4EEC;&#x5148;&#x8981;&#x5BF9;vpp&#x7684;&#x4EE3;&#x7801;&#x548C;&#x8FD0;&#x884C;&#x6846;&#x67B6;&#x6709;&#x6240;&#x4E86;&#x89E3;:</p>
<ul>
<li>vpp&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#x4F7F;&#x7528;<code>vpp -c /etc/vpp/startup.conf</code>, &#x770B;&#x5230;vpp&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x4E3B;&#x8FDB;&#x7A0B;. &#x7528;<code>vppctl show threads</code>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x76EE;&#x524D;&#x53EA;&#x6709;<code>vpp_main</code>&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;.<pre class="language-"><code>vpp# show threads
ID     Name                Type        LWP     Sched Policy (Priority)  lcore  Core   Socket State
0      vpp_main                        63      (nil) (n/a)              n/a    n/a    n/a
</code></pre></li>
<li>&#x7528;<code>vppctl show runtime</code>&#x770B;&#x5230;&#x5404;&#x79CD;&#x8FD0;&#x884C;&#x65F6;&#x7EDF;&#x8BA1;, &#x91CC;&#x9762;&#x6709;&#x5F88;&#x591A;&#x4E1C;&#x897F;&#x90FD;&#x5F88;&#x6709;&#x610F;&#x601D;; &#x7528;<code>vppctl show runtime verbose</code>&#x80FD;&#x770B;&#x5230;&#x66F4;&#x591A;&#x7684;&#x7EDF;&#x8BA1;<pre class="language-"><code>vector rates in 1.9398e-2, out 5.2409e-4, drop 1.8889e-2, punt 0.0000e0
           Name                 State         Calls          Vectors        Suspends         Clocks       Vectors/Call
acl-plugin-fa-cleaner-process  event wait                0               0               1          2.44e5            0.00
af-packet-input               interrupt wa           10170           14842               0          1.94e6            1.46
api-rx-from-ring                any wait                 0               0           38261          2.23e5            0.00
arp-input                        active               4431            4452               0          1.92e5            1.00
arp-reply                        active               4431            4452               0          2.74e6            1.00
avf-process                    event wait                0               0               1          1.19e5            0.00
bfd-process                    event wait                0               0               1          1.22e5            0.00
bond-process                   event wait                0               0               1          2.23e5            0.00
cnat-scanner-process           event wait                0               0               1          6.44e5            0.00
dev-config                        done                   1               0               0          2.98e5            0.00
dhcp-client-process             any wait                 0               0             766          2.37e6            0.00
dhcp6-client-cp-process         any wait                 0               0               1          2.29e5            0.00
dhcp6-pd-client-cp-process      any wait                 0               0               1          6.23e4            0.00
dhcp6-pd-reply-publisher-proce event wait                0               0               1          2.28e5            0.00
dhcp6-reply-publisher-process  event wait                0               0               1          2.88e5            0.00
drop                             active              12752           14453               0          3.13e5            1.13
error-drop                       active              12752           14453               0          3.36e5            1.13
ethernet-input                   active              10022           14842               0          1.18e6            1.48
fib-walk                        any wait                 0               0          382461          6.43e4            0.00
flow-report-process             any wait                 0               0               1          1.09e4            0.00
flowprobe-timer-process         any wait                 0               0               1          1.61e5            0.00
host-eth0-output                 active                401             401               0          6.35e4            1.00
host-eth0-tx                     active                401             401               0          6.37e5            1.00
igmp-timer-process             event wait                0               0               1          1.96e5            0.00
ikev2-manager-process          event wait                0               0               1          2.64e5            0.00
ioam-export-process             any wait                 0               0               1          3.34e5            0.00
ip-neighbor-event              event wait                0               0               1          3.29e5            0.00
ip4-drop                         active               1441            1640               0          2.68e6            1.14
ip4-full-reassembly-expire-wal  any wait                 0               0        15252086          1.68e4            0.00
ip4-glean                        active                  6               6               0          1.77e5            1.00
ip4-icmp-echo-reply              active                380             380               0          4.00e4            1.00
ip4-icmp-echo-request            active                 15              15               0          1.27e5            1.00
ip4-icmp-input                   active                395             395               0          2.86e4            1.00
ip4-input                        active               1830            2029               0          2.19e6            1.11
ip4-load-balance                 active                 15              15               0          4.93e4            1.00
ip4-lookup                       active               2216            2415               0          1.49e6            1.09
ip4-neighbor-age-process       event wait                0               0               1          7.74e4            0.00
ip4-receive                      active                395             395               0          2.78e4            1.00
ip4-rewrite                      active                395             395               0          3.48e4            1.00
ip4-sv-reassembly-expire-walk   any wait                 0               0           76500          2.42e5            0.00
ip6-full-reassembly-expire-wal  any wait                 0               0        15252086          1.70e4            0.00
ip6-input                        active                312             321               0          1.22e6            1.03
ip6-mld-process                 any wait                 0               0          764840          1.65e4            0.00
ip6-neighbor-age-process       event wait                0               0               1          2.94e5            0.00
ip6-not-enabled                  active                312             321               0          1.01e6            1.03
ip6-ra-process                  any wait                 0               0          764840          3.01e4            0.00
ip6-rs-process                  any wait                 0               0               1          2.92e5            0.00
ip6-sv-reassembly-expire-walk   any wait                 0               0           76500          4.58e5            0.00
l2-arp-term-publisher          event wait                0               0               1          1.97e4            0.00
l2fib-mac-age-scanner-process  event wait                0               0               1          5.25e5            0.00
lldp-process                   event wait                0               0               1          2.06e5            0.00
memif-process                  event wait                0               0               1          1.19e5            0.00
nat44-ei-ha-process            event wait                0               0               1          1.18e4            0.00
nsh-md2-ioam-export-process     any wait                 0               0               1          1.65e5            0.00
rd-cp-process                   any wait                 0               0               1          2.89e5            0.00
send-dhcp6-client-message-proc  any wait                 0               0               1          1.27e5            0.00
send-dhcp6-pd-client-message-p  any wait                 0               0               1          2.12e5            0.00
startup-config-process            done                   1               0               1          3.82e4            0.00
statseg-collector-process       time wait                0               0           76500          2.42e7            0.00
udp-ping-process                any wait                 0               0               1          1.14e5            0.00
unix-cli-new-session           event wait                0               0              34          7.88e5            0.00
unix-cli-process-0             event wait                7               0            4995          8.99e8            0.00
unix-cli-process-1               active                  0               0             312          1.64e5            0.00
unix-epoll-input                 polling       11993183211               0               0          1.52e5            0.00
vhost-user-process              any wait                 0               0               1          9.34e4            0.00
vhost-user-send-interrupt-proc  any wait                 0               0               1          2.58e5            0.00
vpe-link-state-process         event wait                0               0               3          2.88e5            0.00
vrrp-periodic-process          event wait                0               0               1          7.99e4            0.00
vxlan-gpe-ioam-export-process   any wait                 0               0               1          2.52e5            0.00
wg-timer-manager               event wait                0               0               1          1.48e5            0.00
</code></pre></li>
<li><code>/bin/vpp</code>&#x672C;&#x8EAB;&#x5E76;&#x4E0D;&#x5927;, &#x6838;&#x5FC3;&#x5E93;&#x5982;&#x4E0B;, &#x6700;&#x5173;&#x952E;&#x7684;&#x5E94;&#x8BE5;&#x5C31;&#x662F;&#x6700;&#x5927;&#x7684;&#x90A3;&#x4E2A;<code>libvnet.so</code></li>
</ul>
<pre class="language-"><code class="lang-shell"><span class="token comment"># ls -lh /lib/lib*.24.06</span>
-rwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">49</span>.9K Jul <span class="token number">24</span> 06:22 /lib/libnat.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root      <span class="token number">133</span>.8K Jul <span class="token number">24</span> 06:22 /lib/libsvm.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">29</span>.7K Jul <span class="token number">24</span> 06:22 /lib/libsvmdb.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">61</span>.6K Jul <span class="token number">24</span> 06:22 /lib/libvapiclient.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">13</span>.7K Jul <span class="token number">24</span> 06:22 /lib/libvatclient.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">13</span>.7K Jul <span class="token number">24</span> 06:22 /lib/libvatplugin.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">66</span>.0K Jul <span class="token number">24</span> 06:22 /lib/libvcl_ldpreload.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root        <span class="token number">1</span>.3M Jul <span class="token number">24</span> 06:22 /lib/libvlib.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">66</span>.4K Jul <span class="token number">24</span> 06:22 /lib/libvlibapi.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root      <span class="token number">191</span>.8K Jul <span class="token number">24</span> 06:22 /lib/libvlibmemory.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">41</span>.8K Jul <span class="token number">24</span> 06:22 /lib/libvlibmemoryclient.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">17</span>.7M Jul <span class="token number">24</span> 06:22 /lib/libvnet.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">37</span>.7K Jul <span class="token number">24</span> 06:22 /lib/libvppapiclient.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root      <span class="token number">250</span>.4K Jul <span class="token number">24</span> 06:22 /lib/libvppcom.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root      <span class="token number">670</span>.3K Jul <span class="token number">24</span> 06:22 /lib/libvppinfra.so.24.06
-rwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">13</span>.8K Jul <span class="token number">24</span> 06:22 /lib/libvppmem_preload.so.24.06
</code></pre>
<ul>
<li>vpp&#x4F7F;&#x7528;&#x4E86;plugin&#x673A;&#x5236;, &#x7528;<code>vppctl show plugins</code>&#x53EF;&#x4EE5;&#x770B;&#x5230;load&#x7684;plugin, &#x57FA;&#x672C;&#x4E0A;&#x4E3B;&#x6D41;&#x7684;&#x534F;&#x8BAE;&#x90FD;&#x652F;&#x6301;:</li>
</ul>
<pre class="language-"><code class="lang-shell"><span class="token comment"># ls /lib/vpp_plugins</span>
abf_plugin.so                  det44_plugin.so                hsi_plugin.so                  lisp_unittest_plugin.so        oddbuf_plugin.so               svs_plugin.so
acl_plugin.so                  dev_ena_plugin.so              http_plugin.so                 lldp_plugin.so                 perfmon_plugin.so              tlsopenssl_plugin.so
adl_plugin.so                  dev_iavf_plugin.so             http_static_plugin.so          mactime_plugin.so              ping_plugin.so                 tracedump_plugin.so
af_packet_plugin.so            dhcp_plugin.so                 idpf_plugin.so                 map_plugin.so                  pnat_plugin.so                 tracenode_plugin.so
arping_plugin.so               dispatch_trace_plugin.so       igmp_plugin.so                 mdata_plugin.so                pppoe_plugin.so                unittest_plugin.so
avf_plugin.so                  dma_intel_plugin.so            ikev2_plugin.so                memif_plugin.so                prom_plugin.so                 urpf_plugin.so
bufmon_plugin.so               dns_plugin.so                  ila_plugin.so                  mss_clamp_plugin.so            snort_plugin.so                vhost_plugin.so
builtinurl_plugin.so           dslite_plugin.so               ioam_plugin.so                 nat44_ei_plugin.so             srmpls_plugin.so               vmxnet3_plugin.so
cdp_plugin.so                  fateshare_plugin.so            ip_session_redirect_plugin.so  nat64_plugin.so                srv6ad_plugin.so               vrrp_plugin.so
cnat_plugin.so                 flowprobe_plugin.so            l2tp_plugin.so                 nat66_plugin.so                srv6adflow_plugin.so           vxlan_plugin.so
crypto_native_plugin.so        geneve_plugin.so               l3xc_plugin.so                 nat_plugin.so                  srv6am_plugin.so               wireguard_plugin.so
crypto_openssl_plugin.so       gre_plugin.so                  lacp_plugin.so                 npt66_plugin.so                srv6as_plugin.so
crypto_sw_scheduler_plugin.so  gtpu_plugin.so                 lb_plugin.so                   nsh_plugin.so                  srv6mobile_plugin.so
ct6_plugin.so                  hs_apps_plugin.so              lisp_plugin.so                 nsim_plugin.so                 stn_plugin.so
</code></pre>
<ul>
<li><code>pmap $(pidof vpp)</code>&#x53EF;&#x4EE5;&#x770B;&#x5230;vpp&#x5DF2;&#x7ECF;map&#x7684;so, &#x5176;&#x4E2D;&#x5C31;&#x6709;<code>af_packet_plugin.so</code></li>
</ul>
<pre class="language-"><code class="lang-shell"><span class="token comment"># pmap $(pidof vpp)</span>
<span class="token number">61</span>: vpp <span class="token parameter variable">-c</span> /etc/vpp/startup.conf
000000013000f000     132K rw-s  /dev/shm/global_vm
0000000130030000   16516K rw-s  /dev/shm/vpe-api
0000000131051000   48888K rw-s  /dev/shm/global_vm
0000000ffffff000       4K ---p    <span class="token punctuation">[</span> anon <span class="token punctuation">]</span>
0000001000000000   38912K rw-s  /memfd:buffers-numa-0
0000001002600000 16738304K ---p    <span class="token punctuation">[</span> anon <span class="token punctuation">]</span>
000055cd3e879000      20K r--p  /bin/vpp
000055cd3e87e000      68K r-xp  /bin/vpp
000055cd3e88f000      24K r--p  /bin/vpp
000055cd3e895000       4K r--p  /bin/vpp
000055cd3e896000       4K rw-p  /bin/vpp
000055cd3e897000       4K rw-p    <span class="token punctuation">[</span> anon <span class="token punctuation">]</span>
000055cd3ea72000       4K ---p  <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>
000055cd3ea73000      36K rw-p  <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>
00007fb984cba000       4K ---p    <span class="token punctuation">[</span> anon <span class="token punctuation">]</span>
00007fb984cbb000     256K rw-p    <span class="token punctuation">[</span> anon <span class="token punctuation">]</span>
00007fb984cfb000   77824K rw-s  socket:<span class="token punctuation">[</span><span class="token number">1867794799</span><span class="token punctuation">]</span>
00007fb9898fb000       4K ---p    <span class="token punctuation">[</span> anon <span class="token punctuation">]</span>
00007fb9898fc000      64K rw-p    <span class="token punctuation">[</span> anon <span class="token punctuation">]</span>
00007fb98990c000       4K ---p    <span class="token punctuation">[</span> anon <span class="token punctuation">]</span>
00007fb98990d000     256K rw-p    <span class="token punctuation">[</span> anon <span class="token punctuation">]</span>

<span class="token comment">#&#x51E0;&#x4E4E;&#x6240;&#x6709;&#x7684;/lib/vpp_plugins/&#x4E0B;&#x9762;&#x7684;so&#x90FD;&#x5728;&#x8FD9;&#x91CC;</span>
00007fb98d627000      12K r--p  /lib/vpp_plugins/af_packet_plugin.so
00007fb98d62a000     228K r-xp  /lib/vpp_plugins/af_packet_plugin.so
00007fb98d663000      32K r--p  /lib/vpp_plugins/af_packet_plugin.so
00007fb98d66b000       4K r--p  /lib/vpp_plugins/af_packet_plugin.so
00007fb98d66c000       4K rw-p  /lib/vpp_plugins/af_packet_plugin.so
<span class="token punctuation">..</span>.
00007fb9cd986000       8K r--p  /usr/lib/libunwind.so.8.0.1
00007fb9cd988000      28K r-xp  /usr/lib/libunwind.so.8.0.1
00007fb9cd98f000      12K r--p  /usr/lib/libunwind.so.8.0.1
00007fb9cd992000       4K r--p  /usr/lib/libunwind.so.8.0.1
00007fb9cd993000       4K rw-p  /usr/lib/libunwind.so.8.0.1
00007fb9cd994000      40K rw-p    <span class="token punctuation">[</span> anon <span class="token punctuation">]</span>
00007fb9cd99e000      20K r--p  /lib/libsvm.so.24.06
00007fb9cd9a3000      92K r-xp  /lib/libsvm.so.24.06
00007fb9cd9ba000      16K r--p  /lib/libsvm.so.24.06
00007fb9cd9be000       4K r--p  /lib/libsvm.so.24.06
00007fb9cd9bf000       4K rw-p  /lib/libsvm.so.24.06
00007fb9cd9c0000      40K r--p  /lib/libvppinfra.so.24.06
00007fb9cd9ca000     556K r-xp  /lib/libvppinfra.so.24.06
00007fb9cda55000      68K r--p  /lib/libvppinfra.so.24.06
00007fb9cda66000       8K r--p  /lib/libvppinfra.so.24.06
00007fb9cda68000       4K rw-p  /lib/libvppinfra.so.24.06
00007fb9cda69000      48K r--p  /lib/libvlib.so.24.06
00007fb9cda75000    1160K r-xp  /lib/libvlib.so.24.06
00007fb9cdb97000      76K r--p  /lib/libvlib.so.24.06
00007fb9cdbaa000       8K r--p  /lib/libvlib.so.24.06
00007fb9cdbac000      20K rw-p  /lib/libvlib.so.24.06
00007fb9cdbb1000       4K rw-p    <span class="token punctuation">[</span> anon <span class="token punctuation">]</span>
00007fb9cdbb2000      12K r--p  /lib/libvlibapi.so.24.06
00007fb9cdbb5000      44K r-xp  /lib/libvlibapi.so.24.06
00007fb9cdbc0000       8K r--p  /lib/libvlibapi.so.24.06
00007fb9cdbc2000       4K r--p  /lib/libvlibapi.so.24.06
00007fb9cdbc3000       4K rw-p  /lib/libvlibapi.so.24.06
00007fb9cdbc4000     400K r--p  /lib/libvnet.so.24.06
00007fb9cdc28000   15276K r-xp  /lib/libvnet.so.24.06
00007fb9ceb13000    2160K r--p  /lib/libvnet.so.24.06
00007fb9ced2f000      76K r--p  /lib/libvnet.so.24.06
00007fb9ced42000     184K rw-p  /lib/libvnet.so.24.06
00007fb9ced70000     140K rw-p    <span class="token punctuation">[</span> anon <span class="token punctuation">]</span>
00007fb9ced93000      20K r--p  /lib/libvlibmemory.so.24.06
00007fb9ced98000     124K r-xp  /lib/libvlibmemory.so.24.06
00007fb9cedb7000      40K r--p  /lib/libvlibmemory.so.24.06
00007fb9cedc1000       4K r--p  /lib/libvlibmemory.so.24.06
00007fb9cedc2000       4K rw-p  /lib/libvlibmemory.so.24.06
00007fb9cedc3000      80K r--p  /lib/ld-musl-x86_64.so.1
00007fb9cedd7000     304K r-xp  /lib/ld-musl-x86_64.so.1
00007fb9cee23000     216K r--p  /lib/ld-musl-x86_64.so.1
00007fb9cee59000       4K r--p  /lib/ld-musl-x86_64.so.1
00007fb9cee5a000       4K rw-p  /lib/ld-musl-x86_64.so.1
00007fb9cee5b000      12K rw-p    <span class="token punctuation">[</span> anon <span class="token punctuation">]</span>
00007fff2184f000     132K rw-p  <span class="token punctuation">[</span>stack<span class="token punctuation">]</span>
00007fff218ca000      12K r--p  <span class="token punctuation">[</span>vvar<span class="token punctuation">]</span>
00007fff218cd000       8K r-xp  <span class="token punctuation">[</span>vdso<span class="token punctuation">]</span>
ffffffffff600000       4K r-xp  <span class="token punctuation">[</span>vsyscall<span class="token punctuation">]</span>
mapped: 18057172K
</code></pre>
<h3 id="&#x5173;&#x4E8E;&#x7B26;&#x53F7;"><a name="&#x5173;&#x4E8E;&#x7B26;&#x53F7;" class="anchor-navigation-ex-anchor" href="#&#x5173;&#x4E8E;&#x7B26;&#x53F7;"><i class="fa fa-link" aria-hidden="true"></i></a>6.3.2. &#x5173;&#x4E8E;&#x7B26;&#x53F7;</h3>
<p>&#x5728;&#x6CA1;&#x6709;&#x5B89;&#x88C5;<code>vpp-dbg</code>&#x65F6;, &#x662F;&#x770B;&#x4E0D;&#x5230;&#x591A;&#x5C11;&#x51FD;&#x6570;&#x7B26;&#x53F7;&#x7684;:</p>
<ul>
<li></li>
<li>af_packet_plugin.so</li>
</ul>
<pre class="language-"><code class="lang-shell"><span class="token comment"># perf probe -x /lib/vpp_plugins/af_packet_plugin.so -F</span>
.plt
af_packet_device_class_tx_fn_hsw
af_packet_device_class_tx_fn_icl
af_packet_device_class_tx_fn_skx
af_packet_input_node_fn_hsw
af_packet_input_node_fn_icl
af_packet_input_node_fn_skx
vlib_plugin_registration

<span class="token comment">#readelf&#x80FD;&#x770B;&#x5230;&#x4E0A;&#x9762;&#x7684;&#x7B26;&#x53F7;, &#x540C;&#x65F6;&#x4E5F;&#x80FD;&#x770B;&#x5230;af_packet_plugin.so&#x8981;&#x5F15;&#x7528;&#x7684;&#x5176;&#x4ED6;so&#x7684;&#x7B26;&#x53F7;, &#x6BD4;&#x5982;ioctl mmap vlib_global_main vlib_put_next_frame vnet_device_main</span>
readelf /lib/vpp_plugins/af_packet_plugin.so <span class="token parameter variable">-a</span>

<span class="token comment">#&#x53EA;&#x6709;&#x4E0A;&#x9762;&#x51E0;&#x4E2A;&#x7B26;&#x53F7;, &#x7528;nm&#x90FD;&#x770B;&#x4E0D;&#x5230;&#x7B26;&#x53F7;</span>
<span class="token comment"># nm /lib/vpp_plugins/af_packet_plugin.so</span>
nm: /lib/vpp_plugins/af_packet_plugin.so: no symbols
</code></pre>
<p>&#x5B89;&#x88C5;<code>vpp-dbg</code>&#x540E;, &#x7B26;&#x53F7;&#x8868;&#x6587;&#x4EF6;&#x88AB;&#x5B89;&#x88C5;&#x5230;<code>/usr/lib/debug</code>&#x76EE;&#x5F55;&#x4E0B;. &#x8FD9;&#x4E9B;&#x7B26;&#x53F7;&#x8868;&#x662F;&#x7528;<code>objcopy --add-gnu-debuglink</code>&#x5236;&#x4F5C;&#x7684;, &#x6240;&#x4EE5;&#x548C;&#x539F;&#x59CB;elf&#x662F;&#x6709;&#x5173;&#x8054;&#x7684;</p>
<ul>
<li>af_packet_plugin.so</li>
</ul>
<pre class="language-"><code class="lang-shell"><span class="token comment"># nm&#x548C;readelf &#x539F;&#x59CB;&#x7684;bin&#x6216;&#x8005;so &#x663E;&#x793A;&#x548C;&#x6CA1;&#x5B89;&#x88C5;debug&#x7B26;&#x53F7;&#x8868;&#x4E00;&#x6837;</span>
<span class="token comment"># &#x4F46;&#x5BF9;.debug&#x6587;&#x4EF6;, &#x53EF;&#x4EE5;&#x770B;&#x5230;&#x66F4;&#x591A;&#x7684;&#x7B26;&#x53F7;</span>
nm /usr/lib/debug/lib/vpp_plugins/af_packet_plugin.so.debug
readelf /usr/lib/debug/lib/vpp_plugins/af_packet_plugin.so.debug <span class="token parameter variable">-a</span>

<span class="token comment"># &#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x91CD;&#x70B9;&#x5173;&#x6CE8; perf probe -F, &#x53EF;&#x4EE5;&#x88AB;probe&#x7684;&#x51FD;&#x6570;:</span>
perf probe <span class="token parameter variable">-x</span> /lib/vpp_plugins/af_packet_plugin.so <span class="token parameter variable">-F</span>
</code></pre>
<h3 id="&#x627E;&#x5230;&#x5173;&#x952E;&#x51FD;&#x6570;"><a name="&#x627E;&#x5230;&#x5173;&#x952E;&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#&#x627E;&#x5230;&#x5173;&#x952E;&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>6.3.3. &#x627E;&#x5230;&#x5173;&#x952E;&#x51FD;&#x6570;</h3>
<pre class="language-"><code class="lang-shell">perf probe <span class="token parameter variable">-x</span> /lib/vpp_plugins/af_packet_plugin.so <span class="token parameter variable">-F</span> <span class="token operator">|</span> <span class="token function">grep</span> af_packet_input_node

perf probe <span class="token parameter variable">-x</span> /lib/vpp_plugins/af_packet_plugin.so <span class="token parameter variable">-F</span> <span class="token operator">|</span> <span class="token function">grep</span> af_packet_device_class
</code></pre>
<ul>
<li>input&#x65B9;&#x5411;: &#x5E94;&#x8BE5;&#x662F;<code>af_packet_input_node_fn</code>, &#x5728;<code>src/plugins/af_packet/node.c</code></li>
<li>output&#x65B9;&#x5411;: &#x5E94;&#x8BE5;&#x662F;<code>af_packet_device_class_tx_fn</code>, &#x5728;<code>src/plugins/af_packet/device.c</code></li>
</ul>
<pre class="language-"><code class="lang-shell">perf probe <span class="token parameter variable">-x</span> /lib/vpp_plugins/af_packet_plugin.so <span class="token parameter variable">--add</span> af_packet_input_node_fn*

perf probe <span class="token parameter variable">-x</span> /lib/vpp_plugins/af_packet_plugin.so <span class="token parameter variable">--add</span> af_packet_device_class*

perf probe <span class="token parameter variable">--list</span>

perf record <span class="token parameter variable">-e</span> probe_af_packet_plugin:af_packet_input_node_fn* <span class="token parameter variable">-e</span> probe_af_packet_plugin:af_packet_device_class_tx_fn* <span class="token parameter variable">-R</span> <span class="token parameter variable">-p</span> <span class="token variable"><span class="token variable">$(</span>pidof vpp<span class="token variable">)</span></span> -- <span class="token function">sleep</span> <span class="token number">30</span>
</code></pre>
<h4 id="&#x7B2C;&#x4E00;&#x6B21;&#x5B9E;&#x9A8C;"><a name="&#x7B2C;&#x4E00;&#x6B21;&#x5B9E;&#x9A8C;" class="anchor-navigation-ex-anchor" href="#&#x7B2C;&#x4E00;&#x6B21;&#x5B9E;&#x9A8C;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x7B2C;&#x4E00;&#x6B21;&#x5B9E;&#x9A8C;</h4>
<p>&#x5728;vpp2&#x4E0A;ping vpp3:<br><img src="img/vpp_host_interace_20240802210923.png" alt=""></p>
<p>tcpdump:<br><img src="img/vpp_host_interace_20240802210835.png" alt=""></p>
<p>&#x5728;vpp3&#x4E0A;perf:</p>
<pre class="language-"><code class="lang-shell"><span class="token comment"># perf record -e probe_af_packet_plugin:af_packet_input_node_fn* -e probe_af_packet_plugin:af_packet_device_class_tx_fn* -R -p $(pidof vpp) -- sleep 30</span>
Couldn&apos;t synthesize bpf events.
<span class="token punctuation">[</span> perf record: Woken up <span class="token number">1</span> <span class="token builtin class-name">times</span> to <span class="token function">write</span> data <span class="token punctuation">]</span>
<span class="token punctuation">[</span> perf record: Captured and wrote <span class="token number">0.046</span> MB perf.data <span class="token punctuation">(</span><span class="token number">11</span> samples<span class="token punctuation">)</span> <span class="token punctuation">]</span>

root@RebornLinux:yingjieb_vpp3:62219 /home
<span class="token comment"># perf script</span>
        vpp_main    <span class="token number">61</span> <span class="token punctuation">[</span>010<span class="token punctuation">]</span> <span class="token number">20587651.672177</span>:                         probe_af_packet_plugin:af_packet_input_node_fn_hsw: <span class="token punctuation">(</span>7fb98d62ae20<span class="token punctuation">)</span>
        vpp_main    <span class="token number">61</span> <span class="token punctuation">[</span>010<span class="token punctuation">]</span> <span class="token number">20587651.672495</span>:                    probe_af_packet_plugin:af_packet_device_class_tx_fn_hsw: <span class="token punctuation">(</span>7fb98d633a10<span class="token punctuation">)</span>
        vpp_main    <span class="token number">61</span> <span class="token punctuation">[</span>010<span class="token punctuation">]</span> <span class="token number">20587652.676184</span>:                         probe_af_packet_plugin:af_packet_input_node_fn_hsw: <span class="token punctuation">(</span>7fb98d62ae20<span class="token punctuation">)</span>
        vpp_main    <span class="token number">61</span> <span class="token punctuation">[</span>010<span class="token punctuation">]</span> <span class="token number">20587652.676237</span>:                    probe_af_packet_plugin:af_packet_device_class_tx_fn_hsw: <span class="token punctuation">(</span>7fb98d633a10<span class="token punctuation">)</span>
        vpp_main    <span class="token number">61</span> <span class="token punctuation">[</span>010<span class="token punctuation">]</span> <span class="token number">20587653.668214</span>:                         probe_af_packet_plugin:af_packet_input_node_fn_hsw: <span class="token punctuation">(</span>7fb98d62ae20<span class="token punctuation">)</span>
        vpp_main    <span class="token number">61</span> <span class="token punctuation">[</span>010<span class="token punctuation">]</span> <span class="token number">20587653.668274</span>:                    probe_af_packet_plugin:af_packet_device_class_tx_fn_hsw: <span class="token punctuation">(</span>7fb98d633a10<span class="token punctuation">)</span>
        vpp_main    <span class="token number">61</span> <span class="token punctuation">[</span>010<span class="token punctuation">]</span> <span class="token number">20587654.672169</span>:                         probe_af_packet_plugin:af_packet_input_node_fn_hsw: <span class="token punctuation">(</span>7fb98d62ae20<span class="token punctuation">)</span>
        vpp_main    <span class="token number">61</span> <span class="token punctuation">[</span>010<span class="token punctuation">]</span> <span class="token number">20587654.672223</span>:                    probe_af_packet_plugin:af_packet_device_class_tx_fn_hsw: <span class="token punctuation">(</span>7fb98d633a10<span class="token punctuation">)</span>
        vpp_main    <span class="token number">61</span> <span class="token punctuation">[</span>010<span class="token punctuation">]</span> <span class="token number">20587655.676133</span>:                         probe_af_packet_plugin:af_packet_input_node_fn_hsw: <span class="token punctuation">(</span>7fb98d62ae20<span class="token punctuation">)</span>
        vpp_main    <span class="token number">61</span> <span class="token punctuation">[</span>010<span class="token punctuation">]</span> <span class="token number">20587655.676181</span>:                    probe_af_packet_plugin:af_packet_device_class_tx_fn_hsw: <span class="token punctuation">(</span>7fb98d633a10<span class="token punctuation">)</span>
        vpp_main    <span class="token number">61</span> <span class="token punctuation">[</span>010<span class="token punctuation">]</span> <span class="token number">20587657.784336</span>:                         probe_af_packet_plugin:af_packet_input_node_fn_hsw: <span class="token punctuation">(</span>7fb98d62ae20<span class="token punctuation">)</span>
</code></pre>
<h3 id="&#x7B2C;&#x4E8C;&#x6B21;&#x5B9E;&#x9A8C;"><a name="&#x7B2C;&#x4E8C;&#x6B21;&#x5B9E;&#x9A8C;" class="anchor-navigation-ex-anchor" href="#&#x7B2C;&#x4E8C;&#x6B21;&#x5B9E;&#x9A8C;"><i class="fa fa-link" aria-hidden="true"></i></a>6.3.4. &#x7B2C;&#x4E8C;&#x6B21;&#x5B9E;&#x9A8C;</h3>
<p>&#x7B2C;&#x4E00;&#x6B21;&#x5B9E;&#x9A8C;&#x91CC;, &#x53EA;&#x5728;vpp3&#x505A;&#x4E86;perf, &#x8FD9;&#x6B21;&#x6211;&#x4EEC;&#x540C;&#x65F6;&#x5728;vpp2&#x4E0A;&#x4E5F;&#x505A;perf:</p>
<p>&#x6CE8;&#x610F;!!!</p>
<p>&#x5728;&#x540C;&#x4E00;&#x4E2A;host&#x4E0A;&#x7684;&#x591A;&#x4E2A;&#x5BB9;&#x5668;, &#x5171;&#x4EAB;<code>perf probe --add</code>&#x7684;&#x914D;&#x7F6E;, &#x539F;&#x56E0;&#x5E94;&#x8BE5;&#x662F;perf&#x76F4;&#x63A5;&#x548C;kernel&#x4EA4;&#x4E92;. &#x5176;&#x4ED6;&#x7684;container&#x91CC;&#x9762;&#x7528;<code>perf probe --list</code>&#x80FD;&#x770B;&#x5230;&#x5176;&#x4ED6;container&#x7684;probe&#x70B9;. &#x5982;&#x679C;&#x9700;&#x8981;&#x5728;&#x672C;container&#x518D;&#x6B21;add, &#x5FC5;&#x987B;&#x52A0;<code>-f</code>&#x9009;&#x9879;:</p>
<pre class="language-"><code>perf probe -x /lib/vpp_plugins/af_packet_plugin.so --add af_packet_input_node_fn* -f

perf probe -x /lib/vpp_plugins/af_packet_plugin.so --add af_packet_device_class* -f
</code></pre><p>&#x8FD9;&#x6837;&#x5176;&#x5B9E;&#x6BCF;&#x4E2A;probe&#x7684;&#x51FD;&#x6570;&#x4F1A;&#x51FA;&#x73B0;&#x4E24;&#x6B21;, &#x5373;<code>perf probe --list</code>&#x80FD;&#x770B;&#x5230;&#x4E24;&#x6B21;:</p>
<pre class="language-"><code>probe_af_packet_plugin:af_packet_input_node_fn_hsw
probe_af_packet_plugin:af_packet_input_node_fn_hsw_1
</code></pre><p>&#x5728;vpp2&#x4E0A;&#x518D;ping&#x4E00;&#x6B21;<br><img src="img/vpp_host_interace_20240802213423.png" alt=""></p>
<p>tcpdump:<br><img src="img/vpp_host_interace_20240802213336.png" alt=""></p>
<p>&#x4F7F;&#x7528;&#x540C;&#x6837;&#x7684;&#x65B9;&#x6CD5;&#x5728;vpp2&#x4E0A;&#x540C;&#x65F6;&#x6293;perf<br><img src="img/vpp_host_interace_20240802213229.png" alt=""></p>
<h4 id="&#x5206;&#x6790;_1"><a name="&#x5206;&#x6790;_1" class="anchor-navigation-ex-anchor" href="#&#x5206;&#x6790;_1"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5206;&#x6790;</h4>
<p><code>perf script</code>&#x663E;&#x793A;&#x7684;&#x65F6;&#x95F4;, &#x662F;&#x76F8;&#x5BF9;machine&#x7684;boot time&#x7684;&#x65F6;&#x95F4;.</p>
<p>&#x5728; <a href="https://sequencediagram.org" target="_blank">https://sequencediagram.org</a> &#x7C98;&#x8D34;&#x4E0B;&#x9762;&#x7684;code</p>
<pre class="language-"><code class="lang-shell">participant <span class="token string">&quot;vppctl process on container2&quot;</span> as vppctl2
participant <span class="token string">&quot;vpp process on container2&quot;</span> as vpp2
participant <span class="token string">&quot;eth0 on container2&quot;</span> as eth02
participant <span class="token string">&quot;eth0 on container3&quot;</span> as eth03
participant <span class="token string">&quot;vpp process on container3&quot;</span> as vpp3

group pint totoal time: <span class="token number">17</span>.8ms
note over vppctl2: <span class="token function">ping</span> <span class="token number">10.10</span>.10.12
vppctl2-<span class="token operator">&gt;</span>vpp2: trigger <span class="token function">ping</span> <span class="token builtin class-name">command</span>
note over vpp2: send_ip46_ping
group record <span class="token function">time</span> by perf: <span class="token number">9</span>.2ms
note over vpp2: af_packet_device_class_tx_fn_hsw
vpp2-<span class="token operator">&gt;</span>eth02: vpp packet send
group record <span class="token function">time</span> by tcpdump: <span class="token number">2</span>.5ms
eth02-<span class="token operator">&gt;</span>eth03: <span class="token number">0</span>.6ms
group record <span class="token function">time</span> by tcpdump: <span class="token number">1</span>.8ms
eth03-<span class="token operator">&gt;</span>vpp3: vpp packet receive
note over vpp3: notify vpp: <span class="token number">0</span>.4ms<span class="token punctuation">(</span>calculated<span class="token punctuation">)</span>
group record <span class="token function">time</span> by perf: <span class="token number">1</span>.4ms
note over vpp3: af_packet_input_node_fn_hsw
note over vpp3: af_packet_device_class_tx_fn_hsw
end
vpp3-<span class="token operator">&gt;</span>eth03: vpp packet send
end
eth03-<span class="token operator">&gt;</span>eth02: <span class="token number">0</span>.05ms
end
eth02-<span class="token operator">&gt;</span>vpp2: vpp packet receive
note over vpp2: notify vpp ?????
note over vpp2: af_packet_input_node_fn_hsw
end
note over vpp2: print_ip46_icmp_reply
vpp2-<span class="token operator">&gt;</span>vppctl2: output result
note over vppctl2: display <span class="token function">ping</span> result
end
</code></pre>
<p>&#x5F97;&#x5230;&#x4E0B;&#x9762;&#x7684;&#x65F6;&#x5E8F;&#x56FE;:<br><img src="img/vpp2_ping_vpp3_latency_analysis.svg" alt=""></p>
<p>&#x540C;&#x6837;&#x7684;, &#x6211;&#x4EEC;&#x5206;&#x6790;&#x4E00;&#x4E0B;&#x7B2C;&#x4E8C;&#x4E2A;ICMP ping request&#x7684;&#x65F6;&#x5E8F;:<br><img src="img/vpp2_ping_vpp3_latency_analysis_p2.svg" alt=""></p>
<p>&#x7B2C;&#x4E09;&#x4E2A;:<br><img src="img/vpp2_ping_vpp3_latency_analysis_p3.svg" alt=""></p>
<p>&#x7B2C;&#x56DB;&#x4E2A;:
<img src="img/vpp2_ping_vpp3_latency_analysis_p4.svg" alt=""></p>
<p>&#x5728;vpp2 container&#x91CC;&#x9762;&#x518D;&#x589E;&#x52A0;&#x4E24;&#x4E2A;probe point, &#x4E3B;&#x8981;&#x8003;&#x5BDF;&#x4ECE;<code>send_ip46_ping</code>&#x5230;<code>print_ip46_icmp_reply</code>&#x7684;&#x65F6;&#x95F4;&#x548C;vpp ping&#x7684;&#x6253;&#x5370;&#x65F6;&#x95F4;&#x7684;&#x5173;&#x7CFB;:</p>
<pre class="language-"><code class="lang-shell"><span class="token comment"># ping&#x7684;&#x4E3B;&#x4F53;&#x4EE3;&#x7801;&#x5728;ping_plugin.so, &#x9605;&#x8BFB;&#x4EE3;&#x7801;, &#x6BCF;&#x4E2A;icmp&#x7684;ping request&#x90FD;&#x662F;&#x4ECE;send_ip46_ping&#x5F00;&#x59CB;&#x7684;</span>
perf probe <span class="token parameter variable">-x</span> /lib/vpp_plugins/ping_plugin.so <span class="token parameter variable">--add</span> send_ip46_ping
<span class="token comment"># &#x8FD9;&#x91CC;&#x5E94;&#x8BE5;probe print_ip46_icmp_reply, &#x4F46;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E0D;&#x80FD;probe, &#x4EE5;vlib_cli_output&#x4EE3;&#x66FF;.</span>
perf probe <span class="token parameter variable">-x</span> /lib/libvlib.so <span class="token parameter variable">--add</span> vlib_cli_output

<span class="token comment"># &#x5728;vpp2&#x4E0A;&#x6267;&#x884C;</span>
perf record <span class="token parameter variable">-e</span> probe_af_packet_plugin:af_packet_input_node_fn* <span class="token parameter variable">-e</span> probe_af_packet_plugin:af_packet_device_class_tx_fn* <span class="token parameter variable">-e</span> probe_ping_plugin:send_ip46_ping <span class="token parameter variable">-e</span> probe_libvlib:vlib_cli_output <span class="token parameter variable">-R</span> <span class="token parameter variable">-p</span> <span class="token variable"><span class="token variable">$(</span>pidof vpp<span class="token variable">)</span></span> -- <span class="token function">sleep</span> <span class="token number">30</span>
</code></pre>
<p>&#x7ED3;&#x679C;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code>vpp# ping 10.10.10.12                                        
116 bytes from 10.10.10.12: icmp_seq=1 ttl=64 time=20.1997 ms
116 bytes from 10.10.10.12: icmp_seq=2 ttl=64 time=16.4867 ms
116 bytes from 10.10.10.12: icmp_seq=3 ttl=64 time=20.4609 ms
116 bytes from 10.10.10.12: icmp_seq=4 ttl=64 time=8.4621 ms 
116 bytes from 10.10.10.12: icmp_seq=5 ttl=64 time=12.4755 ms


20.65ms
        vpp_main    63 [007] 20810116.579668:                                             probe_ping_plugin:send_ip46_ping: (7f11117c28d0)
    0.63ms
        vpp_main    63 [007] 20810116.580296:                    probe_af_packet_plugin:af_packet_device_class_tx_fn_hsw_1: (7f1112908a10)
        vpp_main    63 [007] 20810116.600069:                         probe_af_packet_plugin:af_packet_input_node_fn_hsw_1: (7f11128ffe20)
        vpp_main    63 [007] 20810116.600318:                                                probe_libvlib:vlib_cli_output: (7f1152d57fc0)

16.51ms
        vpp_main    63 [007] 20810117.579663:                                             probe_ping_plugin:send_ip46_ping: (7f11117c28d0)
    3.17ms
        vpp_main    63 [007] 20810117.582837:                    probe_af_packet_plugin:af_packet_device_class_tx_fn_hsw_1: (7f1112908a10)
        vpp_main    63 [010] 20810117.596145:                         probe_af_packet_plugin:af_packet_input_node_fn_hsw_1: (7f11128ffe20)
        vpp_main    63 [010] 20810117.596179:                                                probe_libvlib:vlib_cli_output: (7f1152d57fc0)

20.49ms
        vpp_main    63 [000] 20810118.579666:                                             probe_ping_plugin:send_ip46_ping: (7f11117c28d0)
    7.18ms
        vpp_main    63 [000] 20810118.586850:                    probe_af_packet_plugin:af_packet_device_class_tx_fn_hsw_1: (7f1112908a10)
        vpp_main    63 [010] 20810118.600124:                         probe_af_packet_plugin:af_packet_input_node_fn_hsw_1: (7f11128ffe20)
        vpp_main    63 [010] 20810118.600158:                                                probe_libvlib:vlib_cli_output: (7f1152d57fc0)

8.49ms
        vpp_main    63 [000] 20810119.579671:                                             probe_ping_plugin:send_ip46_ping: (7f11117c28d0)
    0.03ms
        vpp_main    63 [000] 20810119.579708:                    probe_af_packet_plugin:af_packet_device_class_tx_fn_hsw_1: (7f1112908a10)
        vpp_main    63 [010] 20810119.588114:                         probe_af_packet_plugin:af_packet_input_node_fn_hsw_1: (7f11128ffe20)
        vpp_main    63 [010] 20810119.588164:                                                probe_libvlib:vlib_cli_output: (7f1152d57fc0)

12.51ms
        vpp_main    63 [011] 20810120.579670:                                             probe_ping_plugin:send_ip46_ping: (7f11117c28d0)
    4.16ms
        vpp_main    63 [011] 20810120.583834:                    probe_af_packet_plugin:af_packet_device_class_tx_fn_hsw_1: (7f1112908a10)
        vpp_main    63 [010] 20810120.592139:                         probe_af_packet_plugin:af_packet_input_node_fn_hsw_1: (7f11128ffe20)
        vpp_main    63 [010] 20810120.592180:                                                probe_libvlib:vlib_cli_output: (7f1152d57fc0)
</code></pre><h4 id="&#x7ED3;&#x8BBA;"><a name="&#x7ED3;&#x8BBA;" class="anchor-navigation-ex-anchor" href="#&#x7ED3;&#x8BBA;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x7ED3;&#x8BBA;</h4>
<ul>
<li><code>vpp-dbg</code>&#x5B89;&#x88C5;&#x4E86;&#x5206;&#x79BB;&#x5F0F;&#x7684;debug&#x7B26;&#x53F7;, &#x4E5F;&#x597D;&#x7528;&#x7684;.</li>
<li>vpp&#x7684;ping&#x7684;&#x5EF6;&#x8FDF;&#x8FDC;&#x8FDC;&#x5927;&#x4E8E;kernel&#x7684;ping<ul>
<li>&#x7EAF;&#x5904;&#x7406;ICMP&#x7684;&#x62A5;&#x6587;&#x7684;&#x65F6;&#x95F4;&#x5F88;&#x5C0F;</li>
<li>&#x4F3C;&#x4E4E;&#x5927;&#x5934;&#x90FD;&#x82B1;&#x5728;kenel&#x6536;&#x5305;&#x540E;, &#x901A;&#x77E5;vpp&#x7684;&#x65F6;&#x95F4;&#x592A;&#x957F;</li>
<li>&#x6216;&#x8005;vpp&#x6846;&#x67B6;&#x6536;&#x5230;kernel&#x7684;&#x901A;&#x77E5;&#x540E;, &#x518D;&#x8C03;&#x7528;<code>af_packet_input_node_fn_hsw</code>&#x7684;&#x65F6;&#x95F4;&#x592A;&#x957F;</li>
<li>notify&#x7684;&#x65F6;&#x95F4;&#x5F88;&#x4E0D;&#x7A33;&#x5B9A;, &#x4ECE;0.4ms&#x5230;8ms&#x4E0D;&#x7B49;</li>
</ul>
</li>
<li>&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x5927;&#x5934;&#x662F;vpp&#x81EA;&#x5DF1;&#x663E;&#x793A;&#x7684;&#x65F6;&#x95F4;&#x4F3C;&#x4E4E;&#x66F4;&#x957F;.<ul>
<li>vpp ping&#x7684;&#x65F6;&#x95F4;&#x663E;&#x793A;&#x662F;&#x6B63;&#x786E;&#x7684;</li>
<li>&#x4ECE;<code>send_ip46_ping</code>&#x5230;<code>af_packet_device_class_tx_fn_hsw</code>&#x7684;&#x65F6;&#x95F4;&#x95F4;&#x9694;&#x5F88;&#x4E0D;&#x7A33;&#x5B9A;, &#x4ECE;0.03ms&#x5230;7.18ms&#x751A;&#x81F3;&#x66F4;&#x957F;</li>
</ul>
</li>
<li>&#x4F3C;&#x4E4E;8ms&#x662F;vpp&#x5185;&#x90E8;&#x7684;&#x67D0;&#x79CD;event&#x7684;&#x9608;&#x503C;?</li>
</ul>
<p>&#x5C1D;&#x8BD5;performance tuning</p>
<ul>
<li>&#x591A;worker -- &#x4E0D;&#x7BA1;&#x7528;, &#x6BCF;&#x4E2A;worker&#x90FD;&#x5360;4%&#x7684;CPU, &#x5BFC;&#x81F4;&#x6574;&#x4F53;CPU&#x5728;16%&#x4E0A;&#x4E0B;.</li>
<li>chrt 50 -- &#x6709;&#x70B9;&#x4F5C;&#x7528;, &#x4F46;&#x8FD8;&#x662F;10+ms</li>
</ul>
<h3 id="&#x6DF1;&#x5165;&#x5206;&#x6790;&#x65F6;&#x95F4;&#x6D88;&#x8017;"><a name="&#x6DF1;&#x5165;&#x5206;&#x6790;&#x65F6;&#x95F4;&#x6D88;&#x8017;" class="anchor-navigation-ex-anchor" href="#&#x6DF1;&#x5165;&#x5206;&#x6790;&#x65F6;&#x95F4;&#x6D88;&#x8017;"><i class="fa fa-link" aria-hidden="true"></i></a>6.3.5. &#x6DF1;&#x5165;&#x5206;&#x6790;&#x65F6;&#x95F4;&#x6D88;&#x8017;</h3>
<p>&#x7ED3;&#x5408;&#x4E0A;&#x9762;&#x7684;&#x5206;&#x6790;, &#x6211;&#x91CD;&#x70B9;&#x6000;&#x7591;&#x8FD9;&#x4E2A;&#x65B9;&#x5411;: <strong>vpp&#x6846;&#x67B6;&#x6536;&#x5230;kernel&#x7684;&#x901A;&#x77E5;&#x540E;, &#x518D;&#x8C03;&#x7528;<code>af_packet_input_node_fn_hsw</code>&#x7684;&#x65F6;&#x95F4;&#x592A;&#x957F;</strong></p>
<p>&#x90A3;&#x4E48;&#x5C31;&#x9700;&#x8981;&#x4E86;&#x89E3;, &#x5728;vpp&#x8C03;&#x7528;<code>af_packet_input_node_fn_hsw</code>&#x4E4B;&#x524D;, &#x90FD;&#x505A;&#x4E86;&#x4EC0;&#x4E48;. &#x8FD9;&#x5C31;&#x7528;&#x5230;&#x4E86;perf&#x7684;&#x8C03;&#x7528;&#x6808;&#x89E3;&#x6790;:</p>
<pre class="language-"><code class="lang-shell"><span class="token comment"># &#x9996;&#x5148;&#x5220;&#x9664;&#x6240;&#x6709;&#x7684;probe</span>
perf probe <span class="token parameter variable">--del</span> <span class="token string">&quot;*&quot;</span>
<span class="token comment"># &#x589E;&#x52A0;tx&#x51FD;&#x6570;</span>
perf probe <span class="token parameter variable">-x</span> /lib/vpp_plugins/af_packet_plugin.so <span class="token parameter variable">--add</span> af_packet_device_class_tx_fn_hsw
<span class="token comment"># &#x589E;&#x52A0;rx&#x51FD;&#x6570;</span>
perf probe <span class="token parameter variable">-x</span> /lib/vpp_plugins/af_packet_plugin.so <span class="token parameter variable">--add</span> af_packet_input_node_fn_hsw
<span class="token comment"># &#x5E26;&#x8C03;&#x7528;&#x6808;record, &#x52A0;--call-graph dwarf&#x6709;&#x5229;&#x4E8E;&#x8C03;&#x7528;&#x6808;&#x89E3;&#x6790;</span>
perf record <span class="token parameter variable">-e</span> probe_af_packet_plugin:af_packet_input_node_fn* <span class="token parameter variable">-e</span> probe_af_packet_plugin:af_packet_device_class_tx_fn* <span class="token parameter variable">-R</span> <span class="token parameter variable">-p</span> <span class="token variable"><span class="token variable">$(</span>pidof vpp<span class="token variable">)</span></span> <span class="token parameter variable">-g</span> --call-graph dwarf -- <span class="token function">sleep</span> <span class="token number">30</span>
</code></pre>
<p>&#x7ED3;&#x679C;:</p>
<pre class="language-"><code>vpp_main   360 [001] 20847215.566923: probe_af_packet_plugin:af_packet_device_class_tx_fn_hsw: (7f6f34744a10)
                    ca10 af_packet_device_class_tx_fn_hsw+0x0 (/lib/vpp_plugins/af_packet_plugin.so)
                   2caea dispatch_node+0x13a (inlined)
                   2caea dispatch_pending_node+0x13a (/lib/libvlib.so.24.06)
                   32094 vlib_main_or_worker_loop+0x1194 (inlined)
                   32094 vlib_main_loop+0x1194 (inlined)
                   32094 vlib_main+0x1194 (/lib/libvlib.so.24.06)
                   8a569 thread0+0x29 (/lib/libvlib.so.24.06)
                   94feb clib_calljmp+0x17 (/lib/libvppinfra.so.24.06)

vpp_main   360 [000] 20847215.576155:      probe_af_packet_plugin:af_packet_input_node_fn_hsw: (7f6f3473be20)
                    3e20 af_packet_input_node_fn_hsw+0x0 (/lib/vpp_plugins/af_packet_plugin.so)
                   32c58 dispatch_node+0x1d58 (inlined)
                   32c58 vlib_main_or_worker_loop+0x1d58 (inlined)
                   32c58 vlib_main_loop+0x1d58 (inlined)
                   32c58 vlib_main+0x1d58 (/lib/libvlib.so.24.06)
                   8a569 thread0+0x29 (/lib/libvlib.so.24.06)
                   94feb clib_calljmp+0x17 (/lib/libvppinfra.so.24.06)
</code></pre><p>&#x5230;&#x8FD9;&#x91CC;&#x5C31;&#x4E00;&#x5B9A;&#x8981;&#x770B;&#x4EE3;&#x7801;&#x4E86;. &#x7ED3;&#x5408;&#x4EE3;&#x7801;&#x589E;&#x52A0;probe&#x70B9;:</p>
<pre class="language-"><code class="lang-shell"><span class="token comment"># &#x7ED3;&#x5408;&#x6E90;&#x7801;, dispatch_pending_node&#x662F;tx&#x65B9;&#x5411;&#x7684;</span>
perf probe <span class="token parameter variable">-x</span> /lib/libvlib.so.24.06 <span class="token parameter variable">--add</span> dispatch_pending_node
<span class="token comment"># dispatch_node&#x662F;&#x4E3B;&#x5FAA;&#x73AF;&#x7684;&#x6838;&#x5FC3;check&#x70B9;, &#x8FD9;&#x662F;&#x4E2A;inline&#x51FD;&#x6570;</span>
perf probe <span class="token parameter variable">-x</span> /lib/libvlib.so.24.06 <span class="token parameter variable">--add</span> dispatch_node

<span class="token comment"># &#x4ECE;&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x6765;, inline&#x7684;dispatch_node&#x51FD;&#x6570;&#x4E5F;&#x53EF;&#x4EE5;probe, &#x4F46;&#x5B58;&#x5728;&#x591A;&#x4E2A;.</span>
<span class="token comment"># &#x7ED3;&#x5408;&#x4EE3;&#x7801;, &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5728;vlib_main_or_worker_loop&#x91CC;&#x9762;&#x7684;&#x591A;&#x4E2A;&#x5730;&#x65B9;&#x88AB;&#x8C03;&#x7528;</span>
<span class="token comment"># perf&#x7684;&#x4EE3;&#x7801;&#x89E3;&#x6790;probe&#x70B9;&#x7684;&#x884C;&#x53F7;&#x5F88;&#x51C6;, &#x4EE5;&#x51FD;&#x6570;&#x7684;&#x8D77;&#x59CB;&#x884C;&#x4E3A;0&#x8D77;&#x59CB;</span>
perf probe <span class="token parameter variable">--list</span>
  probe_af_packet_plugin:af_packet_device_class_tx_fn_hsw <span class="token punctuation">(</span>on af_packet_device_class_tx_fn_hsw@plugins/af_packet/device.c <span class="token keyword">in</span> /lib/vpp_plugins/af_packet_plugin.so<span class="token punctuation">)</span>
  probe_af_packet_plugin:af_packet_input_node_fn_hsw <span class="token punctuation">(</span>on af_packet_input_node_fn_hsw@src/plugins/af_packet/node.c <span class="token keyword">in</span> /lib/vpp_plugins/af_packet_plugin.so<span class="token punctuation">)</span>
  probe_libvlib:dispatch_node <span class="token punctuation">(</span>on vlib_main_or_worker_loop:98@src/vpp-24.06/src/vlib/main.c <span class="token keyword">in</span> /lib/libvlib.so.24.06<span class="token punctuation">)</span>
  probe_libvlib:dispatch_node_1 <span class="token punctuation">(</span>on vlib_main_or_worker_loop:122@src/vpp-24.06/src/vlib/main.c <span class="token keyword">in</span> /lib/libvlib.so.24.06<span class="token punctuation">)</span>
  probe_libvlib:dispatch_node_2 <span class="token punctuation">(</span>on vlib_main_or_worker_loop:114@src/vpp-24.06/src/vlib/main.c <span class="token keyword">in</span> /lib/libvlib.so.24.06<span class="token punctuation">)</span>
  probe_libvlib:dispatch_node_3 <span class="token punctuation">(</span>on vlib_main_or_worker_loop:141@src/vpp-24.06/src/vlib/main.c <span class="token keyword">in</span> /lib/libvlib.so.24.06<span class="token punctuation">)</span>
  probe_libvlib:dispatch_node_4 <span class="token punctuation">(</span>on vlib_main_or_worker_loop:98@src/vpp-24.06/src/vlib/main.c <span class="token keyword">in</span> /lib/libvlib.so.24.06<span class="token punctuation">)</span>
  probe_libvlib:dispatch_node_5 <span class="token punctuation">(</span>on vlib_main_or_worker_loop:114@src/vpp-24.06/src/vlib/main.c <span class="token keyword">in</span> /lib/libvlib.so.24.06<span class="token punctuation">)</span>
  probe_libvlib:dispatch_node_6 <span class="token punctuation">(</span>on vlib_main_or_worker_loop:122@src/vpp-24.06/src/vlib/main.c <span class="token keyword">in</span> /lib/libvlib.so.24.06<span class="token punctuation">)</span>
  probe_libvlib:dispatch_node_7 <span class="token punctuation">(</span>on vlib_main_or_worker_loop:141@src/vpp-24.06/src/vlib/main.c <span class="token keyword">in</span> /lib/libvlib.so.24.06<span class="token punctuation">)</span>
  probe_libvlib:dispatch_node_8 <span class="token punctuation">(</span>on dispatch_pending_node:51@src/vpp-24.06/src/vlib/main.c <span class="token keyword">in</span> /lib/libvlib.so.24.06<span class="token punctuation">)</span>

perf record <span class="token parameter variable">-e</span> probe_af_packet_plugin:af_packet_input_node_fn* <span class="token parameter variable">-e</span> probe_af_packet_plugin:af_packet_device_class_tx_fn* <span class="token parameter variable">-e</span> probe_libvlib:dispatch_node* <span class="token parameter variable">-R</span> <span class="token parameter variable">-p</span> <span class="token variable"><span class="token variable">$(</span>pidof vpp<span class="token variable">)</span></span> -- <span class="token function">sleep</span> <span class="token number">30</span>
</code></pre>
<p>&#x89C2;&#x5BDF;&#x7ED3;&#x679C;, &#x4EE5;&#x4E0B;&#x90E8;&#x5206;&#x603B;&#x662F;&#x91CD;&#x590D;</p>
<pre class="language-"><code>        vpp_main   360 [020] 20922246.032891:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.032898:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.032905:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.032913:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.042159:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042175:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042184:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042191:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042198:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042206:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042214:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042221:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042228:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042236:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042243:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042251:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042258:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042266:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042274:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042281:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042288:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042296:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042303:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042310:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042317:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042327:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042334:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042342:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042349:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042356:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042363:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042370:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042377:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042385:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
        vpp_main   360 [020] 20922246.042392:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
...
&#x5F53;&#x6709;packet&#x6765;&#x65F6;:
        vpp_main   360 [000] 20922248.528638:                           probe_libvlib:dispatch_node_3: (7f6f74bacbda)
        vpp_main   360 [000] 20922248.528648:      probe_af_packet_plugin:af_packet_input_node_fn_hsw: (7f6f3473be20)
        vpp_main   360 [000] 20922248.529029:                           probe_libvlib:dispatch_node_8: (7f6f74ba6a49)
        vpp_main   360 [000] 20922248.529566:                           probe_libvlib:dispatch_node_8: (7f6f74ba6a49)
        vpp_main   360 [000] 20922248.529731:                           probe_libvlib:dispatch_node_8: (7f6f74ba6a49)
        vpp_main   360 [000] 20922248.529744:                           probe_libvlib:dispatch_node_8: (7f6f74ba6a49)
        vpp_main   360 [000] 20922248.529750:                           probe_libvlib:dispatch_node_8: (7f6f74ba6a49)
        vpp_main   360 [000] 20922248.529857:                           probe_libvlib:dispatch_node_8: (7f6f74ba6a49)
        vpp_main   360 [000] 20922248.530092:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [000] 20922248.530110:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [000] 20922248.530120:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [000] 20922248.530128:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
</code></pre><p>&#x6574;&#x7406;&#x4EE3;&#x7801;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code class="lang-c"><span class="token comment">// src/vlib/main.c</span>
vlib_main_or_worker_loop
  <span class="token comment">/* Process pre-input nodes. */</span>
  <span class="token function">vec_foreach</span> <span class="token punctuation">(</span>n<span class="token punctuation">,</span> nm<span class="token operator">-&gt;</span>nodes_by_type<span class="token punctuation">[</span>VLIB_NODE_TYPE_PRE_INPUT<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">//&#x5BF9;&#x5E94;dispatch_node</span>
    <span class="token function">dispatch_node</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> n<span class="token punctuation">,</span> VLIB_NODE_TYPE_PRE_INPUT<span class="token punctuation">,</span> VLIB_NODE_STATE_POLLING<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">clib_interrupt_is_any_pending</span> <span class="token punctuation">(</span>nm<span class="token operator">-&gt;</span>pre_input_node_interrupts<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">clib_interrupt_get_next_and_clear</span><span class="token punctuation">(</span>nm<span class="token operator">-&gt;</span>pre_input_node_interrupts<span class="token punctuation">)</span><span class="token punctuation">)</span>
      n <span class="token operator">=</span> <span class="token function">vec_elt_at_index</span><span class="token punctuation">(</span>nm<span class="token operator">-&gt;</span>nodes_by_type<span class="token punctuation">[</span>VLIB_NODE_TYPE_PRE_INPUT<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token function">dispatch_node</span> <span class="token punctuation">(</span>vm<span class="token punctuation">,</span> n<span class="token punctuation">,</span> VLIB_NODE_TYPE_PRE_INPUT<span class="token punctuation">,</span> VLIB_NODE_STATE_INTERRUPT<span class="token punctuation">)</span>

  <span class="token comment">/* Next process input nodes. */</span>
  <span class="token function">vec_foreach</span> <span class="token punctuation">(</span>n<span class="token punctuation">,</span> nm<span class="token operator">-&gt;</span>nodes_by_type<span class="token punctuation">[</span>VLIB_NODE_TYPE_INPUT<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">//&#x5BF9;&#x5E94;dispatch_node_1</span>
    <span class="token function">dispatch_node</span> <span class="token punctuation">(</span>vm<span class="token punctuation">,</span> n<span class="token punctuation">,</span> VLIB_NODE_TYPE_INPUT<span class="token punctuation">,</span> VLIB_NODE_STATE_POLLING<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">clib_interrupt_is_any_pending</span> <span class="token punctuation">(</span>nm<span class="token operator">-&gt;</span>input_node_interrupts<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">clib_interrupt_get_next_and_clear</span><span class="token punctuation">(</span>nm<span class="token operator">-&gt;</span>input_node_interrupts<span class="token punctuation">)</span><span class="token punctuation">)</span>
      n <span class="token operator">=</span> <span class="token function">vec_elt_at_index</span><span class="token punctuation">(</span>nm<span class="token operator">-&gt;</span>nodes_by_type<span class="token punctuation">[</span>VLIB_NODE_TYPE_INPUT<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token comment">//&#x5BF9;&#x5E94;dispatch_node_3</span>
      <span class="token function">dispatch_node</span> <span class="token punctuation">(</span>vm<span class="token punctuation">,</span> n<span class="token punctuation">,</span> VLIB_NODE_TYPE_INPUT<span class="token punctuation">,</span>VLIB_NODE_STATE_INTERRUPT<span class="token punctuation">)</span>

  <span class="token comment">//&#x81F3;&#x6B64;input node&#x5904;&#x7406;&#x5B8C;&#x6BD5;</span>
  <span class="token comment">//&#x5728;&#x5904;&#x7406;&#x94FE;&#x7684;&#x6700;&#x540E;, &#x901A;&#x5E38;&#x90FD;&#x6709;&#x53D1;&#x9001;, &#x8FD9;&#x4E9B;&#x53D1;&#x9001;&#x7684;packet&#x4F1A;&#x88AB;&#x653E;&#x5230;pending node&#x91CC;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>&#x5168;&#x90E8;&#x7684;pending node<span class="token punctuation">)</span>
    <span class="token function">dispatch_pending_node</span> <span class="token punctuation">(</span>vm<span class="token punctuation">,</span> i<span class="token punctuation">,</span> cpu_time_now<span class="token punctuation">)</span>

  <span class="token comment">//&#x66F4;&#x65B0;&#x7EDF;&#x8BA1;</span>
</code></pre>
<p>&#x901A;&#x8FC7;&#x4EE3;&#x7801;&#x68B3;&#x7406;, &#x53D1;&#x73B0;vpp&#x7684;main loop&#x662F;polling&#x548C;event&#x7ED3;&#x5408;&#x7684;&#x5904;&#x7406;&#x65B9;&#x5F0F;:</p>
<ul>
<li>&#x5148;&#x5904;&#x7406;&#x6240;&#x6709;pre_input node<ul>
<li>&#x4F18;&#x5148;&#x5904;&#x7406;polling&#x6A21;&#x5F0F;&#x7684;</li>
<li>&#x518D;&#x5904;&#x7406;interrupt&#x6A21;&#x5F0F;&#x7684;</li>
<li>&#x4E00;&#x5171;4&#x4E2A;&#x8FD9;&#x6837;&#x7684;node</li>
</ul>
</li>
<li>&#x518D;&#x5904;&#x7406;&#x6240;&#x6709;input node<ul>
<li>&#x4F18;&#x5148;&#x5904;&#x7406;polling&#x6A21;&#x5F0F;&#x7684;</li>
<li>&#x518D;&#x5904;&#x7406;interrupt&#x6A21;&#x5F0F;&#x7684;</li>
<li>&#x4E00;&#x5171;31&#x4E2A;&#x8FD9;&#x6837;&#x7684;node</li>
</ul>
</li>
</ul>
<p>&#x7ED3;&#x5408;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x89C2;&#x5BDF;&#x5230;&#x7684;&#x89C4;&#x5F8B;: &#x5728;&#x5904;&#x7406;polling&#x7684;VLIB_NODE_TYPE_PRE_INPUT&#x548C;polling&#x7684;VLIB_NODE_TYPE_INPUT&#x4E4B;&#x95F4;, &#x7ECF;&#x5E38;&#x4F1A;&#x6709;&#x957F;&#x65F6;&#x95F4;&#x7684;&#x95F4;&#x9694;, &#x6BD4;&#x5982;&#x8FD9;&#x91CC;&#x7684;10ms:</p>
<pre class="language-"><code>vpp_main   360 [020] 20922246.032913:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
vpp_main   360 [020] 20922246.042159:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
</code></pre><p>&#x5F88;&#x53EF;&#x80FD;&#x5728;&#x5904;&#x7406;&#x67D0;&#x4E2A;VLIB_NODE_TYPE_PRE_INPUT&#x7C7B;&#x578B;&#x7684;node&#x7684;&#x65F6;&#x95F4;&#x592A;&#x957F;&#x5BFC;&#x81F4;&#x5230;&#x4E0B;&#x4E2A;&#x73AF;&#x8282;</p>
<p>&#x4EE3;&#x7801;&#x641C;&#x7D22;<code>VLIB_NODE_TYPE_PRE_INPUT</code>, &#x6B63;&#x597D;&#x662F;4&#x4E2A;&#x76F8;&#x5173;&#x4EE3;&#x7801;:<br><img src="img/vpp2_ping_vpp3_code_VLIB_NODE_TYPE_PRE_INPUT.png" alt=""></p>
<p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x91CD;&#x70B9;&#x5173;&#x6CE8;<code>src/vlib/unix</code></p>
<pre class="language-"><code>static uword
linux_epoll_input (vlib_main_t * vm,
           vlib_node_runtime_t * node, vlib_frame_t * frame)
{
  u32 thread_index = vlib_get_thread_index ();

  if (thread_index == 0)
    return linux_epoll_input_inline (vm, node, frame, 0);
  else
    return linux_epoll_input_inline (vm, node, frame, thread_index);
}

VLIB_REGISTER_NODE (linux_epoll_input_node,static) = {
  .function = linux_epoll_input,
  .type = VLIB_NODE_TYPE_PRE_INPUT,
  .name = &quot;unix-epoll-input&quot;,
};
</code></pre><p>&#x589E;&#x52A0;probe&#x70B9;:</p>
<pre class="language-"><code class="lang-shell">perf probe <span class="token parameter variable">-x</span> /lib/libvlib.so <span class="token parameter variable">--add</span> linux_epoll_input
<span class="token comment"># &#x5F97;&#x5230; -e probe_libvlib:linux_epoll_input</span>
perf probe <span class="token parameter variable">-x</span> /lib/libvlib.so <span class="token parameter variable">--add</span> linux_epoll_input%return
<span class="token comment"># &#x5F97;&#x5230;-e probe_libvlib:linux_epoll_input__return</span>

perf record <span class="token parameter variable">-e</span> probe_af_packet_plugin:af_packet_input_node_fn* <span class="token parameter variable">-e</span> probe_af_packet_plugin:af_packet_device_class_tx_fn* <span class="token parameter variable">-e</span> probe_libvlib:dispatch_node* <span class="token parameter variable">-e</span> probe_libvlib:linux_epoll_input
<span class="token parameter variable">-e</span> probe_libvlib:linux_epoll_input__return <span class="token parameter variable">-R</span> <span class="token parameter variable">-p</span> <span class="token variable"><span class="token variable">$(</span>pidof vpp<span class="token variable">)</span></span> -- <span class="token function">sleep</span> <span class="token number">10</span>
</code></pre>
<p>&#x7ED3;&#x679C;&#x53EF;&#x4EE5;&#x770B;&#x5230;, linux_epoll_input&#x5904;&#x7406;&#x65F6;&#x95F4;&#x4E0D;&#x7A33;&#x5B9A;, &#x4ECE;0.2ms&#x5230;10ms&#x90FD;&#x6709;.</p>
<pre class="language-"><code>        vpp_main   360 [020] 20922246.032891:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.032898:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.032905:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.032913:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.032921:                         probe_libvlib:linux_epoll_input: (7f6f74c03150)
        vpp_main   360 [020] 20922246.042147:                 probe_libvlib:linux_epoll_input__return: (7f6f74c03150 &lt;- 7f6f74bab7a0)
        vpp_main   360 [020] 20922246.042159:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)

        vpp_main   360 [020] 20922246.042417:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.042425:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.042432:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.042441:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.042448:                         probe_libvlib:linux_epoll_input: (7f6f74c03150)
        vpp_main   360 [020] 20922246.042463:                 probe_libvlib:linux_epoll_input__return: (7f6f74c03150 &lt;- 7f6f74bab7a0)
        vpp_main   360 [020] 20922246.042465:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)

        vpp_main   360 [020] 20922246.042694:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.042702:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.042713:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.042720:                             probe_libvlib:dispatch_node: (7f6f74bab70e)
        vpp_main   360 [020] 20922246.042729:                         probe_libvlib:linux_epoll_input: (7f6f74c03150)
        vpp_main   360 [020] 20922246.052133:                 probe_libvlib:linux_epoll_input__return: (7f6f74c03150 &lt;- 7f6f74bab7a0)
        vpp_main   360 [020] 20922246.052152:                           probe_libvlib:dispatch_node_1: (7f6f74babdff)
</code></pre><p>&#x7ED3;&#x5408;vppctl&#x91CC;&#x9762;&#x7684;<code>show runtime</code>&#x7EDF;&#x8BA1;, &#x4E5F;&#x80FD;&#x770B;&#x5230;&#x5176;&#x7EDF;&#x8BA1;&#x503C;&#x975E;&#x5E38;&#x5927;, &#x8FDC;&#x8FDC;&#x5927;&#x4E8E;&#x5176;&#x4ED6;node:<br><img src="img/vpp_host_interace_20240807105459.png" alt="">
&#x8FD9;&#x4E2A;&#x7EDF;&#x8BA1;&#x503C;&#x5927;&#x6982;&#x7684;&#x589E;&#x957F;&#x901F;&#x7387;&#x662F;&#x6BCF;&#x79D2;10000&#x6B21;.</p>
<p>&#x8FD9;&#x4E2A;<code>src/vlib/unix/</code>&#x5BF9;&#x5E94;&#x7684;&#x662F;<code>/etc/vpp/startup.conf</code>&#x91CC;&#x9762;&#x7684;unix&#x5C0F;&#x8282;:</p>
<pre class="language-"><code class="lang-shell">unix <span class="token punctuation">{</span>
  nodaemon
  log /var/log/vpp/vpp.log
  full-coredump
  cli-listen /run/vpp/cli.sock
  <span class="token comment"># gid vpp</span>

  <span class="token comment">## run vpp in the interactive mode</span>
  <span class="token comment"># interactive</span>

  <span class="token comment">## do not use colors in terminal output</span>
  <span class="token comment"># nocolor</span>

  <span class="token comment">## do not display banner</span>
  <span class="token comment"># nobanner</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>linux_epoll_input</code>&#x4EE3;&#x7801;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code class="lang-c">linux_epoll_input
  thread_index <span class="token operator">=</span> <span class="token function">vlib_get_thread_index</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">linux_epoll_input_inline</span> <span class="token punctuation">(</span>vm<span class="token punctuation">,</span> node<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> thread_index<span class="token punctuation">)</span>
    <span class="token keyword">if</span> main_thread
      <span class="token comment">//&#x5982;&#x679C;&#x914D;&#x7F6E;&#x4E86;poll_sleep_usec, &#x5219;sleep poll_sleep_usec</span>
      <span class="token comment">//&#x6839;&#x636E;&#x5F53;&#x524D;&#x60C5;&#x51B5;, &#x6BD4;&#x5982;ticks_until_expiration, &#x8BA1;&#x7B97;epoll&#x7684;time_out&#x65F6;&#x95F4;, &#x4FDD;&#x8BC1;&#x5728;0ms&#x548C;10ms&#x4E4B;&#x95F4;</span>
      <span class="token comment">//&#x8C03;&#x7528;epoll_pwait&#x7B49;&#x5F85;. epoll_pwait&#x6BD4;epoll_wait&#x591A;&#x4E86;signal&#x76F8;&#x5173;&#x7684;&#x914D;&#x7F6E;</span>
      n_fds_ready <span class="token operator">=</span> <span class="token function">epoll_pwait</span> <span class="token punctuation">(</span>em<span class="token operator">-&gt;</span>epoll_fd<span class="token punctuation">,</span>em<span class="token operator">-&gt;</span>epoll_events<span class="token punctuation">,</span><span class="token function">vec_len</span> <span class="token punctuation">(</span>em<span class="token operator">-&gt;</span>epoll_events<span class="token punctuation">)</span><span class="token punctuation">,</span>timeout_ms<span class="token punctuation">,</span> <span class="token operator">&amp;</span>unblock_all_signals<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token comment">//worker&#x7EBF;&#x7A0B;</span>
      <span class="token comment">//worker&#x7EBF;&#x7A0B;&#x4E0D;&#x8D1F;&#x8D23;epoll</span>
      Sleep <span class="token keyword">for</span> <span class="token number">100u</span>s at a time
    <span class="token comment">//&#x5230;&#x8FD9;&#x91CC;epoll_pwait&#x8FD4;&#x56DE;&#x4E86;, &#x8981;&#x4E48;&#x662F;&#x8D85;&#x65F6;&#x4E86;, &#x8981;&#x4E48;&#x6709;fd ready&#x4E86;</span>
    <span class="token comment">//&#x8C03;&#x7528;&#x76F8;&#x5E94;&#x7684;read/write&#x51FD;&#x6570;.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> em<span class="token operator">-&gt;</span>epoll_events<span class="token punctuation">;</span> e <span class="token operator">&lt;</span> em<span class="token operator">-&gt;</span>epoll_events <span class="token operator">+</span> n_fds_ready<span class="token punctuation">;</span> e<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">-&gt;</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span>
        f<span class="token operator">-&gt;</span>read_events<span class="token operator">++</span><span class="token punctuation">;</span>
        errors<span class="token punctuation">[</span>n_errors<span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token operator">-&gt;</span><span class="token function">read_function</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">-&gt;</span>events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span>
        f<span class="token operator">-&gt;</span>write_events<span class="token operator">++</span><span class="token punctuation">;</span>
        errors<span class="token punctuation">[</span>n_errors<span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token operator">-&gt;</span><span class="token function">write_function</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x8FD9;&#x91CC;&#x7684;&#x5173;&#x952E;&#x5728;&#x4E8E;<code>epoll_pwait</code>&#x7684;&#x8D85;&#x65F6;&#x65F6;&#x95F4;. </p>
<p>&#x7528;<code>show unix files</code>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6240;&#x6709;&#x7684;fd</p>
<pre class="language-"><code class="lang-shell">vpp<span class="token comment"># show unix files</span>
 FD Thread         Read        Write        Error File Name                        Description
  <span class="token number">7</span>      <span class="token number">0</span>            <span class="token number">0</span>            <span class="token number">0</span>            <span class="token number">0</span> socket:<span class="token punctuation">[</span><span class="token number">1925382243</span><span class="token punctuation">]</span>              stats segment listener /run/vpp/stats.sock
  <span class="token number">9</span>      <span class="token number">0</span>            <span class="token number">0</span>            <span class="token number">0</span>            <span class="token number">0</span> socket:<span class="token punctuation">[</span><span class="token number">1925382247</span><span class="token punctuation">]</span>              snort listener /run/vpp/snort.sock
 <span class="token number">10</span>      <span class="token number">0</span>            <span class="token number">3</span>            <span class="token number">0</span>            <span class="token number">0</span> socket:<span class="token punctuation">[</span><span class="token number">1925382250</span><span class="token punctuation">]</span>              cli listener /run/vpp/cli.sock
 <span class="token number">11</span>      <span class="token number">0</span>            <span class="token number">0</span>            <span class="token number">0</span>            <span class="token number">0</span> socket:<span class="token punctuation">[</span><span class="token number">1925382253</span><span class="token punctuation">]</span>              socksvr /run/vpp/api.sock
 <span class="token number">13</span>      <span class="token number">0</span>         <span class="token number">2558</span>            <span class="token number">0</span>            <span class="token number">0</span> socket:<span class="token punctuation">[</span><span class="token number">1925383353</span><span class="token punctuation">]</span>              host-eth0 queue <span class="token number">0</span>
 <span class="token number">14</span>      <span class="token number">0</span>          <span class="token number">495</span>            <span class="token number">1</span>            <span class="token number">0</span> socket:<span class="token punctuation">[</span><span class="token number">1946134394</span><span class="token punctuation">]</span>              local:2
</code></pre>
<p>&#x770B;&#x8D77;&#x6765;<code>src/vlib/unix/</code>&#x4E0D;&#x4EC5;&#x8D1F;&#x8D23;cli&#x7684;socket, &#x8FD8;&#x8D1F;&#x8D23;&#x6240;&#x6709;&#x5176;&#x4ED6;&#x7684;unix socket, &#x6BD4;&#x5982;<code>host-eth0</code></p>
<p>&#x7EE7;&#x7EED;&#x589E;&#x52A0;probe epoll_pwait</p>
<pre class="language-"><code class="lang-shell"><span class="token comment"># &#x589E;&#x52A0;syscalls:sys_enter_epoll_pwait</span>
<span class="token comment"># &#x589E;&#x52A0;syscalls:sys_exit_epoll_pwait</span>
<span class="token comment"># &#x8FD9;&#x4E9B;&#x662F;&#x9ED8;&#x8BA4;&#x7684;probe&#x70B9;, &#x80FD;&#x663E;&#x793A;&#x5165;&#x53C2;&#x548C;&#x8FD4;&#x56DE;&#x503C;</span>
perf record <span class="token parameter variable">-e</span> probe_af_packet_plugin:af_packet_input_node_fn* <span class="token parameter variable">-e</span> probe_af_packet_plugin:af_packet_device_class_tx_fn* <span class="token parameter variable">-e</span> probe_libvlib:dispatch_node* <span class="token parameter variable">-e</span> probe_libvlib:linux_epoll_input
<span class="token parameter variable">-e</span> probe_libvlib:linux_epoll_input__return <span class="token parameter variable">-e</span> syscalls:sys_enter_epoll_pwait <span class="token parameter variable">-e</span> syscalls:sys_exit_epoll_pwait <span class="token parameter variable">-R</span> <span class="token parameter variable">-p</span> <span class="token variable"><span class="token variable">$(</span>pidof vpp<span class="token variable">)</span></span> -- <span class="token function">sleep</span> <span class="token number">10</span>
</code></pre>
<p>&#x5F97;&#x5230;&#x7ED3;&#x679C;:</p>
<ul>
<li>&#x901A;&#x5E38;&#x60C5;&#x51B5;&#x4E0B;, &#x5373;&#x6CA1;&#x6709;fd ready, &#x662F;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x6837;&#x5B50;&#x7684;: epoll_pwait&#x7684;&#x5165;&#x53C2;timeout&#x662F;8ms, &#x90A3;&#x4E48;&#x4E00;&#x5B9A;&#x8981;&#x7B49;&#x8D85;&#x65F6;8ms&#x540E;&#x8FD4;&#x56DE;(21006166.827978 -&gt; 21006166.836295), &#x8FD9;&#x4E2A;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x662F;vpp&#x6839;&#x636E;ticks_until_expiration&#x52A8;&#x6001;&#x7B97;&#x51FA;&#x6765;&#x7684;, &#x6BCF;&#x6B21;&#x90FD;&#x4E0D;&#x4E00;&#x6837;, &#x4F46;&#x57FA;&#x672C;&#x5728;0&#x5230;10ms&#x4E4B;&#x95F4;:</li>
</ul>
<pre class="language-"><code class="lang-shell">        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>003<span class="token punctuation">]</span> <span class="token number">21006166.827892</span>:                             probe_libvlib:dispatch_node: <span class="token punctuation">(</span>7f6f74bab70e<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>003<span class="token punctuation">]</span> <span class="token number">21006166.827909</span>:                             probe_libvlib:dispatch_node: <span class="token punctuation">(</span>7f6f74bab70e<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>003<span class="token punctuation">]</span> <span class="token number">21006166.827925</span>:                             probe_libvlib:dispatch_node: <span class="token punctuation">(</span>7f6f74bab70e<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>003<span class="token punctuation">]</span> <span class="token number">21006166.827939</span>:                             probe_libvlib:dispatch_node: <span class="token punctuation">(</span>7f6f74bab70e<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>003<span class="token punctuation">]</span> <span class="token number">21006166.827960</span>:                         probe_libvlib:linux_epoll_input: <span class="token punctuation">(</span>7f6f74c03150<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>003<span class="token punctuation">]</span> <span class="token number">21006166.827978</span>:                          syscalls:sys_enter_epoll_pwait: epfd: 0x00000006, events: 0x7f6f3568f7d8, maxevents: 0x00000100, timeout: 0x00000008,<span class="token operator">&gt;</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>003<span class="token punctuation">]</span> <span class="token number">21006166.836295</span>:                           syscalls:sys_exit_epoll_pwait: 0x0
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>003<span class="token punctuation">]</span> <span class="token number">21006166.836332</span>:                 probe_libvlib:linux_epoll_input__return: <span class="token punctuation">(</span>7f6f74c03150 <span class="token operator">&lt;</span>- 7f6f74bab7a0<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>003<span class="token punctuation">]</span> <span class="token number">21006166.836384</span>:                           probe_libvlib:dispatch_node_1: <span class="token punctuation">(</span>7f6f74babdff<span class="token punctuation">)</span>
</code></pre>
<ul>
<li>&#x5F53;host-eth0&#x8FD9;&#x4E2A;socket&#x6709;packet&#x5230;&#x6765;&#x65F6;, &#x662F;&#x8FD9;&#x6837;&#x7684;: &#x53D1;&#x73B0;<code>epoll_pwait</code>&#x7684;&#x8BBE;&#x5B9A;&#x7684;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x662F;6ms, &#x4F46;&#x53EA;&#x8FC7;&#x4E86;3.2ms&#x5C31;&#x63D0;&#x524D;&#x8FD4;&#x56DE;&#x4E86;, &#x8FD4;&#x56DE;&#x503C;&#x4E3A;1, &#x8BF4;&#x660E;&#x6709;&#x4E00;&#x4E2A;fd&#x5DF2;&#x7ECF;ready&#x4E86;:</li>
</ul>
<pre class="language-"><code class="lang-shell">        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>009<span class="token punctuation">]</span> <span class="token number">21006170.532938</span>:                           probe_libvlib:dispatch_node_1: <span class="token punctuation">(</span>7f6f74babdff<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>009<span class="token punctuation">]</span> <span class="token number">21006170.532984</span>:                             probe_libvlib:dispatch_node: <span class="token punctuation">(</span>7f6f74bab70e<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>009<span class="token punctuation">]</span> <span class="token number">21006170.532995</span>:                             probe_libvlib:dispatch_node: <span class="token punctuation">(</span>7f6f74bab70e<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>009<span class="token punctuation">]</span> <span class="token number">21006170.533005</span>:                             probe_libvlib:dispatch_node: <span class="token punctuation">(</span>7f6f74bab70e<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>009<span class="token punctuation">]</span> <span class="token number">21006170.533018</span>:                             probe_libvlib:dispatch_node: <span class="token punctuation">(</span>7f6f74bab70e<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>009<span class="token punctuation">]</span> <span class="token number">21006170.533032</span>:                         probe_libvlib:linux_epoll_input: <span class="token punctuation">(</span>7f6f74c03150<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>009<span class="token punctuation">]</span> <span class="token number">21006170.533047</span>:                          syscalls:sys_enter_epoll_pwait: epfd: 0x00000006, events: 0x7f6f3568f7d8, maxevents: 0x00000100, timeout: 0x00000009,<span class="token operator">&gt;</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>000<span class="token punctuation">]</span> <span class="token number">21006170.536231</span>:                           syscalls:sys_exit_epoll_pwait: 0x1
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>000<span class="token punctuation">]</span> <span class="token number">21006170.536379</span>:                 probe_libvlib:linux_epoll_input__return: <span class="token punctuation">(</span>7f6f74c03150 <span class="token operator">&lt;</span>- 7f6f74bab7a0<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>000<span class="token punctuation">]</span> <span class="token number">21006170.536390</span>:                           probe_libvlib:dispatch_node_1: <span class="token punctuation">(</span>7f6f74babdff<span class="token punctuation">)</span>
<span class="token punctuation">..</span>.
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>000<span class="token punctuation">]</span> <span class="token number">21006170.536589</span>:                           probe_libvlib:dispatch_node_1: <span class="token punctuation">(</span>7f6f74babdff<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>000<span class="token punctuation">]</span> <span class="token number">21006170.536595</span>:                           probe_libvlib:dispatch_node_1: <span class="token punctuation">(</span>7f6f74babdff<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>000<span class="token punctuation">]</span> <span class="token number">21006170.536607</span>:                           probe_libvlib:dispatch_node_3: <span class="token punctuation">(</span>7f6f74bacbda<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>000<span class="token punctuation">]</span> <span class="token number">21006170.536615</span>:      probe_af_packet_plugin:af_packet_input_node_fn_hsw: <span class="token punctuation">(</span>7f6f3473be20<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>000<span class="token punctuation">]</span> <span class="token number">21006170.536795</span>:                           probe_libvlib:dispatch_node_8: <span class="token punctuation">(</span>7f6f74ba6a49<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>000<span class="token punctuation">]</span> <span class="token number">21006170.537165</span>:                           probe_libvlib:dispatch_node_8: <span class="token punctuation">(</span>7f6f74ba6a49<span class="token punctuation">)</span>
</code></pre>
<p>&#x6709;&#x65F6;&#x5019;&#x5728;timeout&#x662F;10ms&#x7684;&#x60C5;&#x51B5;&#x4E0B;, &#x771F;&#x7684;&#x5728;<code>epoll_pwait</code>&#x91CC;&#x9762;&#x7B49;&#x4E86;9ms, &#x8BF4;&#x660E;&#x8FD9;9ms&#x5C31;&#x662F;&#x6CA1;&#x6709;packet&#x901A;&#x77E5;&#x5230;&#x7528;&#x6237;&#x6001;.</p>
<pre class="language-"><code class="lang-shell"><span class="token comment"># &#x8FD9;&#x91CC;timeout&#x662F;10ms, &#x4F46;9ms&#x8FD4;&#x56DE;</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>002<span class="token punctuation">]</span> <span class="token number">21006171.515827</span>:                             probe_libvlib:dispatch_node: <span class="token punctuation">(</span>7f6f74bab70e<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>002<span class="token punctuation">]</span> <span class="token number">21006171.515841</span>:                         probe_libvlib:linux_epoll_input: <span class="token punctuation">(</span>7f6f74c03150<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>002<span class="token punctuation">]</span> <span class="token number">21006171.515854</span>:                          syscalls:sys_enter_epoll_pwait: epfd: 0x00000006, events: 0x7f6f3568f7d8, maxevents: 0x00000100, timeout: 0x0000000a,<span class="token operator">&gt;</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>000<span class="token punctuation">]</span> <span class="token number">21006171.524303</span>:                           syscalls:sys_exit_epoll_pwait: 0x1
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>000<span class="token punctuation">]</span> <span class="token number">21006171.524346</span>:                 probe_libvlib:linux_epoll_input__return: <span class="token punctuation">(</span>7f6f74c03150 <span class="token operator">&lt;</span>- 7f6f74bab7a0<span class="token punctuation">)</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>000<span class="token punctuation">]</span> <span class="token number">21006171.524358</span>:                           probe_libvlib:dispatch_node_1: <span class="token punctuation">(</span>7f6f74babdff<span class="token punctuation">)</span>
<span class="token punctuation">..</span>.
<span class="token comment">#&#x968F;&#x540E;af_packet_input_node_fn_hsw&#x6536;&#x62A5;</span>
        vpp_main   <span class="token number">360</span> <span class="token punctuation">[</span>000<span class="token punctuation">]</span> <span class="token number">21006171.524575</span>:      probe_af_packet_plugin:af_packet_input_node_fn_hsw: <span class="token punctuation">(</span>7f6f3473be20<span class="token punctuation">)</span>
</code></pre>
<h4 id="&#x7ED3;&#x8BBA;_1"><a name="&#x7ED3;&#x8BBA;_1" class="anchor-navigation-ex-anchor" href="#&#x7ED3;&#x8BBA;_1"><i class="fa fa-link" aria-hidden="true"></i></a>&#x7ED3;&#x8BBA;</h4>
<ul>
<li>vpp&#x7684;&#x4E3B;loop, &#x88AB;&#x8BBE;&#x8BA1;&#x6210;&#x4E86;polling&#x548C;event driven&#x7ED3;&#x5408;&#x7684;&#x65B9;&#x5F0F;<ul>
<li>&#x5148;&#x5904;&#x7406;&#x6240;&#x6709;<code>pre_input node</code>, &#x518D;&#x5904;&#x7406;&#x6240;&#x6709;<code>input node</code></li>
<li>&#x4F18;&#x5148;&#x5904;&#x7406;polling&#x6A21;&#x5F0F;&#x7684;, &#x518D;&#x5904;&#x7406;interrupt&#x6A21;&#x5F0F;&#x7684;</li>
</ul>
</li>
<li><code>unix_epoll_input</code>&#x662F;vpp&#x6BD4;&#x8F83;&#x6838;&#x5FC3;&#x7684;&#x7EC4;&#x4EF6;, &#x5C5E;&#x4E8E;<code>pre_input node</code><ul>
<li>&#x4E3B;&#x8981;&#x8D1F;&#x8D23;cli/api&#x7B49;unix socket&#x7684;polling</li>
<li>&#x8FD8;&#x8D1F;&#x8D23;&#x5176;&#x4ED6;socket&#x7684;polling, &#x6BD4;&#x5982;<code>host-eth0</code></li>
<li><code>unix_epoll_input</code>&#x53EA;&#x5DE5;&#x4F5C;&#x5728;main thread</li>
</ul>
</li>
<li>&#x4E0D;&#x6253;&#x5F00;&#x591A;thread&#x7684;&#x60C5;&#x51B5;&#x4E0B;, &#x4E3B;loop&#x4F1A;&#x88AB;<code>unix_epoll_input</code>&#x5F71;&#x54CD;<ul>
<li><code>unix_epoll_input</code>&#x4F1A;&#x8C03;&#x7528;<code>epoll_pwait</code>&#x5E76;&#x7B49;&#x5F85;0&#x5230;10ms, &#x5728;&#x6B64;&#x671F;&#x95F4;&#x4E3B;loop&#x5C31;&#x662F;blocking&#x7684;</li>
<li>&#x56E0;&#x4E3A;<code>unix_epoll_input</code>&#x5728;<code>pre_input node</code>&#x9636;&#x6BB5;&#x5904;&#x7406;, &#x5B83;&#x4F1A;&#x5F71;&#x54CD;&#x6240;&#x6709;&#x540E;&#x9762;&#x7684;<code>input node</code></li>
<li><code>af-packet-input</code>&#x5728;<code>input node</code>&#x7684;interrupt&#x9636;&#x6BB5;&#x5904;&#x7406;, &#x4F46;&#x5B83;&#x4F9D;&#x8D56;<code>unix_epoll_input</code>&#x7684;event&#x89E6;&#x53D1;&#x8FD9;&#x4E2A;&quot;interrupt&quot;</li>
</ul>
</li>
<li>&#x7EFC;&#x4E0A;<ul>
<li>&#x4E3A;&#x4E86;&#x907F;&#x514D;<code>unix_epoll_input</code>&#x5E26;&#x6765;&#x7684;&#x8D85;&#x65F6;&#x7B49;&#x5F85;&#x7684;latency, &#x5FC5;&#x987B;&#x5F00;&#x542F;&#x591A;thread&#x6A21;&#x5F0F;. &#x914D;&#x7F6E;&#x5728;<code>/etc/vpp/startup.conf</code>&#x7684;<code>cpu{main-core 1; workers 4}</code>&#x5C0F;&#x8282;</li>
<li>&#x5BF9;&#x4E8E;<code>host interface</code>&#x6765;&#x8BF4;, <code>unix_epoll_input</code>&#x7684;&#x8D85;&#x65F6;&#x7B49;&#x5F85;&#x5F71;&#x54CD;&#x4E0D;&#x5927;. &#x56E0;&#x4E3A;&#x5F53;packet&#x5230;&#x8FBE;&#x65F6;, &#x4F1A;&#x5728;&#x8D85;&#x65F6;&#x524D;&#x5524;&#x9192;<code>unix_epoll_input</code>&#x7684;<code>epoll_pwait</code>, &#x968F;&#x540E;&#x89E6;&#x53D1;&quot;&#x4E2D;&#x65AD;&quot;&#x7ED9;<code>af-packet-input</code></li>
</ul>
</li>
</ul>
<p>&#x770B;&#x8D77;&#x6765;vpp&#x5904;&#x7406;<code>af-packet-input</code>&#x7684;&#x673A;&#x5236;&#x6CA1;&#x6709;&#x660E;&#x663E;&#x7684;&#x7F3A;&#x9677;, &#x90A3;&#x4E48;&#x4E3A;&#x4EC0;&#x4E48;&#x62A5;&#x6587;&#x8FD8;&#x662F;&#x5F88;&#x4E45;&#x624D;&#x80FD;&#x6536;&#x5230;&#x5462;?</p>
<h4 id="&#x4E3A;&#x4EC0;&#x4E48;epoll&#x8981;&#x8FD9;&#x4E48;&#x4E45;"><a name="&#x4E3A;&#x4EC0;&#x4E48;epoll&#x8981;&#x8FD9;&#x4E48;&#x4E45;" class="anchor-navigation-ex-anchor" href="#&#x4E3A;&#x4EC0;&#x4E48;epoll&#x8981;&#x8FD9;&#x4E48;&#x4E45;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4E3A;&#x4EC0;&#x4E48;epoll&#x8981;&#x8FD9;&#x4E48;&#x4E45;?</h4>
<p>&#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x5206;&#x6790;&#x5230;, <code>epoll_pwait</code>&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5F88;&#x4E45;&#x624D;&#x8FD4;&#x56DE;, &#x7ED3;&#x5408;<code>tcpdump</code>&#x7684;&#x65F6;&#x95F4;&#x6233;, &#x660E;&#x663E;&#x53D1;&#x73B0;<code>tcpdump</code>&#x8981;&#x8FDC;&#x8FDC;&#x65E9;&#x4E8E;<code>vpp</code>&#x88AB;&#x901A;&#x77E5;. &#x90A3;&#x4E48;&#x540C;&#x6837;&#x7684;&#x62A5;&#x6587;, &#x96BE;&#x9053;<code>tcpdump</code>&#x8981;&#x6536;&#x7684;&#x66F4;&#x53CA;&#x65F6;&#x4E00;&#x4E9B;&#x5417;?</p>
<p>&#x6839;&#x636E;<a href="https://mp.weixin.qq.com/s/LPLZoIr0cNTiA2-yRIhIUw" target="_blank">&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;</a></p>
<p>&#x9996;&#x5148;&#x770B;error&#x7684;&#x7EDF;&#x8BA1;, &#x679C;&#x7136;&#x6709;<code>af-packet-input</code> timed out error</p>
<pre class="language-"><code class="lang-shell"><span class="token comment"># vppctl show error</span>
   Count                  Node                              Reason               Severity
       <span class="token number">138</span>          af-packet-input                    timed out block             error
       <span class="token number">138</span>          af-packet-input                  total received block          error
         <span class="token number">1</span>             arp-reply             ARP request IP4 <span class="token builtin class-name">source</span> address lear   info
         <span class="token number">1</span>             ip4-glean                      ARP requests sent            info
        <span class="token number">76</span>           ip4-icmp-input                      unknown <span class="token builtin class-name">type</span>              error
</code></pre>
<p>&#x5728;<code>af_packet</code>&#x60C5;&#x51B5;&#x4E0B;, app&#x7528;mmap&#x548C;&#x5185;&#x6838;&#x5EFA;&#x7ACB;ring buffer, &#x6216;&#x8005;&#x53EB;queue</p>
<ul>
<li>&#x8FD9;&#x4E2A;buffer&#x6709;&#x591A;&#x4E2A;block, &#x800C;&#x4E00;&#x4E2A;block&#x53EF;&#x4EE5;hold&#x591A;&#x4E2A;packet</li>
<li>app&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>/usr/include/linux/if_packet.h</code>&#x7684;<code>tpacket_req3.tp_retire_blk_tov</code>&#x53BB;&#x914D;&#x7F6E;&#x6BCF;&#x4E2A;queue&#x7684;&#x8D85;&#x65F6;&#x65F6;&#x95F4;, &#x5355;&#x4F4D;&#x4E3A;ms. vpp&#x914D;&#x7F6E;&#x4E86;1ms<ul>
<li>&#x53EA;&#x6709;TPACKET_V3&#x6709;&#x8FD9;&#x4E2A;&#x8D85;&#x65F6;&#x914D;&#x7F6E;</li>
</ul>
</li>
<li>&#x8FD9;&#x4E2A;block size&#x7684;&#x5927;&#x5C0F;&#x4E3A;<ul>
<li>TPACKET_V3: 2048 * 32 = 64K</li>
<li>TPACKET_V2:  2048 <em> 33 </em> 1024 &#x5927;&#x6982;64M</li>
</ul>
</li>
</ul>
<pre class="language-"><code class="lang-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AF_PACKET_DEFAULT_TX_FRAMES_PER_BLOCK</span> <span class="token expression"><span class="token number">1024</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AF_PACKET_DEFAULT_TX_FRAME_SIZE</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token number">2048</span> <span class="token operator">*</span> <span class="token number">33</span><span class="token punctuation">)</span> </span><span class="token comment">// GSO packet of 64KB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AF_PACKET_TX_BLOCK_NR</span>        <span class="token expression"><span class="token number">1</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AF_PACKET_DEFAULT_RX_FRAMES_PER_BLOCK_V2</span> <span class="token expression"><span class="token number">1024</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AF_PACKET_DEFAULT_RX_FRAME_SIZE_V2</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token number">2048</span> <span class="token operator">*</span> <span class="token number">33</span><span class="token punctuation">)</span> </span><span class="token comment">// GSO packet of 64KB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AF_PACKET_RX_BLOCK_NR_V2</span>         <span class="token expression"><span class="token number">1</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AF_PACKET_DEFAULT_RX_FRAMES_PER_BLOCK</span> <span class="token expression"><span class="token number">32</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AF_PACKET_DEFAULT_RX_FRAME_SIZE</span>          <span class="token expression"><span class="token number">2048</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AF_PACKET_RX_BLOCK_NR</span>              <span class="token expression"><span class="token number">160</span></span></span>

rx_queue<span class="token operator">-&gt;</span>rx_req<span class="token operator">-&gt;</span>req<span class="token punctuation">.</span>tp_block_size <span class="token operator">=</span> rx_frame_size <span class="token operator">*</span> rx_frames_per_block<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>apif<span class="token operator">-&gt;</span>version <span class="token operator">==</span> TPACKET_V3<span class="token punctuation">)</span>
  rx_queue<span class="token operator">-&gt;</span>rx_req<span class="token operator">-&gt;</span>req3<span class="token punctuation">.</span>tp_retire_blk_tov <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 1 ms block timout</span>
</code></pre>
<p>app&#x4F7F;&#x7528;epoll&#x7B49;&#x5F85;socket&#x53EF;&#x7528;, &#x5F53;&#x62A5;&#x6587;&#x5230;&#x8FBE;&#x65F6;kernel&#x65F6;, &#x88AB;&#x62F7;&#x8D1D;&#x8FDB;ring buffer
v3&#x7248;&#x672C;&#x4F7F;&#x7528;block&#x6EE1;&#x89E6;&#x53D1;&#x901A;&#x77E5;, &#x800C;v2&#x4F7F;&#x7528;frame&#x5230;&#x8FBE;&#x6765;&#x89E6;&#x53D1;&#x901A;&#x77E5;.</p>
<p>&#x6839;&#x636E;<a href="https://www.kernel.org/doc/Documentation/networking/packet_mmap.txt" target="_blank">&#x5185;&#x6838;&#x6587;&#x6863;packet_mmap</a>&#x7684;&#x8BF4;&#x6CD5;:</p>
<pre class="language-"><code>TPACKET_V2 --&gt; TPACKET_V3:
    - Flexible buffer implementation for RX_RING:
        1. Blocks can be configured with non-static frame-size
        2. Read/poll is at a block-level (as opposed to packet-level)
        3. Added poll timeout to avoid indefinite user-space wait
           on idle links
        4. Added user-configurable knobs:
            4.1 block::timeout
            4.2 tpkt_hdr::sk_rxhash
    - RX Hash data available in user space
    - TX_RING semantics are conceptually similar to TPACKET_V2;
      use tpacket3_hdr instead of tpacket2_hdr, and TPACKET3_HDRLEN
      instead of TPACKET2_HDRLEN. In the current implementation,
      the tp_next_offset field in the tpacket3_hdr MUST be set to
      zero, indicating that the ring does not hold variable sized frames.
      Packets with non-zero values of tp_next_offset will be dropped.
</code></pre><p>&#x5982;&#x679C;&#x6309;&#x7167;&#x8FD9;&#x4E2A;&#x8BF4;&#x6CD5;, &#x5373;&#x4F7F;&#x6BCF;&#x4E2A;packet&#x90FD;&#x7B49;&#x5F85;&#x9ED8;&#x8BA4;1ms&#x7684;block&#x8D85;&#x65F6;&#x65F6;&#x95F4;, &#x90A3;ping&#x7684;&#x5EF6;&#x8FDF;&#x4E5F;&#x4E0D;&#x8BE5;&#x8FD9;&#x4E48;&#x9AD8;&#x5440;?</p>
<p>libpcap&#x793E;&#x533A;&#x4E5F;&#x6709;&#x7C7B;&#x4F3C;&#x7684;<a href="https://github.com/the-tcpdump-group/libpcap/issues/335" target="_blank">&#x8BA8;&#x8BBA;</a></p>
<p>vpp&#x4E0A;&#x7684;<a href="https://lists.fd.io/g/vpp-dev/topic/high_latency_while_pinging/101937209" target="_blank">&#x8FD9;&#x4E2A;&#x8BA8;&#x8BBA;</a>&#x8BF4;&#x8BA9;&#x8BD5;&#x4E00;&#x4E0B;v2</p>
<pre class="language-"><code>vppctl create host-interface v2 name eth0
vppctl set interface state host-eth0 up
vppctl set interface ip address host-eth0 10.10.10.11/24

vppctl create host-interface v2 name eth0
vppctl set interface state host-eth0 up
vppctl set interface ip address host-eth0 10.10.10.12/24

vppctl ping 10.10.10.12
</code></pre><p>&#x679C;&#x7136;ping&#x5EF6;&#x8FDF;&#x5C0F;&#x4E86;&#x5F88;&#x591A;!<br><img src="img/vpp_host_interace_20240808112802.png" alt=""></p>
<p>&#x5982;&#x679C;&#x518D;&#x52A0;&#x4E0A;<code>interval</code>, &#x5EF6;&#x8FDF;&#x4F1A;&#x66F4;&#x5C0F;!</p>
<pre class="language-"><code class="lang-shell"><span class="token comment"># vppctl ping 10.10.10.12 interval 0.0005                  </span>
<span class="token number">116</span> bytes from <span class="token number">10.10</span>.10.12: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>.6489 ms
<span class="token number">116</span> bytes from <span class="token number">10.10</span>.10.12: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>.1924 ms
<span class="token number">116</span> bytes from <span class="token number">10.10</span>.10.12: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>.1426 ms
<span class="token number">116</span> bytes from <span class="token number">10.10</span>.10.12: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>.0398 ms
<span class="token number">116</span> bytes from <span class="token number">10.10</span>.10.12: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">5</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>.1296 ms

Statistics: <span class="token number">5</span> sent, <span class="token number">5</span> received, <span class="token number">0</span>% packet loss
</code></pre>
<p>&#x6700;&#x540E;&#x7684;&#x7ED3;&#x8BBA;:</p>
<ul>
<li>&#x6211;&#x66F4;&#x503E;&#x5411;&#x4E8E;&#x8BA4;&#x4E3A;TPACKET_V3&#x8FD8;&#x662F;&#x53EF;&#x4EE5;&#x5F88;&#x53CA;&#x65F6;&#x7684;&#x89E6;&#x53D1;&#x7528;&#x6237;&#x6001;&#x6536;&#x62A5;&#x7684;, libpcap&#x4E5F;&#x7528;&#x5B83;</li>
<li>vpp&#x7684;ping&#x5EF6;&#x8FDF;&#x9AD8;&#x7684;&#x95EE;&#x9898;, &#x53EF;&#x80FD;&#x662F;vpp&#x4EE3;&#x7801;&#x5BF9;TPACKET_V3&#x7684;&#x4F18;&#x5316;&#x4E0D;&#x591F;&#x597D;?</li>
</ul>
<h2 id="drop&#x6742;&#x5305;"><a name="drop&#x6742;&#x5305;" class="anchor-navigation-ex-anchor" href="#drop&#x6742;&#x5305;"><i class="fa fa-link" aria-hidden="true"></i></a>6.4. drop&#x6742;&#x5305;</h2>
<p>&#x591A;&#x6293;&#x4E00;&#x4F1A;, &#x8FD8;&#x4F1A;&#x6709;drop&#x7684;&#x62A5;&#x6587;. &#x539F;&#x56E0;&#x662F;&#x4F5C;&#x4E3A;<code>AF_PACKET</code>&#x7684;raw socket, &#x8FD9;&#x4E2A;socket&#x53EF;&#x4EE5;&#x63A5;&#x6536;&#x4EFB;&#x4F55;&#x4ECE;eth0&#x6765;&#x7684;&#x62A5;&#x6587;.</p>
<ul>
<li>packet 6&#x548C;packet 7&#x5728;&#x6B65;&#x9AA4;ip4-lookup&#x88AB;&#x4E22;&#x5F03;, &#x56E0;&#x4E3A;<code>172.17.255.255</code>&#x662F;vpp&#x6240;&#x5728;&#x7684;container&#x7684;&#x7F51;&#x6BB5;, &#x8FD9;&#x4E2A;&#x7F51;&#x6BB5;&#x5728;vpp&#x5185;&#x90E8;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x4FE1;&#x606F;.</li>
<li>packet 8&#x5728;ip6-input&#x9636;&#x6BB5;&#x88AB;drop, &#x56E0;&#x4E3A;ip6-not-enabled</li>
</ul>
<pre class="language-"><code class="lang-shell">Packet <span class="token number">6</span>

<span class="token number">23</span>:31:24:325006: af-packet-input
  af_packet: hw_if_index <span class="token number">1</span> rx-queue <span class="token number">0</span> next-index <span class="token number">4</span>
    block <span class="token number">61</span>:
      address 0x7fb9850cb000 version <span class="token number">2</span> seq_num <span class="token number">6782</span> pkt_num <span class="token number">0</span>
    tpacket3_hdr:
      status 0x9 len <span class="token number">278</span> snaplen <span class="token number">278</span> mac <span class="token number">92</span> net <span class="token number">106</span>
      sec 0x66a8a219 nsec 0x7208f8a vlan <span class="token number">0</span> vlan_tpid <span class="token number">0</span>
    vnet-hdr:
      flags 0x01 gso_type 0x00 hdr_len <span class="token number">0</span>
      gso_size <span class="token number">0</span> csum_start <span class="token number">34</span> csum_offset <span class="token number">6</span>
<span class="token number">23</span>:31:24:325017: ethernet-input
  IP4: 02:42:1e:a6:fa:68 -<span class="token operator">&gt;</span> ff:ff:ff:ff:ff:ff
<span class="token number">23</span>:31:24:325403: ip4-input
  UDP: <span class="token number">172.17</span>.0.1 -<span class="token operator">&gt;</span> <span class="token number">172.17</span>.255.255
    tos 0x00, ttl <span class="token number">64</span>, length <span class="token number">264</span>, checksum 0x4b46 dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x967b, flags DONT_FRAGMENT
  UDP: <span class="token number">138</span> -<span class="token operator">&gt;</span> <span class="token number">138</span>
    length <span class="token number">244</span>, checksum 0x5929
<span class="token number">23</span>:31:24:325729: ip4-lookup
  fib <span class="token number">0</span> dpo-idx <span class="token number">0</span> flow hash: 0x00000000
  UDP: <span class="token number">172.17</span>.0.1 -<span class="token operator">&gt;</span> <span class="token number">172.17</span>.255.255
    tos 0x00, ttl <span class="token number">64</span>, length <span class="token number">264</span>, checksum 0x4b46 dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x967b, flags DONT_FRAGMENT
  UDP: <span class="token number">138</span> -<span class="token operator">&gt;</span> <span class="token number">138</span>
    length <span class="token number">244</span>, checksum 0x5929
<span class="token number">23</span>:31:24:325989: ip4-drop
    fib:0 adj:0 flow:0x00000000
  UDP: <span class="token number">172.17</span>.0.1 -<span class="token operator">&gt;</span> <span class="token number">172.17</span>.255.255
    tos 0x00, ttl <span class="token number">64</span>, length <span class="token number">264</span>, checksum 0x4b46 dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x967b, flags DONT_FRAGMENT
  UDP: <span class="token number">138</span> -<span class="token operator">&gt;</span> <span class="token number">138</span>
    length <span class="token number">244</span>, checksum 0x5929
<span class="token number">23</span>:31:24:326130: error-drop
  rx:host-eth0
<span class="token number">23</span>:31:24:338325: drop
  ethernet-input: no error

Packet <span class="token number">7</span>

<span class="token number">23</span>:31:24:325006: af-packet-input
  af_packet: hw_if_index <span class="token number">1</span> rx-queue <span class="token number">0</span> next-index <span class="token number">4</span>
    block <span class="token number">61</span>:
      address 0x7fb9850cb000 version <span class="token number">2</span> seq_num <span class="token number">6782</span> pkt_num <span class="token number">1</span>
    tpacket3_hdr:
      status 0x9 len <span class="token number">255</span> snaplen <span class="token number">255</span> mac <span class="token number">92</span> net <span class="token number">106</span>
      sec 0x66a8a219 nsec 0x7518f61 vlan <span class="token number">0</span> vlan_tpid <span class="token number">0</span>
    vnet-hdr:
      flags 0x01 gso_type 0x00 hdr_len <span class="token number">0</span>
      gso_size <span class="token number">0</span> csum_start <span class="token number">34</span> csum_offset <span class="token number">6</span>
<span class="token number">23</span>:31:24:325017: ethernet-input
  IP4: 02:42:1e:a6:fa:68 -<span class="token operator">&gt;</span> ff:ff:ff:ff:ff:ff
<span class="token number">23</span>:31:24:325403: ip4-input
  UDP: <span class="token number">172.17</span>.0.1 -<span class="token operator">&gt;</span> <span class="token number">172.17</span>.255.255
    tos 0x00, ttl <span class="token number">64</span>, length <span class="token number">241</span>, checksum 0x4b5c dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x967c, flags DONT_FRAGMENT
  UDP: <span class="token number">138</span> -<span class="token operator">&gt;</span> <span class="token number">138</span>
    length <span class="token number">221</span>, checksum 0x5912
<span class="token number">23</span>:31:24:325729: ip4-lookup
  fib <span class="token number">0</span> dpo-idx <span class="token number">0</span> flow hash: 0x00000000
  UDP: <span class="token number">172.17</span>.0.1 -<span class="token operator">&gt;</span> <span class="token number">172.17</span>.255.255
    tos 0x00, ttl <span class="token number">64</span>, length <span class="token number">241</span>, checksum 0x4b5c dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x967c, flags DONT_FRAGMENT
  UDP: <span class="token number">138</span> -<span class="token operator">&gt;</span> <span class="token number">138</span>
    length <span class="token number">221</span>, checksum 0x5912
<span class="token number">23</span>:31:24:325989: ip4-drop
    fib:0 adj:0 flow:0x00000000
  UDP: <span class="token number">172.17</span>.0.1 -<span class="token operator">&gt;</span> <span class="token number">172.17</span>.255.255
    tos 0x00, ttl <span class="token number">64</span>, length <span class="token number">241</span>, checksum 0x4b5c dscp CS0 ecn NON_ECN
    fragment <span class="token function">id</span> 0x967c, flags DONT_FRAGMENT
  UDP: <span class="token number">138</span> -<span class="token operator">&gt;</span> <span class="token number">138</span>
    length <span class="token number">221</span>, checksum 0x5912
<span class="token number">23</span>:31:24:326130: error-drop
  rx:host-eth0
<span class="token number">23</span>:31:24:338325: drop
  ethernet-input: no error

Packet <span class="token number">8</span>

<span class="token number">23</span>:35:05:284106: af-packet-input
  af_packet: hw_if_index <span class="token number">1</span> rx-queue <span class="token number">0</span> next-index <span class="token number">4</span>
    block <span class="token number">62</span>:
      address 0x7fb9850db000 version <span class="token number">2</span> seq_num <span class="token number">6783</span> pkt_num <span class="token number">0</span>
    tpacket3_hdr:
      status 0x1 len <span class="token number">70</span> snaplen <span class="token number">70</span> mac <span class="token number">92</span> net <span class="token number">106</span>
      sec 0x66a8a2f6 nsec 0x2aa72fe vlan <span class="token number">0</span> vlan_tpid <span class="token number">0</span>
    vnet-hdr:
      flags 0x00 gso_type 0x00 hdr_len <span class="token number">0</span>
      gso_size <span class="token number">0</span> csum_start <span class="token number">0</span> csum_offset <span class="token number">0</span>
<span class="token number">23</span>:35:05:284403: ethernet-input
  IP6: f6:4e:1a:65:f3:14 -<span class="token operator">&gt;</span> <span class="token number">33</span>:33:00:00:00:02
<span class="token number">23</span>:35:05:284440: ip6-input
  ICMP6: fe80::f44e:1aff:fe65:f314 -<span class="token operator">&gt;</span> ff02::2
    tos 0x00, flow label 0x0, hop limit <span class="token number">255</span>, payload length <span class="token number">16</span>
<span class="token number">23</span>:35:05:284567: ip6-not-enabled
    fib:0 adj:0 flow:0x00000000
  ICMP6: fe80::f44e:1aff:fe65:f314 -<span class="token operator">&gt;</span> ff02::2
    tos 0x00, flow label 0x0, hop limit <span class="token number">255</span>, payload length <span class="token number">16</span>
<span class="token number">23</span>:35:05:304612: error-drop
  rx:host-eth0
<span class="token number">23</span>:35:05:304616: drop
  ethernet-input: no error
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="vpp_compiling_on_alpine.md" class="navigation navigation-prev " aria-label="Previous page: alpine编译vpp">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="as_title_qemu_ovs.html" class="navigation navigation-next " aria-label="Next page: Qemu OVS和DPDK">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"vpp的host-interface","level":"1.6.8.1","depth":3,"next":{"title":"Qemu OVS和DPDK","level":"1.6.9","depth":2,"path":"notes/as_title_qemu_ovs.md","ref":"notes/as_title_qemu_ovs.md","articles":[{"title":"OVS-DPDK编译运行","level":"1.6.9.1","depth":3,"path":"notes/OVS_DPDK_编译运行.md","ref":"notes/OVS_DPDK_编译运行.md","articles":[]},{"title":"OVS架构和代码","level":"1.6.9.2","depth":3,"path":"notes/OVS_架构和代码.md","ref":"notes/OVS_架构和代码.md","articles":[]},{"title":"OVS-DPDK for ARM server 性能测试环境","level":"1.6.9.3","depth":3,"path":"notes/OVS_DPDK_performance_HXT_ARM_server.md","ref":"notes/OVS_DPDK_performance_HXT_ARM_server.md","articles":[]},{"title":"DPDK Mellanox","level":"1.6.9.4","depth":3,"path":"notes/DPDK_Mellanox.md","ref":"notes/DPDK_Mellanox.md","articles":[]},{"title":"OVS PHY-VM-PHY","level":"1.6.9.5","depth":3,"path":"notes/OVS_phy-vm-phy.md","ref":"notes/OVS_phy-vm-phy.md","articles":[]},{"title":"网络虚拟化用例记录","level":"1.6.9.6","depth":3,"path":"notes/networking_网络虚拟化用例记录.md","ref":"notes/networking_网络虚拟化用例记录.md","articles":[]},{"title":"网络虚拟化操作记录","level":"1.6.9.7","depth":3,"path":"notes/networking_网络虚拟化操作记录.md","ref":"notes/networking_网络虚拟化操作记录.md","articles":[]}]},"previous":{"title":"alpine编译vpp","level":"1.6.8","depth":2,"path":"notes/vpp_compiling_on_alpine.md","ref":"notes/vpp_compiling_on_alpine.md","articles":[{"title":"vpp的host-interface","level":"1.6.8.1","depth":3,"path":"notes/vpp_host_interace.md","ref":"notes/vpp_host_interace.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["-livereload","-sharing","-lunr","-search","search-plus","-highlight","theme-comscore","prism","code","chapter-fold","github","splitter","wide-page","hide-navigation-buttons","anchor-navigation-ex","sequence@0.1.1","mermaid-gb3"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"chapter-fold":{},"prism":{"css":["prismjs/themes/prism.css"],"ignore":["mermaid","sequence"]},"sequence":{"theme":"simple"},"github":{"url":"https://github.com/Bai-Yingjie/Bai-Yingjie.github.io"},"splitter":{},"wide-page":{},"code":{"copyButtons":true},"fontsettings":{"theme":"white","family":"sans","size":2},"hide-navigation-buttons":{},"mermaid-gb3":{},"anchor-navigation-ex":{"mode":"float","pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"isRewritePageTitle":true,"showLevel":true,"tocLevel1Icon":"fa fa-hand-o-right","tocLevel2Icon":"fa fa-hand-o-right","tocLevel3Icon":"fa fa-hand-o-right","showGoTop":true,"isShowTocTitleIcon":true,"printLog":false,"multipleH1":true,"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false}},"theme-comscore":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"theme":"default","author":"Bai Yingjie","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"My Notes","language":"zh-hans","gitbook":"*"},"file":{"path":"notes/vpp_host_interace.md","mtime":"2024-08-09T01:54:16.016Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2024-08-09T01:55:08.517Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-mermaid-gb3/book/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-theme-comscore/test.js"></script>
        
    

    <script src="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.min.js"></script>

    </body>
</html>

